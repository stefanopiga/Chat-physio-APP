# Story 9.3: Chat Session Management UI

## Status
Draft

## Story

**As a** studente fisioterapia,
**I want** gestire completamente le mie sessioni chat (creare, rinominare, eliminare, navigare) tramite un menu laterale intuitivo,
**so that** posso organizzare le conversazioni, mantenere ordine nello storico e riprendere facilmente i dialoghi precedenti.

## Acceptance Criteria

1. **Sidebar Toggle**: Icona sandwich (â˜°) in header apre/chiude sidebar menu laterale
   - Mobile: overlay slide-in da sinistra (z-index elevato)
   - Desktop >1024px: sidebar persistente sempre visibile

2. **Session List Display**: Sidebar mostra lista completa sessioni attive
   - Ogni item mostra: session ID (primi 8 char) + timestamp creazione
   - Lista ordinata cronologicamente (piÃ¹ recente in alto)
   - Scroll verticale se lista >10 items

3. **Load Conversation**: Click su conversazione nella lista
   - Carica history completo via API (riusa endpoint Story 9.2)
   - Popola chat UI con messaggi storici
   - Chiude sidebar automaticamente su mobile
   - Focus su input chat per continuare conversazione

4. **New Chat Button**: Pulsante "Nuova Chat" in cima alla sidebar
   - Click â†’ genera nuovo sessionId (UUID v4)
   - Pulisce array messaggi correnti
   - Salva sessionId in localStorage
   - Focus automatico su input chat

5. **Session Menu Actions**: Menu 3 pallini (â‹®) per ogni conversazione
   - Dropdown con opzioni: "Rinomina" e "Elimina"
   - Click menu non carica conversazione, solo apre dropdown

6. **Rename Dialog**: Dialog modale per rinominare sessione
   - Input text precompilato con nome corrente (default: session ID)
   - Pulsanti "Conferma" e "Annulla"
   - Conferma â†’ PATCH `/chat/sessions/{id}/metadata` con `{display_name: string}`
   - Aggiorna display name in lista sidebar UI

7. **Delete Confirmation**: Dialog conferma eliminazione
   - Testo: "Sei sicuro di voler eliminare questa conversazione? Questa azione Ã¨ irreversibile."
   - Pulsanti: "Prosegui" (danger style) e "Annulla" (default)
   - Click "Prosegui" â†’ chiamata DELETE endpoint backend

8. **Backend Hard Delete**: DELETE `/chat/sessions/{sessionId}` endpoint
   - Elimina TUTTI messaggi sessione da DB: `DELETE FROM chat_messages WHERE session_id = ?`
   - Response 204 No Content su success
   - JWT required, rate limiting 10 req/min

9. **Delete UI Behavior**: Dopo conferma delete success
   - Rimuove sessione da lista sidebar UI
   - Se conversazione eliminata Ã¨ quella corrente: trigger "New Chat" automatico
   - Toast notification: "Conversazione eliminata con successo"

10. **Responsive Design**: Sidebar funzionante su mobile e desktop
    - Mobile (<1024px): slide-in overlay, chiude al click conversazione
    - Desktop (â‰¥1024px): sidebar persistente, non si chiude automaticamente
    - Transizioni smooth (300ms ease-in-out)

## Tasks / Subtasks

- [ ] Task 1: Backend DELETE Endpoint Implementation (AC: 8) â€” 2-3h
  - [ ] 1.1: Creare endpoint `DELETE /api/v1/chat/sessions/{sessionId}` in `apps/api/api/routers/chat.py`
  - [ ] 1.2: Implementare hard delete: `DELETE FROM chat_messages WHERE session_id = $1`
  - [ ] 1.3: Aggiungere JWT auth dependency + rate limiting 10 req/min
  - [ ] 1.4: Error handling: 404 se session non esiste, 204 su success
  - [ ] 1.5: Unit test endpoint: success delete, not found, unauthorized, rate limit

- [ ] Task 2: Zustand Session Store Setup (AC: 2, 4) â€” 1h
  - [ ] 2.1: Creare `apps/web/src/store/sessionStore.ts` con Zustand
  - [ ] 2.2: State: `sessions: SessionMetadata[]`, `currentSessionId: string | null`
  - [ ] 2.3: Actions: `addSession`, `removeSession`, `updateSession`, `setCurrentSession`
  - [ ] 2.4: Persistence: sync con localStorage key `chat.sessions`
  - **Code reference:** `addendum-zustand-shadcn-session-management.md` Section 1.1-1.2

- [ ] Task 3: ChatSidebar Component (AC: 1, 2, 10) â€” 2-3h
  - [ ] 3.1: Creare `apps/web/src/components/ChatSidebar.tsx`
  - [ ] 3.2: Shadcn/UI Sheet component per mobile overlay
  - [ ] 3.3: Persistent `<aside>` component per desktop â‰¥1024px
  - [ ] 3.4: Render lista sessioni da Zustand store
  - [ ] 3.5: Responsive breakpoint con Tailwind `lg:` prefix
  - [ ] 3.6: Smooth transitions: `transition-transform duration-300 ease-in-out`
  - **Code reference:** `addendum-zustand-shadcn-session-management.md` Section 2.1-2.2

- [ ] Task 4: New Chat Button (AC: 4) â€” 1h
  - [ ] 4.1: Button "Nuova Chat" in header sidebar (sticky top)
  - [ ] 4.2: Click handler: genera UUID v4, aggiungi a store, clear messages
  - [ ] 4.3: Focus automatico input chat con `useRef` + `focus()`
  - [ ] 4.4: Icon "+" prefix button per visual consistency

- [ ] Task 5: SessionListItem Component (AC: 3, 5) â€” 2h
  - [ ] 5.1: Creare `apps/web/src/components/SessionListItem.tsx`
  - [ ] 5.2: Display: primi 8 char session ID + timestamp relativo (es. "2 ore fa")
  - [ ] 5.3: Click item â†’ `onSessionClick(sessionId)` handler
  - [ ] 5.4: Menu 3 pallini: Shadcn/UI DropdownMenu component
  - [ ] 5.5: Dropdown items: "Rinomina" e "Elimina" con icons
  - **Code reference:** `addendum-zustand-shadcn-session-management.md` Section 4.1
  - **CRITICAL:** `modal={false}` su DropdownMenu + `e.stopPropagation()` su container

- [ ] Task 6: Rename Dialog (AC: 6) â€” 2h
  - [ ] 6.1: Creare `apps/web/src/components/RenameSessionDialog.tsx`
  - [ ] 6.2: Shadcn/UI Dialog con input text precompilato
  - [ ] 6.3: Validation: min 1 char, max 100 chars
  - [ ] 6.4: API call PATCH `/chat/sessions/{id}/metadata` (TO BE IMPLEMENTED backend)
  - [ ] 6.5: Update Zustand store + toast success/error

- [ ] Task 7: Delete Confirmation Dialog (AC: 7, 9) â€” 2h
  - [ ] 7.1: Creare `apps/web/src/components/DeleteSessionDialog.tsx`
  - [ ] 7.2: Shadcn/UI AlertDialog con testo warning
  - [ ] 7.3: Pulsante "Prosegui" con destructive variant (red)
  - [ ] 7.4: API call DELETE con error handling
  - [ ] 7.5: Se sessione corrente: trigger new chat automaticamente
  - [ ] 7.6: Toast notification + rimuovi da Zustand store
  - **Code reference:** `addendum-zustand-shadcn-session-management.md` Section 3.1
  - **CRITICAL:** `e.preventDefault()` in AlertDialogAction.onClick per async handling

- [ ] Task 8: Integration in ChatPage (AC: 3) â€” 1-2h
  - [ ] 8.1: Modificare `apps/web/src/pages/ChatPage.tsx` per integrare sidebar
  - [ ] 8.2: Toggle sidebar state con hook `useSidebarStore`
  - [ ] 8.3: Load conversation handler: chiamata `getSessionHistory` da apiClient
  - [ ] 8.4: Merge history in messages state esistente (riusa logic Story 9.2)

- [ ] Task 9: Header Sandwich Icon (AC: 1) â€” 1h
  - [ ] 9.1: Aggiungere icona â˜° in `apps/web/src/components/Navigation.tsx` (o Header component)
  - [ ] 9.2: Click â†’ toggle sidebar open/close
  - [ ] 9.3: Icon change animato: â˜° â†” âœ• (hamburger â†’ close)
  - [ ] 9.4: Z-index management per overlay mobile

- [ ] Task 10: E2E Testing (AC: 1-10) â€” 2-3h
  - [ ] 10.1: Playwright test: Open sidebar â†’ click "Nuova Chat" â†’ verify new session
  - [ ] 10.2: Playwright test: Load conversation â†’ verify history popolato
  - [ ] 10.3: Playwright test: Rename conversation â†’ verify name aggiornato
  - [ ] 10.4: Playwright test: Delete conversation â†’ verify rimossa + redirect new chat se corrente
  - [ ] 10.5: Playwright test: Responsive behavior mobile vs desktop

## Dev Notes

### ðŸ“š IMPLEMENTATION GUIDANCE

**PRIMARY REFERENCE:** `docs/architecture/addendum-zustand-shadcn-session-management.md`

Questo addendum contiene:
- âœ… Production-ready code snippets per copy-paste
- âœ… Zustand store pattern con persist middleware
- âœ… Shadcn Sheet, AlertDialog, DropdownMenu implementation
- âœ… Common pitfalls e troubleshooting
- âœ… Testing patterns (Vitest + Playwright)
- âœ… Integration checklist step-by-step

**CRITICAL:** Leggere addendum PRIMA di iniziare implementazione. Tutti i pattern sono validati e testati.

---

### Frontend Architecture Context

**UI Component Library**: Shadcn/UI (latest)
- Sheet component per mobile sidebar overlay
- Dialog + AlertDialog per modali rename/delete
- DropdownMenu per menu 3 pallini
- Button variants: default, destructive, ghost
- **Code patterns:** `addendum-zustand-shadcn-session-management.md` Section 2-4

**State Management**: Zustand ~4.x
- Global store per session management
- Persist middleware per localStorage sync
- Actions pattern per modifiche state
- **Full implementation:** `addendum-zustand-shadcn-session-management.md` Section 1

**Riferimenti**: 
- [Primary: docs/architecture/addendum-zustand-shadcn-session-management.md]
- [Source: docs/architecture/sezione-3-tech-stack.md L7-8]
- [Pattern Shadcn/UI: https://ui.shadcn.com/docs/components/sheet]

### Session Metadata Schema

**Frontend TypeScript Interface**:
```typescript
interface SessionMetadata {
  id: string;              // UUID v4
  display_name?: string;   // Custom name o null (default: primi 8 char ID)
  created_at: string;      // ISO 8601 timestamp
  message_count: number;   // Conteggio messaggi (opzionale analytics)
  last_message_at: string; // Ultimo messaggio timestamp
}
```

**Backend Database**: Tabella `chat_messages`
- Metadata `display_name` salvato in colonna JSONB `metadata->>'display_name'`
- Query aggregata per ottenere lista sessioni:
```sql
SELECT 
  session_id,
  metadata->>'display_name' as display_name,
  MIN(created_at) as created_at,
  COUNT(*) as message_count,
  MAX(created_at) as last_message_at
FROM chat_messages
WHERE metadata->>'archived' IS NULL OR metadata->>'archived' != 'true'
GROUP BY session_id
ORDER BY MAX(created_at) DESC;
```

[Source: docs/architecture/sezione-4-modelli-di-dati.md L19-26]

### Backend API Endpoints

**Existing Endpoints** (Story 9.2):
- `GET /api/v1/chat/sessions/{sessionId}/history/full` â€” Riusa per load conversation

**New Endpoints** (Story 9.3):
- `DELETE /api/v1/chat/sessions/{sessionId}` â€” Hard delete implementation
  - SQL: `DELETE FROM chat_messages WHERE session_id = $1`
  - Auth: JWT required
  - Rate limit: 10 req/min per user
  - Response: 204 No Content (success), 404 Not Found, 401 Unauthorized

**To Be Implemented** (optional Story 9.3.1):
- `PATCH /api/v1/chat/sessions/{sessionId}/metadata` â€” Update display_name
  - Body: `{ display_name: string }`
  - SQL: `UPDATE chat_messages SET metadata = metadata || '{"display_name": "..."}' WHERE session_id = $1`

[Source: docs/architecture/sezione-5-specifica-api-sintesi.md L13-15]

### Frontend API Client Pattern

**File**: `apps/web/src/lib/apiClient.ts`

**New Method**: `deleteSession()`
```typescript
class ApiClient {
  async deleteSession(sessionId: string): Promise<void> {
    const response = await fetch(`/api/v1/chat/sessions/${sessionId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${this.getJwtToken()}`,
      }
    });
    
    if (!response.ok) {
      if (response.status === 404) {
        // Sessione giÃ  eliminata o non esiste
        return;
      }
      throw new Error(`HTTP ${response.status}: Failed to delete session`);
    }
  }
}
```

**Error Handling**:
- 404 â†’ silent success (idempotent)
- 401 â†’ redirect to login
- 429 â†’ retry dopo Retry-After header
- 500+ â†’ toast error notification

[Pattern: Story 9.2 Dev Notes L220-273]

### Responsive Breakpoints

**Tailwind CSS Breakpoints**:
- Mobile: default (0-1023px)
- Desktop: `lg:` prefix (â‰¥1024px)

**Sidebar Behavior**:
```tsx
// Mobile: Sheet overlay
<Sheet open={isSidebarOpen} onOpenChange={setIsSidebarOpen}>
  <SheetContent side="left" className="w-80">
    {/* Sidebar content */}
  </SheetContent>
</Sheet>

// Desktop: Persistent aside
<aside className="hidden lg:block w-80 border-r">
  {/* Sidebar content */}
</aside>
```

[Source: docs/architecture/sezione-3-tech-stack.md L25]

### File Structure

**New Files**:
```
apps/web/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ChatSidebar.tsx              # Main sidebar container (NEW)
â”‚   â”œâ”€â”€ SessionListItem.tsx          # Single session item (NEW)
â”‚   â”œâ”€â”€ RenameSessionDialog.tsx      # Rename modal (NEW)
â”‚   â””â”€â”€ DeleteSessionDialog.tsx      # Delete confirmation (NEW)
â”œâ”€â”€ store/
â”‚   â””â”€â”€ sessionStore.ts              # Zustand session state (NEW)
apps/api/api/routers/
â””â”€â”€ chat.py                          # Add DELETE endpoint (MODIFY)
```

**Modified Files**:
```
apps/web/src/pages/ChatPage.tsx      # Integrate sidebar
apps/web/src/components/Navigation.tsx  # Add sandwich icon
apps/web/src/lib/apiClient.ts        # Add deleteSession method
```

### Testing Strategy

**Unit Tests** (Vitest):
- `sessionStore.test.ts`: Zustand actions (add, remove, update session)
- `apiClient.test.ts`: deleteSession method con mock fetch
- **Test patterns:** `addendum-zustand-shadcn-session-management.md` Section 6.1

**Integration Tests** (React Testing Library):
- ChatSidebar component: render, toggle, session list
- SessionListItem: click load, menu dropdown
- Dialogs: rename/delete con form submission
- **Test patterns:** `addendum-zustand-shadcn-session-management.md` Section 6.2

**E2E Tests** (Playwright):
- Full flow: open sidebar â†’ new chat â†’ rename â†’ delete
- Responsive behavior mobile/desktop
- Error scenarios: delete 404, network errors
- **Test patterns:** `addendum-zustand-shadcn-session-management.md` Section 6.3

**Validation Checklist:** `addendum-zustand-shadcn-session-management.md` Section 5.3

[Source: docs/architecture/sezione-3-tech-stack.md L17-19]

### Performance Considerations

**Session List Optimization**:
- Virtual scrolling se >50 sessioni (react-window o TanStack Virtual)
- Lazy loading: fetch iniziale 20 sessioni piÃ¹ recenti
- Infinite scroll per caricamento incrementale

**State Management**:
- Zustand store separato da chat messages (no re-render chat on session list update)
- Debounce rename input (300ms) per evitare multiple API calls

**Backend Query Performance**:
- Index esistente `idx_chat_messages_session_created` ottimizza query lista sessioni
- Pagination backend (limit 50 per page) per grandi dataset

[Source: Story 9.2 Dev Notes L436-452]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Initial story draft - Chat session management UI con sidebar, CRUD operations, responsive design | Bob (SM) |
| 2025-01-17 | 1.1 | **Implementation guidance update**: Aggiunto riferimento a `addendum-zustand-shadcn-session-management.md` con production-ready code patterns, pitfalls, e test strategies. Dev Notes espansi con link diretti a sezioni specifiche per ogni Task. | Architect Agent |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be populated by QA agent_

