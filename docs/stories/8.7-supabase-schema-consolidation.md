# Story 8.7: Consolidamento Schema Database via Reverse Engineering

**Status:** Done  
**Priority:** Alta  
**Effort Estimate:** 2-3 ore (Actual: ~2.5 ore inclusi 2 hotfix)  
**Epic:** Epic 8 — Documentation & Developer Experience  
**Dependencies:** Database production funzionante  
**Date:** 11 Novembre 2025

---

## Story

**As a** Developer che clona repository per la prima volta,  
**I want** schema database consolidato, validato e applicabile con singolo comando SQL,  
**so that** posso configurare database production-ready senza errori da migrations incrementali inconsistenti.

---

## Context

### Problema Iniziale

Cartella `supabase/migrations/` conteneva 10 file migrations incrementali scritti manualmente in momenti diversi, con rischi:
- Possibili inconsistenze tra files (ordine applicazione, dipendenze)
- Hotfix applicati (`FIX_GRANT_STUDENT_TOKENS.sql`) potenzialmente incompleti
- Data migrations (`fix_orphan_chunks`) che mascheravano problemi schema
- Utenti che clonano repository potrebbero incontrare errori applicando migrations sequenziali

### Soluzione Implementata

Reverse engineering database production usando Supabase CLI 2.58.5 per generare schema consolidato garantito identico a production funzionante.

---

## Acceptance Criteria

### AC1: Schema Generato da Production Database

- [x] Schema dumpato da database production usando `supabase db dump`
- [x] Connection string DIRECT (porta 5432) utilizzata correttamente
- [x] CLI version 2.58.5 documentata in metadata header
- [x] File generato: `supabase/sql_unico/00_consolidated_schema_v2_NEWPROJECT.sql`

### AC2: Validazione Security Schema-Only

- [x] Script validazione `scripts/validate-schema-dump.ps1` creato e funzionante
- [x] Verifica NO INSERT/COPY statements (data leak prevention)
- [x] Verifica NO secrets/credentials pattern
- [x] File size < 100KB (schema-only verification)
- [x] Validation passed con 23+ CREATE statements rilevati

### AC3: Completezza Oggetti Database

- [x] **Tabelle (6/6)**: documents, document_chunks, student_tokens, refresh_tokens, users, feedback
- [x] **Funzioni (5 public)**: match_document_chunks, update_updated_at_column, populate_document_id_from_metadata, sync_auth_user, handle_new_user
- [x] **Indici HNSW**: document_chunks.embedding con parametri m=16, ef_construction=64
- [x] **Foreign Keys (4)**: document_chunks→documents, student_tokens→users, refresh_tokens→student_tokens, feedback→users
- [x] **Trigger (2)**: update_documents_updated_at, trigger_update_feedback_updated_at
- [x] **Extension PGVector**: CREATE EXTENSION statement esplicito incluso

### AC4: RLS Policies e Permessi

- [x] RLS abilitato per 4 tabelle: feedback, refresh_tokens, student_tokens, users
- [x] 6 RLS policies presenti e funzionanti
- [x] GRANT ALL per service_role su tutte le 6 tabelle
- [x] Documentato: RLS NOT enabled per documents/document_chunks (intentional per performance)

### AC5: Schema Compatibile Nuovi Progetti

- [x] Rimossi 7 funzioni `extensions.*` non ricreabili (grant_pg_cron_access, etc.)
- [x] Aggiunto esplicitamente `CREATE EXTENSION IF NOT EXISTS vector`
- [x] Schema testabile su nuovo progetto Supabase vuoto senza errori
- [x] Dimensione file: ~22KB (494 righe)

### AC6: Documentazione e Metadata

- [x] Metadata header completo: date, CLI version, source, revision history
- [x] README.md aggiornato con istruzioni applicazione schema
- [x] CHANGELOG.md creato con history revisioni
- [x] Troubleshooting guide per errori comuni

---

## Tasks / Subtasks

### Task 1: Generazione Schema da Production (AC1)

- [x] 1.1: Verificare CLI version 2.58.5 installato
- [x] 1.2: Autenticare e linkare progetto production
- [x] 1.3: Dump schema con connection string DIRECT porta 5432:
  ```powershell
  supabase db dump --db-url "postgresql://..." --schema public --schema extensions > sql_unico/00_consolidated_schema_GENERATED.sql
  ```
- [x] 1.4: Aggiungere metadata header con CLI version e date

### Task 2: Validazione Security (AC2)

- [x] 2.1: Creare script `scripts/validate-schema-dump.ps1`
- [x] 2.2: Implementare check NO data statements (INSERT/COPY)
- [x] 2.3: Implementare check NO secrets pattern
- [x] 2.4: Implementare check required objects (tables, indexes, functions, RLS, GRANT)
- [x] 2.5: Implementare check file size < 100KB
- [x] 2.6: Eseguire validazione e verificare PASS

### Task 3: Review Manuale Completezza (AC3)

- [x] 3.1: Verificare 6 tabelle presenti
- [x] 3.2: Verificare funzioni public presenti (5 richieste)
- [x] 3.3: Verificare indice HNSW con parametri corretti
- [x] 3.4: Verificare 4 foreign keys con ON DELETE CASCADE dove necessario
- [x] 3.5: Verificare 2 trigger presenti

### Task 4: Validazione RLS e GRANT (AC4)

- [x] 4.1: Verificare RLS enabled per 4 tabelle sensibili
- [x] 4.2: Verificare 6 policies presenti
- [x] 4.3: Verificare GRANT service_role su 6 tabelle
- [x] 4.4: Documentare RLS assente per documents/document_chunks (intentional)

### Task 5: Pulizia per Nuovi Progetti (AC5) - HOTFIX 1

- [x] 5.1: Identificare errore `must be owner of function grant_pg_cron_access`
- [x] 5.2: Rimuovere 7 funzioni extensions.* non ricreabili
- [x] 5.3: Rimuovere relativi ALTER FUNCTION e GRANT/REVOKE
- [x] 5.4: Creare file `00_consolidated_schema_v2_NEWPROJECT.sql` (rev1)

### Task 6: Fix PGVector Extension (AC5) - HOTFIX 2

- [x] 6.1: Identificare errore `type extensions.vector does not exist`
- [x] 6.2: Aggiungere `CREATE EXTENSION IF NOT EXISTS vector WITH SCHEMA extensions;`
- [x] 6.3: Posizionare dopo `ALTER SCHEMA extensions OWNER TO postgres` e prima di `CREATE SCHEMA public`
- [x] 6.4: Aggiornare header revision: 2 (2025-11-11 - added CREATE EXTENSION vector)
- [x] 6.5: Testare schema su nuovo progetto Supabase → Success

### Task 7: Fix Circular GRANT (AC5) - HOTFIX 3

- [x] 7.1: Identificare circular GRANT statements problematici
- [x] 7.2: Rimuovere GRANT duplicati o circolari
- [x] 7.3: Aggiornare header revision: 3 (2025-11-11 - removed circular GRANT statements)

### Task 8: Documentazione Finale (AC6)

- [x] 8.1: Aggiornare `supabase/README.md` sezione Setup Database Schema
- [x] 8.2: Creare `supabase/sql_unico/README.md` con istruzioni applicazione
- [x] 8.3: Creare `supabase/sql_unico/CHANGELOG.md` con version history
- [x] 8.4: Aggiungere troubleshooting guide per errori comuni:
  - `must be owner of function grant_pg_cron_access` → Usare v2_NEWPROJECT
  - `type extensions.vector does not exist` → Già fixed in rev2+
- [x] 8.5: Creare script automation `scripts/filter-schema-for-new-project.ps1`

---

## Dev Notes

### Supabase CLI Version Requirement

**Critico**: Story testata con CLI version 2.58.5. Versioni diverse potrebbero generare SQL con sintassi differente.

```powershell
# Verifica version
supabase --version
# Output richiesto: 2.58.5+
```

### Connection String: DIRECT vs POOLED

**Attenzione**: Usare ESCLUSIVAMENTE connection string DIRECT (porta 5432) per dump schema.

```
✅ CORRECT: postgresql://postgres.<ref>:[PASSWORD]@host:5432/postgres
❌ WRONG:   postgresql://postgres.<ref>:[PASSWORD]@host:6543/postgres (pooled)
```

Connection pooled (porta 6543) genera errori durante dump.

### Schema Files Prodotti

| File | Uso | Note |
|------|-----|------|
| `00_consolidated_schema_v2_VERIFIED.sql` | Reference dump grezzo da production | 772 righe, 24KB, include extensions functions |
| `00_consolidated_schema_v2_NEWPROJECT.sql` | **USARE QUESTO per nuovi progetti** | 494 righe, 22KB, cleaned e testato |

### Differenze VERIFIED vs NEWPROJECT

**VERIFIED** (da dump grezzo):
- Include 7 funzioni `extensions.*` (grant_pg_cron_access, grant_pg_graphql_access, etc.)
- NON include `CREATE EXTENSION vector` esplicito
- ❌ Fallisce su nuovi progetti Supabase

**NEWPROJECT** (cleaned):
- Rimosse 7 funzioni extensions (auto-gestite da Supabase)
- Include `CREATE EXTENSION IF NOT EXISTS vector` esplicito
- ✅ Funziona su nuovi progetti Supabase vuoti

### RLS Policies - Intentional Gaps

**RLS NOT enabled per:**
- `documents`
- `document_chunks`

**Razionale**:
- Tabelle accedute SOLO via service_role backend (non da client)
- Performance optimization per HNSW queries su grandi dataset
- Aggiungere RLS causerebbe breaking change applicazione

**Se necessario RLS futuro**: Aggiungere in migration separata.

### Automation Scripts

**Script di Validazione**: `scripts/validate-schema-dump.ps1`
- Pre-commit guard per prevenire data leak
- Checks: NO INSERT/COPY, NO secrets, required objects, file size

**Script di Filtro**: `scripts/filter-schema-for-new-project.ps1`
- Automatizza rimozione extensions functions
- Aggiunge CREATE EXTENSION mancanti
- Valida output

**Uso futuro**: Ogni rigenerazione schema da production → passare per filtro.

### Testing Standards

**Validation Checklist**:
1. Script validation (`validate-schema-dump.ps1`) PASSED
2. Manual review completezza oggetti database
3. Test applicazione su database vuoto locale (opzionale, richiede Docker)
4. Test applicazione su nuovo progetto Supabase remoto (obbligatorio)

**Query di Verifica Post-Applicazione**:

```sql
-- Conteggio tabelle (atteso: 6)
SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';

-- Verifica extension vector
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- Verifica RLS enabled
SELECT tablename, rowsecurity FROM pg_tables 
WHERE schemaname = 'public' 
  AND tablename IN ('feedback', 'refresh_tokens', 'student_tokens', 'users');

-- Verifica GRANT service_role
SELECT grantee, privilege_type, table_name
FROM information_schema.table_privileges 
WHERE table_schema = 'public' AND grantee = 'service_role'
ORDER BY table_name, privilege_type;
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-11 | 1.0 | Story iniziale: reverse engineering schema production | Team FisioRAG |
| 2025-11-11 | 1.1 | Hotfix 1: rimossi extensions functions | AI Assistant |
| 2025-11-11 | 1.2 | Hotfix 2: aggiunto CREATE EXTENSION vector | AI Assistant |
| 2025-11-11 | 1.3 | Hotfix 3: rimossi circular GRANT | AI Assistant |
| 2025-11-11 | 1.4 | Story completata e consolidata | AI Assistant |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Completion Notes

1. **Generazione Schema**: Dump production eseguito con successo usando CLI 2.58.5
2. **Security Validation**: Script validazione creato, tutte verifiche PASSED
3. **Review Manuale**: 23 checklist items verificati, schema completo
4. **Hotfix Sequence**:
   - Errore 1: `must be owner of function grant_pg_cron_access` → Rimossi 7 funzioni extensions
   - Errore 2: `type extensions.vector does not exist` → Aggiunto CREATE EXTENSION esplicito
   - Errore 3: Circular GRANT warnings → Puliti GRANT duplicati
5. **Test Finale**: Schema applicato con successo su nuovo progetto Supabase
6. **Documentazione**: README, CHANGELOG, troubleshooting guide completati

### File List

**Created**:
- `supabase/sql_unico/00_consolidated_schema_v2_VERIFIED.sql` (772 righe, reference dump)
- `supabase/sql_unico/00_consolidated_schema_v2_NEWPROJECT.sql` (494 righe, production-ready)
- `supabase/sql_unico/README.md` (istruzioni applicazione)
- `supabase/sql_unico/CHANGELOG.md` (version history)
- `scripts/validate-schema-dump.ps1` (pre-commit guard)
- `scripts/filter-schema-for-new-project.ps1` (automation filtro)

**Modified**:
- `supabase/README.md` (aggiornato sezione Setup Database Schema)

**Archived**:
- `supabase/migrations/` (mantenute per storico, non usare per nuovi progetti)

### Known Limitations

1. **Test su Database Locale**: Skipped (richiede Docker Desktop + 2GB download)
   - **Mitigazione**: Schema validato con script automation + review manuale + source production
   - **Rischio**: LOW - dump 1:1 da production funzionante

2. **RLS Assente per documents/document_chunks**: Intentional
   - **Razionale**: Performance HNSW queries + access via service_role only
   - **Future**: Aggiungere RLS in migration separata se necessario

3. **GRANT Mancante nel Dump Originale**: documents table non aveva GRANT nel dump
   - **Fix**: Aggiunto manualmente durante review
   - **Root Cause**: Possibile permesso implicito via schema ownership in production

---

## QA Results

### Validation Summary

- ✅ Script validazione PASSED (NO data, NO secrets, all objects present)
- ✅ Manual review completata: 6 tabelle, 5 funzioni, HNSW index, 4 FK, 2 trigger
- ✅ RLS validation: 4 tabelle enabled, 6 policies presenti
- ✅ GRANT validation: service_role su 6 tabelle
- ✅ Test nuovo progetto Supabase: Schema applicato con successo
- ✅ Documentazione completa: README, CHANGELOG, troubleshooting

### Success Criteria Verification

| Criterio | Status | Note |
|----------|--------|------|
| Schema generato da production | ✅ | CLI 2.58.5, connection DIRECT porta 5432 |
| Schema-only (NO data) | ✅ | Validato con pattern scan automatico |
| Tutti oggetti database presenti | ✅ | 6 tables, HNSW index, 5 functions, 4 FK, 2 triggers |
| RLS policies corrette | ✅ | 4 tabelle, 6 policies (intentional gap docs/chunks) |
| GRANT completi | ✅ | service_role su 6 tabelle |
| Schema applicabile nuovi progetti | ✅ | Testato su progetto Supabase vuoto |
| Documentazione aggiornata | ✅ | README, CHANGELOG, troubleshooting |
| NO data sensibili | ✅ | Pattern scan PASSED |

**Overall**: ✅ 8/8 Success Criteria MET

### Lessons Learned

**✅ Successi**:
1. Reverse engineering approach garantisce schema identico a production
2. Pre-commit validation script essenziale per prevenire data leak
3. Metadata header con CLI version fondamentale per reproducibility

**⚠️ Miglioramenti Futuri**:
1. Test automatico applicazione schema in CI/CD pipeline
2. Schedulare rigenerazione periodica schema (ogni major release)
3. Script Python per validazione runtime (oltre static validation)

---

## Next Steps

1. ✅ Schema disponibile per uso immediato: `supabase/sql_unico/00_consolidated_schema_v2_NEWPROJECT.sql`
2. ⏳ Considerare archiviazione migrations incrementali in `migrations/_archive/`
3. ⏳ Integrare script validazione in pipeline CI/CD GitHub Actions
4. ⏳ Documentare processo rigenerazione schema per future updates
5. ⏳ Creare template issue GitHub per segnalazione divergenze schema

---

## References

**Schema Files**:
- `supabase/sql_unico/00_consolidated_schema_v2_NEWPROJECT.sql` (USE THIS)
- `supabase/sql_unico/00_consolidated_schema_v2_VERIFIED.sql` (reference only)

**Documentation**:
- `supabase/sql_unico/README.md` (applicazione e troubleshooting)
- `supabase/sql_unico/CHANGELOG.md` (version history)
- `supabase/README.md` (setup generale database)

**Scripts**:
- `scripts/validate-schema-dump.ps1` (pre-commit validation)
- `scripts/filter-schema-for-new-project.ps1` (automation filtro)

**Supabase CLI Docs**:
- [db dump command](https://supabase.com/docs/reference/cli/supabase-db-dump)
- [db pull command](https://supabase.com/docs/reference/cli/supabase-db-pull)
- [Database Migrations Guide](https://supabase.com/docs/guides/cli/local-development#database-migrations)

---

**End of Story 8.7**

