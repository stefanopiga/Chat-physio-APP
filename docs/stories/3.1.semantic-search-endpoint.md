# Story 3.1: Semantic Search Endpoint

**Status:** Done

## Story

**As a** Sviluppatore Backend,
**I want** un endpoint per eseguire una ricerca di similarità,
**so that** possiamo recuperare i chunk pertinenti.

[Fonte: `docs/prd/sezione-9-epic-3-dettagli-interactive-rag-experience.md`]

## Acceptance Criteria

1. Endpoint `/api/v1/chat/query` protetto.
2. La domanda viene convertita in embedding.
3. Esegue query di similarità su Supabase.
4. Restituisce i top N chunk.

[Fonte: `docs/prd/sezione-9-epic-3-dettagli-interactive-rag-experience.md`]

## Dev Notes

### Previous Story Insights
- L'indice vettoriale e la funzione di matching sono già predisposti nella Story 2.4.
  - `document_chunks.embedding vector(1536)` con indice HNSW `vector_cosine_ops`.
  - Funzione SQL `match_document_chunks(query_embedding vector(1536), match_threshold float, match_count int)`.
  [Fonti: `docs/stories/2.4.vector-indexing-in-supabase.md` L32–L36; `docs/architecture/addendum-pgvector-langchain-supabase.md` L31–L55, L61–L63]

### Data Models
- `DocumentChunk`: `id`, `document_id`, `content`, `embedding`, `metadata`, `created_at`, `updated_at`.
- `ChatMessage`: `id`, `session_id`, `role`, `content`, `source_chunk_ids`, `metadata`, `created_at`.
[Fonte: `docs/architecture/sezione-4-modelli-di-dati.md` L15–L26]

### Supabase / pgvector
- Estensione `pgvector` abilitata e tabella con colonna `vector(1536)`.
- Funzione `match_document_chunks` per similarità coseno con operatore `<=>`.
- Indice HNSW su `embedding` con `vector_cosine_ops`.
[Fonte: `docs/architecture/addendum-pgvector-langchain-supabase.md` L5–L11, L28–L55, L57–L63]
### API Specifications

- Host: `/api/v1`
- Sicurezza: JWT Bearer Token (Supabase Auth)
- Endpoint:
  - POST `/chat/query` (prefisso host `/api/v1` → percorso completo: `/api/v1/chat/query`) — Request body: `{ sessionId: string, question: string, match_threshold?: number, match_count?: number }`
    - Body: `{ "sessionId": string, "question": string, "match_threshold"?: number, "match_count"?: number }`
    - Risposta (200): `{ "chunks": Array<{ id: string, document_id: string, content: string, similarity: number }> }`
    - Errori: 401 (unauthorized), 429 (rate limited), 500 (internal)
[Fonti: `docs/architecture/sezione-5-specifica-api-sintesi.md` L7–L15; `docs/prd/sezione-9-epic-3-dettagli-interactive-rag-experience.md` L5–L8]

Esempio FastAPI (schematico):
```python
# apps/api/api/chat.py (estratto, schematico)
from fastapi import APIRouter, Depends
from langchain_openai import OpenAIEmbeddings
from langchain_community.vectorstores import SupabaseVectorStore
from supabase import create_client
import os

router = APIRouter(prefix="/api/v1/chat", tags=["chat"])

@router.post("/query")
async def query_chat(payload: dict, user=Depends(require_auth)):
    question = payload["question"]
    match_threshold = payload.get("match_threshold", 0.75)
    match_count = payload.get("match_count", 8)

    embeddings = OpenAIEmbeddings(model="text-embedding-3-small")
    supabase = create_client(os.environ["SUPABASE_URL"], os.environ["SUPABASE_SERVICE_KEY"])
    store = SupabaseVectorStore(
        embedding=embeddings,
        client=supabase,
        table_name="document_chunks",
        query_name="match_document_chunks",
    )
    docs = store.similarity_search_with_relevance_scores(question, k=match_count, score_threshold=match_threshold)
    return {"chunks": [
        {"id": d[0].metadata.get("id"), "document_id": d[0].metadata.get("document_id"), "content": d[0].page_content, "similarity": float(d[1])}
        for d in docs
    ]}
```
[Fonti: `docs/architecture/addendum-pgvector-langchain-supabase.md` L77–L124, L126–L138]
## Testing

- Backend (Pytest + HTTPX): test async dell'endpoint `/api/v1/chat/query` con mocking di OpenAIEmbeddings e SupabaseVectorStore; validare che `k` e `score_threshold` predefiniti siano rispettati e che la risposta contenga `top N` risultati.
- LLM Evals: dataset di domande e valutazione quality con Ragas; non bloccante per questa story ma tracciato per Epic 3.
- Coverage >= 80% sul nuovo codice.
[Fonti: `docs/architecture/sezione-11-strategia-di-testing.md` L3–L9, L31–L35]

## Sicurezza e Performance

- Autenticazione: JWT Supabase; l'API usa solo chiavi server-side per Supabase.
- Rate limiting: applicato per prevenire abuso dell'endpoint di ricerca.
- Target: p95 < 500ms per query standard con indice HNSW attivo.
[Fonti: `docs/architecture/sezione-10-sicurezza-e-performance.md` L3–L6, L18–L23; `docs/stories/2.4.vector-indexing-in-supabase.md` L49–L51]

## Technical Constraints

- Python 3.11, FastAPI, LangChain, Supabase, OpenAI Embeddings.
[Fonti: `docs/architecture/sezione-3-tech-stack.md` L9–L14, L11]

## File Locations

- Monorepo: `/`
- Backend: `/apps/api/`
- Docs: `/docs/`
[Fonti: `docs/architecture/sezione-7-struttura-unificata-del-progetto.md`]

## Tasks / Subtasks

- [x] Backend: Implementare endpoint `/api/v1/chat/query` con conversione domanda→embedding e query su Supabase. (AC: 1–4)
- [x] Backend: Aggiungere test unit/integration dell'endpoint con mocking embedding/vector store. (Testing)
- [x] Security: Abilitare rate limiting coerente con la strategia definita. (Sicurezza)

## Dev Agent Record

### Agent Model Used
GPT-5

### Debug Log References
- Vector store e embeddings: `apps/api/api/knowledge_base/indexer.py` (per riferimento configurazioni embedding e client Supabase)
- Migrazioni e funzione SQL: `supabase/migrations/20250922000000_create_document_chunks.sql`
- Sicurezza/Rate limiting: `docker-compose.yml` (config gateway), `apps/api/api/main.py` (middleware RL)
[Fonti: `docs/stories/2.4.vector-indexing-in-supabase.md`; `docs/qa/assessments/2.4-nfr-20250924.md` L6–L9]

- Endpoint implementato: `apps/api/api/main.py` (`POST /api/v1/chat/query`) con rate limit `60/minute`.
- Test endpoint: `apps/api/tests/test_chat_query.py` (mock `perform_semantic_search`, auth monkeypatch).

### Completion Notes List
- Endpoint implementato con rate limit e auth: `POST /api/v1/chat/query` in `apps/api/api/main.py`.
- Fix SlowAPI: aggiunto parametro `request: Request` alla firma dell'handler `chat_query_endpoint`.
- Test mirati: `poetry run pytest -q -k chat_query` → 1 passed, 27 deselected.
- Suite completa: da eseguire in ambiente poetry per evitare errori di dipendenze di sistema.

### File List
- apps/api/api/main.py
- apps/api/tests/test_chat_query.py

## QA Results

```text
NFR Assessment

- Performance: Target p95 < 500ms (fonte: docs/architecture/sezione-10-sicurezza-e-performance.md; questa story, sezione "Sicurezza e Performance"). Evidenza misurazione p95 per /api/v1/chat/query: non disponibile nella fonte.

- Sicurezza: Endpoint protetto con JWT Bearer tramite dependency `_verify_jwt_token_runtime` (fonte: apps/api/api/main.py, definizione `chat_query_endpoint`). Rate limiting applicato `60/minute` (fonte: apps/api/api/main.py, decorator `@limiter.limit("60/minute")`).

- Affidabilità: Non specificati requisiti di resilienza/reattempt per /api/v1/chat/query in questa story (non disponibile nella fonte).

- Osservabilità: Middleware di logging richieste globale attivo (fonte: apps/api/api/main.py, middleware `@app.middleware("http")`). Evidenza logging specifico per /api/v1/chat/query: non disponibile nella fonte.

- Evidenza Test: `poetry run pytest -q -k chat_query` → 1 passed, 27 deselected (fonte: terminale fornito dall'utente).
```

### Trace
- AC1 (endpoint protetto): implementato `POST /api/v1/chat/query` con auth via `_verify_jwt_token_runtime` e rate limiting `60/minute` (fonte: `apps/api/api/main.py`). Test mirato presente (fonte: `apps/api/tests/test_chat_query.py`).
- AC2 (conversione domanda→embedding): conversione gestita dal modello `OpenAIEmbeddings(model="text-embedding-3-small")` usato in ricerca (fonte: `apps/api/api/knowledge_base/search.py`).
- AC3 (query similarità su Supabase): uso di `SupabaseVectorStore` con tabella `document_chunks` e funzione `match_document_chunks` (fonte: `apps/api/api/knowledge_base/search.py`).
- AC4 (restituzione top N chunk): parametro `match_count` supportato dall’endpoint e validato nel test con `match_count=2` → 2 risultati (fonte: `apps/api/api/main.py`; `apps/api/tests/test_chat_query.py`).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-24 | 0.1 | Bozza iniziale Story 3.1 | SM |
| 2025-09-24 | 1.0 | Implementazione endpoint + test; stato impostato a Ready for Review | DEV |

## PO Validation Report

### Template Compliance Issues

- non disponibile nella fonte

### Critical Issues (Must Fix - Story Blocked)

- non disponibile nella fonte

### Should-Fix Issues (Important Quality Improvements)

- Integrare test di errore (401, 429) nella suite. [Fonte: `docs/qa/gates/3.1-semantic-search-endpoint.yml` L9–L10]

### Nice-to-Have Improvements (Optional Enhancements)

- Verificare p95 < 500ms in staging con dataset realistico. [Fonte: `docs/qa/gates/3.1-semantic-search-endpoint.yml` L9]

### Anti-Hallucination Findings

- Le affermazioni tecniche presenti citano fonti nel repository. [Fonti: `docs/architecture/addendum-pgvector-langchain-supabase.md`; `docs/architecture/sezione-5-specifica-api-sintesi.md`; `docs/architecture/sezione-10-sicurezza-e-performance.md`; `docs/architecture/sezione-11-strategia-di-testing.md`; `docs/stories/2.4.vector-indexing-in-supabase.md`]

### Final Assessment

- GO
- Implementation Readiness Score: non disponibile nella fonte
- Confidence Level: non disponibile nella fonte
