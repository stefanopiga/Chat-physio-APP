# Story 2.6.1: Production Infrastructure Critical Fixes (P1 Issues)

**Status:** Done

## Metadata
- **ID**: 2.6.1
- **Type**: Infrastructure / DevOps / Bugfix
- **Epic**: Epic 2 ‚Äî Core RAG Knowledge Pipeline
- **Priority**: P1 - High Priority (Must Fix Before Production)
- **Complexity**: Medium
- **Effort Estimate**: 3 ore
- **Dependencies**: Story 2.6 (RAG System Production Readiness Validation) ‚Äî ‚úÖ Completata
- **Blocks**: Production Deployment
- **Scope**: Docker Compose, Traefik, Database Configuration

---

## Story

**As a** DevOps Engineer / System Administrator,  
**I want** risolvere i 3 problemi critici P1 identificati in Story 2.6 production readiness validation,  
**so that** il sistema RAG sia deployable in ambiente production con garanzie di affidabilit√†, data persistence e monitoring operativo.

**Business Value**: Sbloccare deployment production; garantire data durability (Redis); abilitare health monitoring (API endpoint); risolvere database connectivity per validazione integrity.

---

## Context & Background

### Initial State (Post Story 2.6 Validation)

**Production Readiness Status:** ‚ö†Ô∏è **NOT READY** (Story 2.6 - 2025-10-10)

**Critical Blockers Identified (P1):**

```
Story 2.6 Validation Results:
- AC1 (Environment Audit): ‚úÖ PASS
- AC2 (Infrastructure Health): ‚ö†Ô∏è CONCERNS  
- AC3 (Database Integrity): ‚ùå BLOCKED
- AC4 (Performance Benchmarks): üö´ NOT EXECUTED (DB dependency)
- AC5 (Security Review): üö´ NOT EXECUTED (planned)
- AC6 (Deployment Checklist): üö´ NOT CREATED (planned)
```

**3 P1 Issues (Must Fix):**

#### P1-1: Database Connectivity Failure
**Severity:** P1 (Blocks validation & production)  
**Report:** `docs/reports/rag-database-integrity.md`  
**Symptom:** `ConnectionRefusedError: [WinError 1225] Il computer remoto ha rifiutato la connessione di rete`

**Impact:**
- Impossibile eseguire database integrity audit (AC3)
- Impossibile validare orphan documents/NULL embeddings
- Impossibile eseguire performance benchmarks (AC4)
- Production deployment bloccato

**Root Cause Analysis (ipotesi):**
1. `DATABASE_URL` non configurato correttamente in `.env`
2. Format connection string invalido (pooler vs direct, SSL params)
3. Network connectivity a Supabase endpoint bloccato (firewall/proxy)
4. Credenziali scadute o permissions insufficienti
5. Database Supabase in pausa/suspended (free tier limit)

#### P1-2: Redis Data Persistence Mancante
**Severity:** P1 (Data loss risk)  
**Report:** `docs/reports/rag-config-gap-analysis.md`  
**Symptom:** Redis container senza volume mounted ‚Üí data loss on restart

**Impact:**
- **Celery task results** persi al restart container
- **Rate limiting data** persi ‚Üí bypass rate limit post-restart
- **Session data** persi (se implementato)
- Comportamento imprevedibile production (restart normali per deploy/update)

**Current State:**
```yaml
# docker-compose.yml - redis service
redis:
  image: redis:alpine
  container_name: fisio-rag-redis
  networks:
    - fisio-rag-net
  # ‚ùå MISSING: volume mount per data persistence
```

**Expected State:**
```yaml
redis:
  image: redis:alpine
  volumes:
    - redis_data:/data  # ‚úÖ Persistent storage
  command: redis-server --appendonly yes  # ‚úÖ AOF persistence
```

#### P1-3: Traefik Health Endpoint Routing Conflict
**Severity:** P1 (Monitoring blocked)  
**Report:** `docs/reports/rag-infrastructure-health.md`  
**Symptom:** `curl http://localhost/health` returns HTML (web frontend) instead of JSON (API)

**Impact:**
- Health monitoring broken (ops team blind)
- Cannot detect API failures proactively
- Docker healthcheck cannot validate API status
- Load balancer health checks fail (se deployed con LB)

**Current Routing (Traefik labels):**
```yaml
# docker-compose.yml
api:
  labels:
    - "traefik.http.routers.api-router.rule=Host(`localhost`) && PathPrefix(`/api`)"
    - "traefik.http.routers.api-router.priority=100"

web:
  labels:
    - "traefik.http.routers.web-router.rule=Host(`localhost`)"
    # ‚ùå PROBLEM: Priority non definita, default bassa
    #    /health cade in web fallback (non match /api prefix)
```

**Root Cause:** `/health` endpoint non matcha `/api` prefix ‚Üí Traefik route a web service (catch-all).

---

## Acceptance Criteria

### AC1: Database Connectivity Validated ‚úÖ

**Given** sistema con `.env` file configurato  
**When** script database integrity audit viene eseguito  
**Then**:
- Connection successful a Supabase PostgreSQL
- Query `SELECT 1` returns result
- DATABASE_URL format validato e documentato
- Troubleshooting guide creata per connection errors

**Validation:**
```powershell
# Test connection
python scripts/validation/database_connectivity_test.py

# Expected output:
# ‚úÖ Database connection: SUCCESS
# ‚úÖ Query execution: SUCCESS  
# ‚úÖ pgvector extension: PRESENT
# Database: <project_id>.supabase.co
# Pool size: 20
```

### AC2: Redis Data Persistence Configured ‚úÖ

**Given** Redis service in docker-compose.yml  
**When** volume mount e AOF persistence vengono configurati  
**Then**:
- Named volume `redis_data` definito
- Volume mounted su `/data` in container
- Redis AOF persistence abilitato (`appendonly yes`)
- Data survived restart test

**Validation:**
```powershell
# Set test key
docker exec fisio-rag-redis redis-cli SET test_key "test_value"

# Restart Redis
docker compose restart redis

# Verify data persists
docker exec fisio-rag-redis redis-cli GET test_key
# Expected: "test_value"

# Verify AOF file exists
docker exec fisio-rag-redis ls -lh /data/appendonly.aof
# Expected: file present, size > 0
```

### AC3: Traefik Health Endpoint Routing Fixed ‚úÖ

**Given** API service con `/health` endpoint  
**When** request HTTP a `http://localhost/health` viene eseguita  
**Then**:
- Response Content-Type: `application/json`
- Response body: `{"status":"ok"}` (or equivalent)
- NO HTML response (web frontend)
- Routing priority API > web

**Validation:**
```powershell
# Test health endpoint
curl http://localhost/health

# Expected response:
# HTTP/1.1 200 OK
# Content-Type: application/json
# {"status":"ok"}

# NOT expected:
# <!doctype html> (web frontend)
```

### AC4: Infrastructure Health Matrix Green ‚úÖ

**Given** tutti P1 fixes applicati  
**When** script `docker_health_check.py` viene rieseguito  
**Then**:
- API health endpoint: ‚úÖ OK (JSON response)
- Redis connectivity: ‚úÖ OK (PONG response)
- Database connectivity: ‚úÖ OK (connection successful)
- Celery worker: ‚úÖ OK (ready status)
- Overall status: ‚úÖ PASS

**Validation:**
```powershell
python scripts/validation/docker_health_check.py

# Expected output:
# Overall Status: ‚úÖ PASS
# - API Health: OK
# - Redis Connectivity: OK
# - Database Connection: OK  
# - Celery Worker: OK
```

### AC5: Production Readiness Documentation Updated ‚úÖ

**Given** P1 fixes completati  
**When** documentazione viene aggiornata  
**Then**:
- `docs/troubleshooting/docker-infrastructure.md` creato
- `docs/troubleshooting/database-connectivity.md` creato
- `docker-compose.yml` annotato con commenti best practices
- `docs/reports/rag-production-readiness-summary.md` updated (P1 ‚Üí resolved)

---

## Tasks / Subtasks

**NOTA AMBIENTE:** Tutti comandi terminal per **PowerShell** (Windows 10). Workspace: `C:\Users\user\Desktop\Claude-Code\fisio-rag-master\APPLICAZIONE`.

### Pre-Task: Validation Baseline

_Nota: le attivit√† di baseline non sono state eseguite (ambiente gi√† documentato in Story 2.6, nessuna modifica applicata prima dei fix)._ 

- [ ] **Task 0: Capture Current State** (Baseline)
  - [ ] **Subtask 0.1: Backup Configurazione Attuale**
    - [ ] Backup `docker-compose.yml` ‚Üí `docker-compose.yml.backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')`
    - [ ] Backup `.env` file (se modifiche necessarie) ‚Üí `.env.backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')`
    - [ ] Commit git pre-fix: `git commit -am "Backup: Pre Story 2.6.1 fixes"`
  
  - [ ] **Subtask 0.2: Document Current Behavior**
    - [ ] Execute `curl http://localhost/health` ‚Üí save output `temp/pre-fix-health-response.txt`
    - [ ] Execute `docker exec fisio-rag-redis redis-cli GET test_key_persistence` (should fail: key not exist)
    - [ ] Attempt database connection test (expected: connection refused)
    - [ ] Save all outputs as baseline evidence

---

### Phase 1: Database Connectivity Fix (P1-1)

- [x] **Task 1: DATABASE_URL Diagnosis & Fix** (AC: 1)
  - [x] **Subtask 1.1: Verify .env File Configuration**
    - [x] Confirm `.env` file exists in project root
    - [x] Verificare `DATABASE_URL` presente (note: file reale non readable, usare indirect validation)
    - [x] Alternative: check container env vars: `docker exec fisio-rag-api printenv | grep DATABASE_URL`
    - [x] Verificare format expected: `postgresql://postgres.<project>:<password>@<host>:<port>/postgres`
  
  - [x] **Subtask 1.2: Create DATABASE_URL Validation Script**
    - [x] Create `scripts/validation/database_connectivity_test.py`:
      ```python
      import os
      import asyncpg
      from urllib.parse import urlparse
      
      async def test_connection():
          db_url = os.getenv("DATABASE_URL")
          if not db_url:
              print("‚ùå DATABASE_URL not set")
              return False
          
          # Parse URL
          parsed = urlparse(db_url)
          print(f"Database host: {parsed.hostname}")
          print(f"Database port: {parsed.port}")
          print(f"Database name: {parsed.path.lstrip('/')}")
          
          # Test connection
          try:
              conn = await asyncpg.connect(db_url)
              result = await conn.fetchval("SELECT 1")
              await conn.close()
              
              if result == 1:
                  print("‚úÖ Database connection: SUCCESS")
                  return True
          except Exception as e:
              print(f"‚ùå Connection failed: {e}")
              return False
      
      if __name__ == "__main__":
          import asyncio
          asyncio.run(test_connection())
      ```
    - [x] Test esecuzione: `cd apps/api && poetry run python ../../scripts/validation/database_connectivity_test.py`
  
  - [x] **Subtask 1.3: Troubleshoot Connection Failure**
    - [x] **Case A: DATABASE_URL non configurato**
      - [x] Reference `ENV_TEMPLATE.txt` per format corretto
      - [x] Verify Supabase project ID e credentials (non mostrare in logs)
      - [x] Document setup: aggiornare `docs/admin-setup-guide.md` con sezione DATABASE_URL troubleshooting
    
    - [x] **Case B: Format invalido**
      - [x] Verify pooler URL vs direct URL (Supabase docs: pooler = port 6543, direct = port 5432)
      - [x] Verify SSL mode: aggiungere `?sslmode=require` se missing
      - [x] Verify timeout params: aggiungere `?connect_timeout=10` se necessario
    
    - [x] **Case C: Network/Firewall block**
      - [x] Test connection from host: `psql $DATABASE_URL` (if psql installed)
      - [x] Test DNS resolution: `nslookup <supabase-host>`
      - [x] Test port connectivity: `Test-NetConnection -ComputerName <host> -Port 6543` (PowerShell)
    
    - [x] **Case D: Credentials invalid**
      - [x] Verify Supabase project active (not paused/suspended)
      - [x] Verify password non expired/changed
      - [x] Regenerate pooler connection string da Supabase Dashboard se necessario
  
  - [x] **Subtask 1.4: Validate Fix**
    - [x] Re-run `database_connectivity_test.py` ‚Üí expect ‚úÖ SUCCESS
    - [x] Re-run `database_integrity_audit.py` ‚Üí expect query results (not connection refused)
    - [x] Document resolution in `docs/troubleshooting/database-connectivity.md`

  - [x] **Output Task 1:** 
    - Script: `scripts/validation/database_connectivity_test.py`
    - Guide: `docs/troubleshooting/database-connectivity.md`
    - Validation: Database integrity audit unblocked

---

### Phase 2: Redis Data Persistence Fix (P1-2)

- [x] **Task 2: Configure Redis Volume & AOF Persistence** (AC: 2)
  - [x] **Subtask 2.1: Add Named Volume to docker-compose.yml**
    - [x] Edit `docker-compose.yml` ‚Üí sezione `volumes` (root level):
      ```yaml
      volumes:
        redis_data:
          driver: local
      ```
    - [x] Edit `redis` service:
      ```yaml
      redis:
        image: redis:alpine
        container_name: fisio-rag-redis
        command: redis-server --appendonly yes  # Enable AOF persistence
        volumes:
          - redis_data:/data  # Mount persistent volume
        networks:
          - fisio-rag-net
      ```
    - [ ] Add comment documenting change:
      ```yaml
      # Story 2.6.1: Redis persistence configured for production
      # - AOF (Append Only File) enabled for data durability
      # - Named volume prevents data loss on container restart
      ```
  
  - [x] **Subtask 2.2: Restart Redis with New Configuration**
    - [x] Stop Redis container: `docker compose stop redis`
    - [x] Remove old container (non-persistent data lost, expected): `docker compose rm redis`
    - [x] Start Redis with new config: `docker compose up -d redis`
    - [x] Verify container running: `docker compose ps redis`
    - [x] Verify volume created: `docker volume ls | Select-String redis_data`
  
  - [x] **Subtask 2.3: Test Data Persistence**
    - [x] Set test key: `docker exec fisio-rag-redis redis-cli SET test_persistence "value_$(Get-Date -Format 'HHmmss')"`
    - [x] Verify key exists: `docker exec fisio-rag-redis redis-cli GET test_persistence`
    - [x] Restart Redis: `docker compose restart redis`
    - [x] Wait container ready (5s)
    - [x] Verify key survived: `docker exec fisio-rag-redis redis-cli GET test_persistence` (expect same value)
    - [x] Verify AOF file: `docker exec fisio-rag-redis ls -lh /data/appendonlydir` (AOF manifest/incremental files present)
  
  - [x] **Subtask 2.4: Document Redis Persistence**
    - [x] Create `docs/troubleshooting/docker-infrastructure.md`:
      - Sezione "Redis Data Persistence"
      - AOF vs RDB comparison
      - Volume backup strategy
      - Recovery procedures
    - [x] Add note in `docker-compose.yml` comments
  
  - [x] **Output Task 2:**
    - File modified: `docker-compose.yml` (redis service + volumes)
    - Guide: `docs/troubleshooting/docker-infrastructure.md`
    - Validation: Data survived restart test

---

### Phase 3: Traefik Health Endpoint Routing Fix (P1-3)

- [x] **Task 3: Fix Traefik Routing Priority for /health** (AC: 3)
  - [x] **Subtask 3.1: Diagnose Current Routing**
    - Test current behavior: `curl http://localhost/health` ‚Üí save response
    - Verify response type: HTML (web) vs JSON (api)
    - Inspect Traefik dashboard: open `http://localhost:18080` (Traefik UI; override via `TRAEFIK_DASHBOARD_PORT`)
    - Check router list: verify `api-router` vs `web-router` priority
    - Check router rules: verify PathPrefix matching
  
  - [x] **Subtask 3.2: Add Dedicated /health Router (Option A - Preferred)**
    - Edit `docker-compose.yml` ‚Üí `api` service labels:
      ```yaml
      api:
        labels:
          # Existing API router (all /api routes)
          - "traefik.http.routers.api-router.rule=Host(`localhost`) && PathPrefix(`/api`)"
          - "traefik.http.routers.api-router.priority=100"
          - "traefik.http.routers.api-router.service=api-service"
          
          # NEW: Dedicated /health router (Story 2.6.1)
          - "traefik.http.routers.api-health-router.rule=Host(`localhost`) && Path(`/health`)"
          - "traefik.http.routers.api-health-router.priority=150"  # Higher than api-router
          - "traefik.http.routers.api-health-router.service=api-service"
          
          # Service definition (shared)
          - "traefik.http.services.api-service.loadbalancer.server.port=8000"
      ```
    - Add comment documenting routing strategy:
      ```yaml
      # Story 2.6.1: Dedicated /health router for monitoring
      # - Priority 150 > api-router (100) > web-router (default ~1)
      # - Exact path match prevents web fallback
      ```
  
  - [ ] **Subtask 3.3: Alternative - Update API Router Rule (Option B)**
    - [ ] Se Option A non funziona, modificare rule api-router:
      ```yaml
      - "traefik.http.routers.api-router.rule=Host(`localhost`) && (PathPrefix(`/api`) || Path(`/health`))"
      ```
    - [ ] Note: Option A preferred per separazione concerns
  
  - [x] **Subtask 3.4: Update Web Router Priority**
    - Edit `web` service labels per clarezza:
      ```yaml
      web:
        labels:
          - "traefik.http.routers.web-router.rule=Host(`localhost`)"
          - "traefik.http.routers.web-router.priority=1"  # Explicit low priority (catch-all)
          - "traefik.http.routers.web-router.service=web-service"
          - "traefik.http.services.web-service.loadbalancer.server.port=80"
      ```
  
  - [x] **Subtask 3.5: Apply Configuration & Test**
    - Restart Traefik per reload config: `docker compose restart proxy`
    - Wait Traefik ready (5s)
    - Test health endpoint: `curl http://localhost/health`
    - Verify response:
      - Content-Type: `application/json`
      - Body: `{"status":"ok"}` (or equivalent)
      - Status: 200 OK
    - Verify Traefik dashboard: check `api-health-router` presente con priority 150
  
  - [x] **Subtask 3.6: Document Traefik Routing**
    - [x] Create `docs/troubleshooting/traefik-routing.md`:
      - Sezione "Router Priority System"
      - PathPrefix vs Path matching
      - Debugging routing conflicts
      - Traefik dashboard usage
    - [x] Update `docker-compose.yml` comments con routing architecture
  
  - [x] **Output Task 3:**
    - File modified: `docker-compose.yml` (api + web labels)
    - Guide: `docs/troubleshooting/traefik-routing.md`
    - Validation: /health returns JSON (API), not HTML (web)

---

### Phase 4: Validation & Documentation

- [x] **Task 4: Execute Full Infrastructure Health Check** (AC: 4)
  - [x] **Subtask 4.1: Re-run Health Check Script**
    - Execute: `python scripts/validation/docker_health_check.py`
    - Expected results:
      - Overall Status: ‚úÖ PASS (not FAIL)
      - API Health Endpoint: ‚úÖ OK (JSON response)
      - Redis Connectivity: ‚úÖ OK (PONG response)
      - Celery Worker: ‚úÖ OK (ready status)
      - Docker Network: ‚úÖ OK (fisio-rag-net inspected)
    - Compare with baseline (Story 2.6): document improvements
  
  - [x] **Subtask 4.2: Re-run Database Integrity Audit**
    - Execute: `python scripts/validation/database_integrity_audit.py`
    - Expected: queries executed successfully (not connection refused)
    - Document findings:
      - Orphan documents count
      - NULL embeddings count (should be 0 post Story 2.5)
      - pgvector indices present
      - Table statistics
    - Save report: `docs/reports/rag-database-integrity-post-fix.md`
  
  - [x] **Subtask 4.3: Test Docker Restart Resilience**
    - [x] Full stack restart: `docker compose down && docker compose up -d`
    - [x] Wait services ready (30s)
    - [x] Verify Redis data persists: `docker exec fisio-rag-redis redis-cli GET test_persistence`
    - [x] Verify API health: `curl http://localhost/health`
    - [x] Verify Celery worker ready: `docker logs fisio-rag-celery-worker | grep "celery@.*ready"`

- [x] **Task 5: Update Production Readiness Summary** (AC: 5)
  - [x] **Subtask 5.1: Update Report Status**
    - [x] Edit `docs/reports/rag-production-readiness-summary.md`:
      - AC2 (Infrastructure Health): ‚ö†Ô∏è CONCERNS ‚Üí ‚úÖ PASS
      - AC3 (Database Integrity): ‚ùå BLOCKED ‚Üí ‚úÖ PASS
      - P1-1 (Database Connectivity): OPEN ‚Üí ‚úÖ RESOLVED
      - P1-2 (Redis Persistence): OPEN ‚Üí ‚úÖ RESOLVED
      - P1-3 (Traefik Routing): OPEN ‚Üí ‚úÖ RESOLVED
    - [x] Update "Overall Assessment": CONCERNS ‚Üí READY (pending P2 fixes)
    - [x] Update "Timeline to Production Ready": 3 hours (P1) ‚Üí 0 ore (P1 complete)
  
  - [x] **Subtask 5.2: Create Troubleshooting Guides**
    - [x] `docs/troubleshooting/database-connectivity.md`:
      - DATABASE_URL format validation
      - Common connection errors (timeouts, refused, SSL)
      - Supabase pooler vs direct connection
      - Firewall/network diagnostics
      - Credentials verification

    - [x] `docs/troubleshooting/docker-infrastructure.md`:
      - Redis persistence (AOF vs RDB)
      - Volume backup/restore procedures
      - Container restart policies best practices
      - Health check configuration patterns
      - Common Docker Compose issues

    - [x] `docs/troubleshooting/traefik-routing.md`:
      - Router priority mechanism
      - PathPrefix vs Path matching
      - Debugging routing conflicts (Traefik UI)
      - Service vs router configuration
      - Common routing mistakes
  
  - [x] **Subtask 5.3: Update Architecture Documentation**
    - [x] Edit `docs/architecture/sezione-9-architettura-di-deployment.md`:
      - Aggiungere sezione "Docker Compose Production Configuration"
      - Documentare Redis persistence strategy
      - Documentare Traefik routing architecture
      - Documentare health check endpoints

    - [x] Annotate `docker-compose.yml` con inline comments:
      - Redis: persistence strategy documented
      - Traefik: routing priority explained
      - Volumes: purpose and backup notes

- [ ] **Task 6: Commit & Tag Release**
  - [ ] Git commit fixes: `git add . && git commit -m "Story 2.6.1: Fix P1 infrastructure issues (DB, Redis, Traefik)"`
  - [ ] Update Story 2.6: marcare checkboxes P1 issues risolti
  - [ ] Update Story 2.6.1: marcare Status ‚Üí Done
  - [ ] Optional: tag release `git tag -a v2.6.1-infra-fixes -m "Production infrastructure P1 fixes"`

---

## Dev Notes

### Architecture Context (Post Story 5.*)

**Current Stack:**
- **Orchestration:** Docker Compose (5 services: proxy, api, celery-worker, redis, web)
- **Proxy:** Traefik v3.1 (HTTP routing, rate limiting middleware)
- **API:** FastAPI (Python 3.11, Uvicorn)
- **Worker:** Celery (async task processing)
- **Broker:** Redis Alpine (message broker, rate limit storage)
- **Database:** Supabase PostgreSQL (pgvector extension)
- **Frontend:** React + Vite + Nginx

**Network:** fisio-rag-net (bridge driver)

### Related Issues Resolved (Story 5.*)

- ‚úÖ Story 5.2: Architettura modulare (main.py refactoring)
- ‚úÖ Story 5.4: Test suite isolation (rate limiting bypass)
- ‚úÖ Story 5.5: Test suite 100% pass rate (179/179 PASSED)
- ‚úÖ Story 2.5: Pipeline RAG tested (embedding retry logic)

### Known Constraints

**Environment:**
- **OS:** Windows 10 (win32 10.0.19045)
- **Shell:** PowerShell (tutti comandi terminal)
- **Workspace:** `C:\Users\user\Desktop\Claude-Code\fisio-rag-master\APPLICAZIONE`
- **Docker:** Docker Desktop with WSL2 backend

**Database:**
- **Provider:** Supabase (cloud hosted)
- **Connection:** Pooler (port 6543) recommended per connection pooling
- **SSL:** Required (sslmode=require)
- **Free Tier Limits:** Database pu√≤ essere paused dopo inattivit√†

**Redis:**
- **Image:** redis:alpine (lightweight)
- **Persistence:** AOF (Append Only File) recommended per durability
- **Volume:** Named volume `redis_data` (driver: local)

**Traefik:**
- **Version:** v3.1
- **Priority System:** Maggiore numero = higher priority
- **Default Priority:** ~1 per router senza priority esplicita
- **Rule Types:** PathPrefix (prefix match), Path (exact match), Host (hostname)

### External Documentation References

**Docker & Docker Compose:**
- Docker Volumes: https://docs.docker.com/storage/volumes/
- Compose File v3: https://docs.docker.com/compose/compose-file/
- Healthcheck Reference: https://docs.docker.com/engine/reference/builder/#healthcheck

**Redis:**
- Persistence (AOF/RDB): https://redis.io/docs/latest/operate/oss_and_stack/management/persistence/
- Docker Redis Best Practices: https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/docker/

**Traefik v3:**
- Routers Documentation: https://doc.traefik.io/traefik/routing/routers/
- Docker Provider: https://doc.traefik.io/traefik/providers/docker/
- Priority Rules: https://doc.traefik.io/traefik-hub/api-gateway/reference/routing/http/routers/ref-rules-prios

**Supabase:**
- Database Connection: https://supabase.com/docs/guides/database/connecting-to-postgres
- Connection Troubleshooting: https://supabase.com/docs/guides/troubleshooting/error-connection-refused-when-trying-to-connect-to-supabase-database-hwG0Dr

### Testing Strategy

**No New Tests Required:**
- Story validates infrastructure configuration, non application logic
- Validation via manual testing + script execution
- Evidence collection: logs, curl outputs, script results

**Validation Scripts (Existing):**
- `scripts/validation/docker_health_check.py` (Story 2.6)
- `scripts/validation/database_integrity_audit.py` (Story 2.6)
- `scripts/validation/database_connectivity_test.py` (NEW - Task 1)

**Manual Tests:**
- Redis data persistence (set key ‚Üí restart ‚Üí get key)
- Health endpoint routing (curl /health ‚Üí expect JSON)
- Database connectivity (psql or script ‚Üí expect success)

### Success Criteria

**Story considerata completata quando:**
1. Database connectivity test: ‚úÖ SUCCESS
2. Redis data survived restart: ‚úÖ VERIFIED
3. /health endpoint returns JSON: ‚úÖ VERIFIED
4. Infrastructure health check: Overall Status ‚úÖ PASS
5. Troubleshooting guides created: 3 docs in `docs/troubleshooting/`
6. Production readiness summary updated: P1 issues ‚Üí RESOLVED

**Rollback Plan:**
- Restore `docker-compose.yml` from backup
- Restore `.env` from backup (se modificato)
- Restart stack: `docker compose down && docker compose up -d`
- Evidence: backup files created in Task 0

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 0.1 | Draft iniziale Story 2.6.1 - Fix 3 P1 Issues identificati in Story 2.6 production readiness validation. Focus: Database connectivity (CONNECTION_REFUSED), Redis data persistence (no volume), Traefik routing (/health endpoint). Effort: 3 ore. Blockers production deployment. | SM |
| 2025-10-10 | 0.2 | Implementate modifiche infrastrutturali (script DATABASE_URL, persistenza Redis, router /health) e documentazione associata; verifiche runtime rimandate per accesso Supabase. | Dev Agent (James) |
| 2025-10-11 | 0.3 | Validazioni runtime completate: health check PASS, audit DB OK, documentazione aggiornata con evidenze P1 risolte. | Dev Agent (James) |

---

## Dev Agent Record

_Questa sezione sar√† popolata dal development agent durante l'implementazione._

### Agent Model Used
GPT-5 (Codex CLI)

### Completion Notes
- `poetry run python ../../scripts/validation/database_connectivity_test.py` ‚Üí SUCCESS (PgBouncer compatibile, host Supabase pooler 6543).
- `python scripts/validation/docker_health_check.py` ‚Üí Overall PASS dopo aggiornamento rete/volume (router `/health`, Redis volume verificato).
- `python scripts/validation/database_integrity_audit.py` ‚Üí Overall OK (0 orphan documents, 0 NULL embeddings, indice HNSW presente).
- Documentazione aggiornata: readiness summary ora READY, post-fix DB report con metriche, guide troubleshooting arricchite (statement cache, appendonlydir, Traefik priority).
- Full stack restart eseguito (`docker compose down && up -d`) con verifica Redis persistence, API health e Celery ready.

### File List
- docker-compose.yml
- scripts/validation/database_connectivity_test.py
- scripts/validation/docker_health_check.py
- scripts/validation/database_integrity_audit.py
- docs/troubleshooting/database-connectivity.md
- docs/troubleshooting/docker-infrastructure.md
- docs/troubleshooting/traefik-routing.md
- docs/reports/rag-production-readiness-summary.md
- docs/reports/rag-database-integrity.md
- docs/reports/rag-database-integrity-post-fix.md
- docs/reports/rag-infrastructure-health.md
- docs/reports/rag-config-gap-analysis.md
- docs/architecture/sezione-9-architettura-di-deployment.md

---

## QA Results

NFR Assessment (2025-10-11)

- Decisione: PASS (con follow-up P2)
- Evidenze:
  - `docs/reports/rag-infrastructure-health.md` ‚Üí Overall PASS
  - `docs/reports/rag-database-integrity.md` ‚Üí Overall OK (0 orphan, 0 NULL, idx pgvector presente)
  - `docs/reports/rag-production-readiness-summary.md` ‚Üí READY (P1 risolti)
- Rischi Residui (P2):
  - Aggiungere restart policies (`api`, `celery-worker`, `redis`) e healthcheck formali
  - Restringere CORS in produzione
  - Valutare utente non-root per Celery in produzione
- Azioni Successive:
  - Pianificare AC4 performance benchmarks con dataset rappresentativo
  - Integrare gli script di validazione in pipeline di release

Documento completo: `docs/qa/assessments/2.6.1-nfr-assessment-20251011.md`

Traceability: `docs/qa/assessments/2.6.1-trace-20251011.md`

---

