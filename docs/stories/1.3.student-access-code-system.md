# Story 1.3: Student Access Code System

**Status:** Done

## Story

**As a** Studente,
**I want** accedere con un semplice codice,
**so that** posso usare lo strumento rapidamente senza creare un account.

## Acceptance Criteria

1. Endpoint admin per generare codici.
2. Endpoint pubblico per validare un codice.
3. Un codice valido restituisce un token temporaneo.
4. La pagina principale ha un campo per il codice.
5. Inserendo un codice valido, si viene reindirizzati alla chat.
6. Il campo del codice di accesso non può essere inviato se vuoto.
7. Un messaggio di errore specifico viene mostrato sotto il campo se la validazione client-side fallisce.

## Dipendenze

- Non esplicitate nel PRD per questa story. [Fonte: `docs/prd/sezione-7-epic-1-dettagli-foundation-user-access.md#story-13-student-access-code-system`]

## Dev Notes

### Previous Story Insights
- Autenticazione delegata a Supabase Auth; il backend valida i JWT su endpoint protetti. Rilevanza: gli endpoint di questa story devono rispettare lo stesso modello di sicurezza dove applicabile (admin). [Fonte: `docs/stories/1.2.admin-login-system.md`]

### Data Models
- Modello `AccessCode`: `id` (UUID), `code` (string), `is_active` (boolean), `expires_at` (timestamp, nullable), `usage_count` (integer), `last_used_at` (timestamp, nullable), `created_by_id` (UUID, FK to Admin), `created_at`, `updated_at`. [Fonte: `architecture/sezione-4-modelli-di-dati.md#42-modello-accesscode`]

### API Specifications
- Stile API ibrido: Supabase PostgREST per CRUD su `AccessCode`; API custom FastAPI per logica non auto-generata. [Fonte: `architecture/sezione-5-specifica-api-sintesi.md`]
- Requisiti specifici della story (admin endpoint generazione codici; endpoint pubblico validazione; token temporaneo su codice valido). [Fonte: `prd.md#Sezione 7: Epic 1 Dettagli - Story 1.3`]
- Sicurezza: JWT Bearer Token forniti da Supabase Auth; RLS a livello DB. [Fonte: `architecture/sezione-5-specifica-api-sintesi.md`, `architecture/sezione-10-sicurezza-e-performance.md`]

### Component Specifications
- Frontend: campo codice nella pagina principale; redirect alla chat su validazione positiva; messaggistica di errore specifica. [Fonte: `prd.md#Sezione 7: Epic 1 Dettagli - Story 1.3`]
- Componenti di riferimento: Authentication Component; Admin Panel; Multi-API Service. [Fonte: `architecture/sezione-6-componenti.md`]

### File Locations
- Monorepo root: `/`
- Frontend App: `/apps/web/`
- Backend App: `/apps/api/`
- Docs: `/docs/`
- Percorsi secondo Struttura Unificata. [Fonte: `architecture/sezione-7-struttura-unificata-del-progetto.md`]

### Token temporaneo (JWT)
- Issuer (`iss`): `https://<project-ref>.supabase.co/auth/v1` (pattern Supabase)
- Audience (`aud`): "authenticated" (o "anon" se applicabile)
- Claims minimi: `iss`, `aud`, `sub`, `role` (es. `authenticated`), `session_id`, `iat`, `exp`
- Algoritmo esempio: `HS256` (tutorial FastAPI)
- Durata esempio: 15 minuti

### Flusso validazione/scambio token (overview)
1. Admin genera `AccessCode` (PostgREST, soggetto a RLS). [Fonte: `architecture/sezione-5-specifica-api-sintesi.md`, `architecture/sezione-10-sicurezza-e-performance.md`]
2. Endpoint pubblico `POST /api/v1/auth/exchange-code` valida `access_code` (attivo/non scaduto) e rilascia JWT temporaneo.

### Testing Requirements
- Piramide dei test: Unit (FE: Vitest, BE: Pytest), Integration (FE: React Testing Library, BE: Pytest+HTTPX), E2E (Playwright). [Fonte: `architecture/sezione-11-strategia-di-testing.md`]
- Scenari chiave (mappati agli AC):
  1. (AC1) Invocazione endpoint admin genera codice e persiste record `AccessCode` con attributi attesi. [Fonti: `prd.md#Story 1.3`, `architecture/sezione-4-modelli-di-dati.md`]
  2. (AC2, AC3) Endpoint pubblico valida codice attivo/non scaduto → restituisce token temporaneo; codici invalidi/inattivi/scaduti → errore. [Fonte: `prd.md#Story 1.3`]
  3. (AC4, AC5) UI: inserimento codice valido → redirect a `/chat`; invalidi → messaggio errore. [Fonte: `prd.md#Story 1.3`]
  4. (AC6, AC7) Validazione client-side: blocco submit su campo vuoto e messaggio specifico sotto il campo. [Fonte: `prd.md#Story 1.3`]
  5. Casi negativi addizionali: codice riutilizzato oltre policy (`usage_count`), codice scaduto, codice disattivato. [Fonte: `architecture/sezione-4-modelli-di-dati.md`]
- Livelli test per AC:
  - AC1: BE integration (HTTPX) + unit DAL; opzionale E2E admin flow.
  - AC2-AC3: BE integration (HTTPX) + unit validator; E2E happy/negative.
  - AC4-AC5-AC6-AC7: FE unit/integration (RTL) + E2E.

### Technical Constraints
- Stack e strumenti come da Tech Stack: React+TS+Vite (FE), FastAPI (BE), Supabase (Auth/DB/Storage), Docker Compose, pnpm/Poetry, ecc. [Fonte: `architecture/sezione-3-tech-stack.md`]
- Sicurezza: RLS; JWT da Supabase; hardening infrastrutturale VPS. [Fonte: `architecture/sezione-10-sicurezza-e-performance.md`]

## Tasks / Subtasks

- [x] Backend: Endpoint admin per generare codici (AC: 1)
  - [x] Persistenza record `AccessCode` con campi previsti. [Fonti: `prd.md#Story 1.3`, `architecture/sezione-4-modelli-di-dati.md`]
  - [x] Protezione endpoint (admin). [Fonti: `docs/stories/1.2.admin-login-system.md`, `architecture/sezione-10-sicurezza-e-performance.md`]
- [x] Backend: Endpoint pubblico per validare codice e rilasciare token temporaneo (AC: 2, 3)
  - [x] Ritorno errore per codice inesistente/inattivo/scaduto. [Fonte: `prd.md#Story 1.3`]
- [x] Frontend: Campo codice nella pagina principale con validazione client-side (AC: 4, 6, 7)
  - [x] Messaggi di errore specifici sotto il campo. [Fonte: `prd.md#Story 1.3`]
- [x] Frontend: Flusso redirect su codice valido verso `/chat` (AC: 5) [Fonte: `prd.md#Story 1.3`]
- [x] Test: unit/integration/e2e per gli scenari chiave (mappare agli AC). [Fonte: `architecture/sezione-11-strategia-di-testing.md`]

## Dev Agent Record

### Agent Model Used
- dev

### Debug Log References

```bash
pnpm -C apps\web lint
```

```powershell
cd 'apps/api'; poetry install --no-root --sync --quiet; $env:SUPABASE_JWT_SECRET='devsecret'; poetry run pytest -q
```

```bash
pnpm -C apps\web test
```

```bash
pnpm -C apps\web test:e2e
```

```bash
pnpm -C apps\web build
```

### Completion Notes List
- Implementati endpoint BE: generazione codici admin e `POST /api/v1/auth/exchange-code`.
- Aggiunta pagina FE `AccessCodePage` con validazione e redirect a `/chat`.
- Aggiornato routing in `App.tsx`.
- Aggiunti test BE minimi su health, errori e happy-path mono-uso.
 - QA fixes: aggiunti test BE per endpoint admin (auth required/forbidden/success con persistenza) e test FE (RTL+Vitest) per AC4–AC7: campo presente, errore su submit vuoto, redirect `/chat` su successo, errore API mostrato.
 - Implementato rate limiting per `/api/v1/auth/exchange-code` (per-IP, finestra e soglia configurabili via env) e log strutturati JSON per tentativi/esiti e richieste HTTP.
 - Sistemata build FE allineando Vite 5 e `@vitejs/plugin-react` 4; isolati test Vitest da cartella Playwright in `vite.config.ts`.
 - 2025-09-24: FE lint OK; FE test Vitest: 3 file, 6 test passati; FE E2E Playwright: 4 test passati; FE build completata; BE Pytest: 27 test passati, coverage 91.90% (>=85% richiesto).

### Environment Variables
- `SUPABASE_URL` (richiesta per test/PostgREST): base URL progetto Supabase (es. `https://<ref>.supabase.co`).
- `SUPABASE_ANON_KEY` (richiesta per test/PostgREST): chiave anon per chiamate REST nei test/cURL.
- `SUPABASE_JWT_SECRET` (richiesta): chiave di firma/validazione JWT (server-side) per token temporanei.
- `SUPABASE_JWT_ISSUER` (opzionale): default `https://example.supabase.co/auth/v1`.
- `TEMP_JWT_EXPIRES_MINUTES` (opzionale): default `15`.
- `USER_ACCESS_TOKEN` (solo test RLS): access token utente per verifiche PostgREST autenticate.

### Testing Notes
- Backend (Pytest):
  - Preferire integration test con `httpx.AsyncClient` + `@pytest.mark.anyio` e `LifespanManager(app)` per gestire startup/shutdown.
  - Validare contratto `POST /api/v1/auth/exchange-code` (happy/negative) e claims JWT minimi (`iss`, `aud`, `exp`).
  - Usare fixture client riutilizzabile (scope `module`).
  - Mock dipendenze esterne con `monkeypatch` (es. wrapper Supabase/JWT) per test deterministici.
  - Per test RLS via PostgREST, usare header `Authorization: Bearer ${USER_ACCESS_TOKEN}`.

- Frontend (Vitest/RTL):
  - Validazione client-side: blocco submit su campo vuoto e messaggio specifico sotto il campo.
  - Redirect a `/chat` su codice valido (mock risposta API).

- E2E (Playwright):
  - Scenario felice: inserimento codice valido → redirect `/chat`.
  - Scenari negativi: codice invalido/scaduto/disattivato → messaggio errore specifico.

### File List
- apps/api/api/main.py
- apps/api/api/__init__.py
- apps/api/api/test_main.py
- apps/api/pyproject.toml
- apps/web/src/pages/AccessCodePage.tsx
- apps/web/src/App.tsx
 - apps/web/src/pages/AccessCodePage.test.tsx
 - apps/web/vitest.setup.ts
 - apps/web/vite.config.ts
 - apps/web/package.json

### API Specification (Exchange Code)
- Metodo/Path: `POST /api/v1/auth/exchange-code`
- Request (JSON): `{ "access_code": "string" }`
- Response 200 (JSON): `{ "token": "jwt-string", "token_type": "bearer", "expires_in": 900 }`
- Errori (etichette esemplificative, messaggi non presenti nella fonte): 400 `invalid_request`, 401 `invalid_code`, 410 `expired_code`, 409 `code_already_used`, 429 `rate_limited`

## Project Structure Notes
- Allineare nuove directory/file a `sezione-7-struttura-unificata-del-progetto`. [Fonte: `architecture/sezione-7-struttura-unificata-del-progetto.md`]

## QA Results

### Review Date: 2025-09-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
La bozza di story è adeguata nel perimetro PRD/architettura. Mancano dettagli operativi sul token temporaneo e il flusso completo di validazione/scambio. Testing: scenari negativi parziali e livelli test ora mappati ma da rendere prescrittivi.

### Refactoring Performed
Nessun refactoring di codice applicabile (documento). Aggiornamenti raccomandati in story (sezioni aggiunte) già redatti in 1.1.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: CONCERNS (integrare negativi e fixture Supabase)
- All ACs Met: CONCERNS (specifica token non definita)

### Improvements Checklist
- [ ] Definire specifica completa token temporaneo (issuer/formato/claims/audience/durata)
- [ ] Documentare flusso PostgREST↔FastAPI con endpoint/route
- [ ] Aggiungere casi negativi dettagliati e note di mocking Supabase
- [ ] Esplicitare policy RLS coinvolte e mappatura file/route

### Gate Status
Gate: CONCERNS → docs/qa/gates/1.3-student-access-code-system.yml
Risk profile: docs/qa/assessments/1.3-risk-20250912.md
NFR assessment: docs/qa/assessments/1.3-nfr-20250912.md

### Recommended Status
[✗ Changes Required - See unchecked items above]

## QA Results

### Review Date: 2025-09-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Documentazione allineata post-aggiornamenti: sezione API (Sezione 5) ora include `POST /auth/exchange-code`; story aggiornata con Dev Agent Record e task BE/FE marcati; NFR assessment PASS; test-design v2 senza coverage gaps.

### Refactoring Performed
Nessun refactoring applicabile (documento).

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist
- [ ] Aggiungere rate limiting su endpoint pubblico (difesa in profondità)
- [ ] Log strutturati esiti exchange-code

### Gate Status
Gate: PASS → docs/qa/gates/1.3-student-access-code-system.yml
Risk profile: docs/qa/assessments/1.3-risk-20250912.md
NFR assessment: docs/qa/assessments/1.3-nfr-20250913.md

### Recommended Status
[✓ Ready for Approved]

### QA Review Addendum (2025-09-13 Post-Update)
- Gate: PASS (immutato)
- Status reason: Specifiche JWT e API exchange-code documentate; Sezione 5 aggiornata; story con task marcati e Dev Agent Record.
- Ulteriori note: considerare rate limiting; aggiungere coverage integration/E2E come da strategia.

### QA Review Update (2025-09-13)
- Verifica post-aggiornamenti: presente sezione "Environment Variables" (story) e note di testing (integration/E2E).
- Sezione 5 aggiornata con `POST /auth/exchange-code` (architettura).
- Gate: PASS (invariato). Stato motivato da: specifiche JWT+endpoint documentati; Sezione 5 aggiornata; env vars e testing notes presenti.

### QA Review Update (2025-09-14)
- Story-checklist outcome: READY (Chiarezza 9/10). Nessun gap bloccante.
- Traceability: creato report `docs/qa/assessments/1.3-trace-20250914.md`.
  - Totali: requirements=7, full=3, partial=0, none=4.
  - Scoperti: AC1 (test endpoint admin mancante), AC4–AC7 (test FE/UX mancanti: campo, redirect, validazione, messaggi).
- Raccomandazioni: mantenere Gate PASS con monitor su coverage FE e test endpoint admin; finalizzare tassonomia errori per coerenza FE/BE.
- Gate aggiornato con sezione `trace` e timestamp.

### QA Review Update (2025-09-14 Final)
- Gate: PASS (immutato).
- All AC covered: test BE per endpoint admin (AC1) presenti; test FE AC4–AC7 presenti (campo, blocco submit vuoto, redirect `/chat` su successo, messaggio errore su API failure).
- Traceability: requirements=7, full=7, partial=0, none=0.
- Raccomandazioni: monitorare rate limiting e log strutturati per `exchange-code`.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
|      | 1.1     | Added token + flow details and testing matrix | Scrum Master |
| 2025-09-13 |  | Status set to Ready for Done per QA PASS gate | Dev Agent |
| 2025-09-13 |  | Added Environment Variables and Testing Notes in Dev Agent Record | Dev Agent |
| 2025-09-14 |  | Enriched env vars and testing notes from Supabase/Pytest KB | Dev Agent |
| 2025-09-14 |  | QA fixes: aggiunti test BE admin generate e test FE AC4–AC7 | Dev Agent |
| 2025-09-15 |  | Rate limiting + log JSON su exchange-code; fix build Vite 5; isolamento test Vitest | Dev Agent |
| 2025-09-24 |  | FE lint/test/e2e/build e BE pytest passati; coverage 91.90%; stato impostato "Ready for Review" | Dev Agent |

### Environment Variables

- SUPABASE_URL: base URL del progetto Supabase (es. `https://<ref>.supabase.co`).
- SUPABASE_ANON_KEY: chiave anon per chiamate REST nei test/cURL.
- SUPABASE_JWT_SECRET: chiave di firma/validazione JWT (server-side) per token temporanei.
- SUPABASE_JWT_ISSUER (opzionale): default `https://example.supabase.co/auth/v1`.
- TEMP_JWT_EXPIRES_MINUTES (opzionale): default `15`.
- USER_ACCESS_TOKEN (solo test RLS): token utente per verifiche PostgREST autenticate.
[Fonti: `docs/qa/assessments/po-master-check-20250913.md` L113–L120; `docs/architecture/sezione-3-tech-stack.md` L35–L41]

### Sicurezza: Rate Limiting e Logging su `POST /api/v1/auth/exchange-code`

- Rate limiting applicativo per-IP con finestra e soglia configurabili via variabili d'ambiente.
- Log strutturati JSON per tentativi/esiti di scambio codice e richieste HTTP.
[Fonti: `docs/qa/assessments/po-master-check-20250913.md` L110–L112; `docs/qa/assessments/po-master-check-20250913-v2.md` L209–L211]
