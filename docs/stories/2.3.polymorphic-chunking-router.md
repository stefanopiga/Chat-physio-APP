# Story 2.3: Polymorphic Chunking Router

**Status:** Done

## Story

**As a** Sviluppatore Backend,
**I want** implementare diverse strategie di chunking e un router,
**so that** il testo venga suddiviso in blocchi ottimizzati.

## Acceptance Criteria

1. Almeno due strategie di chunking implementate. [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]
2. Definita una strategia di fallback. [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]
3. Il sistema applica la strategia corretta o il fallback. [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]
4. Il testo viene suddiviso in chunk con riferimento alla sorgente. [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]
5. Design modulare. [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]

## Dev Notes

### Previous Story Insights
- La classificazione (Story 2.2) guida la scelta dello splitter. [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]

### Data Models
- `Document`: utilizzo di `chunking_strategy` e `metadata` per audit. [Fonte: `docs/architecture/sezione-4-modelli-di-dati.md#4.3-modello-document`]
- `DocumentChunk`: blocchi con `content`, `embedding`, `metadata`. [Fonte: `docs/architecture/sezione-4-modelli-di-dati.md#4.4-modello-documentchunk`]

### API Specifications
- Orchestrazione pipeline ingestion lato backend. [Fonte: `docs/architecture/sezione-6-componenti.md#6.2-componenti-backend-fastapi`]

### File Locations
- Monorepo: `/`
- Backend: `/apps/api/`
- Docs: `/docs/`
- Struttura: vedi guida. [Fonte: `docs/architecture/sezione-7-struttura-unificata-del-progetto.md`]

### Testing Requirements
- Pytest unit/integration; mock servizi esterni. [Fonte: `docs/architecture/sezione-11-strategia-di-testing.md`]

### Technical Constraints
- Python 3.11, FastAPI, LangChain per splitter. [Fonte: `docs/architecture/sezione-3-tech-stack.md`]

### Strategie di Chunking (minime)
- `RecursiveCharacterTextSplitter` per `TESTO_ACCADEMICO_DENSO`. [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]
- Splitter tabellare/strutturale per `DOCUMENTO_TABELLARE` o `PAPER_SCIENTIFICO_MISTO` (placeholder architetturale, attuare design modulare). [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]
- Fallback: strategia generica quando `confidenza < 0.85` o classificazione non supportata. [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]

### Logging e Audit
- Registrare motivazione e confidenza in `Document.metadata`; tracciare strategia scelta in `chunking_strategy`. [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]

### Pattern e Eccezioni
- Nessuna eccezione ai pattern standard rilevata. [Fonte: `docs/architecture/sezione-12-standard-di-codifica.md`]

## Tasks / Subtasks
- [x] Backend: Implementare interfaccia `ChunkingStrategy` e router (AC: 1,3,5). [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]
  - [x] Strategia A: `RecursiveCharacterTextSplitter` (AC: 1). [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]
  - [x] Strategia B: splitter tabellare/strutturale (AC: 1). [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]
  - [x] Fallback: strategia generica su `confidenza < 0.85` o classificazione non mappata (AC: 2–3). [Fonte: `docs/architecture/sezione-6-componenti.md#6.3.5-Uso-nel-Processo-di-Ingestion`]
- [x] Persistence: Salvare `chunking_strategy` e aggiornare `metadata` (AC: 4). [Fonte: `docs/architecture/sezione-4-modelli-di-dati.md#4.3-modello-document`]
- [x] Testing: unit e integrazione per selezione strategia e output chunk (AC: 3–4). [Fonte: `docs/architecture/sezione-11-strategia-di-testing.md`]

## Testing
- Livelli: unit (strategies), integration (router + persistence). [Fonte: `docs/architecture/sezione-11-strategia-di-testing.md`]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-19 | 0.1 | Bozza iniziale Story 2.3 | SM |
| 2025-09-21 | 1.0 | Implementazione router e strategie + test | dev |

## Dev Agent Record

### Agent Model Used
GPT-5

### Debug Log References
- Pytest: 23 passed in 4.74s; Total coverage: 91.90%

### Completion Notes List
- Router con fallback su `confidenza < 0.85` operativo; selezione per categoria corretta.
- Persistenza aggiornata: `chunking_strategy` e `metadata["chunks_count"]` impostati in `watcher.py`.

### File List
- `apps/api/api/ingestion/chunking/strategy.py`
- `apps/api/api/ingestion/chunking/recursive.py`
- `apps/api/api/ingestion/chunking/tabular.py`
- `apps/api/api/ingestion/chunk_router.py`
- `apps/api/api/ingestion/watcher.py` (aggiornato per usare il router)
- `apps/api/tests/test_chunk_strategies.py`
- `apps/api/tests/test_chunking_router.py`
- `apps/api/tests/test_ingestion.py` (aggiunto test metadati chunking)

## QA Results

### Review Date: 2025-09-21

### Reviewed By: Quinn (Test Architect)

### Gate Status

Gate: PASS → docs/qa/gates/2.3-polymorphic-chunking-router.yml

### Trace & NFR References

- Trace: docs/qa/assessments/2.3-trace-20250921.md
- NFR assessment: docs/qa/assessments/2.3-nfr-20250921.md
