# Story 3.4: Source Visualization & Feedback

**Status:** Done

## Story

**As a** Sviluppatore Frontend,
**I want** implementare la visualizzazione delle fonti e il feedback,
**so that** gli studenti possano verificare le info e noi possiamo misurare la qualit√†.

[Fonte: `docs/prd/sezione-9-epic-3-dettagli-interactive-rag-experience.md`]

## Acceptance Criteria

1. Le citazioni sono interattive (click/hover).
2. Al click/hover si apre un popover con estratto della fonte e metadati minimi (document_id, posizione).
3. Pulsanti di feedback üëç/üëé sono visibili vicino ad ogni risposta.
4. Il feedback viene inviato al backend con `sessionId`, `message_id`, `vote` (up|down).
5. Accessibilit√†: controlli per citazioni e feedback sono `<button>` con ruoli e `aria-*` corretti; focus management e tastiera funzionanti.
6. Persistenza lato client: l‚Äôultimo voto dell‚Äôutente √® riflesso nello stato UI per il messaggio corrente.

[Fonte: `docs/prd/sezione-9-epic-3-dettagli-interactive-rag-experience.md` L40‚ÄìL46; `docs/front-end-spec.md` Sez. 7]

## Decisione Operativa

- Stato: GO ‚Äî prerequisiti backend completati.
- Completati:
  1. Endpoint `POST /api/v1/chat/messages/{messageId}/feedback` (body `{ sessionId, vote }`, risposta `{ ok }`).
  2. Risposta AG arricchita con citazioni per popover (`chunk_id`, `document_id`, `excerpt`, `position`).

## Piano Passo‚ÄëPasso

1. Backend ‚Äî Feedback API
   - Definire contratto `POST /api/v1/chat/messages/{messageId}/feedback` (body: `{ sessionId, vote: 'up'|'down' }`, response `{ ok: boolean }`). [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md` L32‚ÄìL35]
   - Implementare endpoint e test (401/429/500).
2. Backend ‚Äî Citazioni arricchite
   - Estendere output AG per includere per ogni citazione: `document_id`, `position` (o offset), `excerpt` (estratto breve). [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md` L15‚ÄìL21]
   - Adeguare modelli e test.
3. Frontend ‚Äî Integrazione UI (dopo prerequisiti)
   - `CitationBadge`/`CitationPopover` con ruoli `aria-*` corretti e chiusura `Esc`/click outside. [Fonte: `docs/front-end-spec.md` Sez. 7]
   - `FeedbackControls` con stato pending/selected e invio al nuovo endpoint.
   - Aggiornare `apiClient` con `sendFeedback(messageId, vote)`.
4. QA ‚Äî Test
   - Aggiornare E2E per verificare popover con estratto/metadati e invio feedback.

## Dev Notes

### UI/Componenti
- `CitationBadge`: bottone che mostra un ID citazione; al click apre `CitationPopover`.
- `CitationPopover`: mostra estratto testo e metadati minimi; chiusura con Esc/click outside; gestisce focus.
- `FeedbackControls`: due bottoni (üëç/üëé) con stato selezionato; invoca API.
- `ChatMessageItem`: integra citazioni e feedback in coda al messaggio del bot.

### Accessibilit√†
- Usare `<button>` per trigger citazioni; `aria-expanded`, `aria-controls`.
- `role="dialog"` o `aria-live` non necessario per popover informativo; usare `role="tooltip"`.
- Tasti: `Enter`/`Space` per aprire; `Esc` per chiudere; focus trapping non richiesto per tooltip.

[Fonte: `docs/front-end-spec.md` Sez. 7]

### Test E2E (linee guida)
- Verificare presenza citazioni come bottoni cliccabili.
- Al click, appare popover con testo atteso.
- Click su üëç invia richiesta; UI mostra stato selezionato; retry disabilitato finch√© pending.

[not available in source]

## Tracciabilit√† API
- Feedback endpoint: definito in `docs/qa/assessments/3.4-po-validate-20250929.md` (Must Fix) e casi in `docs/qa/assessments/3.4-test-design-20250929.md`.
- Citazioni arricchite AG: requisito e casi definiti in `docs/qa/assessments/3.4-po-validate-20250929.md` e `docs/qa/assessments/3.4-test-design-20250929.md`.

## File Locations
- Frontend: `/apps/web/`
- API: `/apps/api/`
- Docs: `/docs/`

## Tasks / Subtasks
- [x] Backend: implementare `POST /api/v1/chat/messages/{messageId}/feedback` + test.
- [x] Backend: arricchire output citazioni (excerpt, metadati minimi) + test.
- [x] Frontend: rendering citazioni in `ChatMessagesList` con `CitationBadge`/`CitationPopover`.
- [x] Frontend: integrare `FeedbackControls` e stato.
- [x] Frontend: aggiornare `apiClient` con `sendFeedback(messageId, vote)`.
- [x] QA: scrivere/aggiornare test E2E per citazioni/feedback.
