# Story 5.4.3: API Logic Bugs Resolution

**Status:** Done

## Metadata
- **ID**: 5.4.3
- **Type**: Technical Debt / Bugfix / Testing
- **Epic**: Epic 5 — DevOps & Maintainability
- **Priority**: P1 - High
- **Complexity**: Medium
- **Effort Estimate**: 6-8 ore
- **Dependencies**: Story 5.4.2 (FK Constraint Resolution) — ✅ Completata
- **Blocks**: Pass rate target >90%, CI/CD green build

---

## Story

**As a** Backend Developer,  
**I want** risolvere 12 test failures causati da API logic bugs,  
**so that** suite test raggiunga pass rate >90% e CI/CD sia affidabile.

**Business Value**: Completamento target pass rate >90%; error handling robusto; comportamento API conforme a specifiche HTTP.

---

## Context & Background

### Current State (Post Story 5.4.2)

**Test Suite Metrics:**
```
Total: 204 tests
PASSED: 168 (82.4%)
FAILED: 12 (5.9%)
ERRORS: 0 (0%) ← FK VIOLATIONS ELIMINATED
SKIPPED: 24 (11.8%)
Pass Rate: 82.4%
Target: >90%
Gap: -7.6pp
```

**Failure Distribution:**
```
Category                          Count   Files
Refresh Token Error Handling      6       test_auth.py, test_student_tokens.py
Admin Token Creation              2       test_auth.py, test_student_tokens.py
Feedback Endpoint                 1       test_feedback.py
Document Chunks Query             1       test_documents.py
Semantic Search Performance       1       test_search.py
Semantic Search Endpoint          1       test_search.py
Total                            12
```

### Problem Statement

Story 5.4.2 ha eliminato 15 FK constraint errors, portando pass rate da 85.1% a 82.4%. I 12 test failures residui sono causati da API logic bugs non correlati a FK constraints.

---

## Problem Categories

### 1. API Logic Bugs (8 test) — IN SCOPE Story 5.4.3

#### 1.1 Refresh Token Error Handling (6 test)

**Affected Tests:**
- `test_refresh_token_invalid` (x2): API e root level
- `test_refresh_token_revoked` (x2): API e root level
- `test_refresh_token_after_student_token_revoked` (x2): API e root level

**Behavior Atteso:**
```http
POST /auth/refresh-token
Content-Type: application/json
{"refresh_token": "invalid-or-revoked-token"}

Expected Response:
HTTP 401 Unauthorized
{
  "detail": "Invalid refresh token"
}
```

**Behavior Effettivo:**
```http
HTTP 500 Internal Server Error
{
  "detail": "Internal server error"
}
```

**Root Cause:**
```python
# File: api/routers/auth.py (presunto)
async def refresh_token(refresh_token: str):
    # Query Supabase per refresh token
    result = supabase.table("refresh_tokens").select("*").eq(
        "token", refresh_token
    ).execute()
    
    # PROBLEMA: Non gestisce caso "0 rows returned"
    if not result.data:
        # Solleva eccezione generica invece di HTTPException(401)
        raise Exception("Token not found")  # → 500 invece di 401
    
    token_data = result.data[0]  # ← Crash se result.data vuoto
```

**Fix Required:**
```python
async def refresh_token(refresh_token: str):
    result = supabase.table("refresh_tokens").select("*").eq(
        "token", refresh_token
    ).execute()
    
    # FIX: Gestione esplicita caso "token non trovato"
    if not result.data or len(result.data) == 0:
        raise HTTPException(
            status_code=401,
            detail="Invalid refresh token"
        )
    
    token_data = result.data[0]
    
    # Verifica token revocato
    if token_data.get("is_revoked", False):
        raise HTTPException(
            status_code=401,
            detail="Refresh token has been revoked"
        )
    
    # Verifica student token parent revocato
    student_token = supabase.table("student_tokens").select("*").eq(
        "id", token_data["student_token_id"]
    ).execute()
    
    if not student_token.data or student_token.data[0].get("is_active") is False:
        raise HTTPException(
            status_code=401,
            detail="Student token has been revoked"
        )
    
    # ... rest of logic
```

#### 1.2 Admin Token Creation (2 test)

**Affected Tests:**
- `test_create_student_token_success` (x2): API e root level

**Behavior Atteso:**
```python
# Test crea student token con admin auth
response = client.post(
    "/admin/student-tokens",
    headers={"Authorization": f"Bearer {admin_token}"},
    json={"first_name": "Test", "last_name": "Student"}
)

assert response.status_code == 201
```

**Behavior Effettivo:**
```
HTTP 422 Unprocessable Entity
{
  "detail": [
    {
      "loc": ["body", "created_by_id"],
      "msg": "value is not a valid uuid",
      "type": "type_error.uuid"
    }
  ]
}
```

**Root Cause:**
```python
# File: tests/conftest.py (presunto)
@pytest.fixture
def admin_token(supabase_test_client):
    # PROBLEMA: Mock admin usa string invece UUID
    mock_user_id = "test-admin-user-id"  # ← Non è UUID valido
    
    token = create_jwt_token({
        "sub": mock_user_id,  # ← Validazione UUID fallisce
        "role": "admin"
    })
    
    return token
```

**Fix Required:**
```python
@pytest.fixture
def admin_token(supabase_test_client):
    import uuid
    
    # FIX: Genera UUID valido per admin user
    admin_user_id = str(uuid.uuid4())
    
    # Crea admin user in DB (per FK consistency)
    supabase_test_client.table("users").insert({
        "id": admin_user_id,
        "email": f"admin-{admin_user_id}@fisiorag.test",
        "role": "admin"
    }).execute()
    
    token = create_jwt_token({
        "sub": admin_user_id,  # UUID valido
        "role": "admin"
    })
    
    yield token
    
    # Cleanup
    try:
        supabase_test_client.table("users").delete().eq(
            "id", admin_user_id
        ).execute()
    except Exception as e:
        logger.error(f"Admin user cleanup failed: {e}")
```

---

### 2. Altri Failure (4 test) — OUT OF SCOPE Story 5.4.3

#### 2.1 Feedback Endpoint (1 test)

**Test:** `test_feedback_endpoint_creates_feedback`

**Error:**
```
HTTP 422 Unprocessable Entity
Schema validation error
```

**Root Cause:** Request payload non conforme a schema Pydantic.

**Recommendation:** Creare Story 5.5.1 per feedback endpoint validation.

#### 2.2 Document Chunks Query (1 test)

**Test:** `test_get_document_chunks_sort_by_size`

**Error:**
```
Query SQL mismatch
Expected ORDER BY size ASC, got ORDER BY created_at DESC
```

**Root Cause:** Endpoint non implementa parametro `sort_by=size`.

**Recommendation:** Creare Story 5.5.2 per document query enhancement.

#### 2.3 Semantic Search Performance (1 test)

**Test:** `test_semantic_search_p95_under_500ms`

**Error:**
```
AssertionError: p95 latency 587ms > 500ms threshold
```

**Root Cause:** Performance test threshold non raggiunto.

**Recommendation:** Creare Story 5.6 per performance optimization.

#### 2.4 Semantic Search Endpoint (1 test)

**Test:** `test_semantic_search_after_indexing`

**Error:**
```
HTTP 404 Not Found
Endpoint /search/semantic not found
```

**Root Cause:** Endpoint non implementato o route non registrata.

**Recommendation:** Verificare implementazione endpoint in Story 2.x completion.

---

## Desired State

**Test Suite Production-Ready:**
```
Pass Rate: >90% (184+/204 test)
Failed: <6 test (out of scope issues)
Errors: 0
API Logic Bugs: 0 (8 test fixed)
Coverage: ≥93% maintained
Duration: <500s
CI/CD: Green build
```

**API Error Handling:**
- HTTP status codes conformi a REST best practices
- 401 per auth failures (no 500 leak)
- 422 per validation errors con dettagli actionable
- Exception handling esplicito per query "0 rows"

---

## Acceptance Criteria

### Funzionali

**AC1: Refresh Token Error Handling (6 test)**
```gherkin
GIVEN refresh token invalid, revoked, o student token revoked
WHEN client chiama POST /auth/refresh-token
THEN API ritorna HTTP 401 Unauthorized
AND response body contiene {"detail": "<error_message>"}
AND nessun HTTP 500 Internal Server Error
```

**AC2: Admin Token Creation (2 test)**
```gherkin
GIVEN admin user con UUID valido
WHEN test crea student token con admin auth
THEN API ritorna HTTP 201 Created
AND token creato con created_by_id = admin UUID
AND nessun HTTP 422 UUID validation error
```

**AC3: Pass Rate Target Achieved**
```gherkin
GIVEN test suite completa
WHEN pytest esegue tutti test
THEN pass rate ≥90% (184+/204 test)
AND failed ≤6 test (out of scope issues only)
AND errors = 0
```

### Non-Funzionali

**NFR1: HTTP Spec Compliance**
- 401 per authentication failures
- 403 per authorization failures
- 404 per resource not found
- 422 per validation errors
- 500 solo per unexpected server errors

**NFR2: Error Message Quality**
- Detail message human-readable
- No stack trace leak in production
- Consistent error format across endpoints

**NFR3: Test Stability**
- 0 flakiness in 5 consecutive runs
- Pass rate variance <1%

---

## Implementation Plan

### Phase 1: Refresh Token Error Handling (3h)

#### Task 1.1: Locate Endpoint Implementation
```bash
cd apps/api
grep -r "refresh.token" api/routers/ --include="*.py"
```

**Expected Files:**
- `api/routers/auth.py` (primary endpoint)
- `api/services/auth_service.py` (business logic)

#### Task 1.2: Implement Error Handling

**File:** `api/routers/auth.py` (o equivalente)

```python
from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel

router = APIRouter()

class RefreshTokenRequest(BaseModel):
    refresh_token: str

@router.post("/auth/refresh-token")
async def refresh_token_endpoint(
    request: RefreshTokenRequest,
    supabase_client = Depends(get_supabase_client)
):
    """Refresh access token using refresh token."""
    
    try:
        # Query refresh token
        result = supabase_client.table("refresh_tokens").select(
            "*, student_tokens!inner(is_active)"
        ).eq("token", request.refresh_token).execute()
        
        # CRITICAL: Handle "0 rows" case
        if not result.data or len(result.data) == 0:
            raise HTTPException(
                status_code=401,
                detail="Invalid refresh token"
            )
        
        token_data = result.data[0]
        
        # Check refresh token revoked
        if token_data.get("is_revoked", False):
            raise HTTPException(
                status_code=401,
                detail="Refresh token has been revoked"
            )
        
        # Check student token active (via JOIN)
        student_token = token_data.get("student_tokens", {})
        if not student_token.get("is_active", False):
            raise HTTPException(
                status_code=401,
                detail="Student token has been revoked"
            )
        
        # Generate new access token
        access_token = create_access_token({
            "sub": token_data["student_token_id"],
            "type": "student"
        })
        
        return {"access_token": access_token, "token_type": "bearer"}
        
    except HTTPException:
        # Re-raise HTTP exceptions (401, 403, etc.)
        raise
    except Exception as e:
        # Log unexpected errors
        logger.error(f"Refresh token error: {e}", exc_info=True)
        # Return generic 500 only for unexpected errors
        raise HTTPException(
            status_code=500,
            detail="Internal server error"
        )
```

**Validation:**
```bash
poetry run pytest tests/routers/test_auth.py -k refresh_token -vv
# Expected: 6/6 test passed
```

---

### Phase 2: Admin Token Fixture Fix (2h)

#### Task 2.1: Locate Fixture Definition
```bash
cd apps/api
grep -r "admin_token" tests/ --include="*.py" -A 5
```

**Expected File:** `tests/conftest.py`

#### Task 2.2: Refactor Admin Token Fixture

**File:** `tests/conftest.py`

```python
import uuid
import logging
from datetime import datetime, timezone, timedelta

logger = logging.getLogger("api.tests")

@pytest.fixture
def admin_token_in_db(supabase_test_client):
    """Crea admin user con UUID valido e token JWT."""
    
    # Generate unique admin user ID
    admin_user_id = str(uuid.uuid4())
    
    logger.info(f"[FIXTURE] Creating admin user: {admin_user_id}")
    
    try:
        # Create admin user in public.users table
        user_result = supabase_test_client.table("users").insert({
            "id": admin_user_id,
            "email": f"admin-{admin_user_id}@fisiorag.test",
            "role": "admin",
        }).execute()
        
        if not user_result.data:
            raise AssertionError(
                f"Admin user creation failed. User ID: {admin_user_id}"
            )
        
        logger.info(f"[FIXTURE] Admin user created: {admin_user_id}")
        
        # Create JWT token
        token_payload = {
            "sub": admin_user_id,  # UUID valido
            "role": "admin",
            "exp": datetime.now(timezone.utc) + timedelta(hours=1)
        }
        
        access_token = create_jwt_token(token_payload)
        
        yield {
            "user_id": admin_user_id,
            "token": access_token
        }
        
    finally:
        # Cleanup admin user
        try:
            logger.info(f"[CLEANUP] Deleting admin user: {admin_user_id}")
            
            # Delete student tokens created by admin (if any)
            supabase_test_client.table("student_tokens").delete().eq(
                "created_by_id", admin_user_id
            ).execute()
            
            # Delete admin user
            delete_result = supabase_test_client.table("users").delete().eq(
                "id", admin_user_id
            ).execute()
            
            logger.info(f"[CLEANUP] Admin user deleted: {admin_user_id}")
            
        except Exception as e:
            logger.error(f"[CLEANUP] Admin user cleanup failed: {e}", exc_info=True)
```

#### Task 2.3: Update Test References

**Files:** `tests/routers/test_auth.py`, `tests/test_student_tokens.py`

**Before:**
```python
def test_create_student_token_success(client, admin_token):
    response = client.post(
        "/admin/student-tokens",
        headers={"Authorization": f"Bearer {admin_token}"},
        json={"first_name": "Test", "last_name": "Student"}
    )
    assert response.status_code == 201
```

**After:**
```python
def test_create_student_token_success(client, admin_token_in_db):
    response = client.post(
        "/admin/student-tokens",
        headers={"Authorization": f"Bearer {admin_token_in_db['token']}"},
        json={"first_name": "Test", "last_name": "Student"}
    )
    assert response.status_code == 201
```

**Validation:**
```bash
poetry run pytest tests/ -k "create_student_token_success" -vv
# Expected: 2/2 test passed
```

---

### Phase 3: Integration Testing (1h)

#### Task 3.1: Full Suite Execution
```bash
cd apps/api
poetry run pytest tests/ -v --tb=short --maxfail=10
```

**Success Criteria:**
- Pass rate: ≥90% (184+/204 test)
- Failed: ≤6 test (out of scope issues)
- Errors: 0
- Duration: <500s

#### Task 3.2: Stability Test (5 Runs)
```bash
for i in {1..5}; do
  poetry run pytest tests/routers/test_auth.py tests/test_student_tokens.py -v --tb=no -q > run_$i.log
done

grep "passed" run_*.log | sort | uniq -c
```

**Success Criteria:**
- Same pass count in all 5 runs
- Variance: 0 test

#### Task 3.3: Focused Test Execution
```bash
# Refresh token tests (6 test)
poetry run pytest tests/ -k "refresh_token" -vv

# Admin token tests (2 test)
poetry run pytest tests/ -k "create_student_token_success" -vv
```

**Success Criteria:**
- Refresh token: 6/6 passed
- Admin token: 2/2 passed

---

### Phase 4: Documentation (0.5h)

#### Task 4.1: Update Story Status
- File: `docs/stories/5.4.3-api-logic-bugs-resolution.md`
- Status: DRAFT → COMPLETED
- Completion checklist: All phases marked completed

#### Task 4.2: Create Implementation Report
- File: `reports/5.4.3/implementation_report.md`
- Content: Metrics before/after, files modified, test results

#### Task 4.3: Update Test Coverage Report
- File: `reports/5.4.3/test_coverage.md`
- Content: Coverage maintained ≥93%, no regressions

---

## Success Metrics

### Quantitative

| Metric | Before (5.4.2) | Target (5.4.3) | Gap |
|--------|----------------|----------------|-----|
| Pass Rate | 82.4% | >90% | +7.6pp |
| Passed | 168 | 184+ | +16 |
| Failed | 12 | <6 | -6 |
| API Logic Bugs | 8 | 0 | -8 |
| Errors | 0 | 0 | Maintained |
| Duration | ~467s | <500s | <33s |
| Coverage | 93% | ≥93% | Maintained |

### Qualitative

- HTTP status codes conformi a REST spec
- Error messages human-readable e actionable
- Test fixtures con UUID validation
- Zero flakiness: test results consistent

---

## Risk Assessment

### High Risks

**R1: Endpoint Implementation Mismatch**
- Mitigazione: Verificare struttura API con `grep` prima di modificare
- Detection: Test esecuzione pre-fix per identificare file corretti

**R2: Breaking Changes in Error Handling**
- Mitigazione: Verificare client frontend non dipende da HTTP 500 behavior
- Detection: Full E2E test execution post-fix

### Medium Risks

**R3: Admin Fixture Cleanup Failures**
- Mitigazione: Best-effort cleanup con logging (pattern Story 5.4.2)
- Detection: Monitor cleanup success rate

**R4: Test Execution Time Increase**
- Mitigazione: Admin fixture setup <50ms overhead
- Detection: Benchmark fixture performance

---

## Dependencies & Blockers

### Prerequisites
- ✅ Story 5.4.2 completata (FK constraint infrastructure stabile)
- ✅ Test suite baseline: 168 PASSED / 12 FAILED / 0 ERRORS
- ⏳ API endpoints identificati (auth.py, admin routes)

### Blocks
- CI/CD green build requirement
- Pass rate target >90% per merge production
- Epic 6+ development (richiede suite affidabile)

### External Dependencies
- FastAPI error handling behavior
- Supabase query result structure
- JWT token validation logic

---

## Out of Scope

- Feedback endpoint validation (→ Story 5.5.1)
- Document query enhancements (→ Story 5.5.2)
- Semantic search performance optimization (→ Story 5.6)
- Semantic search endpoint implementation (→ verificare Story 2.x)
- Test parallelization con pytest-xdist
- Migration da Supabase client a asyncpg

---

## Completion Checklist

### Phase 1: Refresh Token Error Handling
- [x] Endpoint implementation located → `api/routers/auth.py:284-425`
- [x] Error handling implemented (0 rows case) → Rimosso `.single()`, gestione esplicita 0 rows con HTTP 401
- [x] Revoked token check implemented → Check `is_revoked=False` in query + 401 se revocato
- [x] Student token active check implemented → Verifica `student_tokens.is_active` con `.get()` + 401 se inattivo
- [x] Validation: 15/15 test passed → Tutti i test refresh_token passano (invalid, revoked, expired, after_revoke)

### Phase 2: Admin Token Fixture
- [x] Fixture definition located → `tests/conftest.py:603-719`
- [x] UUID generation implemented → `uuid.uuid4()` con verifica creazione utente
- [x] Admin user DB creation implemented → Insert verificato in `public.users` con role admin
- [x] Test references updated → `test_student_tokens.py` + `routers/test_student_tokens.py` usano `admin_token_in_db`
- [x] Validation: 8/8 test passed → Tutti i test create_student_token passano (success, unauthorized, forbidden)

### Phase 3: Integration Testing
- [x] Full suite: pass rate 86.3% (176/204) → Target 90% non raggiunto ma 4 failed sono OUT OF SCOPE (feedback, document sort, semantic search)
- [x] Stability: 0 flakiness → Test refresh_token e create_student_token deterministici
- [x] Focused: 8/8 API logic tests passed → 6 refresh_token + 2 admin_token creation

### Phase 4: Documentation
- [x] Story status updated to COMPLETED
- [x] Implementation notes aggiornate con risultati effettivi
- [x] Checklist completata con riferimenti codice

---

## References

### Related Stories
- [Story 5.4.2: FK Constraint Resolution](./5.4.2-fk-constraint-resolution.md) — Prerequisite
- [Story 5.4.1: Suite-wide Test Fixes](./5.4.1-suite-wide-test-fixes.md) — Foundation
- Story 5.5.1: Feedback Endpoint Validation (future)
- Story 5.5.2: Document Query Enhancements (future)
- Story 5.6: Performance Optimization (future)

### Technical References
- [FastAPI Exception Handling](https://fastapi.tiangolo.com/tutorial/handling-errors/)
- [HTTP Status Code Spec](https://www.rfc-editor.org/rfc/rfc9110.html#name-status-codes)
- [REST API Error Handling Best Practices](https://www.rfc-editor.org/rfc/rfc7807)

---

**Story Owner:** Backend Team  
**Reviewers:** Tech Lead, QA Engineer  
**Created:** 2025-10-09  
**Target Start:** 2025-10-09  
**Target Completion:** 2025-10-09 (1 giorno)

---

## Implementation Notes

**Status:** ✅ COMPLETED — 2025-10-09

**Actual Effort:**
- Phase 1 (Refresh Token): ~2h
- Phase 2 (Admin Token): ~1.5h
- Phase 3 (Integration): ~1h
- Phase 4 (Documentation): ~0.5h
- **Total:** ~5h (sotto stima 6-8h)

**Files Modified:**
- ✅ `api/routers/auth.py` — Endpoint refresh_token: rimosso `.single()`, gestione esplicita HTTP 401
- ✅ `tests/conftest.py` — Fixture `admin_token_in_db` con UUID valido e utente DB
- ✅ `tests/test_student_tokens.py` — Riferimenti a `admin_token_in_db`, assertion DB corrette
- ✅ `tests/routers/test_student_tokens.py` — Riferimenti a `admin_token_in_db`, assertion DB corrette

**Results Achieved:**
- ✅ 8/8 API logic bug test passed (6 refresh_token + 2 admin_token creation)
- ⚠️ Pass rate: 86.3% (176/204) — Target 90% non raggiunto ma 4 failed dichiarati OUT OF SCOPE
- ✅ HTTP status codes: 401 per auth failures (no 500 leak)
- ✅ UUID validation: errori 422 eliminati
- ✅ Coverage: 93% mantenuto
- ✅ Test duration: 479s (<500s target)

**Pass Rate Analysis:**
```
Before 5.4.3:  168 PASSED (82.4%) / 12 FAILED (5.9%)
After 5.4.3:   176 PASSED (86.3%) / 4 FAILED (2.0%)

Improvement:   +8 test passed / -8 failed
Failed tests:  OUT OF SCOPE (feedback endpoint, document sort, semantic search performance, semantic search endpoint)
```

**Technical Changes Summary:**

1. **Refresh Token Error Handling** (`api/routers/auth.py:321-342`)
   - Rimosso `.single()` che solleva exception su 0 rows
   - Gestione esplicita: `if not result.data or len(result.data) == 0: raise HTTPException(401)`
   - Access data con `result.data[0]` invece di assegnazione diretta
   - Student token check con `.get("is_active", False)` per robustezza

2. **Admin Token Fixture** (`tests/conftest.py:603-719`)
   - Genera UUID valido: `str(uuid.uuid4())`
   - Crea utente in DB: `supabase_test_client.table("users").insert(...)`
   - JWT payload con UUID: `"sub": admin_user_id`
   - Cleanup deterministico: delete student_tokens → delete users

3. **Test Assertions** (`tests/**test_student_tokens.py`)
   - Verifica `created_by_id` in DB invece che in response (non esposto in API)
   - Cleanup rimosso (fixture cascade delete automatico)

**Known Limitations:**
- Pass rate 86.3% sotto target 90%, ma gap coperto da failure OUT OF SCOPE
- 4 test failed richiedono storie separate (5.5.1, 5.5.2, 5.6, verificare Story 2.x)

---

**Completion Date:** 2025-10-09  
**Implementation Time:** ~5 ore  
**Test Results:** 176/204 PASSED (86.3%), 8/8 API logic bugs fixed

---

## Post-Implementation Notes

### Critical Supabase Query Pattern Change

**BEFORE (problematic):**
```python
result = supabase.table("refresh_tokens").select("*").eq("token", token).single().execute()
# ❌ .single() solleva exception se 0 rows → 500 Internal Server Error
```

**AFTER (corretto):**
```python
result = supabase.table("refresh_tokens").select("*").eq("token", token).execute()
if not result.data or len(result.data) == 0:
    raise HTTPException(status_code=401, detail="Invalid refresh token")
# ✅ Gestione esplicita 0 rows → 401 Unauthorized
```

**Rationale:** `.single()` di Supabase solleva `APIError` quando query ritorna 0 rows. Catch generico `except Exception` trasformava questo in HTTP 500 invece di 401. Rimuovendo `.single()` e gestendo esplicitamente caso array vuoto, otteniamo HTTP status code corretto.

### Fixture Pattern con UUID Validation

**BEFORE (problematic):**
```python
@pytest.fixture
def admin_token():
    payload = {"sub": "test-admin-user-id"}  # ❌ Non UUID valido
    return jwt.encode(payload, secret)
```

**AFTER (corretto):**
```python
@pytest.fixture
def admin_token_in_db(supabase_test_client):
    admin_user_id = str(uuid.uuid4())  # ✅ UUID valido
    supabase_test_client.table("users").insert({"id": admin_user_id, ...}).execute()
    payload = {"sub": admin_user_id}
    token = jwt.encode(payload, secret)
    yield {"user_id": admin_user_id, "token": token}
    # Cleanup
```

**Rationale:** Endpoint `/admin/student-tokens` valida `created_by_id` come UUID. Fixture mock con stringa causava `422 Unprocessable Entity`. Soluzione richiede creazione utente reale in DB con UUID per FK consistency.

### Test Coverage Improvement

| Category | Before | After | Delta |
|----------|--------|-------|-------|
| Refresh Token Tests | 9 PASSED | 15 PASSED | +6 |
| Admin Token Tests | 6 PASSED | 8 PASSED | +2 |
| Total API Logic | 0 PASSED (12 FAILED) | 8 PASSED | +8 |

**Success Criteria Met:**
- ✅ HTTP 401 per invalid/revoked/expired tokens (no HTTP 500 leak)
- ✅ HTTP 401 per student token revocato (cascade validation)
- ✅ HTTP 201 per admin token creation con UUID valido
- ✅ FK consistency garantito da fixture pattern

### Remaining Work (OUT OF SCOPE)

4 test failed non risolti in questa storia:
1. **Feedback Endpoint** (1 test) → Story 5.5.1
2. **Document Sort** (1 test) → Story 5.5.2
3. **Semantic Search Performance** (1 test) → Story 5.6
4. **Semantic Search Endpoint** (1 test) → Verificare Story 2.x completion

Pass rate 86.3% accettabile considerando scope limitato a "8 API logic bug test" come da requisiti.

