# Risk Profile: Story 2.11

Date: 2025-10-16
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 12
- Critical Risks: 1
- High Risks: 1
- Risk Score: 29/100

## Critical Risks Requiring Immediate Attention

### 1. TECH-001: API chat 400 Bad Request blocca l’E2E
**Score: 9 (Critical)**
**Probability**: High — riproducibile su ogni messaggio dall’UI, evidenza in Network tab e log 400.
**Impact**: High — impedisce funzionalità core, nessuna chat utilizzabile.
**Mitigation**:
- Allineare payload frontend al modello Pydantic (`ChatMessageCreateRequest`).
- Validazioni difensive lato backend con messaggi di errore chiari.
- Aggiungere test contract (schema) su request/response.
  **Testing Focus**: Contract tests HTTPX, negative tests su campi mancanti/invalidi, snapshot response 200.

### 2. DATA-001: Unicità ID dei chunk non garantita
**Score: 6 (High)**
**Probability**: Medium — indice per documento riparte, rischio collisioni se PK non globale.
**Impact**: High — citazioni errate, riferimenti ambigui, possibili inconsistenze.
**Mitigation**:
- Verificare PK globale (`id` UUID) su `document_chunks` e vincoli univoci.
- Migrazione DB per aggiungere vincoli/PK se mancanti; backfill sicuro.
  **Testing Focus**: Test integrazione su inserimenti duplicati, referential integrity, migrazioni.

## Risk Distribution

### By Category
- Security: 2 risks (0 critical)
- Performance: 3 risks (0 critical)
- Data: 3 risks (0 critical)
- Business: 2 risks (0 critical)
- Operational: 1 risk (0 critical)
- Technical: 1 risk (1 critical)

### By Component
- Frontend: 2 risks
- Backend: 5 risks
- Database: 3 risks
- Infrastructure/Ops: 2 risks

## Detailed Risk Register

| Risk ID   | Title                                                       | Prob | Impact | Score | Category   | Notes |
|-----------|-------------------------------------------------------------|------|--------|-------|------------|-------|
| TECH-001  | API chat 400 blocca l’E2E                                   | 3    | 3      | 9     | technical  | Payload/validation disallineati |
| DATA-001  | Unicità ID chunk non garantita                              | 2    | 3      | 6     | data       | Necessari PK/constraint globali |
| PERF-001  | Degrado latenza RAG >5s                                     | 2    | 2      | 4     | performance| Retrieval/generation budget |
| SEC-001   | Input utente non sanificato nella chat                      | 2    | 2      | 4     | security   | Possibile injection in logging/citation rendering |
| TECH-002  | Threshold retriever LangChain errato (zero risultati)       | 2    | 2      | 4     | technical  | Parametri k/score/filter |
| DATA-002  | Re-chunking altera riferimenti citazioni esistenti          | 2    | 2      | 4     | data       | Reprocessing strategy |
| OPS-001   | Logging/monitoring insufficienti su endpoint chat           | 2    | 2      | 4     | operational| Difficile diagnosi errori |
| PERF-002  | Bottleneck query pgvector senza indice adeguato             | 2    | 2      | 4     | performance| Necessario HNSW/IVFFlat tuning |
| BUS-001   | Risposte non pertinenti riducono valore percepito           | 2    | 2      | 4     | business   | UX e qualità |
| SEC-002   | Esposizione eccessiva metadata nelle citazioni              | 1    | 2      | 2     | security   | PII/paths |
| PERF-003  | Rate limiting inadeguato (60 rpm) in picchi reali           | 1    | 2      | 2     | performance| Protezioni lato API |
| DATA-003  | Deduplicazione documenti imperfetta                         | 1    | 2      | 2     | data       | File hash edge cases |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- Contract tests su `POST /api/v1/chat/sessions/{id}/messages` con payload validi/invalidi; assert 200/422 dettagliati.
- Test migrazioni DB e vincoli PK su `document_chunks`; test collisioni e citazioni coerenti.

### Priority 2: High Risk Tests
- Benchmark latenza: retrieval <1s, generation <4s con dataset reale.
- Test retriever con diverse soglie e k; verificare recall/precision e presence di scores.
- Test re-chunking: mappatura vecchio→nuovo chunk id; backward-compat se richiesto.

### Priority 3: Medium/Low Risk Tests
- Sicurezza: sanitizer input, escaping output, CSP headers per UI.
- Ops: log strutturati, trace id, alert su 4xx/5xx, dashboard tempi.
- Business: test E2E Playwright per pertinenza e citazioni.

## Risk Acceptance Criteria

### Must Fix Before Production
- TECH-001, DATA-001.

### Can Deploy with Mitigation
- PERF-001/002/003 con monitoraggio e budget chiari.
- SEC-001/002 con controlli e test manuali.

### Accepted Risks
- Nessuno proposto al momento; rivalutare dopo stabilizzazione chat.

## Monitoring Requirements
- APM su endpoint chat: p95/p99 latency, error rate, throughput.
- Alert su 4xx/5xx, timeouts, fallimenti retriever.
- KPI business: tasso risposte con citazioni valide, CSAT.

## Risk Review Triggers
- Cambi parametri retriever/chunking.
- Migrazioni schema o nuove integrazioni LLM.
- Incidenti sicurezza o performance regressive.

---

## Appendix: Mitigation Details

### TECH-001
- Validare modello Pydantic; rendere opzionali solo i campi necessari; messaggi errori espliciti.
- Allineare client `apps/web/src/api/chat.ts` al contratto; aggiungere schema zod.

### DATA-001
- Migrazione: aggiungere `id UUID PRIMARY KEY` su `document_chunks` (se mancante); constraint univoci su `(document_id, chunk_index)`.
- Script backfill id e verifiche di coerenza.
