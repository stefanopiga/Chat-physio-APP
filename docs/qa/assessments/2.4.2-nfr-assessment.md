# NFR Assessment — Story 2.4.2: Error Handling Ingestion Pipeline

## Scope
- **Story**: 2.4.2 — Implementazione Gestione Errori Pipeline di Ingestione (rif. L16-L23:docs/stories/2.4.2-error-handling-ingestion-pipeline.md)
- **Epic**: Epic 2 — Core Knowledge Pipeline (rif. L8:docs/stories/2.4.2-error-handling-ingestion-pipeline.md)
- **Priority**: P0 - Critical Blocker (rif. L9:docs/stories/2.4.2-error-handling-ingestion-pipeline.md)
- **Complexity**: Low (rif. L10:docs/stories/2.4.2-error-handling-ingestion-pipeline.md)
- **Effort Estimate**: 2-3 ore (rif. L11:docs/stories/2.4.2-error-handling-ingestion-pipeline.md)

## Affidabilità e Coerenza
- **Gestione errori OpenAI**: cattura `AuthenticationError`, `APIConnectionError`, `RateLimitError`, `APIStatusError` con logging e re-raise (rif. L79-L92:docs/stories/2.4.2-error-handling-ingestion-pipeline.md; L218-L244:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
```79:92:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
    try:
        embeddings = OpenAIEmbeddings(model="text-embedding-3-small")
    except openai.AuthenticationError as e:
        logger.error(f"Autenticazione OpenAI fallita: {e}")
        raise
    except openai.APIConnectionError as e:
        logger.error(f"Connessione OpenAI fallita: {e.__cause__}")
        raise
    except openai.RateLimitError as e:
        logger.warning(f"Rate limit OpenAI raggiunto: {e}")
        raise
    except openai.APIStatusError as e:
        logger.error(f"Errore API OpenAI [{e.status_code}]: {e.response}")
        raise
```
- **Validazione inserimento Supabase**: verifica `ids` non vuoto, gestione messaggi specifici (es. "Error inserting: No rows added") e logging (rif. L94-L124:docs/stories/2.4.2-error-handling-ingestion-pipeline.md; L279-L326:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
```97:104:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
        if not ids or len(ids) == 0:
            logger.error("add_texts ha restituito lista vuota - nessun chunk inserito")
            raise ValueError("Nessun chunk inserito nel vector store")

        logger.info(f"Inseriti {len(ids)} chunks con successo")
        return len(ids)
```
- **Logging di inizio e conteggio**: `logger.info("Inizio indexing N chunks")` e log di successo (rif. L76-L83, L101-L103:docs/stories/2.4.2-error-handling-ingestion-pipeline.md; L263-L301:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
## Sicurezza
- **Access control**: endpoint admin protetto; errori propagati come HTTP 500 per failure esterni (rif. L130-L135:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
- **Gestione chiavi**: requisiti `.env` per OPENAI e Supabase `service_role` specificati (rif. L574-L589; L591-L595:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
```574:589:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
# Supabase Configuration
SUPABASE_URL=https://<project-id>.supabase.co
SUPABASE_SERVICE_KEY=<service_role_key>  # NON anon key!
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>

# OpenAI Configuration
OPENAI_API_KEY=sk-proj-<valid-key>
LLM_API_KEY=<same-as-openai>
EMBEDDING_API_KEY=<same-as-openai>

# Celery Configuration
CELERY_ENABLED=true
CELERY_BROKER_URL=redis://<redis-host>:6379/0
```

## Osservabilità
- **Diagnostica completa**: log per inizio indexing, errori OpenAI, errori Supabase, successo inserimenti (rif. L263-L301; L648-L666; L754-L759:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
```654:659:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
[2025-10-06 11:54:08,323: INFO] Inizio indexing 1 chunks
[2025-10-06 11:54:08,767: ERROR] Errore inatteso durante add_texts: AuthenticationError: Error code: 401
[2025-10-06 11:54:08,795: INFO] Task retry: Retry in 1s: AuthenticationError(...)
```

## Prestazioni
- **Overhead**: aggiunta try/except e logging; nessuna indicazione di degrado prestazionale misurato nella story; embedding e insert mantengono esiti 200/201 (rif. L754-L759:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).## Scalabilità e Throughput
- **Async design**: con `CELERY_ENABLED=true` l'endpoint risponde immediatamente con `inserted: 0`; lavorazione asincrona nel worker; risultato verificabile via `/sync-jobs/{job_id}` (rif. L668-L672:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).

## Testabilità e Qualità
- **AC verificati**: AC1, AC3, AC4 con evidenze log ed esiti HTTP 500/201 (rif. L130-L169; L171-L185; L647-L666; L675-L785:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
- **Script test**: `test_story_242_manual.ps1` per TC1-TC4 creato (rif. L462-L464:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).

## Migrazioni e Configurazioni
- **Permessi e RLS**: GRANT ALL su tabelle e RLS disabilitato (rif. L520-L541:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
```520:541:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
GRANT ALL ON TABLE document_chunks TO service_role;
GRANT ALL ON TABLE documents TO service_role;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO service_role;
...
ALTER TABLE document_chunks DISABLE ROW LEVEL SECURITY;
ALTER TABLE documents DISABLE ROW LEVEL SECURITY;
```
- **Trigger document_id**: popolazione automatica della colonna `document_id` da metadata (rif. L545-L563:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
```545:563:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
CREATE OR REPLACE FUNCTION populate_document_id_from_metadata() ...
CREATE TRIGGER trigger_populate_document_id BEFORE INSERT ON document_chunks ...
```

## Conformità ai Criteri di Accettazione
- **AC1**: HTTP 500 su `AuthenticationError` con log dedicato (rif. L130-L148:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
- **AC2**: HTTP 500 su `APIConnectionError` con causa riportata (rif. L150-L156:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
- **AC3**: HTTP 500 su fallimento insert/ids vuoto con messaggio specifico (rif. L158-L169:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).
- **AC4**: Success path con `inserted > 0` e log di successo (rif. L171-L185:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).

## Rischi Residui
- **R-2.4.2-1**: pattern addendum potrebbe non coprire edge case — mitigazione: test con config invalida post-implementazione (rif. L359-L361:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).

## Decisione
- **Stato**: Conforme agli NFR per affidabilità, osservabilità, sicurezza, testabilità; pronto per review (evidenze in log e requisiti di configurazione) (rif. L647-L666; L754-L759; L574-L595:docs/stories/2.4.2-error-handling-ingestion-pipeline.md).