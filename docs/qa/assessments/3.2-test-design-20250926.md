# Test Design — Story 3.2: Augmented Generation Endpoint

## Riferimenti
- Fonte primaria: `docs/stories/3.2.augmented-generation-endpoint.md`

## Obiettivi di Test
- Verificare l'endpoint `POST /api/v1/chat/sessions/{sessionId}/messages` secondo contratto corrente (scheletro) e criteri di testing documentati.
- Validare requisiti di sicurezza (JWT), rate limiting, logging e validazioni input.
- Preparare i casi per la fase AG completa (risposta con citazioni) con mocking dell'LLM.

## Endpoint sotto test
- Metodo/Path: `POST /api/v1/chat/sessions/{sessionId}/messages` — stato attuale: scheletro, risposta `501 ag_not_implemented`.

```3:3:docs/stories/3.2.augmented-generation-endpoint.md
**Status:** Draft — scheletro endpoint presente (501 ag_not_implemented)
```
```37:38:docs/stories/3.2.augmented-generation-endpoint.md
- Endpoint implementato (scheletro): `POST /api/v1/chat/sessions/{sessionId}/messages` — attualmente ritorna `501 ag_not_implemented`.
[Fonti: `apps/api/api/main.py`]
```

## Contratto attuale (scheletro)
- Request model: `ChatMessageCreateRequest`
  - `question: str` (obbligatorio)
  - `chunks: list[ChatQueryChunk] | None` (opzionale)
- Response model: `ChatMessageCreateResponse`
  - `message_id: str`
  - `answer: str | None`
  - `citations: list[str] | None`
- Rate limiting: `60/minute`
- Auth: `Depends(_verify_jwt_token_runtime)`
- Logging: evento `ag_message_request`
- Validazioni: `400` se `sessionId` o `question` mancanti/blank

```40:52:docs/stories/3.2.augmented-generation-endpoint.md
#### Contratto attuale (scheletro)
- Request model: `ChatMessageCreateRequest`
  - `question: str` (obbligatorio)
  - `chunks: list[ChatQueryChunk] | None` (opzionale; stessa forma di `ChatQueryResponse.chunks`)
- Response model: `ChatMessageCreateResponse`
  - `message_id: str`
  - `answer: str | None`
  - `citations: list[str] | None`
- Rate limiting: `60/minute`
- Auth: `Depends(_verify_jwt_token_runtime)`
- Logging: evento `ag_message_request` con `session_id` e `has_chunks`
- Validazioni: `400` se `sessionId` o `question` mancanti/blank
[Fonti: `apps/api/api/main.py`]
```

## Strategia di Testing
- Test async su API; mocking di LLM e dipendenze esterne nella fase AG completa; copertura >= 80% per nuovo codice.

```127:130:docs/stories/3.2.augmented-generation-endpoint.md
### Testing
- Backend (Pytest + HTTPX): test async; mocking di LLM e dipendenze esterne; scenari positivi/negativi; verificare che le citazioni siano presenti in output.
- Coverage >= 80% per nuovo codice.
[Fonti: `docs/architecture/sezione-11-strategia-di-testing.md` L3–L10, L33–L37]
```

## Casi di Test

### Fase corrente (scheletro)
- TC-001 — Skeleton disponibile: richiesta valida → risposta `501 ag_not_implemented`.
  - Fonte: vedi sezioni "Endpoint sotto test".

### Validazioni input
- TC-010 — `sessionId` mancante/blank → `400`.
- TC-011 — `question` mancante/blank → `400`.
  - Fonte: vedi Contratto attuale (Validazioni 400).

### Sicurezza
- TC-020 — Token assente → `401`.
- TC-021 — Token non valido → `401`.
  - Fonte: scenari negativi documentati.

```146:150:docs/stories/3.2.augmented-generation-endpoint.md
## Testing
- Test positivi: risposta include testo e citazioni riferite a `document_id/id` dei chunk di input.
- Test negativi: mancanza `chunks` → 400; token assente/invalid → 401; throttling → 429.
- Misure: coverage >= 80%.
[Fonti: `docs/architecture/sezione-11-strategia-di-testing.md` L3–L10, L33–L37]
```

### Rate limiting e throttling
- TC-030 — Superamento soglia (≥61 richieste/min per IP) → `429`.
  - Fonte: scenari negativi e rate `60/minute` nel contratto.

```48:49:docs/stories/3.2.augmented-generation-endpoint.md
- Rate limiting: `60/minute`
- Auth: `Depends(_verify_jwt_token_runtime)`
```

### Logging
- TC-040 — Presenza log evento `ag_message_request` con `session_id` e `has_chunks`.
  - Fonte: contratto (logging).

```50:51:docs/stories/3.2.augmented-generation-endpoint.md
- Logging: evento `ag_message_request` con `session_id` e `has_chunks`
- Validazioni: `400` se `sessionId` o `question` mancanti/blank
```

### Fase AG completa (con mocking LLM)
- TC-100 — Positivo: con `question` e `chunks` validi → risposta contiene testo e `citations` riferite a `document_id/id` dei chunk.
- TC-101 — Negativo: mancanza `chunks` → `400`.
  - Fonte: sezione Testing.

```146:149:docs/stories/3.2.augmented-generation-endpoint.md
- Test positivi: risposta include testo e citazioni riferite a `document_id/id` dei chunk di input.
- Test negativi: mancanza `chunks` → 400; token assente/invalid → 401; throttling → 429.
```

## Metriche
- Coverage obiettivo: `>= 80%` per nuovo codice.

```127:130:docs/stories/3.2.augmented-generation-endpoint.md
- Backend (Pytest + HTTPX): test async; mocking di LLM e dipendenze esterne; scenari positivi/negativi; verificare che le citazioni siano presenti in output.
- Coverage >= 80% per nuovo codice.
```
