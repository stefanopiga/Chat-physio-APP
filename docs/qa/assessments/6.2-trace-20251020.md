# Requirements Traceability Matrix – Story 6.2

Story: docs/stories/6.2.watcher-configuration-diagnostics-and-stabilization.md
Date: 2025-10-20
Scope: diagnostics, configuration precedence, Redis graceful handling, LLM binding, ingestion paths, timeout validation, runbook, tests

## Coverage Summary
- Total Acceptance Criteria: 8
- Fully Covered: 7
- Partially Covered: 1 (Performance SLOs/load not in scope of this story)

## Requirement Mappings

### AC1: Docker Logs & Health (ops scripts)
- Artifacts: scripts/ops/watcher-debug.ps1, scripts/ops/watcher-debug.sh
- Evidence: Story File List; troubleshooting docs update
- Validation: Manual execution path captured in docs/operations/monitoring.md
- Coverage: full

### AC2: Redis Cache Check (graceful degradation)
- Code: apps/api/api/diagnostics/redis_check.py; apps/api/api/ingestion/watcher.py (integration)
- Tests: apps/api/tests/test_redis_graceful.py
  - Given: Redis unavailable or CLASSIFICATION_CACHE_ENABLED=false
  - When: The watcher initializes cache/check
  - Then: Warning log, no hard failure; skip connection if disabled
- Coverage: full

### AC3: Binding LLM to watcher + timeout validation
- Code: apps/api/api/knowledge_base/classifier.py::_get_llm(); apps/api/api/config.py (classification_timeout_seconds validation)
- Tests: apps/api/tests/test_classifier_binding.py; apps/api/tests/test_watcher_config.py (timeout validation)
  - Given: Settings with api_key, base_url; environment dev/prod and timeout overrides
  - When: LLM client is constructed; Settings are loaded
  - Then: api_key/base_url passed; project omitted; warnings if timeout below env floor
- Coverage: full

### AC4: Precedence .env vs process env + print_settings
- Code: apps/api/api/debug/print_settings.py; apps/api/api/config.py (logging of precedence/warnings)
- Tests: apps/api/tests/test_watcher_config.py
  - Given: Conflicting values between .env and process env for critical keys
  - When: Settings are loaded or printed
  - Then: Process env overrides; warning logged; printer redacts secrets and shows effective values
- Coverage: full

### AC5: Ingestion paths from .env with provenance and mkdir
- Code: apps/api/api/ingestion/config.py::IngestionConfig.from_env(); apps/api/api/config.py (ingestion_watch_dir/temp_dir fields)
- Tests: apps/api/tests/test_watcher_config.py
  - Given: Paths present in Settings or env; or missing
  - When: from_env resolves values
  - Then: Source is logged (settings/env/default); directories ensured; clear error if not writable
- Coverage: full

### AC6: Single-file diagnostic runner
- Code: apps/api/api/ingestion/run_diag.py
- Tests: apps/api/tests/test_watcher_diag.py
  - Given: A test document path and mock LLM
  - When: run_diag is executed with --file
  - Then: Extract→classify→chunk; timings and strategy printed; JSON report saved; exits non-zero on blocking errors
- Coverage: full

### AC7: Documentation & Runbook updates
- Docs: docs/operations/monitoring.md (Troubleshooting Watcher)
- Evidence: Story File List and diffs indicate added section and commands
- Coverage: full

### AC8: Test coverage targets
- Tests: apps/api/tests/test_watcher_config.py, test_redis_graceful.py, test_classifier_binding.py, test_watcher_diag.py; plus isolation in tests/conftest.py with reset_settings()
- Evidence: Story Dev Agent Record notes 19/19 passing, coverage ≥85% on target modules
- Coverage: full (per story evidence and test presence)

## Critical Links
- Settings isolation: apps/api/api/config.py::reset_settings(); apps/api/tests/conftest.py (autouse)
- Secrets redaction: apps/api/api/debug/print_settings.py (SENSITIVE_FIELDS policy)
- Structured logs: apps/api/api/ingestion/watcher.py and classifier initialization logs

## Gaps & Notes
- Performance SLOs and load/burst tests are outside the explicit scope of 6.2; flagged in NFR as CONCERNS for future story.
- Recommend adding CI smoke for ops scripts to validate archive layout if feasible.

## Evidence Pointers
- Story: docs/stories/6.2.watcher-configuration-diagnostics-and-stabilization.md
- Tests: apps/api/tests/test_watcher_config.py, apps/api/tests/test_redis_graceful.py, apps/api/tests/test_classifier_binding.py, apps/api/tests/test_watcher_diag.py
- Code: apps/api/api/config.py, apps/api/api/ingestion/config.py, apps/api/api/knowledge_base/classifier.py, apps/api/api/diagnostics/redis_check.py, apps/api/api/ingestion/run_diag.py
- Docs: docs/operations/monitoring.md

--
Generated by QA requirements trace for Story 6.2.

