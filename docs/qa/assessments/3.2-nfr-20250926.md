# NFR Assessment — Story 3.2 (Augmented Generation Endpoint)

## Executive Summary
- **Story**: `docs/stories/3.2.augmented-generation-endpoint.md`
- **Stato**: conforme ai requisiti NFR principali documentati
- **Ambito**: endpoint `POST /api/v1/chat/sessions/{sessionId}/messages` con LCEL, risposte con citazioni, memoria breve, RL e logging

## Requisiti NFR e Evidenze

### Sicurezza
- **Auth JWT (Supabase)**: richiesta Bearer JWT, validazione via `verify_jwt_token` e bridge `_auth_bridge`.
  - Fonte: `apps/api/api/main.py` L141–L161, L183–L193, L550–L557
- **Secrets via env**: utilizzo di `SUPABASE_JWT_SECRET`, `SUPABASE_JWT_ISSUER`, nessun secret hardcoded.
  - Fonte: `apps/api/api/main.py` L88–L93; `docs/architecture/sezione-10-sicurezza-e-performance.md` L7–L16
- **CORS e logging strutturato**: CORS applicato, logging JSON con evento `ag_message_request`.
  - Fonte: `apps/api/api/main.py` L76–L83, L53–L75, L563–L568

### Rate Limiting
- **Limite applicativo**: `60/minute` sull’endpoint AG.
  - Fonte: `apps/api/api/main.py` L550–L552; `docs/architecture/sezione-10-sicurezza-e-performance.md` L18–L23

### Performance
- **Target**: p95 < 500ms per operazioni di chat lato backend (riferimento generale di progetto).
  - Fonte: `docs/architecture/sezione-10-sicurezza-e-performance.md` L25–L31
- **Implementazione**: catena LCEL con `ChatOpenAI(model="gpt-5-nano", temperature=0)`; costruzione contesto da chunk input.
  - Fonte: `apps/api/api/main.py` L608–L618, L623–L631
- **Osservabilità**: logging `ag_metrics` con `latency_ms`, `p95_ms`, `samples` e finestra scorrevole in‑process.
  - Fonte: `apps/api/api/main.py` L660–L669; `docs/architecture/sezione-10-sicurezza-e-performance.md`

### Affidabilità e Degradazione
- **Fallback sicuro**: in assenza LLM, risposta di ripiego e citazioni derivate dai chunk; logging evento `ag_fallback`.
  - Fonte: `apps/api/api/main.py` L614–L628

### Dati e Memoria
- **Memoria breve**: persistenza in‑memory dei messaggi per sessione (`chat_messages_store`).
  - Fonte: `apps/api/api/main.py` L212–L214, L647–L658
- **Modello Output**: `AnswerWithCitations` centralizzato in `apps/api/api/models/answer_with_citations.py` e usato dal parser.
  - Fonte: `apps/api/api/main.py` L619–L631; `apps/api/api/models/answer_with_citations.py`

### Testing e Qualità
- **Strategia**: Test async Pytest+HTTPX, mocking LLM, scenari positivi/negativi, coverage ≥ 80% per nuovo codice.
  - Fonte: `docs/architecture/sezione-11-strategia-di-testing.md` L13–L22, L35–L37
- **Casi negativi previsti**: 400 su `chunks` mancanti, 401 per token mancante/invalid, 429 per throttling.
  - Fonte: `docs/stories/3.2.augmented-generation-endpoint.md` L159–L163; `apps/api/api/main.py` L570–L573; L509–L515 + RL

## Gap e Raccomandazioni
- Nessun gap bloccante aperto per 3.2. Miglioramenti futuri: esportare metriche verso sistema APM esterno.
  - Fonte: `apps/api/api/main.py` (log `ag_metrics`), `docs/architecture/sezione-10-sicurezza-e-performance.md`

## Decisione
- **Go/No-Go**: GO
  - Fonte: evidenze nelle sezioni precedenti

## Fonti
- `docs/stories/3.2.augmented-generation-endpoint.md`
- `apps/api/api/main.py`
- `docs/architecture/sezione-10-sicurezza-e-performance.md`
- `docs/architecture/sezione-11-strategia-di-testing.md`
- `docs/architecture/sezione-5-specifica-api-sintesi.md`