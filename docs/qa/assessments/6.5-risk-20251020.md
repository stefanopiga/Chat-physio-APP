# Risk Profile: Story 6.5

Date: 2025-10-20
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 0
- High Risks: 1
- Risk Score: 61/100

Rationale: The primary risk is technical misconfiguration of gpt-5-nano temperature leading to runtime failures in generation paths. Remaining risks are medium/low and mitigated by execution policy (`RUN_E2E_REAL`), retry/backoff, and structured logging requirements defined in the story.

## Critical Risks Requiring Immediate Attention

None identified. The highest risk is High (score 6) and must be addressed before merging.

## Risk Matrix

| Risk ID  | Description                                                      | Probability | Impact    | Score | Priority |
| -------- | ---------------------------------------------------------------- | ----------- | --------- | ----- | -------- |
| TECH-001 | gpt-5-nano temperature override causes runtime errors            | High (3)    | Medium (2)| 6     | High     |
| TECH-002 | Inconsistent LLM init across services (admin/chat/classifier)    | Medium (2)  | Medium (2)| 4     | Medium   |
| OPS-001  | Real E2E tests flakiness/cost if policy not enforced             | Medium (2)  | Medium (2)| 4     | Medium   |
| OPS-002  | Rate-limit handling/backoff mistakes causing failed pipelines    | Medium (2)  | Medium (2)| 4     | Medium   |
| PERF-001 | Increased latency/cost due to retries and token usage            | Medium (2)  | Medium (2)| 4     | Medium   |
| BUS-001  | Cost overrun from frequent real E2E runs                         | Medium (2)  | Medium (2)| 4     | Medium   |
| DATA-001 | Test documents not cleaned; index pollution                      | Medium (2)  | Low (1)   | 2     | Low      |
| SEC-001  | API key exposure through mis-logging                             | Low (1)     | High (3)  | 3     | Low      |

## Detailed Risk Register

### TECH-001: gpt-5-nano temperature override causes runtime errors
- Category: Technical
- Description: Passing `temperature=0` (or non-default) with `gpt-5-nano` results in API errors; identified in `admin.py` and potential via `openai_temperature_chat` in `chat_service.py`.
- Affected Components: `apps/api/api/routers/admin.py`, `apps/api/api/services/chat_service.py`
- Detection Method: Story analysis with file references; prior failures in 6.4 completion.
- Probability: High (3)
- Impact: Medium (2)
- Score: 6 (High)
- Mitigation Strategy: Preventive
  - Actions:
    - Add model-aware init: skip temperature override for nano models
    - Log explicit temperature decision for observability
    - Unit tests for nano vs non-nano behavior
  - Testing Requirements:
    - Unit tests on `_get_chat_llm()` for nano models (no temp set)
    - Integration test on generation path
  - Residual Risk: Low
  - Owner: dev
  - Timeline: Before merge

### TECH-002: Inconsistent LLM init across services
- Category: Technical
- Description: Divergent instantiations in `admin.py`, `chat_service.py`, and `classifier.py` can regress behavior when models change.
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigation: Preventive
  - Actions: Centralize LLM factory; enforce single path for ChatOpenAI construction
  - Testing: Unit/integration coverage for all call sites

### OPS-001: Real E2E tests flakiness/cost if policy not enforced
- Category: Operational
- Description: Without strict gating, real-API runs can be flaky/expensive.
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigation: Preventive/Detective
  - Actions: Enforce `RUN_E2E_REAL` guard; nightly schedule; protected CI context; alerts on auto-skip
  - Testing: Verify skip behavior, flag handling, and CI config

### OPS-002: Rate-limit handling/backoff mistakes
- Category: Operational
- Description: Incorrect handling of 429s may cause cascading failures.
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigation: Corrective/Preventive
  - Actions: Implement 60s wait on 429 (not counting toward retries); structured logging of retries
  - Testing: Simulate 429; assert backoff and retry counter behavior

### PERF-001: Latency/cost increases due to retries and token usage
- Category: Performance
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigation: Preventive/Detective
  - Actions: Track P50/P95/P99 latency, token metrics, and cost; optimize prompt size
  - Testing: Collect metrics in E2E; set thresholds

### BUS-001: Cost overrun from frequent real E2E runs
- Category: Business
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigation: Preventive
  - Actions: Budget threshold check ($100/month, configurable); CI rate limiting; feature flags
  - Testing: Validate budget guard skip path

### DATA-001: Test documents not cleaned; index pollution
- Category: Data
- Probability: Medium (2)
- Impact: Low (1)
- Score: 2 (Low)
- Mitigation: Corrective/Preventive
  - Actions: Ensure teardown deletes test docs/embeddings; fixtures with cleanup
  - Testing: Assert cleanup in tests; verify index counts before/after

### SEC-001: API key exposure through mis-logging
- Category: Security
- Probability: Low (1)
- Impact: High (3)
- Score: 3 (Low)
- Mitigation: Preventive/Detective
  - Actions: Scrub secrets in logs; centralized logger filters; prohibit printing env vars
  - Testing: Log snapshot tests to ensure redaction

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- Unit tests verifying nano default temperature behavior; fail if temperature set
- Integration: generation endpoint path with `gpt-5-nano` using real API (flagged)

### Priority 2: Medium Risk Tests
- Retry/backoff behavior including 429 specific wait
- Metrics emission and thresholds for latency/token usage
- Centralized LLM factory usage across modules

### Priority 3: Low Risk Tests
- Secret redaction snapshot checks
- Cleanup verification for test docs/embeddings

## Risk Acceptance Criteria
- Must fix before merge: TECH-001
- Can deploy with mitigation: Medium risks with monitoring (OPS/PERF/BUS)
- Accepted risks: None at this time

## Monitoring Requirements
- Security alerts for key exposure attempts (logger filter errors)
- Performance dashboards for generation latency and token usage
- Alerts on budget threshold and auto-skip events

## References
- Story: docs/stories/6.5.llm-generation-fix-e2e-validation.md
- QA Config: .bmad-core/core-config.yaml (qa.qaLocation: docs/qa)
