# Test Design — Story 5.1: Project Structure Security Refactoring

## Metadata
- **ID**: 5.1  
- **Tipo**: Technical Debt / Security  
- **Epic**: Epic 5 — DevOps & Maintainability  
- **Priorità**: P0 - Critical (Security Risk)  
- **Complessità**: Medium  
- **Stato**: Draft  

Fonte unica: `docs/stories/5.1-project-structure-security-refactoring.md`.

## Acceptance Criteria (estratti con riferimenti)

### AC1 — Security (linee 130–151)
```130:151:docs/stories/5.1-project-structure-security-refactoring.md
### AC1: Security - Credenziali Hardcoded Eliminate
**Given** il repository contiene file con credenziali hardcoded  
**When** il refactoring security viene completato  
**Then** nessun file nel repository contiene credenziali in plaintext  
**And** tutti gli script usano `python-dotenv` per caricare secrets da `.env`  
**And** `.env.example` contiene template sicuro senza valori reali  
**And** `.gitignore` include pattern per bloccare commit di secrets

**Verifica**:
```bash
# 1. Scan repository per pattern sensibili
git grep -E "(SECRET_KEY|OPENAI_API_KEY|SUPABASE_SERVICE_KEY|JWT.*eyJ)" -- '*.py' '*.ps1' '*.md'
# Expected: Nessun risultato (0 matches)

# 2. Verifica .gitignore
grep -E "^\.env$|^\*_key_backup\..\*$|^temp_env_\*$" .gitignore
# Expected: Almeno 3 matches (pattern security presenti)

# 3. Test script con dotenv
cd scripts/admin && python generate_jwt.py
# Expected: ValueError("SUPABASE_JWT_SECRET not found in environment") se .env mancante
```
```

### AC2 — Struttura (linee 153–179)
```153:179:docs/stories/5.1-project-structure-security-refactoring.md
### AC2: Struttura Directory Organizzata
**Given** il progetto ha 30+ file in root directory senza organizzazione  
**When** il refactoring struttura viene completato  
**Then** la root contiene solo file di configurazione top-level (`.gitignore`, `docker-compose.yml`, `README.md`, `.env.example`)  
**And** tutti gli script operativi sono in `scripts/` con subdirectory per categoria  
**And** i report story sono in `docs/qa/reports/` organizzati per story ID  
**And** i file temporanei sono in `temp/` (gitignored)  
**And** i test PowerShell sono migrati in `tests/integration/`

**Verifica**:
```bash
# 1. Conta file root (escluse directory)
ls -1 | grep -v '^[a-z]' | wc -l
# Expected: ≤ 10 file (solo configurazione top-level)

# 2. Verifica struttura scripts/
ls -d scripts/*/ 
# Expected: scripts/admin/ scripts/ingestion/

# 3. Verifica report organizzati
ls -d docs/qa/reports/*/
# Expected: docs/qa/reports/2.4.1/ docs/qa/reports/2.4.2/ ...

# 4. Verifica tests_power-shell eliminata
test ! -d tests_power-shell && echo "OK: Eliminata"
# Expected: "OK: Eliminata"
```
```

### AC3 — Script Operativi (linee 181–206)
```181:206:docs/stories/5.1-project-structure-security-refactoring.md
### AC3: Script Operativi Refactorizzati con Python + Dotenv
**Given** gli script operativi usano PowerShell o Python con credenziali hardcoded  
**When** il refactoring script viene completato  
**Then** tutti gli script operativi sono Python (no PowerShell)  
**And** tutti gli script caricano secrets da `.env` tramite `python-dotenv`  
**And** ogni script ha documentazione inline (docstring) e CLI arguments parsing  
**And** ogni directory script ha un `README.md` con esempi d'uso

**Verifica**:
```bash
# 1. Nessun script PowerShell in scripts/
find scripts/ -name "*.ps1"
# Expected: Nessun risultato

# 2. Tutti gli script Python caricano dotenv
grep -r "from dotenv import load_dotenv" scripts/**/*.py | wc -l
# Expected: ≥ 3 (generate_jwt.py, ingest_single_document.py, verify_ingestion.py)

# 3. Documentazione presente
find scripts/ -name "README.md" | wc -l
# Expected: ≥ 3 (admin/, ingestion/, root)

# 4. Test funzionalità script (con .env configurato)
python scripts/admin/generate_jwt.py --help
# Expected: Help message con argomenti disponibili
```
```

### AC4 — Gitignore/Security (linee 208–230)
```208:230:docs/stories/5.1-project-structure-security-refactoring.md
### AC4: Conformità .gitignore per Security
**Given** il `.gitignore` potrebbe non bloccare tutti i pattern sensibili  
**When** il refactoring security viene completato  
**Then** `.gitignore` include pattern per `.env`, backup secrets, file temporanei  
**And** `temp/` è gitignored  
**And** verifiche pre-commit prevengono commit accidentali di secrets

**Verifica**:
```bash
# 1. Verifica pattern gitignore
cat .gitignore | grep -E "^\.env$|^temp/|^\*_key_backup|^temp_env_"
# Expected: 4+ matches

# 2. Test gitignore su file test
touch temp/test.log
git add temp/test.log
git status --short
# Expected: Nessun output (file ignorato)

# 3. Git history scan
git log -p --all -S "SUPABASE_JWT_SECRET" -- '*.py'
# Expected: Solo commit di eliminazione (questo refactoring)
```
```

### AC5 — Documentazione (linee 232–257)
```232:257:docs/stories/5.1-project-structure-security-refactoring.md
### AC5: Documentazione Script Completa
**Given** gli script operativi non hanno documentazione centralizzata  
**When** il refactoring documentazione viene completato  
**Then** `scripts/README.md` contiene overview script disponibili  
**And** ogni subdirectory (`admin/`, `ingestion/`) ha `README.md` con esempi  
**And** ogni script Python ha docstring completa e help CLI funzionante  
**And** documentazione include prerequisiti (variabili d'ambiente richieste)

**Verifica**:
```bash
# 1. README principale scripts
test -f scripts/README.md && grep -q "## Admin Scripts" scripts/README.md
# Expected: Exit code 0 (file esiste e contiene sezione)

# 2. README subdirectory
test -f scripts/admin/README.md && test -f scripts/ingestion/README.md
# Expected: Exit code 0 (entrambi i file esistono)

# 3. Docstring script
python -c "import sys; sys.path.insert(0, 'scripts/admin'); from generate_jwt import generate_admin_jwt; print(generate_admin_jwt.__doc__)"
# Expected: Output con docstring (non None)

# 4. Help CLI
python scripts/admin/generate_jwt.py --help | grep -q "SUPABASE_JWT_SECRET"
# Expected: Exit code 0 (help menziona variabili richieste)
```
```

## Test Cases (estratti dal sorgente)

### Manual Testing (linee 1180–1232)
```1180:1232:docs/stories/5.1-project-structure-security-refactoring.md
## Testing Strategy

### Manual Testing (Obbligatorio)

**Test Case 1: Security - Credenziali Hardcoded Eliminate**
```bash
# 1. Scan repository
git grep -E "(SECRET_KEY|sk-proj-|eyJhbGci)" -- '*.py' '*.ps1' '*.md'
# Expected: Nessun risultato

# 2. Test script con dotenv
unset SUPABASE_JWT_SECRET
python scripts/admin/generate_jwt.py
# Expected: ValueError("SUPABASE_JWT_SECRET not found")

# 3. Test script con dotenv configurato
export SUPABASE_JWT_SECRET="test_secret_key"
python scripts/admin/generate_jwt.py --help
# Expected: Help message
```

**Test Case 2: Struttura Directory Organizzata**
```bash
# 1. Verifica file root
ls -1 | grep -v '^[a-z]' | wc -l
# Expected: ≤ 10 file

# 2. Verifica scripts/
ls scripts/admin/generate_jwt.py
ls scripts/ingestion/ingest_single_document.py
ls scripts/ingestion/verify_ingestion.py
# Expected: Tutti i file esistono

# 3. Verifica report organizzati
ls docs/qa/reports/2.4.1/
ls docs/qa/reports/2.4.2/
# Expected: Report spostati
```

**Test Case 3: Script Refactorizzati Funzionanti**
```bash
# 1. Test generate_jwt.py
python scripts/admin/generate_jwt.py --email test@example.com --expires-days 1
# Expected: JWT token generato

# 2. Test ingest_single_document.py (con API running)
python scripts/ingestion/ingest_single_document.py --help
# Expected: Help con argomenti

# 3. Test verify_ingestion.py
python scripts/ingestion/verify_ingestion.py --help
# Expected: Help con argomenti
```

**Test Case 4: Documentazione Completa**
```bash
# 1. Verifica README
test -f scripts/README.md && echo "OK"
test -f scripts/admin/README.md && echo "OK"
test -f scripts/ingestion/README.md && echo "OK"

# 2. Verifica docstring
python -c "from scripts.admin.generate_jwt import generate_admin_jwt; print(generate_admin_jwt.__doc__)"
# Expected: Docstring presente
```
```

### Integration Tests (Optional) (linee 1246–1276)
```1246:1276:docs/stories/5.1-project-structure-security-refactoring.md
### Integration Tests (Optional)

**Test Case 5: End-to-End Script Workflow**
```python
# File: tests/integration/test_script_workflow.py

import subprocess
import os
from pathlib import Path

def test_generate_jwt_script():
    """Test generate_jwt.py con .env configurato."""
    result = subprocess.run(
        ["python", "scripts/admin/generate_jwt.py", "--expires-days", "1"],
        capture_output=True,
        text=True,
        env={**os.environ, "SUPABASE_JWT_SECRET": "test_secret"}
    )
    assert result.returncode == 0
    assert "JWT ADMIN TOKEN GENERATED" in result.stdout

def test_ingest_script_help():
    """Test ingest_single_document.py help."""
    result = subprocess.run(
        ["python", "scripts/ingestion/ingest_single_document.py", "--help"],
        capture_output=True,
        text=True
    )
    assert result.returncode == 0
    assert "Usage:" in result.stdout
```
```

## Tracciabilità
- Requisiti di test derivati esclusivamente dagli AC e dalla Testing Strategy del sorgente, con citazioni linea-per-linea.

## Note
Qualsiasi contenuto non presente esplicitamente nel sorgente: non disponibile nel sorgente.
