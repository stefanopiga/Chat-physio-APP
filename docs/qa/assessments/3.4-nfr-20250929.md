# NFR Assessment — Story 3.4: Source Visualization & Feedback

## Ambito
Valutazione requisiti non funzionali per: visualizzazione citazioni con popover, invio feedback su risposte chat.

## Sicurezza
- Autenticazione JWT (Supabase) su endpoint chat/query, chat/messages, feedback. Fonte: `apps/api/api/main.py` (HTTPBearer, `verify_jwt_token`, dipendenza `_auth_bridge`, decoratore su route).
- Token recuperato lato web via `supabase.auth.getSession()` o `temp_jwt` (sessionStorage). Fonte: `apps/web/src/lib/apiClient.ts`.

## Rate Limiting
- Limitazione a `60/minute` per `/api/v1/chat/query`, `/api/v1/chat/sessions/{sessionId}/messages`, `/api/v1/chat/messages/{messageId}/feedback`. Fonte: `apps/api/api/main.py` (`@limiter.limit("60/minute")`).

## Accessibilità
- Citazioni come `<button>` con `aria-label` e `aria-haspopup`. Fonte: `apps/web/src/components/CitationBadge.tsx`.
- Popover con `role="tooltip"`, chiusura via `Esc` e click outside. Fonte: `apps/web/src/components/CitationPopover.tsx`.
- Controlli feedback come `<button>` con `aria-label`. Fonte: `apps/web/src/components/FeedbackControls.tsx`.

## Performance
- Logging metrica AG con `latency_ms` e `p95_ms`; finestra campioni configurabile (`AG_LATENCY_MAX_SAMPLES`). Fonte: `apps/api/api/main.py` (`_record_ag_latency_ms`).
- Popover non intercetta eventi (`pointerEvents: "none"`). Fonte: `apps/web/src/components/CitationPopover.tsx`.
- Stato `pendingFeedback` disabilita i pulsanti durante l'invio. Fonte: `apps/web/src/components/ChatMessagesList.tsx`.

## Affidabilità e Resilienza
- Fallback AG se LLM non disponibile: ricostruzione citazioni dai chunk, risposta di ripiego. Fonte: `apps/api/api/main.py` (blocchi `except` in create_chat_message).

## Osservabilità e Logging
- Logger JSON per tutte le richieste (`http_request`) e eventi AG/feedback. Fonte: `apps/api/api/main.py` (JSONFormatter, middleware, `logger.info`).

## Validazione ed Error Handling
- 400: `sessionId`/`question`/`chunks` mancanti; 401: token assente/invalid; 429: rate limit; 500: fallback o errori interni. Fonte: `apps/api/api/main.py` (raise `HTTPException`).
- Feedback: accetta input anche se `messageId` non trovato, con log dedicato. Fonte: `apps/api/api/main.py` (`feedback_message_not_found`).

## Dati esposti
- Citazioni arricchite con `chunk_id`, `document_id`, `excerpt` (max ~240 char), `position`. Fonte: `apps/api/api/main.py` (assemblaggio `enriched_citations`).
- Feedback memorizza `session_id`, `message_id`, `vote`, `ip`, `user_id`. Fonte: `apps/api/api/main.py` (`feedback_store`).

## Evidenza Test
- E2E: verifica presenza bottoni citazioni, visibilità `tooltip`, invio feedback con pulsante disabilitato. Fonte: `apps/web/tests/story-3.4.spec.ts` (tutti passati).
- Unit: test frontend esistenti passano. Fonte: output Vitest.

## Documentazione allineata
- Stato storia: Implementato; checklist completata. Fonte: `docs/stories/3.4.source-visualization-and-feedback.md`.
- Specifica API: endpoint feedback e citazioni arricchite documentati. Fonte: `docs/architecture/sezione-5-specifica-api-sintesi.md`, `apps/api/README.md`.
