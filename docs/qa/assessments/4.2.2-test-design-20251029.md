# Test Design: Story 4.2.2 — Analytics Dashboard - Metriche Avanzate

Date: 2025-10-29
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 24
- By level: Unit 10 (42%), Integration 9 (38%), E2E 5 (20%)
- By priority: P0 8, P1 10, P2 6, P3 0

## Test Scenarios by Acceptance Criteria

### AC1: Distribuzione Temporale Query
Scopo: Aggregazione per fasce orarie 2h, identificazione picco, ultimo periodo.

| ID              | Level | Priority | Test                                                            | Justification |
|-----------------|-------|----------|-----------------------------------------------------------------|--------------|
| 4.2.2-UNIT-001  | Unit  | P1       | Bucket 2h correctness for boundary hours (0,1,2,23)            | Pure bucketing logic |
| 4.2.2-UNIT-002  | Unit  | P1       | UTC cutoff inclusive window for `day/week/month/all`            | Deterministic cutoff |
| 4.2.2-INT-001   | Int   | P1       | Aggregate over synthetic store (mixed roles, missing timestamps)| Store iteration + filters |
| 4.2.2-INT-002   | Int   | P1       | Peak hour identification correctness                            | Aggregate + select max |
| 4.2.2-E2E-001   | E2E   | P2       | UI shows bar chart with 12 slots and correct labels (UTC)       | User-visible behavior |

Data variations/edges: empty store, <10 queries (empty state), malformed timestamps, timezone suffixes (Z, +00:00).

### AC2: Metriche Qualità Risposta
Scopo: Lunghezza media, chunk per risposta, distribuzione (min/max/mediana).

| ID              | Level | Priority | Test                                                           | Justification |
|-----------------|-------|----------|----------------------------------------------------------------|--------------|
| 4.2.2-UNIT-003  | Unit  | P1       | Average response length with mixed empty/non-empty content     | Pure math |
| 4.2.2-UNIT-004  | Unit  | P1       | Average chunks per response with/without chunk_ids             | Pure math |
| 4.2.2-UNIT-005  | Unit  | P1       | Median/min/max computation stable with even/odd samples        | Algorithmic correctness |
| 4.2.2-INT-003   | Int   | P1       | Aggregation ignores non-assistant roles                        | Component interaction |
| 4.2.2-E2E-002   | E2E   | P2       | UI renders values and units; i18n labels present               | User-visible behavior |

Edge cases: no assistant messages, extremely long content, missing chunk_ids.

### AC3: Analisi Query Problematiche
Scopo: Conteggio thumbs down, Top 5 query con più negativi, percentuale timeout/errori.

| ID              | Level | Priority | Test                                                                 | Justification |
|-----------------|-------|----------|----------------------------------------------------------------------|--------------|
| 4.2.2-UNIT-006  | Unit  | P0       | Counter logic for negative feedback tally                            | Core logic |
| 4.2.2-INT-004   | Int   | P0       | Join chat messages to feedback store and compute top 5               | Cross-component data join |
| 4.2.2-INT-005   | Int   | P1       | `total_count` present and accurate for all problematic queries       | Contract compliance |
| 4.2.2-E2E-003   | E2E   | P1       | UI lists Top 5 queries and negative count; shows total_count         | Critical path |

Edge cases: ties in ranking, case normalization, messages without ids, more than 5 items.

### AC4: Engagement Metrics
Scopo: Tempo medio sessione, query per sessione, tasso conversione feedback.

| ID              | Level | Priority | Test                                                        | Justification |
|-----------------|-------|----------|-------------------------------------------------------------|--------------|
| 4.2.2-UNIT-007  | Unit  | P1       | Average session duration calculation                        | Pure math |
| 4.2.2-INT-006   | Int   | P1       | Session grouping and queries per session integration        | Data aggregation over store |
| 4.2.2-E2E-004   | E2E   | P2       | Overview cards show values with correct formatting (minutes)| User-visible behavior |

Edge cases: short sessions, single-query sessions, sessions without feedback.

### AC5: Analisi Chunk Retrieval
Scopo: Top 10 chunk più recuperati, fonte documento, score medio similarità, total_chunks_count.

| ID              | Level | Priority | Test                                                                 | Justification |
|-----------------|-------|----------|----------------------------------------------------------------------|--------------|
| 4.2.2-UNIT-008  | Unit  | P1       | Top-N selection stability and tie-breaking determinism               | Algorithmic correctness |
| 4.2.2-INT-007   | Int   | P1       | Aggregation groups by chunk_id; counts occurrences and avg score     | Interaction with retrieval metadata |
| 4.2.2-INT-008   | Int   | P1       | Includes `document_id` only (no content leakage); threshold filter   | Data governance |
| 4.2.2-INT-009   | Int   | P1       | `total_chunks_count` accurate for unique chunk ids                   | Contract compliance |
| 4.2.2-E2E-005   | E2E   | P2       | UI shows Top 10 list with counts and doc references; no content      | User-visible behavior |

Edge cases: fewer than 10 chunks, items under k-threshold hidden, missing metadata.

### AC6: Export Dati (Optional per MVP)
Scopo: CSV conforme allowlist, anonimizzazione condizionale, hashing session_id.

| ID              | Level | Priority | Test                                                                 | Justification |
|-----------------|-------|----------|----------------------------------------------------------------------|--------------|
| 4.2.2-UNIT-009  | Unit  | P0       | Hashing function uses HMAC-SHA256 with managed secret; non-empty key | Security-critical |
| 4.2.2-INT-010   | Int   | P0       | Export service outputs exact allowlist columns and order              | Contract + privacy |
| 4.2.2-INT-011   | Int   | P0       | Anonymization toggle behavior (`query_text` vs `query_hash`)         | Privacy control |
| 4.2.2-INT-012   | Int   | P1       | Signed URL/authorization required for export                         | Access control |

Edge cases: empty dataset export, invalid toggle state, weak/empty secret.

### AC7: Filtri Temporali Base
Scopo: Mappatura UI→API, finestra UTC inclusiva, applicata a tutte le metriche.

| ID              | Level | Priority | Test                                                                   | Justification |
|-----------------|-------|----------|------------------------------------------------------------------------|--------------|
| 4.2.2-UNIT-010  | Unit  | P1       | `_get_time_cutoff(time_filter)` logic for day/week/month/all           | Pure logic |
| 4.2.2-INT-013   | Int   | P1       | All aggregations respect cutoff; dataset filtered uniformly            | Cross-aggregation correctness |
| 4.2.2-E2E-006   | E2E   | P1       | Dropdown selections update query param and reflected across sections   | Critical user flow |

Edge cases: boundary at exactly cutoff time, invalid filter value → validation error.

### AC8: Performance e UX
Scopo: p95 < 800ms su 5k query; responsività, loading/empty states.

| ID              | Level | Priority | Test                                                             | Justification |
|-----------------|-------|----------|------------------------------------------------------------------|--------------|
| 4.2.2-INT-014   | Int   | P0       | Synthetic 5k dataset: p95 latency < 800ms for week filter        | Performance requirement |
| 4.2.2-E2E-007   | E2E   | P1       | Loading states appear for heavy sections                          | UX requirement |
| 4.2.2-E2E-008   | E2E   | P1       | Empty states shown when <10 query                                 | UX requirement |

Edge cases: 30-day hard cap enforced; requests beyond cap rejected/trimmed.

### AC9: Backward Compatibility
Scopo: Metriche base Story 4.2 continuano a funzionare; nessuna regressione.

| ID              | Level | Priority | Test                                                | Justification |
|-----------------|-------|----------|-----------------------------------------------------|--------------|
| 4.2.2-INT-015   | Int   | P0       | Base metrics unchanged on same dataset              | Regression guard |
| 4.2.2-E2E-009   | E2E   | P1       | Dashboard loads with both base + advanced sections  | End-to-end check |

## Risk Coverage

- DATA-001 (CSV privacy): 4.2.2-INT-010, 4.2.2-INT-011, 4.2.2-INT-012
- SEC-001 (hashing/salt): 4.2.2-UNIT-009, 4.2.2-INT-012
- PERF-001 (latency): 4.2.2-INT-014
- TECH-001 (UTC windows): 4.2.2-UNIT-002, 4.2.2-UNIT-010, 4.2.2-INT-013
- DATA-002 (chunk metadata): 4.2.2-INT-008, 4.2.2-E2E-005
- OPS-001 (monitoring): Covered indirectly via perf/export assertions
- BUS-001 (definitions): Covered via UI labels/i18n verifications

## Recommended Execution Order
1. P0 Unit tests (hashing, counters, cutoff)
2. P0 Integration tests (export columns, anonymization, base metrics regression, performance)
3. P0 E2E tests (problematic queries list)
4. P1 Unit/Integration by AC order
5. Remaining P2 E2E/visuals

## Gate Summary Block

```yaml
test_design:
  scenarios_total: 24
  by_level:
    unit: 10
    integration: 9
    e2e: 5
  by_priority:
    p0: 8
    p1: 10
    p2: 6
  coverage_gaps: []
```

## Quality Checklist
- [x] Every AC has test coverage
- [x] Levels appropriate and deduplicated
- [x] Priorities align with risk
- [x] IDs follow convention
- [x] Scenarios atomic and independent

---

Trace Hook
- Test design matrix: docs/qa/assessments/4.2.2-test-design-20251029.md
- P0 tests identified: 8

