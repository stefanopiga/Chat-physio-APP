# Risk Profile: Story 9.1 — Hybrid Memory Foundation

Date: 2025-11-06
Reviewer: Quinn (Test Architect & Quality Advisor)
Story: docs/stories/9.1-hybrid-memory-foundation.md

## Executive Summary

- Total risks identified: 18
- Critical risks: 3
- High risks: 6
- Overall risk score: 41/100

The story introduces a dual-tier memory (L1 in-memory, L2 DB) with asynchronous persistence, circuit breaker, backpressure, durable outbox, and feature flag. The main exposure areas are data durability and ordering, failure-mode behavior under DB outages, and operational visibility. Clear mitigations are specified below with explicit test focus and monitoring requirements.

## Critical Risks Requiring Immediate Attention

### 1) DATA-001: Perdita/duplicazione messaggi durante persistenza asincrona
Score: 9 (Critical)
Probability: High — Concorrenza, retry, idempotency edge cases.
Impact: High — Storico corrotto, fiducia utente compromessa.
Mitigation:
- Idempotency key deterministica come da story; enforce unique index su chiave idempotency in DB.
- Insert idempotente: ON CONFLICT DO NOTHING, con log structured del conflict.
- Test: property-based su chiavi duplicate, test di stress con retry e crash injection.

### 2) REL-001: Circuit breaker bloccato in OPEN (fail-fast prolungato)
Score: 9 (Critical)
Probability: Medium — Parametri/temporizzazioni errate, clock skew.
Impact: High — Perdita prolungata di persistenza L2 e dati nell’outbox.
Mitigation:
- Implementare HALF_OPEN con tentativi limitati e time window affidabile; usare monotonic clock.
- Metriche e alert su stato OPEN > 2× timeout.
- Test: simulazioni con 3 failure consecutivi, verifica transizioni CLOSED↔OPEN↔HALF_OPEN.

### 3) PERF-001: Latenza chat aumenta per saturazione coda write (backpressure)
Score: 9 (Critical)
Probability: Medium — Picchi reali, p95 DB > 1s.
Impact: High — UX degradata, messaggi scartati (drop oldest) non comunicati.
Mitigation:
- Bounded queue con metriche e log ogni drop; preferire drop oldest solo se ACK lato UI.
- Alert su queue_depth > 80% e counter backpressure_activated.
- Test: carico con >100 enqueue, verificare drop policy e notifiche.

## Risk Register (detailed)

| ID         | Title                                                        | Prob | Impact | Score | Category     | Notes |
|------------|--------------------------------------------------------------|------|--------|-------|--------------|-------|
| DATA-001   | Perdita/duplicazione messaggi in persistenza asincrona      | 3    | 3      | 9     | data         | Idempotency/retry edge cases |
| REL-001    | Circuit breaker bloccato OPEN                               | 3    | 3      | 9     | reliability  | Parametri e clock |
| PERF-001   | Latenza elevata per coda write saturata                      | 3    | 3      | 9     | performance  | Backpressure e drop |
| OUTBOX-001 | Corruzione outbox/dlq su crash/partial write                | 2    | 3      | 6     | operational  | Atomicità file JSONL |
| ORDER-001  | Disordine cronologico tra L1 e L2                           | 2    | 3      | 6     | data         | Timestamp/clock monotonic |
| CONSIST-001| Divergenza L1 vs L2 (cache incoerente)                       | 2    | 3      | 6     | reliability  | Cache-first senza invalidazione |
| IDX-001    | Indici mancanti o non usati                                 | 2    | 3      | 6     | technical    | Migrazione non applicata |
| SEC-001    | Log di contenuti sensibili (PII)                             | 2    | 2      | 4     | security     | Logging structured redaction |
| OBS-001    | Metriche incomplete/assenti                                  | 2    | 2      | 4     | operational  | No visibility su failure |
| TEST-001   | Coverage <80% componenti critici                             | 2    | 2      | 4     | quality      | Mancano test property/concurrency |
| COMP-001   | Regressioni compatibilità con Story 7.1                      | 2    | 2      | 4     | technical    | API surface invariata |
| FLAG-001   | Default feature flag errato                                  | 2    | 2      | 4     | operational  | Boot in prod con flag OFF/ON sbagliato |
| MIG-001    | Failure migrazione indici con dati reali                     | 1    | 3      | 3     | technical    | Lock e tempi, GIN costoso |
| IDMP-001   | Collisione chiavi idempotenti                                | 1    | 3      | 3     | data         | Hashing/normalizzazione contenuti |
| DLQ-001    | DLQ cresce senza draining                                    | 1    | 2      | 2     | operational  | Runbook assente |
| COST-001   | Crescita storage fuori controllo                              | 1    | 2      | 2     | business     | Retention/archiviazione |
| PRIV-001   | Retention non conforme GDPR                                  | 1    | 2      | 2     | compliance   | Diritto all’oblio |
| OPS-001    | Assenza alert sui KPI chiave                                 | 1    | 2      | 2     | operational  | No SLO p95/p99 |

Legend: Prob/Impact 1=Low, 2=Medium, 3=High; Score=Prob×Impact

## Mitigations and Test Focus

- DATA-001, IDMP-001, ORDER-001, CONSIST-001
  - DB: indice unico su `idempotency_key`; ON CONFLICT DO NOTHING.
  - Chiave idempotency: `sha256(session_id + ts_ms + content_hash)`; normalizzare whitespace.
  - Usare monotonic clock per ordering locale; in DB ordinare per `(session_id, created_at DESC, id)`.
  - Test: property-based su duplicati; kill -9 tra write; test di ordinamento con clock skew simulato.

- REL-001
  - Circuit breaker: CLOSED→OPEN→HALF_OPEN con finestra temporale e max trial; usare `time.monotonic()`.
  - Metriche: `circuit_breaker_open` gauge; alert se OPEN > 2×timeout.
  - Test: failure consecutive e recovery; half-open multiplo.

- PERF-001, IDX-001
  - Migrazioni per 4 indici definiti in story; benchmark p50/p95 `db_write_latency_ms`.
  - Backpressure: soglia 80%, drop oldest con counter e log; alternative: blocco soft lato UI.
  - Test: stress con 4× throughput, verifica code, latenza, drop e metriche.

- OUTBOX-001, DLQ-001
  - Outbox JSONL con write atomica (fsync); temp file + rename; lock file.
  - Retry con exponential backoff 1→60s; max 10 tentativi; spostamento in DLQ con tracciamento.
  - Runbook “drain DLQ” e comando admin per reingestione sicura.
  - Test: crash in mezzo a write; file troncato; recovery idempotente.

- SEC-001, PRIV-001
  - Redazione contenuti nei log; separare PII dai metadati; consentire `archived=true` e retention.
  - DPIA light: retention per sessioni; endpoint per delete per utente (right to be forgotten).
  - Test: verificare assenza contenuti in log; retention applicata su query.

- OBS-001, OPS-001
  - Metriche complete (come da story): counters/gauges/histogram; dashboard e alert.
  - Tracing: trace-id per sessione; log strutturati.
  - Test: smoke su export metriche; contract Prometheus.

- TEST-001
  - Aggiungere test concurrency (asyncio), property-based (hypothesis), e integrazione DB con rollback.
  - Coverage report con soglia fallimento CI a 80%.

- COMP-001, FLAG-001
  - Feature flag `ENABLE_PERSISTENT_MEMORY` con default esplicito per env (dev=true, prod=true solo se DB ok).
  - Garantire API invariata su `get_context_window()`; fallback in-memory-only quando DB non disponibile.
  - Test: toggling runtime e fallback; backward compat con Story 7.1.

- MIG-001, COST-001
  - Eseguire migrazione in finestra bassa; creare GIN offline se dataset grande (CONCURRENTLY dove possibile).
  - Stimare crescita e aggiungere policy archiviazione/compattazione; monitor storage.

## Risk-Based Testing Strategy (Prioritized)

Priority 1 (Blockers before release)
- Idempotency e anti-duplica: test property e carico.
- Circuit breaker state-machine + recovery; verificare alerting.
- Backpressure con >100 task: drop policy, metriche, UX non bloccante.

Priority 2
- Outbox crash-safety e DLQ; reingestione.
- Ordinamento e coerenza L1↔L2; fallback DB down (graceful degradation).
- Indici/migrazioni e benchmark latenza p95.

Priority 3
- Sicurezza logging/PII; retention/GDPR.
- Osservabilità: export metriche, dashboard, alert.
- Compatibilità 7.1 e flag defaults per env.

## Monitoring & SLOs

- p95 `db_write_latency_ms` < 200ms; error rate write < 1%.
- `backpressure_activated` = 0 su p95; alert se > 5/min.
- `circuit_breaker_open` = 0; alert se > 0 per > 2×timeout.
- `outbox_queue_depth` < 50; alert se crescita monotona per 5 min.
- `retry_attempts_total` trend piatto; spike = investigare.

## Risk Acceptance

- Must-fix pre-merge: DATA-001, REL-001, PERF-001, OUTBOX-001.
- Deploy con mitigazioni: SEC-001, OBS-001, IDX-001 (se metriche ok).
- Accettati temporaneamente: COST-001, PRIV-001 con piano a data certa.

## Review Triggers

- Cambi schema messaggi o chiavi idempotenza.
- Modifiche parametri circuit breaker/backpressure.
- Incidenti con outbox/DLQ o spike latenza.

---

Document generated: docs/qa/assessments/9.1-hybrid-memory-foundation-risk-20251106.md

