# Story 2.2 – Test Design

Fonte: `docs/stories/2.2.structural-analysis-meta-agent.md`
Data: 2025-09-19

## Scope
- Verifica degli Acceptance Criteria AC1–AC5 (L13–L17) usando Pytest (unit/integration) e mock dei servizi esterni (L41–L42, L57, L70–L71).

## Tracciabilità AC → Scenari
- AC1 → TD-AC1
- AC2 → TD-AC2
- AC3 → TD-AC3
- AC4 → TD-AC4
- AC5 → TD-AC5

## Scenari di test

### TD-AC1: Prompt vincolato con PydanticOutputParser e format_instructions
- Riferimenti: L13, L48–L51
- Obiettivo: Verificare che il prompt includa `format_instructions` del `PydanticOutputParser` tramite `partial_variables`.
- Livello: unit
- Dati di test: non disponibile nella fonte.
- Criteri di esito: presenza di `format_instructions` nel prompt e binding tramite `partial_variables`.

### TD-AC2: Output validato Pydantic con classificazione, motivazione, confidenza
- Riferimenti: L14, L49, L63–L64
- Obiettivo: Verificare che l'output contenga i campi `classificazione`, `motivazione`, `confidenza` e che la confidenza rispetti il range previsto.
- Livello: unit
- Dati di test: non disponibile nella fonte.
- Criteri di esito: struttura Pydantic valida con i tre campi; confidenza in range.

### TD-AC3: Logging strutturato JSON dell'output
- Riferimenti: L15, L55–L56, L68–L69
- Obiettivo: Verificare che l'output di classificazione venga registrato come JSON strutturato.
- Livello: integration
- Dati di test: non disponibile nella fonte.
- Criteri di esito: log in formato JSON coerente con il modello; disponibilità per audit in `Document.metadata`/`chunking_strategy`.

### TD-AC4: Categorie minime documentate
- Riferimenti: L16, L56–L57, L61–L63
- Obiettivo: Verificare la presenza delle categorie `REPORT_STRUTTURATO`, `TESTO_NARRATIVO`, `DOCUMENTO_LEGALE` nella documentazione/configurazione.
- Livello: unit
- Dati di test: non disponibile nella fonte.
- Criteri di esito: categorie presenti e riferibili dal componente di classificazione.

### TD-AC5: Endpoint /classify con mock catena LCEL
- Riferimenti: L17, L51, L66–L71
- Obiettivo: Verificare che l'endpoint `/classify` restituisca l'output previsto quando la catena LCEL è mockata.
- Livello: integration
- Dati di test: non disponibile nella fonte.
- Criteri di esito: risposta contiene `classificazione`, `motivazione`, `confidenza` con struttura valida; status 200.

## NFR
- Sicurezza, performance, affidabilità, manutenibilità: non disponibile nella fonte (L41–L46 indica solo riferimenti generali).

## Ambiente e dati di test
- Ambiente: non disponibile nella fonte.
- Fixtures/dataset: non disponibile nella fonte.
