# Test Design: Story 2.7 – Database Hardening & Performance (Supabase)

Date: 2025-10-13  
Designer: Quinn (Test Architect & Quality Advisor)

## Test Strategy Overview

- Total test scenarios: 20
- By level: Unit 0, Integration 11 (55%), E2E 9 (45%)
- Priority distribution: P0: 8, P1: 11, P2: 1
- Focus areas: Auth hardening, RLS safety nets, database performance, operational readiness (pytest/pipelines), and documentation of the upgrade runway.

## Test Scenarios by Acceptance Criteria

### AC1 – Security Settings (Auth)
AC1.1 richiede leaked password protection attiva oppure decisione documentata con mitigazioni; AC1.2 impone almeno due fattori MFA (TOTP + WebAuthn/passkeys o evidenza limitazione).

| ID            | Level | Priority | Test                                                                                   | Justification                                                                                                        |
| ------------- | ----- | -------- | -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| 2.7-INT-001   | INT   | P0       | Richiamare Supabase Management API/CLI per `is_leaked_password_protection_enabled` e confrontare con atteso | Verifica automatizzabile della configurazione di sicurezza; copre hardening Auth (rischio SEC-001)                  |
| 2.7-E2E-001   | E2E   | P0       | Validare da dashboard Supabase (screenshot/evidenza) che la protezione leaked password sia ON oppure che il piano di mitigazione approvato sia archiviato | Fonte autorevole per accettazione AC1.1, necessaria per audit                                                        |
| 2.7-E2E-002   | E2E   | P0       | Percorso MFA: abilitare TOTP e (se disponibile) Passkeys/WebAuthn; verificare l’enrollment di un account amministratore e l’obbligatorietà per ruoli sensibili | Impedisce takeover; controlla enforcement MFA e documenta eventuali limiti di piano                                 |

### AC2 – RLS Policies Ottimizzate
AC2.1 impone wrapper `(SELECT auth.uid()/auth.jwt())`; AC2.2 chiede evidenza via `pg_policy`.

| ID            | Level | Priority | Test                                                                                   | Justification                                                                                                        |
| ------------- | ----- | -------- | -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| 2.7-INT-002   | INT   | P0       | Eseguire `pg_policy` + `pg_get_expr` su `student_tokens`, `refresh_tokens`, `users` per confermare l’uso del wrapper SELECT | Garantisce mitigazione del rischio di RLS errata e riduce regressioni future                                         |
| 2.7-E2E-004   | E2E   | P0       | Tentare accesso alle tabelle con utente non privilegiato (token user) e verificare che sia negato | Copre enforcement reale delle RLS; difesa contro data leakage                                                        |
| 2.7-E2E-005   | E2E   | P1       | Tentare azioni da utente admin e verificare che l’accesso sia consentito (happy path)  | Evita regressioni funzionali per ruoli legittimi                                                                     |

### AC3 – Indice FK `document_chunks.document_id`

| ID            | Level | Priority | Test                                                                                   | Justification                                                                                                        |
| ------------- | ----- | -------- | -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| 2.7-INT-004   | INT   | P1       | Query `pg_indexes` per confermare l’esistenza dell’indice `idx_document_chunks_document_id` | Copertura diretta AC3.1                                                                                              |
| 2.7-INT-005   | INT   | P1       | `EXPLAIN (ANALYZE, BUFFERS)` su query filtrata per `document_id` e validare l’uso dell’indice | Verifica benefici prestazionali (AC3.2)                                                                              |
| 2.7-INT-006   | INT   | P1       | Dopo carico mirato, campionare `pg_stat_user_indexes` e validare `idx_scan > 0`        | Conferma utilizzo reale e input per decisioni su manutenzione indici (AC3.3, rischio PERF-001/DATA-001)             |

### AC4 – Hardening Funzioni con `search_path`

| ID            | Level | Priority | Test                                                                                   | Justification                                                                                                        |
| ------------- | ----- | -------- | -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| 2.7-INT-008   | INT   | P0       | Controllare `pg_proc` affinché `prosecdef=true` per `populate_document_id_from_metadata`, `update_updated_at_column`, `match_document_chunks` | Garantisce `SECURITY DEFINER` (riduce escalation privilegi – rischio TECH-001)                                      |
| 2.7-INT-009   | INT   | P0       | Validare che `proconfig` includa `search_path=public,extensions,pg_catalog` per ciascuna funzione | Impedisce dipendenze dal search path mutabile e garantisce compatibilità vector                                     |
| 2.7-INT-010   | INT   | P1       | Confermare owner delle funzioni = `service_role` e che non vi siano owner non privilegiati | Principio del privilegio minimo (OPS-002 mitigazione indiretta)                                                     |
| 2.7-INT-012   | INT   | P1       | Invocare `match_document_chunks` con embedding reale e validare top-k ordinato          | Smoke test funzionale post-hardening per evitare regressioni operative                                              |

### AC5 – Estensione `vector` e Upgrade DB pianificati

| ID            | Level | Priority | Test                                                                                   | Justification                                                                                                        |
| ------------- | ----- | -------- | -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| 2.7-E2E-006   | E2E   | P1       | Verificare che `docs/reports/db-vector-extension-migration-plan.md` includa change log, evidenze di esecuzione e risultati post-migrazione | Attesta che il piano sia stato completato/documentato e rimanga aggiornato                                          |
| 2.7-E2E-007   | E2E   | P1       | Verificare `docs/reports/postgres-upgrade-plan.md` per finestra, prerequisiti, checklist Go/No-Go e approvazioni firmate | Mitiga rischio OPS-002; garantisce prontezza per upgrade                                                             |

### AC6 – Regressioni, test suite e documentazione

| ID            | Level | Priority | Test                                                                                   | Justification                                                                                                        |
| ------------- | ----- | -------- | -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| 2.7-E2E-009   | E2E   | P0       | Eseguire `pytest` completa nel container ufficiale (o pipeline CI) assicurando assenza di `ImportError` e failure bloccanti | Rimuove il failure corrente e chiude rischio OPS-001                                                                 |
| 2.7-E2E-010   | E2E   | P1       | Eseguire `scripts/validation/database_connectivity_test.py` + `database_integrity_audit.py`; salvare output in `reports/` | Garantisce non regressione connettività e integrità DB                                                              |
| 2.7-E2E-011   | E2E   | P1       | Raccogliere metriche Supabase (p95/p99) per query ingestion/search/chat pre/post hardening; archiviare in `reports/metrics-*.md` | Copre requisito AC6.1 e rischio PERF-001                                                                             |
| 2.7-INT-013   | INT   | P1       | Diff automatizzato dei documenti di validazione (`docs/reports/*.md`) per verificare aggiornamenti delle sezioni “Evidenze” e “Piano Test” | Garantisce coerenza documentale (AC6.2)                                                                              |
| 2.7-INT-014   | INT   | P2       | Verificare che i file di evidenza (es. `reports/metrics-p95-YYYYMMDD.md`, screenshot Auth) siano presenti e collegati nella story | Mantiene tracciabilità delle prove, utile come controllo continuo                                                    |

## Risk Coverage

- **SEC-001 (Auth incompleto):** 2.7-INT-001, 2.7-E2E-001, 2.7-E2E-002
- **OPS-001 (pytest suite rotta):** 2.7-E2E-009, supportato da 2.7-E2E-010 per gli script di validazione
- **OPS-002 (upgrade Postgres sospeso):** 2.7-E2E-007 (piano aggiornato e approvazioni)
- **PERF-001 (assenza telemetria):** 2.7-INT-006, 2.7-E2E-011
- **DATA-001 (decisioni sugli indici):** 2.7-INT-006, 2.7-INT-014
- **TECH-001 (drift funzioni hardened):** 2.7-INT-008, 2.7-INT-009, 2.7-INT-010, 2.7-INT-012
- RLS enforcement (AC2) continua a garantire barriera security anche se non classificata tra i rischi residui.

## Recommended Execution Order

1. **P0 Integration:** 2.7-INT-001, 2.7-INT-002, 2.7-INT-008, 2.7-INT-009  
2. **P0 E2E:** 2.7-E2E-001, 2.7-E2E-002, 2.7-E2E-004, 2.7-E2E-009  
3. **P1 Integration:** 2.7-INT-004, 2.7-INT-005, 2.7-INT-006, 2.7-INT-010, 2.7-INT-012, 2.7-INT-013  
4. **P1 E2E:** 2.7-E2E-005, 2.7-E2E-006, 2.7-E2E-007, 2.7-E2E-010, 2.7-E2E-011  
5. **P2 Controls:** 2.7-INT-014 (evidenze e archiviazione)

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 20
  by_level:
    unit: 0
    integration: 11
    e2e: 9
  by_priority:
    p0: 8
    p1: 11
    p2: 1
  coverage_gaps: []
```

## Trace References

```
Test design matrix: docs/qa/assessments/2.7-test-design-20251013.md
P0 tests identified: 8
```

## Notes

- Automatizzare i controlli INT dove possibile (query SQL, diff documentali) e versionarli come script in `scripts/validation/` o `scripts/sql/verification/` per riesecuzioni rapide.  
- Le evidenze E2E (screenshot Auth, output CLI Supabase, log pytest) devono essere archiviate insieme alla story e referenziate nella Dev Agent Record per semplificare l’audit.  
- Integrare i test P0/P1 nel job CI pre-deploy; usare i P2 come guardrail periodici (es. cron settimanale su metriche e archiviazione evidenze).  
