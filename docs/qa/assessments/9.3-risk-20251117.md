# Risk Profile: Story 9.3

Date: 2025-11-17
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 12
- Critical Risks: 2
- High Risks: 4
- Risk Score: 46/100

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Broken authorization on session operations
**Score: 9 (Critical)**
**Probability**: High - Endpoint and UI manipulate sessions by ID; without strict ownership checks, a user could delete or rename sessions not owned by them (ID guessing or leakage).
**Impact**: High - Unauthorized delete causes irreversible data loss across users and privacy breach.
**Mitigation**:
- Enforce per-user ownership checks on all session endpoints (DELETE, PATCH, GET).
- Use subject-scoped queries: `WHERE session_id=$1 AND user_id=$jwt.sub` with composite index.
- Add negative tests for cross-tenant attempts (expect 404/403).
  **Testing Focus**: AuthZ unit/integration tests; security tests for IDOR; Playwright tests ensuring users cannot affect others' sessions.

### 2. DATA-001: Irreversible hard delete without recovery guardrails
**Score: 9 (Critical)**
**Probability**: Medium - UI exposes destructive action; mistakes are common, and no backend soft-delete exists.
**Impact**: High - Permanent loss of chat history; compliance and support issues.
**Mitigation**:
- Implement soft-delete flag (`metadata->>'archived' = 'true'`) plus async hard-delete janitor after retention window (e.g., 30 days).
- Require server-side confirmation token or double-submit pattern for destructive actions.
- Add backups and restore tooling scoped to session/user.
  **Testing Focus**: Verify soft-delete path, janitor job, and that soft-deleted data never appears in queries.

## Risk Distribution

### By Category

- Security: 3 risks (1 critical)
- Performance: 2 risks (0 critical)
- Data: 3 risks (1 critical)
- Business: 2 risks (0 critical)
- Operational: 1 risk (0 critical)
- Technical: 1 risk (0 critical)

### By Component

- Frontend: 4 risks
- Backend: 5 risks
- Database: 2 risks
- Infrastructure: 1 risk

## Detailed Risk Register

| Risk ID  | Description | Probability | Impact | Score | Priority | Category | Components | Mitigation Summary |
|---------|-------------|-------------|--------|-------|----------|----------|------------|--------------------|
| SEC-001 | Broken authorization on session operations (IDOR) | High (3) | High (3) | 9 | Critical | Security | API, DB | Enforce ownership checks; tests |
| DATA-001 | Irreversible hard delete | Medium (2) | High (3) | 6 | High | Data | API, DB | Soft-delete + retention; backups |
| SEC-002 | CSRF on DELETE without proper protections | Medium (2) | High (3) | 6 | High | Security | API | If cookies: CSRF token; else Bearer only with strict CORS |
| SEC-003 | Rate limiting misconfiguration (global instead of per-user) | Medium (2) | Medium (2) | 4 | Medium | Security | API | Per-user limiter; headers; tests |
| PERF-001 | Session list scaling (N>1k) causes slow UI/API | Medium (2) | Medium (2) | 4 | Medium | Performance | API, FE | Pagination + virtual list; indexes |
| PERF-002 | Delete cascades lock contention on hot partitions | Low (1) | Medium (2) | 2 | Low | Performance | DB | Batched deletes; index guidance |
| DATA-002 | Inconsistent state after delete (localStorage vs server) | Medium (2) | Medium (2) | 4 | Medium | Data | FE | Robust optimistic update + server reconcile |
| DATA-003 | Rename path corrupts metadata JSON (merge errors) | Low (1) | Medium (2) | 2 | Low | Data | API | JSONB merge with validation + tests |
| TECH-001 | Zustand store bugs cause incorrect current session | Medium (2) | Medium (2) | 4 | Medium | Technical | FE | Deterministic actions; unit tests |
| BUS-001 | Confusing UX leads to accidental deletes | Medium (2) | Medium (2) | 4 | Medium | Business | FE | Clear destructive UI; undo; confirmations |
| BUS-002 | Sidebar unusable on small screens | Low (1) | Medium (2) | 2 | Low | Business | FE | Responsive tests; accessibility checks |
| OPS-001 | Missing monitoring/alerts for delete/rename | Medium (2) | Medium (2) | 4 | Medium | Operational | API, Infra | Audit logs; metrics; alerts |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- IDOR tests: user A cannot access/delete user B sessions (API and E2E).
- Soft-delete flow tests and retention janitor (integration).
- Backup/restore drill for a single session (runbook validation).

### Priority 2: High Risk Tests
- CSRF protections validated (if cookies used, require CSRF token; if Bearer, ensure CORS and no credential mode).
- Rate limiting per-user validated; 429 with Retry-After; ensure no global throttling of tenants.
- Pagination/virtualization for session list with 1k+ sessions (FE perf test).

### Priority 3: Medium/Low Risk Tests
- Zustand store actions unit tests (add/remove/update/setCurrent).
- Delete reconciliation: FE removes item, server confirms, new-chat auto-trigger if current deleted.
- Accessibility tests for dialogs and sidebar (focus trap, aria labels).

## Monitoring Requirements
- Metrics: delete/rename counts, 4xx/5xx rate, p95 for session list and delete.
- Alerts: spike in deletes; repeated 403s; DB lock waits; janitor failures.
- Logs: structured audit logs with user_id, session_id, action, result.

## Risk Acceptance Criteria
- Must fix before prod: SEC-001, DATA-001; any CSRF exposure in cookie-auth config.
- Can deploy with mitigation: PERF-001 with pagination flag; SEC-003 with rate limiter tuned and monitors.
- Accepted risks: None at this time.

## Recommendations Summary
- Add ownership checks and negative tests now.
- Prefer soft-delete + retention; ship hard-delete behind feature flag for admins only initially.
- Implement per-user rate-limiting and CSRF-safe auth pattern; confirm CORS policy.
- Add pagination API and FE virtualization before enabling on large datasets.
- Wire audit logging + dashboards before release.

