# Risk Profile: Story 6.7 — Chat UI/UX Enhancements

Date: 2025-10-21
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 14
- Critical Risks: 1
- High Risks: 5
- Risk Score: 46/100

## Critical Risks Requiring Immediate Attention

### 1. UX-ACC-001: Regressioni di accessibilità e focus-trap

Score: 9 (Critical)
Probability: High — molti cambi UI simultanei (header, loading state, textarea)
Impact: High — utenti tastiera/screen reader bloccati o disorientati
Mitigation:
- Pattern ARIA corretti per `status/progressbar`, landmark `<header> / <main> / <nav>`
- Gestione focus esplicita durante loading e navigazione; test con NVDA/VoiceOver
- Axe/Storybook a11y checks in CI; snapshot semantici per landmark e ruoli
Testing Focus: test di navigazione via tastiera, order del focus, annunci ARIA, contrasto e skip-links

## Risk Matrix

| Risk ID     | Description                                                                 | Probability | Impact | Score | Priority |
|-------------|-----------------------------------------------------------------------------|-------------|--------|-------|----------|
| UX-ACC-001  | Focus trap/annunci ARIA errati su loading e nuova navigazione               | High (3)    | High (3) | 9   | Critical |
| NAV-001     | Header/nav attivo non coerente tra route                                    | High (3)    | Medium (2) | 6 | High     |
| PERF-UI-001 | Layout full-height provoca jank/overflow su mobile (vh/dvh)                 | Medium (2)  | High (3) | 6 | High     |
| REG-001     | Regressioni CSS: rottura layout pagine login/dashboard                      | Medium (2)  | High (3) | 6 | High     |
| UX-002      | Textarea auto-resize causa loop/scroll jump                                 | Medium (2)  | Medium (2) | 4 | Medium   |
| UX-003      | Gestione Enter/Shift+Enter interferisce con submit o IME                    | Medium (2)  | Medium (2) | 4 | Medium   |
| A11Y-002    | Landmark/ruoli mancanti o duplicati (header/nav/main)                       | Medium (2)  | Medium (2) | 4 | Medium   |
| MOB-001     | Tastiera virtuale copre input su iOS/Android                                | Medium (2)  | Medium (2) | 4 | Medium   |
| INT-001     | Loading indicator non si sincronizza con stato async chat                   | Low (1)     | High (3) | 3  | Low      |
| TEST-001    | Mancanza di test e2e visivi/accessibilità per nuovi componenti              | Low (1)     | High (3) | 3  | Low      |
| PERF-UI-002 | Spinner/animazioni impattano rendering o aumentano CLS                      | Low (1)     | Medium (2) | 2 | Low      |
| SEC-UI-001  | Link nav verso route non protette o leakage di stato                        | Low (1)     | Medium (2) | 2 | Low      |
| DOC-001     | Divergenza da design system Tailwind/Shadcn                                 | Low (1)     | Medium (2) | 2 | Low      |
| OPS-UI-001  | Fallback incompleti se componenti Shadcn non disponibili                    | Low (1)     | Medium (2) | 2 | Low      |

## Risk Distribution

- Accessibility/UX: 5 (1 critical)
- Navigation/Routing: 2 (0 critical)
- Performance/UI: 2 (0 critical)
- Regression (CSS/Layout): 1 (0 critical)
- Mobile/Responsiveness: 1 (0 critical)
- Integration/State: 1 (0 critical)
- Security: 1 (0 critical)
- Ops/Tooling: 1 (0 critical)

## Detailed Risk Register

UX-ACC-001 — Focus trap e annunci ARIA
- Description: durante loading o passaggi di pagina, focus perso o non annunci corretti
- Components: `LoadingIndicator.tsx`, layout `App.tsx`, `ChatMessagesList`
- Detection: test NVDA/VoiceOver, axe ci, keyboard-only run-through
- Mitigation: `role="status"`/`aria-live="polite"`, landmark semantici, gestione `tabIndex`, skip link

NAV-001 — Stato voce attiva incoerente
- Description: evidenziazione route attiva non aggiornata o multipla
- Components: `Navigation.tsx`, router
- Mitigation: usare hook router per match esatto, test su `/chat`, `/admin/dashboard`, `/login`

PERF-UI-001 — Full-height jank su mobile
- Description: `h-screen` vs `100dvh` causa rimbalzi con address bar/tastiera
- Components: `ChatPage.tsx`
- Mitigation: fallback `min-h-[100dvh]` condizionale, CSS env `safe-area-inset*`, test su device reali

REG-001 — Regressioni di layout
- Description: rimozione `min-h-[300px]` e refactor flex rompe card o overflow
- Components: `ChatPage.tsx`, componenti card
- Mitigation: visual regression su viewport chiave, checklist CSS, rollback rapido

UX-002 — Auto-resize loop/scroll jump
- Description: ricalcolo altezza textarea genera loop o salti scroll
- Components: `ChatInput.tsx`
- Mitigation: reset a `height:auto` prima di leggere `scrollHeight`, clamp a 4 righe, test IME

UX-003 — Enter handling/IME
- Description: conflitti tra submit con Enter e IME/Shift+Enter
- Components: `ChatInput.tsx`
- Mitigation: `preventDefault` condizionale, feature test per IME, fallback bottone invio

A11Y-002 — Landmark/ruoli
- Description: header/nav/main mancanti o duplicati
- Components: layout principale
- Mitigation: `<header role="banner">`, `<nav aria-label="Principale">`, `<main role="main">`

MOB-001 — Tastiera copre input
- Description: su iOS Safari l’input resta nascosto
- Components: `ChatInput.tsx`
- Mitigation: `100dvh` + scroll-into-view sul focus, padding-bottom dinamico, test real device

INT-001 — Desync loading indicator
- Description: spinner resta visibile dopo risposta o non appare
- Components: `ChatMessagesList`, store stato
- Mitigation: derive loading da pending request id, effect cleanup

TEST-001 — Copertura test insufficiente
- Description: mancano test e2e/accessibilità sui nuovi componenti
- Components: test suite web
- Mitigation: aggiungere test Playwright per keyboard nav e axe checks

PERF-UI-002 — Animazioni e CLS
- Description: spinner/transition causano layout shift
- Components: `LoadingIndicator.tsx`
- Mitigation: riservare spazio, usare `visibility` anziché mount/unmount, preferire CSS transform

SEC-UI-001 — Navigazione e permessi
- Description: link verso route protette senza guard
- Components: `Navigation.tsx`, route guards
- Mitigation: condizionare voci nav per ruolo; verificare auth state in header

DOC-001 — Allineamento design system
- Description: deviazione da Tailwind/Shadcn
- Components: nuovi componenti
- Mitigation: usare `Textarea` shadcn o wrapper coerente; checklist design system

OPS-UI-001 — Fallback componenti
- Description: assenza `Textarea` shadcn in setup corrente
- Components: dependency install
- Mitigation: toggle fallback a textarea custom con stile coerente

## Risk-Based Testing Strategy

Priority 1 (Critical)
- A11Y: keyboard-only flow su tutte le route, axe checks, announcements su loading

Priority 2 (High)
- Full-height layout su 5 viewport + 2 device reali; focus behavior con tastiera
- Visual regression su login/dashboard/chat; sincronizzazione loading indicator

Priority 3 (Medium/Low)
- Textarea auto-resize (IME, loop), Enter/Shift+Enter, CLS con spinner

## Risk Acceptance Criteria

- Must Fix: tutti i Critical (score 9) prima del merge
- Deploy con Mitigazione: High con check visivo + a11y automatici in CI
- Accepted: Medium/Low documentati con owner e follow-up

## Monitoring Requirements

- Frontend: error rate UI, CLS/LCP nei Web Vitals, focus-visible anomalies (manuale)
- A11Y: axe ci report zero-violations su route toccate
- UX: feedback qualitativo post-rilascio su input e navigazione

## Risk Review Triggers

- Cambi a layout globale o routing
- Introduzione/aggiornamento componenti shadcn
- Bug report su mobile/input/accessibilità

---

# risk_summary (paste into gate file)
risk_summary:
  totals:
    critical: 1
    high: 5
    medium: 6
    low: 2
  highest:
    id: UX-ACC-001
    score: 9
    title: "Regressioni accessibilità (focus/annunci ARIA)"
  recommendations:
    must_fix:
      - "Aggiungere e validare landmark/ruoli ARIA + keyboard flow"
      - "Axe checks e snapshot semantici in CI per nuove pagine"
    high_priority:
      - "Test full-height su mobile con 100dvh + fallback"
      - "Visual regression login/dashboard/chat su viewport chiave"
