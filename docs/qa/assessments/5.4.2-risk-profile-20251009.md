# Risk Profile — Story 5.4.2: FK Constraint Violations Resolution

Status: Draft (2025-10-09)
Source: `docs/stories/5.4.2-fk-constraint-resolution.md`

---

## 1) Executive Summary
- Objective: Eliminare 15 FK constraint errors per raggiungere pass rate >90%.
- Scope: Fixture `student_token_in_db` e correlati (`refresh_token_in_db`, `supabase_test_client`).
- Impact atteso: Stabilità suite, CI/CD affidabile, nessuna flakiness.

## 2) Risk Register (estratto dalla Story)

### R1 — Transactional Approach Complexity
- Severity: High (source L632-L635)
- Probability: Medium (non obbligatorio se incremental fix sufficiente)
- Impact: Aumento complessità, rischio regressioni.
- Mitigation: Avviare con simple verification; usare transazioni solo se necessario (L633-L635).
- Detection: Benchmark overhead <50ms per fixture; prove in isolation (L634-L635).

### R2 — Supabase Client API Limitations
- Severity: High (L636-L639)
- Probability: Medium (dipendenza esterna)
- Impact: Impossibilità di garantire semantiche transazionali.
- Mitigation: Fallback a asyncpg direct connection (L637-L638).
- Detection: Test transactional API in isolation (L638-L639).

### R3 — Fixture Refactoring Breaking Tests
- Severity: High (L640-L643)
- Probability: Medium (ampiezza modifiche)
- Impact: Failures diffusi post-refactor.
- Mitigation: Backward compatible API, cambiare solo implementazione interna (L641-L642).
- Detection: Full suite run dopo ogni fase (L642-L643).

### R4 — Performance Regression
- Severity: Medium (L646-L649)
- Probability: Low-Medium
- Impact: +durata suite; timeout sporadici.
- Mitigation: UUID overhead minimo; benchmark setup <100ms (L647-L648).
- Detection: Misurare tempo fixture; durata suite <550s (L648-L649, L571-L575).

### R5 — Cleanup Failures Non-Critical
- Severity: Medium (L650-L653)
- Probability: Medium
- Impact: Pollution DB tra test; flakiness.
- Mitigation: Log warning, best-effort cleanup (L651-L652).
- Detection: Monitor cleanup success rate >95% (L652-L653).

### R6 — Race Conditions Persistenti (non esplicitato, inferito dal contesto Story)
- Severity: High (rif. L237-L247, L646-L649)
- Probability: Medium-High (con parallelismo)
- Impact: FK errors residui, instabilità.
- Mitigation: Unique UUID per test (L252-L331); parallel stress test con xdist (L577-L586).
- Detection: `pytest -n 8 --count=3` su auth/student_tokens (L579-L581).

## 3) Controls & Mitigations (dagli AC e dal Plan)

- C1: Unique ID Generation per fixture (L252-L331)
- C2: Verified Insert Pattern (assert su INSERT parent e child) (L274-L291, L293-L329)
- C3: Deterministic Cleanup (child → parent con verifica) (L299-L317)
- C4: Scope Optimization (client function-scoped o options) (L391-L443)
- C5: Transactional Fixture (opzionale, fallback) (L337-L385)
- C6: Parallel Stress Test (xdist) (L577-L586)
- C7: Flakiness Detection 10 runs (L588-L601)

## 4) Success Criteria (tracciati alla Story)
- SC1: FK errors = 0 (L571-L575)
- SC2: Pass rate >90% (L571-L575)
- SC3: Variance <1 test in 10 runs (L598-L601)
- SC4: Suite duration <550s (L575)

## 5) Test Plan di Verifica Rischi (estratto Story)
1. Sequential validation: `pytest tests/ -v --tb=short --maxfail=5` (L565-L569)
2. Parallel stress: `pytest tests/routers/test_auth.py tests/routers/test_student_tokens.py -n 8 --dist loadfile -vv --count=3` (L577-L586)
3. Flakiness 10 runs: loop su `test_auth.py` con analisi variance (L588-L596)

## 6) Decision Log (Story-driven)
- Start incremental (C1-C3), valutare C5 solo se necessario (L632-L639).
- Mantenere API fixture invariata (L641-L642).

## 7) Open Questions (riprese dalla Story)
- Transactional vs simple verification? (L771)
- Supabase client vs asyncpg fallback? (L772)
- Cleanup failure policy (warning vs crash)? (L773)
- Performance budget per fixture? (L774)

## 8) Sign-off Criteria
- [ ] SC1: 0 FK errors in full suite
- [ ] SC2: Pass rate >90%
- [ ] SC3: 10/10 runs stabili (variance <1)
- [ ] SC4: Duration <550s
- [ ] Documentazione aggiornata (Checklist Phase 6) (L711-L717)

---

Appendice — Criteri di Tracciabilità
- Tutte le sezioni fanno riferimento a linee del documento sorgente (`5.4.2-fk-constraint-resolution.md`).
- Nessuna informazione esterna introdotta.
