# Requirements Traceability — Story 1.3: Student Access Code System

Data: 2025-09-12
Fonte requisiti: `docs/prd.md#Sezione 7`, `docs/prd/sezione-7-epic-1-dettagli-foundation-user-access.md`, `docs/stories/1.3.student-access-code-system.md`
Riferimenti architettura: `docs/architecture/sezione-4-modelli-di-dati.md` (AccessCode), `docs/architecture/sezione-5-specifica-api-sintesi.md`, `docs/architecture/sezione-10-sicurezza-e-performance.md`, `docs/architecture/sezione-11-strategia-di-testing.md`
Altri riferimenti QA: `docs/qa/gates/1.3-student-access-code-system.yml`, `docs/sprint-change-proposal-20250912.md`

## Acceptance Criteria → Test Mapping

AC1: Endpoint admin per generare codici.
- Test Level: Integration (BE: Pytest + HTTPX)
- Given: admin autenticato via Supabase Auth
- When: richiama endpoint generazione codice
- Then: viene creato record `AccessCode` persistito con attributi previsti (`code`, `is_active`, `created_by_id`, timestamps)
- Fonti: PRD Sezione 7; Architettura sezione-4 (AccessCode); Story 1.3 Dev Notes (Security model)

AC2: Endpoint pubblico per validare un codice.
- Test Level: Integration (BE: Pytest + HTTPX)
- Given: codice esistente e attivo
- When: richiesta di validazione
- Then: esito positivo
- Note: casi negativi richiesti in story (codice inesistente/inattivo/scaduto)
- Fonti: PRD Sezione 7; Story 1.3 Testing Requirements

AC3: Un codice valido restituisce un token temporaneo.
- Test Level: Integration (BE)
- Given: codice valido (attivo/non scaduto)
- When: validazione
- Then: response contiene token temporaneo
- Dettagli token (issuer/formato/claims/audience/durata): not available in source
- Fonti: PRD Sezione 7; Story 1.3 “Token temporaneo (dettagli richiesti)”

AC4: La pagina principale ha un campo per il codice.
- Test Level: Unit/Integration (FE: RTL)
- Given: render pagina principale
- Then: campo input codice presente
- Fonti: PRD Sezione 7; Story 1.3 Component Specifications

AC5: Inserendo un codice valido, si viene reindirizzati alla chat.
- Test Level: E2E (Playwright) + FE Integration
- Given: codice valido inserito
- When: submit
- Then: redirect a `/chat`
- Fonti: PRD Sezione 7; Story 1.3 Testing Requirements

AC6: Il campo del codice di accesso non può essere inviato se vuoto.
- Test Level: Unit/Integration (FE: RTL)
- Given: input vuoto
- When: submit
- Then: blocco submit; errore specifico sotto il campo
- Fonti: PRD Sezione 7; Story 1.3 Testing Requirements

AC7: Messaggio di errore specifico se validazione client-side fallisce.
- Test Level: Unit/Integration (FE: RTL)
- Given: input non valido
- When: submit
- Then: messaggio di errore specifico sotto il campo
- Fonti: PRD Sezione 7; Story 1.3 Testing Requirements

## Coverage Summary
- AC coperti: [1,2,3,4,5,6,7]
- Gaps:
  - AC3: specifica del token temporaneo assente (issuer/formato/claims/audience/durata) → blocca definizione test assertion: not available in source
  - AC2/AC3: endpoint/route esatti non documentati → impedisce definizione URL e shape esatte: not available in source

## Risks & Notes (Derivato dalle fonti)
- Sicurezza: definizione token temporaneo mancante; RLS e protezione endpoint admin da rispettare. Fonti: Architettura Sezione 10, Story 1.2, Story 1.3.
- Test Strategy: necessaria copertura negativa per codici inesistenti, inattivi, scaduti e riuso (`usage_count`). Fonte: Story 1.3 Testing Requirements.

## Recommendations
- Integrare la story con specifica token e dettagli endpoint prima di implementare i test AC3.
- Mantenere mapping livelli test come da Story 1.3; aggiungere fixture/mocking per Supabase.
