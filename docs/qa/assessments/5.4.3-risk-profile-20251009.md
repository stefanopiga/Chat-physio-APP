# Risk Profile: Story 5.4.3 — API Logic Bugs Resolution

Date: 2025-10-09
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 12
- Critical Risks: 3
- High Risks: 4
- Risk Score: 56/100

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Gestione errori refresh token ritorna 500 invece di 401
**Score: 9 (Critical)**  
**Probability**: High — Bug riproducibile in 6 test; query "0 rows" non gestita.  
**Impact**: High — Leakage di 500 causa failure sicurezza e regressioni client.
**Mitigation**:
- Implementare gestione esplicita 0 rows con HTTP 401.  
- Aggiungere check token revocato e student token inattivo.  
- Test: 6 scenari refresh token invalid/revoked/parent revoked.

### 2. SEC-002: UUID non valido per admin `created_by_id`
**Score: 9 (Critical)**  
**Probability**: High — Fixture usa stringa non UUID in 2 test.  
**Impact**: High — 422 su endpoint admin, blocca creazione token.
**Mitigation**:
- Generare UUID valido per admin; creare utente admin in DB.  
- Aggiornare test a usare `admin_token_in_db`.  
- Test: 2 casi `create_student_token_success`.

### 3. TECH-001: Mancata join/validazione stato `student_tokens`
**Score: 9 (Critical)**  
**Probability**: Medium — Assenza join porta a validazioni incomplete.  
**Impact**: High — Possibile rilascio token con parent revocato.
**Mitigation**:
- Aggiungere join/select su `student_tokens.is_active`.  
- Gestire 401 se non attivo.  
- Test: scenari parent revoked.

## Risk Distribution

### By Category
- Security: 4 rischi (3 critical)
- Performance: 2 rischi (0 critical)
- Data: 2 rischi (0 critical)
- Business: 2 rischi (0 critical)
- Operational: 2 rischi (0 critical)

### By Component
- Backend (FastAPI auth routers/services): 7 rischi
- Database (Supabase queries/schema): 3 rischi
- Tests/Fixtures: 2 rischi

## Detailed Risk Register

| Risk ID   | Category   | Title                                                       | Prob. | Impact | Score | Mitigation Summary |
|-----------|------------|-------------------------------------------------------------|-------|--------|-------|--------------------|
| SEC-001   | Security   | 500 instead of 401 in /auth/refresh-token                   | High  | High   | 9     | Handle 0 rows → 401; revoked checks |
| SEC-002   | Security   | Admin `created_by_id` non UUID valido                       | High  | High   | 9     | UUID valido + admin user in DB |
| TECH-001  | Technical  | Mancata validazione `student_tokens.is_active`              | Medium| High   | 6     | Join e check stato → 401 |
| DATA-001  | Data       | Inconsistenze relazione refresh_tokens → student_tokens     | Medium| Medium | 4     | Vincoli test e cleanup deterministico |
| PERF-001  | Performance| Query refresh token senza indice su `token`                 | Low   | Medium | 2     | Verificare indice/ottimizzazione |
| OPS-001   | Operational| Logging insufficiente errori auth                           | Medium| Medium | 4     | Log strutturati senza PII |
| BUS-001   | Business   | Client dipendono dal 500; breaking behavior                 | Medium| Medium | 4     | Comunicare change; mantenere error schema |
| TECH-002  | Technical  | Eccezioni generiche convertite in 500                       | Medium| Medium | 4     | Catch mirati + HTTPException |
| DATA-002  | Data       | Fixture admin non pulisce entità derivate                   | Low   | Medium | 2     | Cleanup child → parent |
| OPS-002   | Operational| Mancanza di test contract per codici HTTP                   | Medium| Medium | 4     | Aggiungere test negativi e contract |
| PERF-002  | Performance| Overhead join su `student_tokens`                           | Low   | Low    | 1     | Valutare impatto; cache se necessario |
| BUS-002   | Business   | Pass rate <90% se non fixati 8 test in scope                | High  | Medium | 6     | Implementare fix fase 1-2 |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- 6 test refresh token: invalid, revoked, parent revoked → aspettarsi 401.  
- 2 test admin token creation: 201 con UUID valido.  
- Contract test: schema error body uniforme.

### Priority 2: High Risk Tests
- Unit test per handler errori (0 rows, revoked).  
- Integration test per join `student_tokens.is_active`.

### Priority 3: Medium/Low Risk Tests
- Test logging e osservabilità (assenza PII).  
- Benchmark semplice p95 per endpoint auth.  
- Test cleanup fixture admin.

## Risk Acceptance Criteria

### Must Fix Before Production
- Tutti i rischi con score 9 (SEC-001, SEC-002, TECH-001).

### Can Deploy With Mitigation
- Score 6 (BUS-002) con piano test completo e comunicazione.  
- Score 4 con monitoring e rollback.

### Accepted Risks
- Score ≤3 con monitoraggio post-deploy.

## Monitoring Requirements
- Alert 401 rate su `/auth/refresh-token`.  
- Error rate 5xx su router auth.  
- Log pattern per cause 401 (invalid/revoked/parent_revoked).  
- KPI pass rate suite test in CI.

## Risk Review Triggers
- Cambi significativi ad `auth.py` o a schema `student_tokens/refresh_tokens`.  
- Introduzione nuove policy di revoca.  
- Variazioni client che dipendono da specifici codici HTTP.

---

# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 3
    high: 2
    medium: 5
    low: 2
  highest:
    id: SEC-001
    score: 9
    title: '500 instead of 401 in /auth/refresh-token'
  recommendations:
    must_fix:
      - 'Gestione 0 rows → 401; revoked checks; UUID valido admin'
    monitor:
      - 'Alert 401/5xx rates su auth; contract tests codici HTTP'

Risk profile: qa.qaLocation/assessments/5.4.3-risk-profile-20251009.md