# Test Design: Story 3.1

Date: 2025-09-24 [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L129]
Designer: Quinn (Test Architect) [Fonte: `.cursor/rules/bmad/qa.mdc` L38–L41]

## Test Strategy Overview

- Total test scenarios: 9 [Fonte: questo documento]
- Unit tests: 2 [Fonte: questo documento]
- Integration tests: 6 [Fonte: questo documento]
- E2E tests: 1 [Fonte: questo documento]
- Priority distribution: P0: 1, P1: 6, P2: 2 [Fonte: questo documento]

## Test Scenarios by Acceptance Criteria

### AC1: Endpoint `/api/v1/chat/query` protetto [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L15]

| ID            | Level       | Priority | Test                                                                       | Justification                                                                                           |
| ------------- | ----------- | -------- | -------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| 3.1-INT-001   | Integration | P1       | Richiesta senza JWT → 401 Unauthorized                                     | Endpoint dichiarato protetto [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L42–L49]
| 3.1-INT-002   | Integration | P1       | Richiesta con JWT valido → 200 e payload conforme                          | Sicurezza JWT Bearer [Fonte: `docs/architecture/sezione-5-specifica-api-sintesi.md` L7–L15]

### AC2: La domanda viene convertita in embedding [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L16]

| ID            | Level | Priority | Test                                                                                   | Justification                                                                                                         |
| ------------- | ----- | -------- | -------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- |
| 3.1-UNIT-001  | Unit  | P2       | Inizializzazione di `OpenAIEmbeddings(model="text-embedding-3-small")` viene eseguita | Requisito di provider embeddings e modello indicato [Fonte: `docs/architecture/addendum-pgvector-langchain-supabase.md` L126–L138]
| 3.1-UNIT-002  | Unit  | P2       | L'embedding prodotto è di dimensione 1536 (mock)                                       | Dimensione del modello esplicita [Fonte: `docs/architecture/addendum-pgvector-langchain-supabase.md` L135–L137]

### AC3: Esegue query di similarità su Supabase [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L17]

| ID            | Level       | Priority | Test                                                                                                     | Justification                                                                                                                 |
| ------------- | ----------- | -------- | -------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| 3.1-INT-003   | Integration | P1       | Chiamata a `similarity_search_with_relevance_scores(question, k, score_threshold)` su `SupabaseVectorStore` | Integrazione con vector store dichiarata [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L68–L76]
| 3.1-INT-004   | Integration | P1       | Default applicati: `k=8`, `score_threshold=0.75` se non specificati                                      | Valori di default presenti nell'esempio endpoint [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L65–L66]

### AC4: Restituisce i top N chunk [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L18]

| ID            | Level       | Priority | Test                                                                                           | Justification                                                                                                              |
| ------------- | ----------- | -------- | ---------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------- |
| 3.1-INT-005   | Integration | P1       | Risposta contiene `chunks` con campi `id`, `document_id`, `content`, `similarity` (float)      | Schema risposta esemplificato nel documento Story [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L46–L48, L76–L81]
| 3.1-INT-006   | Integration | P1       | Numero di risultati restituiti ≤ `match_count` richiesto                                       | Top N richiesto dagli AC [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L18, L46]

## Cross-Cutting Scenarios

### Rate Limiting e Sicurezza

| ID            | Level       | Priority | Test                                                  | Justification                                                                                                 |
| ------------- | ----------- | -------- | ----------------------------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| 3.1-INT-007   | Integration | P1       | Superamento soglia RL → 429 (se RL abilitato)         | Indicazione di rate limiting sull'endpoint di ricerca nel documento Story [Fonte: `docs/stories/3.1.semantic-search-endpoint.md` L92–L95]

### Performance Target

| ID            | Level | Priority | Test                                                                | Justification                                                                                                    |
| ------------- | ----- | -------- | ------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| 3.1-E2E-001   | E2E   | P0       | p95 latenza della query semantica < 500ms (dataset campione)        | Target PRD esplicito per ricerca semantica [Fonte: `docs/stories/2.4.vector-indexing-in-supabase.md` L49–L51]

## Risk Coverage

- Nessun rischio da coprire (nessun rischio registrato) [Fonte: `docs/qa/assessments/3.1-risk-20250924.md` L8, L21–L27]

## Recommended Execution Order

1. P0 E2E tests: 3.1-E2E-001 [Fonte: questo documento]
2. P1 Integration tests: 3.1-INT-001, 3.1-INT-002, 3.1-INT-003, 3.1-INT-004, 3.1-INT-005, 3.1-INT-006, 3.1-INT-007 [Fonte: questo documento]
3. P2 Unit tests: 3.1-UNIT-001, 3.1-UNIT-002 [Fonte: questo documento]

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 9
  by_level:
    unit: 2
    integration: 6
    e2e: 1
  by_priority:
    p0: 1
    p1: 6
    p2: 2
  coverage_gaps: []
```

## Trace References

Test design matrix: qa.qaLocation/assessments/3.1-test-design-20250924.md

## Sources

- `docs/stories/3.1.semantic-search-endpoint.md` (AC, API, esempio endpoint)
- `docs/architecture/addendum-pgvector-langchain-supabase.md` (embedding 1536, vector store)
- `docs/architecture/sezione-5-specifica-api-sintesi.md` (sicurezza JWT)
- `docs/architecture/sezione-11-strategia-di-testing.md` (strategie, mocking, coverage)
- `docs/stories/2.4.vector-indexing-in-supabase.md` (target p95 < 500ms)
- `.cursor/rules/bmad/qa.mdc` (identità QA)
