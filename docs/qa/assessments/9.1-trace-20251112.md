# Requirements Traceability Matrix

## Story: 9.1 - Hybrid Memory Foundation

Source: docs/stories/9.1-hybrid-memory-foundation.md
Date: 2025-11-12
Reviewer: Quinn (QA)

### Coverage Summary

- Total Requirements: 9
- Fully Covered: 5 (55.6%)
- Partially Covered: 4 (44.4%)
- Not Covered: 0 (0%)

Planning reference: docs/qa/assessments/9.1-test-design-20251106.md

---

### Requirement Mappings

#### AC1: Architettura Hybrid Memory con due livelli (L1 cache ultimi 3 turni <2000 token; L2 DB persistenza)

Coverage: FULL

- Unit Test: `apps/api/tests/services/test_conversation_manager.py::test_l1_cache_keeps_last_three_turns`
  - Given: Sessione attiva con più di 3 turni
  - When: Si aggiunge un nuovo turno
  - Then: La finestra di contesto contiene solo gli ultimi 3 turni (<2000 token)

- Integration Test: `apps/api/tests/integration/test_hybrid_conversation_manager.py::test_dual_write_cache_and_db`
  - Given: HybridConversationManager con persistence abilitata
  - When: Si aggiunge un turno
  - Then: Dati presenti sia in cache (immediato) che in DB (async)

#### AC2: Persistenza asincrona senza impattare latenza, backpressure (max 100) e circuit breaker (3 fail/p95>1s → open 30s)

Coverage: FULL

- Unit Test: `apps/api/tests/services/test_hybrid_manager_backpressure.py::test_backpressure_drops_oldest_and_metrics`
  - Given: Coda piena con 100 write tasks
  - When: Nuovo turno enqueued
  - Then: Il task più vecchio viene droppato, metrica `backpressure_activated` incrementata

- Unit Test: `apps/api/tests/services/test_circuit_breaker.py::test_breaker_opens_after_three_failures`
  - Given: 3 fallimenti consecutivi/timeout
  - When: Nuova richiesta di persistenza
  - Then: Breaker in stato OPEN per 30s; metriche aggiornate

- Integration Test: `apps/api/tests/integration/test_async_persist_latency.py::test_async_persist_timeout_and_latency_histogram`
  - Given: DB lento simulato
  - When: Persistenza async oltre 5s
  - Then: Timeout registrato, `db_writes_timeout` incrementa, histogram popolato

#### AC3: Feature flag `ENABLE_PERSISTENT_MEMORY` con graceful degradation

Coverage: FULL

- Unit Test: `apps/api/tests/services/test_feature_flag.py::test_disable_persistence_falls_back_to_memory_only`
  - Given: Flag disabilitato
  - When: Si aggiungono turni
  - Then: Nessuna chiamata al persistence service; sistema opera in-memory senza errori

- Integration Test: `apps/api/tests/integration/test_flag_degradation.py::test_graceful_degradation_db_down`
  - Given: DB non disponibile e flag abilitato
  - When: Si aggiungono turni
  - Then: Nessun errore lato utente; messaggi serviti da cache; breaker/outbox attivi

#### AC4: Indici Postgres ottimizzati (session_created, created_at, content_fts GIN, metadata_archived partial, unique idempotency key)

Coverage: PARTIAL

- Migration Test: `supabase/tests/test_migration_indices.sql` (psql automation)
  - Given: Schema aggiornato con migrazione epic9
  - When: `\di` e `EXPLAIN` su query tipiche
  - Then: Indici presenti e utilizzati

- Integration Test: `apps/api/tests/integration/test_db_indices_usage.py::test_session_history_uses_composite_index`
  - Given: Query storia sessione
  - When: EXPLAIN ANALYZE
  - Then: Utilizzo indice `idx_chat_messages_session_created`

Gap: Verifica FTS italiano e indice partial archived in ambiente CI.

#### AC5: Backward compatibility completa con Story 7.1 (short-term memory in-memory)

Coverage: FULL

- Regression Test: `apps/api/tests/services/test_conversation_manager.py::test_legacy_behavior_unchanged`
  - Given: ConversationManager originale
  - When: Aggiunta turni e richiesta context window
  - Then: Comportamento invariato rispetto a 7.1

#### AC6: Degradazione graceful a in-memory only se DB non disponibile (zero downtime)

Coverage: FULL

- Integration Test: `apps/api/tests/integration/test_db_outage_graceful.py::test_operates_memory_only_on_db_outage`
  - Given: DB down
  - When: Nuove interazioni
  - Then: Latenza chat stabile; nessun errore restituito; breaker=OPEN

#### AC7: Metriche implementate e tracciate (writes ok/fail/timeout, latency histogram, cache hit/miss, sessions, backpressure, breaker, outbox, retry, DLQ)

Coverage: PARTIAL

- Unit Test: `apps/api/tests/utils/test_metrics.py::test_counters_histograms_gauges_basic`
  - Given: Collector in-memory
  - When: increment/histogram/gauge
  - Then: Valori aggiornati e bounded storage

- Integration Test: `apps/api/tests/integration/test_metrics_wiring.py::test_metrics_emitted_on_async_persist`
  - Given: Persistenza async
  - When: Successo, errore, timeout
  - Then: Counter e histogram aggiornati correttamente

Gap: Cache hit/miss wiring e outbox gauges nei percorsi reali.

#### AC8: Coverage test minimo 80% per nuovi moduli

Coverage: PARTIAL

- Coverage Report: `reports/coverage/9.1/index.html`
  - Given: Suite eseguita
  - When: Misurazione coverage
  - Then: Target 80% per moduli 9.1

Gap: Conferma soglia raggiunta in CI una volta implementati tutti i test.

#### AC9: Durable outbox pattern (disk queue .data/persistence_outbox.jsonl, retry backoff 1s→60s, idempotency key sha256, DLQ >10 retry)

Coverage: PARTIAL

- Unit Test: `apps/api/tests/services/test_outbox.py::test_retry_with_exponential_backoff_and_idempotency`
  - Given: Messaggi in outbox con DB down
  - When: Retry progressivi fino a successo o DLQ
  - Then: Backoff rispettato, nessun duplicato (ON CONFLICT/idempotency), DLQ dopo >10

- Integration Test: `apps/api/tests/integration/test_outbox_end_to_end.py::test_outbox_persists_and_drains_on_recovery`
  - Given: DB non disponibile poi ripristinato
  - When: Accodamento su file e successivo drain
  - Then: Tutti i messaggi salvati, `outbox_queue_depth` e `retry_attempts_total` coerenti

Gap: Governance DLQ e alerting operativi.

---

### Critical Gaps

1. Indici e FTS (AC4)
   - Gap: Mancano verifiche automatiche EXPLAIN per FTS e indice partial archived in CI
   - Severity: Medium
   - Suggested Test: Integrazione con EXPLAIN su query FTS e filtro archived

2. Metriche cache/outbox (AC7)
   - Gap: Collegamento metriche `cache_hits/misses` e `outbox_queue_depth` nei percorsi reali
   - Severity: Medium
   - Suggested Test: Integrazione su HybridConversationManager per emettere tali metriche

3. Coverage soglia (AC8)
   - Gap: Necessaria conferma report >=80% post implementazione completa
   - Severity: Medium
   - Suggested Test: Gate CI su coverage minima per cartelle dei nuovi moduli

4. DLQ governance (AC9)
   - Gap: Mancano test/processo di drain periodico e alerting
   - Severity: Low
   - Suggested Test: Job programmato che drena DLQ e verifica esito

---

### Test Design Recommendations

1. Aggiungere fixture per simulare DB lento/failure e validare breaker/backpressure con metriche.
2. Integrare test EXPLAIN ANALYZE per query principali e FTS italiano.
3. Stabilire soglia di coverage per directory `services/` e `utils/` in CI.
4. Aggiungere test wiring per metriche cache hit/miss e outbox depth.

### Risk Assessment

- High Risk: Nessuno (tutti i requisiti hanno almeno copertura parziale pianificata/testata)
- Medium Risk: AC4, AC7, AC8, AC9 finché i gap non sono colmati
- Low Risk: AC1, AC2, AC3, AC5, AC6 con test multipli pianificati

---

### Gate YAML (paste under trace)

```
trace:
  totals:
    requirements: 9
    full: 5
    partial: 4
    none: 0
  planning_ref: 'docs/qa/assessments/9.1-test-design-20251106.md'
  uncovered: []
  notes: 'See docs/qa/assessments/9.1-trace-20251112.md'
```

Trace matrix: docs/qa/assessments/9.1-trace-20251112.md

