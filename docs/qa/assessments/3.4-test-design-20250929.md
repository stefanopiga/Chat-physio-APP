# Test Design â€” Story 3.4: Source Visualization & Feedback

## Riferimenti
- Fonte primaria: `docs/stories/3.4.source-visualization-and-feedback.md`
- Gating: `docs/qa/assessments/3.4-po-validate-20250929.md` (NO-GO, must-fix backend)

## Gating / Prerequisiti (Bloccanti)
- Endpoint feedback `POST /api/v1/chat/messages/{messageId}/feedback` implementato. [Fonte: `3.4-po-validate-20250929.md`]
- Output AG arricchito con citazioni: `document_id`, `position` (o offset), `excerpt`. [Fonti: `3.4-po-validate-20250929.md`; `docs/stories/3.2.augmented-generation-endpoint.md`]

## Obiettivi di Test
- Verificare interattivitÃ  citazioni (click/hover). [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md` "Acceptance Criteria"]
- Verificare popover con estratto e metadati minimi. [Fonte: medesima]
- Verificare presenza e comportamento dei pulsanti di feedback ğŸ‘/ğŸ‘. [Fonte: medesima]
- Verificare invio feedback al backend con `{ sessionId, message_id, vote }`. [Fonte: medesima]
- Verificare accessibilitÃ  su trigger citazioni/feedback (ruoli, aria-*, tastiera). [Fonti: `docs/stories/3.4.source-visualization-and-feedback.md` "AccessibilitÃ "; `docs/front-end-spec.md` Sez. 7]
- Verificare persistenza UI del voto selezionato. [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md`]

## Endpoints/Componenti rilevanti
- Componenti: `CitationBadge`, `CitationPopover`, `FeedbackControls`, `ChatMessageItem`. [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md` "UI/Componenti"]
- Endpoint feedback: `POST /api/v1/chat/messages/{messageId}/feedback`. [Fonte: `3.4-po-validate-20250929.md`]

## Strategia di Testing
- Integrazione UI: mock `apiClient` per verificare click â†’ popover, invio feedback, stato pending/selected. [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md`]
- E2E (post-gating): verifica end-to-end citazioni+popover+feedback. [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md` "Test E2E (linee guida)"]

## Casi di Test

### AC1 â€” Citazioni interattive
- TC-001 â€” Render citazioni come `<button>` con `aria-expanded=false`. [Fonti: `docs/front-end-spec.md` Sez. 7; `docs/stories/3.4.source-visualization-and-feedback.md`]
- TC-002 â€” Click citazione â†’ popover visibile, `aria-expanded=true`. [Fonte: medesima]
- TC-003 â€” Hover (se previsto) â†’ popover visibile. [Fonte: medesima]

### AC2 â€” Popover con estratto e metadati
- TC-010 â€” Popover contiene `excerpt`, `document_id`, `position`. [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md`]
- TC-011 â€” Chiusura con `Esc` e click outside; focus ritorna al trigger. [Fonte: medesima]

### AC3 â€” Pulsanti di feedback
- TC-020 â€” Visualizzazione bottoni ğŸ‘/ğŸ‘ accanto alla risposta. [Fonte: medesima]
- TC-021 â€” Click su ğŸ‘ invia `{ sessionId, message_id, vote: 'up' }`, UI pending/selected. [Fonte: medesima]
- TC-022 â€” Click su ğŸ‘ invia `{ vote: 'down' }`, UI pending/selected. [Fonte: medesima]

### AC4 â€” AccessibilitÃ 
- TC-030 â€” Navigazione tastiera: `Tab` raggiunge badge citazioni e controlli feedback. [Fonte: `docs/front-end-spec.md` Sez. 7]
- TC-031 â€” `Enter`/`Space` aprono popover; `Esc` chiude. [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md`]

### AC5 â€” Persistenza UI del Voto
- TC-040 â€” Dopo risposta OK, stato selezionato persiste per quel messaggio. [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md`]

## E2E (Prerequisiti e Best Practices)
- Impostare credenziali fittizie prima del `goto` per rotte protette (`AuthGuard`). [Fonte: `docs/stories/3.3.frontend-chat-integration.md` "Testing"]
- Attendere sblocco `AuthGuard` prima di interagire. [Fonte: medesima]
- Usare selettori resilienti e attese esplicite. [Fonte: `docs/qa/review-qa-report-20250926.md` L46â€“L50]

## Backend Test Design

### Endpoint: POST /api/v1/chat/messages/{messageId}/feedback
- Contratto (body): `{ sessionId: string, vote: 'up'|'down' }`. [Fonte: `docs/stories/3.4.source-visualization-and-feedback.md`]
- Esiti attesi:
  - 200 OK â€” body `{ ok: true }`.
  - 400/422 â€” validazioni: `sessionId` mancante/vuoto, `vote` non valido.
  - 401 â€” token assente/invalid.
  - 429 â€” rate limit superato.
  - 500 â€” errore generico back-end.
- Casi di test:
  - BT-001 â€” happy path `vote: 'up'` â†’ 200, persistenza lato server opzionale non verificata. [non disponibile nella fonte]
  - BT-002 â€” happy path `vote: 'down'` â†’ 200. [non disponibile nella fonte]
  - BT-010 â€” `sessionId` mancante â†’ 400/422.
  - BT-011 â€” `vote` non in `{'up','down'}` â†’ 400/422.
  - BT-020 â€” 401 senza bearer token.
  - BT-030 â€” 429 con throttling simulato.
  - BT-040 â€” 500 simulando eccezione interna.

### Endpoint: POST /api/v1/chat/sessions/{sessionId}/messages (AG arricchita)
- Requisito: risposta include citazioni arricchite per ogni riferimento: `document_id`, `position` (o offset), `excerpt` (estratto). [Fonti: `docs/stories/3.4.source-visualization-and-feedback.md`; `docs/qa/assessments/3.4-po-validate-20250929.md`]
- Casi di test:
  - BT-101 â€” citazioni presenti e complete (tutte le chiavi richieste).
  - BT-102 â€” citazioni presenti ma senza `excerpt` â†’ comportamento definito (errore 400 o fallback). [non disponibile nella fonte]
  - BT-103 â€” nessuna citazione in input â†’ 400 se richieste dallâ€™AG; altrimenti output coerente. [non disponibile nella fonte]
  - BT-104 â€” validazione tipi/shape dellâ€™array citazioni.

## Metriche
- non disponibile nella fonte
