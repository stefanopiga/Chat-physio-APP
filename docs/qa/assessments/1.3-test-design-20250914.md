# Test Design — Story 1.3: Student Access Code System (2025-09-14)

## Overview
- Objective: Validate Story 1.3 against Acceptance Criteria (AC1–AC7) via unit, integration, and E2E tests.
- Scope: Backend FastAPI endpoints, JWT claims, and Frontend AccessCode UX.
- Out of scope: Rate limiting and structured logging (tracked as QA monitor items).

## Assumptions
- SUPABASE_JWT_SECRET available for signing/verification in tests.
- TEMP_JWT_EXPIRES_MINUTES defaults to 15 unless overridden.
- In-memory store `access_codes_store` suffices for integration tests.

## Coverage Summary
- Total scenarios: 14
- By level: unit=3, integration=8, e2e=3
- Priority split: P0=7, P1=5, P2=2

## Scenario List (Given-When-Then)

### Unit (3)
1) TD-U1 (P0) — JWT claims builder
- Given a valid access code exchange
- When a JWT is issued
- Then claims include iss=https://example.supabase.co/auth/v1, aud=authenticated, sub starts with student:, iat, exp within configured window

2) TD-U2 (P0) — Admin role enforcement
- Given a bearer token with role!=admin
- When calling POST /api/v1/admin/access-codes/generate
- Then a forbidden decision is produced (403) by the role guard

3) TD-U3 (P1) — Access code validator
- Given an empty or whitespace access_code
- When validating the payload
- Then a 400 invalid_request is produced

### Integration (8)
4) TD-I1 (P0) — Health endpoint
- Given the API is running
- When GET /health
- Then 200 and { status: "ok" }

5) TD-I2 (P0) — Exchange invalid_request
- Given an empty access_code
- When POST /api/v1/auth/exchange-code
- Then 400 invalid_request

6) TD-I3 (P0) — Exchange invalid_code
- Given a non-existent access_code
- When POST /api/v1/auth/exchange-code
- Then 401 invalid_code

7) TD-I4 (P0) — Exchange happy path + single-use policy
- Given an active, non-expired access_code in store
- When POST /api/v1/auth/exchange-code the first time
- Then 200 with { token, token_type=bearer, expires_in>0 }
- And when POST again with the same code
- Then 409 code_already_used

8) TD-I5 (P1) — Exchange expired code
- Given an access_code with expires_at in the past
- When POST /api/v1/auth/exchange-code
- Then 410 expired_code

9) TD-I6 (P0) — JWT claims verification
- Given a successful exchange
- When decoding the token with SUPABASE_JWT_SECRET and audience=authenticated
- Then iss/aud/sub/exp claims are as specified

10) TD-I7 (P0) — Admin generate requires auth
- Given no bearer token
- When POST /api/v1/admin/access-codes/generate
- Then 401 unauthorized

11) TD-I8 (P1) — Admin generate forbidden (non-admin) and success persistence
- Given a bearer token role=authenticated
- When POST /api/v1/admin/access-codes/generate
- Then 403 forbidden
- And given a bearer token role=admin
- When POST /api/v1/admin/access-codes/generate with expires_in_minutes
- Then 200 and store contains a record with id, code, is_active=true, usage_count=0, created_by_id, expires_at≈now+minutes

### E2E / FE Integration (3)
12) TD-E1 (P0) — Client-side validation
- Given the AccessCodePage is loaded
- When submitting with empty field
- Then submission is blocked and specific error appears under the field

13) TD-E2 (P0) — Valid code redirect
- Given the API responds ok with { token, token_type, expires_in }
- When user submits a valid code
- Then token is placed in sessionStorage and navigation occurs to /chat

14) TD-E3 (P1) — API error surfaced to user
- Given the API responds 401 invalid_code
- When user submits a code
- Then specific error text is shown below the field

## Data and Setup
- TestClient/HTTPX used with app instance; in-memory `access_codes_store` manipulated for deterministic setup.
- Environment: set SUPABASE_JWT_SECRET=devsecret for tests requiring decode.
- Clock: use datetime.now(timezone.utc) for claims; allow ±1s tolerance where needed.

## Mocks and Stubs
- Frontend: mock fetch responses for success and error cases.
- Router: mock useNavigate to capture redirects.

## Tooling
- Backend: Pytest + TestClient.
- Frontend: Vitest + React Testing Library.
- E2E: Playwright (planned/optional in this story; non-blocking).

## Traceability to Acceptance Criteria
- AC1: TD-I7, TD-I8 (+ TD-U2)
- AC2/AC3: TD-I2, TD-I3, TD-I4, TD-I5, TD-I6 (+ TD-U1, TD-U3)
- AC4/AC6/AC7: TD-E1
- AC5: TD-E2
- Error surfacing: TD-E3

## Notes
- Rate limiting and structured logs to be validated in subsequent hardening task; add scenarios once implemented.
