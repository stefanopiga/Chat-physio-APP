# Test Design: Story 4.2.4 – Persistenza Feedback Database

Date: 2025-10-30
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- By level: Unit 8 (33%), Integration 10 (42%), E2E 6 (25%)
- By priority: P0 10, P1 9, P2 5
- Focus: RLS/permessi, UPSERT/UNIQUE, performance p95 < 100ms, regressione analytics

References: Risk profile docs/qa/assessments/4.2.4-risk-20251030.md

## Test Scenarios by Acceptance Criteria

### AC1: Database Migration & Schema

#### Scenarios

| ID                 | Level       | Priority | Test                                                      | Justification                          |
| ------------------ | ----------- | -------- | --------------------------------------------------------- | -------------------------------------- |
| 4.2.4-UNIT-001     | Unit        | P1       | Verifica generazione SQL: colonne e vincoli previsti      | Validazione schema generato            |
| 4.2.4-INT-001      | Integration | P0       | Migrazione applicata: tabella feedback esiste             | Fondamentale per tutte le feature      |
| 4.2.4-INT-002      | Integration | P0       | UNIQUE(session_id,message_id) effettivo                   | Prevenzione duplicati (UPSERT)         |
| 4.2.4-INT-003      | Integration | P1       | Indici presenti: session_id, message_id, created_at, vote | Performance analytics                  |
| 4.2.4-INT-004      | Integration | P0       | RLS abilitata + policy SELECT solo admin                  | Copre SEC-001                          |

### AC2: Repository Pattern Backend

#### Scenarios

| ID                 | Level       | Priority | Test                                                                 | Justification                        |
| ------------------ | ----------- | -------- | -------------------------------------------------------------------- | ------------------------------------ |
| 4.2.4-UNIT-002     | Unit        | P0       | Validation input repo: vote in {'up','down'}                         | Prevenzione errori/SEC-002           |
| 4.2.4-UNIT-003     | Unit        | P1       | Mascheramento IP utility (es. 192.168.x.x)                           | Privacy SEC-003                      |
| 4.2.4-INT-005      | Integration | P0       | create_feedback salva record completo                                | Funzionalità base                    |
| 4.2.4-INT-006      | Integration | P0       | UPSERT: doppio create su stesso (session,message) non duplica        | Integrità dati DATA-001              |
| 4.2.4-INT-007      | Integration | P1       | get_feedback_summary aggrega correttamente thumbs_up/down/total      | Analytics base                       |
| 4.2.4-INT-008      | Integration | P1       | get_feedback_by_timerange filtra su created_at                       | Bug naming timestamp vs created_at   |
| 4.2.4-INT-009      | Integration | P0       | Concorrenza: 100 richieste stesso (session,message) → 1 record       | Race UPSERT TECH-001                 |

### AC3: Endpoint Feedback Modificato

#### Scenarios

| ID                 | Level       | Priority | Test                                                             | Justification                      |
| ------------------ | ----------- | -------- | ---------------------------------------------------------------- | ---------------------------------- |
| 4.2.4-E2E-001      | E2E         | P0       | POST /messages/{id}/feedback → 200 {"ok":true}                   | Backward compatibility              |
| 4.2.4-E2E-002      | E2E         | P0       | POST latenza p95 < 100ms su 100 richieste                         | Perf AC3                            |
| 4.2.4-INT-010      | Integration | P0       | POST persiste su DB (select by message_id)                        | Persistenza                         |
| 4.2.4-INT-011      | Integration | P1       | Doppio POST stesso id → 1 record                                  | UPSERT                              |
| 4.2.4-UNIT-004     | Unit        | P1       | Logging: "feedback_persisted_db" emesso                           | Osservabilità                        |

### AC4: Analytics Endpoint Aggiornato

#### Scenarios

| ID                 | Level       | Priority | Test                                                                    | Justification                     |
| ------------------ | ----------- | -------- | ----------------------------------------------------------------------- | --------------------------------- |
| 4.2.4-INT-012      | Integration | P0       | /admin/analytics legge da repo (DB), non da feedback_store              | Regressione evitata               |
| 4.2.4-INT-013      | Integration | P1       | Time filter su intervalli storici                                       | Corretta semantica created_at     |
| 4.2.4-E2E-003      | E2E         | P1       | Dashboard mostra dati corretti dopo restart                             | Persistenza cross‑restart         |
| 4.2.4-E2E-004      | E2E         | P1       | Nessuna modifica richiesta al frontend (nessuna rottura interfaccia)    | Backward compatibility            |

### AC5: Deprecazione In‑Memory Store

#### Scenarios

| ID                 | Level       | Priority | Test                                               | Justification                 |
| ------------------ | ----------- | -------- | -------------------------------------------------- | ----------------------------- |
| 4.2.4-UNIT-005     | Unit        | P2       | Verifica commento di deprecazione in stores.py     | Documentazione                |
| 4.2.4-INT-014      | Integration | P1       | Nessun riferimento attivo a feedback_store         | Pulizia tecnica TECH-002      |

### AC6: Test Coverage

#### Scenarios

| ID                 | Level       | Priority | Test                                                       | Justification                |
| ------------------ | ----------- | -------- | ---------------------------------------------------------- | ---------------------------- |
| 4.2.4-UNIT-006     | Unit        | P2       | Copertura unit > 85% su nuovo codice repo                  | Soglia qualità               |
| 4.2.4-INT-015      | Integration | P2       | Copertura integrazione test endpoints/repo sufficiente      | Soglia qualità               |

### AC7: No Regression - Backward Compatibility

#### Scenarios

| ID                 | Level       | Priority | Test                                                        | Justification                     |
| ------------------ | ----------- | -------- | ----------------------------------------------------------- | --------------------------------- |
| 4.2.4-E2E-005      | E2E         | P0       | Esecuzione completa suite 4.2.2 (analytics) senza regressioni| Protezione funzionalità critiche  |
| 4.2.4-E2E-006      | E2E         | P0       | Esecuzione completa suite 4.2.3 (bug aggregation) ok        | Evitare regressione recente       |

## Risk Coverage

- SEC-001: Coperto da 4.2.4-INT-004, E2E admin/anon tests
- DATA-001: Coperto da 4.2.4-INT-006, 4.2.4-INT-009, 4.2.4-INT-011
- PERF-001: Coperto da 4.2.4-E2E-002; monitoraggio p95
- SEC-002: Coperto da 4.2.4-UNIT-002 (validazione/sanitizzazione)
- DATA-002: Coperto da 4.2.4-INT-008, 4.2.4-INT-013
- PERF-002: Coperto da 4.2.4-INT-003 + EXPLAIN
- TECH-001: Coperto da 4.2.4-INT-009 (concorrenza)
- TECH-002: Coperto da 4.2.4-INT-014 (nessun residuo)

## Recommended Execution Order

1. P0 Unit (4.2.4-UNIT-002) → fail‑fast su input/sicurezza
2. P0 Integration (INT‑001/002/004/005/006/010) → fondamenta DB+repo
3. P0 E2E (E2E‑001/002/005/006) → journey e performance
4. P1 Integration/E2E rimanenti → analytics/time filter/backward compat
5. P2 scenari documentazione/copertura

## Notes for Implementation

- Mock Supabase per unit; DB test per integration
- Usa pytest‑asyncio per metodi async del repository
- Integra timer per misurare p95 in test performance
- Esegui EXPLAIN/ANALYZE una volta per validare indici in env test

## Quality Checklist

- [x] Ogni AC ha copertura test
- [x] Livelli appropriati e non ridondanti
- [x] Priorità allineate ai rischi
- [x] Convenzione ID rispettata
- [x] Scenari atomici e indipendenti

