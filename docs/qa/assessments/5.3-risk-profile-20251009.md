# Risk Profile – Story 5.3: Test Suite Modernization & Legacy Test Migration

Data: 2025-10-09  
Owner: QA/Architecture  
Fonte: `docs/stories/5.3-test-suite-modernization.md`, `docs/qa/gates/story-5.2-gate.yaml`, `docs/qa/assessments/5.2-nfr-20251009.md`

---

## 1. Executive Summary

- Obiettivo: Migrare 138 test legacy a fixture moderne per raggiungere ≥80% pass rate e confermare backward compatibility Story 5.2.
- Stato attuale: Pass rate suite completa 25.9% (53/204); modulari 51.5%, legacy 13.8%; coverage 62%.
- Rischio complessivo: Medio (processo di migrazione lineare; pattern consolidati; impatto controllabile).
- Bloccante: Merge finale Story 5.2 dipende dal completamento 5.3.

---

## 2. Risk Register

| ID | Rischio | Causa | Prob. | Impatto | Severità | Mitigazione | Trigger | Owner |
|----|---------|-------|-------|---------|----------|-------------|---------|-------|
| R-5.3-1 | Regressioni durante migrazione test | Refactor pattern test, differenze tra legacy e moderni | Media | Alto | Alta | Esecuzione suite incrementale per file; rollback immediato; code review mirata | Calo pass rate dopo commit | QA/Dev |
| R-5.3-2 | Fixture moderne non coprono edge cases legacy | Varianti test legacy non previste | Bassa | Medio | Medio | Estendere fixture `conftest.py`; documentare nuovi parametri | Test flaky o edge non coperti | Dev |
| R-5.3-3 | RL pollution persiste | Cleanup incompleto store RL in test specifici | Media | Medio | Medio | Verifica `_store.clear()` prima/dopo; scoping per-test; test isolati | 429 inattesi su test admin/debug | Dev |
| R-5.3-4 | FK constraint ricompare | Fixture duplicate o non consolidate | Bassa | Alto | Medio-Alta | Unica fixture `student_token_in_db` in `conftest.py`; rimozione duplicati | APIError 23503 su `student_tokens_created_by_id_fkey` | Dev |
| R-5.3-5 | Import obsoleti residui | Test non aggiornati ai nuovi path | Media | Basso | Bassa | Grep sistematico e autofix; lint rule temporanea | AttributeError su import | Dev |
| R-5.3-6 | Path `/classify` 404 post-split router | Mancato aggiornamento registrazione router | Bassa | Medio | Bassa | Split `router_classify` + include in `main.py`; test mirati | 404 su `/classify` | Dev |
| R-5.3-7 | Coverage <65% | Test legacy con bassa copertura | Media | Medio | Medio | Priorità ai file a bassa copertura; aggiunta test mirati | Report coverage <65% | QA |
| R-5.3-8 | Tempo insufficiente (6-8h) | Frammentazione casi legacy | Media | Medio | Medio | Priorità quick wins (Admin/Analytics/Documents); timeboxing per file | Slittamento milestone | PM |
| R-5.3-9 | Flaky per dipendenze esterne | Supabase/LLM in tests | Bassa | Medio | Bassa | Mock coerente; skip `@integration` se env assente | Failures intermittenti | QA |

Legenda Severità: Bassa, Medio, Alto, Alta.

---

## 3. Controlli Preventivi (Proactive Controls)

- Pattern standard fixture: `client_admin/client_student/client_no_auth` obbligatori nei test endpoint.
- RL isolation: `rate_limit_service._store.clear()` in setup/teardown fixture, scoping per-test.
- FK safety: unica fixture `student_token_in_db` in `conftest.py`; rimozione duplicati da file test.
- Import governance: grep su `from api.main import` (escluso `app`), sostituzione con `api.dependencies`/`api.schemas`/`api.services`.
- Router governance: split `/classify` fuori prefix; smoke test mirati `-k classify`.
- Pipeline incrementale: migrazione per file con run `pytest tests/test_<file>.py -v` e checkpoint.

---

## 4. Piani di Contingenza (Fallback Plans)

- Regressione per-file: revert immediato del singolo file test (`git checkout HEAD -- tests/test_<file>.py`) e rianalisi.
- RL pollution persistente: introdurre store dedicato per test (`RateLimitService(store={})`) via DI temporanea nei test critici.
- FK persistenti: switch temporaneo a mock DB layer per test specifici (solo unit), mantenendo integrazione su subset.
- `/classify` 404: ripristino temporaneo handler legacy in `main.py` (deprecato) finché split non è validato.

---

## 5. Go/No-Go Criteria

- GO se:
  - Pass rate suite completa ≥80% (164+/204)
  - Coverage ≥65%
  - 0 FK errors, 0 RL pollution failures
  - Nessun import obsoleto residuo in `apps/api/tests/test_*.py`

- NO-GO se:
  - Pass rate <80% o coverage <65%
  - Presenza di 404 su `/classify`
  - Persistono 401 imprevisti su documents/admin con fixture moderne

---

## 6. Monitoraggio e Metriche

- KPI giornalieri:
  - Pass rate totale, modulari vs legacy
  - Failures per categoria (RL, Auth, FK, Path, Import)
  - Coverage totale e per modulo core
- Report:
  - Aggiornare `docs/qa/gates/story-5.2-gate.yaml` (sezione test_metrics) a fine fase
  - Aggiornare `docs/qa/assessments/5.2-nfr-20251009.md` (decisione → PASS) a completamento 5.3

---

## 7. Azioni ImmediatE (Next 6-8h)

1. Migrare `test_admin_debug.py` → elimina 15+ RL failures.
2. Migrare `test_analytics.py` (endpoints) → elimina 2 RL failures.
3. Migrare `test_document_explorer.py` → elimina 6 auth failures.
4. Fix `/classify` router split e migrare `test_classify.py`.
5. Rimuovere fixture duplicate in `routers/test_auth.py` e usare `conftest.py`.
6. Full suite + coverage report; aggiornare gate e NFR.

---

## 8. Rischi Residui Post-Implementazione

- Flaky sporadici su integrazione se env Supabase non stabile → mitigare con skip `@integration` e mock consistenti.
- Performance test sensibili al carico locale: marcare `@slow` e isolare dall’esecuzione standard.

---

## 9. Approvals

- QA Lead: PENDING  
- Tech Lead: PENDING  
- Product: PENDING
