### Validazione Storia — Story 5.4.1: Suite-wide Test Fixes & Pattern Propagation

- **ID**: 5.4.1 (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Tipo**: Technical Debt / Testing / Bugfix (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Epic**: Epic 5 — DevOps & Maintainability (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Priorità**: P1 - High (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Complessità**: High (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Stato**: DRAFT (2025-10-09) (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Baseline e Target
- Baseline post 5.4: 143 PASSED, 33 FAILED, 15 ERRORS, 14 SKIPPED; Pass Rate 73.7%; Duration 471.64s; Coverage 93% (fonte)
- Target desiderato: Pass Rate >90% (180+/194), Failed <10, Errors 0, Coverage ≥93%, Duration <500s, CI/CD green (fonte)

### Criteri di Accettazione (AC) da validare
- **AC1: FK Violations Eliminated** — nessun `postgrest.exceptions.APIError` per FK su test auth e student_tokens (fonte)
- **AC2: API Schema Compliance Suite-wide** — `/documents/{id}/chunks` include `document_id`, `chunks`, `total_chunks`; `/knowledge-base/search` include `similarity_score` nei results (fonte)
- **AC3: Import Path Modernization Complete** — nessun ImportError/AttributeError su `api.main`; import spostati su `api.dependencies` (fonte)
- **AC4: Service Tests Functional** — rate limit tests con skip/override coerenti; JWT tests con `aud` e `timedelta` corretti (fonte)
- **AC5: Integration Tests Green** — `test_sync_job_integration.py` senza 401; status code attesi (fonte)

### Criteri Non Funzionali (NFR) da validare
- **NFR1: Performance** — Suite <500s; nessun timeout (fonte)
- **NFR2: Test Isolation** — zero FK violations; nessuna contaminazione stato condiviso; cleanup garantito (fonte)
- **NFR3: Coverage** — ≥93% mantenuta (fonte)

### Evidenze richieste e comandi di validazione
- AC1: `poetry run pytest tests/routers/test_auth.py -v` e test student_tokens; assenza APIError FK (fonte)
- AC2: `poetry run pytest tests/routers/test_documents.py tests/test_document_explorer.py -v`; nessun `KeyError: 'total_chunks'` (fonte)
- AC3: `poetry run pytest tests/test_indexing_admin.py tests/test_indexing_unit.py -v`; nessun `AttributeError` import (fonte)
- AC4: `poetry run pytest tests/services/ -v`; rate limit coerente con `TESTING=true`/`RATE_LIMITING_ENABLED=false`; JWT con validator applicato (fonte)
- AC5: `poetry run pytest tests/test_sync_job_integration.py -v`; nessun 401 (fonte)
- Full suite finale: `poetry run pytest tests/ -v --tb=short --cov=api`; verifica pass rate >90%, Errors 0, Coverage ≥93%, Duration <500s (fonte)

### Rischi bloccanti per la validazione
- **R1: FK Cascade Deletion Complexity** — mitigazione: ordine cleanup esplicito, try-except; detection: test FK in CI (fonte)
- **R2: Schema Breaking Changes Propagation** — mitigazione: audit script endpoint; detection: integrazione con real API calls (fonte)
- **R3: Test Isolation Side Effects** — mitigazione: scope function e cleanup; detection: `pytest --random-order` (fonte)
- **R4: Performance Regression** — mitigazione: timeout monitoring, checkpoint logging; detection: performance suite separata (fonte)

### Dipendenze e blocchi
- Prerequisiti: Story 5.4 completata; baseline 143 PASSED / 48 FAILED+ERRORS (fonte)
- Blocchi: Merge Story 5.2/5.3/5.4 su master; CI/CD green build (fonte)

### Esito atteso della validazione
- Pass Rate >90% (≥180/194), Failed <10, Errors 0, Coverage ≥93%, Duration <500s; nessun KeyError schema; nessun 401 nei sync job; nessuna violazione FK (fonte)

### Riferimenti
- Sorgente: `docs/stories/5.4.1-suite-wide-test-fixes.md` (tutte le affermazioni e numeri provengono da questa fonte)
