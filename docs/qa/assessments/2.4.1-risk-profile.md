# Risk Profile — Story 2.4.1: Document Persistence Integrity Fix

## Riepilogo
- **ID**: 2.4.1 (fonte: L6)
- **Tipo**: Technical Debt / Blocker (fonte: L7)
- **Epic**: Epic 2 — Core Knowledge Pipeline (fonte: L8)
- **Priorità**: Critical (P0 - Blocker) (fonte: L9)
- **Complessità**: Medium (fonte: L10)
- **Effort stimato**: 4-6 ore (fonte: L11)
- **Storie bloccate**: 4.4, 4.2.1 (fonte: L12)

## Contesto del rischio
- Il flusso corrente inserisce chunk senza record padre `documents`, causando violazioni FK e orfani (fonte: L31–L50, L53–L57).
- L’obiettivo è creare/aggiornare documento padre e propagare `document_id` ai chunk prima dell’indicizzazione (fonte: L58–L69).

## Elenco rischi

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-2.4.1-1 | `document_chunks` esistenti senza FK valida | Alta | Alto | Pre-migration: query identificazione orfani + script fix retroattivo | 
| R-2.4.1-2 | Race condition su ON CONFLICT | Bassa | Medio | `file_hash` UNIQUE garantisce serializzazione; test concurrency |
| R-2.4.1-3 | Breaking change per test esistenti | Media | Medio | Aggiornare fixture test per includere `document_id` in metadata |
| R-2.4.1-4 | Performance overhead asyncpg call | Bassa | Basso | Connection pool già configurato; latency +5-10ms accettabile |
| R-2.4.1-5 | Watcher refactoring scope creep | Media | Medio | Out of scope: Watcher opzionale, focus su API endpoint |

(Fonti: L379–L386)

## Verifiche e criteri di accettazione rilevanti
- AC1: creazione record `documents` e ritorno `document_id` (fonte: L75–L85).
- AC2: rispetto FK; nessun chunk orfano (fonte: L87–L98).
- AC3: idempotenza con `ON CONFLICT` e stesso UUID (fonte: L100–L116).
- AC4: endpoint crea `documents` prima dei chunk; response include `document_id` (fonte: L118–L131, L291–L294).
- AC5: sblocco Story 4.4; lista documenti con `chunk_count > 0` e test E2E verdi (fonte: L133–L144).

## Piano di mitigazione sintetico
- Implementare `save_document_to_db` con `ON CONFLICT (file_hash)` e propagazione `document_id` ai chunk (fonte: L150–L223, L231–L301).
- Aggiornare endpoint `/api/v1/admin/knowledge-base/sync-jobs` per creare/aggiornare `documents` prima dell’indicizzazione (fonte: L231–L301).
- Eseguire pre-verifica stato DB e, se necessario, migrazione retroattiva per orfani (fonte: L557–L643).
- Copertura test: unit, integrazione, E2E Story 4.4 (fonte: L389–L475).

## Impatti
- Sblocca pipeline ingestion e Document Explorer (fonte: L22, L54–L57, L133–L144).
- Abilita persistenze future come analytics (fonte: L12, L366–L369).

## Fonti puntuali
- `docs/stories/2.4.1-document-persistence-integrity-fix.md`: L6–L12, L31–L50, L53–L57, L58–L69, L75–L144, L148–L223, L231–L301, L356–L386, L389–L475, L557–L643.