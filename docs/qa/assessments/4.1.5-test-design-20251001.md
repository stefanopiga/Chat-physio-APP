# Test Design — Story 4.1.5: Admin Dashboard Hub

**Date**: 2025-10-01  
**Reviewer**: QA Team  
**Story**: Technical Debt / UX Enhancement  
**Type**: Frontend Refactoring + Testing

---

## Riferimenti

### Story Documents
- **Fonte Primaria**: `docs/stories/4.1.5-admin-dashboard-hub.md`
- **Risk Profile**: `docs/qa/assessments/4.1.5-risk-20251001.md`
- **UX Gap Analysis**: `docs/qa/assessments/admin-dashboard-ux-gap-analysis-20251001.md`

### Related Stories
- Story 1.4: `docs/stories/1.4.placeholder-ui-and-protected-routes.md` (DashboardPage originale)
- Story 4.1: `docs/stories/4.1.admin-debug-view.md` (pattern UI admin reference)
- Story 4.1 Test Design: `docs/qa/assessments/4.1-test-design-20251001.md` (E2E pattern reference)

---

## Executive Summary

### Test Scope
- **File Under Test**: `apps/web/src/pages/DashboardPage.tsx` (refactoring)
- **Test Files**: 
  - Unit: `apps/web/src/pages/__tests__/DashboardPage.test.tsx` (nuovo)
  - E2E: `apps/web/tests/story-4.1.5.spec.ts` (nuovo)
- **Test Types**: Unit (Vitest) + E2E (Playwright)
- **Backend Testing**: N/A (solo frontend refactoring)

### Test Strategy Summary
- **Total Test Cases**: 16 (8 unit + 8 E2E)
- **Coverage Target**: ≥ 90% unit coverage
- **Duration Target**: E2E < 30 secondi totali
- **Risk-Based Priority**: P0 (1 test), P1 (7 test), P2 (8 test)

### Quality Gates
- ✅ All AC verified (7/7)
- ✅ All critical risks covered (R-4.1.5-1, R-4.1.5-2, R-4.1.5-3)
- ✅ Regression testing Story 4.1 (AdminGuard)
- ✅ Accessibility testing (keyboard nav, aria-label)

---

## Gating / Prerequisiti (Bloccanti)

### Dipendenze Tecniche (Status: Done)

**Story 1.4 (Protected Routes)**: AdminGuard disponibile
- Route `/admin/dashboard` già protetta
- Pattern guard consolidato
- **Fonte**: Story 4.1.5 L168-169

**Story 4.1 (Admin Debug View)**: Pattern UI admin validato
- Card navigation pattern
- Responsive grid Tailwind
- E2E auth mocking pattern (__mockAuthService)
- **Fonte**: Story 4.1.5 L271

### Prerequisiti Implementativi (Pre-Testing)

**R-4.1.5-1 CRITICAL BLOCKER — Card Component Installation**:
- [ ] **MANDATORY**: `pnpm dlx shadcn@latest add card` eseguito
- [ ] **VERIFICATION**: File `apps/web/src/components/ui/card.tsx` esiste
- [ ] **BUILD TEST**: `pnpm build` zero errori TypeScript
- **Fonte**: Story 4.1.5 L108-113, Risk Profile R-4.1.5-1
- **Status**: **BLOCKER** — Test non eseguibili senza Card component

**DashboardPage Refactored**:
- [ ] Placeholder JSON user data rimosso
- [ ] Grid card funzionalità admin implementato
- [ ] User email extraction con fallback pattern
- [ ] Badge "Coming Soon" card Analytics
- **Fonte**: Story 4.1.5 L219-223

**AdminGuard Intatto**:
- [ ] Route `/admin/dashboard` ancora protetta da AdminGuard in App.tsx
- [ ] Nessuna modifica accidentale App.tsx routing
- **Fonte**: Risk Profile R-4.1.5-2


---

## Obiettivi di Test

### Functional Testing
1. **Verificare tutti 7 Acceptance Criteria** della Story 4.1.5
2. **Garantire UX coerente**: Dashboard funzionale vs placeholder JSON
3. **Validare navigation pattern**: Link card funzionanti e accessibili

### Risk-Based Testing
1. **R-4.1.5-1 (CRITICAL)**: Card component disponibile e type-safe
2. **R-4.1.5-2 (HIGH)**: AdminGuard regression — no security breach
3. **R-4.1.5-3 (HIGH)**: Session email extraction con fallback pattern
4. **R-4.1.5-4 (MEDIUM)**: Badge "Coming Soon" card Analytics
5. **R-4.1.5-5 (MEDIUM)**: Responsive layout mobile/desktop

### Regression Testing
1. **Story 4.1 E2E Suite**: Re-run 3 test AdminGuard (E2E-002, E2E-003)
2. **AdminDebugPage**: Verifica dashboard → debug navigation intatta

### Non-Functional Testing
1. **Accessibility**: Keyboard navigation, aria-label, focus visible
2. **Performance**: E2E duration < 30s (target Story 4.1: 1.3s per test)
3. **Responsive Design**: Mobile (375px) e desktop (1280px) viewport

---

## Acceptance Criteria → Test Cases Mapping

### AC1: Dashboard Funzionale (Non Più Placeholder)

**Requirement**: `/admin/dashboard` mostra dashboard funzionale (non più placeholder JSON)

**Test Cases**:
- **UT-001**: Heading "Dashboard Amministratore" presente
- **UT-002**: Nessun elemento `<pre>` con JSON stringify (placeholder rimosso)
- **E2E-001**: Admin login → dashboard mostra grid card (no JSON)

**Priority**: P1  
**Fonte**: Story 4.1.5 AC1 L27

---

### AC2: Sezione "Funzionalità Admin" con Card/Link

**Requirement**: Dashboard include card link a Debug RAG e Analytics Dashboard

**Test Cases**:
- **UT-003**: Card "Debug RAG" presente con link `/admin/debug`
- **UT-004**: Card "Analytics Dashboard" presente con link `/admin/analytics`
- **UT-005**: Badge "Coming Soon" presente card Analytics
- **E2E-002**: Click card "Debug RAG" → redirect `/admin/debug`
- **E2E-003**: Card Analytics badge "Coming Soon" visible
- **E2E-004**: Click card Analytics → NO redirect (pointer-events-none)

**Priority**: P1 (card Debug), P2 (card Analytics)  
**Fonte**: Story 4.1.5 AC2 L28-30

---

### AC3: Informazioni Utente Admin (Email, Ruolo)

**Requirement**: Dashboard mostra email utente admin

**Test Cases**:
- **UT-006**: User email estratto da session e displayed
- **UT-007**: Fallback "Benvenuto, Amministratore" se email undefined
- **UT-008**: Fallback "Benvenuto, Amministratore" se session null
- **E2E-006**: Email reale post-login visible in dashboard

**Priority**: P1 (fallback pattern obbligatorio)  
**Fonte**: Story 4.1.5 AC3 L31, Risk Profile R-4.1.5-3

**Note**: AC richiede "email, ruolo" ma implementation mostra solo email (ruolo implicito in contesto admin). Test valida solo email display.

---

### AC4: Layout Responsive (2 Col Desktop, 1 Col Mobile)

**Requirement**: Grid 2 col desktop, 1 col mobile

**Test Cases**:
- **UT-009**: className grid include `md:grid-cols-2` (o `grid-cols-1 md:grid-cols-2`)
- **E2E-007**: Viewport 375px (mobile) → 1 col layout verify
- **E2E-008**: Viewport 1280px (desktop) → 2 col layout verify

**Priority**: P2  
**Fonte**: Story 4.1.5 AC4 L32, Risk Profile R-4.1.5-5

---

### AC5: UI Coerente Pattern Shadcn/UI

**Requirement**: Card componenti Shadcn/UI + variabili semantiche Tailwind

**Test Cases**:
- **UT-010**: Card import da `@/components/ui/card` type-safe
- **UT-011**: Nessun colore hard-coded (grep verification post-implementation)

**Priority**: P0 (Card import — BLOCKER)  
**Fonte**: Story 4.1.5 AC5 L33, Risk Profile R-4.1.5-1

---

### AC6: Navigazione Diretta (No Browser Back)

**Requirement**: Link diretti tra funzionalità admin

**Test Cases**:
- **E2E-002**: Dashboard → Debug RAG (link diretto, no back)
- **Integration implicit**: Link `<Link to="/admin/debug">` React Router

**Priority**: P2  
**Fonte**: Story 4.1.5 AC6 L34

**Note**: Requirement "no browser back" significa link diretti vs navigation history. Test E2E-002 valida click → redirect senza necessità back button.

---

### AC7: Dashboard Accessibile Solo Admin Autenticati

**Requirement**: AdminGuard protezione route `/admin/dashboard`

**Test Cases**:
- **E2E-005**: Non-admin (student) login → redirect `/` (AdminGuard attivo)
- **Regression**: Story 4.1 E2E-002 (redirect non-auth), E2E-003 (redirect student)

**Priority**: P1 (security critical)  
**Fonte**: Story 4.1.5 AC7 L35, Risk Profile R-4.1.5-2

---

## Test Cases Dettagliati


### Frontend Unit Tests (Vitest + React Testing Library)

**File**: `apps/web/src/pages/__tests__/DashboardPage.test.tsx`

---

#### UT-001: Rendering — Heading "Dashboard Amministratore" Presente

**Test ID**: UT-001  
**Priority**: P1  
**Type**: Smoke Test  
**AC Coverage**: AC1  
**Risk Coverage**: —

**Given**:
- DashboardPage component mounted
- Mock session con user admin

**When**:
- Component renders

**Then**:
- Heading "Dashboard Amministratore" visibile

**Implementation**:
```typescript
test('renders heading "Dashboard Amministratore"', () => {
  render(<DashboardPage />);
  expect(screen.getByRole('heading', { name: /dashboard amministratore/i })).toBeInTheDocument();
});
```

**Assertions**:
- `getByRole('heading')` trova elemento
- Text match case-insensitive

---

#### UT-002: Placeholder JSON Rimosso

**Test ID**: UT-002  
**Priority**: P1  
**Type**: Regression Prevention  
**AC Coverage**: AC1  
**Risk Coverage**: —

**Given**:
- DashboardPage component mounted

**When**:
- Component renders

**Then**:
- Nessun elemento `<pre>` presente (placeholder legacy)
- Nessun testo `JSON.stringify` visible

**Implementation**:
```typescript
test('does not render JSON placeholder from Story 1.4', () => {
  render(<DashboardPage />);
  expect(screen.queryByText(/\{/)).not.toBeInTheDocument();  // No JSON braces
  const preElements = document.querySelectorAll('pre');
  expect(preElements).toHaveLength(0);
});
```

**Rationale**: Story 1.4 aveva placeholder JSON user data. Questo test previene regressione.

---

#### UT-003: Card "Debug RAG" Presente con Link

**Test ID**: UT-003  
**Priority**: P1  
**Type**: Functional  
**AC Coverage**: AC2  
**Risk Coverage**: —

**Given**:
- DashboardPage component mounted

**When**:
- Component renders

**Then**:
- Card con text "Debug RAG" presente
- Link `href="/admin/debug"` presente

**Implementation**:
```typescript
test('renders "Debug RAG" card with link to /admin/debug', () => {
  render(<DashboardPage />);
  const link = screen.getByRole('link', { name: /debug rag/i });
  expect(link).toBeInTheDocument();
  expect(link).toHaveAttribute('href', '/admin/debug');
});
```

---

#### UT-004: Card "Analytics Dashboard" Presente con Link

**Test ID**: UT-004  
**Priority**: P2  
**Type**: Functional  
**AC Coverage**: AC2  
**Risk Coverage**: R-4.1.5-4

**Given**:
- DashboardPage component mounted

**When**:
- Component renders

**Then**:
- Card con text "Analytics Dashboard" presente
- Link `href="/admin/analytics"` presente

**Implementation**:
```typescript
test('renders "Analytics Dashboard" card with link to /admin/analytics', () => {
  render(<DashboardPage />);
  const link = screen.getByRole('link', { name: /analytics dashboard/i });
  expect(link).toBeInTheDocument();
  expect(link).toHaveAttribute('href', '/admin/analytics');
});
```

---

#### UT-005: Badge "Coming Soon" Card Analytics

**Test ID**: UT-005  
**Priority**: P2  
**Type**: Functional  
**AC Coverage**: AC2  
**Risk Coverage**: R-4.1.5-4 (mitigation)

**Given**:
- DashboardPage component mounted

**When**:
- Component renders

**Then**:
- Card Analytics contiene badge "Coming Soon"
- Link Analytics ha `pointer-events-none` (disabled)

**Implementation**:
```typescript
test('Analytics card shows "Coming Soon" badge and is disabled', () => {
  render(<DashboardPage />);
  expect(screen.getByText(/coming soon/i)).toBeInTheDocument();
  
  const analyticsLink = screen.getByRole('link', { name: /analytics/i });
  // Verify disabled state (pointer-events-none or aria-disabled)
  expect(analyticsLink).toHaveClass(/pointer-events-none|opacity-50/);
});
```

**Rationale**: R-4.1.5-4 mitigation — Badge previene confusion 404 pre-Story 4.2.

---

#### UT-006: User Email Display (Session Valid)

**Test ID**: UT-006  
**Priority**: P1  
**Type**: Functional  
**AC Coverage**: AC3  
**Risk Coverage**: R-4.1.5-3

**Given**:
- Mock `authService.getSession()` restituisce session con `user.email = "admin@test.com"`

**When**:
- Component renders

**Then**:
- Text "Benvenuto, admin@test.com" visibile

**Implementation**:
```typescript
test('displays user email when session is valid', async () => {
  // Mock authService
  vi.mock('@/services/authService', () => ({
    authService: {
      getSession: vi.fn().mockResolvedValue({
        data: { session: { user: { email: 'admin@test.com' } } },
        error: null,
      }),
    },
  }));
  
  render(<DashboardPage />);
  
  await waitFor(() => {
    expect(screen.getByText(/benvenuto, admin@test.com/i)).toBeInTheDocument();
  });
});
```

---

#### UT-007: Fallback "Amministratore" (Email Undefined)

**Test ID**: UT-007  
**Priority**: P1  
**Type**: Edge Case / Risk Mitigation  
**AC Coverage**: AC3  
**Risk Coverage**: R-4.1.5-3 (HIGH)

**Given**:
- Mock `authService.getSession()` restituisce session con `user.email = undefined`

**When**:
- Component renders

**Then**:
- Text "Benvenuto, Amministratore" visibile (fallback)

**Implementation**:
```typescript
test('displays fallback "Amministratore" when email is undefined', async () => {
  vi.mock('@/services/authService', () => ({
    authService: {
      getSession: vi.fn().mockResolvedValue({
        data: { session: { user: { email: undefined } } },
        error: null,
      }),
    },
  }));
  
  render(<DashboardPage />);
  
  await waitFor(() => {
    expect(screen.getByText(/benvenuto, amministratore/i)).toBeInTheDocument();
  });
});
```

**Rationale**: R-4.1.5-3 HIGH risk — Session email extraction failure mitigation.

---

#### UT-008: Fallback "Amministratore" (Session Null)

**Test ID**: UT-008  
**Priority**: P1  
**Type**: Edge Case / Risk Mitigation  
**AC Coverage**: AC3  
**Risk Coverage**: R-4.1.5-3 (HIGH)

**Given**:
- Mock `authService.getSession()` restituisce `session = null`

**When**:
- Component renders

**Then**:
- Text "Benvenuto, Amministratore" visibile (fallback)
- No crash/error rendering

**Implementation**:
```typescript
test('displays fallback "Amministratore" when session is null', async () => {
  vi.mock('@/services/authService', () => ({
    authService: {
      getSession: vi.fn().mockResolvedValue({
        data: { session: null },
        error: null,
      }),
    },
  }));
  
  render(<DashboardPage />);
  
  await waitFor(() => {
    expect(screen.getByText(/benvenuto, amministratore/i)).toBeInTheDocument();
  });
});
```

**Rationale**: R-4.1.5-3 HIGH risk — Timing race condition session null.

---

#### UT-009: Responsive Grid ClassName

**Test ID**: UT-009  
**Priority**: P2  
**Type**: Functional / Responsive Design  
**AC Coverage**: AC4  
**Risk Coverage**: R-4.1.5-5

**Given**:
- DashboardPage component mounted

**When**:
- Component renders

**Then**:
- Grid container ha className `md:grid-cols-2` (responsive breakpoint)
- Oppure `grid-cols-1 md:grid-cols-2` (explicit mobile-first)

**Implementation**:
```typescript
test('grid has responsive className for 2 col desktop, 1 col mobile', () => {
  const { container } = render(<DashboardPage />);
  
  const gridElement = container.querySelector('.grid');
  expect(gridElement).toHaveClass(/md:grid-cols-2/);
});
```

**Rationale**: Verify Tailwind responsive pattern presente. E2E test visual validation.

---

#### UT-010: Card Import Type-Safe

**Test ID**: UT-010  
**Priority**: P0 (BLOCKER verification)  
**Type**: Build / Dependency Verification  
**AC Coverage**: AC5  
**Risk Coverage**: R-4.1.5-1 (CRITICAL)

**Given**:
- Card component installato da Shadcn/UI

**When**:
- DashboardPage importa `Card`, `CardHeader`, `CardDescription` da `@/components/ui/card`

**Then**:
- Import TypeScript compilation success (no type errors)
- Card renderizza senza crash

**Implementation**:
```typescript
// Test implicito: se file compila senza errori TS, test PASS
// Esplicito:
test('Card component imports are type-safe', () => {
  expect(() => render(<DashboardPage />)).not.toThrow();
  
  // Verify Card elements rendered
  const { container } = render(<DashboardPage />);
  const cards = container.querySelectorAll('[class*="card"]');
  expect(cards.length).toBeGreaterThan(0);
});
```

**Rationale**: R-4.1.5-1 CRITICAL BLOCKER — Verifica Card disponibile e type-safe.

**Pre-Test Gating**: Se UT-010 fallisce, STOP test suite → risolvere R-4.1.5-1.

---

#### UT-011: No Hard-Coded Colors (Code Inspection)

**Test ID**: UT-011  
**Priority**: P2  
**Type**: Code Quality / Design Compliance  
**AC Coverage**: AC5  
**Risk Coverage**: —

**Given**:
- DashboardPage.tsx source code

**When**:
- Grep verification: `grep -E '#[0-9a-fA-F]{3,6}|rgb\(|hsl\(' DashboardPage.tsx`

**Then**:
- Zero match (no hard-coded colors)

**Implementation**:
```bash
# Manual verification (not automated test)
cd apps/web/src/pages
grep -E '#[0-9a-fA-F]{3,6}|rgb\(|hsl\(' DashboardPage.tsx
# Expected output: (empty) or only comments

# Alternative: ESLint rule custom
```

**Rationale**: AC5 compliance — solo variabili semantiche Tailwind.

**Note**: Test manuale, non automated. Verificare durante code review.


---

### End-to-End Tests (Playwright)

**File**: `apps/web/tests/story-4.1.5.spec.ts`

**Auth Mocking Pattern**: Riutilizzo pattern Story 4.1 (`__mockAuthService`)

**Setup Comune**:
```typescript
await page.addInitScript(() => {
  const mockSession = {
    access_token: "mock-admin-token",
    user: {
      id: "test-admin-id",
      email: "admin@test.com",
      user_metadata: { role: "admin" },
    },
  };
  
  (window as any).__mockAuthService = {
    getSession: async () => ({ data: { session: mockSession }, error: null }),
    onAuthStateChange: (callback) => {
      setTimeout(() => callback("SIGNED_IN", mockSession), 0);
      return { data: { subscription: { unsubscribe: () => {} } } };
    },
    isAdmin: () => true,
    isStudent: () => false,
    isAuthenticated: () => true,
  };
  
  sessionStorage.setItem("temp_jwt", "mock-admin-token");
});
```

---

#### E2E-001: Admin Login → Dashboard Mostra Grid Card (No JSON)

**Test ID**: E2E-001  
**Priority**: P1  
**Type**: Happy Path  
**AC Coverage**: AC1, AC2  
**Risk Coverage**: —

**Given**:
- Admin autenticato (mock session)

**When**:
- Navigazione a `/admin/dashboard`

**Then**:
- Heading "Dashboard Amministratore" visible
- Card "Debug RAG" visible
- Card "Analytics Dashboard" visible
- Nessun elemento `<pre>` con JSON (placeholder rimosso)

**Implementation**:
```typescript
test('admin navigates to dashboard and sees functional grid (no JSON)', async ({ page }) => {
  // Setup auth mock (setup comune)
  
  await page.goto('/admin/dashboard');
  
  // AC1: Dashboard funzionale
  await expect(page.getByRole('heading', { name: /dashboard amministratore/i })).toBeVisible();
  
  // AC2: Card presenti
  await expect(page.getByText(/debug rag/i)).toBeVisible();
  await expect(page.getByText(/analytics dashboard/i)).toBeVisible();
  
  // Placeholder JSON rimosso
  const preElements = await page.locator('pre').count();
  expect(preElements).toBe(0);
});
```

**Duration Estimate**: ~1.5s

---

#### E2E-002: Click Card "Debug RAG" → Redirect `/admin/debug`

**Test ID**: E2E-002  
**Priority**: P1  
**Type**: Functional / Navigation  
**AC Coverage**: AC2, AC6  
**Risk Coverage**: —

**Given**:
- Admin autenticato, dashboard visible

**When**:
- Click su card "Debug RAG"

**Then**:
- Redirect a `/admin/debug` (AdminDebugPage)
- Heading "Debug RAG" visible (conferma redirect)

**Implementation**:
```typescript
test('clicking "Debug RAG" card redirects to /admin/debug', async ({ page }) => {
  await page.goto('/admin/dashboard');
  
  // Wait for dashboard loaded
  await page.waitForSelector('text=Dashboard Amministratore');
  
  // Click card Debug RAG
  await page.click('text=Debug RAG');
  
  // Verify redirect
  await expect(page).toHaveURL(/\/admin\/debug$/);
  await expect(page.getByRole('heading', { name: /debug rag/i })).toBeVisible();
});
```

**Duration Estimate**: ~1.2s

**Note**: Test valida AC6 (navigazione diretta, no browser back necessario).

---

#### E2E-003: Card Analytics Badge "Coming Soon" Visible

**Test ID**: E2E-003  
**Priority**: P2  
**Type**: Functional / UX Mitigation  
**AC Coverage**: AC2  
**Risk Coverage**: R-4.1.5-4 (mitigation verification)

**Given**:
- Admin autenticato, dashboard visible

**When**:
- Card "Analytics Dashboard" rendered

**Then**:
- Badge "Coming Soon" visible
- Card ha visual indicator disabled (opacity reduced o simile)

**Implementation**:
```typescript
test('Analytics card shows "Coming Soon" badge', async ({ page }) => {
  await page.goto('/admin/dashboard');
  
  // Wait for dashboard
  await page.waitForSelector('text=Dashboard Amministratore');
  
  // Verify badge visible
  await expect(page.getByText(/coming soon/i)).toBeVisible();
  
  // Verify card appears disabled (opacity check)
  const analyticsCard = page.locator('text=Analytics Dashboard').locator('..');
  const opacity = await analyticsCard.evaluate(el => window.getComputedStyle(el).opacity);
  expect(parseFloat(opacity)).toBeLessThan(1);  // Reduced opacity indicator
});
```

**Duration Estimate**: ~1.0s

---

#### E2E-004: Click Card Analytics → NO Redirect (Disabled)

**Test ID**: E2E-004  
**Priority**: P2  
**Type**: Functional / UX Mitigation  
**AC Coverage**: AC2  
**Risk Coverage**: R-4.1.5-4 (404 prevention)

**Given**:
- Admin autenticato, dashboard visible

**When**:
- Tentativo click su card "Analytics Dashboard"

**Then**:
- NO redirect (pointer-events-none attivo)
- URL rimane `/admin/dashboard`
- NO error console 404

**Implementation**:
```typescript
test('clicking Analytics card does NOT redirect (disabled)', async ({ page }) => {
  await page.goto('/admin/dashboard');
  
  await page.waitForSelector('text=Dashboard Amministratore');
  
  // Tentativo click (potrebbe non triggerare nulla)
  await page.click('text=Analytics Dashboard', { force: true });  // Force click anche se disabled
  
  // Wait breve per verificare no redirect
  await page.waitForTimeout(500);
  
  // Verify URL unchanged
  await expect(page).toHaveURL(/\/admin\/dashboard$/);
  
  // Verify no 404 in console errors
  // (Playwright tracks console errors automatically)
});
```

**Duration Estimate**: ~1.0s

**Rationale**: R-4.1.5-4 mitigation — Badge "Coming Soon" + disabled state previene 404 pre-Story 4.2.

---

#### E2E-005: Non-Admin (Student) Login → Redirect `/` (AdminGuard)

**Test ID**: E2E-005  
**Priority**: P1  
**Type**: Security / Access Control  
**AC Coverage**: AC7  
**Risk Coverage**: R-4.1.5-2 (AdminGuard regression)

**Given**:
- User student autenticato (mock session role=student)

**When**:
- Navigazione a `/admin/dashboard`

**Then**:
- AdminGuard redirect a `/` (AccessCodePage)
- Dashboard NON visible

**Implementation**:
```typescript
test('student user is redirected to / by AdminGuard', async ({ page }) => {
  // Setup STUDENT auth mock
  await page.addInitScript(() => {
    const mockSession = {
      access_token: "mock-student-token",
      user: {
        id: "test-student-id",
        email: "student@test.com",
        user_metadata: { role: "student" },  // NON admin
      },
    };
    
    (window as any).__mockAuthService = {
      getSession: async () => ({ data: { session: mockSession }, error: null }),
      onAuthStateChange: (callback) => {
        setTimeout(() => callback("SIGNED_IN", mockSession), 0);
        return { data: { subscription: { unsubscribe: () => {} } } };
      },
      isAdmin: () => false,  // KEY: isAdmin() restituisce false
      isStudent: () => true,
      isAuthenticated: () => true,
    };
  });
  
  await page.goto('/admin/dashboard');
  
  // Verify redirect to /
  await expect(page).toHaveURL(/^\/$|^\/$/);
  
  // Verify dashboard NOT visible
  await expect(page.getByText(/dashboard amministratore/i)).not.toBeVisible();
});
```

**Duration Estimate**: ~1.1s

**Rationale**: R-4.1.5-2 HIGH risk — Verifica AdminGuard protection intatta (no regression).

---

#### E2E-006: Email Display — Reale Post-Login

**Test ID**: E2E-006  
**Priority**: P1  
**Type**: Functional / Data Display  
**AC Coverage**: AC3  
**Risk Coverage**: R-4.1.5-3

**Given**:
- Admin autenticato con email `admin@test.com`

**When**:
- Dashboard rendered

**Then**:
- Text "Benvenuto, admin@test.com" visible
- NO fallback "Amministratore"

**Implementation**:
```typescript
test('dashboard displays real admin email after login', async ({ page }) => {
  // Setup auth mock con email specifica
  await page.addInitScript(() => {
    const mockSession = {
      user: { email: 'admin@test.com', user_metadata: { role: 'admin' } },
    };
    (window as any).__mockAuthService = {
      getSession: async () => ({ data: { session: mockSession }, error: null }),
      // ... rest of mock
      isAdmin: () => true,
    };
  });
  
  await page.goto('/admin/dashboard');
  
  await expect(page.getByText(/benvenuto, admin@test\.com/i)).toBeVisible();
});
```

**Duration Estimate**: ~1.0s

---

#### E2E-007: Responsive Mobile — Viewport 375px → 1 Col Layout

**Test ID**: E2E-007  
**Priority**: P2  
**Type**: Responsive Design / Cross-Device  
**AC Coverage**: AC4  
**Risk Coverage**: R-4.1.5-5

**Given**:
- Admin autenticato
- Viewport mobile: 375px width

**When**:
- Dashboard rendered

**Then**:
- Grid card visibile come 1 colonna (vertical stack)
- Card non troncate o overflow horizontal

**Implementation**:
```typescript
test('dashboard shows 1 column layout on mobile viewport (375px)', async ({ page }) => {
  // Set mobile viewport
  await page.setViewportSize({ width: 375, height: 667 });
  
  await page.goto('/admin/dashboard');
  
  await page.waitForSelector('text=Dashboard Amministratore');
  
  // Verify grid layout: card stacked vertically
  const gridElement = page.locator('.grid').first();
  const boundingBox = await gridElement.boundingBox();
  
  // Both cards should be within viewport width (no horizontal overflow)
  expect(boundingBox?.width).toBeLessThanOrEqual(375);
  
  // Visual verification: card Debug RAG above card Analytics
  const debugCard = page.locator('text=Debug RAG').locator('..');
  const analyticsCard = page.locator('text=Analytics Dashboard').locator('..');
  
  const debugBox = await debugCard.boundingBox();
  const analyticsBox = await analyticsCard.boundingBox();
  
  expect(debugBox?.y).toBeLessThan(analyticsBox?.y!);  // Debug above Analytics
});
```

**Duration Estimate**: ~1.2s

---

#### E2E-008: Responsive Desktop — Viewport 1280px → 2 Col Layout

**Test ID**: E2E-008  
**Priority**: P2  
**Type**: Responsive Design / Cross-Device  
**AC Coverage**: AC4  
**Risk Coverage**: R-4.1.5-5

**Given**:
- Admin autenticato
- Viewport desktop: 1280px width

**When**:
- Dashboard rendered

**Then**:
- Grid card visibile come 2 colonne (side-by-side)

**Implementation**:
```typescript
test('dashboard shows 2 column layout on desktop viewport (1280px)', async ({ page }) => {
  // Set desktop viewport
  await page.setViewportSize({ width: 1280, height: 720 });
  
  await page.goto('/admin/dashboard');
  
  await page.waitForSelector('text=Dashboard Amministratore');
  
  // Verify grid layout: card side-by-side
  const debugCard = page.locator('text=Debug RAG').locator('..');
  const analyticsCard = page.locator('text=Analytics Dashboard').locator('..');
  
  const debugBox = await debugCard.boundingBox();
  const analyticsBox = await analyticsCard.boundingBox();
  
  // Both cards should have similar Y position (same row)
  const yDiff = Math.abs(debugBox?.y! - analyticsBox?.y!);
  expect(yDiff).toBeLessThan(10);  // Tolleranza 10px per alignment
  
  // Debug card a sinistra, Analytics a destra
  expect(debugBox?.x).toBeLessThan(analyticsBox?.x!);
});
```

**Duration Estimate**: ~1.2s


---

## Test Summary Matrix

### Unit Tests

| Test ID | Description | AC | Risk | Priority | Type |
|---------|-------------|----|----|----------|------|
| UT-001 | Heading "Dashboard Amministratore" | AC1 | — | P1 | Smoke |
| UT-002 | Placeholder JSON rimosso | AC1 | — | P1 | Regression Prevention |
| UT-003 | Card "Debug RAG" con link | AC2 | — | P1 | Functional |
| UT-004 | Card "Analytics" con link | AC2 | R-4.1.5-4 | P2 | Functional |
| UT-005 | Badge "Coming Soon" Analytics | AC2 | R-4.1.5-4 | P2 | UX Mitigation |
| UT-006 | User email display (valid) | AC3 | R-4.1.5-3 | P1 | Functional |
| UT-007 | Fallback email undefined | AC3 | R-4.1.5-3 | P1 | Edge Case |
| UT-008 | Fallback session null | AC3 | R-4.1.5-3 | P1 | Edge Case |
| UT-009 | Responsive grid className | AC4 | R-4.1.5-5 | P2 | Responsive |
| UT-010 | Card import type-safe | AC5 | R-4.1.5-1 | P0 | BLOCKER Verification |
| UT-011 | No hard-coded colors | AC5 | — | P2 | Code Quality (manual) |

**Total Unit Tests**: 11 (10 automated + 1 manual)

---

### E2E Tests

| Test ID | Description | AC | Risk | Priority | Type |
|---------|-------------|----|----|----------|------|
| E2E-001 | Dashboard grid visible (no JSON) | AC1, AC2 | — | P1 | Happy Path |
| E2E-002 | Click Debug RAG → redirect | AC2, AC6 | — | P1 | Navigation |
| E2E-003 | Badge "Coming Soon" visible | AC2 | R-4.1.5-4 | P2 | UX Mitigation |
| E2E-004 | Click Analytics NO redirect | AC2 | R-4.1.5-4 | P2 | UX Mitigation |
| E2E-005 | Student redirect by AdminGuard | AC7 | R-4.1.5-2 | P1 | Security |
| E2E-006 | Email display post-login | AC3 | R-4.1.5-3 | P1 | Functional |
| E2E-007 | Mobile viewport 1 col | AC4 | R-4.1.5-5 | P2 | Responsive |
| E2E-008 | Desktop viewport 2 col | AC4 | R-4.1.5-5 | P2 | Responsive |

**Total E2E Tests**: 8

---

## Risk-Based Testing Coverage

### Critical Risk (P0)

**R-4.1.5-1: Card Component Not Available [BLOCKER]**

**Test Coverage**:
- **UT-010**: Card import type-safe (verification post-installation)
- **Pre-Test Gating**: Card installation verificata prima test suite execution

**Mitigation Verification**:
1. Build test: `pnpm build` zero errors
2. Unit test: UT-010 PASS
3. E2E implicit: Se dashboard renders, Card funzionante

**Status**: **GATING CONDITION** — Test suite non eseguibile senza Card.

---

### High Risks (P1)

**R-4.1.5-2: AdminGuard Regression**

**Test Coverage**:
- **E2E-005**: Student redirect `/` (AdminGuard attivo)
- **Regression**: Story 4.1 E2E-002, E2E-003 (re-run obbligatorio)

**Mitigation Verification**:
- AdminGuard protection intatta
- No modifica accidentale App.tsx routing
- Security log verification (post-deployment)

---

**R-4.1.5-3: Session Email Extraction Failure**

**Test Coverage**:
- **UT-006**: Email display valid session
- **UT-007**: Fallback email undefined
- **UT-008**: Fallback session null
- **E2E-006**: Email reale post-login

**Mitigation Verification**:
- Fallback pattern implementato: `userEmail || "Amministratore"`
- Loading state gestito (no "undefined" visible)
- Test coverage 4/16 test (25% focus su questo risk)

---

### Medium Risks (P2)

**R-4.1.5-4: Link `/admin/analytics` 404**

**Test Coverage**:
- **UT-005**: Badge "Coming Soon" presente
- **E2E-003**: Badge visible
- **E2E-004**: Click NO redirect (disabled)

**Mitigation Verification**:
- Badge visible in produzione
- Pointer-events-none attivo
- Zero 404 errors monitored (post-deployment)

---

**R-4.1.5-5: Responsive Layout Breakage**

**Test Coverage**:
- **UT-009**: Grid className responsive
- **E2E-007**: Mobile 375px → 1 col
- **E2E-008**: Desktop 1280px → 2 col

**Mitigation Verification**:
- Pattern grid Tailwind validato
- Visual regression testing (viewport)

---

## Accessibility Testing

### Keyboard Navigation (Manual Test)

**Test ID**: MANUAL-001  
**Priority**: P2  
**Type**: Accessibility / WCAG AA

**Procedure**:
1. Navigare a `/admin/dashboard` con admin auth
2. Premere Tab key ripetutamente
3. Verificare:
   - Focus visible su card "Debug RAG"
   - Focus visible su card "Analytics Dashboard"
   - Enter key su card Debug → redirect `/admin/debug`
   - Focus ring color contrast sufficiente (WCAG AA)

**Expected Result**: Navigazione completa solo con tastiera, focus visible su tutti elementi interattivi.

**Rationale**: Risk Profile R-4.1.5-9 (Accessibility issues).

---

### ARIA Labels Verification

**Test ID**: UT-012 (Additional)  
**Priority**: P2

**Implementation**:
```typescript
test('card links have aria-label for screen readers', () => {
  render(<DashboardPage />);
  
  const debugLink = screen.getByRole('link', { name: /debug rag/i });
  expect(debugLink).toHaveAttribute('aria-label', /accedi a debug rag/i);
  
  const analyticsLink = screen.getByRole('link', { name: /analytics/i });
  expect(analyticsLink).toHaveAttribute('aria-label', /analytics dashboard/i);
});
```

**Rationale**: R-4.1.5-9 mitigation — Screen reader support.

---

## Regression Testing

### Story 4.1 E2E Suite (Re-Run Obbligatorio)

**File**: `apps/web/tests/story-4.1.spec.ts`

**Test Cases da Re-Run**:
1. **E2E-001**: Admin happy path (dashboard → debug flow)
2. **E2E-002**: Redirect non-autenticato
3. **E2E-003**: Redirect student (AdminGuard)

**Objective**: Verificare nessuna regressione su:
- AdminGuard protection `/admin/debug`
- Navigation dashboard → debug intatta
- Auth mocking pattern funzionante

**Expected Result**: 3/3 test PASS, duration < 5s totali.

**Rationale**: R-4.1.5-2 mitigation — AdminGuard regression prevention.

---

### AdminDebugPage Integration Test

**Test ID**: INTEGRATION-001  
**Priority**: P2  
**Type**: Integration / Navigation

**Procedure** (Manual or E2E):
1. Login admin → `/admin/dashboard`
2. Click card "Debug RAG" → redirect `/admin/debug`
3. Submit query debug → response visible
4. Browser back → return `/admin/dashboard`
5. Dashboard ancora funzionante (no state loss)

**Expected Result**: Navigation bidirezionale dashboard ↔ debug funzionante.

**Rationale**: Verify integration tra dashboard hub e feature admin esistente.

---

## Coverage Targets

### Unit Test Coverage

**Target**: ≥ 90% line coverage  
**Files Covered**: `apps/web/src/pages/DashboardPage.tsx`

**Critical Paths** (must be covered):
- User email extraction + fallback logic
- Card rendering (Debug RAG, Analytics)
- Badge "Coming Soon" logic
- Grid responsive className

**Coverage Command**:
```bash
cd apps/web
pnpm test:coverage -- DashboardPage.test.tsx
```

**Expected Output**:
```
File                  | % Stmts | % Branch | % Funcs | % Lines |
----------------------|---------|----------|---------|---------|
DashboardPage.tsx     |   95.2  |   90.5   |  100.0  |   94.8  |
```

---

### E2E Coverage

**Target**: 100% AC coverage (7/7 AC)

**AC → E2E Mapping**:
- AC1: E2E-001 ✅
- AC2: E2E-001, E2E-002, E2E-003, E2E-004 ✅
- AC3: E2E-006 ✅
- AC4: E2E-007, E2E-008 ✅
- AC5: Implicit (Card rendering) ✅
- AC6: E2E-002 (implicit navigation) ✅
- AC7: E2E-005 ✅

**Coverage Status**: **100% AC Covered**

---

## Test Execution Plan

### Phase 1: Pre-Implementation Verification

**Duration**: 5 minuti

**Tasks**:
1. [ ] Verify Card component installed: `ls apps/web/src/components/ui/card.tsx`
2. [ ] Build test: `pnpm build` (zero errors)
3. [ ] Isolated Card rendering: `pnpm test -- Card.test.tsx` (if exists)

**Gating Decision**: Se Phase 1 fallisce → STOP, risolvere R-4.1.5-1 BLOCKER.

---

### Phase 2: Unit Test Execution

**Duration**: 30 secondi (esecuzione) + 15 min (scrittura test)

**Command**:
```bash
cd apps/web
pnpm test -- DashboardPage.test.tsx
```

**Expected Result**: 10/10 test PASS (UT-011 manuale escluso)

**Coverage Verification**:
```bash
pnpm test:coverage -- DashboardPage.test.tsx
```

**Success Criteria**:
- Coverage ≥ 90%
- Zero test failures
- Duration < 5s

---

### Phase 3: E2E Test Execution

**Duration**: 8-12 secondi (esecuzione) + 20 min (scrittura test)

**Command**:
```bash
cd apps/web
pnpm test:e2e -- story-4.1.5.spec.ts
```

**Expected Result**: 8/8 test PASS

**Performance Target**: < 30s totali (E2E suite)

**Breakdown**:
- E2E-001: ~1.5s
- E2E-002: ~1.2s
- E2E-003: ~1.0s
- E2E-004: ~1.0s
- E2E-005: ~1.1s
- E2E-006: ~1.0s
- E2E-007: ~1.2s
- E2E-008: ~1.2s
- **Total**: ~9.2s (well under 30s target)

---

### Phase 4: Regression Testing

**Duration**: 3-5 secondi

**Command**:
```bash
cd apps/web
pnpm test:e2e -- story-4.1.spec.ts
```

**Expected Result**: 3/3 test PASS (no regression)

**Rationale**: R-4.1.5-2 mitigation — AdminGuard intatto.

---

### Phase 5: Manual Testing

**Duration**: 10-15 minuti

**Tasks**:
1. [ ] Keyboard navigation test (MANUAL-001)
2. [ ] Visual inspection theming Light/Dark
3. [ ] Code review: No hard-coded colors (UT-011)
4. [ ] Integration test: Dashboard ↔ Debug navigation (INTEGRATION-001)

**Success Criteria**:
- Keyboard nav funzionante
- Theming coerente
- Zero colori hard-coded
- Integration smooth

---

## Test Environment Setup

### Local Development

**Prerequisites**:
```bash
cd apps/web

# 1. Install dependencies
pnpm install

# 2. BLOCKER: Install Card component
pnpm dlx shadcn@latest add card

# 3. Verify build
pnpm build

# 4. Start dev server (for E2E)
pnpm dev  # Port 5173
```

---

### CI/CD Pipeline

**GitHub Actions** (or equivalent):

```yaml
name: Test Story 4.1.5

on:
  pull_request:
    paths:
      - 'apps/web/src/pages/DashboardPage.tsx'
      - 'apps/web/tests/story-4.1.5.spec.ts'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install pnpm
        run: npm install -g pnpm
      
      - name: Install dependencies
        run: |
          cd apps/web
          pnpm install
      
      - name: Install Card component (BLOCKER)
        run: |
          cd apps/web
          pnpm dlx shadcn@latest add card
      
      - name: Unit tests
        run: |
          cd apps/web
          pnpm test -- DashboardPage.test.tsx
      
      - name: E2E tests
        run: |
          cd apps/web
          pnpm test:e2e -- story-4.1.5.spec.ts
      
      - name: Regression tests (Story 4.1)
        run: |
          cd apps/web
          pnpm test:e2e -- story-4.1.spec.ts
```

---

## Test Data & Mocking

### Auth Service Mock (Unit Tests)

```typescript
// vitest.setup.ts or test file
vi.mock('@/services/authService', () => ({
  authService: {
    getSession: vi.fn().mockResolvedValue({
      data: { 
        session: { 
          user: { 
            email: 'admin@test.com',
            user_metadata: { role: 'admin' }
          } 
        } 
      },
      error: null,
    }),
  },
}));
```

---

### Auth Service Mock (E2E Tests)

```typescript
// Playwright test file
await page.addInitScript(() => {
  const mockSession = {
    access_token: "mock-admin-token",
    user: {
      id: "test-admin-id",
      email: "admin@test.com",
      user_metadata: { role: "admin" },
    },
  };
  
  (window as any).__mockAuthService = {
    getSession: async () => ({ 
      data: { session: mockSession }, 
      error: null 
    }),
    onAuthStateChange: (callback) => {
      setTimeout(() => callback("SIGNED_IN", mockSession), 0);
      return { 
        data: { 
          subscription: { unsubscribe: () => {} } 
        } 
      };
    },
    isAdmin: () => true,
    isStudent: () => false,
    isAuthenticated: () => true,
  };
  
  sessionStorage.setItem("temp_jwt", "mock-admin-token");
});
```

**Source Pattern**: Story 4.1 `apps/web/tests/story-4.1.spec.ts` L8-41

---

## Success Criteria & Exit Criteria

### Test Pass Criteria

**Unit Tests**:
- ✅ 10/10 automated test PASS (UT-011 manuale escluso)
- ✅ Coverage ≥ 90%
- ✅ Duration < 5s

**E2E Tests**:
- ✅ 8/8 test PASS
- ✅ Duration < 30s totali
- ✅ Zero flaky test (3 consecutive runs)

**Regression**:
- ✅ Story 4.1 E2E: 3/3 test PASS
- ✅ AdminGuard protection intatta

**Manual**:
- ✅ Keyboard navigation funzionante
- ✅ Zero hard-coded colors
- ✅ Integration dashboard ↔ debug smooth

---

### Exit Criteria (Story 4.1.5 Ready for Merge)

**Code Quality**:
- [ ] Linter: zero errors
- [ ] TypeScript: strict mode, zero errors
- [ ] Build: `pnpm build` success

**Testing**:
- [ ] Unit tests: 10/10 PASS, coverage ≥ 90%
- [ ] E2E tests: 8/8 PASS, duration < 30s
- [ ] Regression: Story 4.1 tests PASS
- [ ] Manual: Accessibility verified

**Risk Mitigation**:
- [ ] R-4.1.5-1: Card component installed ✅
- [ ] R-4.1.5-2: AdminGuard regression test PASS ✅
- [ ] R-4.1.5-3: Fallback pattern verified ✅
- [ ] R-4.1.5-4: Badge "Coming Soon" visible ✅
- [ ] R-4.1.5-5: Responsive test PASS ✅

**Documentation**:
- [ ] Story 1.4 updated: "Placeholder evoluto in Story 4.1.5"
- [ ] Screenshot dashboard for reference
- [ ] Test design document complete (questo documento)

---

## Known Limitations & Future Improvements

### Limitations MVP

1. **UT-011 (Hard-coded colors)**: Manual verification, non automated. Future: ESLint custom rule.
2. **WCAG AAA**: Non testato (target WCAG AA sufficiente MVP).
3. **Screen Reader Audio**: Non testato (Shadcn/UI compliant by design assumption).
4. **Cross-Browser**: Solo Chromium testato E2E. Firefox/Safari optional post-MVP.

---

### Future Test Enhancements

**Post-Story 4.2**:
1. Integration test: Dashboard → Analytics navigation (dopo merge 4.2)
2. Visual regression testing (Percy, Chromatic)
3. Performance metrics: bundle size impact Card component
4. Load testing: Dashboard rendering con 10+ card (scalability)

---

## References

### Story Documents
- Story 4.1.5: `docs/stories/4.1.5-admin-dashboard-hub.md`
- Story 1.4: `docs/stories/1.4.placeholder-ui-and-protected-routes.md`
- Story 4.1: `docs/stories/4.1.admin-debug-view.md`

### QA Documents
- Risk Profile: `docs/qa/assessments/4.1.5-risk-20251001.md`
- UX Gap Analysis: `docs/qa/assessments/admin-dashboard-ux-gap-analysis-20251001.md`
- Story 4.1 Test Design: `docs/qa/assessments/4.1-test-design-20251001.md`

### Code References
- DashboardPage: `apps/web/src/pages/DashboardPage.tsx`
- AdminGuard: `apps/web/src/components/AdminGuard.tsx`
- AuthService: `apps/web/src/services/authService.ts`
- Story 4.1 E2E: `apps/web/tests/story-4.1.spec.ts` (auth mocking pattern)

### External Documentation
- Vitest: https://vitest.dev/guide/
- Playwright: https://playwright.dev/docs/intro
- React Testing Library: https://testing-library.com/react
- Shadcn/UI Testing: https://ui.shadcn.com/docs/components/card

---

## Change Log

| Date | Author | Change Description |
|------|--------|-------------------|
| 2025-10-01 | QA Team | Initial test design — Story 4.1.5 comprehensive coverage |
| 2025-10-01 | QA Team | Mapped 7 AC → 16 test cases (11 unit + 8 E2E + regression) |
| 2025-10-01 | QA Team | Risk-based testing: CRITICAL R-4.1.5-1, HIGH R-4.1.5-2/3 covered |
| 2025-10-01 | QA Team | Test execution plan: 4 phases + CI/CD pipeline defined |

---

**Test Design Completed**: 2025-10-01  
**Status**: Ready for Implementation + Test Execution  
**Next Step**: Dev Team — Implement DashboardPage refactoring + test suite
