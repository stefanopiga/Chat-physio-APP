# Risk Profile: Story 6.3 — Watcher Async Refactoring & DB-First Integration

Date: 2025-10-20
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 9
- Critical Risks: 0
- High Risks: 4
- Medium Risks: 4
- Low Risks: 1
- Risk Score: 38/100

## Critical Risks Requiring Immediate Attention

None identified as score 9. Highest risks (score 6) listed below; treat as must-mitigate pre-merge.

## Risk Matrix

| Risk ID   | Description                                                       | Probability | Impact | Score | Priority |
| --------- | ----------------------------------------------------------------- | ----------- | ------ | ----- | -------- |
| DATA-002  | Orphan/partial writes without transaction across doc + chunks     | Medium (2)  | High(3)| 6     | High     |
| TECH-002  | Connection leaks / incorrect pool handling                        | Medium (2)  | High(3)| 6     | High     |
| TECH-001  | Residual sync I/O blocking event loop                             | Medium (2)  | High(3)| 6     | High     |
| TECH-003  | Concurrency/race when multiple watcher runs overlap               | Medium (2)  | High(3)| 6     | High     |
| PERF-001  | Latency from per-chunk awaits inside tight loops                  | Medium (2)  | Medium(2)| 4   | Medium   |
| OPS-001   | Script/ops breakage removing legacy ingest paths                  | Medium (2)  | Medium(2)| 4   | Medium   |
| OPS-002   | Observability gaps for async execution and retries                | Medium (2)  | Medium(2)| 4   | Medium   |
| DATA-001  | Duplicate writes during transition (legacy + DB double write)     | Low (1)     | High(3)| 3     | Low      |
| SEC-001   | Misconfigured DB creds/permissions in new runner                  | Low (1)     | Medium(2)| 2   | Low      |

## Highest Risk Detail

### DATA-002: Orphan/partial writes without transaction across doc + chunks

- Score: 6 (High)
- Affected components: pps/api/api/ingestion/watcher.py, pps/api/api/ingestion/db_storage.py, pps/api/api/database.py
- Detection method: Review of AC2 flow shows separate calls to save document, save chunks, and update status without explicit transaction scope.
- Mitigation:
  - Wrap save_document_to_db, save_chunks_to_db, and update_document_status in a single transaction (sync with conn.transaction())
  - Add NOT NULL/foreign key constraints; use ON DELETE CASCADE only if consistent with retention
  - Implement idempotency via document hash + unique constraint to avoid duplicates
  - Add retry with backoff for transient failures; on failure, roll back
  - Add integrity check post-commit (count chunks for document_id)
  - Testing: chaos tests to inject failures between steps and assert atomicity

## Detailed Risk Register with Mitigations

### TECH-001: Residual sync I/O blocking event loop (Score 6)
- Probability: Medium — legacy sync paths exist (classification/chunking remain sync)
- Impact: High — can stall async throughput under load
- Mitigation:
  - Audit file and network I/O in scan_once; isolate CPU-bound sync via un_in_executor if needed
  - Batch operations; avoid per-file synchronous logging to slow sinks
  - Add instrumentation for event loop lag
  - Tests: load tests with many small files; assert loop lag within thresholds

### TECH-002: Connection leaks / incorrect pool handling (Score 6)
- Mitigation:
  - Use sync with db_pool.acquire() patterns only; never store global connections
  - Centralize connection lifecycle in runner; forbid creating pools inside hot paths
  - Add max lifetime and leak detection logs; ensure close_db_pool() on shutdown
  - Tests: fail test if pool size grows across runs; simulate exceptions to verify release

### TECH-003: Concurrency/race when multiple watcher runs overlap (Score 6)
- Mitigation:
  - Introduce locking or deduping (e.g., claim files by hash/state in DB)
  - Enforce unique constraints by file hash + path
  - Idempotent writes in save_chunks_to_db
  - Tests: concurrent runs on same directory; expect single write set

### DATA-001: Duplicate writes during transition (Score 3)
- Mitigation:
  - Disable legacy file writes behind flag; do not double-write
  - One-way migration: read-only legacy; backup then remove after verification
  - Tests: assert absence of file I/O calls; verify unique index prevents duplicates

### PERF-001: Latency from per-chunk awaits inside tight loops (Score 4)
- Mitigation:
  - Batch inserts in save_chunks_to_db; use executemany or COPY where viable
  - Use gather for independent awaits with bounded concurrency
  - Tests: benchmark single vs batched path; regression threshold in CI

### OPS-001: Script/ops breakage removing legacy ingest paths (Score 4)
- Mitigation:
  - Provide scripts/watcher_runner.py CLI parity with old script flags
  - Deprecation window; symlink or thin wrapper that forwards to new runner
  - Update runbooks and monitoring docs; announce change to stakeholders

### OPS-002: Observability gaps for async execution and retries (Score 4)
- Mitigation:
  - Structured logs with trace/span IDs; log key events (acquire, begin tx, commit)
  - Metrics: processed docs, chunks/sec, error rate, retry count, pool usage
  - Alerts: error rate spikes, queue backlog, loop lag > threshold

### SEC-001: Misconfigured DB creds/permissions in new runner (Score 2)
- Mitigation:
  - Principle of least privilege; runner uses limited role
  - Store secrets in env/secret manager; never log connection strings
  - Tests: attempt forbidden operations in CI to validate role

## Risk-Based Testing Strategy

- Priority 1 (High score 6): transactional atomicity (DATA-002), pool hygiene (TECH-002), residual sync I/O (TECH-001), concurrency overlap (TECH-003)
- Priority 2 (Score 4): batching/perf, observability/metrics, ops parity
- Priority 3 (Score 2-3): duplicate writes prevention, security config

Required test types:
- Integration tests with real asyncpg against test DB
- Concurrency tests simulating overlapping watcher runs
- Chaos testing injecting failures between DB steps
- Performance microbenchmarks for batched inserts

## Risk Acceptance Criteria

- Must fix before merge: any un-transactional DB write path; connection leaks; non-idempotent duplicate writes
- Can deploy with mitigation: ops parity/documentation if feature flagged; perf tuning with monitoring
- Accepted (documented): none at this time

## Monitoring Requirements

- Loop lag, pool utilization, acquire latency
- Processed docs/min, chunks/sec, error/retry rates
- Transaction aborts/rollbacks count; integrity check failures
- Alert on spike thresholds and sustained degradations

## Gate Snippet (for qa gate file)

`yaml
risk_summary:
  totals:
    critical: 0
    high: 4
    medium: 4
    low: 1
  highest:
    id: DATA-002
    score: 6
    title: 'Orphan/partial writes without transaction across doc + chunks'
  recommendations:
    must_fix:
      - 'Wrap document+chunks+status in single DB transaction'
      - 'Ensure idempotency via unique hash constraints'
      - 'Fix connection lifecycle; prevent leaks'
    monitor:
      - 'Observe event loop lag and pool metrics post-deploy'
      - 'Benchmark batched vs per-chunk inserts in CI'
`

## Story Hook

Risk profile: docs/qa/assessments/6.3.watcher-async-refactoring-db-integration-risk-20251020.md
