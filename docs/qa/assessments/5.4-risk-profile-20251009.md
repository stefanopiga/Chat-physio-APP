# Story 5.4 — Risk Profile (Test Suite Critical Fixes & Environment Isolation)

Data: 2025-10-09
ID: QA-RISK-5.4
Riferimento: docs/stories/5.4-test-suite-critical-fixes.md

## Executive Summary
Stato attuale test suite critico: 45 FAILED, 16 ERRORS, pass rate 74.2% (durata 359.72s). I rischi principali riguardano: interferenza del rate limiting in ambiente test, mismatch contratti API, violazioni FK su fixture, migrazione import incompleta, incongruenze JWT e timeout E2E. La Story 5.4 mira a rimuovere il blocco primario (rate limiting) e ripristinare l’allineamento tra codice/test.

## Rischi (Classificazione: Probabilità × Impatto)

### R1 — Rate Limiting abilitato in test (BLOCCANTE)
- Probabilità: Alta
- Impatto: Critico
- Evidenza: 429 diffusi su test admin/analytics (vedi output pytest)
- Causa: SlowAPI attivo + store condiviso
- Mitigazione (5.4): Flag `testing`, toggle `rate_limiting_enabled`, registrazione condizionale in `main.py`, fixture cleanup store.
- Residuo: Basso (doppio guard + fixture)

### R2 — API contract mismatch (documenti, KB)
- Probabilità: Media-Alta
- Impatto: Alto
- Evidenza: KeyError `document_id`, `total_chunks`, `similarity_score`; assert ORDER BY
- Causa: Refactoring non allineato agli expectations dei test
- Mitigazione (5.4): Ripristino campi, paginazione/ordinamento espliciti
- Residuo: Basso-Medio (necessaria regression su frontend e OpenAPI)

### R3 — Violazioni FK su fixture database
- Probabilità: Alta
- Impatto: Alto
- Evidenza: postgrest.exceptions.APIError su `student_tokens`
- Causa: `created_by_id` senza parent `auth.users`
- Mitigazione (5.4): Fixture con upsert parent + cleanup
- Residuo: Basso (idempotenza)

### R4 — Migrazione import incompleta
- Probabilità: Media
- Impatto: Medio-Alto
- Evidenza: ImportError/AttributeError (verify_jwt_token, perform_semantic_search, CreateStudentTokenRequest)
- Causa: Riferimenti legacy a `api.main`
- Mitigazione (5.4): Audit script + fix puntuali
- Residuo: Basso (audit automatizzato)

### R5 — Incongruenze configurazione JWT
- Probabilità: Media
- Impatto: Medio-Alto
- Evidenza: InvalidAudienceError; TypeError timedelta
- Causa: Claim `aud`/`iss` disallineati; tipo env var
- Mitigazione (5.4): `aud` esplicito, validator int, leeway
- Residuo: Basso (test unit pass attesi)

### R6 — Timeout E2E
- Probabilità: Media
- Impatto: Medio
- Evidenza: Timeout test pipeline
- Causa: Effetti collaterali di R1–R5
- Mitigazione (5.4): Timeout 120s + checkpoint logging, da rivalutare post-fix
- Residuo: Basso-Medio (da verificare a valle)

## Rischi Operativi/Processo

### R7 — Leakage configurazioni test in produzione
- Probabilità: Bassa-Media
- Impatto: Critico
- Mitigazione: Doppia condizione (config `should_enable_rate_limiting` + env), log espliciti, validazione CI env
- Controllo: Smoke test prod che verifica presenza rate limiting

### R8 — Regressioni su frontend/integrazioni
- Probabilità: Media
- Impatto: Medio-Alto
- Mitigazione: Allineamento OpenAPI/contratti, smoke E2E post-deploy
- Controllo: Validazione con test d’integrazione frontend (se disponibili)

## Matrice Rischi (Sintesi)
- Critico: R1, R7
- Alto: R2, R3, R5
- Medio: R4, R6, R8

## KPI di Riduzione Rischio (Target 5.4)
- 429 imprevisti: 20+ → 0
- KeyError schema: 6 → 0
- FK errors: 16 → 0
- Import/AttributeError: 4 → 0
- JWT errors: 2 → 0
- E2E timeout: 2 → ≤1 (post-fix)
- Pass rate: 74.2% → >90%
- Errors: 16 → 0
- Durata suite: ≤400s

## Controlli & Verifiche
- Gate QA: esecuzione suite completa con `TESTING=true`, `RATE_LIMITING_ENABLED=false`
- Report finale: compilazione template Completion Report in Story 5.4
- Evidenze: log rate limiting disabilitato, output pytest per categorie

## Decisioni & Dipendenze
- Abilitare bypass RL solo in test, vietato in prod
- Aggiornare documentazione sicurezza/performance e README test
- Nessun blocco esterno: priorità massima per sblocco CI

## Esito QA (provvisorio)
- Idoneità a procedere: Condizionata al completamento Phases 1–5 e validazioni 7.1–7.2
- Requisiti per sign-off: 0 errori, failed <10, >90% pass rate, controlli R7 attivi