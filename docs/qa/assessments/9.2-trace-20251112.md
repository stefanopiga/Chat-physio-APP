# Requirements Traceability Matrix

## Story: 9.2 - Session History Retrieval & UI Integration

### Coverage Summary
- Total Requirements: 9
- Fully Covered: 4 (44.4%)
- Partially Covered: 5 (55.6%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Backend endpoint GET /api/v1/chat/sessions/{sessionId}/history/full con auth, rate limit 60/min, pagination
- Coverage: PARTIAL
- Evidence (Backend tests):
  - apps/api/tests/routers/test_chat_history.py:1
    - Success path → 200, struttura risposta corretta
    - 401 Unauthorized senza JWT
    - Pagination con `limit=100` e `has_more=True`
    - Feature flag disabilitato → risposta vuota 200
    - db_pool non disponibile → degradazione 200 con vuoto
    - Errore persistence → 500 con messaggio
- Evidence (Client tests):
  - apps/web/src/lib/__tests__/apiClient.test.ts:1
    - Gestione 429 con `Retry-After` e retry/backoff
- Gap: assenza test espliciti di rate limiting lato backend (429 generato dal server)

#### AC2: Uso di ConversationPersistenceService.load_session_history() (Story 9.1)
- Coverage: FULL
- Evidence:
  - apps/api/tests/routers/test_chat_history.py:1
    - Patch del service e verifica mapping dei messaggi in risposta

#### AC3: Frontend apiClient.getSessionHistory(sessionId, limit?, offset?) tipizzato con error handling
- Coverage: FULL
- Evidence:
  - apps/web/src/lib/__tests__/apiClient.test.ts:1
    - Success 200 con parsing JSON tipizzato
    - 404 → ritorno `{ messages: [], total_count: 0, has_more: false }`
    - Network error → 3 retry con exponential backoff
    - 429 → rispetto `Retry-After` + backoff
    - 500 → throw con messaggio `HTTP 500`
    - Pagination con `limit/offset` custom

#### AC4: ChatPage carica automaticamente history su mount con UI indicator
- Coverage: FULL
- Evidence (E2E):
  - apps/web/tests/story-9.2.spec.ts:1
    - E2E-1: verifica loading indicator visibile e poi nascosto; messaggi popolati

#### AC5: Messaggi storico mantengono formato dei messaggi runtime (MessageBubble, citations popover, source_chunk_ids preservati)
- Coverage: PARTIAL
- Evidence (Backend):
  - apps/api/tests/routers/test_chat_history.py:1
    - Verifica `source_chunk_ids` sull’assistant message
- Evidence (E2E):
  - apps/web/tests/story-9.2.spec.ts:1 (E2E-4)
    - Presenza di citations e rendering di base
- Gap: comportamento completo del popover citations e deep-link source chunk non verificati in test automatici

#### AC6: Feature flag ENABLE_PERSISTENT_MEMORY controlla comportamento (true: DB; false: degradazione)
- Coverage: FULL
- Evidence:
  - apps/web/src/hooks/__tests__/useSessionHistory.test.ts:1
    - Flag disabilitato → skip caricamento, log info
  - apps/api/tests/routers/test_chat_history.py:1
    - Flag disabilitato lato server → risposta vuota 200
  - E2E: apps/web/tests/story-9.2.spec.ts:1 (E2E-6)

#### AC7: Error handling robusto (network retry, 401 redirect, 404 vuoto, 500 toast)
- Coverage: PARTIAL
- Evidence:
  - Network/Retry: apps/web/src/lib/__tests__/apiClient.test.ts:1 (retry 3x)
  - 404: api client test + E2E-3
  - 500: api client test + E2E-2 (toast/graceful)
- Gap: 401 redirect non coperto esplicitamente in test E2E/unit (solo implied pattern)

#### AC8: Performance ottimizzata (pagination >100, spinner <500ms, virtual scrolling >50)
- Coverage: PARTIAL
- Evidence:
  - Pagination: backend test (has_more), client unit, E2E-5 (lazy load scroll)
  - Spinner: E2E-1 verifica presenza indicatori
- Gap: soglia temporale <500ms non validata con misure; virtual scrolling performance non misurata; test di rendering performance non presenti

#### AC9: Testing coverage minimo 80% (BE unit, FE Vitest hook, E2E Playwright)
- Coverage: PARTIAL
- Evidence:
  - BE: apps/api/tests/routers/test_chat_history.py:1 (7 scenari)
  - FE: apps/web/src/hooks/__tests__/useSessionHistory.test.ts:1 (scenari multipli)
  - E2E: apps/web/tests/story-9.2.spec.ts:1 (6 scenari)
- Gap: percentuali di coverage non misurate/riportate; mancano report coverage consolidati

### Critical Gaps
1. Rate limiting server-side (429) non verificato a livello backend (solo client-side handling) — impatta AC1/AC7.
2. 401 Unauthorized redirect non testato end-to-end — impatta AC7.
3. Comportamento completo citations popover e deep-link source chunk non coperti — impatta AC5.
4. Performance target (<500ms, virtual scrolling) non misurati — impatta AC8.
5. Assenza report coverage ≥80% consolidato — impatta AC9.

### Test Design Recommendations
- Aggiungere test backend per rate limiting (fixture SlowAPI/limiter → aspettarsi 429 con `Retry-After`).
- E2E scenario 401: mock risposta 401 e verificare redirect alla login.
- FE integration test su componenti citations: apertura popover, link ai chunk (o mock handler) presenti e funzionanti.
- Integrare misurazioni di performance in E2E (timing TTFB/TTFR) o test di performance separati con soglie soft e alert.
- Abilitare raccolta coverage su BE/FE ed esportare report HTML/XML; aggiungere check CI per soglia ≥80%.

### Risk Assessment
- High Risk: Mancata validazione rate limiting backend potrebbe nascondere regressioni sotto carico.
- Medium Risk: Redirect 401 non validato E2E può generare UX inconsistente.
- Medium Risk: Mancata validazione performance può degradare UX con storici lunghi.
- Low Risk: Citations popover non critico per funzionalità base ma utile per UX.

