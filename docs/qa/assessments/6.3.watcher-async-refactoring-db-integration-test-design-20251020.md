# Test Design: Story 6.3 — Watcher Async Refactoring & DB-First Integration

Date: 2025-10-20
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 6 (25%)
- Integration tests: 14 (58%)
- E2E tests: 4 (17%)
- Priority distribution: P0: 9, P1: 9, P2: 6

Rationale: Core change is integration-heavy (async DB, transactions, pool lifecycle). Prioritize integration tests backed by a real test DB (asyncpg). Keep unit tests for transformation logic and guards. Limited E2E to validate end-to-end watcher runner behavior and ops parity.

## Test Scenarios by Acceptance Criteria

### AC1: Refactoring Async scan_once() (Watcher Core)

#### Scenarios

| ID                 | Level       | Priority | Test                                                             | Justification |
| ------------------ | ----------- | -------- | ---------------------------------------------------------------- | ------------- |
| 6.3-UNIT-001       | Unit        | P1       | Validate scan_once handles empty inventory                     | Logic guard   |
| 6.3-UNIT-002       | Unit        | P1       | Error path: exception in classification bubbles with logging     | Error logic   |
| 6.3-INT-001        | Integration | P0       | scan_once uses provided conn without creating new pool       | Pool hygiene  |
| 6.3-INT-002        | Integration | P0       | No legacy file I/O calls triggered during run                    | Legacy off    |
| 6.3-INT-003        | Integration | P0       | Structured logs emitted for start/finish and error cases         | Observability |
| 6.3-INT-004        | Integration | P0       | Transaction wraps doc+chunks+status (atomicity under failure)    | Risk DATA-002 |

### AC2: Integration DB-First Storage (Elimina File Legacy)

#### Scenarios

| ID                 | Level       | Priority | Test                                                             | Justification |
| ------------------ | ----------- | -------- | ---------------------------------------------------------------- | ------------- |
| 6.3-INT-005        | Integration | P0       | save_document_to_db ? save_chunks_to_db ? update_status in one tx | Atomicity |
| 6.3-INT-006        | Integration | P0       | Unique constraint by file hash prevents duplicate ingest         | Idempotency   |
| 6.3-INT-007        | Integration | P1       | On failure mid-write, no orphan rows (rollback)                  | Consistency   |
| 6.3-INT-008        | Integration | P1       | Chunks persisted count equals produced chunks                    | Integrity     |
| 6.3-INT-009        | Integration | P1       | Legacy storage.py not imported/called anywhere                 | Clean removal |

### AC3: Script Runner Async con Connection Management

#### Scenarios

| ID                 | Level       | Priority | Test                                                             | Justification |
| ------------------ | ----------- | -------- | ---------------------------------------------------------------- | ------------- |
| 6.3-UNIT-003       | Unit        | P2       | Runner calls init_db_pool once and close_db_pool on finally  | Control flow  |
| 6.3-INT-010        | Integration | P0       | sync with db_pool.acquire() usage; connection not leaked      | Pool hygiene  |
| 6.3-INT-011        | Integration | P1       | Runner returns non-zero exit code on error                       | Ops contract  |
| 6.3-E2E-001        | E2E         | P1       | CLI execution processes directory and reports processed count    | Behavioral    |

### AC4: Migrazione Test Suite ad Async

#### Scenarios

| ID                 | Level       | Priority | Test                                                             | Justification |
| ------------------ | ----------- | -------- | ---------------------------------------------------------------- | ------------- |
| 6.3-UNIT-004       | Unit        | P2       | Async fixtures provide syncpg.Connection                      | Test infra    |
| 6.3-INT-012        | Integration | P0       | Updated tests use wait scan_once and pass real conn         | Coverage      |
| 6.3-INT-013        | Integration | P1       | Test suite passes with watcher async (no deadlocks)              | Regression    |

### AC5: Regression Testing & Validation

#### Scenarios

| ID                 | Level       | Priority | Test                                                             | Justification |
| ------------------ | ----------- | -------- | ---------------------------------------------------------------- | ------------- |
| 6.3-INT-014        | Integration | P0       | Full test run with DB asserts coverage >= 85% on modified modules | Quality bar  |
| 6.3-INT-015        | Integration | P1       | Ruff lint passes for modified files                              | Quality bar   |
| 6.3-E2E-002        | E2E         | P1       | Manual validation plan: run watcher, query DB for chunk counts   | Acceptance    |

### AC6: Documentazione Aggiornata

#### Scenarios

| ID                 | Level       | Priority | Test                                                             | Justification |
| ------------------ | ----------- | -------- | ---------------------------------------------------------------- | ------------- |
| 6.3-E2E-003        | E2E         | P2       | Docs commands execute successfully in local env                  | Docs parity   |
| 6.3-E2E-004        | E2E         | P2       | Monitoring doc reflects async metrics and runner command         | Docs parity   |

## Risk Coverage

- DATA-002 (atomicity): 6.3-INT-004/005/007
- TECH-002 (pool leaks): 6.3-INT-001/010
- TECH-001 (sync I/O): 6.3-INT-002/013 + profiling step in perf tests
- TECH-003 (overlap races): Add separate concurrency set below
- PERF-001 (batching): perf microbenchmarks below
- OPS-001/002 (ops parity/observability): 6.3-E2E-001/002/004, 6.3-INT-003/011
- SEC-001 (creds/perm): negative permission test below

### Additional Concurrency and Performance Suite

| ID                 | Level       | Priority | Test                                                             | Justification |
| ------------------ | ----------- | -------- | ---------------------------------------------------------------- | ------------- |
| 6.3-INT-016        | Integration | P0       | Simulate overlapping watcher runs on same files ? no duplicates  | Idempotency   |
| 6.3-INT-017        | Integration | P1       | Batching in save_chunks_to_db outperforms per-chunk awaits     | Perf target   |
| 6.3-INT-018        | Integration | P1       | Event loop lag within threshold under load                       | Stability     |
| 6.3-INT-019        | Integration | P2       | DB role lacks DROP/ALTER permissions                             | Security      |

## Recommended Execution Order

1. P0 Unit tests
2. P0 Integration tests (atomicity, pool leaks, overlap)
3. P1 Integration and E2E
4. Performance microbenchmarks
5. P2 scenarios and docs parity

## Gate Snippet

`yaml
test_design:
  scenarios_total: 24
  by_level:
    unit: 6
    integration: 14
    e2e: 4
  by_priority:
    p0: 9
    p1: 9
    p2: 6
  coverage_gaps: []
`

## Trace References

Test design matrix: docs/qa/assessments/6.3.watcher-async-refactoring-db-integration-test-design-20251020.md
P0 tests identified: 9
