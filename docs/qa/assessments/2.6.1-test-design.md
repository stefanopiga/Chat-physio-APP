# Test Design — Story 2.6.1: Production Infrastructure Critical Fixes (P1)

Data: 2025-10-10
Designer: QA Agent

## Strategia di Test

- Scenari totali: 18
- Livelli: Integrazione=12, E2E=6
- Priorità: P0=12, P1=6
- Scope derivato da `docs/stories/2.6.1-production-infrastructure-critical-fixes.md` (AC1–AC5)

## Riferimenti vincolanti (fonte)
- AC1: connessione DB, SELECT 1, documentazione URL, guida troubleshooting (fonte: L129–L138)
- AC2: volume Redis, mount /data, AOF on, persistenza post-restart (fonte: L152–L177)
- AC3: /health → JSON, nessun HTML, priorità routing API > web (fonte: L179–L201)
- AC4: health matrix verde tramite script `docker_health_check.py` (fonte: L203–L224)
- AC5: documentazione aggiornata e nuove guide in docs/troubleshooting/* (fonte: L226–L235)

## Scenari di Test per Acceptance Criteria

### AC1 — Database Connectivity Validated
| ID              | Livello      | Priorità | Test                                                                                 | Evidenza/Output |
| --------------- | ------------ | -------- | ------------------------------------------------------------------------------------ | --------------- |
| 2.6.1-INT-DB-01 | Integrazione | P0       | Eseguire `scripts/validation/database_connectivity_test.py` con `DATABASE_URL` settata | Output SUCCESS  |
| 2.6.1-INT-DB-02 | Integrazione | P0       | Verificare `SELECT 1` restituisce 1                                                  | Log script      |
| 2.6.1-INT-DB-03 | Integrazione | P1       | Validare formato `DATABASE_URL` (pooler 6543 vs direct 5432, `sslmode=require`)      | Screenshot/log  |
| 2.6.1-INT-DB-04 | Integrazione | P1       | Documentare troubleshooting errori comuni                                            | Doc creata      |

Esecuzione: `cd apps/api && poetry run python ../../scripts/validation/database_connectivity_test.py` (fonte: L303).

### AC2 — Redis Data Persistence Configured
| ID               | Livello      | Priorità | Test                                                                                               | Evidenza/Output |
| ---------------- | ------------ | -------- | -------------------------------------------------------------------------------------------------- | --------------- |
| 2.6.1-INT-RD-01  | Integrazione | P0       | Verificare volume `redis_data` creato (`docker volume ls`)                                         | Output CLI      |
| 2.6.1-INT-RD-02  | Integrazione | P0       | Verificare mount `/data` in container (`docker inspect`/`ls -lh /data`)                            | Output CLI      |
| 2.6.1-INT-RD-03  | Integrazione | P0       | Abilitazione AOF: `appendonly.aof` presente e > 0                                                  | Output CLI      |
| 2.6.1-INT-RD-04  | Integrazione | P0       | Persistenza chiave: SET → restart → GET stesso valore                                              | Output CLI      |
| 2.6.1-INT-RD-05  | Integrazione | P1       | Verificare commenti/documentazione nel `docker-compose.yml`                                        | Diff file       |

Comandi di validazione (fonte: L163–L177): `docker exec ... redis-cli SET/GET`, `docker compose restart redis`, `ls -lh /data/appendonly.aof`.

### AC3 — Traefik Health Endpoint Routing Fixed
| ID                | Livello      | Priorità | Test                                                                                 | Evidenza/Output |
| ----------------- | ------------ | -------- | ------------------------------------------------------------------------------------ | --------------- |
| 2.6.1-INT-TF-01   | Integrazione | P0       | `curl http://localhost/health` restituisce JSON, Content-Type `application/json`     | Output curl     |
| 2.6.1-INT-TF-02   | Integrazione | P0       | Traefik dashboard mostra router `api-health-router` con priority 150                 | Screenshot UI   |
| 2.6.1-INT-TF-03   | Integrazione | P1       | Verificare che `web-router.priority=1` e `api-router.priority=100` siano applicati   | Diff file       |
| 2.6.1-INT-TF-04   | Integrazione | P1       | Alternative rule: `(PathPrefix('/api') || Path('/health'))` se Option A non disponibile | Diff file    |

Comandi di validazione (fonte: L189–L201, L449–L458): `curl`, Traefik UI `http://localhost:18080` (o la porta definita in `TRAEFIK_DASHBOARD_PORT`).

### AC4 — Infrastructure Health Matrix Green
| ID               | Livello      | Priorità | Test                                                              | Evidenza/Output |
| ---------------- | ------------ | -------- | ----------------------------------------------------------------- | --------------- |
| 2.6.1-INT-HM-01  | Integrazione | P0       | Eseguire `python scripts/validation/docker_health_check.py`       | Output PASS     |
| 2.6.1-INT-HM-02  | Integrazione | P0       | Verificare API Health OK, Redis PONG, DB Connection OK, Celery OK | Output dettagli |

### AC5 — Production Readiness Documentation Updated
| ID               | Livello | Priorità | Test                                                                 | Evidenza/Output |
| ---------------- | ------- | -------- | -------------------------------------------------------------------- | --------------- |
| 2.6.1-E2E-DOC-01 | E2E     | P1       | `docs/troubleshooting/database-connectivity.md` creato e completo     | File presente   |
| 2.6.1-E2E-DOC-02 | E2E     | P1       | `docs/troubleshooting/docker-infrastructure.md` creato e completo     | File presente   |
| 2.6.1-E2E-DOC-03 | E2E     | P1       | `docs/troubleshooting/traefik-routing.md` creato e completo           | File presente   |
| 2.6.1-E2E-DOC-04 | E2E     | P1       | `docs/reports/rag-production-readiness-summary.md` aggiornato          | Diff file       |

## Ordine di Esecuzione Raccomandato
1. AC1 (DB) — sblocca audit e health
2. AC2 (Redis) — evita perdita dati durante altri restart
3. AC3 (Traefik) — ripristina osservabilità
4. AC4 (Health Matrix) — verifica completo
5. AC5 (Documentazione) — consolidamento finale

## Blocco YAML per Gate di Qualità

test_design:
  scenarios_total: 18
  by_level:
    integration: 12
    e2e: 6
  by_priority:
    p0: 12
    p1: 6
  coverage_gaps: []

## Tracciabilità
- Sorgente: `docs/stories/2.6.1-production-infrastructure-critical-fixes.md`
- AC1: L129–L138; AC2: L152–L177; AC3: L179–L201; AC4: L203–L224; AC5: L226–L235
