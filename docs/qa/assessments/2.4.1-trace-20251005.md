# Traceability Matrix — Story 2.4.1: Document Persistence Integrity Fix

## Scope
- **Story**: 2.4.1 — Document Persistence Integrity Fix (rif. L5-L12:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **Epic**: Epic 2 — Core Knowledge Pipeline (rif. L8:docs/stories/2.4.1-document-persistence-integrity-fix.md)

## Matrice AC → Implementazione → Test → Migrazioni

### AC1 — Creazione record `documents` e `document_id` UUID
- **Definizione**: L75-L85
```75:85:docs/stories/2.4.1-document-persistence-integrity-fix.md
Then un record viene inserito in tabella `documents` ...
And viene restituito `document_id` UUID valido
```
- **Implementazione**: L182-L194 (upsert `documents`), L265-L275 (invocazione `save_document_to_db`)
```182:194:docs/stories/2.4.1-document-persistence-integrity-fix.md
INSERT INTO documents (...) ... RETURNING id
```
```265:275:docs/stories/2.4.1-document-persistence-integrity-fix.md
# 3. Crea/aggiorna documento padre
document_id = await save_document_to_db(...)
```
- **Test**: L401-L409 (unit), L457-L462 (integration)
- **Migrazioni**: L575 (UNIQUE file_hash)

### AC2 — Rispetto FK `document_chunks.document_id → documents.id`
- **Definizione**: L87-L98
```95:98:docs/stories/2.4.1-document-persistence-integrity-fix.md
SELECT COUNT(*) FROM document_chunks dc
WHERE NOT EXISTS (SELECT 1 FROM documents d WHERE d.id = dc.document_id);
-- Expected: 0
```
- **Implementazione**: L276-L285 (propagazione `document_id`), L287-L293 (indexing + status)
```276:285:docs/stories/2.4.1-document-persistence-integrity-fix.md
metadata_list = [{ ... "document_id": str(document_id) ... } for _ in chunks_result.chunks]
```
- **Test**: L409-L411 (unit), L458-L461 (integration)
- **Migrazioni**: L576-L577 (FK su `document_id`)

### AC3 — Idempotenza inserimento documento via `ON CONFLICT`
- **Definizione**: L100-L116
- **Implementazione**: L182-L194 (upsert), L196-L209 (ritorno id), L258-L260 (hash)
- **Test**: L405-L406, L420-L447 (unit)

### AC4 — Endpoint integra creazione documento e ritorna `document_id`
- **Definizione**: L118-L131
- **Implementazione**: L244-L246 (rate limit + route), L265-L275 (save), L295-L298 (response con `job_id=document_id`)
- **Test**: L458-L460 (integration)

### AC5 — Unblocking Story 4.4 con `chunk_count > 0`
- **Definizione**: L133-L145
- **Implementazione**: dipende da AC1-AC2 end-to-end (L258-L293)
- **Test**: L471-L496 (E2E pending), L510-L511 (DoD pending)

## Artefatti Collegati
- **Codice**: L540-L548 (file creati/modificati)
- **Testing Config**: L747-L751
- **Rischi**: L383-L392 (mitigazioni incluse)
- **Migrazione retroattiva**: L618-L656

## Stato Tracciabilità
- **Unit Test**: 8/8 presenti (L507-L509)
- **Integration Test**: 4 definiti, esecuzione bloccata da lifespan (L455-L466, L509-L511)
- **E2E 4.4**: pending (L469-L496)
