# Requirements Traceability Matrix

## Story: 6.5 - LLM Generation Fix & E2E Validation

Source: docs/stories/6.5.llm-generation-fix-e2e-validation.md
Date: 2025-10-20
Reviewer: Quinn

### Coverage Summary

- Total Requirements: 5 (AC1–AC5)
- Fully Covered: 2 (40%)
- Partially Covered: 2 (40%)
- Not Covered: 1 (20%)

### Requirement Mappings

#### AC1: gpt-5-nano Temperature Configuration Fixed

- Description: Ensure ChatOpenAI with gpt-5-nano uses default temp (1.0) and does not accept override; document/config compatible.
- Coverage: PARTIAL
- Unit Test: apps/api/tests/test_rag_e2e_complete.py:260
  - Given: Settings with openai_model=gpt-5-nano and openai_temperature_chat=0.5
  - When: get_llm() is invoked
  - Then: Temperature override is not applied for nano (logic path verified)
- Gap: Direct assertion of temperature on ChatOpenAI not feasible; rely on logic and logs. Implement nano-guard in apps/api/api/services/chat_service.py:get_llm and add logging assertion if possible.

#### AC2: Generation Chain Operational with gpt-5-nano

- Description: Manual validation of generation endpoint, proper context and citations, error handling.
- Coverage: PARTIAL
- E2E Test: apps/api/tests/test_rag_e2e_complete.py:260
  - Given: Uploaded doc with embeddings and created session
  - When: POST /api/v1/chat/sessions/{sessionId}/messages with question
  - Then: 200 OK, non-empty answer, citations present
- Gap: Error handling edge cases (missing chunks, invalid session_id, empty question) not separately covered; add targeted integration tests.

#### AC3: Complete E2E RAG Pipeline Test

- Description: Full pipeline validation with real OpenAI, retry/backoff, p0 and e2e markers.
- Coverage: FULL
- E2E Test: apps/api/tests/test_rag_e2e_complete.py:1
  - Given: RUN_E2E_REAL=1 and OpenAI credentials available
  - When: Upload doc → wait for embeddings → search → generate
  - Then: Coherent answer with citations; structured logs and metrics recorded
- Notes: Skip gated when RUN_E2E_REAL!=1 per policy; retry/backoff implemented with special 429 handling.

#### AC4: Configuration Documentation Updated

- Description: Update architecture docs and .env.example with gpt-5-nano guidance.
- Coverage: NONE
- Gap: Documentation changes not yet implemented; create docs/architecture/llm-configuration.md and update .env.example accordingly.

#### AC5: Error Handling & Logging

- Description: Clear errors on missing API key, structured generation metrics, rate limit handling, alerts.
- Coverage: PARTIAL
- E2E Artifacts: apps/api/tests/test_rag_e2e_complete.py:24
  - Given: Reporter initialized for test
  - When: Generation completes or fails
  - Then: Logs and JSON reports written to reports/e2e/* with required fields (latency, tokens, cost, citations, retry_count)
- Gap: Application-level logging hooks for generation path not shown; enhance chat_service or route handlers to emit structured logs during normal operation.

### Critical Gaps

1. AC4 Documentation updates missing
   - Severity: Medium
   - Suggested test: Documentation review checklist or lint check for .env.example entries

2. AC2 Error handling edge cases
   - Severity: Medium
   - Suggested tests: Add unit/integration tests for invalid session_id, empty question, and missing chunks

### Test Design Recommendations

- Add integration tests covering generation error conditions and status codes.
- Add assertion for nano temperature decision in logs; consider exposing config decision for easier testing.
- Register pytest markers if not already in pytest.ini; ensure CI respects RUN_E2E_REAL gate.

### Risk Assessment

- High Risk: None
- Medium Risk: Missing docs (AC4); incomplete error-path tests (AC2)
- Low Risk: AC3 covered and gated; AC1 guarded via logic and classifier precedent

---

Gate YAML (copy/paste):

```yaml
trace:
  totals:
    requirements: 5
    full: 1
    partial: 3
    none: 1
  planning_ref: 'docs/qa/assessments/6.5-test-design-20251020.md'
  uncovered:
    - ac: 'AC4'
      reason: 'Documentation updates not implemented'
  notes: 'See docs/qa/assessments/6.5-trace-20251020.md'
```

Trace matrix: qa.qaLocation/assessments/6.5-trace-20251020.md

