# Test Design – Story 5.3: Test Suite Modernization & Legacy Test Migration

Data: 2025-10-09  
Owner: QA/Architecture  
Fonte: `docs/stories/5.3-test-suite-modernization.md`, `docs/qa/gates/story-5.2-gate.yaml`, `docs/qa/assessments/5.2-nfr-20251009.md`

---

## 1. Obiettivi di Test

- Verificare la migrazione di 138 test legacy verso fixture moderne (`client_admin`, `client_student`, `client_no_auth`).
- Dimostrare isolamento dei test (assenza di RL pollution, auth override coerenti, fixture FK consolidate).
- Raggiungere e dimostrare ≥80% pass rate su 204 test, coverage ≥65%.
- Confermare backward compatibility della Story 5.2 (AC8 → FULL).

---

## 2. Scope

IN SCOPE:
- Test root legacy: `tests/test_admin_debug.py`, `tests/test_analytics.py` (endpoints), `tests/test_document_explorer.py`, `tests/test_classify.py`, `tests/test_chat_query.py`, fixture duplicate in `routers/test_auth.py`.
- Router fix `/classify`: split router e registrazione in `main.py`.

OUT OF SCOPE:
- E2E frontend (Playwright).
- Ingestion pipeline integrazione (se env non configurato) – marcati `@integration`.

---

## 3. Strategia di Test

- Approccio incrementale per file con esecuzione immediata (`pytest tests/test_<file>.py -v`).
- Uso sistematico di fixture moderne per endpoint tests.
- Mock/patch per dipendenze esterne (LLM, Supabase) dove richiesto.
- Grep/analisi per rimozione import obsoleti e fixture duplicate.
- Controllo RL store prima/dopo i test.

---

## 4. Casi di Test (Selezione e Priorità)

### 4.1 Admin Debug (Alta Priorità)
- TD-ADM-001: 401 senza token (client_no_auth) → 401
- TD-ADM-002: 403 con ruolo student (client_student) → 403
- TD-ADM-003: 200 con admin (client_admin) e mock search/LLM → 200, chunks, timing
- TD-ADM-004: 429 all’11ª richiesta (client isolato) → 429
- TD-ADM-005: 400 domanda vuota → 400
- TD-ADM-006: LLM failure fallback → 200 con fallback
- TD-ADM-007: Audit log evento presente → log contains event

### 4.2 Analytics (Alta Priorità)
- TD-ANL-001: 403 non-admin (client_student) → 403
- TD-ANL-002: 200 admin (client_admin) → struttura overview/top/feedback/performance
- TD-ANL-003: Rate limit 30/h enforcement con store pulito → 429

### 4.3 Documents (Alta Priorità)
- TD-DOC-001: GET /admin/documents admin → 200
- TD-DOC-002: GET /admin/documents non-admin → 403
- TD-DOC-003: GET /admin/documents/{id}/chunks admin → 200 con filtri e sort

### 4.4 Classify (Media Priorità)
- TD-CLF-001: POST /classify 200 con mock LLM/chain
- TD-CLF-002: POST /classify 400 testo vuoto

### 4.5 Chat Query (Media Priorità)
- TD-CHT-001: POST /api/v1/chat/query 200 con mocks
- TD-CHT-002: RL 429 con store pulito e key deterministica

### 4.6 Auth/Token Fixture (Media Priorità)
- TD-AUT-001: Nessuna fixture duplicata in file di test (solo in conftest)
- TD-AUT-002: 0 FK constraint errors in auth/student_tokens

---

## 5. Dati di Test e Fixture

- Fixture moderne: `client_admin`, `client_student`, `client_no_auth` da `tests/conftest.py`.
- RL store: `rate_limit_service._store.clear()` in setup/teardown di fixture client.
- FK: `student_token_in_db`, `refresh_token_in_db` solo in `conftest.py`.
- Mock esterni: `perform_semantic_search`, `ChatOpenAI` per admin_debug/classify; Supabase client mock dove necessario.

---

## 6. Criteri di Esecuzione

- Ambiente locale con `poetry` e dipendenze backend.
- Comandi:
```powershell
cd apps/api
poetry run pytest tests/ -v --tb=short --maxfail=50
poetry run pytest tests/ --cov=api --cov-report=term-missing --cov-report=html
```

- Marcatori: `@integration` per test che richiedono env esterno.

---

## 7. Copertura Attesa

- Pass rate: da 25.9% → ≥80%
- Coverage: da 62% → ≥65%
- Assenza di: 404 `/classify`, 401 documents/admin con fixture moderne, 23503 FK, RL pollution intermittenti.

---

## 8. Exit Criteria

- ≥164/204 test passed.
- Coverage ≥65%.
- 0 FK errors, 0 RL pollution failures.
- Nessun import obsoleto `from api.main` (eccetto `app`).
- Gate 5.2 aggiornato con metriche finali; NFR 5.2 → PASS.

---

## 9. Tracciabilità

- Requisiti: Story 5.3 (AC1–AC6), Gate 5.2 (test_metrics), NFR 5.2.
- Mapping: TD-* ↔ AC*
  - TD-ADM-*, TD-ANL-*, TD-DOC-* ↔ AC1/AC2/AC6
  - TD-CLF-* ↔ AC4
  - TD-CHT-* ↔ AC1/AC2
  - TD-AUT-* ↔ AC3/AC5

---

## 10. Pianificazione

- Fase 1 (2.5h): Admin, Analytics (endpoints), Documents.
- Fase 2 (2h): Classify, Chat, FK consolidamento.
- Fase 3 (1.5h): Suite completa, coverage, documentazione.

---

## 11. Reporting

- Output:
  - Report pytest (pass/fail per file)
  - Coverage report (term + htmlcov)
  - Aggiornamento: `docs/qa/gates/story-5.2-gate.yaml`, `docs/qa/assessments/5.2-nfr-20251009.md`

---

## 12. Approvals

- QA Lead: PENDING  
- Tech Lead: PENDING  
- Product: PENDING
