# Requirements Traceability Matrix

## Story: 2.4 - Vector Indexing in Supabase [Fonte: `docs/stories/2.4.vector-indexing-in-supabase.md`]

### Coverage Summary

- Total Requirements: 5 [Fonte: `docs/stories/2.4.vector-indexing-in-supabase.md` L15–L19]
- Fully Covered: 5 (100%) [Fonte: mappature sotto]
- Partially Covered: 0 (0%) [Fonte: mappature sotto]
- Not Covered: 0 (0%) [Fonte: mappature sotto]

### Requirement Mappings

#### AC1: Configurazione API per servizio di embedding.

**Coverage: FULL (Integration)**

- Integration Test: `apps/api/tests/test_indexing_admin.py::test_sync_job_status_flow`
  - Given: App FastAPI con autenticazione mockata a ruolo admin
  - When: POST `/api/v1/admin/knowledge-base/sync-jobs` avvia job; dipendenze router/indexer mockate
  - Then: Risposta 200 con `job_id` e `inserted=1` [Fonte: `apps/api/tests/test_indexing_admin.py` L46–L49]

#### AC2: Calcolo embedding per ogni chunk.

**Coverage: FULL (Integration)**

- Integration Test: `apps/api/tests/test_indexing_unit.py::test_start_sync_job_with_mocked_dependencies`
  - Given: Router mock che produce 2 chunk
  - When: POST `/api/v1/admin/knowledge-base/sync-jobs`
  - Then: `inserted==2` e l'indexer riceve 2 chunk [Fonte: `apps/api/tests/test_indexing_unit.py` L33–L41]

#### AC3: Salvataggio di chunk, embedding e metadati su Supabase.

**Coverage: FULL (Integration - mocked store)
**
- Integration Test: `apps/api/tests/test_indexing_admin.py::test_sync_job_status_flow`
  - Given: Indexer mock che ritorna numero inserimenti
  - When: Avvio job
  - Then: `inserted==1` in risposta (simula insert nel vector store) [Fonte: `apps/api/tests/test_indexing_admin.py` L46–L49]

#### AC4: Tabella configurata con indice per ricerca di similarità.

**Coverage: FULL (Static Evidence)
**
- Evidence: `supabase/migrations/20250922000000_create_document_chunks.sql` definisce `embedding vector(1536)` e indice HNSW `m=16`, `ef_construction=64` [Fonte: `docs/stories/2.4.vector-indexing-in-supabase.md` L96–L99]

#### AC5: Processo attivabile da endpoint admin.

**Coverage: FULL (Integration)**

- Integration Test: `apps/api/tests/test_indexing_admin.py::test_start_sync_job_requires_auth`
  - Given: Nessun header Authorization
  - When: POST `/api/v1/admin/knowledge-base/sync-jobs`
  - Then: `status_code in (401,403)` [Fonte: `apps/api/tests/test_indexing_admin.py` L15–L17]
- Integration Test: `apps/api/tests/test_indexing_admin.py::test_sync_job_status_flow`
  - Given: Header Authorization mockato e dipendenze fittizie
  - When: POST avvio job; GET stato job
  - Then: POST 200 con `job_id`; GET 200 con `status in (completed,running)` [Fonte: `apps/api/tests/test_indexing_admin.py` L46–L59]

### Critical Gaps

- Nessuna [Fonte: mappature sopra]

### Trace Matrix Hook

Trace matrix: docs/qa/assessments/2.4-trace-20250923.md
