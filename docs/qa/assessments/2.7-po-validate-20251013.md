# PO Validation – Story 2.7: Hardening di Sicurezza e Ottimizzazione Performance del Database Supabase

Data: 2025-10-13  
Validator: Sarah (Product Owner)  
Fonte story: docs/stories/2.7.database-hardening-and-performance.md  
Stato story: In Progress – High Priority

## Executive Summary

La storia rimane incompleta per l’avvio o la prosecuzione dello sviluppo. Il fallimento noto della suite `pytest` (ImportError) non è gestito nei task, manca la sezione `Dev Notes` prevista dal template e alcune istruzioni operative restano ambigue (ad es. placeholder `<fn_signature>` e checklist MFA in contrasto con il vincolo di piano Supabase). Con queste lacune il rischio di blocco per il dev agent è elevato: esito **NO-GO** finché non vengono corretti i punti critici sotto elencati.

## Template Compliance Issues

- La storia non include la sezione `## Dev Notes` (né la sotto-sezione `Testing`) richiesta da `.bmad-core/templates/story-tmpl.yaml`; le informazioni di contesto sono distribuite altrove ma non rispettano la struttura attesa per i dev agent.

## Critical Issues (Must Fix – Story Blocked)

1. **Gestire la failure `pytest` documentata nei report**  
   - Evidenza: la suite fallisce con `ImportError: cannot import name 'access_codes_store' from 'api.main'` (`docs/reports/db-hardening-validation.md:155`).  
   - Problema: nessun task/subtask in `docs/stories/2.7.database-hardening-and-performance.md` affronta la correzione dell’import o l’aggiornamento dei test, pur essendo requisito AC6.1.  
   - Azione richiesta: aggiungere un task esplicito (es. in Fase 0 o Fase 1) per correggere il modulo di test o riallineare `api.main`, indicando file coinvolti e strategia di risoluzione.

## Should-Fix Issues (Quality Improvements)

1. **Ripristinare la sezione `Dev Notes` con sotto-sezione `Testing`**  
   - Motivazione: la mancanza viola il template e costringe il dev agent a ricostruire riferimenti architetturali da altri documenti.  
   - Suggerimento: reintrodurre `## Dev Notes` con sintesi di architettura, source tree e standard di test pertinenti.

2. **Sostituire il placeholder `<fn_signature>` con le firme reali**  
   - Riferimento: `docs/stories/2.7.database-hardening-and-performance.md:78-79`.  
   - Senza le firme (`public.populate_document_id_from_metadata()`, `public.update_updated_at_column()`, `public.match_document_chunks(...)`), il dev deve investigare manualmente; fornire esempi completi per `REVOKE EXECUTE` riduce ambiguità.

3. **Allineare la checklist MFA con la limitazione Passkeys del piano Supabase**  
   - Riferimenti: nota sulla non disponibilità `docs/reports/db-hardening-validation.md:164` vs. Step 3 della checklist `docs/reports/db-hardening-validation.md:170` che chiede comunque di abilitare Passkeys.  
   - Azione: aggiornare il task/checklist a indicare chiaramente la mitigazione alternativa (TOTP + documentazione limitazione) senza imporre un toggle inesistente.

4. **Chiarire dove archiviare gli output aggiornati della suite di test**  
   - Il piano test cita file storici (`reports/test-backend-20251013.log`, ecc.), ma non indica dove salvare l’esecuzione che dovrà risultare PASS dopo la correzione dell’import. Aggiungere percorsi aggiornati o rinominare i file target per evitare conflitti.

## Nice-to-Have Improvements

- Integrare nella sezione Deliverables un riferimento diretto ai nuovi report prodotti (`reports/metrics-p95-*.md`, log pytest post-fix, export Auth) per chiudere il cerchio documentale.
- Aggiungere alle attività la verifica automatizzata degli ACL delle funzioni (`pg_proc.proacl`) per dare visibilità sul risultato del `REVOKE`.
- Specificare la procedura per rigenerare gli screenshot Auth (tool, percorso archiviazione) così da mantenere standard uniforme.

## Anti-Hallucination Findings

- Tutte le affermazioni tecniche della story trovano riscontro nei report di hardening (`docs/reports/db-hardening-validation.md`) e nei piani associati (`docs/reports/db-vector-extension-migration-plan.md`, `docs/reports/postgres-upgrade-plan.md`); non emergono invenzioni di librerie o comandi.
- Tuttavia, l’assenza della sezione `Dev Notes` costringe a consultare file esterni: è fondamentale reintegrare i riferimenti chiave (ad es. percorsi sorgente FastAPI, standard di test) direttamente nella story.

## Dev Agent Implementation Readiness

- **Completezza del contesto:** Media – molte informazioni esistono ma sono disperse; senza `Dev Notes` l’agente dovrà esplorare altre fonti.  
- **Chiarezza operativa:** Bassa per AC6 (test suite) finché non viene descritto come risolvere l’ImportError.  
- **Test instructions:** Buone per la parte SQL/RLS, ma serve chiarezza sugli artefatti da produrre dopo la fix dei test e sulle soglie MFA.  
- **Gap principali:** task mancante per la failure pytest; template non rispettato; checklist MFA da correggere.

## Final Assessment

- **Decisione:** NO-GO  
- **Implementation Readiness Score:** 6/10  
- **Confidence Level:** Medium – la story potrà diventare attuabile rapidamente una volta indirizzati i punti elencati, ma allo stato attuale rischia di bloccare lo sviluppo.

## Action Items (prima di ri-aprire lo sviluppo)

- [ ] Aggiungere un task esplicito per correggere l’`ImportError` di pytest e aggiornare i log target (AC6.1).  
- [ ] Reintrodurre `## Dev Notes` con sotto-sezione `Testing`, includendo riferimenti architetturali essenziali.  
- [ ] Sostituire `<fn_signature>` con firme reali in tutte le istruzioni `REVOKE` (AC4).  
- [ ] Aggiornare la checklist MFA affinché rifletta la non disponibilità delle Passkeys e descriva la mitigazione documentata.  
- [ ] (Opzionale) Integrare Deliverables con i nuovi report/log/screenshot previsti post-hardening.
