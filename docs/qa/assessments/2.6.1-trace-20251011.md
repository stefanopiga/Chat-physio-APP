# Traceability — Story 2.6.1: Production Infrastructure Critical Fixes

Date: 2025-10-11
Epic: 2 — Core RAG Knowledge Pipeline
Story: 2.6.1 — Production Infrastructure Critical Fixes (P1)

## Scope
- Fix P1 blockers detected in Story 2.6: DB connectivity, Redis durability, Traefik `/health` routing.
- Validate infrastructure health and produce troubleshooting/documentation artifacts.

## Requirements → Tests (Given–When–Then)

- AC1 — Database Connectivity Validated
  - Given a valid `.env` with Supabase Pooler URL (port 6543, sslmode=require)
  - When the script `scripts/validation/database_connectivity_test.py` runs under Poetry in `apps/api`
  - Then connection succeeds and returns `[OK] Database connection: SUCCESS`
  - Evidence:
    - Command: `cd apps/api && poetry run python ../../scripts/validation/database_connectivity_test.py`
    - Output: success (latest run 2025-10-11)
    - Doc: `docs/troubleshooting/database-connectivity.md`

- AC1b — Database Integrity Audit Unblocked
  - Given the same environment
  - When `python scripts/validation/database_integrity_audit.py` executes
  - Then the report is generated with Overall Status OK and zero NULL embeddings
  - Evidence:
    - Report: `docs/reports/rag-database-integrity.md` (OK)
    - JSON: `temp/database_integrity_report.json`

- AC2 — Redis Data Persistence Configured
  - Given `docker-compose.yml` with `redis_data` volume and `redis-server --appendonly yes`
  - When a key is set, the service is restarted (and full stack restart executed)
  - Then the key persists and AOF artifacts are present
  - Evidence:
    - Commands: `redis-cli SET/GET`, `docker compose restart redis`, `docker compose down && up -d`
    - Files: `/data/appendonlydir/*` inside container
    - Doc: `docs/troubleshooting/docker-infrastructure.md`

- AC3 — Traefik Health Endpoint Routing Fixed
  - Given the `api-health-router` with priority 150
  - When `curl http://localhost/health` is requested
  - Then response is HTTP 200 with JSON body `{"status":"ok"}`
  - Evidence:
    - Labels in `docker-compose.yml`
    - Doc: `docs/troubleshooting/traefik-routing.md`

- AC4 — Full Infrastructure Health Check PASS
  - Given all services are up
  - When `python scripts/validation/docker_health_check.py` runs
  - Then `docs/reports/rag-infrastructure-health.md` shows Overall Status: PASS
  - Evidence:
    - Report: `docs/reports/rag-infrastructure-health.md`

- AC5 — Documentation Updated
  - Given the fixes are implemented
  - When readiness documents and troubleshooting are updated
  - Then `docs/reports/rag-production-readiness-summary.md` reflects READY with P1 resolved, and troubleshooting docs exist
  - Evidence:
    - Readiness: `docs/reports/rag-production-readiness-summary.md`
    - Troubleshooting: `docs/troubleshooting/*`

## Test Artifacts
- Scripts
  - `scripts/validation/database_connectivity_test.py`
  - `scripts/validation/database_integrity_audit.py`
  - `scripts/validation/docker_health_check.py`

- Reports
  - `docs/reports/rag-database-integrity.md`
  - `docs/reports/rag-infrastructure-health.md`
  - `docs/reports/rag-production-readiness-summary.md`

## Trace Matrix (Summary)
- AC1 → Connectivity script PASS; audit unblocked and PASS
- AC2 → Redis volume + AOF verified; persistence across restarts
- AC3 → `/health` JSON via Traefik; router priority in place
- AC4 → Infra health PASS
- AC5 → Readiness updated; troubleshooting docs present

## Decision
- Trace status: COMPLETE (all ACs mapped to concrete validations and evidence)

