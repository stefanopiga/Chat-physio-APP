# Test Design — Story 3.5: In-App User Guide

## Riferimenti
- Fonte primaria: `docs/stories/3.5.in-app-user-guide.md`
- Profilo rischi: `docs/qa/assessments/3.5-risk-20250930.md`
- Guida implementativa Dialog: `docs/architecture/addendum-shadcn-dialog-implementation.md`
- Requisiti accessibilità: `docs/front-end-spec.md` Sez. 7 L227–L243
- Vincoli UI/Dev: `docs/prompt-for-lovable_V0.md` L50–L55, L59
- Contenuti guida: `Guida-Rapida-a-FisioRAG.md`
- Prerequisito tecnico: `docs/stories/tech.refactoring-tailwind-shadcn.md` (Status: Done)

## Gating / Prerequisiti (Bloccanti)

PREREQUISITO TECNICO COMPLETATO: [Fonte: `docs/stories/tech.refactoring-tailwind-shadcn.md` L3]

- Componente Dialog Shadcn/UI installato: `npx shadcn@latest add dialog`. [Fonte: `docs/architecture/addendum-shadcn-dialog-implementation.md` Sez. 5]
- Componente `HelpModal` implementato con `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription`. [Fonti: `docs/stories/3.5.in-app-user-guide.md` L50; `docs/architecture/addendum-shadcn-dialog-implementation.md` Sez. 1]
- Entry point UI: icona "Aiuto" come `DialogTrigger asChild` con `Button` e `aria-label="Apri guida"`. [Fonti: `docs/stories/3.5.in-app-user-guide.md` L47; `docs/architecture/addendum-shadcn-dialog-implementation.md` Sez. 1]
- Theming: Dialog utilizza variabili semantiche (`bg-background`, `text-foreground`, `bg-card`, `text-muted-foreground`). [Fonti: `docs/architecture/addendum-shadcn-dialog-implementation.md` Sez. 4; `docs/prompt-for-lovable_V0.md` L50–L53]

## Obiettivi di Test

Priorità basata su Risk Profile (R-3.5-1 a R-3.5-5): [Fonte: `docs/qa/assessments/3.5-risk-20250930.md`]

### High Priority (Must-Fix)
1. **Accessibilità Dialog Completa** (R-3.5-1): Verificare role="dialog", focus trap, aria-labelledby, chiusura con Esc e click outside. [Fonte: `docs/qa/assessments/3.5-risk-20250930.md` L40]
2. **Theming Light/Dark** (R-3.5-2): Verificare rendering corretto in entrambi i temi senza colori hard-coded. [Fonte: `docs/qa/assessments/3.5-risk-20250930.md` L41]

### Medium Priority (Monitor)
3. **Test E2E Modale** (R-3.5-3): Verificare apertura/chiusura e presenza contenuti. [Fonte: `docs/qa/assessments/3.5-risk-20250930.md` L42]
4. **Focus Management** (R-3.5-4): Verificare focus trap e ritorno a trigger alla chiusura. [Fonte: `docs/qa/assessments/3.5-risk-20250930.md` L43]

### Low Priority (Continuous)
5. **Posizionamento Icona** (R-3.5-5): Verificare visibilità e tab-order logico. [Fonte: `docs/qa/assessments/3.5-risk-20250930.md` L44]

## Componenti Rilevanti

- `ChatPage`: container icona "Aiuto". [Fonte: `docs/stories/3.5.in-app-user-guide.md` L48–L49]
- `HelpModal`: dialog con contenuti guida (Shadcn/UI Dialog component). [Fonte: `docs/stories/3.5.in-app-user-guide.md` L50–L52]
- Contenuti testuali: base da `Guida-Rapida-a-FisioRAG.md`. [Fonte: `docs/stories/3.5.in-app-user-guide.md` L62]

## Strategia di Testing

### Integration Tests (Component-level)
- Mock minimo; focus su interazioni, attributi ARIA, variabili CSS semantiche.
- Verifica rendering condizionale (modale aperta/chiusa).
- Test stato focus con jsdom/Testing Library.

### E2E Tests (End-to-End)
- Playwright: verifica completa apertura/chiusura, navigazione tastiera, contenuti testuali.
- Test theming: switch Light/Dark durante sessione, verifica assenza regressioni visive.
- Test screen reader (manuale): NVDA/VoiceOver annunciano ruolo dialog e contenuto.

[Fonti: `docs/stories/3.5.in-app-user-guide.md` L53–L56; `docs/front-end-spec.md` L243–L248]

## Casi di Test

### AC1 — Icona "Aiuto" Visibile e Accessibile

**TC-001** — Rendering icona come button con aria-label
- **Given**: Utente autenticato su `/chat`
- **When**: Pagina caricata
- **Then**: Icona "Aiuto" renderizzata come `<button aria-label="Apri guida">`
- **Priority**: Medium (R-3.5-5)
- **Fonti**: `docs/stories/3.5.in-app-user-guide.md` L15, L66

**TC-002** — Icona raggiungibile via tastiera
- **Given**: Utente su `/chat`
- **When**: Navigazione con `Tab`
- **Then**: Focus visibile su icona "Aiuto"; attivazione con `Enter`/`Space`
- **Priority**: Medium (R-3.5-5)
- **Fonte**: `docs/front-end-spec.md` L233, L236

**TC-003** — Posizionamento non intrusivo
- **Given**: Utente su `/chat` con modale chiusa
- **When**: Verifica visiva su viewport desktop/mobile
- **Then**: Icona visibile in area header/toolbar, non sovrapposta a contenuti principali
- **Priority**: Low (R-3.5-5)
- **Fonte**: `docs/qa/assessments/3.5-risk-20250930.md` L44

### AC2 — Apertura/Chiusura Modale Guida

**TC-010** — Apertura modale con role="dialog"
- **Given**: Icona "Aiuto" visibile
- **When**: Click su icona
- **Then**: Modale appare con `role="dialog"` e `aria-labelledby` corretto
- **Priority**: High (R-3.5-1)
- **Fonti**: `docs/stories/3.5.in-app-user-guide.md` L16; `docs/qa/assessments/3.5-risk-20250930.md` L40

**TC-011** — Chiusura con Esc
- **Given**: Modale aperta
- **When**: Pressione `Esc`
- **Then**: Modale chiusa; focus ritorna all'icona trigger
- **Priority**: High (R-3.5-1, R-3.5-4)
- **Fonti**: `docs/stories/3.5.in-app-user-guide.md` L52; `docs/front-end-spec.md` L240

**TC-012** — Chiusura con click outside
- **Given**: Modale aperta
- **When**: Click su area overlay/backdrop
- **Then**: Modale chiusa; focus ritorna all'icona trigger
- **Priority**: High (R-3.5-1, R-3.5-4)
- **Fonte**: `docs/stories/3.5.in-app-user-guide.md` L52

**TC-013** — Focus trap attivo durante apertura
- **Given**: Modale aperta
- **When**: Navigazione con `Tab` / `Shift+Tab`
- **Then**: Focus rimane all'interno del dialog; non esce su elementi sottostanti
- **Priority**: High (R-3.5-1, R-3.5-4)
- **Fonte**: `docs/qa/assessments/3.5-risk-20250930.md` L40, L43

**TC-014** — Focus su primo elemento interattivo all'apertura
- **Given**: Modale chiusa
- **When**: Apertura modale
- **Then**: Focus si sposta automaticamente sul primo elemento interattivo del dialog (es. pulsante chiusura o contenuto)
- **Priority**: High (R-3.5-4)
- **Fonte**: `docs/front-end-spec.md` L236, L240

### AC3 — Contenuti Minimi Guida

**TC-020** — Sezione "Come Porre Domande" presente
- **Given**: Modale aperta
- **When**: Verifica contenuto testuale
- **Then**: Sezione con testo da `Guida-Rapida-a-FisioRAG.md` L6–L7 presente
- **Priority**: Medium (AC completion)
- **Fonti**: `docs/stories/3.5.in-app-user-guide.md` L18; `Guida-Rapida-a-FisioRAG.md` L6–L7

**TC-021** — Sezione "Come Funzionano le Fonti" presente
- **Given**: Modale aperta
- **When**: Verifica contenuto testuale
- **Then**: Sezione con testo da `Guida-Rapida-a-FisioRAG.md` L9–L10 presente
- **Priority**: Medium (AC completion)
- **Fonti**: `docs/stories/3.5.in-app-user-guide.md` L19; `Guida-Rapida-a-FisioRAG.md` L9–L10

**TC-022** — Sezione "Aiutaci a Migliorare" (Feedback) presente
- **Given**: Modale aperta
- **When**: Verifica contenuto testuale
- **Then**: Sezione con testo da `Guida-Rapida-a-FisioRAG.md` L12–L13 presente
- **Priority**: Medium (AC completion)
- **Fonti**: `docs/stories/3.5.in-app-user-guide.md` L20; `Guida-Rapida-a-FisioRAG.md` L12–L13

**TC-023** — Linguaggio chiaro e conciso
- **Given**: Modale aperta
- **When**: Revisione contenuti
- **Then**: Testo conforme a `Guida-Rapida-a-FisioRAG.md`; nessuna modifica semantica introdotta
- **Priority**: Medium (AC4)
- **Fonte**: `docs/stories/3.5.in-app-user-guide.md` L21

### AC4 — Accessibilità Dialog (ARIA e Keyboard)

**TC-030** — Attributi ARIA corretti su dialog e trigger
- **Given**: Modale chiusa e aperta
- **When**: Ispezione DOM
- **Then**: 
  - Dialog ha `role="dialog"`, `aria-labelledby` o `aria-label`
  - Icona trigger comunica stato con `aria-expanded` (se applicabile)
- **Priority**: High (R-3.5-1)
- **Fonti**: `docs/front-end-spec.md` L234, L240; `docs/qa/assessments/3.5-risk-20250930.md` L40

**TC-031** — Focus visibile su tutti controlli interattivi
- **Given**: Modale aperta
- **When**: Navigazione con `Tab`
- **Then**: Indicatori di focus chiari e visibili su pulsante chiusura e altri controlli
- **Priority**: High (R-3.5-1)
- **Fonti**: `docs/front-end-spec.md` L236; `docs/stories/3.5.in-app-user-guide.md` L44

**TC-032** — Screen reader annuncia dialog e contenuto
- **Given**: Screen reader attivo (NVDA/VoiceOver)
- **When**: Apertura modale
- **Then**: Screen reader annuncia ruolo dialog e contenuto testuale accessibile
- **Priority**: High (R-3.5-1)
- **Fonte**: `docs/front-end-spec.md` L239, L248

### AC5 — Theming Light/Dark

**TC-040** — Rendering corretto in tema Light
- **Given**: Tema Light attivo
- **When**: Apertura modale
- **Then**: Colori e contrasti conformi a palette Light; nessun colore hard-coded (verifica ispezione CSS)
- **Priority**: High (R-3.5-2)
- **Fonti**: `docs/stories/3.5.in-app-user-guide.md` L22; `docs/qa/assessments/3.5-risk-20250930.md` L41

**TC-041** — Rendering corretto in tema Dark
- **Given**: Tema Dark attivo
- **When**: Apertura modale
- **Then**: Colori e contrasti conformi a palette Dark; variabili semantiche (background, foreground, card) applicate
- **Priority**: High (R-3.5-2)
- **Fonte**: `docs/prompt-for-lovable_V0.md` L50–L53

**TC-042** — Switch tema durante sessione senza regressioni
- **Given**: Modale aperta in tema Light
- **When**: Switch a tema Dark
- **Then**: Modale aggiorna colori senza glitch; contrasto WCAG AA rispettato
- **Priority**: High (R-3.5-2)
- **Fonte**: `docs/front-end-spec.md` L232

**TC-043** — Assenza valori colore hard-coded
- **Given**: Implementazione HelpModal
- **When**: Revisione codice e CSS compilato
- **Then**: Nessun valore hex/rgb diretto; solo variabili CSS semantiche (es. `var(--background)`)
- **Priority**: High (R-3.5-2)
- **Fonte**: `docs/qa/assessments/3.5-risk-20250930.md` L41

## E2E (Prerequisiti e Best Practices)

### Setup Pre-Test
- Autenticazione: Impostare credenziali fittizie per accesso a `/chat` (se rotta protetta da `AuthGuard`). [Fonte: `docs/stories/3.3.frontend-chat-integration.md` L17–L25]
- Attese esplicite: Usare `waitForSelector` per visibilità icona e modale; timeout adeguato per animazioni. [Fonte: `docs/qa/review-qa-report-20250926.md` L46–L50]

### Scenari E2E Prioritari

**E2E-001** — Happy Path: Apertura e chiusura modale
1. Navigare a `/chat`
2. Click su icona "Aiuto"
3. Verificare modale visibile con `role="dialog"`
4. Pressare `Esc`
5. Verificare modale chiusa e focus su icona

**E2E-002** — Navigazione tastiera completa
1. Navigare a `/chat` 
2. `Tab` fino a icona "Aiuto"
3. `Enter` per aprire
4. `Tab` per navigare elementi interni
5. `Esc` per chiudere
6. Verificare focus ritorna a icona

**E2E-003** — Theming switch durante sessione
1. Navigare a `/chat` in tema Light
2. Aprire modale
3. Switch a tema Dark
4. Verificare modale renderizzata correttamente
5. Chiudere e riaprire
6. Verificare persistenza tema

[Fonte: `docs/stories/3.5.in-app-user-guide.md` L53–L56]

## Test Manuali (Pre-Release)

### Screen Reader Testing
- **Tool**: NVDA (Windows) o VoiceOver (macOS)
- **Scenari**:
  1. Navigazione con screen reader attivo: icona annunciata correttamente
  2. Apertura modale: ruolo dialog e contenuto annunciati
  3. Chiusura modale: conferma chiusura e ritorno focus
- **Criteria**: Conformità WCAG 2.1 AA per annunci e struttura semantica
- **Fonte**: `docs/front-end-spec.md` L248

### Visual Regression Testing
- **Scenari**: Rendering modale in Light/Dark su viewport desktop/mobile
- **Criteria**: Nessuna regressione visiva rispetto a baseline; contrasti rispettati
- **Fonte**: `docs/qa/assessments/3.5-risk-20250930.md` L41

## Monitoring Requirements

- **Build-time**: Linter accessibilità attivo (eslint-plugin-jsx-a11y) su `HelpModal` e `ChatPage`. [Fonte: `docs/qa/assessments/3.5-risk-20250930.md` L63]
- **CI/CD**: Test E2E Playwright eseguiti su PR e commit a main. [Fonte: medesima L64]
- **Manual**: Test screen reader prima di ogni release. [Fonte: medesima L65]

## Metriche

- **Coverage Target**: non disponibile nella fonte
- **Pass Rate Minimum**: 100% per High Priority tests (TC-010 a TC-014, TC-030 a TC-032, TC-040 a TC-043)
- **Performance**: Apertura modale < 200ms (animazione inclusa); nessun blocco UI durante rendering

## Gate Alignment

Questo test design è allineato al gate YAML: [Fonte: `docs/qa/assessments/3.5-risk-20250930.md` L71–L85]

```yaml
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 2
    low: 1
  recommendations:
    must_fix:
      - R-3.5-1: "Implementazione accessibilità dialog completa (role, focus trap, Esc, aria)"
      - R-3.5-2: "Theming Light/Dark con variabili semantiche (no hard-coded)"
    monitor:
      - R-3.5-3: "Test E2E per modale (apertura, chiusura, contenuti)"
      - R-3.5-4: "Focus management nel dialog"
```

## Review Hook

```
Test design: docs/qa/assessments/3.5-test-design-20250930.md
```
