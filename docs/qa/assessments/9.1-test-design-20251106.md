# Test Design — Story 9.1: Hybrid Memory Foundation

**Date:** 2025-11-06  
**Designer:** Quinn (Test Architect & Quality Advisor)  
**Story:** docs/stories/9.1-hybrid-memory-foundation.md

## Test Strategy Overview

- Total Test Scenarios: 46
- Unit Tests: 20
- Integration Tests: 18
- E2E Tests: 8

Priority split:
- P0 Critical: 16
- P1 High: 18
- P2 Medium: 10
- P3 Low: 2

Rationale: The story introduces dual-write async persistence with circuit breaker, backpressure, and a durable outbox. Risk-based focus targets data integrity (idempotency, ordering), reliability under DB failures, and performance under load. Instrumentation is verified via metrics export and alertability.

---

## Test Scenarios by Acceptance Criteria

### AC1 — Architettura Hybrid Memory (L1 cache ultimi 3 turni; L2 DB completo)

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-UNIT-001   | Unit        | P0       | L1 cache mantiene esattamente 3 turni (push/pop policy)                     | CONSIST-001   |
| 9.1-UNIT-002   | Unit        | P0       | L1 eviction: aggiunta 4° turno rimuove il più vecchio                       | CONSIST-001   |
| 9.1-INT-001    | Integration | P0       | Dual-write: add_turn crea cache sync e enqueue write async                   | DATA-001      |
| 9.1-INT-002    | Integration | P1       | load_full_history legge da DB e ignora L1                                   | ORDER-001     |
| 9.1-E2E-001    | E2E         | P1       | Conversazione di 10 turni: UI mostra 3 in context, storico completo da DB   | CONSIST-001   |

### AC2 — Persistenza asincrona, backpressure, circuit breaker

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-UNIT-003   | Unit        | P0       | Bounded queue: MAX_PENDING_WRITES=100, rifiuta oltre soglia                 | PERF-001      |
| 9.1-UNIT-004   | Unit        | P0       | Drop oldest policy quando coda piena                                        | PERF-001      |
| 9.1-UNIT-005   | Unit        | P0       | Circuit breaker: CLOSED→OPEN dopo 3 failure consecutive                      | REL-001       |
| 9.1-UNIT-006   | Unit        | P0       | Circuit breaker: OPEN→HALF_OPEN dopo timeout con clock monotonic            | REL-001       |
| 9.1-INT-003    | Integration | P0       | Persistenza async con timeout 5s e raccolta metriche                         | PERF-001      |
| 9.1-INT-004    | Integration | P1       | Failure DB 3×: breaker OPEN, call successive fail-fast                       | REL-001       |
| 9.1-INT-005    | Integration | P1       | Recovery: HALF_OPEN 1 prova ok → chiude breaker                              | REL-001       |
| 9.1-E2E-002    | E2E         | P1       | Picco 200 messaggi: attiva backpressure e non degrada latenza UI             | PERF-001      |

### AC3 — Feature flag ENABLE_PERSISTENT_MEMORY con graceful degradation

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-UNIT-007   | Unit        | P0       | Flag OFF: manager opera in-memory only                                      | COMP-001      |
| 9.1-UNIT-008   | Unit        | P1       | Flag ON: abilita dual-write                                                  | COMP-001      |
| 9.1-INT-006    | Integration | P1       | Toggle runtime: persistenza passa ON/OFF senza errori                        | COMP-001      |
| 9.1-E2E-003    | E2E         | P1       | Flag OFF con DB down: UX invariata e zero error UI                           | REL-001       |

### AC4 — Indici DB ottimizzati

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-INT-007    | Integration | P1       | Migrazione crea i 4 indici richiesti                                         | IDX-001       |
| 9.1-INT-008    | Integration | P1       | Query storico sessione usa `idx_chat_messages_session_created`               | IDX-001       |
| 9.1-INT-009    | Integration | P2       | FTS italiano su content usa GIN                                              | IDX-001       |

### AC5 — Backward compatibility con Story 7.1 (short-term memory)

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-UNIT-009   | Unit        | P0       | get_context_window invariata                                                 | COMP-001      |
| 9.1-INT-010    | Integration | P1       | API esistenti continuano a servire risposte identiche a 7.1                  | COMP-001      |

### AC6 — Degradazione graceful a in-memory only se DB non disponibile

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-INT-011    | Integration | P0       | DB down: nessun crash, L1 continua a funzionare                               | REL-001       |
| 9.1-E2E-004    | E2E         | P0       | Sessione completa durante outage: messaggi salvati su outbox                 | OUTBOX-001    |

### AC7 — Metriche complete

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-UNIT-010   | Unit        | P1       | Emissione contatori db_writes_* e histogram db_write_latency_ms               | OBS-001       |
| 9.1-UNIT-011   | Unit        | P1       | Gauges cache_hits/cache_misses/active_sessions_count                          | OBS-001       |
| 9.1-INT-012    | Integration | P1       | Esposizione /metrics conforme (Prometheus)                                    | OBS-001       |
| 9.1-INT-013    | Integration | P2       | Alert rule sample su breaker e queue depth                                    | OPS-001       |

### AC8 — Coverage ≥80% per nuovi moduli

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-UNIT-012   | Unit        | P0       | Coverage threshold 80% in CI per moduli target                                | TEST-001      |
| 9.1-INT-014    | Integration | P1       | Report coverage aggregato include test concurrency e error paths               | TEST-001      |

### AC9 — Durable outbox con retry, idempotency, DLQ

| ID             | Level       | Priority | Scenario                                                                    | Risk Coverage |
|----------------|-------------|----------|-----------------------------------------------------------------------------|---------------|
| 9.1-UNIT-013   | Unit        | P0       | Calcolo idempotency key deterministico `sha256(session+ts+hash)`              | DATA-001      |
| 9.1-UNIT-014   | Unit        | P0       | ON CONFLICT DO NOTHING su chiave univoca                                      | DATA-001      |
| 9.1-UNIT-015   | Unit        | P0       | Backoff esponenziale 1s→60s, max 10 tentativi                                 | OUTBOX-001    |
| 9.1-UNIT-016   | Unit        | P1       | Spostamento in DLQ dopo max tentativi                                         | DLQ-001       |
| 9.1-INT-015    | Integration | P0       | Crash durante write outbox: file JSONL resta consistente                       | OUTBOX-001    |
| 9.1-INT-016    | Integration | P1       | Reingestione idempotente da DLQ                                               | DLQ-001       |
| 9.1-E2E-005    | E2E         | P1       | Outage DB prolungato → accumulo outbox, recovery success e zero duplicati     | DATA-001      |
| 9.1-E2E-006    | E2E         | P1       | Clock skew moderato: ordinamento corretto in storico sessione                 | ORDER-001     |

---

## Cross-Cutting Scenarios

- 9.1-UNIT-017 (P1): Redazione log messaggi (niente contenuto sensibile) — SEC-001
- 9.1-INT-017 (P1): Dashboard metriche mostra breaker/open e queue depth — OBS-001/OPS-001
- 9.1-E2E-007 (P1): Toggle flag in runtime non interrompe conversazione — COMP-001
- 9.1-E2E-008 (P2): Retention/archivio: query esclude archived correttamente — PRIV-001

## Test Data and Fixtures

- Synthetic conversation sessions con 1, 3, 10, 200 turni.
- Payload generator per messaggi random e contenuti ripetuti per test idempotency.
- DB test schema con indice unico su `idempotency_key` e indici da migrazione.
- Fault injection: mock pool che fallisce X volte; clock skew; fs crash per outbox.

## Tooling and Harness

- Python: pytest + pytest-asyncio, hypothesis (property-based) per idempotency e ordering.
- HTTP: httpx/pytest per API; snapshot testing risposte.
- Metrics: Prometheus client exporter; tests di scraping e validazione label set.
- Load: Locust/k6 per stress breve su persistenza async e latenza chat.

## Exit Criteria

- Tutti P0 e P1 passano; P2 accettabili con rationale.
- Coverage moduli target ≥ 80% con line/branch.
- Metriche exportate e dashboard/alert configurati (smoke test).
- Nessun duplicato in DB sotto carico e dopo outage.

---

Test design generated: docs/qa/assessments/9.1-test-design-20251106.md

