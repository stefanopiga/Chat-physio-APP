# Risk Profile — Story 6.4: RAG Activation — Embedding Generation for Watcher Pipeline

Data: 2025-10-20
Riferimento Story: docs/stories/6.4.rag-activation-embedding-generation-watcher.md
Ambito: AC1 (batch embeddings), AC2 (watcher indexing), AC2.5 (concurrency), AC3 (verifiche), AC4 (monitoring)

## Sintesi
- Stato attuale: ingestion completa (6.3), embeddings assenti ? RAG non funzionale.
- Obiettivo: abilitare embeddings sia in batch (arretrati) che in linea nel watcher, con coordinamento sicuro.
- Rischi principali: duplicazione/condizioni di gara, inconsistenza dati, costi OpenAI, rate limit, osservabilità insufficiente, regressioni pipeline.

## Assunzioni chiave
- OpenAI embeddings e Supabase Vector Store già funzionanti nell’API (riuso index_chunks).
- syncpg usato per connection management; standard advisory locks PostgreSQL disponibili.
- Celery disattivato per MVP; feature flag disponibile per attivazione futura.

## Mappa Rischi (Probabilità × Impatto ? Priorità)
1) Duplicati/Corruzione indici (batch vs watcher)	P: Alta	I: Alta	Priorità: Critica
- Causa: lock eterogenei, reindicizzazione di chunk già indicizzati.
- Impatti: risposte incoerenti, costi extra, difficoltà rollback.
- Mitigazione: AC2.5 advisory locks db-side con hashtext(); query WHERE embedding IS NULL; idempotenza dd_texts(); test concorrenza.

2) Race condition su stesso documento	P: Media	I: Alta	Priorità: Alta
- Causa: esecuzione parallela batch+watcher.
- Mitigazione: watcher pg_advisory_lock, batch pg_try_advisory_lock (skip se locked), finally unlock, log strutturato.

3) Costi e rate limit OpenAI	P: Media	I: Media/Alta	Priorità: Alta
- Causa: indicizzazione di 190+ chunk; retry con tenacity.
- Mitigazione: batching, backoff esponenziale, limiti QPS, metriche costo/chunk, finestra temporale pianificata.

4) Timeout o errori rete verso servizi esterni	P: Media	I: Media	Priorità: Media
- Mitigazione: retry index_chunks, circuit-breaker soft (skip e log), job di ripresa giornaliero.

5) Inconsistenza DB (transaction boundaries)	P: Bassa/Media	I: Alta	Priorità: Alta
- Mitigazione: atomicità salvataggio chunk (6.3), indexing separato con lock; validazioni di copertura embedding (AC3).

6) Osservabilità insufficiente	P: Media	I: Media	Priorità: Media
- Mitigazione: endpoint AC4, logs evento (watcher_indexing_complete/failed, atch_doc_indexed/skipped), metriche per documento.

7) Regressione pipeline ingestion (performance)	P: Bassa	I: Media	Priorità: Media
- Mitigazione: mantenere indexing fuori transazione ingestion; monitorare latenza scan_once; feature flag Celery per offloading.

8) Stabilità chiavi lock (hash)	P: Media	I: Alta	Priorità: Alta
- Rischio: uso di hash() Python non stabile.
- Mitigazione: usare solo hashtext() lato DB come da AC2.5.

9) Sicurezza segreti/config	P: Bassa/Media	I: Alta	Priorità: Media/Alta
- Mitigazione: validazione env (API keys, DB), least-privilege, no log di contenuti sensibili.

10) Allineamento semantico tra chunk e metadati	P: Bassa/Media	I: Media	Priorità: Media
- Mitigazione: metadata {document_id, source} coerenti; controlli su conteggi indicizzati.

## Verifiche/Oracoli di Test (traccia AC)
- AC1: batch script indicizza tutti i chunk NULL; report finale con conteggi per documento.
- AC2: watcher invoca index_chunks post-salvataggio; log di completamento/fallimento per iterazione.
- AC2.5: test concorrenza ? nessun duplicato (COUNT(id)=COUNT(DISTINCT id)), lock coordination nei log, copertura completa embeddings.
- AC3: diagnostica COUNT(embedding IS NOT NULL)=190; chat/semantic search restituisce risultati rilevanti con similarity_score = 0.6 almeno per 1 chunk.
- AC4: endpoint embedding-health espone coverage, breakdown per documento, timestamp ultimo indexing.

## Piano di Mitigazione Operativa
- Implementare prima AC2.5 (lock standardizzati), poi AC1/AC2.
- Eseguire batch in finestre non di picco; configurare rate limit/batch size.
- Attivare logging strutturato e dashboard minime (conteggi, tempi, fallimenti).
- Preparare runbook fallback: se watcher fallisce, batch giornaliero ripristina copertura.

## Decisione QA (Advisory)
- Gate: CONCERNS
- Bloccanti da chiudere prima di "Ready for QA Review":
  1) Verifica test concorrenza AC2.5 con evidenza log e query anti-duplicati.
  2) Evidenza AC3 (190/190 indicizzati) e test chat con citazioni non vuote.
  3) Endpoint AC4 funzionante con campi richiesti.

## Riferimenti
- docs/stories/6.4.rag-activation-embedding-generation-watcher.md
- docs/architecture/addendum-asyncpg-database-pattern.md (Pattern 6)
- PostgreSQL advisory locks docs
- apps/api/api/knowledge_base/indexer.py (index_chunks)
