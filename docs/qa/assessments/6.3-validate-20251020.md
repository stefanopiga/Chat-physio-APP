# Story Draft Validation — 6.3 Watcher Async Refactoring & DB-First Integration (Re-Run)

Date: 2025-10-20 05:02
Validator: Sarah (Product Owner)
Source: docs/stories/6.3.watcher-async-refactoring-db-integration.md

## Template Compliance

- Structure: Matches project story template (Status, Story, Context, Acceptance Criteria, Tasks, Dev Notes).
- Sections present: Yes — including Files list and Task sequencing.
- Placeholders: None. Note minor encoding artifacts in Context/Benefits (accented characters) — fix for readability.

## Critical Issues (Must Fix — Blockers)

- None blocking implementation. ACs are specific, measurable, and map to concrete files/functions.

## Should-Fix Improvements (Recommended Before Dev Freeze)

1) Paths and Test Locations
- Story references 	ests/...; actual repo uses pps/api/tests/... for test suite.
- Update AC4 and Tasks tables to reference pps/api/tests/*.py consistently.

2) Transactional Safety (AC2)
- Make explicit: wrap save_document_to_db + save_chunks_to_db + update_document_status in a single transaction: sync with conn.transaction(): ....

3) Idempotency & Uniqueness (AC2)
- Add requirement: unique constraint on (file_hash [, file_path]) to prevent duplicates; define behavior on conflict (skip/update) and log.

4) Observability Baseline (AC1/AC3)
- Specify minimum structured log fields: event, doc_id, ile, duration_ms, status, etries.
- Metrics: docs_processed, chunks_sec, error_rate, pool_acquire_ms.

5) Security Note (Runner)
- Least-privilege DB role for runner; forbid DROP/ALTER. Never log secrets.

## Nice-to-Have Enhancements

- Bounded concurrency guidance for watcher (e.g., max N concurrent files) and backpressure/queueing behavior.
- Rollback/cleanup policy for repeated failures (tombstone/mark failed with reason).
- Performance target: batched inserts outperform per-chunk by =30% in CI microbenchmarks.

## Acceptance Criteria Assessment

- AC1: Clear; ensure explicit error handling + structured logs.
- AC2: Clear; add single-transaction + idempotency clauses (above).
- AC3: Clear; add expected exit codes and timing metric.
- AC4: Clear; align fixture location to pps/api/tests/conftest.py.
- AC5: Clear; targets feasible.
- AC6: Clear; file list accurate.

## Anti-Hallucination Check

- Referenced modules exist: pps/api/api/ingestion/watcher.py, .../db_storage.py, .../database.py.
- Async tooling present: pytest-asyncio, syncpg in project.
- Test files live under pps/api/tests/ — adjust story references accordingly.

## Final Assessment

- Decision: GO (with Should-Fix updates)
- Implementation Readiness Score: 8.5/10
- Confidence Level: High

## Action Items

- [ ] Fix encoding artifacts in text
- [ ] Align test path references to pps/api/tests/...
- [ ] Add single-transaction requirement in AC2
- [ ] Add idempotency/unique constraint note in AC2
- [ ] Specify minimal logging + metrics fields
- [ ] Add least-privilege DB role note
