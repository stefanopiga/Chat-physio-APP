# Risk Profile: Story 4.2.3

Date: 2025-10-29
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 3
- Risk Score: 46/100

## Critical Risks Requiring Immediate Attention

No score-9 critical risks identified. Highest risks (score 6) listed under Priority 1 tests.

## Risk Distribution

### By Category

- Technical: 4 risks (0 critical, 2 high)
- Security: 0 risks (0 critical)
- Performance: 1 risk (0 critical)
- Data: 1 risk (0 critical)
- Business: 1 risk (0 critical)
- Operational: 0 risks (0 critical)

### By Component

- Backend (analytics aggregation): 5 risks
- Tests/Tooling: 1 risk
- Dashboard/Reporting: 1 risk

## Detailed Risk Register

| Risk ID   | Title                                                  | Category   | Probability | Impact | Score | Rationale |
|-----------|--------------------------------------------------------|------------|-------------|--------|-------|-----------|
| TECH-002  | Non 1:1 pairing user→assistant messages (edge cases)  | Technical  | Medium (2)  | High (3)  | 6 | Conversations with system/tool messages or retries may break naive next-index pairing |
| OPS-001   | Lack of monitoring for zero/flat feedback metrics      | Operational| High (3)    | Medium (2)| 6 | No alerting when feedback suddenly remains at 0, masking defects in production |
| TECH-003  | Insufficient test coverage on aggregation paths        | Technical  | High (3)    | Medium (2)| 6 | Current issue slipped past; need targeted unit tests for ID mapping and rates |
| TECH-001  | Incomplete fix leaves partial ID mismatches            | Technical  | Medium (2)  | Medium (2)| 4 | Multiple code paths access IDs; risk of missing one |
| BUS-001   | Erosion of trust in analytics                          | Business   | Medium (2)  | Medium (2)| 4 | Stakeholders rely on accurate metrics for decisions |
| PERF-001  | O(n×m) scans over feedback keys by substring           | Performance| Medium (2)  | Low (1)   | 2 | any(msg_id in key for key in keys) is linear and string-based |
| DATA-001  | Misaggregation yields misleading “problematic queries” | Data       | Low (1)     | High (3)  | 3 | If residual mapping bugs persist, lists become incorrect |

## Risk-Based Mitigations

- TECH-002 (score 6):
  - Strategy: preventive
  - Actions:
    - Pair user→assistant via iteration that explicitly links the immediate assistant reply only when roles match; skip non-assistant interleavings
    - Guard for streaming/system/tool messages; use indices and role checks instead of list.index on objects
    - Add unit tests covering: missing assistant reply, multiple assistants, inserted system messages
  - Testing Requirements:
    - Parametric tests with varied message sequences; negative/positive feedback present/absent
  - Residual Risk: Low

- OPS-001 (score 6):
  - Strategy: detective
  - Actions:
    - Add metric/alert: “feedback_conversion_rate == 0 for 24h” and “sum(feedback) unchanged 24h”
    - Log warnings when analytics aggregates 0 with non-empty stores
  - Testing Requirements:
    - Unit test for warning path; staging alert rule validation
  - Residual Risk: Low

- TECH-003 (score 6):
  - Strategy: preventive
  - Actions:
    - Implement tests listed in AC4 (problematic queries, feedback conversion)
    - Add regression over aggregate_analytics summary untouched by ID mapping
  - Testing Requirements:
    - Coverage ≥85% on modified functions
  - Residual Risk: Low

- TECH-001 (score 4):
  - Strategy: preventive
  - Actions:
    - Centralize helper: get_assistant_id_for_user_message(messages, i)
    - Single lookup utility to avoid divergence across functions

- BUS-001 (score 4):
  - Strategy: corrective
  - Actions:
    - Communicate the defect window and reprocess affected analytics if persisted data exists

- PERF-001 (score 2):
  - Strategy: preventive
  - Actions:
    - Build set of exact feedback keys for session for O(1) lookup
    - Avoid substring scans; compare exact keys `{session}:{msg_id}`

- DATA-001 (score 3):
  - Strategy: detective
  - Actions:
    - Add cross-check in report: negative feedback count equals sum over feedback_store filtered by session

## Risk-Based Testing Strategy

### Priority 1: High-Risk Tests (score 6)

- Edge-case pairing: sequences with system/tool messages between user and assistant
- Multiple assistants per user and missing assistant reply scenarios
- Monitoring hooks: unit test warning path when aggregates are zero but stores non-empty
- Test coverage: enforce AC4 tests and add parameterized variations

### Priority 2: Medium-Risk Tests (score 4)

- Validate central helper correctness across both aggregation functions
- Business sanity checks on dashboard percentages and totals

### Priority 3: Low-Risk Tests (score ≤3)

- Micro-benchmarks for feedback lookup optimization
- Data reconciliation checks between stores and aggregates

## Notes

- Prefer exact-key membership using a precomputed set of feedback keys for the current session to eliminate substring scans and reduce false positives.
- Extract shared logic for message pairing and reuse across analytics functions to avoid future divergence.
