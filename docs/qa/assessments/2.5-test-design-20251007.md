# Test Design: Story 2.5 - Intelligent Document Preprocessing & Pipeline Completion

**Date:** 2025-10-07  
**Designer:** Quinn (Test Architect)  
**Story ID:** 2.5  
**Story Title:** Intelligent Document Preprocessing & Pipeline Completion

## Test Strategy Overview

- **Total Test Scenarios:** 43
- **Unit Tests:** 18 (42%)
- **Integration Tests:** 17 (40%)
- **E2E Tests:** 8 (18%)
- **Priority Distribution:**
  - P0 Critical: 15 (35%)
  - P1 High: 18 (42%)
  - P2 Medium: 8 (19%)
  - P3 Low: 2 (4%)

### Test Strategy Rationale

Story 2.5 completes pipeline RAG critica con multiple componenti complesse:
- Extraction layer (PyMuPDF, python-docx)
- Classification LLM (8 domini fisioterapici)
- Batch embedding con retry logic
- Celery async processing
- Pipeline orchestration end-to-end

**Testing approach:** Defense in depth
- Unit tests: logic isolation (extraction, classification, retry)
- Integration tests: component interactions (pipeline steps, Celery tasks, DB)
- E2E tests: critical journeys (document upload → search → chat)

**Risk-based focus:** 2 critical risks (DATA-001, OPS-001) richiedono coverage estensivo

---

## Test Scenarios by Acceptance Criteria

### AC1: Pre-processing automatico riconosce estensione file e applica extractor appropriato

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                    | Justification                          | Risk Coverage |
|---------------|-------------|----------|--------------------------------------------------|----------------------------------------|---------------|
| 2.5-UNIT-001  | Unit        | P0       | File type detection - PDF extension              | Core logic, fast feedback              | TECH-001      |
| 2.5-UNIT-002  | Unit        | P0       | File type detection - DOCX extension             | Core logic validation                  | TECH-001      |
| 2.5-UNIT-003  | Unit        | P0       | File type detection - TXT extension              | Core logic completeness                | -             |
| 2.5-UNIT-004  | Unit        | P1       | File type detection - unsupported extension      | Error handling                         | TECH-004      |
| 2.5-UNIT-005  | Unit        | P2       | File type detection - no extension               | Edge case                              | TECH-004      |
| 2.5-INT-001   | Integration | P0       | Extractor routing - PDF to PyMuPDF               | Component interaction                  | TECH-001      |
| 2.5-INT-002   | Integration | P0       | Extractor routing - DOCX to python-docx          | Component interaction                  | TECH-003      |
| 2.5-INT-003   | Integration | P1       | Extractor routing - unsupported file error       | Error path validation                  | -             |

**Coverage Summary AC1:** 8 scenarios (3 unit P0, 1 unit P1, 1 unit P2, 3 integration P0/P1)

---

### AC2: LLM classifica natura contenuto con confidenza

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                           | Justification                          | Risk Coverage |
|---------------|-------------|----------|---------------------------------------------------------|----------------------------------------|---------------|
| 2.5-UNIT-006  | Unit        | P0       | Classification prompt construction - domain selection   | Complex prompt logic                   | DATA-002      |
| 2.5-UNIT-007  | Unit        | P1       | Confidence threshold validation - reject < 0.7          | Business rule enforcement              | DATA-002      |
| 2.5-INT-004   | Integration | P0       | Classify fisioterapia_clinica domain - sample text      | LLM integration critical               | DATA-002      |
| 2.5-INT-005   | Integration | P0       | Classify anatomia domain - sample text                  | Domain accuracy validation             | DATA-002      |
| 2.5-INT-006   | Integration | P0       | Classify patologia domain - sample text                 | Domain accuracy validation             | DATA-002      |
| 2.5-INT-007   | Integration | P1       | Classify ambiguous content - mixed domains              | Edge case handling                     | DATA-002      |
| 2.5-INT-008   | Integration | P1       | Classification confidence calibration - 50 sample docs  | Accuracy measurement                   | DATA-002      |
| 2.5-E2E-001   | E2E         | P1       | End-to-end classification accuracy - real documents     | Full pipeline validation               | DATA-002      |

**Coverage Summary AC2:** 8 scenarios (2 unit P0/P1, 5 integration P0/P1, 1 e2e P1)

---

### AC3: Gestione immagini - estrazione caption/didascalie, metadata storage

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                           | Justification                          | Risk Coverage |
|---------------|-------------|----------|---------------------------------------------------------|----------------------------------------|---------------|
| 2.5-UNIT-008  | Unit        | P1       | Image metadata extraction - PDF embedded images         | Pure extraction logic                  | TECH-001      |
| 2.5-UNIT-009  | Unit        | P1       | Image metadata extraction - DOCX embedded images        | Pure extraction logic                  | TECH-003      |
| 2.5-INT-009   | Integration | P1       | Extract images from PDF - verify page number            | Component integration                  | TECH-001      |
| 2.5-INT-010   | Integration | P1       | Extract images from DOCX - verify filename              | Component integration                  | TECH-003      |
| 2.5-INT-011   | Integration | P2       | Image alt text extraction - DOCX with captions          | Feature validation                     | TECH-003      |
| 2.5-E2E-002   | E2E         | P2       | Images metadata persisted in DB - end-to-end            | Data persistence validation            | -             |

**Coverage Summary AC3:** 6 scenarios (2 unit P1, 3 integration P1/P2, 1 e2e P2)

---

### AC4: Gestione tabelle - estrazione strutturata con header/relazioni

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                           | Justification                          | Risk Coverage |
|---------------|-------------|----------|---------------------------------------------------------|----------------------------------------|---------------|
| 2.5-UNIT-010  | Unit        | P1       | Table parsing - DOCX with headers                       | Complex parsing logic                  | DATA-003      |
| 2.5-UNIT-011  | Unit        | P1       | Table parsing - preserve row structure                  | Data structure validation              | DATA-003      |
| 2.5-INT-012   | Integration | P1       | Extract table from DOCX - verify header detection       | Component integration                  | DATA-003      |
| 2.5-INT-013   | Integration | P2       | Extract table from PDF - basic detection                | Optional feature validation            | DATA-003      |
| 2.5-INT-014   | Integration | P2       | Table extraction - complex nested tables                | Edge case                              | DATA-003      |

**Coverage Summary AC4:** 5 scenarios (2 unit P1, 3 integration P1/P2)

---

### AC5: Pipeline end-to-end completata

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                                    | Justification                          | Risk Coverage |
|---------------|-------------|----------|------------------------------------------------------------------|----------------------------------------|---------------|
| 2.5-INT-015   | Integration | P0       | Pipeline step 1: extraction timing < 2s                          | Performance requirement                | TECH-002      |
| 2.5-INT-016   | Integration | P0       | Pipeline step 2: classification timing < 3s                      | Performance requirement                | TECH-002      |
| 2.5-INT-017   | Integration | P0       | Pipeline step 3: chunking timing < 1s per 100 chunks            | Performance requirement                | TECH-002      |
| 2.5-E2E-003   | E2E         | P0       | Full pipeline: document upload → chunks embedati                 | Critical journey validation            | DATA-001, OPS-001 |
| 2.5-E2E-004   | E2E         | P0       | Full pipeline: semantic search funzionante post-ingestion        | Critical journey completion            | DATA-001      |
| 2.5-E2E-005   | E2E         | P0       | Full pipeline: chat LLM risponde con citazioni                   | End user value validation              | -             |
| 2.5-E2E-006   | E2E         | P1       | Full pipeline timing: 50-page document < 60s total              | Performance target validation          | TECH-002      |

**Coverage Summary AC5:** 7 scenarios (3 integration P0, 4 e2e P0/P1)

---

### AC6: Batch embedding ottimizzato con retry logic

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                                    | Justification                          | Risk Coverage |
|---------------|-------------|----------|------------------------------------------------------------------|----------------------------------------|---------------|
| 2.5-UNIT-012  | Unit        | P0       | Retry logic - RateLimitError triggers exponential backoff        | Critical error handling                | PERF-001      |
| 2.5-UNIT-013  | Unit        | P0       | Retry logic - APIConnectionError retries with delay              | Critical error handling                | DATA-001      |
| 2.5-UNIT-014  | Unit        | P0       | Retry logic - max 5 attempts then raise                          | Error boundary validation              | DATA-001      |
| 2.5-UNIT-015  | Unit        | P0       | Retry logic - AuthenticationError no retry                       | Error classification logic             | -             |
| 2.5-INT-018   | Integration | P0       | Batch embedding - 100 chunks success path                        | Core functionality                     | DATA-001      |
| 2.5-INT-019   | Integration | P0       | Batch embedding - adaptive batch sizing on rate limit            | Performance optimization               | PERF-001      |
| 2.5-INT-020   | Integration | P1       | Batch embedding - 1000 chunks load test                          | Scale validation                       | PERF-001      |
| 2.5-INT-021   | Integration | P1       | Batch embedding timing - < 30s per 100 chunks                    | Performance requirement                | PERF-001      |

**Coverage Summary AC6:** 8 scenarios (4 unit P0, 4 integration P0/P1)

---

### AC7: Celery worker configurato e documentato

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                                    | Justification                          | Risk Coverage |
|---------------|-------------|----------|------------------------------------------------------------------|----------------------------------------|---------------|
| 2.5-INT-022   | Integration | P0       | Celery worker running - health check endpoint                    | Operational validation                 | OPS-001       |
| 2.5-INT-023   | Integration | P0       | Celery task submission - task accepted and queued                | Core async functionality               | OPS-001       |
| 2.5-INT-024   | Integration | P0       | Celery task execution - embedding task completes                 | Critical task validation               | OPS-001       |
| 2.5-INT-025   | Integration | P1       | Celery worker restart - task resilience                          | Operational resilience                 | OPS-001       |
| 2.5-INT-026   | Integration | P1       | Redis broker connectivity - PING/PONG                            | Infrastructure validation              | OPS-002       |
| 2.5-E2E-007   | E2E         | P1       | Celery worker monitoring - logs contain worker ready             | Operational observability              | OPS-001       |

**Coverage Summary AC7:** 6 scenarios (4 integration P0, 2 integration/e2e P1)

---

### AC8: Monitoring pipeline - logging dettagliato con timing metrics

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                                    | Justification                          | Risk Coverage |
|---------------|-------------|----------|------------------------------------------------------------------|----------------------------------------|---------------|
| 2.5-UNIT-016  | Unit        | P1       | Timing metrics calculation - accuracy validation                 | Metric logic correctness               | OPS-003       |
| 2.5-INT-027   | Integration | P0       | Pipeline logging - structured JSON format                        | Observability requirement              | OPS-003       |
| 2.5-INT-028   | Integration | P0       | Pipeline logging - all steps logged with timing                  | Complete monitoring coverage           | OPS-003       |
| 2.5-INT-029   | Integration | P1       | Log sanitization - no API keys in output                         | Security requirement                   | SEC-001       |
| 2.5-E2E-008   | E2E         | P2       | Monitoring dashboard - metrics visible (future)                  | Future enhancement validation          | OPS-003       |

**Coverage Summary AC8:** 5 scenarios (1 unit P1, 3 integration P0/P1, 1 e2e P2)

---

### AC9: Troubleshooting guide per errori comuni pipeline

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                                    | Justification                          | Risk Coverage |
|---------------|-------------|----------|------------------------------------------------------------------|----------------------------------------|---------------|
| 2.5-INT-030   | Integration | P1       | Documentation test - follow troubleshooting guide                | Documentation validation               | OPS-003       |
| 2.5-E2E-009   | E2E         | P2       | Troubleshooting scenario - chunks non embedati diagnosis         | Real-world issue resolution            | DATA-001      |

**Coverage Summary AC9:** 2 scenarios (1 integration P1, 1 e2e P2)

---

### AC10: Test end-to-end - verifica funzionamento completo

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                                    | Justification                          | Risk Coverage |
|---------------|-------------|----------|------------------------------------------------------------------|----------------------------------------|---------------|
| 2.5-E2E-010   | E2E         | P0       | E2E regression: upload → verify chunks → search → chat           | Comprehensive validation               | Multiple      |
| 2.5-INT-031   | Integration | P0       | Database validation - no NULL embeddings post-ingestion          | Data integrity check                   | DATA-001      |
| 2.5-INT-032   | Integration | P1       | Semantic search quality - relevance score > 0.7                  | RAG quality validation                 | -             |

**Coverage Summary AC10:** 3 scenarios (1 e2e P0, 2 integration P0/P1)

---

## Comprehensive Test Scenario Inventory

### Unit Tests (18 total)

| ID            | AC  | Priority | Test Focus                                    | Risk Mitigation |
|---------------|-----|----------|-----------------------------------------------|-----------------|
| 2.5-UNIT-001  | 1   | P0       | File type detection - PDF                     | TECH-001        |
| 2.5-UNIT-002  | 1   | P0       | File type detection - DOCX                    | TECH-001        |
| 2.5-UNIT-003  | 1   | P0       | File type detection - TXT                     | -               |
| 2.5-UNIT-004  | 1   | P1       | File type detection - unsupported             | TECH-004        |
| 2.5-UNIT-005  | 1   | P2       | File type detection - no extension            | TECH-004        |
| 2.5-UNIT-006  | 2   | P0       | Classification prompt construction            | DATA-002        |
| 2.5-UNIT-007  | 2   | P1       | Confidence threshold validation               | DATA-002        |
| 2.5-UNIT-008  | 3   | P1       | Image metadata - PDF extraction               | TECH-001        |
| 2.5-UNIT-009  | 3   | P1       | Image metadata - DOCX extraction              | TECH-003        |
| 2.5-UNIT-010  | 4   | P1       | Table parsing - DOCX headers                  | DATA-003        |
| 2.5-UNIT-011  | 4   | P1       | Table parsing - row structure                 | DATA-003        |
| 2.5-UNIT-012  | 6   | P0       | Retry logic - RateLimitError                  | PERF-001        |
| 2.5-UNIT-013  | 6   | P0       | Retry logic - APIConnectionError              | DATA-001        |
| 2.5-UNIT-014  | 6   | P0       | Retry logic - max attempts                    | DATA-001        |
| 2.5-UNIT-015  | 6   | P0       | Retry logic - AuthenticationError             | -               |
| 2.5-UNIT-016  | 8   | P1       | Timing metrics calculation                    | OPS-003         |
| 2.5-UNIT-017  | -   | P2       | Path validation - sanitization logic          | SEC-002         |
| 2.5-UNIT-018  | -   | P3       | Magic bytes verification - file type          | TECH-004        |

**Unit Tests Distribution:** P0: 8, P1: 7, P2: 2, P3: 1

---

### Integration Tests (17 total)

| ID            | AC  | Priority | Test Focus                                    | Risk Mitigation |
|---------------|-----|----------|-----------------------------------------------|-----------------|
| 2.5-INT-001   | 1   | P0       | Extractor routing - PDF to PyMuPDF           | TECH-001        |
| 2.5-INT-002   | 1   | P0       | Extractor routing - DOCX to python-docx      | TECH-003        |
| 2.5-INT-003   | 1   | P1       | Extractor routing - unsupported error        | -               |
| 2.5-INT-004   | 2   | P0       | Classify fisioterapia_clinica                | DATA-002        |
| 2.5-INT-005   | 2   | P0       | Classify anatomia                            | DATA-002        |
| 2.5-INT-006   | 2   | P0       | Classify patologia                           | DATA-002        |
| 2.5-INT-007   | 2   | P1       | Classify ambiguous mixed content             | DATA-002        |
| 2.5-INT-008   | 2   | P1       | Classification accuracy - 50 samples         | DATA-002        |
| 2.5-INT-009   | 3   | P1       | Extract images PDF - page number             | TECH-001        |
| 2.5-INT-010   | 3   | P1       | Extract images DOCX - filename               | TECH-003        |
| 2.5-INT-011   | 3   | P2       | Image alt text extraction                    | TECH-003        |
| 2.5-INT-012   | 4   | P1       | Extract table DOCX - header detection        | DATA-003        |
| 2.5-INT-013   | 4   | P2       | Extract table PDF - basic detection          | DATA-003        |
| 2.5-INT-014   | 4   | P2       | Table extraction - complex nested            | DATA-003        |
| 2.5-INT-015   | 5   | P0       | Pipeline extraction timing < 2s              | TECH-002        |
| 2.5-INT-016   | 5   | P0       | Pipeline classification timing < 3s          | TECH-002        |
| 2.5-INT-017   | 5   | P0       | Pipeline chunking timing < 1s/100            | TECH-002        |

*(continued on next section with remaining integration tests)*

| ID            | AC  | Priority | Test Focus                                    | Risk Mitigation |
|---------------|-----|----------|-----------------------------------------------|-----------------|
| 2.5-INT-018   | 6   | P0       | Batch embedding - 100 chunks success         | DATA-001        |
| 2.5-INT-019   | 6   | P0       | Batch embedding - adaptive sizing            | PERF-001        |
| 2.5-INT-020   | 6   | P1       | Batch embedding - 1000 chunks load           | PERF-001        |
| 2.5-INT-021   | 6   | P1       | Batch embedding timing < 30s/100             | PERF-001        |
| 2.5-INT-022   | 7   | P0       | Celery health check endpoint                 | OPS-001         |
| 2.5-INT-023   | 7   | P0       | Celery task submission                       | OPS-001         |
| 2.5-INT-024   | 7   | P0       | Celery task execution - embedding            | OPS-001         |
| 2.5-INT-025   | 7   | P1       | Celery worker restart resilience             | OPS-001         |
| 2.5-INT-026   | 7   | P1       | Redis broker connectivity                    | OPS-002         |
| 2.5-INT-027   | 8   | P0       | Pipeline logging - structured JSON           | OPS-003         |
| 2.5-INT-028   | 8   | P0       | Pipeline logging - all steps timed           | OPS-003         |
| 2.5-INT-029   | 8   | P1       | Log sanitization - no API keys               | SEC-001         |
| 2.5-INT-030   | 9   | P1       | Documentation test - troubleshooting guide   | OPS-003         |
| 2.5-INT-031   | 10  | P0       | Database validation - no NULL embeddings     | DATA-001        |
| 2.5-INT-032   | 10  | P1       | Semantic search quality - score > 0.7        | -               |

**Integration Tests Distribution:** P0: 13, P1: 10, P2: 3

---

### End-to-End Tests (8 total)

| ID            | AC  | Priority | Test Focus                                    | Risk Mitigation |
|---------------|-----|----------|-----------------------------------------------|-----------------|
| 2.5-E2E-001   | 2   | P1       | Classification accuracy - real documents     | DATA-002        |
| 2.5-E2E-002   | 3   | P2       | Images metadata persisted in DB              | -               |
| 2.5-E2E-003   | 5   | P0       | Full pipeline - upload to embeddings         | DATA-001, OPS-001 |
| 2.5-E2E-004   | 5   | P0       | Full pipeline - semantic search works        | DATA-001        |
| 2.5-E2E-005   | 5   | P0       | Full pipeline - chat responds with citations | -               |
| 2.5-E2E-006   | 5   | P1       | Full pipeline timing - 50pg < 60s            | TECH-002        |
| 2.5-E2E-007   | 7   | P1       | Celery monitoring - logs worker ready        | OPS-001         |
| 2.5-E2E-008   | 8   | P2       | Monitoring dashboard metrics visible         | OPS-003         |
| 2.5-E2E-009   | 9   | P2       | Troubleshooting - chunks non embedati        | DATA-001        |
| 2.5-E2E-010   | 10  | P0       | E2E regression - full user journey           | Multiple        |

**E2E Tests Distribution:** P0: 4, P1: 3, P2: 3

---

## Risk Coverage Matrix

Mapping test scenarios to identified risks from risk profile:

| Risk ID   | Risk Title                               | Test Coverage Count | Test IDs                                                    |
|-----------|------------------------------------------|---------------------|-------------------------------------------------------------|
| DATA-001  | Embedding failure chunks senza vectors   | 9                   | 2.5-UNIT-013/014, 2.5-INT-018/031, 2.5-E2E-003/004/009/010 |
| OPS-001   | Celery worker operational instability    | 6                   | 2.5-INT-022/023/024/025, 2.5-E2E-003/007                   |
| PERF-001  | OpenAI API rate limiting                 | 5                   | 2.5-UNIT-012, 2.5-INT-019/020/021                          |
| TECH-001  | PyMuPDF integration complexity           | 5                   | 2.5-UNIT-001/008, 2.5-INT-001/009                          |
| DATA-002  | Enhanced classification accuracy         | 8                   | 2.5-UNIT-006/007, 2.5-INT-004/005/006/007/008, 2.5-E2E-001 |
| TECH-002  | Pipeline timing bottlenecks              | 4                   | 2.5-INT-015/016/017, 2.5-E2E-006                           |
| SEC-001   | OpenAI API key exposure logs             | 1                   | 2.5-INT-029                                                |
| TECH-003  | DOCX image extraction incomplete         | 4                   | 2.5-UNIT-009, 2.5-INT-002/010/011                          |
| OPS-002   | Redis broker availability                | 1                   | 2.5-INT-026                                                |
| DATA-003  | Table extraction structure loss          | 5                   | 2.5-UNIT-010/011, 2.5-INT-012/013/014                      |
| OPS-003   | Pipeline monitoring gaps                 | 5                   | 2.5-UNIT-016, 2.5-INT-027/028/030, 2.5-E2E-008             |
| TECH-004  | File type detection magic bytes          | 3                   | 2.5-UNIT-004/005/018                                       |
| SEC-002   | File path injection                      | 1                   | 2.5-UNIT-017                                               |

**Critical Risks Coverage:**
- DATA-001: 9 tests (excellent coverage)
- OPS-001: 6 tests (good coverage)

**High Risks Coverage:**
- PERF-001: 5 tests (adequate)
- TECH-001: 5 tests (adequate)
- TECH-002: 4 tests (adequate)
- DATA-002: 8 tests (excellent)

---

## Test Data Requirements

### Unit Test Data

**File Type Detection:**
- Sample files: `test.pdf`, `test.docx`, `test.txt`, `test.unknown`, `noextension`

**Classification:**
- Sample texts (50 documents):
  - 10x fisioterapia_clinica (casi clinici lombalgia, cervicalgia)
  - 10x anatomia (strutture vertebrali, muscoli)
  - 10x patologia (ernia discale, tendinopatie)
  - 5x esercizi_riabilitativi (protocolli esercizi)
  - 5x valutazione_diagnostica (test clinici)
  - 5x evidence_based (paper scientifici)
  - 3x divulgativo (materiale pazienti)
  - 2x tecnico_generico

**Retry Logic:**
- Mock OpenAI responses: 429 RateLimitError, ConnectionError, AuthenticationError

### Integration Test Data

**PDF Samples:**
- Small: 10-page PDF with 2 images, 1 table
- Medium: 50-page PDF with 10 images, 5 tables
- Large: 200-page PDF (memory test)
- Corrupted: invalid PDF structure

**DOCX Samples:**
- Simple: 5-page DOCX with text only
- Images: DOCX with 5 embedded images + alt text
- Tables: DOCX with 3 complex tables (headers, nested)
- Mixed: DOCX with images + tables + text

**Batch Embedding:**
- 10 chunks (minimal batch)
- 100 chunks (standard batch)
- 1000 chunks (stress test)

### E2E Test Data

**Real Documents:**
- `lombalgia-acuta.docx` (50 pages, fisioterapia_clinica)
- `anatomia-vertebrale.pdf` (80 pages, anatomia, with images)
- `protocollo-esercizi-spalla.docx` (30 pages, esercizi_riabilitativi)

**Expected Search Queries:**
- "trattamento lombalgia acuta" → relevance score > 0.8
- "anatomia colonna vertebrale" → relevance score > 0.7
- "esercizi rinforzo cuffia rotatori" → relevance score > 0.75

---

## Test Environment Requirements

### Unit Tests
- **Dependencies:** pytest, pytest-mock, faker
- **Mocks:** OpenAI API, Supabase client, file system
- **Execution time target:** < 5 seconds total
- **Isolation:** No external dependencies

### Integration Tests
- **Environment:** Docker containers (API, Supabase, Redis, Celery worker)
- **Database:** Test Supabase instance with pgvector
- **OpenAI API:** Real API calls (rate limited test account)
- **Execution time target:** < 5 minutes total
- **Setup:** docker-compose.test.yml with test services

### E2E Tests
- **Environment:** Full staging environment
- **Browser:** Playwright (Chromium)
- **Services:** All services running (API, web, Celery, Redis, Supabase)
- **Execution time target:** < 15 minutes total
- **Data reset:** Clean database before each test suite

---

## Recommended Execution Order

### Phase 1: Fast Feedback (P0 Unit Tests)
**Duration:** ~30 seconds  
**Tests:** 8 unit tests P0  
**Goal:** Validate core logic immediately

```bash
pytest tests/unit/test_file_detection.py::test_pdf_extension
pytest tests/unit/test_file_detection.py::test_docx_extension
pytest tests/unit/test_file_detection.py::test_txt_extension
pytest tests/unit/test_classification.py::test_prompt_construction
pytest tests/unit/test_retry_logic.py::test_rate_limit_retry
pytest tests/unit/test_retry_logic.py::test_connection_error_retry
pytest tests/unit/test_retry_logic.py::test_max_attempts
pytest tests/unit/test_retry_logic.py::test_auth_error_no_retry
```

### Phase 2: Component Validation (P0 Integration Tests)
**Duration:** ~3 minutes  
**Tests:** 13 integration tests P0  
**Goal:** Verify critical component interactions

```bash
pytest tests/integration/test_extractor_routing.py -k "P0"
pytest tests/integration/test_classification_domains.py -k "P0"
pytest tests/integration/test_batch_embedding.py -k "P0"
pytest tests/integration/test_celery_worker.py -k "P0"
pytest tests/integration/test_pipeline_timing.py -k "P0"
pytest tests/integration/test_pipeline_logging.py -k "P0"
pytest tests/integration/test_data_integrity.py -k "P0"
```

### Phase 3: Critical Journeys (P0 E2E Tests)
**Duration:** ~8 minutes  
**Tests:** 4 e2e tests P0  
**Goal:** Validate end-user value delivery

```bash
playwright test tests/e2e/story-2.5-pipeline-e2e.spec.ts --grep "@P0"
# Covers: upload → embeddings, search, chat, regression
```

### Phase 4: High Priority Coverage (P1 Tests)
**Duration:** ~10 minutes  
**Tests:** 18 tests P1 (7 unit + 10 integration + 3 e2e)  
**Goal:** Comprehensive coverage of core functionality

```bash
pytest tests/ -k "P1"
playwright test tests/e2e/ --grep "@P1"
```

### Phase 5: Medium/Low Priority (P2/P3 Tests)
**Duration:** ~5 minutes  
**Tests:** 10 tests P2/P3  
**Goal:** Edge cases and nice-to-have validation

```bash
pytest tests/ -k "P2 or P3"
playwright test tests/e2e/ --grep "@P2"
```

**Total Execution Time:** ~27 minutes for full suite

---

## Test Implementation Details

### Critical Test: 2.5-E2E-003 (Full Pipeline)

**File:** `apps/web/tests/story-2.5-pipeline-e2e.spec.ts`

```typescript
test('2.5-E2E-003: Full pipeline - upload to embeddings @P0', async ({ page }) => {
  // Setup: Login as admin
  await page.goto('/admin/login');
  await page.fill('[name="accessCode"]', process.env.ADMIN_ACCESS_CODE);
  await page.click('button[type="submit"]');

  // Step 1: Upload documento
  await page.goto('/admin/knowledge-base');
  await page.click('button:has-text("Upload Document")');
  const fileInput = page.locator('input[type="file"]');
  await fileInput.setInputFiles('tests/fixtures/lombalgia-acuta.docx');
  await page.fill('[name="documentName"]', 'Test Lombalgia Acuta');
  await page.click('button:has-text("Start Ingestion")');

  // Step 2: Wait for ingestion completion
  await page.waitForSelector('.ingestion-success', { timeout: 120000 });
  const jobId = await page.locator('.job-id').textContent();

  // Step 3: Verify chunks embedati in database
  const response = await fetch(`http://localhost/api/v1/admin/knowledge-base/documents/${jobId}`, {
    headers: { 'Authorization': `Bearer ${adminJwt}` }
  });
  const document = await response.json();
  
  expect(document.chunks_count).toBeGreaterThan(0);
  
  // Critical assertion: NO NULL embeddings
  const nullEmbeddingsCount = document.chunks.filter(c => c.embedding === null).length;
  expect(nullEmbeddingsCount).toBe(0); // MUST BE ZERO - mitigates DATA-001
  
  // Step 4: Verify timing metrics
  expect(document.timing.total_pipeline_ms).toBeLessThan(120000); // < 2 minutes
  expect(document.timing.embedding_ms).toBeLessThan(60000); // < 1 minute
});
```

### Critical Test: 2.5-UNIT-012 (Retry Logic)

**File:** `apps/api/tests/unit/test_retry_logic.py`

```python
def test_retry_logic_rate_limit_exponential_backoff():
    """
    2.5-UNIT-012: Verify RateLimitError triggers exponential backoff
    
    Mitigates: PERF-001 (OpenAI rate limiting)
    Priority: P0
    """
    # Arrange
    mock_embeddings = Mock(spec=OpenAIEmbeddings)
    mock_embeddings.embed_documents.side_effect = [
        openai.RateLimitError("Rate limit exceeded"),  # Attempt 1
        openai.RateLimitError("Rate limit exceeded"),  # Attempt 2
        [[0.1] * 1536] * 10  # Attempt 3: success
    ]
    
    texts = ["sample text"] * 10
    
    # Act
    start_time = time.time()
    result = _embed_texts_with_retry(texts, mock_embeddings)
    duration = time.time() - start_time
    
    # Assert
    assert len(result) == 10
    assert mock_embeddings.embed_documents.call_count == 3
    
    # Verify exponential backoff: min 2s wait between retries
    assert duration >= 4.0  # 2s + 4s minimum backoff
    assert duration < 10.0  # Should not exceed max backoff significantly
```

### Critical Test: 2.5-INT-031 (No NULL Embeddings)

**File:** `apps/api/tests/integration/test_data_integrity.py`

```python
@pytest.mark.integration
def test_no_null_embeddings_post_ingestion():
    """
    2.5-INT-031: Verify no NULL embeddings after ingestion
    
    Mitigates: DATA-001 (Embedding failure)
    Priority: P0
    
    This test addresses production issue: 121 chunks with NULL embeddings
    """
    # Arrange
    test_document_path = "tests/fixtures/sample-fisioterapia.docx"
    
    # Act
    response = client.post(
        "/api/v1/admin/knowledge-base/sync-jobs",
        json={
            "document_text": "",
            "metadata": {"source_path": test_document_path}
        },
        headers={"Authorization": f"Bearer {admin_jwt}"}
    )
    
    assert response.status_code == 200
    job_id = response.json()["job_id"]
    
    # Wait for async task completion (max 60s)
    for _ in range(60):
        time.sleep(1)
        status = client.get(
            f"/api/v1/admin/knowledge-base/sync-jobs/{job_id}",
            headers={"Authorization": f"Bearer {admin_jwt}"}
        ).json()
        if status["state"] == "SUCCESS":
            break
    
    # Assert: CRITICAL - No NULL embeddings
    supabase = get_supabase_client()
    result = supabase.table("document_chunks") \
        .select("id, embedding") \
        .eq("document_id", job_id) \
        .execute()
    
    null_embeddings = [chunk for chunk in result.data if chunk["embedding"] is None]
    
    assert len(null_embeddings) == 0, \
        f"CRITICAL FAILURE: Found {len(null_embeddings)} chunks with NULL embeddings"
    
    # Additional validation: embeddings have correct dimensionality
    for chunk in result.data:
        assert len(chunk["embedding"]) == 1536, "Invalid embedding dimension"
```

---

## Coverage Gaps and Recommendations

### No Coverage Gaps Identified

All 10 Acceptance Criteria have comprehensive test coverage:
- AC1: 8 scenarios
- AC2: 8 scenarios
- AC3: 6 scenarios
- AC4: 5 scenarios
- AC5: 7 scenarios
- AC6: 8 scenarios
- AC7: 6 scenarios
- AC8: 5 scenarios
- AC9: 2 scenarios
- AC10: 3 scenarios

**Total:** 58 test scenarios across 10 ACs (average 5.8 scenarios per AC)

### Additional Recommended Tests (Optional)

**Performance Regression Suite:**
1. Baseline performance benchmarks for each pipeline step
2. Memory leak detection for large document processing
3. Concurrent ingestion load test (5 documents simultaneous)

**Chaos Engineering:**
1. Network partition during embedding
2. Supabase connection drop mid-transaction
3. Redis crash during Celery task execution

**Security Hardening:**
1. Fuzzing file upload endpoint
2. SQL injection attempts in metadata fields
3. XXE attacks on XML-based document formats

---

## Test Maintenance Strategy

### Flaky Test Prevention

**Integration Tests:**
- Use deterministic test data (no random generation)
- Implement proper cleanup between tests
- Configure appropriate timeouts (not too short, not too long)
- Mock external API calls when testing internal logic

**E2E Tests:**
- Implement retry logic for legitimate network delays
- Use explicit waits (waitForSelector) not sleep()
- Reset database state before each test
- Capture screenshots on failure for debugging

### Test Data Management

**Version Control:**
- Store test fixtures in `tests/fixtures/` directory
- Document fixture creation process
- Keep fixtures small (<5MB) for version control
- Use Git LFS for large binary test files

**Dynamic Generation:**
- Generate classification test corpus programmatically
- Use faker/factory patterns for metadata
- Seed random generators for reproducibility

### CI/CD Integration

**Pre-commit Hooks:**
- Run P0 unit tests (< 1 minute)
- Enforce code coverage threshold (85%)

**Pull Request Checks:**
- Run P0 + P1 tests (< 10 minutes)
- Generate coverage report
- Fail PR if critical tests fail

**Nightly Builds:**
- Run full test suite including P2/P3
- Performance benchmarks
- Security scans

---

## Success Metrics

### Test Coverage Targets

| Level       | Target Coverage | Actual Coverage | Status |
|-------------|-----------------|-----------------|--------|
| Unit        | >= 85%          | TBD             | ⏳      |
| Integration | >= 70%          | TBD             | ⏳      |
| E2E         | All P0 paths    | TBD             | ⏳      |

### Test Execution Targets

| Metric                  | Target      | Actual | Status |
|-------------------------|-------------|--------|--------|
| Unit test execution     | < 5 seconds | TBD    | ⏳      |
| Integration execution   | < 5 minutes | TBD    | ⏳      |
| E2E execution           | < 15 minutes| TBD    | ⏳      |
| Flaky test rate         | < 2%        | TBD    | ⏳      |
| Test maintenance hours  | < 10% sprint| TBD    | ⏳      |

### Quality Metrics

| Metric                     | Target    | Actual | Status |
|----------------------------|-----------|--------|--------|
| Production defect rate     | < 1/sprint| TBD    | ⏳      |
| Critical path coverage     | 100%      | TBD    | ⏳      |
| Risk mitigation coverage   | >= 90%    | 100%   | ✅      |
| AC coverage                | 100%      | 100%   | ✅      |

---

## Appendix: Test File Structure

```
apps/api/tests/
├── unit/
│   ├── test_file_detection.py           # 2.5-UNIT-001 to 005
│   ├── test_classification.py           # 2.5-UNIT-006, 007
│   ├── test_image_extraction.py         # 2.5-UNIT-008, 009
│   ├── test_table_parsing.py            # 2.5-UNIT-010, 011
│   ├── test_retry_logic.py              # 2.5-UNIT-012 to 015
│   ├── test_timing_metrics.py           # 2.5-UNIT-016
│   ├── test_path_validation.py          # 2.5-UNIT-017
│   └── test_magic_bytes.py              # 2.5-UNIT-018
│
├── integration/
│   ├── test_extractor_routing.py        # 2.5-INT-001 to 003
│   ├── test_classification_domains.py   # 2.5-INT-004 to 008
│   ├── test_image_integration.py        # 2.5-INT-009 to 011
│   ├── test_table_integration.py        # 2.5-INT-012 to 014
│   ├── test_pipeline_timing.py          # 2.5-INT-015 to 017
│   ├── test_batch_embedding.py          # 2.5-INT-018 to 021
│   ├── test_celery_worker.py            # 2.5-INT-022 to 026
│   ├── test_pipeline_logging.py         # 2.5-INT-027 to 029
│   ├── test_documentation.py            # 2.5-INT-030
│   └── test_data_integrity.py           # 2.5-INT-031, 032
│
└── fixtures/
    ├── lombalgia-acuta.docx
    ├── anatomia-vertebrale.pdf
    ├── protocollo-esercizi-spalla.docx
    ├── sample-with-images.pdf
    ├── sample-with-tables.docx
    └── classification-corpus/
        ├── fisioterapia_clinica_01.txt
        ├── anatomia_01.txt
        └── ... (50 total samples)

apps/web/tests/
└── story-2.5-pipeline-e2e.spec.ts       # 2.5-E2E-001 to 010
```

---

## Quality Checklist Verification

- [x] Every AC has test coverage (all 10 ACs covered)
- [x] Test levels are appropriate (unit: logic, integration: components, e2e: journeys)
- [x] No duplicate coverage across levels (validated via test scenario descriptions)
- [x] Priorities align with business risk (P0 for critical risks DATA-001, OPS-001)
- [x] Test IDs follow naming convention (2.5-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent (each test scenario standalone)
- [x] Risk mitigation mapping complete (all 13 risks mapped to tests)
- [x] Critical path coverage validated (upload → search → chat covered in E2E)

---

**End of Test Design Document**

*For implementation, reference:*
- Story: `docs/stories/2.5.intelligent-document-preprocessing.md`
- Risk Profile: `docs/qa/assessments/2.5-intelligent-document-preprocessing-risk-20251007.md`
- Quality Gate: `docs/qa/gates/2.5-intelligent-document-preprocessing-pipeline-completion.yml`

