# Test Design: Story 6.5

Date: 2025-10-20
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 14
- Unit tests: 6 (43%)
- Integration tests: 5 (36%)
- E2E tests: 3 (21%)
- Priority distribution: P0: 5, P1: 6, P2: 3

Rationale: Emphasize unit/integration coverage for model-aware temperature handling and logging/metrics, with one critical E2E validating the full RAG pipeline using real OpenAI gated by `RUN_E2E_REAL`.

## Test Scenarios by Acceptance Criteria

### AC1: gpt-5-nano Temperature Configuration Fixed

#### Scenarios

| ID             | Level       | Priority | Test                                                                 | Justification                                 |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------- |
| 6.5-UNIT-001   | Unit        | P0       | `_get_chat_llm()` skips temperature for nano models                  | Core logic; prevents runtime errors (TECH-001) |
| 6.5-UNIT-002   | Unit        | P1       | `_get_chat_llm()` applies configured temperature for non-nano models | Ensures backward compatibility                 |
| 6.5-INT-001    | Integration | P1       | Admin route LLM init doesn’t set temp for nano                       | Regression at endpoint construction layer      |
| 6.5-UNIT-003   | Unit        | P2       | Classifier path keeps temperature=1 for nano                         | Guard against future refactors                 |

### AC2: Generation Chain Operational with gpt-5-nano

#### Scenarios

| ID             | Level       | Priority | Test                                                                 | Justification                                 |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------- |
| 6.5-INT-002    | Integration | P1       | POST `/api/v1/chat/sessions/{id}/messages` returns answer+citations  | Validates end-to-end service stack minus OpenAI |
| 6.5-UNIT-004   | Unit        | P1       | Input validation errors (missing chunks/empty question)              | Fast checks on validation paths                |
| 6.5-INT-003    | Integration | P1       | Error handling: invalid session_id, missing chunks                   | Ensures API surfaces clear errors              |

### AC3: Complete E2E RAG Pipeline Test

#### Scenarios

| ID             | Level | Priority | Test                                                                                   | Justification                                   |
| -------------- | ----- | -------- | -------------------------------------------------------------------------------------- | ----------------------------------------------- |
| 6.5-E2E-001    | E2E   | P0       | Full pipeline: upload doc → embeddings → semantic search → generation with nano        | Critical business flow with real OpenAI         |
| 6.5-E2E-002    | E2E   | P0       | Policy guard: `RUN_E2E_REAL` unset → tests skipped with clear reason                   | Controls cost/flakiness (OPS-001)               |
| 6.5-E2E-003    | E2E   | P1       | Retry/backoff: simulate transient failure then success; verify logs and counters       | Ensures resilience and observability (OPS-002)  |

### AC4: Configuration Documentation Updated

#### Scenarios

| ID             | Level | Priority | Test                                                              | Justification                         |
| -------------- | ----- | -------- | ----------------------------------------------------------------- | ------------------------------------- |
| 6.5-UNIT-005   | Unit  | P2       | Presence check: `.env.example` warns about nano temperature       | Lightweight guard on documentation    |
| 6.5-UNIT-006   | Unit  | P2       | Docs lint: `llm-configuration.md` includes nano constraints       | Prevents regressions in doc content   |

### AC5: Error Handling & Logging

#### Scenarios

| ID             | Level       | Priority | Test                                                                              | Justification                                       |
| -------------- | ----------- | -------- | --------------------------------------------------------------------------------- | --------------------------------------------------- |
| 6.5-INT-004    | Integration | P0       | Logs include required structured fields on success (latency, tokens, citations)   | Observability requirement; validates AC5 evidence   |
| 6.5-INT-005    | Integration | P0       | Error logs structured: rate limit or API error includes code/backoff/retry        | Ensures actionable error trails                     |

## Risk Coverage

- TECH-001 (High): 6.5-UNIT-001, 6.5-INT-001, 6.5-E2E-001
- TECH-002 (Medium): 6.5-INT-001, 6.5-INT-002
- OPS-001 (Medium): 6.5-E2E-002
- OPS-002 (Medium): 6.5-E2E-003, 6.5-INT-005
- PERF-001 (Medium): 6.5-INT-004, 6.5-E2E-001 (collect/assess metrics)
- BUS-001 (Medium): 6.5-E2E-002 (policy), 6.5-E2E-001 (budget check observed)
- DATA-001 (Low): 6.5-E2E-001 (cleanup in teardown)
- SEC-001 (Low): Global logger filter test will be added in future scope

## Recommended Execution Order

1. P0 Unit tests: 6.5-UNIT-001
2. P0 Integration tests: 6.5-INT-004, 6.5-INT-005
3. P0 E2E tests: 6.5-E2E-001, 6.5-E2E-002
4. P1 tests: 6.5-UNIT-002, 6.5-INT-002, 6.5-UNIT-004, 6.5-INT-003, 6.5-E2E-003
5. P2 tests: 6.5-UNIT-003, 6.5-UNIT-005, 6.5-UNIT-006

## Environment, Data, and Execution Notes

- Flags: `RUN_E2E_REAL=1` required for real OpenAI execution; otherwise E2E skipped.
- Retries: Max 2 with exponential backoff (1s, 2s, 4s); on 429 wait 60s and do not count toward retries.
- Artifacts: Ensure outputs under `reports/e2e/*` are generated as per story (logs, metrics JSON files).
- Isolation: Use unique test documents and ensure teardown deletes docs and embeddings.

## Gate YAML Block

test_design:
  scenarios_total: 14
  by_level:
    unit: 6
    integration: 5
    e2e: 3
  by_priority:
    p0: 5
    p1: 6
    p2: 3
  coverage_gaps: []

## Trace References

Test design matrix: qa.qaLocation/assessments/6.5-test-design-20251020.md
P0 tests identified: 5

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels appropriate and non-duplicative
- [x] Priorities align with risk profile
- [x] Test IDs follow convention
- [x] Scenarios are atomic and independent

