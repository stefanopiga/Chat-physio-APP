# PO Validation Report — Story 2.3

Date: 2025-09-21

## Executive Summary
- Story: `docs/stories/2.3.polymorphic-chunking-router.md`
- Overall readiness: Ready
- Go/No-Go: GO
- Critical blocking issues: None
- Sections skipped: UI/Frontend N/A

## Template Compliance Issues
- Present: Status; Story; Acceptance Criteria; Dev Notes; Tasks / Subtasks; Testing; Change Log; Dev Agent Record; QA Results. [`docs/stories/2.3.polymorphic-chunking-router.md`]
- Placeholders in text: none found (no `{{...}}`, `_TBD_`)
- Structure/format: compliant

## File Structure and Source Tree Validation
- Current ingestion modules: `apps/api/api/ingestion/` contains `extractors.py`, `models.py`, `storage.py`, `watcher.py`.
- Proposed additions:
  - `apps/api/api/ingestion/chunking/strategy.py` (define `ChunkingStrategy` interface)
  - `apps/api/api/ingestion/chunking/recursive.py` (implement RecursiveCharacterTextSplitter-based strategy)
  - `apps/api/api/ingestion/chunking/tabular.py` (tabular/structural splitter placeholder with modular design)
  - `apps/api/api/ingestion/chunk_router.py` (route by `DocumentStructureCategory` + confidence with fallback when `confidenza < 0.85` or unsupported)
  - Update `apps/api/api/ingestion/watcher.py` to call router instead of direct `split_text`
- Persistence: `storage.save_chunks`, `storage.save_document` already suitable; `models.Document` includes `chunking_strategy` and `metadata` keys for audit.
- Paths align with monorepo structure and docs.

## UI/Frontend Completeness Validation (N/A)
- Not applicable for backend ingestion story.

## Acceptance Criteria Satisfaction Assessment
- AC1 (≥2 strategies): Will be satisfied by adding `recursive.py` and `tabular.py`.
- AC2 (fallback): Router enforces fallback when `confidenza < 0.85` or unmapped class.
- AC3 (apply correct strategy/fallback): Router selection logic based on Story 2.2 classification output (`ClassificazioneOutput`).
- AC4 (chunks with source reference): Persist via `save_chunks`; ensure `metadata` includes `chunks_count`, and `chunking_strategy` recorded (already done in `watcher.py` for recursive; extend for router).
- AC5 (modular design): Separate strategy interface and implementations satisfy modularity.
- Task↔AC mapping in story is coherent; add explicit task to integrate the classifier output from Story 2.2 into router.

## Validation and Testing Instructions Review
- Tests: Use pytest; create unit tests for each strategy and router selection, plus integration in ingestion pipeline.
- Suggested files:
  - `apps/api/tests/test_chunk_strategies.py`
  - `apps/api/tests/test_chunking_router.py`
  - Extend `apps/api/tests/test_ingestion.py` or add `test_ingestion_router_integration.py` for end-to-end chunking + persistence.
- Tools/frameworks: pytest; mock external loaders where needed.
- Test data: small .txt/.pdf fixtures covering dense text and tabular-like content.

## Security Considerations
- Handle untrusted documents safely; fail fast on unsupported types.
- Guard memory/time with bounded chunk sizes/overlaps; robust error handling in router.

## Tasks/Subtasks Sequence Validation
- Logical order: define interface → implement strategies → implement router + fallback → integrate with watcher → persist metadata → tests.
- Dependencies: router depends on Story 2.2 classifier output model (`ClassificazioneOutput` present in `models.py`), but integration logic needed in router.
- Granularity/actionability: adequate; add explicit step for classifier integration and for updating `doc.chunking_strategy` consistently.

## Anti‑Hallucination Findings
- Source references in story exist in repository and align with architecture/PRD.
- `RecursiveCharacterTextSplitter` present and used in `extractors.py` and `watcher.py` (currently direct, to be refactored via router).
- Data models `Document`, `DocumentStructureCategory`, and `ClassificazioneOutput` present and consistent with docs.

## Dev Agent Implementation Readiness
- Self-contained context is strong; precise file paths remove ambiguity.
- No missing template sections; proceed to implementation tasks.

## Final Assessment
- Decision: GO
- Implementation Readiness Score: 9/10
- Confidence Level: High

## Azioni Raccomandate (Brevi)
- Aggiungere sezioni placeholder: Dev Agent Record; QA Results nella story.
- Implementare router e strategie nei path proposti; aggiornare `watcher.py`.
- Aggiornare test come da sezione Testing.

## Fonti
- `docs/stories/2.3.polymorphic-chunking-router.md`
- `.bmad-core/templates/story-tmpl.yaml` L25–L139
- `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`
- `docs/architecture/sezione-6-componenti.md`
- `docs/architecture/sezione-4-modelli-di-dati.md`
- `docs/architecture/sezione-11-strategia-di-testing.md`
- Codice: `apps/api/api/ingestion/models.py`, `extractors.py`, `storage.py`, `watcher.py`
