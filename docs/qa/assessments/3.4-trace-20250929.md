# QA Trace ‚Äî Story 3.4: Source Visualization & Feedback

## AC1 ‚Äî Citazioni interattive (click/hover)
- ChatMessagesList integra `CitationBadge` per ogni citazione.
```tsx
// apps/web/src/components/ChatMessagesList.tsx
<CitationBadge
  id={c.chunk_id}
  excerpt={c.excerpt}
  onClick={() => setOpenCitation(openCitation === c.chunk_id ? null : c.chunk_id)}
/>
```
- `CitationBadge` √® un `<button>` con attributi ARIA.
```tsx
// apps/web/src/components/CitationBadge.tsx
<button type="button" aria-label={`Fonte ${id}`} aria-haspopup="dialog" title={excerpt || id} onClick={onClick}>
  {id}
</button>
```

## AC2 ‚Äî Popover con estratto e metadati (document_id, posizione)
- Popover con `role="tooltip"`, mostra `excerpt`, `documentId`, `position`.
```tsx
// apps/web/src/components/CitationPopover.tsx
<div role="tooltip" aria-live="polite" style={{ pointerEvents: "none" }}>
  <div>Documento: {documentId || "-"} {typeof position === "number" ? `(pos ${position})` : ""}</div>
  <div>{excerpt || "(nessun estratto)"}</div>
</div>
```
- Posizionamento fuori flusso (assoluto) per non coprire i controlli di feedback (gestito in `ChatMessagesList`).

## AC3 ‚Äî Pulsanti di feedback visibili (üëç/üëé)
- Controlli di feedback come `<button>` con `aria-label` e stato disabilitato.
```tsx
// apps/web/src/components/FeedbackControls.tsx
<button type="button" aria-label="Vota positivo" disabled={disabled} onClick={onUp}>üëç</button>
<button type="button" aria-label="Vota negativo" disabled={disabled} onClick={onDown}>üëé</button>
```
- Rendering accanto alle risposte assistant.
```tsx
// apps/web/src/components/ChatMessagesList.tsx
<FeedbackControls
  disabled={pendingFeedback === m.messageId}
  onUp={() => handleVote(localStorage.getItem("chat.sessionId") || "", m.messageId!, "up")}
  onDown={() => handleVote(localStorage.getItem("chat.sessionId") || "", m.messageId!, "down")}
/>
```
# QA Trace ‚Äî Story 3.4: Source Visualization & Feedback

## AC4 ‚Äî Invio feedback { sessionId, message_id, vote }
- Invio da frontend con gestione pending per riflettere lo stato UI.
```tsx
// apps/web/src/components/ChatMessagesList.tsx
setPendingFeedback(messageId);
await new Promise((resolve) => setTimeout(resolve, 0));
await apiClient.sendFeedback(sessionId, messageId, vote);
setTimeout(() => setPendingFeedback(null), 200);
```
- Client REST per feedback.
```ts
// apps/web/src/lib/apiClient.ts
async sendFeedback(sessionId: string, messageId: string, vote: "up" | "down") {
  const endpoint = `${API_BASE}/chat/messages/${messageId}/feedback`;
  const payload = { sessionId, vote };
  return this.post<typeof payload, { ok: boolean }>(endpoint, payload);
}
```
- Endpoint backend implementato e tipizzato.
```py
# apps/api/api/main.py
class FeedbackCreateRequest(BaseModel):
    sessionId: str
    vote: Literal["up", "down"]

class FeedbackCreateResponse(BaseModel):
    ok: bool

@app.post("/api/v1/chat/messages/{messageId}/feedback", response_model=FeedbackCreateResponse)
```
## AC5 ‚Äî Persistenza UI del voto selezionato
- Stato `pendingFeedback` disabilita i pulsanti per il messaggio corrente.
```tsx
// apps/web/src/components/ChatMessagesList.tsx
const [pendingFeedback, setPendingFeedback] = useState<string | null>(null);
```

## Backend ‚Äî Citazioni arricchite per popover
- Modello `CitationItem` e arricchimento dei dati.
```py
# apps/api/api/main.py
class CitationItem(BaseModel):
    chunk_id: str
    document_id: str | None = None
    excerpt: str | None = None
    position: int | None = None
```
```py
# apps/api/api/main.py (arricchimento)
if ch:
    text = (ch.content or "").strip()
    if text:
        excerpt_value = text[:240]
    document_id_value = ch.document_id
```

## Test E2E ‚Äî Verifica citazioni/popover/feedback
```ts
// apps/web/tests/story-3.4.spec.ts
await expect(page.getByRole("button", { name: /Fonte c1/ })).toBeVisible();
await page.getByRole("button", { name: /Fonte c1/ }).click();
await expect(page.getByRole("tooltip")).toBeVisible();
const up = page.getByRole("button", { name: "Vota positivo" });
await up.click();
await expect(up).toBeDisabled();
```

## Documentazione aggiornata
- `docs/stories/3.4.source-visualization-and-feedback.md` ‚Äî Status ‚ÄúImplementato‚Äù, checklist completata.
- `docs/architecture/sezione-5-specifica-api-sintesi.md` ‚Äî dettagli `citations` arricchite e contratto feedback.
- `apps/api/README.md` ‚Äî sezione Feedback e output AG con citazioni arricchite.
