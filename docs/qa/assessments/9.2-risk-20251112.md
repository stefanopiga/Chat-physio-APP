# Risk Profile: Story 9.2

Story: 9.2  |  Slug: story-9-2
Date: 2025-11-12

## Summary
Comprehensive risk analysis for implementing full session history retrieval and UI integration with pagination, feature flag control, and robust error handling.

## Risk Matrix (Probability x Impact)
- Scale: Probability 1-3, Impact 1-3, Score = P x I

| ID | Category | Title | P | I | Score | Level |
|---|---|---|---|---|---|---|
| TECH-001 | Technical | Backend pagination/offset bugs corrupt ordering | 2 | 3 | 6 | Medium |
| TECH-002 | Technical | Hook state race conditions on mount/unmount | 2 | 2 | 4 | Medium |
| SEC-001  | Security  | Inadequate auth checks / token leakage | 1 | 3 | 3 | Medium |
| SEC-002  | Security  | History exposure of sensitive content via citations | 1 | 3 | 3 | Medium |
| PERF-001 | Performance | Large history degrades load/render (no virtual scroll) | 2 | 3 | 6 | Medium |
| PERF-002 | Performance | Excessive retries overwhelm API under failure | 2 | 2 | 4 | Medium |
| DATA-001 | Data      | Missing/duplicated messages due to offset drift | 2 | 3 | 6 | Medium |
| DATA-002 | Data      | Source chunk IDs not preserved/linked | 2 | 2 | 4 | Medium |
| OPS-001  | Operational | Missing rate limiting/monitoring on endpoint | 1 | 3 | 3 | Medium |
| BUS-001  | Business  | UX regression when flag disabled (empty state) | 2 | 2 | 4 | Medium |

## Detailed Risks and Mitigations
### TECH-001: Backend pagination/offset bugs corrupt ordering
- Indicators: ascending order required; LIMIT/OFFSET with evolving data
- Mitigations: order by created_at ASC, stable cursor semantics in future, wrap in tx snapshot if needed, tests for >100 msgs
- Residual: Low-Medium

### TECH-002: Hook state race conditions on mount/unmount
- Indicators: setState after unmount, double fetch on React StrictMode
- Mitigations: abort controller, mounted ref guard, idempotent merges
- Residual: Low

### SEC-001: Inadequate auth checks / token leakage
- Indicators: GET endpoint requires JWT; frontend stores token
- Mitigations: server-side verify_jwt_token, least-privilege scopes, never log tokens, 401 redirect
- Residual: Low

### SEC-002: History exposure of sensitive content via citations
- Indicators: source_chunk_ids may reveal content
- Mitigations: enforce row-level access; filter archived; sanitize UI; honor 'archived' metadata
- Residual: Low-Medium

### PERF-001: Large history degrades load/render (no virtual scroll)
- Indicators: >100 messages
- Mitigations: lazy pagination, virtualized list >50, spinner target <500ms
- Residual: Medium

### PERF-002: Excessive retries overwhelm API under failure
- Indicators: retry 1s-2s-4s
- Mitigations: backoff with jitter, cap attempts to 3, respect 429 via rate limit headers
- Residual: Low

### DATA-001: Missing/duplicated messages due to offset drift
- Indicators: concurrent message writes while paginating
- Mitigations: immutable ordering by created_at+id, dedupe by id on client append, consider keyset pagination later
- Residual: Medium

### DATA-002: Source chunk IDs not preserved/linked
- Indicators: citations UI depends on IDs
- Mitigations: ensure API returns source_chunk_ids; types enforce non-null where expected; integration tests
- Residual: Low

### OPS-001: Missing rate limiting/monitoring on endpoint
- Indicators: AC requires 60 req/min
- Mitigations: apply limiter, expose metrics, alert on 5xx spikes
- Residual: Low

### BUS-001: UX regression when flag disabled (empty state)
- Indicators: ENABLE_PERSISTENT_MEMORY=false
- Mitigations: graceful empty state copy; analytics to confirm engagement
- Residual: Low

## Testing Focus Areas
- Backend unit tests: success/empty/error; pagination correctness; archived filter
- Frontend unit tests: hook success/empty/network/500; retry with backoff and abort on unmount
- E2E: reopen app with existing session; 404 new session; 500 error toast
- Performance: list virtualization >50; API latency under load

## Risk Score Summary
- Highest score: 6 (Medium) across TECH-001, PERF-001, DATA-001
- Overall profile: Medium risk, acceptable with listed mitigations

## Recommendations
- Keep keyset pagination as follow-up for stability
- Add metrics for history fetch latency and error rates
- Gate virtual scroll behind incremental rollout if needed
