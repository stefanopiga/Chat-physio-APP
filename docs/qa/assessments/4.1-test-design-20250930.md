# Test Design — Story 4.1: Admin Debug View

## Riferimenti

- Fonte primaria: `docs/stories/4.1.admin-debug-view.md`
- Profilo rischi: `docs/qa/assessments/4.1-risk-20250930.md`
- Admin Login System: `docs/stories/1.2.admin-login-system.md`
- Semantic Search: `docs/stories/3.1.semantic-search-endpoint.md`
- Augmented Generation: `docs/stories/3.2.augmented-generation-endpoint.md`
- **FastAPI Best Practices**: `docs/architecture/addendum-fastapi-best-practices.md` (implementation patterns)
- **LangChain RAG Patterns**: `docs/architecture/addendum-langchain-rag-debug-patterns.md` (retriever scores, timing separato)
- Coding Standards: `docs/architecture/sezione-12-standard-di-codifica.md`
- Shadcn/UI Guidelines: `docs/architecture/addendum-shadcn-dialog-implementation.md`
- Tailwind Guidelines: `docs/architecture/addendum-tailwind-shadcn-setup.md`
- Security Standards: `docs/architecture/sezione-10-sicurezza-e-performance.md`
- Frontend Spec: `docs/front-end-spec.md` Sez. 7

## Gating / Prerequisiti (Bloccanti)

### Dipendenze Tecniche (Status: Done)
- Story 1.2 (Admin Login System): JWT verification infrastructure disponibile. [Fonte: `docs/stories/4.1.admin-debug-view.md` L32]
- Story 3.1 (Semantic Search): Retrieval logic riutilizzabile. [Fonte: medesima L33]
- Story 3.2 (Augmented Generation): LLM generation logic riutilizzabile. [Fonte: medesima L34]
- Tech Story (Tailwind + Shadcn/UI): UI component library disponibile. [Fonte: medesima L35]

### Prerequisiti Implementativi (Pre-Testing)
- Endpoint `POST /api/v1/admin/debug/query` implementato con Pydantic models `DebugQueryRequest` e `DebugQueryResponse`. [Fonte: `docs/stories/4.1.admin-debug-view.md` L91–L92]
- Admin auth check `_is_admin(payload)` implementato e testato. [Fonte: `docs/qa/assessments/4.1-risk-20250930.md` R-4.1-1]
- Rate limiting configurato per endpoint debug (10 queries/hour). [Fonte: `docs/qa/assessments/4.1-risk-20250930.md` R-4.1-3]
- Frontend route `/admin/debug` protetta da `AdminGuard`. [Fonte: `docs/stories/4.1.admin-debug-view.md` L113]
- Componenti Shadcn/UI necessari installati: Textarea, Card, Badge, Accordion (se usato). [Fonte: medesima L107]
- Sanitization markdown configurata: `react-markdown` + `rehype-sanitize`. [Fonte: `docs/qa/assessments/4.1-risk-20250930.md` R-4.1-5]

## Obiettivi di Test

Priorità basata su Risk Profile (R-4.1-1 a R-4.1-10): [Fonte: `docs/qa/assessments/4.1-risk-20250930.md`]

### Critical Priority (Must-Fix Blockers)
1. **Admin Authentication Bypass Prevention** (R-4.1-1): Verificare role=admin check su endpoint debug; bloccare accesso non autorizzato. [Fonte: `docs/qa/assessments/4.1-risk-20250930.md` L39–L40]
2. **API Cost Control** (R-4.1-3): Verificare rate limiting enforcement (10 queries/hour). [Fonte: medesima L42]

### High Priority (Pre-Gate)
3. **Data Exposure Audit** (R-4.1-2): Verificare logging accessi debug con admin_id; nessun PII esposto in logs. [Fonte: medesima L41]
4. **Performance Isolation** (R-4.1-4): Verificare nessun impatto su endpoint studenti durante debug queries. [Fonte: medesima L43]
5. **XSS Prevention** (R-4.1-5): Verificare sanitization HTML/JS in chunk content rendering. [Fonte: medesima L44]

### Medium Priority (Pre-Release)
6. **Error Handling Completeness** (R-4.1-6): Verificare gestione errori API OpenAI/embedding con messaggi informativi. [Fonte: medesima L45]
7. **UI Scalability** (R-4.1-7): Verificare rendering corretto con 50+ chunk senza memory leak. [Fonte: medesima L46]
8. **Timing Metrics Accuracy** (R-4.1-8): Verificare precisione timing retrieval/generation (±10ms). [Fonte: medesima L47]

### Low Priority (Continuous)
9. **Theming & Accessibility** (R-4.1-9): Verificare conformità WCAG AA, keyboard nav, theming Light/Dark. [Fonte: medesima L48]
10. **Metadata Robustness** (R-4.1-10): Verificare fallback UI per chunk senza metadati opzionali. [Fonte: medesima L49]

## Componenti Rilevanti

### Backend
- Endpoint: `POST /api/v1/admin/debug/query` (`/apps/api/api/main.py`). [Fonte: `docs/stories/4.1.admin-debug-view.md` L40]
- Auth dependency: `verify_jwt_token` + `_is_admin()` check. [Fonte: medesima L41]
- Models: `DebugQueryRequest`, `DebugQueryResponse`. [Fonte: medesima L91–L92]
- Logica retrieval: riutilizzo da Story 3.1 semantic search. [Fonte: medesima L95]
- Logica generation: riutilizzo da Story 3.2 augmented generation. [Fonte: medesima L96]

### Frontend
- Page: `AdminDebugPage` (`/apps/web/src/pages/AdminDebugPage.tsx`). [Fonte: medesima L162]
- Components:
  - `DebugQueryForm`: form input domanda + submit button. [Fonte: medesima L163]
  - `ChunkList`: lista chunk recuperati. [Fonte: medesima L163]
  - `ChunkCard`: singolo chunk con content preview, score badge, metadata. [Fonte: medesima L163]
- Hook: `useDebugQuery` per API call. [Fonte: medesima L117]
- Route: `/admin/debug` protetta da `AdminGuard`. [Fonte: medesima L113]

### Database
- Tabella `document_chunks`: metadati chunk (document_id, document_name, page_number, chunking_strategy). [Fonte: medesima L154]

## Strategia di Testing

### Unit Tests Backend
- Mock minimo: Supabase client, OpenAI client.
- Focus: auth verification, rate limiting, error handling, timing accuracy.
- Coverage target: 95% endpoint debug e helper functions.

### Integration Tests Backend
- Mock Supabase vector search con risultati predefiniti.
- Mock OpenAI API con responses controllate.
- Verifica end-to-end flow: request → retrieval → generation → response.

### Unit Tests Frontend
- Mock API client `useDebugQuery`.
- Focus: rendering condizionale (idle/loading/success/error), keyboard nav, sanitization.
- Testing Library + jsdom per DOM interactions.

### E2E Tests (End-to-End)
- Playwright: admin login → navigazione `/admin/debug` → submit query → verifica risultati.
- Test theming: switch Light/Dark durante sessione.
- Test accessibilità: keyboard navigation completa.
- Test error scenarios: API failure, empty results.

### Performance Tests
- Load test endpoint debug concorrente (5 admin simultanei).
- Monitor latency endpoint `/api/v1/chat/query` durante debug execution.
- Memory profiling frontend con 50+ chunk visualizzati.

### Security Tests
- Penetration testing: JWT manipulation, role tampering.
- XSS payload injection tests.
- Rate limiting bypass attempts.

[Fonti: `docs/stories/4.1.admin-debug-view.md` L100–L103, L129–L133; `docs/qa/assessments/4.1-risk-20250930.md` Monitoring Requirements]

## Casi di Test

### AC1 — Sezione "Debug RAG" nel Pannello Admin

**TC-001** — Route `/admin/debug` accessibile da admin autenticato
- **Given**: Admin autenticato con JWT valido (role=admin)
- **When**: Navigazione a `/admin/debug`
- **Then**: Pagina "Debug RAG" renderizzata; titolo e descrizione visibili
- **Priority**: Medium (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L15, L137–L138

**TC-002** — Route `/admin/debug` bloccata per utenti non autenticati
- **Given**: Utente non autenticato (no JWT)
- **When**: Tentativo accesso `/admin/debug`
- **Then**: Redirect a login o errore 401/403
- **Priority**: High (R-4.1-1)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L39

**TC-003** — Route `/admin/debug` bloccata per studenti autenticati
- **Given**: Studente autenticato con JWT valido (role=student)
- **When**: Tentativo accesso `/admin/debug`
- **Then**: Errore 403 Forbidden o redirect
- **Priority**: Critical (R-4.1-1)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L39

### AC2 — Input Domanda di Test

**TC-010** — Textarea domanda renderizzata con label e placeholder
- **Given**: Admin su `/admin/debug`
- **When**: Verifica UI form
- **Then**: Textarea con label "Domanda di test" e placeholder "Inserisci una domanda per testare..."
- **Priority**: Medium (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L139–L140

**TC-011** — Textarea espandibile per domande lunghe
- **Given**: Admin inserisce domanda >200 caratteri
- **When**: Digitazione in textarea
- **Then**: Textarea si espande verticalmente (auto-resize o scroll)
- **Priority**: Low (UX enhancement)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L73

**TC-012** — Button submit disabilitato con textarea vuota
- **Given**: Admin su `/admin/debug` con textarea vuota
- **When**: Verifica stato button "Esegui Query Debug"
- **Then**: Button disabilitato (disabled=true) o validazione client-side
- **Priority**: Medium (UX enhancement)
- **Fonte**: Pattern validazione form standard

**TC-013** — Button submit enabled con domanda valida
- **Given**: Admin inserisce domanda non vuota
- **When**: Verifica stato button submit
- **Then**: Button enabled e clickable
- **Priority**: Medium (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L141

### AC3 — Visualizzazione Risposta Finale + Chunk + Metadati

**TC-020** — Risposta finale visualizzata in sezione dedicata
- **Given**: Admin esegue query debug con successo
- **When**: Verifica response rendering
- **Then**: Sezione "Risposta Finale" presente con contenuto LLM generato
- **Priority**: High (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L17–L18, L143

**TC-021** — Chunk recuperati visualizzati con count
- **Given**: Debug query restituisce 5 chunk
- **When**: Verifica UI chunk list
- **Then**: Sezione "Chunk Recuperati (5)" presente; 5 chunk cards renderizzate
- **Priority**: High (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L19, L144

**TC-022** — Ogni chunk include content preview
- **Given**: Chunk list visualizzata
- **When**: Ispezione singolo chunk card
- **Then**: Content preview (primi 200 caratteri o configurabile) visibile
- **Priority**: High (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L82

**TC-023** — Ogni chunk include similarity score badge
- **Given**: Chunk list visualizzata
- **When**: Ispezione singolo chunk card
- **Then**: Badge "Score: 0.95" (o valore effettivo) visibile e formattato
- **Priority**: High (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L19, L77, L145

**TC-024** — Ogni chunk include metadati completi
- **Given**: Chunk list visualizzata
- **When**: Espansione metadati chunk (se collapsable) o visualizzazione diretta
- **Then**: Metadati presenti: document_name, page_number, chunking_strategy
- **Priority**: High (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L20, L52–L57

**TC-025** — Timing metrics visualizzati
- **Given**: Debug query completata
- **When**: Verifica UI performance feedback
- **Then**: Timing metrics "Retrieval: 150ms | Generation: 2300ms" (valori esempio) visibili
- **Priority**: Medium (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L83, L147

### AC4 — Chunk Ordinati per Rilevanza (Score Decrescente)

**TC-030** — Chunk ordinati da score più alto a più basso
- **Given**: Debug query restituisce chunk con scores [0.95, 0.87, 0.82, 0.75, 0.68]
- **When**: Verifica ordine rendering chunk list
- **Then**: Chunk visualizzati in ordine: 0.95 → 0.87 → 0.82 → 0.75 → 0.68
- **Priority**: High (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L21

**TC-031** — Verifica ordinamento con score identici
- **Given**: Chunk con score duplicati [0.90, 0.90, 0.85]
- **When**: Verifica ordine rendering
- **Then**: Chunk con score 0.90 entrambi prima di 0.85 (ordinamento secondario stabile o by ID)
- **Priority**: Low (edge case)
- **Fonte**: Logica ordinamento standard

### AC5 — Distinzione Visiva Risposta Finale / Chunk

**TC-040** — Risposta finale e chunk list visivamente separate
- **Given**: Debug query completata
- **When**: Verifica layout UI
- **Then**: Sezione "Risposta Finale" distinguibile da sezione "Chunk Recuperati" (card separati, spacing, titoli)
- **Priority**: Medium (AC completion)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L22, L81

**TC-041** — Risposta finale con styling differenziato
- **Given**: Risposta finale renderizzata
- **When**: Verifica styling Card componente
- **Then**: Styling distinguibile da chunk cards (es. background diverso, border, font size)
- **Priority**: Medium (UX enhancement)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L75

### AC6 — Accesso Solo Admin Autenticati

**TC-050** — Endpoint `/api/v1/admin/debug/query` richiede JWT
- **Given**: Request senza Authorization header
- **When**: POST `/api/v1/admin/debug/query`
- **Then**: Response 401 Unauthorized
- **Priority**: Critical (R-4.1-1)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L39

**TC-051** — Endpoint verifica role=admin nel JWT payload
- **Given**: JWT valido con claim `app_metadata.role = "student"`
- **When**: POST `/api/v1/admin/debug/query` con Authorization header
- **Then**: Response 403 Forbidden
- **Priority**: Critical (R-4.1-1)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L41, L94

**TC-052** — Endpoint accetta JWT admin valido
- **Given**: JWT valido con claim `app_metadata.role = "admin"`
- **When**: POST `/api/v1/admin/debug/query` con body `{"question": "test query"}`
- **Then**: Response 200 OK con payload `DebugQueryResponse`
- **Priority**: Critical (R-4.1-1)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L94

**TC-053** — JWT manipulation attempt bloccato
- **Given**: JWT con signature invalida o claim `role` manipolato
- **When**: POST endpoint debug
- **Then**: Response 401 Unauthorized (verifica firma fallisce)
- **Priority**: Critical (R-4.1-1)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` Security Testing L158

### AC7 — Theming Light/Dark con Variabili Semantiche

**TC-060** — Rendering corretto tema Light
- **Given**: Tema Light attivo
- **When**: Navigazione `/admin/debug` e submit query
- **Then**: UI renderizzata con palette Light; contrasto WCAG AA rispettato
- **Priority**: High (R-4.1-9)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L24, L68

**TC-061** — Rendering corretto tema Dark
- **Given**: Tema Dark attivo
- **When**: Navigazione `/admin/debug` e submit query
- **Then**: UI renderizzata con palette Dark; variabili semantiche applicate (background, foreground, card)
- **Priority**: High (R-4.1-9)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L24, L68

**TC-062** — Assenza colori hard-coded
- **Given**: Implementazione `AdminDebugPage`, `ChunkCard`, `ChunkList`
- **When**: Code review e CSS inspection
- **Then**: Nessun valore hex/rgb diretto; solo variabili CSS semantiche Tailwind
- **Priority**: High (R-4.1-9)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L68, L125

**TC-063** — Switch tema durante sessione senza glitch
- **Given**: Admin su `/admin/debug` con risultati visualizzati in tema Light
- **When**: Switch a tema Dark
- **Then**: UI aggiorna colori immediatamente senza flash/glitch; contrasto mantenuto
- **Priority**: Medium (UX enhancement)
- **Fonte**: Pattern theming standard

### AC8 — Accessibilità: Keyboard Nav, Focus, Label

**TC-070** — Label esplicite su form controls
- **Given**: Form debug query renderizzato
- **When**: Ispezione DOM textarea e button
- **Then**: Textarea ha `<label for="question">` o aria-label; button ha testo descrittivo
- **Priority**: High (R-4.1-9)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L25, L122

**TC-071** — Focus visibile su tutti elementi interattivi
- **Given**: Admin naviga con Tab
- **When**: Focus su textarea, button, chunk cards (se interattive)
- **Then**: Indicatore focus visibile e chiaro (outline, ring)
- **Priority**: High (R-4.1-9)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L25, L123

**TC-072** — Keyboard navigation logica su chunk list
- **Given**: Chunk list con 5 chunk visualizzati
- **When**: Navigazione con Tab/Shift+Tab
- **Then**: Tab order logico (form → risultati → chunk in ordine); nessun focus trap indesiderato
- **Priority**: High (R-4.1-9)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L124

**TC-073** — ARIA attributes corretti su componenti complessi
- **Given**: Chunk list, accordion (se usato), cards
- **When**: Ispezione DOM
- **Then**: ARIA roles appropriati (es. `role="region"` per sezioni, `aria-expanded` per collapsible)
- **Priority**: Medium (R-4.1-9)
- **Fonte**: `docs/front-end-spec.md` Sez. 7 accessibility requirements

### Backend Security & Cost Control

**TC-080** — Rate limiting enforcement (10 queries/hour)
- **Given**: Admin esegue 10 debug queries in 1 ora
- **When**: Tentativo 11ª query
- **Then**: Response 429 Too Many Requests con retry-after header
- **Priority**: Critical (R-4.1-3)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L42, L151

**TC-081** — Rate limit scope isolato per endpoint debug
- **Given**: Admin esegue 10 debug queries (rate limit raggiunto)
- **When**: Studente esegue query su `/api/v1/chat/query`
- **Then**: Query studente non bloccata (scope rate limit separato)
- **Priority**: High (R-4.1-3)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L151

**TC-082** — Audit logging accessi debug
- **Given**: Admin esegue debug query
- **When**: Verifica logs backend
- **Then**: Log entry presente con: admin_id, timestamp, question (hashed o sanitized), chunk_count
- **Priority**: High (R-4.1-2)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L41, L156

**TC-083** — Nessun PII esposto in logs
- **Given**: Chunk contengono potenziali PII (nomi, email)
- **When**: Verifica logs audit
- **Then**: PII non loggato in chiaro; solo metadati aggregati (chunk_count, document_id)
- **Priority**: High (R-4.1-2)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L41

### Backend Performance & Resilience

**TC-090** — Performance isolation endpoint studenti
- **Given**: 5 admin eseguono debug queries concorrenti
- **When**: Studente esegue query su `/api/v1/chat/query`
- **Then**: Latency P95 endpoint studenti <8s (baseline mantenuto)
- **Priority**: High (R-4.1-4)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L43, L154

**TC-091** — Gestione errore OpenAI API failure
- **Given**: Mock OpenAI API restituisce 500 Internal Error
- **When**: Admin esegue debug query
- **Then**: Response 500 con error message informativo; no crash backend
- **Priority**: High (R-4.1-6)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L45, L103

**TC-092** — Gestione errore embedding API timeout
- **Given**: Mock embedding API timeout dopo 30s
- **When**: Admin esegue debug query
- **Then**: Response 504 Gateway Timeout con message; no hanging request
- **Priority**: High (R-4.1-6)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L103

**TC-093** — Gestione nessun chunk trovato
- **Given**: Query debug con domanda fuori topic (no chunk con similarity >threshold)
- **When**: Verifica response
- **Then**: Response 200 OK con `chunks: []`, `answer: "Non ho trovato informazioni..."`
- **Priority**: Medium (R-4.1-6)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L103

**TC-094** — Timing metrics accuracy
- **Given**: Mock retrieval con sleep 100ms, generation con sleep 500ms
- **When**: Verifica response timing metrics
- **Then**: `retrieval_time_ms` ~100±10, `generation_time_ms` ~500±10
- **Priority**: Medium (R-4.1-8)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L47, L158

### Frontend XSS Prevention & Sanitization

**TC-100** — XSS payload in chunk content sanitized
- **Given**: Mock chunk con content `<script>alert('xss')</script>`
- **When**: Rendering chunk card
- **Then**: Script tag escaped o stripped; no alert eseguito
- **Priority**: Critical (R-4.1-5)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L44, L156

**TC-101** — XSS payload via img tag sanitized
- **Given**: Mock chunk con content `<img src=x onerror=alert(1)>`
- **When**: Rendering chunk card
- **Then**: Img tag stripped o src sanitized; no alert eseguito
- **Priority**: Critical (R-4.1-5)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L44

**TC-102** — Markdown safe rendering risposta finale
- **Given**: Risposta LLM con markdown legittimo (`**bold**, [link](url)`)
- **When**: Rendering sezione risposta finale
- **Then**: Markdown renderizzato correttamente con sanitization (`react-markdown` + `rehype-sanitize`)
- **Priority**: High (R-4.1-5)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L75, L156

**TC-103** — User input (domanda) escaped in UI
- **Given**: Admin inserisce domanda con HTML `<b>test</b>`
- **When**: Rendering echo domanda in UI (se presente)
- **Then**: HTML escaped; renderizzato come testo plain
- **Priority**: Medium (XSS prevention)
- **Fonte**: Standard XSS prevention

### Frontend UI Scalability & Error Handling

**TC-110** — UI rendering con 50 chunk senza memory leak
- **Given**: Mock response con 50 chunk
- **When**: Rendering chunk list; Chrome DevTools Memory profiler attivo
- **Then**: Rendering completo in <3s; no memory leak rilevato dopo unmount
- **Priority**: High (R-4.1-7)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L46, L155

**TC-111** — Limite max chunk visualizzati (top 10-15)
- **Given**: Backend restituisce 50 chunk
- **When**: Verifica UI chunk list
- **Then**: Solo top 10 (o configurabile) visualizzati; warning UI "Showing top 10 of 50"
- **Priority**: Medium (R-4.1-7)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L155

**TC-112** — Loading state durante query execution
- **Given**: Admin submit query; API response delayed 3s
- **When**: Verifica UI durante waiting
- **Then**: Spinner/skeleton + text "Elaborazione query in corso..." visibile; form disabilitato
- **Priority**: Medium (UX enhancement)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L78, L142

**TC-113** — Error state con API failure
- **Given**: API restituisce 500 Internal Error
- **When**: Verifica UI error handling
- **Then**: Error message actionable visualizzato (es. "Errore server. Riprova."); no crash frontend
- **Priority**: High (R-4.1-6)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L85

**TC-114** — Empty state con zero chunk
- **Given**: API restituisce `chunks: []`
- **When**: Verifica UI chunk section
- **Then**: Empty state message "Nessun chunk recuperato. Verifica la base di conoscenza."
- **Priority**: Medium (UX enhancement)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L84, L146

**TC-115** — Fallback UI per metadati chunk mancanti
- **Given**: Chunk senza `page_number` (null/undefined)
- **When**: Rendering metadati chunk card
- **Then**: Fallback text "Pagina: N/A" o "non disponibile" invece di crash
- **Priority**: Low (R-4.1-10)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L49

## E2E (Prerequisiti e Best Practices)

### Setup Pre-Test
- **Admin Auth**: Impostare JWT admin in sessionStorage prima di `goto`:
  ```ts
  await page.addInitScript(() => {
    sessionStorage.setItem("admin_jwt", "mock-admin-token");
  });
  ```
  [Fonte: Pattern da `docs/stories/3.3.frontend-chat-integration.md` L17–L25]

- **Attese esplicite**: Usare `waitForSelector` per visibilità form, risultati; timeout adeguato per API calls (max 10s). [Fonte: `docs/qa/review-qa-report-20250926.md` L46–L50]

- **Mock Backend**: Considerare MSW (Mock Service Worker) per mock endpoint debug in E2E tests isolati.

### Scenari E2E Prioritari

**E2E-001** — Happy Path: Admin Debug Query End-to-End
1. Admin login (mock JWT admin)
2. Navigare a `/admin/debug`
3. Inserire domanda "Cos'è la fisioterapia respiratoria?"
4. Click button "Esegui Query Debug"
5. Attendere loading state
6. Verificare risposta finale visibile
7. Verificare chunk list con count >0
8. Verificare timing metrics visualizzati
- **Priority**: Critical (End-to-End coverage)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L130

**E2E-002** — Admin Auth Guard: Blocco Accesso Studente
1. Student login (mock JWT student)
2. Tentativo navigazione diretta a `/admin/debug`
3. Verificare redirect a `/chat` o error page 403
- **Priority**: Critical (R-4.1-1)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L39

**E2E-003** — Keyboard Navigation Completa
1. Admin su `/admin/debug`
2. Tab fino a textarea domanda
3. Inserire testo con tastiera
4. Tab a button submit
5. Enter per submit
6. Attendere risultati
7. Tab per navigare chunk cards
8. Verificare focus visibile in ogni step
- **Priority**: High (R-4.1-9)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L131

**E2E-004** — Theming Switch Durante Sessione
1. Admin su `/admin/debug` in tema Light
2. Submit query e verificare risultati
3. Switch a tema Dark (UI toggle)
4. Verificare rendering corretto chunk cards e risposta
5. Submit nuova query in tema Dark
6. Verificare consistenza theming
- **Priority**: High (R-4.1-9)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L132

**E2E-005** — Error Handling: API Failure
1. Mock backend endpoint debug → 500 error
2. Admin submit query
3. Verificare error message UI
4. Verificare form re-enabled per retry
- **Priority**: High (R-4.1-6)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L133

**E2E-006** — Empty Results: Zero Chunk
1. Mock backend → response con `chunks: []`
2. Admin submit query
3. Verificare empty state message visualizzato
4. Verificare risposta finale comunque presente (se LLM restituisce testo)
- **Priority**: Medium (Edge case)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L133

[Fonte generale: `docs/stories/4.1.admin-debug-view.md` L129–L133]

## Backend Test Design

### Endpoint: POST /api/v1/admin/debug/query

**Request Schema**:
```json
{
  "question": "string (required, non-empty)"
}
```

**Response Schema** (200 OK):
```json
{
  "question": "string",
  "answer": "string",
  "chunks": [
    {
      "chunk_id": "uuid",
      "content": "string",
      "similarity_score": 0.95,
      "metadata": {
        "document_id": "uuid",
        "document_name": "filename.pdf",
        "page_number": 12,
        "chunking_strategy": "recursive"
      }
    }
  ],
  "retrieval_time_ms": 150,
  "generation_time_ms": 2300
}
```

[Fonte: `docs/stories/4.1.admin-debug-view.md` L42–L63]

### Backend Unit Tests

**BT-001** — Happy path: admin query con chunk trovati
- **Given**: JWT admin valido, domanda valida, mock retrieval 5 chunk, mock generation OK
- **When**: POST `/api/v1/admin/debug/query`
- **Then**: 200 OK; response con answer + 5 chunks + timing metrics
- **Priority**: Critical
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L95–L98

**BT-002** — Auth: JWT mancante
- **Given**: Request senza Authorization header
- **When**: POST endpoint
- **Then**: 401 Unauthorized
- **Priority**: Critical (R-4.1-1)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L93

**BT-003** — Auth: JWT student (non admin)
- **Given**: JWT valido con `role=student`
- **When**: POST endpoint
- **Then**: 403 Forbidden
- **Priority**: Critical (R-4.1-1)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L94

**BT-004** — Auth: JWT admin valido
- **Given**: JWT valido con `role=admin`
- **When**: POST endpoint con question
- **Then**: 200 OK (auth check passed)
- **Priority**: Critical (R-4.1-1)
- **Fonte**: medesima

**BT-005** — Validation: question empty
- **Given**: Body `{"question": ""}`
- **When**: POST endpoint
- **Then**: 422 Unprocessable Entity (Pydantic validation error)
- **Priority**: Medium
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L91

**BT-006** — Validation: question missing
- **Given**: Body `{}`
- **When**: POST endpoint
- **Then**: 422 Unprocessable Entity
- **Priority**: Medium
- **Fonte**: medesima

**BT-010** — Rate limiting: 11th query in 1 hour
- **Given**: 10 debug queries già eseguite in 1 ora
- **When**: POST 11ª query
- **Then**: 429 Too Many Requests con retry-after header
- **Priority**: Critical (R-4.1-3)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L42, L151

**BT-011** — Rate limiting: reset dopo 1 ora
- **Given**: 10 queries eseguite; attesa 1 ora
- **When**: POST nuova query
- **Then**: 200 OK (rate limit resetted)
- **Priority**: High (R-4.1-3)
- **Fonte**: medesima

**BT-020** — Retrieval: nessun chunk trovato
- **Given**: Mock vector search → empty results
- **When**: POST endpoint
- **Then**: 200 OK; `chunks: []`; answer con disclaimer "no info found"
- **Priority**: Medium
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L103

**BT-021** — Retrieval: chunk senza metadati opzionali
- **Given**: Mock chunk con `page_number: null`
- **When**: Verifica response
- **Then**: Chunk incluso in response; metadati null preservati (no crash)
- **Priority**: Low (R-4.1-10)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L49

**BT-030** — Generation: OpenAI API failure
- **Given**: Mock OpenAI client → raise Exception
- **When**: POST endpoint
- **Then**: 500 Internal Server Error; error logged; no crash
- **Priority**: High (R-4.1-6)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L45

**BT-031** — Generation: OpenAI API timeout
- **Given**: Mock OpenAI client → timeout 30s
- **When**: POST endpoint
- **Then**: 504 Gateway Timeout; error logged
- **Priority**: High (R-4.1-6)
- **Fonte**: medesima

**BT-040** — Timing metrics: accuracy verification
- **Given**: Mock retrieval 100ms, generation 500ms (controlled with sleep)
- **When**: Verifica response timing
- **Then**: `retrieval_time_ms` 100±10; `generation_time_ms` 500±10
- **Priority**: Medium (R-4.1-8)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L47

**BT-050** — Audit logging: admin_id logged
- **Given**: Admin JWT con sub=admin123
- **When**: POST endpoint
- **Then**: Log entry con admin_id=admin123, timestamp, question_hash
- **Priority**: High (R-4.1-2)
- **Fonte**: `docs/qa/assessments/4.1-risk-20250930.md` L41, L156

**BT-051** — Audit logging: nessun PII in logs
- **Given**: Chunk content con email/nome
- **When**: Verifica logs
- **Then**: Solo metadati aggregati (chunk_count, document_id); no email/nome
- **Priority**: High (R-4.1-2)
- **Fonte**: medesima

### Backend Integration Tests

**BI-001** — End-to-end flow con mock Supabase + OpenAI
- **Given**: Mock Supabase vector search (5 chunk), mock OpenAI (response OK)
- **When**: Admin POST debug query
- **Then**: 200 OK; response completa con answer + 5 chunks + scores + timing
- **Priority**: Critical
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L102

**BI-002** — Chunk ordering: score decrescente
- **Given**: Mock retrieval con scores [0.75, 0.95, 0.82, 0.68, 0.90]
- **When**: Verifica response chunks array
- **Then**: Ordinamento: [0.95, 0.90, 0.82, 0.75, 0.68]
- **Priority**: High (AC4)
- **Fonte**: `docs/stories/4.1.admin-debug-view.md` L21, L97

## Test Manuali (Pre-Release)

### Security Audit
- **Penetration Testing**: Tentativo bypass auth con JWT manipulation (expired token, invalid signature, role claim tampering). [Fonte: `docs/qa/assessments/4.1-risk-20250930.md` L158]
- **XSS Payload Testing**: Inserimento payload HTML/JS in mock chunk; verifica sanitization UI. [Fonte: medesima L156]
- **Data Exposure Review**: Verifica logs audit per presenza PII; review screenshot UI per leak dati sensibili. [Fonte: medesima L160]

### Accessibility Audit
- **Screen Reader**: NVDA (Windows) o VoiceOver (macOS) test completo:
  1. Navigazione form debug query con screen reader
  2. Annunci risultati (risposta finale, chunk list)
  3. Metadati chunk annunciati correttamente
- **Keyboard Navigation**: Verifica tab order logico; focus visibile; Enter/Space activation. [Fonte: `docs/stories/4.1.admin-debug-view.md` L177]

### Performance Testing
- **Load Test Backend**: JMeter/k6 con 5 admin concorrenti; 10 queries ciascuno in 5 minuti.
  - Verifica: latency P95 endpoint debug <5s
  - Verifica: endpoint studenti `/api/v1/chat/query` latency non degradata
  - [Fonte: `docs/qa/assessments/4.1-risk-20250930.md` L154]

- **Frontend Memory Profiling**: Chrome DevTools con 50 chunk renderizzati; verifica no memory leak. [Fonte: medesima L155]

### Visual Regression Testing
- **Theming**: Screenshot baseline Light/Dark per debug page; automated comparison post-changes. [Fonte: `docs/stories/4.1.admin-debug-view.md` L126]

## Monitoring Requirements

### Build-time
- Linter security checks: `bandit` (Python backend), `eslint-plugin-security` (TypeScript frontend). [Fonte: `docs/qa/assessments/4.1-risk-20250930.md` L150]
- Static analysis: verificare presenza `_is_admin()` check in endpoint debug (pre-commit hook). [Fonte: medesima L151]
- TypeScript strict mode enabled; no `any` types in debug components. [Fonte: medesima L152]

### CI/CD
- Unit tests backend: minimum 95% coverage endpoint debug e auth logic. [Fonte: medesima L153]
- E2E tests: tutti scenari E2E-001 a E2E-006 passing required for merge. [Fonte: medesima L154]
- Performance regression tests: baseline endpoint chat latency monitored durante test debug. [Fonte: medesima L154]

### Runtime (Post-Deploy)
- **Cost Monitoring**: Dashboard metriche debug queries count, OpenAI API calls, embedding API calls; alert se >threshold. [Fonte: medesima L156]
- **Audit Logging**: Logs strutturati (JSON) con admin_id, timestamp, question_hash, chunk_count. [Fonte: medesima L156]
- **Performance Metrics**: APM (es. Sentry) con tracing endpoint debug; latency P50/P95/P99; error rate. [Fonte: medesima L157]

### Manual (Pre-Release)
- Penetration testing: auth bypass, XSS, rate limiting bypass attempts. [Fonte: medesima L158]
- Security review: audit logs per PII exposure. [Fonte: medesima L160]
- Accessibility audit: screen reader test completo (NVDA/VoiceOver). [Fonte: medesima L161]

## Metriche

- **Coverage Target**: 
  - Backend: 95% unit test coverage su endpoint debug e auth logic
  - Frontend: 80% component test coverage su AdminDebugPage, ChunkCard, ChunkList

- **Pass Rate Minimum**: 
  - 100% per Critical priority tests (TC-002, TC-003, TC-050, TC-051, TC-052, TC-053, TC-080, TC-100, TC-101)
  - 100% per High priority tests (AC completion + security)
  - 90% per Medium/Low priority tests

- **Performance**:
  - Endpoint debug latency P95: <5s (retrieval + generation)
  - Frontend rendering 10 chunk: <500ms
  - No performance degradation endpoint studenti durante debug queries

- **Security**:
  - Zero vulnerabilities OWASP Top 10 (verified via penetration testing)
  - Zero PII leaks in logs (verified via audit)
  - Rate limiting enforcement: 100% (no bypass)

## Gate Alignment

Questo test design è allineato al Risk Profile e gate requirements: [Fonte: `docs/qa/assessments/4.1-risk-20250930.md` L167–L186]

```yaml
risk_summary:
  totals:
    critical: 1
    high: 4
    medium: 3
    low: 2
  risk_score: 53
  highest_priority_risks:
    - R-4.1-1: "Admin authentication bypass"
    - R-4.1-2: "Data exposure in debug view"
    - R-4.1-3: "Uncontrolled API costs"
    - R-4.1-4: "Performance degradation student queries"
    - R-4.1-5: "XSS via unsanitized markdown"
  recommendations:
    must_fix_pre_implementation:
      - R-4.1-1: "Implementare auth check admin con test coverage 100%"
      - R-4.1-3: "Rate limiting endpoint debug obbligatorio"
      - R-4.1-5: "Setup sanitization markdown con react-markdown + rehype-sanitize"
    must_test_pre_gate:
      - "Auth bypass attempts (JWT manipulation, role tampering)"
      - "XSS injection payload tests"
      - "Performance isolation (student endpoint latency during debug)"
      - "Rate limiting enforcement"
    monitor_post_deploy:
      - "Cost metrics debug queries (alert >threshold)"
      - "Audit logs accessi admin"
      - "Performance metrics endpoint chat (detect regression)"
  blockers:
    - risk_id: R-4.1-1
      description: "Admin auth bypass è blocker critico"
      resolution_required: "Auth implementation + tests prima di procedere con frontend"
```

## Review Hook

```
Test design: docs/qa/assessments/4.1-test-design-20250930.md
Story: docs/stories/4.1.admin-debug-view.md
Risk Profile: docs/qa/assessments/4.1-risk-20250930.md

Total Test Cases: 85+
Critical Priority: 10
High Priority: 22
Medium Priority: 25
Low Priority: 8

Backend Tests: 20+ unit + integration
Frontend Tests: 25+ component + E2E
Security Tests: 10+ auth + XSS + rate limiting
Performance Tests: 5+ load + isolation

Coverage Target: Backend 95%, Frontend 80%
Pass Rate Minimum: 100% Critical/High, 90% Medium/Low
```
