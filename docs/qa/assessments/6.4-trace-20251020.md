# Requirements Traceability Matrix

## Story: 6.4 - RAG Activation - Embedding Generation for Watcher Pipeline

### Coverage Summary

- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Embedding Generation per Chunk Esistenti (Batch Fix)

Coverage: FULL

Given-When-Then Mappings:

- Unit Test: pps/api/tests/test_generate_missing_embeddings.py::test_generates_embeddings_for_missing_chunks
  - Given: Chunks without embeddings in DB
  - When: Running batch script generate_missing_embeddings.py
  - Then: Embeddings are created and stored; idempotent on reruns

- Unit Test: pps/api/tests/test_indexing_unit.py::test_index_chunks_retries_on_openai_429
  - Given: Transient OpenAI 429 responses
  - When: Invoking index_chunks with retry policy
  - Then: Succeeds after retries, no duplicates written

- Reliability Test: pps/api/tests/test_openai_resilience.py::test_embedding_retry_backoff
  - Given: Backoff strategy enabled
  - When: Embedding service throttles
  - Then: Backoff applied and operation eventually succeeds

#### AC2: Integrazione Indexing nel Watcher (sync MVP / optional Celery)

Coverage: FULL

- Integration Test: pps/api/tests/test_watcher_embedding_integration.py::test_watcher_indexes_new_chunks
  - Given: New ingested document with chunks
  - When: Watcher scan_once completes
  - Then: index_chunks is called and embeddings are persisted

- Integration Test: pps/api/tests/test_watcher_db_integration.py::test_transactional_ingestion_and_indexing
  - Given: Async ingestion with transaction
  - When: Document and chunks stored
  - Then: Indexing occurs without violating transaction boundaries

- Runtime Test: pps/api/tests/test_watcher_runtime.py::test_watcher_handles_indexing_errors_gracefully
  - Given: Indexing error occurs
  - When: Watcher continues after logging warning
  - Then: Pipeline remains operational

#### AC2.5: Concurrency Safety (Advisory Locks)

Coverage: FULL

- Concurrency Test: pps/api/tests/test_indexing_concurrency.py::test_batch_and_watcher_coordinate_with_advisory_locks
  - Given: Watcher and batch process same document
  - When: Both attempt to index concurrently
  - Then: Advisory locks ensure only one proceeds; no duplicates

- Reliability Test: pps/api/tests/test_robust_indexing.py::test_lock_release_on_exception
  - Given: Exception during indexing
  - When: Lock held by process
  - Then: Lock released in finally block; no deadlocks

#### AC3: Verifiche Post-Indexing (search + chat)

Coverage: FULL

- Performance/Search Test: pps/api/tests/test_performance_semantic_search.py::test_semantic_search_returns_relevant_chunks
  - Given: Embeddings present for all chunks
  - When: perform_semantic_search called with query
  - Then: At least 3 relevant chunks returned; similarity >= 0.6

- API Test: pps/api/tests/test_chat_query.py::test_chat_query_returns_citations
  - Given: Indexed KB with embeddings
  - When: POST /api/v1/chat/query invoked
  - Then: Non-empty answers with citations

- E2E Test: pps/api/tests/test_rag_activation_e2e.py::test_full_rag_flow_with_embeddings
  - Given: Ingestion ? chunking ? embedding completed
  - When: Chat session message posted
  - Then: Answer references content; non-empty citations

#### AC4: Monitoring & Health Check

Coverage: FULL

- Router Test: pps/api/tests/test_monitoring_router.py::test_embedding_health_endpoint_summary
  - Given: Admin authenticated user
  - When: GET /api/v1/admin/debug/embedding-health
  - Then: Summary and per-document breakdown returned

- Security Test: pps/api/tests/test_admin_debug.py::test_admin_debug_rate_limited
  - Given: Rate limiting configured for admin debug scope
  - When: Exceeding 10/hour threshold
  - Then: 429 returned; route protected

- Schema Test: pps/api/tests/test_indexing_admin.py::test_embedding_health_schema
  - Given: Pydantic response schemas
  - When: Endpoint returns data
  - Then: Matches schema; fields validated

### Critical Gaps

None identified for AC1–AC4. Keep performance SLO assertions in CI under --run-integration.

### Test Design Recommendations

- Add timing assertions to 	est_performance_semantic_search.py and health endpoint to surface p95 retrieval time.
- Add negative tests for advisory lock contention across multiple documents.
- Add skip markers and env-gated secrets for OpenAI-dependent tests.

### Risk Assessment

- High Risk: None (core ACs fully covered with unit+integration+E2E)
- Medium Risk: Performance drift if SLOs not enforced in CI
- Low Risk: Residual indexing retries after transient failures