# NFR Assessment: 9.1 – Hybrid Memory Foundation

Date: 2025-11-12
Reviewer: Quinn

Story: docs/stories/9.1-hybrid-memory-foundation.md

## Summary

- Performance/Latency: PASS – L1 cache (<2000 token) mantiene ultimi 3 turni; persistenza L2 asincrona con timeout 5s e backpressure (max 100) evita impatti su p95 chat latency. Indici mirati per query comuni.
- Reliability/Resilience: PASS – Circuit breaker (3 errori/latency>1s → open 30s), bounded queue, graceful degradation a in‑memory only, durable outbox con retry/backoff e DLQ.
- Observability: PASS – Metriche richieste coperte (writes ok/fail/timeout, histogram latency, cache hits/miss, active sessions, backpressure, circuit breaker, outbox depth, retry, DLQ). Logging strutturato previsto.
- Security: PASS – Nessun PII aggiuntivo; uso idempotency key deterministica; raccomandata cifratura at-rest by Supabase e least privilege su indici/viste.
- Scalability: PASS – Bulk insert, indici appropriati (session+created_at, created_at, FTS GIN, partial su archived), architettura dual-write asincrona.
- Maintainability: PASS – Servizi separati (HybridConversationManager, ConversationPersistenceService), feature flag per roll-out sicuro, backward compatibility con 7.1.
- Testability: PASS – Coverage ≥80% richiesto per moduli nuovi, test di integrazione su dual‑write, backpressure e circuit breaker.

Quality Score: 96/100 (note minori su governance DLQ e privacy-by-default)

## Evidence

- AC1/5: L1 cache + compatibilità con 7.1; HybridConversationManager estende ConversationManager (story Tasks 3.x).
- AC2: Persistenza asincrona con timeout 5s, backpressure max 100, circuit breaker (Tasks 3.4, 3.8–3.11).
- AC3: Feature flag `ENABLE_PERSISTENT_MEMORY` per abilitazione/disabilitazione con graceful degradation.
- AC4: Specifica indici SQL e migrazione dedicata (Tasks 2.1–2.4) incl. FTS italiano GIN, partial index archived.
- AC6: Degradazione a in‑memory only in caso DB down (zero downtime dichiarato, coperto da breaker+outbox).
- AC7: Elenco metriche dettagliato da implementare in utils/metrics e integrazione nei flussi async.
- AC8: Coverage 80%+ e test di integrazione su dual‑write/backpressure/breaker.
- AC9: Durable outbox pattern con idempotency key `sha256(session_id + timestamp + content_hash)`, exponential backoff, DLQ >10 retry.

## Scope & Assunzioni

- Carico tipico: chat interattiva con burst brevi; write rate moderato (<< 1k msg/min). Supabase Postgres gestisce indici senza degrado rilevante.
- FTS: lingua italiana configurata in `to_tsvector('italian', ...)` come da migrazione.
- Outbox: file JSONL locale `.data/persistence_outbox.jsonl` su storage affidabile del pod/VM; in ambienti container si raccomanda volume persistente.

## Risks & Mitigations

- DLQ governance non definita: definire processo periodico di drain/alerting. Mitigazione: alert su `dlq_messages_total` e playbook runbook.
- Privacy by default: assicurare che `content` non includa PII non necessari; valutare redaction lato app se richiesto. Mitigazione: flag di redaction opzionale.
- Backpressure drop oldest: rischio perdita di ultimi messaggi in overload prolungato. Mitigazione: metriche e alert su `backpressure_activated`; tuning MAX_PENDING_WRITES per ambienti.
- FTS costo storage: monitorare crescita indice GIN. Mitigazione: autovacuum tuning e partial FTS se necessario.

## Verification Plan (NFR scenarios)

- Latency: misurare p95 chat end‑to‑end con `ENABLE_PERSISTENT_MEMORY=true/false`; verificare invarianza entro ±10% sotto carico moderato.
- Throughput: test burst 200 msg/min sessione, verificare assenza di timeouts (`db_writes_timeout=0`) e `backpressure_activated` limitato.
- Resilience: simulare 3 errori consecutivi DB → `circuit_breaker_open=1` per 30s; verify graceful degradation e assenza di errori utente.
- Outbox: simulare DB down 2 min → accumulo in `.data/persistence_outbox.jsonl`, retry con backoff, zero duplicati via idempotency.
- Indici: EXPLAIN ANALYZE su history sessione e FTS; target `idx_chat_messages_session_created` utilizzato e FTS con GIN.
- Observability: tutte le metriche esposte con valori non nulli durante test; histogram `db_write_latency_ms` popolato.

## Quick Wins

- Aggiungere alerting base su: `db_writes_failed`, `circuit_breaker_open`, `backpressure_activated`, `dlq_messages_total`.
- Log idempotency conflict con chiave e hash contenuto truncato per audit.
- Proteggere `.data/` con .gitignore esistente e permessi ristretti in produzione.

## Gate YAML (incolla sotto nfr_validation)

```
nfr_validation:
  _assessed: [performance, reliability, observability, security, scalability, maintainability, testability, data_integrity]
  performance:
    status: PASS
    notes: L1 cache e persistenza asincrona con backpressure/timeout; indici ottimizzati
  reliability:
    status: PASS
    notes: Circuit breaker, bounded queue, graceful degradation, outbox con retry+DLQ
  observability:
    status: PASS
    notes: Metriche complete (writes ok/fail/timeout, latency histogram, cache, queue, breaker, retry, DLQ)
  security:
    status: PASS
    notes: Nessun secret introdotto; idempotency key deterministica; storage Supabase cifrato
  scalability:
    status: PASS
    notes: Bulk insert, indici su pattern principali, dual‑write asincrono
  maintainability:
    status: PASS
    notes: Servizi separati, feature flag, compatibilità con 7.1
  testability:
    status: PASS
    notes: Coverage ≥80%, test integrazione dual‑write/backpressure/breaker
  data_integrity:
    status: PASS
    notes: Idempotency + ON CONFLICT, outbox eventual consistency, DLQ monitorato
```

---

NFR assessment: docs/qa/assessments/9.1-nfr-20251112.md

Gate NFR block pronto → incolla nel gate file relativo alla story (docs/qa/gates/9.1-<slug>.yml) sotto `nfr_validation`.

