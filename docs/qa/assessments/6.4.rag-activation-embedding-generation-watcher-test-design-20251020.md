# Test Design — Story 6.4: RAG Activation — Embedding Generation for Watcher Pipeline

Data: 2025-10-20
Riferimento Story: docs/stories/6.4.rag-activation-embedding-generation-watcher.md
Ambito: AC1 (batch embeddings), AC2 (watcher indexing), AC2.5 (concurrency & locks), AC3 (verifiche post-indexing), AC4 (monitoring)
Priorità: P0 (critico)

## 1) Obiettivo e Scope
- Verificare che i chunk generati dal watcher siano indicizzati con embeddings e resi ricercabili, senza duplicazioni e con corretta osservabilità.
- Copertura dei path: batch arretrati (AC1), indexing in-line watcher (AC2), coordinamento concorrenza con advisory locks (AC2.5), verifiche funzionali/diagnostiche (AC3–AC4).

## 2) Assunzioni e Precondizioni
- Funzione index_chunks(chunks, metadata_list) già funzionante e idempotente (LangChain + SupabaseVectorStore).
- syncpg configurato; DB con tabelle documents/document_chunks e dati esistenti (>=190 chunk embedding IS NULL).
- Variabili d’ambiente valorizzate (OpenAI, Supabase, DB). Celery opzionale disattivato per MVP.

## 3) Ambiente di Test
- API FastAPI locale (pps/api/api/main.py) con DB Postgres e Supabase disponibili.
- Watcher avviato (script/runner) e batch script disponibile: scripts/admin/generate_missing_embeddings.py.
- Feature flag (se previsto): WATCHER_CELERY_INDEXING=false per MVP.

## 4) Dati di Test
- Documenti in stato completed e relativi chunk con embedding IS NULL (target ˜190).
- Un documento sintetico "DOC_X" con 3–5 chunk noti per test rapidi.

## 5) Tracciabilità ? Acceptance Criteria
- AC1: Batch indicizza tutti i chunk NULL per ogni documento completato; report conteggi.
- AC2: Watcher invoca index_chunks post-salvataggio, gestisce errori senza bloccare pipeline.
- AC2.5: Advisory locks coordinano batch e watcher; zero duplicati; evidenza log di lock acquire/skip.
- AC3: Copertura embeddings completa (190/190), semantic search e chat forniscono risultati coerenti.
- AC4: Endpoint GET /api/v1/admin/debug/embedding-health espone summary e breakdown coerenti.

## 6) Casi di Test (Gherkin-style)

### 6.1 AC1 — Batch Embeddings
- TC-AC1-01 — Indicizzazione arretrati
  Given documenti in documents con status completed e chunk con embedding IS NULL
  When eseguo poetry --directory apps/api run python scripts/admin/generate_missing_embeddings.py
  Then i chunk vengono indicizzati e i log mostrano atch_doc_indexed con conteggi per documento
  And la query SELECT COUNT(*) FROM document_chunks WHERE embedding IS NULL restituisce 0

- TC-AC1-02 — Idempotenza batch
  Given doc già indicizzati
  When rieseguo lo script batch
  Then non vengono creati duplicati e i log non mostrano reinserimenti per gli stessi chunk

- TC-AC1-03 — Error handling esterni
  Given rate limit o errore temporaneo OpenAI simulato
  When eseguo il batch
  Then il retry/backoff avviene e le voci fallite vengono riprese in un secondo run senza duplicati

### 6.2 AC2 — Watcher Indexing In-line
- TC-AC2-01 — Indexing post-save
  Given watcher attivo e nuovo documento ingestito con chunk
  When scan_once() salva i chunk
  Then index_chunks viene invocata e logga watcher_indexing_complete con inserted>0

- TC-AC2-02 — Degradazione controllata
  Given errore OpenAI temporaneo durante indexing
  When watcher tenta l’indicizzazione
  Then logga watcher_indexing_failed ma il watcher continua a processare altri file

### 6.3 AC2.5 — Concurrency & Locks
- TC-AC2.5-01 — Coordinamento watcher>batch (lock bloccante)
  Given watcher sta indicizzando DOC_X e ha acquisito pg_advisory_lock
  When batch tenta di processare DOC_X
  Then batch registra atch_doc_skipped con eason=locked_by_watcher e non indicizza DOC_X

- TC-AC2.5-02 — Coordinamento batch>watcher (lock non-bloccante)
  Given batch ha acquisito lock su DOC_X
  When watcher tenta di indicizzare DOC_X
  Then attende il lock (bloccante) o procede su altri file; nessun duplicato

- TC-AC2.5-03 — Nessun duplicato dati
  Given esecuzioni concorrenti batch+watcher su N documenti
  When terminano entrambe le esecuzioni
  Then COUNT(id)=COUNT(DISTINCT id) in document_chunks e tutti i chunk hanno embedding IS NOT NULL

- TC-AC2.5-04 — Stabilità chiave lock
  Given sistema in esecuzione su più processi/sessioni
  When verifico il meccanismo di lock
  Then le chiavi sono calcolate via hashtext() lato DB e non via hash() Python

### 6.4 AC3 — Verifiche Post-Indexing
- TC-AC3-01 — Copertura 190/190
  Given stato post indicizzazione
  When eseguo SELECT COUNT(*) FROM document_chunks WHERE embedding IS NOT NULL
  Then il conteggio rispetta il target (es. 190)

- TC-AC3-02 — Ricerca semantica
  Given servizio chat attivo
  When interrogo POST /api/v1/chat/query con domanda nota (es. "lombalgia")
  Then ottengo >=3 chunk rilevanti e almeno uno con similarity_score = 0.6

- TC-AC3-03 — Chat end-to-end con citazioni
  Given sessione chat e JWT valido
  When invio messaggio su POST /api/v1/chat/sessions/{id}/messages
  Then la risposta contiene citazioni non vuote e non riporta "Nessun contenuto rilevante"

### 6.5 AC4 — Monitoring & Health
- TC-AC4-01 — Endpoint embedding-health
  Given sistema indicizzato
  When chiamo GET /api/v1/admin/debug/embedding-health
  Then summary.embedding_coverage_percent=100.0 e breakdown coerente per documento

- TC-AC4-02 — Ultimo indexing
  Given eventi di indexing recenti
  When consulto l’endpoint
  Then last_indexed_at è valorizzato con timestamp recente

## 7) Negative & Edge Cases
- Input vuoti o chunk estremamente lunghi: indexing salta o tronca con log di warning.
- Metadati mancanti: validazione server-side, fallimento controllato.
- Documenti parzialmente indicizzati: batch completa la copertura senza duplicati.

## 8) Performance & Affidabilità
- Misurare tempo medio di indicizzazione/chunk e throughput totale.
- Verificare che il watcher non degradi throughput ingestion (> regressione rispetto 6.3).

## 9) Osservabilità & Logging
- Log strutturati richiesti: watcher_indexing_complete/failed, atch_doc_indexed/skipped, indexing_lock_acquired/released.
- Metriche minime: conteggi per documento, tempi, errori/retry.

## 10) Strumenti/Comandi
- Batch: poetry --directory apps/api run python scripts/admin/generate_missing_embeddings.py
- Query DB: SELECT ... FROM document_chunks ... per copertura/duplicati.
- API: curl per chat/query e embedding-health.

## 11) Criteri di Uscita
- PASS se: tutti i TC critici (AC1–AC4, concorrenza) PASSANO; copertura embeddings 100%; nessun duplicato.
- CONCERNS/FAIL se: duplicazioni, lock non efficaci, copertura <100%, endpoint AC4 incompleto.

## 12) Evidenze Richieste
- Log esecuzione batch e watcher con eventi chiave.
- Snapshot query DB per copertura/duplicati.
- Response API chat/query e embedding-health.
