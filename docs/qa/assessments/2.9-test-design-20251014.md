# Test Design: Story 2.9 — Classification Performance Optimization

Date: 2025-10-14
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Obiettivo validazione: Ridurre P95 sync-jobs < 2s con cache Redis deterministica, mantenendo compatibilità e osservabilità.
- Totale scenari: 26
- Per livello: Unit 12 (46%), Integration 9 (35%), E2E/Perf 5 (19%)
- Priorità: P0: 10, P1: 10, P2: 6

Razionale livelli: coprire logica chiavi/TTL a livello unit (rapido e preciso), interazioni Redis/HTTP admin a livello integrazione, risultato finale P95 e flussi critici tramite E2E/Performance.

## Test Scenarios by Acceptance Criteria

### AC1: Redis Cache Implementation

Descrizione: caching Redis con TTL 7 giorni, chiavi deterministiche su testo+metadata, metriche hit/miss.

| ID             | Level       | Priority | Test                                                                 | Justification                                    |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------------------------------------------ |
| 2.9-UNIT-001   | Unit        | P0       | Determinismo chiave: stesso contenuto/metadata → stessa chiave       | Mitiga TECH-001; pura logica hashing/serializ.   |
| 2.9-UNIT-002   | Unit        | P0       | Normalizzazione metadata (ordine chiavi, liste) non cambia chiave    | Mitiga TECH-001; invariance properties           |
| 2.9-UNIT-003   | Unit        | P1       | Disabilitazione cache (`enabled=false`) bypassa get/set              | Config flag logic                                |
| 2.9-UNIT-004   | Unit        | P1       | `set()` usa TTL configurato (`setex` con TTL env)                    | TTL policy                                        |
| 2.9-INT-001    | Integration | P0       | Cache Hit: `get()` → Redis GET → parse JSON → ritorno modello        | Interazione Redis reale/mocked                    |
| 2.9-INT-002    | Integration | P0       | Cache Miss: `get()` → None; dopo LLM, `set()` persist                 | Flusso miss→store                                 |
| 2.9-INT-003    | Integration | P1       | Redis errore (conn refused) → fallback + log `classification_cache_error` | Mitiga OPS-001; resilienza                       |
| 2.9-UNIT-005   | Unit        | P1       | `get_stats()` aggrega hit/miss/hit_rate correttamente                | Metriche di base                                  |

### AC2: Performance Improvement

Descrizione: Cache hit <100ms; miss invariato; P95 sync-jobs <2s con 300 richieste.

| ID             | Level | Priority | Test                                                                 | Justification                          |
| -------------- | ----- | -------- | -------------------------------------------------------------------- | -------------------------------------- |
| 2.9-PERF-001   | E2E   | P0       | Perf test warmup+run: P95 sync-jobs <2s (300 req)                    | KPI principale di story (BUS-001)      |
| 2.9-PERF-002   | E2E   | P0       | Cache hit latency p50/p95 <100ms pipeline classification              | Validazione beneficio cache            |
| 2.9-INT-004    | Int   | P1       | Cache miss latency ~baseline (~11.4s), nessuna regressione            | Verifica non peggioramenti             |
| 2.9-INT-005    | Int   | P1       | Hit-rate ≥90% su dataset realistico (dopo warmup)                     | Mitiga PERF-001                        |

Esecuzione: usare `scripts/perf/run_p95.ps1` con warmup dedicato; raccogliere report in `reports/metrics-p95-...md`.

### AC3: Configurabilità & Operatività

Descrizione: env vars (`CLASSIFICATION_CACHE_ENABLED`, `CLASSIFICATION_CACHE_TTL_SECONDS`), fallback se Redis down, admin endpoint delete.

| ID             | Level       | Priority | Test                                                                 | Justification                                  |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ---------------------------------------------- |
| 2.9-UNIT-006   | Unit        | P1       | Parsing env vars: default true/604800                                | Config parsing                                 |
| 2.9-INT-006    | Integration | P0       | Redis down → fallback a classification diretta (HTTP 200) + warning  | Mitiga OPS-001; comportamento richiesto        |
| 2.9-INT-007    | Integration | P1       | Admin `DELETE /admin/.../{content_hash}` rimuove chiave esistente    | Funzione invalidation                           |
| 2.9-SEC-001    | Integration | P0       | Accesso endpoint delete non admin → 403                              | Mitiga SEC-002; authz                           |
| 2.9-SEC-002    | Integration | P1       | Rate-limit applicato (oltre soglia → 429)                            | Mitiga abuso endpoint admin                     |

### AC4: Monitoring & Observability

Descrizione: eventi strutturati, metriche aggregate, endpoint stats JSON.

| ID             | Level       | Priority | Test                                                                | Justification                          |
| -------------- | ----------- | -------- | ------------------------------------------------------------------- | -------------------------------------- |
| 2.9-UNIT-007   | Unit        | P1       | Emissione eventi `hit/miss/error` via logger wrapper                | Logging a basso livello                |
| 2.9-INT-008    | Integration | P1       | `GET /admin/.../stats` riporta hit, miss, hit_rate, latency fields  | API osservabilità                      |
| 2.9-INT-009    | Integration | P1       | Stats riflettono operazioni reali (dopo sequenza hit/miss)          | Coerenza metriche                      |

### AC5: Testing & Validation

Descrizione: unit, integration, perf test; re-run script p95.

| ID             | Level | Priority | Test                                                                | Justification                         |
| -------------- | ----- | -------- | ------------------------------------------------------------------- | ------------------------------------- |
| 2.9-UNIT-008   | Unit  | P0       | Round-trip cache: serialize→store→retrieve→model equivalence        | Affidabilità valore in cache (TECH-002) |
| 2.9-UNIT-009   | Unit  | P1       | TTL expiration: simulazione avanzamento tempo → chiave scade        | Politica TTL                          |
| 2.9-UNIT-010   | Unit  | P1       | Versioning namespace `classification:v1:` usato nelle chiavi        | Future-proofing schema                 |
| 2.9-PERF-003   | E2E   | P0       | Re-run `run_p95.ps1` post-implementazione e cattura report          | Validazione finale                     |

### AC6: Backwards Compatibility

Descrizione: nessun breaking esterno; test suite esistente passa; rollback sicuro.

| ID             | Level       | Priority | Test                                                                 | Justification                                     |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------------------------------------------- |
| 2.9-E2E-001    | E2E         | P1       | Regressione suite: 189+ pytest pass con cache enabled                | Stabilità globale                                |
| 2.9-E2E-002    | E2E         | P1       | `CLASSIFICATION_CACHE_ENABLED=false` → comportamento invariato       | Rollback sicuro                                  |
| 2.9-INT-010    | Integration | P2       | Endpoint esistenti invariati (POST /admin/knowledge-base/sync-jobs) | Nessun breaking API                              |

## Risk Coverage

Mappatura principale rischio→scenari (vedi 2.9-risk-20251014.md):
- TECH-001 (key determinism): 2.9-UNIT-001, 002, 2.9-INT-001/002
- OPS-001 (Redis down): 2.9-INT-003, 2.9-INT-006
- SEC-002 (admin endpoint security): 2.9-SEC-001, 2.9-SEC-002
- OPS-002 (memoria/eviction): copertura indiretta via perf carico e stats (2.9-PERF-001/002, 2.9-INT-008/009)
- BUS-001 (P95 <2s): 2.9-PERF-001/003
- DATA-001 (staleness): 2.9-UNIT-009, 2.9-INT-007
- TECH-002 (schema compat): 2.9-UNIT-008, 2.9-UNIT-010
- OPS-003 (metriche incomplete): 2.9-UNIT-005, 2.9-INT-008/009
- PERF-001 (hit-rate): 2.9-INT-005
- PERF-002 (latenza Redis): 2.9-PERF-002

## Recommended Execution Order
1. P0 Unit: 2.9-UNIT-001, 2.9-UNIT-008
2. P0 Integration: 2.9-INT-001/002/006, 2.9-SEC-001
3. P0 E2E/Perf: 2.9-PERF-001/002/003
4. P1 Unit/Integration: restanti AC1–AC4
5. P2 rimanenti

## Gate YAML — test_design

```yaml
test_design:
  scenarios_total: 26
  by_level:
    unit: 12
    integration: 9
    e2e: 5
  by_priority:
    p0: 10
    p1: 10
    p2: 6
  coverage_gaps: []
```

## Notes for Implementation
- Creare fixtures per Redis (mock/fake) e per endpoint admin con utente admin/non-admin.
- Per perf, prevedere warmup batch e dataset rappresentativo per misurare hit-rate.
- Salvare i risultati in `reports/metrics-p95-YYYYMMDD-post-cache.md` e linkare in Story.

## Story Hook
Test design matrix: docs/qa/assessments/2.9-test-design-20251014.md
P0 tests identified: 10

