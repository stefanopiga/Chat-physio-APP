# Test Design — Story 2.4.1: Document Persistence Integrity Fix

## Scopo
Definire i test richiesti dalla story per validare integrità referenziale, idempotenza e integrazione endpoint. Contenuti estratti dal sorgente indicato.

## Unità (Backend Unit Tests)
- Numero test: 8 (fonte: L395)
- File: `apps/api/tests/test_document_persistence.py` (fonte: L393)
- Casi:
  1. test_save_document_creates_record — Inserimento nuovo documento (fonte: L396)
  2. test_save_document_idempotent — ON CONFLICT aggiorna existing (fonte: L397)
  3. test_save_document_returns_uuid — Ritorno UUID valido (fonte: L398)
  4. test_update_document_status — Aggiornamento status post-indexing (fonte: L399)
  5. test_sync_job_creates_document_before_chunks — Ordine corretto padre-figlio (fonte: L400)
  6. test_sync_job_propagates_document_id — Metadata chunk contiene document_id (fonte: L401)
  7. test_foreign_key_constraint_respected — Nessun chunk orfano (fonte: L402)
  8. test_document_hash_collision_handling — Deduplicazione su stesso file (fonte: L403)
- Coverage target: ≥90% (fonte: L405)
- Esempio test incluso nel sorgente (fonte: L408–L434)

## Integrazione (Integration Tests)
- Numero test: 4 (fonte: L442–L447)
- File: `apps/api/tests/test_sync_job_integration.py` (fonte: L440)
- Casi:
  1. test_sync_job_full_pipeline — Document → Chunks → Search (fonte: L443)
  2. test_sync_job_response_includes_document_id — Response contiene document_id (fonte: L444)
  3. test_sync_job_error_updates_status — Status "error" su failure indexing (fonte: L445)
  4. test_concurrent_sync_jobs_same_hash — Race condition gestita da ON CONFLICT (fonte: L446)

## E2E (Story 4.4)
- File test: `apps/web/tests/story-4.4.spec.ts` (fonte: L452)
- Prerequisito: Popolare DB via API (fonte: L454)
- Setup: chiamata POST a `/api/v1/admin/knowledge-base/sync-jobs` con fixture e verifica `document_id` (fonte: L456–L471)
- Risultato atteso: 6/6 PASSED (fonte: L474)

## Criteri di accettazione collegati ai test
- AC1: verifica inserimento `documents` e ritorno `document_id` (fonte: L75–L85)
- AC2: rispetto FK, nessun orfano (fonte: L87–L98)
- AC3: idempotenza `ON CONFLICT`, stesso UUID (fonte: L100–L116)
- AC4: endpoint crea `documents` prima dei chunk, response include `document_id` (fonte: L118–L131, L291–L294)
- AC5: sblocco Story 4.4 con documenti e test verdi (fonte: L133–L144)

## Ambiente e dipendenze di test
- asyncpg setup e DI FastAPI già configurati (fonte: L363, L372)
- Migrazioni applicate: documents, document_chunks + FK (fonte: L361–L363)
- DB: PostgreSQL 14+ con pgvector/Supabase (fonte: L373)

## Comandi/Verifiche dal sorgente
- Query FK orfani: vedere sezione Pre-Implementation Checklist (fonte: L563–L583)
- Migrazione retroattiva: `supabase/migrations/20251005000000_fix_orphan_chunks.sql` con note esecuzione (fonte: L595–L643)

## Fonti puntuali
- `docs/stories/2.4.1-document-persistence-integrity-fix.md`: L75–L116, L118–L144, L389–L475, L361–L373, L563–L583, L595–L643.
