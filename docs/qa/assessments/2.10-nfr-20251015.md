# NFR Assessment: 2.10 – Batch Ingestion Knowledge Base

Date: 2025-10-15
Reviewer: Quinn (Test Architect & Quality Advisor)

Story: docs/stories/2.10.batch-ingestion-knowledge-base.md

## Scope & Assumptions

- Scope: Client-side batch ingestion script invoking `POST /api/v1/admin/knowledge-base/sync-jobs` with `document_text` payload; pacing to respect 10 req/min; resumable via `--state-file`; reports in MD/JSON/CSV.
- Assumptions: Backend classification cache from Story 2.9 remains enabled; admin JWT generation via `scripts/admin/generate_jwt.py`; no PII in source documents; embeddings and chunking executed server-side as previously validated.

## Summary Decision

- Security: PASS — Admin JWT required; gateway rate limiting; secrets verified via preflight; masking enforced in logs. Add denylist for sensitive keys in logger.
- Performance: PASS — `/sync-jobs` P95 1.16s baseline (2.9); client pacing 6–7s with jitter and `Retry-After` compliance prevents regressions under serial ingestion.
- Reliability: PASS — Exponential backoff on 429/5xx/timeouts; idempotent resume via `--state-file`; corrupted files skipped and reported.
- Availability: PASS — Admin API remains available under controlled RPS; no long-lived locks; failures isolated per file.
- Scalability: PASS — Workload is I/O bound and serialized; can scale by sharding directories in future with coordination constraints; single-run path is safe now.
- Data Integrity: CONCERNS — Potential duplicate submissions if resume logic or backend lacks de-dup keyed by `(source_path, content_hash)`; ensure backend enforces uniqueness or client de-dup before POST.
- Observability: PASS — Structured JSON logs, per-file outcomes, final report; recommend counters: submitted/succeeded/failed/retried, 429/5xx rates, average backoff.
- Maintainability: PASS — Parametric CLI, tests present/planned, aligned with ruff/mypy/pytest; clear file layout.
- Operability: PASS — Preflight hard-fails on missing env; deterministic pacing; safe to stop/resume; clear failure modes.
- Privacy/Compliance: PASS — No PII expected; ensure redaction of content snippets in logs/reports; JWT never logged.
- Cost: CONCERNS — Batch operations can spike embedding/token costs; schedule during off-peak and monitor spend per batch.

Gate: PASS with targeted follow-ups (see Recommendations).

## Evidence & Checks

- Security
  - Endpoint: `POST /api/v1/admin/knowledge-base/sync-jobs` requires admin JWT.
  - Rate limiting: 10 req/min via Traefik + SlowAPI; client pacing implemented (`--sleep-seconds` + jitter; honors `Retry-After`).
  - Preflight verifies `OPENAI_API_KEY`, `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` (or `SUPABASE_SERVICE_KEY`), `SUPABASE_JWT_SECRET`; sensitive values masked.

- Performance
  - Baseline P95 `/sync-jobs`: 1.16s (reports/metrics-p95-20251014-post-cache.md) — unchanged by serialized client.
  - Script enforces min inter-request delay; retries back off exponentially to avoid thundering herd.

- Reliability & Availability
  - Retries on transient errors (429/5xx/timeouts) with cap `--max-retries`.
  - Resume via `--state-file` avoids reprocessing; corrupted/unsupported files skipped and logged.
  - No shared mutable server state; per-file isolation reduces blast radius.

- Data Integrity
  - Report artifacts: MD/JSON/CSV enumerate outcomes; enable post-run SQL validations (duplicates, NULL embeddings, chunk counts).
  - Risk: duplicate ingestion if POST repeated; need server-side uniqueness or client pre-check hash.

- Observability & Operability
  - Structured logs under `reports/logs/ingestion_YYYYMMDD.log`; report path configurable.
  - KPIs proposed: submitted, success, fail, retried, retry_attempts_avg, 429_rate, 5xx_rate, mean_backoff, effective_rps.

- Maintainability
  - Single script `scripts/ingestion/ingest_all_documents.py`; tests in `scripts/ingestion/test_integration_batch_ingestion.py` + unit tests for preflight/rate-limit/state logic.

- Privacy/Compliance
  - No storage of JWT or secrets in logs; redact content previews; ensure reports exclude full document text.

## Recommendations (Must/Should)

- Must
  - Enforce de-dup: backend unique index or upsert key on `(source_path, content_hash)`; client computes SHA256 and sends in `metadata`.
  - Logging guard: global redaction for `Authorization`, `*_KEY`, `*_SECRET`; sanitize exception messages.
  - Post-run SQL checks: ensure `embedding IS NOT NULL`, chunk counts per doc > 0, zero duplicates by `(source_path, chunk_idx)`.

- Should
  - Add counters to JSON report (submitted/success/fail/retried/429/5xx) and export Prometheus-friendly metrics if available.
  - Schedule batch windows; cap daily cost; surface cost estimate in report.
  - Consider limited parallelism only when worker capacity telemetry confirms headroom.

## Validation Scenarios (Given-When-Then)

- Given missing `SUPABASE_SERVICE_ROLE_KEY` When running preflight Then exit code 1 and redacted error message.
- Given rate limit 10/min When sending requests Then effective RPS ≤ 0.16 and 429 bursts are retried honoring `Retry-After`.
- Given network timeouts When posting Then retry with exponential backoff up to `--max-retries` and final status recorded.
- Given interrupted run after N files When resuming Then script skips completed files via `--state-file` and no duplicates appear server-side.
- Given duplicated file content When hashing client-side Then only one ingestion record exists (upsert by `(source_path, content_hash)`).
- Given successful batch When generating report Then MD/JSON/CSV include counts and per-file statuses without secrets or raw content.

## Metrics & Thresholds

- p95 `/sync-jobs` during batch: < 2.0s; 429 rate < 2% sustained; 5xx rate < 1%.
- Effective RPS: ~0.1–0.16; mean backoff ≤ 8s; max retries per file ≤ `--max-retries`.
- Data integrity: duplicates by `(source_path, content_hash)` = 0; `embedding NULL` = 0.

## Gate Block (merge into gate file)

```yaml
nfr_validation:
  _assessed: [security, performance, reliability, availability, scalability, data_integrity, observability, maintainability, operability, privacy, cost]
  security:
    status: PASS
    notes: 'Admin JWT + gateway rate limit; redact secrets; preflight checks.'
  performance:
    status: PASS
    notes: 'P95 1.16s baseline; paced client avoids regression.'
  reliability:
    status: PASS
    notes: 'Retries/backoff; resumable state; per-file isolation.'
  availability:
    status: PASS
    notes: 'Low steady RPS; failures isolated; no locks.'
  scalability:
    status: PASS
    notes: 'Safe serial path; future sharded runs possible with coordination.'
  data_integrity:
    status: CONCERNS
    notes: 'Require de-dup by (source_path, content_hash); add post-run SQL checks.'
  observability:
    status: PASS
    notes: 'Structured logs; detailed reports; propose KPIs and alerting.'
  maintainability:
    status: PASS
    notes: 'Parametric CLI; tests; standards (ruff/mypy/pytest).'
  operability:
    status: PASS
    notes: 'Preflight hard-fail; safe resume; clear failure modes.'
  privacy:
    status: PASS
    notes: 'No PII expected; redact JWT/content in logs/reports.'
  cost:
    status: CONCERNS
    notes: 'Batch may spike spend; schedule and monitor per-run cost.'
```

Artifacts: docs/qa/assessments/2.10-nfr-20251015.md

Next: update `docs/qa/gates/2.10-batch-ingestion-knowledge-base.yml` `nfr_validation` with the above block.

