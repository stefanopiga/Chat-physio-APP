# QA Gate — Story 2.4.2: Error Handling Ingestion Pipeline

## Executive Summary
- **Decisione**: GO
- **Motivazione**: Acceptance Criteria implementati con evidenze a codice e log; configurazioni DB/ENV applicate.

## Verifica Acceptance Criteria

- **AC1 — AuthenticationError rilevato con HTTP 500 e log**
```130:148:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
Then l'endpoint DEVE restituire HTTP 500 ...
And nei log DEVE apparire "openai.AuthenticationError" ...
```
```79:92:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
except openai.AuthenticationError as e:
    logger.error(...)
    raise
```
```654:659:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
[INFO] Inizio indexing 1 chunks
[ERROR] ... AuthenticationError: Error code: 401
[INFO] Task retry: Retry in 1s: AuthenticationError(...)
```

- **AC2 — APIConnectionError rilevato con HTTP 500 e causa**
```150:156:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
Then l'endpoint DEVE restituire HTTP 500 ... "openai.APIConnectionError" ...
```
```84:86:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
except openai.APIConnectionError as e:
    logger.error(f"Connessione OpenAI fallita: {e.__cause__}")
    raise
```

- **AC3 — Fallimento insert Supabase con messaggio specifico**
```158:169:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
Then l'endpoint DEVE restituire HTTP 500 ...
And nei log DEVE apparire ... "Error inserting: No rows added"
```
```279:291:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
ids = vector_store.add_texts(...)
if not ids or len(ids) == 0:
    logger.error(...)
    raise ValueError(...)
```

- **AC4 — Success path con inserimento > 0 e log**
```171:185:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
Then response DEVE contenere "inserted": N con N > 0 ...
```
```754:759:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
[INFO] ... 201 Created Supabase
[INFO] Inseriti 1 chunks con successo
[INFO] Task kb_indexing_task succeeded: {'inserted': 1}
```

## Configurazioni Critiche
```520:541:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
GRANT ALL ON TABLE document_chunks ... DISABLE ROW LEVEL SECURITY;
```
```545:563:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
CREATE OR REPLACE FUNCTION populate_document_id_from_metadata() ...
```
```574:589:docs/stories/2.4.2-error-handling-ingestion-pipeline.md
SUPABASE_SERVICE_KEY=<service_role_key>
OPENAI_API_KEY=sk-proj-<valid-key>
CELERY_ENABLED=true
```

## Osservazioni
- Comportamento async by design: endpoint risponde con `inserted: 0`, risultato nel worker (rif. 668-672).
- Fix endpoint `/documents/{id}/chunks` per `chunk_index` in metadata (rif. 684-695).

## Decisione Finale
- **GO** — Pronto per review e merge secondo standard QA Gate.
