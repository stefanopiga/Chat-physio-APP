# Test Design: Story 2.11

Date: 2025-10-16
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 22
- Unit tests: 8 (36%)
- Integration tests: 8 (36%)
- E2E tests: 6 (27%)
- Priority distribution: P0: 8, P1: 10, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: API Chat Funzionante

#### Scenarios

| ID             | Level       | Priority | Test                                                                 | Justification |
| 2.11-UNIT-001  | Unit        | P0       | Validazione schema `ChatMessageCreateRequest` (campi richiesti, tipi) | Pure validation logic |
| 2.11-UNIT-002  | Unit        | P0       | Serializzazione `ChatMessageCreateResponse` con citazioni             | DTO correctness |
| 2.11-INT-001   | Integration | P0       | POST /chat/sessions/{id}/messages con payload valido → 200            | Contract + controller/service |
| 2.11-INT-002   | Integration | P0       | Payload invalido → 422 con messaggi espliciti                         | Negative path behavior |
| 2.11-INT-003   | Integration | P1       | Timeout retriever/LLM gestito con 504/timeout handler                 | Resilience |
| 2.11-INT-004   | Integration | P1       | Rate limiting 60 rpm rispettato (header, 429 su overflow)             | Policy enforcement |
| 2.11-E2E-001   | E2E         | P0       | Invio messaggio da UI → risposta 200 visibile                         | Core journey |
| 2.11-E2E-002   | E2E         | P1       | Gestione errore UI su 4xx/5xx con messaggio utile                     | UX error handling |

### AC2: Esperienza Utente Completa

#### Scenarios

| ID             | Level       | Priority | Test                                                          | Justification |
| 2.11-UNIT-003  | Unit        | P2       | Formatter citazioni (escape, truncation excerpt)              | Pure formatting |
| 2.11-INT-005   | Integration | P1       | Risposta include `citations` con `chunk_id`, `document_id`, `score` | Contract completeness |
| 2.11-E2E-003   | E2E         | P1       | UI mostra citazioni con link a documento                       | User value |
| 2.11-E2E-004   | E2E         | P1       | Loading states e retry su errore                               | UX stability |

### AC3: Strategia di Chunking Ottimale Applicata

#### Scenarios

| ID             | Level       | Priority | Test                                                          | Justification |
| 2.11-UNIT-004  | Unit        | P1       | Parametri chunker validati (size, overlap, separators)        | Config validation |
| 2.11-INT-006   | Integration | P1       | Re-processing documenti applica nuova strategia senza crash   | Pipeline correctness |
| 2.11-INT-007   | Integration | P2       | Confronto qualità retrieval prima/dopo (recall/precision proxy) | Quality measure |
| 2.11-E2E-005   | E2E         | P2       | Chat continua a fornire citazioni corrette dopo re-chunking   | Regression safety |

### AC4: Integrità dei Chunk Verificata

#### Scenarios

| ID             | Level       | Priority | Test                                                          | Justification |
| 2.11-UNIT-005  | Unit        | P0       | Validazione modelli DB: `document_chunks.id` UUID PK globale | Data integrity rules |
| 2.11-INT-008   | Integration | P0       | Inserimento duplicati rifiutato da vincoli (PK/unique)       | Constraint enforcement |
| 2.11-INT-009   | Integration | P1       | Foreign keys e join citazioni→chunk→documento coerenti       | Referential integrity |
| 2.11-UNIT-006  | Unit        | P2       | Mapper citazioni: costruzione di `excerpt` e `position`       | Deterministic mapping |

### AC5: Flusso End-to-End Validato

#### Scenarios

| ID             | Level       | Priority | Test                                                          | Justification |
| 2.11-E2E-006   | E2E         | P0       | Sessione chat completa: domanda→risposta→citazioni corrette   | Business critical |
| 2.11-INT-010   | Integration | P1       | Similarity scores presenti e ordinati desc                    | Retrieval transparency |
| 2.11-UNIT-007  | Unit        | P1       | Sorting per score stabile e deterministico                    | Logic purity |
| 2.11-UNIT-008  | Unit        | P2       | Normalizzazione query utente (trim, language hints)           | Robustness |

## Risk Coverage

- TECH-001 (API 400): coperto da 2.11-UNIT-001/002, 2.11-INT-001/002, 2.11-E2E-001
- DATA-001 (PK chunk): coperto da 2.11-UNIT-005, 2.11-INT-008/009
- PERF-001/002/003: coperti da benchmark e contract (2.11-INT-003/004, 2.11-INT-010)
- TECH-002 (threshold retriever): 2.11-INT-010, 2.11-UNIT-007
- SEC-001/002: 2.11-UNIT-003 e verify escaping; add CSP in app (manual check)

## Recommended Execution Order

1. P0 Unit tests (2.11-UNIT-001, -002, -005)
2. P0 Integration tests (2.11-INT-001, -002, -008)
3. P0 E2E tests (2.11-E2E-001, -006)
4. P1 tests (resto unit/integration/E2E)
5. P2 tests (robustness/regressioni)

## Notes on Implementation

- Backend: usare Pytest + HTTPX AsyncClient; mock LLM/retriever per test deterministici.
- DB: fixture schema di test con pgvector; migrazioni controllate.
- Frontend: Playwright per E2E; mock rete opzionale per scenari di errore.
- Metriche: registrare p95 per endpoint chat, assert soglie.

