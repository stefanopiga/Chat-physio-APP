# Risk Profile — Story 2.9: Classification Performance Optimization

Data: 2025-10-14
Revisore: Quinn (Test Architect)

## Riepilogo Esecutivo
- Obiettivo: Portare il P95 dell’endpoint sync-jobs sotto 2s introducendo cache Redis per la classification LLM (attuale ~11.4s/doc)
- Totale Rischi Identificati: 10
- Critici: 1 | Alti: 4 | Medi: 3 | Bassi: 1
- Story Risk Score (0–100, maggiore è meglio): 23/100
- Esito Gate suggerito: CONCERNS (almeno un rischio ≥6, con un rischio critico da mitigare prima del merge)

## Gate YAML — risk_summary (per gate file)
```yaml
risk_summary:
  totals:
    critical: 1
    high: 4
    medium: 3
    low: 1
  highest:
    id: TECH-001
    score: 9
    title: 'Bassa hit-rate per chiavi cache non deterministiche'
  recommendations:
    must_fix:
      - 'Garantire determinismo chiavi cache (JSON sort_keys=true, hash su testo+metadata normalizzati)'
      - 'Proteggere endpoint admin cache con auth/permessi admin e rate-limit'
      - 'Isolare Redis DB cache (db=1) e configurare eviction policy + limiti memoria'
      - 'Implementare metriche hit/miss e p50/p95 con validazione automatica nel CI/perf'
    monitor:
      - 'Monitorare disponibilità Redis e fallback count; alert su outage'
      - 'Osservare crescita chiavi e memory footprint; definire soglie'
      - 'Controllare sicurezza rete Redis (solo interno, nessuna esposizione pubblica)'
```

## Contesto
- Bottleneck attuale: classification LLM sincrona (~11.4s/doc) rappresenta ~99% del tempo d’ingestione, causando timeout >60s con concorrenza (k6).
- Soluzione proposta: layer di caching Redis con TTL 7 giorni, chiave deterministica su contenuto+metadata e metriche hit/miss.
- Requisiti: nessuna regressione funzionale; P95 sync-jobs <2s con 300 richieste; fallback funzionante in assenza Redis.

## Matrice dei Rischi (ordinati per priorità)

| ID       | Descrizione                                                                 | Prob | Impatto | Score | Priorità |
|----------|------------------------------------------------------------------------------|------|---------|-------|----------|
| TECH-001 | Chiavi cache non deterministiche → hit-rate bassa, P95 non rientra          | Alta | Alta    | 9     | Critico  |
| OPS-001  | Redis non disponibile → fallback costante, P95 >> 2s                        | Media| Alta    | 6     | Alto     |
| SEC-002  | Endpoint admin cache non protetto → delete/flush abusivi (DoS funzionale)   | Media| Alta    | 6     | Alto     |
| OPS-002  | Pressione memoria Redis → eviction errata o impatto Celery                  | Media| Alta    | 6     | Alto     |
| BUS-001  | Non raggiungere P95 <2s → slittamento rilascio                              | Media| Alta    | 6     | Alto     |
| DATA-001 | Staleness cache su documenti aggiornati                                     | Media| Media   | 4     | Medio    |
| TECH-002 | Serializzazione/compatibilità schema `EnhancedClassificationOutput` in cache| Media| Media   | 4     | Medio    |
| OPS-003  | Metriche incomplete (hit/miss, p95) → scarsa osservabilità                   | Media| Media   | 4     | Medio    |
| PERF-001 | Alta percentuale di cache miss in scenari reali                              | Media| Alta    | 6     | Alto     |
| PERF-002 | Latency Redis/contesa rete aumenta tail                                    | Bassa| Media   | 2     | Basso    |

Note: probabilità/impatti espressi come Bassa/Media/Alta e mappati su scala 1–3.

## Dettagli Rischi e Mitigazioni

### TECH-001 — Chiavi cache non deterministiche (Score 9 — Critico)
- Razionale: Se la key include metadata non normalizzati (ordine/precisione/valori mancanti), l’hit-rate crolla → prestazioni non migliorano.
- Mitigazioni (preventive):
  - Normalizzare input: `json.dumps({text, metadata}, sort_keys=true, separators=(",", ":"))`
  - Stringhe trim e lower-case dove sensato; ordina liste/chiavi; serializza metadata con schema noto
  - Test unit per determinismo key: stesso input → stessa chiave; input semantico uguale (chiavi riordinate) → stessa chiave
  - Contract test su funzione `_generate_key()` con fixtures
- Testing: unit (hash determinism), integration (warmup + hit), perf (p50/p95 con cache calda)
- Residual risk: Basso

### OPS-001 — Redis non disponibile (Score 6 — Alto)
- Effetto: Fallback costante a LLM → P95 non rientra; log rumoroso; possibile overload di OpenAI API.
- Mitigazioni:
  - Healthcheck Redis + circuito di graceful degradation con contatori fallback
  - Alerting su indisponibilità e percentuale fallback >X%
  - Timeout client e retry bounded; bulkhead per non bloccare thread
- Testing: simulare down (container stop), verificare fallback e metriche `classification_cache_error`

### SEC-002 — Endpoint admin cache non protetto (Score 6 — Alto)
- Effetto: Cancellazioni massicce/flush → miss storm e DoS prestazionale; possibile probing su hash.
- Mitigazioni:
  - Autenticazione/Autorizzazione admin-only; rate limit; audit log
  - Validazione input `content_hash`; 404 non-leaking
  - Non esporre endpoint in ambienti pubblici; dietro VPN/rete interna
- Testing: authz e rate-limit e2e; test negative (utente non admin)

### OPS-002 — Pressione memoria Redis (Score 6 — Alto)
- Effetto: Eviction imprevedibile o OOM; interferenza con Celery (stesso server).
- Mitigazioni:
  - DB separato (1) per cache; policy `volatile-lru`/`allkeys-lru`; limiti `maxmemory`
  - Metriche `cache_size_keys`, footprint, eviction count; alert su soglie
  - TTL coerente con pattern d’uso; eventuale versioning `classification:v1:`
- Testing: carico sintetico su N documenti; osservare footprint e eviction

### BUS-001 — P95 <2s non raggiunto (Score 6 — Alto)
- Effetto: Ritardo rilascio e valore business; blocco pipeline ingestion.
- Mitigazioni:
  - Warmup cache per set realistico; definire target hit-rate (≥90%)
  - Misurazioni ripetibili con `scripts/perf/run_p95.ps1`; integrare soglie nel CI/perf
  - Back-off plan: feature flag `CLASSIFICATION_CACHE_ENABLED=false`
- Testing: perf test pre/post, report `reports/metrics-p95-...md`

### DATA-001 — Cache stantia (Score 4 — Medio)
- Effetto: Output non aggiornati su documenti modificati.
- Mitigazioni: TTL 7 giorni; admin invalidate by hash; considerare includere `metadata.version` nella chiave
- Testing: update documento → invalidate → miss successivo → hit successivo

### TECH-002 — Compatibilità schema in cache (Score 4 — Medio)
- Effetto: Evoluzione modello Pydantic rompe decoding di valori storici.
- Mitigazioni: versionare valore (`schema_version` nel payload) o namespace della chiave (`classification:v1:`)
- Testing: deserializzazione backward compatibile; migrazione opzionale con flush controllato

### OPS-003 — Metriche incomplete (Score 4 — Medio)
- Effetto: Difficoltà a dimostrare miglioramento e a diagnosticare regressioni.
- Mitigazioni: Log strutturati (`classification_cache_hit/miss/error`), export JSON admin, dashboard; soglie/alert
- Testing: assertions su log/metriche, endpoint stats

### PERF-001 — Alta percentuale di miss (Score 6 — Alto)
- Effetto: Scarso beneficio reale se contenuti variano molto o hashing troppo specifico.
- Mitigazioni: Normalizzare testo (trim, unicode normalize), scegliere opportuno perimetro di hashing (includere solo metadata rilevanti), strategia di warmup batch
- Testing: misurare hit-rate su dataset rappresentativo; tuning

### PERF-002 — Latenza Redis/contesa (Score 2 — Basso)
- Effetto: Aumento marginale della coda; impatto limitato.
- Mitigazioni: Connection pooling, timeout bassi, collocazione di rete vicina all’API
- Testing: micro-benchmark Redis GET/SET in container

## Distribuzione Rischi
### Per Categoria
- Technical: 2 (1 critico)
- Operational: 3 (0 critici)
- Security: 1 (0 critici, 1 alto)
- Performance: 2 (0 critici, 1 alto)
- Data: 1 (0 critici)
- Business: 1 (0 critici, 1 alto)

### Per Componente
- Backend API (classifier, routers admin): Alto
- Infrastructure (Redis): Alto
- Database: Basso
- Frontend: N/A

## Strategia di Test Basata sul Rischio
### Priorità 1 — Critici/Alti
- Determinismo chiavi: unit/integration mirati su `_generate_key()` e end-to-end hit dopo warmup
- Redis indisponibile: test fallimento controllato e fallback con contatori e log evento
- Endpoint admin: test di autorizzazione, rate-limit e negative cases
- Pressione memoria: test carico con N documenti e verifica eviction/metriche

### Priorità 2 — Medi
- Staleness/TTL: update documento → invalidate → sequenza miss→hit
- Compatibilità schema: round-trip vecchi valori e versioning
- Metriche: validazione endpoint stats e log strutturati

### Priorità 3 — Bassi
- Micro-benchmark Redis GET/SET; verifica impatto trascurabile sul tail

## Criteri di Accettazione Rischio
- Must Fix prima della produzione: tutti i rischi con score 9; rischi ≥6 su sicurezza/operatività
- Deploy con mitigazione: rischi medi con controlli compensativi e monitoraggio attivo
- Rischi accettati: documentare motivazione, approvatore e scadenza (se applicabile)

## Requisiti di Monitoraggio
- Performance: p50/p95 con e senza cache; hit-rate
- Sicurezza: accessi endpoint admin; anomalie cancellazioni
- Operatività: disponibilità Redis, eviction count, memoria

## Story Hook
Risk profile: docs/qa/assessments/2.9-risk-20251014.md

