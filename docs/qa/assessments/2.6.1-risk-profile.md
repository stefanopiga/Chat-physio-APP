# QA Risk Profile — Story 2.6.1: Production Infrastructure Critical Fixes (P1)

**Date:** 2025-10-10  
**Scope:** Database connectivity, Redis persistence, Traefik /health routing

---

## 1) Executive Risk Summary

- **Overall Risk Level:** High → Medium (post-fix expected)
- **Primary Risk Drivers:** External DB provider connectivity, data durability gaps, routing misconfiguration affecting health monitoring
- **Critical Path:** Unblock DB connectivity; ensure Redis durability; guarantee health endpoint observability

---

## 2) Risk Register

| ID | Area | Risk | Likelihood | Impact | Severity | Mitigations | Residual Risk |
|---|---|---|---|---|---|---|---|
| DB-001 | Database | DATABASE_URL errato o assente | Medium | High | High | Script di validazione, guida troubleshooting, verifica pooler/SSL | Medium |
| DB-002 | Database | Supabase endpoint non raggiungibile (network/firewall) | Medium | High | High | Test-NetConnection/psql, fallback da container API | Medium |
| DB-003 | Database | Credenziali scadute/cambiate | Low | High | Medium | Rigenerazione stringa da dashboard, rotazione sicura | Low |
| DB-004 | Database | DB paused (free tier) | Medium | Medium | Medium | Wake via dashboard/API, monitorare stato | Low |
| RD-001 | Redis | Assenza volume persistente | High | High | High | Volume named `redis_data`, AOF `appendonly yes` | Low |
| RD-002 | Redis | Corruzione AOF | Low | Medium | Low | Backup volume, monitor dim/compattazione AOF | Low |
| RD-003 | Redis | Perdita dati su `docker compose down -v` | Medium | High | High | Policy: non usare `-v` in production, backup | Medium |
| TR-001 | Traefik | Routing /health alla web app | High | Medium | High | Router dedicato Path(`/health`), priority > web | Low |
| TR-002 | Traefik | Regole incoerenti tra ambienti | Medium | Medium | Medium | Commenti e doc, dashboard Traefik per verifica | Low |
| OPS-001 | Ops | Mancanza di healthcheck Docker | Medium | Medium | Medium | Aggiungere healthcheck (API/Celery) | Low |
| OPS-002 | Ops | Mancanza restart policies | Medium | Medium | Medium | `restart: unless-stopped` su servizi core | Low |

---

## 3) Failure Modes & Effects Analysis (FMEA)

### A) Database Connectivity
- **Failure Mode:** Connection refused/timeout
- **Effects:** Audit bloccato, ingestion/search/chat non testabili
- **Detection:** Script `database_connectivity_test.py`, `database_integrity_audit.py`
- **Severity:** High
- **Mitigations:** Validazione `.env`, pooler 6543, `sslmode=require`, test da container
- **Controls:** Evidenze test salvate in `temp/`

### B) Redis Persistence
- **Failure Mode:** Dati volatili, perdita su restart
- **Effects:** Rate limiting reset, Celery results persi, instabilità
- **Detection:** Test GET dopo restart, assenza AOF file
- **Severity:** High
- **Mitigations:** Volume `redis_data:/data`, `--appendonly yes`
- **Controls:** Verifica file `/data/appendonly.aof`

### C) Traefik /health Routing
- **Failure Mode:** /health servito dal web, non API
- **Effects:** Monitoring inefficace, falsi positivi
- **Detection:** `curl /health` → HTML
- **Severity:** Medium-High
- **Mitigations:** Router dedicato `api-health-router` priority 150, web priority 1
- **Controls:** Traefik UI (18080 by default; configurable via `TRAEFIK_DASHBOARD_PORT`) router list

---

## 4) Test Plan di Validazione dei Mitigations

1. Database
   - Eseguire `poetry run python ../../scripts/validation/database_connectivity_test.py`
   - Atteso: `SUCCESS` + `SELECT 1`
   - Re-run `scripts/validation/database_integrity_audit.py`: atteso esecuzione query
2. Redis
   - `redis-cli SET test_key value && docker compose restart redis && redis-cli GET test_key`
   - Verifica AOF: `ls -lh /data/appendonly.aof`
3. Traefik
   - `curl http://localhost/health` → JSON `{"status":"ok"}`
   - Verifica Traefik UI: router `api-health-router` priority 150
4. Health Matrix
   - `python scripts/validation/docker_health_check.py` → Overall PASS

---

## 5) Go/No-Go Criteria (P1 Scope)

- DB connectivity: PASS (script + audit eseguito)
- Redis persistence: PASS (dopo restart)
- /health API: PASS (JSON response)
- Health matrix: PASS

Decisione: **GO** se tutti 4 criteri in PASS, altrimenti **NO-GO**.

---

## 6) Monitoring & Runbook

- Aggiungere healthcheck Docker per API e Celery (follow-up P2)
- Log routing Traefik: verificare router match su /health
- Backup volume `redis_data` prima di upgrade
- Rotazione credenziali DB: verificare impatto su connessioni

---

## 7) Residual Risks & Follow-ups

- Residuo: Traefik rules drift tra ambienti → mitigare con repo IaC o compose-prod
- Residuo: Redis AOF growth → pianificare BGREWRITEAOF periodico
- Residuo: Supabase downtime → valutare retry/exponential backoff lato app

---

## 8) References

- `docs/stories/2.6.1-production-infrastructure-critical-fixes.md`
- `docs/reports/rag-infrastructure-health.md`
- `docs/reports/rag-database-integrity.md`
- `docs/reports/rag-config-gap-analysis.md`
