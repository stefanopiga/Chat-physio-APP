# Requirements Traceability Matrix

## Story: 2.11 - Attivazione e Stabilizzazione della Chat RAG End-to-End

### Coverage Summary
- Total Requirements: 5
- Fully Covered: 3 (60%)
- Partially Covered: 2 (40%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: API Chat Funzionante
Coverage: FULL

Given-When-Then Mappings:
- Unit/Integration: pps/api/tests/test_ag_endpoint.py:1
  - Given: Chat router montato con schema valido
  - When: POST /api/v1/chat/sessions/{id}/messages con message
  - Then: Risponde 200 OK con payload conforme e message_id
- Integration: pps/api/tests/routers/test_chat.py:6
  - Given: Client HTTP e mock LLM/Retriever
  - When: Invio messaggio a endpoint session messages
  - Then: Response model ChatMessageCreateResponse con citazioni normalizzate

#### AC2: Esperienza Utente Completa
Coverage: FULL

Given-When-Then Mappings:
- E2E (Playwright): pps/web/tests/story-2.11.spec.ts:1
  - Given: Utente studente autenticato (mock) su /chat
  - When: Invia domanda e attende risposta
  - Then: Vede messaggio assistant e citazioni con badge; input state/loader corretti
- E2E (Popover): pps/web/tests/story-2.11.spec.ts:75
  - Given: Citazione presente
  - When: Click su badge citazione
  - Then: Popover mostra document_id e excerpt
- E2E (Errori): pps/web/tests/story-2.11.spec.ts:114, :148
  - Given: API risponde 429/500
  - When: Invio messaggio
  - Then: UI mostra messaggio errore e non aggiunge risposta assistant

#### AC3: Strategia di Chunking Ottimale Applicata
Coverage: PARTIAL

Given-When-Then Mappings (documentazione/strumenti):
- Docs: docs/architecture/addendum-langchain-loaders-splitters.md
  - Given: Scelte di strategia documentate
  - When: Applichiamo parametri ottimizzati
  - Then: Strategia scelta e giustificata
- Gap: Nessun test automatico che verifichi applicazione parametri e reingestione

#### AC4: Integrità dei Chunk Verificata
Coverage: FULL

Given-When-Then Mappings:
- Unit: pps/api/tests/test_chunk_integrity.py:1
  - Given: Dataset chunk/doc valido
  - When: Esecuzione validator
  - Then: Nessuna violazione (PASS)
- Unit (negativi): pps/api/tests/test_chunk_integrity.py:58,72,86
  - Given: Duplicati/indici mancanti/metadata mancanti
  - When: Validator eseguito
  - Then: Violazioni rilevate
- Script: scripts/validation/run_chunk_integrity_check.ps1:1
  - Given: Ambiente locale/CI
  - When: Esecuzione script
  - Then: Riporta esito test integrità

#### AC5: Flusso End-to-End Validato
Coverage: PARTIAL

Given-When-Then Mappings:
- E2E (UI happy path): pps/web/tests/story-2.11.spec.ts:20
  - Given: Sessione presente, API mock 200
  - When: Invio domanda
  - Then: Conversazione completa con citazioni
- NFR Latency: pps/api/tests/test_chat_nfr.py:2
  - Given: Base URL e sessione
  - When: Invia messaggi e misura elapsed_ms
  - Then: Report latenza; verifica limiti consigliati (p95)
- Gap: Manca un test E2E che copra davvero back-end live + DB

### Critical Gaps
1) AC3 — Verifica automatica applicazione strategia chunking
   - Gap: Nessun test che confermi parametri/strategie applicate ai documenti reali
   - Severity: medium
   - Suggested: Test integrazione ingestion che assetti chunk_size/overlap/strategy nei metadati e verifichi DB

2) AC5 — E2E completo con backend reale
   - Gap: Mancano test E2E contro ambiente di test/staging
   - Severity: medium
   - Suggested: Playwright + API live (feature flag) o pipeline separata

### Test Design Recommendations
- Integrare test di ingestion per assert su metadati chunking (unit/integration)
- Aggiungere scenario Playwright con backend reale su staging per AC5
- Integrare test performance p95/p99 su endpoint chat end-to-end usando scripts/perf/run_p95.ps1

### Risk Assessment
- High: Nessuno
- Medium: AC3, AC5
- Low: AC1, AC2, AC4

---
Gate YAML (paste-ready under 	race):
trace:
  totals:
    requirements: 5
    full: 3
    partial: 2
    none: 0
  planning_ref: 'docs/qa/assessments/2.11-test-design-20251017.md'
  uncovered:
    - ac: 'AC3'
      reason: 'Nessun test per applicazione strategia chunking'
    - ac: 'AC5'
      reason: 'Manca E2E contro backend reale'
  notes: 'See docs/qa/assessments/2.11-trace-20251017.md'
