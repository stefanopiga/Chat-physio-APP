# Test Design: Story 2.4

Date: 2025-09-22 [Fonte: `docs/stories/2.4.vector-indexing-in-supabase.md` L154]
Designer: Quinn (Test Architect) [Fonte: `.cursor/rules/bmad/qa.mdc` L38–L41]

## Test Strategy Overview

- Total test scenarios: 11 [Fonte: questo documento]
- Unit tests: 3 [Fonte: questo documento]
- Integration tests: 7 [Fonte: questo documento]
- E2E tests: 1 [Fonte: questo documento]
- Priority distribution: P0: 1, P1: 7, P2: 3 [Fonte: questo documento]

## Test Scenarios by Acceptance Criteria

### AC1: Configurazione API per servizio di embedding [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]

| ID            | Level       | Priority | Test                                                                                 | Justification                                                                                                  |
| ------------- | ----------- | -------- | ------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------- |
| 2.4-UNIT-001  | Unit        | P2       | Inizializzazione `OpenAIEmbeddings(model="text-embedding-3-small")`                 | Logica di configurazione isolabile [Fonte: `docs/architecture/sezione-11-strategia-di-testing.md`]
| 2.4-INT-001   | Integration | P1       | L'indexer utilizza il provider embeddings configurato                                | Verifica integrazione servizio [Fonte: `apps/api/api/knowledge_base/indexer.py`]

### AC2: Calcolo embedding per ogni chunk [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]

| ID            | Level       | Priority | Test                                                                      | Justification                                                                                                  |
| ------------- | ----------- | -------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| 2.4-UNIT-002  | Unit        | P2       | Il vettore embedding ha dimensione 1536                                   | Requisito esplicito [Fonte: `docs/architecture/addendum-pgvector-langchain-supabase.md`]
| 2.4-INT-002   | Integration | P1       | Per N chunk in input vengono generate N embedding                          | Verifica comportamento batch [Fonte: `docs/architecture/sezione-11-strategia-di-testing.md`]

### AC3: Salvataggio chunk, embedding e metadati su Supabase [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]

| ID            | Level       | Priority | Test                                                                 | Justification                                                                                                  |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| 2.4-INT-003   | Integration | P1       | `SupabaseVectorStore.add_texts` inserisce `content`, `embedding`, `metadata` | Integrazione DB-store [Fonte: `docs/architecture/addendum-pgvector-langchain-supabase.md`]
| 2.4-INT-004   | Integration | P1       | Insert su tabella `document_chunks` completa senza errori              | Validazione operativa [Fonte: `supabase/migrations/20250922000000_create_document_chunks.sql`]

### AC4: Tabella con indice per similarità [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]

| ID            | Level       | Priority | Test                                                                                 | Justification                                                                                                  |
| ------------- | ----------- | -------- | ------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------- |
| 2.4-UNIT-003  | Unit        | P2       | Verifica schema: colonna `embedding vector(1536)`                                    | Requisito di schema [Fonte: `supabase/migrations/20250922000000_create_document_chunks.sql`]
| 2.4-INT-005   | Integration | P1       | Indice HNSW creato con `vector_cosine_ops`, `m=16`, `ef_construction=64`             | Requisito di indice [Fonte: `supabase/migrations/20250922000000_create_document_chunks.sql`]

### AC5: Processo attivabile da endpoint admin [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]

| ID            | Level       | Priority | Test                                                                             | Justification                                                                                                  |
| ------------- | ----------- | -------- | -------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| 2.4-INT-006   | Integration | P1       | POST `/api/v1/admin/knowledge-base/sync-jobs` restituisce `job_id`               | Verifica endpoint admin [Fonte: `apps/api/api/main.py`]
| 2.4-INT-007   | Integration | P1       | GET `/api/v1/admin/knowledge-base/sync-jobs/{job_id}` restituisce stato          | Verifica stato job [Fonte: `apps/api/api/main.py`]

### Performance Target [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]

| ID            | Level | Priority | Test                                                                | Justification                                                                                                  |
| ------------- | ----- | -------- | ------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| 2.4-E2E-001   | E2E   | P0       | p95 latenza `similarity_search` < 500ms su dataset campione         | Target PRD esplicito [Fonte: `docs/prd/sezione-8-epic-2-dettagli-core-knowledge-pipeline.md`]

## Risk Coverage

- 2.4-INT-006, 2.4-INT-007 → mitigano OPS-REL-1 [Fonte: `docs/qa/assessments/2.4-risk-20250922.md`]

## Recommended Execution Order

1. P0 E2E tests: 2.4-E2E-001 [Fonte: questo documento]
2. P1 Integration tests: 2.4-INT-001, 2.4-INT-002, 2.4-INT-003, 2.4-INT-004, 2.4-INT-005, 2.4-INT-006, 2.4-INT-007 [Fonte: questo documento]
3. P2 Unit tests: 2.4-UNIT-001, 2.4-UNIT-002, 2.4-UNIT-003 [Fonte: questo documento]

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 3
    integration: 7
    e2e: 1
  by_priority:
    p0: 1
    p1: 7
    p2: 3
  coverage_gaps: []
```

## Trace References

Test design matrix: qa.qaLocation/assessments/2.4-test-design-20250922.md

## Sources

- `docs/stories/2.4.vector-indexing-in-supabase.md` (AC, Dev Notes)
- `docs/architecture/addendum-pgvector-langchain-supabase.md` (schema/integrazione LangChain/Supabase)
- `supabase/migrations/20250922000000_create_document_chunks.sql` (schema, indice, funzione)
- `apps/api/api/main.py` (endpoint admin)
- `apps/api/api/knowledge_base/indexer.py` (embedding provider, store)
- `.cursor/rules/bmad/qa.mdc` (identità QA)
