# Test Design: Story 5.2 - FastAPI Modularization & Architecture Refactoring

**Date:** 2025-10-08  
**Designer:** Quinn (Test Architect)  
**Story ID:** 5.2  
**Story Title:** FastAPI Modularization & Architecture Refactoring

## Test Strategy Overview

- **Total Test Scenarios:** 31  
- **Unit Tests:** 8 (26%)  
- **Integration Tests:** 19 (61%)  
- **E2E Tests:** 4 (13%)  
- **Priority Distribution:**  
  - P0 Critical: 11  
  - P1 High: 14  
  - P2 Medium: 6

### Test Strategy Rationale

Refactoring architetturale ad ampio raggio. Rischio primario: regressioni funzionali e drift dello schema OpenAPI senza modificare contratti. Approccio:  
- Verifiche strutturali automatiche (grep/contatori) per AC1–AC7  
- Contract parity & schema diff per AC8  
- Coverage gate ≥85% in CI  
- Test DI/security per `dependencies.py` e services principali

**Risk-based focus:** ARCH-5.2-001 (endpoint regressions), ARCH-5.2-004 (OpenAPI drift), ARCH-5.2-011 (OpenAPI governance), ARCH-5.2-003 (coverage), ARCH-5.2-005 (DI/Auth), ARCH-5.2-007 (doc consistency).

---

## Test Scenarios by Acceptance Criteria

### AC1: Main.py ridotto a entry point minimo (≤150 LOC, nessun endpoint handler, nessun model inline)

| ID            | Level       | Priority | Test Scenario                                                                 | Justification                              | Risk Coverage     |
|---------------|-------------|----------|------------------------------------------------------------------------------|--------------------------------------------|-------------------|
| 5.2-INT-001   | Integration | P0       | `main.py` LOC ≤ 150                                                          | Requisito chiave architetturale             | ARCH-5.2-001      |
| 5.2-INT-002   | Integration | P0       | Zero handler `@app.(get|post|...)` in `main.py` (≤2: /health, opzionale)     | Nessun endpoint inline                      | ARCH-5.2-001      |
| 5.2-INT-003   | Integration | P1       | Nessun `BaseModel` definito in `main.py`                                     | Schemas centralizzati                       | ARCH-5.2-001      |
| 5.2-UNIT-001  | Unit        | P2       | `utils.logging.JSONFormatter` produce JSON con `level`, `logger`, `time`     | Logging consistente                         | ARCH-5.2-009 (obs) |
| 5.2-INT-004   | Integration | P1       | Middleware registrati: `log_requests`, `add_request_id` in `main.py`         | Observability & tracing                      | ARCH-5.2-009      |

**Coverage Summary AC1:** 5 scenari

---

### AC2: Routers organizzati per dominio e inclusi in `main.py`

| ID            | Level       | Priority | Test Scenario                                                                 | Justification                      | Risk Coverage   |
|---------------|-------------|----------|------------------------------------------------------------------------------|------------------------------------|-----------------|
| 5.2-INT-005   | Integration | P0       | Esistenza file routers: `auth`, `student_tokens`, `admin`, `chat`, `kb`, `documents` | Struttura target                    | ARCH-5.2-001    |
| 5.2-INT-006   | Integration | P1       | Ogni router definisce `APIRouter(prefix=...)`                                 | Convenzioni routing                 | ARCH-5.2-001    |
| 5.2-INT-007   | Integration | P0       | `app.include_router(...)` chiamato 6 volte in `main.py`                       | Integrazione completa               | ARCH-5.2-001    |

**Coverage Summary AC2:** 3 scenari

---

### AC3: Services estratti con business logic isolata

| ID            | Level       | Priority | Test Scenario                                                                 | Justification                      | Risk Coverage       |
|---------------|-------------|----------|------------------------------------------------------------------------------|------------------------------------|---------------------|
| 5.2-INT-008   | Integration | P0       | Esistenza file services: `auth_service`, `rate_limit_service`, `chat_service`, `analytics_service` | Layer servizi creato       | ARCH-5.2-001        |
| 5.2-INT-009   | Integration | P1       | Routers importano da `services/` (≥10 import)                                 | Niente logica inline nei router     | ARCH-5.2-001        |
| 5.2-UNIT-002  | Unit        | P1       | `auth_service.generate_temp_jwt(...)` contiene claims attese (`iss,aud,sub,exp`) | Contratto token temporaneo          | ARCH-5.2-005        |
| 5.2-UNIT-003  | Unit        | P2       | `auth_service.generate_access_code(length=8)` restituisce stringa A-Z0-9       | Utility coerente                     | -                   |

**Coverage Summary AC3:** 4 scenari

---

### AC4: Pydantic schemas centralizzati e importati dai routers

| ID            | Level       | Priority | Test Scenario                                                                 | Justification                      | Risk Coverage   |
|---------------|-------------|----------|------------------------------------------------------------------------------|------------------------------------|-----------------|
| 5.2-INT-010   | Integration | P0       | Esistenza files in `schemas/`: `auth`, `student_tokens`, `chat`, `admin`, `knowledge_base` | Struttura schema                   | ARCH-5.2-001    |
| 5.2-INT-011   | Integration | P1       | Routers importano da `schemas/` (≥20 import)                                  | Separation of concerns              | ARCH-5.2-001    |
| 5.2-INT-012   | Integration | P1       | Nessun `BaseModel` definito in `routers/*.py`                                  | Schemas non inline                  | ARCH-5.2-001    |
| 5.2-UNIT-004  | Unit        | P2       | Validazione schema esempio (`ExchangeCodeRequest`)                             | Tipi coerenti                       | -               |

**Coverage Summary AC4:** 4 scenari

---

### AC5: Dependencies centralizzate e usate dai routers

| ID            | Level       | Priority | Test Scenario                                                                 | Justification                             | Risk Coverage   |
|---------------|-------------|----------|------------------------------------------------------------------------------|-------------------------------------------|-----------------|
| 5.2-INT-013   | Integration | P0       | `dependencies.py` esiste e definisce `verify_jwt_token`, `get_settings`, `_is_admin` | Dependency hub presente               | ARCH-5.2-005    |
| 5.2-INT-014   | Integration | P1       | Routers importano da `dependencies` (≥6 match)                                 | DI coerente                             | ARCH-5.2-005    |
| 5.2-UNIT-005  | Unit        | P0       | `verify_jwt_token` accetta token valido e applica `leeway`                     | Autenticazione affidabile               | ARCH-5.2-005    |
| 5.2-UNIT-006  | Unit        | P1       | `verify_jwt_token` rifiuta header assente/scheme errato                        | Hardening                               | ARCH-5.2-005    |
| 5.2-UNIT-007  | Unit        | P1       | `_is_admin` True per `role` o `app_metadata.role == 'admin'`                   | RBAC coerente                            | ARCH-5.2-005    |
| 5.2-INT-016   | Integration | P1       | Rate limiting attivo su endpoints sensibili (smoke: 429 su burst)              | RL wiring corretto                       | ARCH-5.2-006    |

**Coverage Summary AC5:** 6 scenari

---

### AC6: Test organizzati per modulo con coverage ≥85%

| ID            | Level       | Priority | Test Scenario                                                                 | Justification                  | Risk Coverage    |
|---------------|-------------|----------|------------------------------------------------------------------------------|--------------------------------|------------------|
| 5.2-INT-017   | Integration | P1       | Directory `apps/api/tests/{routers,services}` presenti                         | Organizzazione test            | ARCH-5.2-010     |
| 5.2-INT-018   | Integration | P1       | Esistono ≥6 file `tests/routers/test_*.py`                                     | Coverage router per dominio    | ARCH-5.2-003     |
| 5.2-INT-019   | Integration | P0       | Coverage gate ≥85% (CI fallisce sotto soglia)                                  | Prevenzione regressioni        | ARCH-5.2-003     |

**Coverage Summary AC6:** 3 scenari

---

### AC7: Documentazione architettura aggiornata omogeneamente

| ID            | Level       | Priority | Test Scenario                                                                 | Justification                         | Risk Coverage   |
|---------------|-------------|----------|------------------------------------------------------------------------------|---------------------------------------|-----------------|
| 5.2-INT-020   | Integration | P1       | Grep docs: 0 riferimenti a `main.py` come monolite (eccetto entry point)      | Coerenza documentazione             | ARCH-5.2-007    |
| 5.2-INT-021   | Integration | P1       | Grep docs: ≥20 riferimenti a `apps/api/api/routers/`                           | Allineamento esempi                 | ARCH-5.2-007    |
| 5.2-INT-022   | Integration | P2       | `docs/architecture.md` include percorsi `routers/` nella sezione struttura     | Sezione architettura aggiornata     | ARCH-5.2-007    |

**Coverage Summary AC7:** 3 scenari

---

### AC8: Backward compatibility mantenuta (contract parity, E2E invariance)

| ID            | Level       | Priority | Test Scenario                                                                 | Justification                         | Risk Coverage       |
|---------------|-------------|----------|------------------------------------------------------------------------------|---------------------------------------|---------------------|
| 5.2-E2E-001   | E2E         | P0       | Suite backend esistente passa senza modifiche                                  | Invariance di comportamento        | ARCH-5.2-001        |
| 5.2-E2E-002   | E2E         | P0       | Suite frontend E2E passa (Playwright)                                          | Nessuna breaking change client     | ARCH-5.2-001        |
| 5.2-INT-023   | Integration | P0       | Diff OpenAPI pre/post: nessuna differenza strutturale                          | Contract parity                    | ARCH-5.2-004        |
| 5.2-INT-025   | Integration | P0       | Gate governance OpenAPI: differenze consentite solo in descrizioni/tags; versioning/deprecation policy referenziata | Governance contratti               | ARCH-5.2-011        |
| 5.2-INT-024   | Integration | P1       | Parity responses su campione endpoint (golden files)                            | Verifica di risposta invariata     | ARCH-5.2-001        |

**Coverage Summary AC8:** 4 scenari

---

## Comprehensive Test Scenario Inventory

### Unit Tests (8 total)

| ID            | AC  | Priority | Test Focus                                                | Risk Mitigation |
|---------------|-----|----------|-----------------------------------------------------------|-----------------|
| 5.2-UNIT-001  | 1   | P2       | JSONFormatter fields presenti                             | ARCH-5.2-009    |
| 5.2-UNIT-002  | 3   | P1       | JWT temporaneo contiene claims corretti                   | ARCH-5.2-005    |
| 5.2-UNIT-003  | 3   | P2       | Access code alfanumerico lunghezza 8                      | -               |
| 5.2-UNIT-004  | 4   | P2       | Validazione schema di esempio                             | -               |
| 5.2-UNIT-005  | 5   | P0       | `verify_jwt_token` token valido                           | ARCH-5.2-005    |
| 5.2-UNIT-006  | 5   | P1       | `verify_jwt_token` errori comuni (mancante/scheme errato) | ARCH-5.2-005    |
| 5.2-UNIT-007  | 5   | P1       | `_is_admin` rileva ruolo in payload/app_metadata          | ARCH-5.2-005    |
| 5.2-UNIT-008  | 5   | P2       | `get_settings` singleton                                  | ARCH-5.2-005    |

### Integration Tests (19 total)

| ID            | AC  | Priority | Test Focus                                                | Risk Mitigation |
|---------------|-----|----------|-----------------------------------------------------------|-----------------|
| 5.2-INT-001   | 1   | P0       | `main.py` LOC ≤ 150                                       | ARCH-5.2-001    |
| 5.2-INT-002   | 1   | P0       | Nessun handler inline in `main.py`                        | ARCH-5.2-001    |
| 5.2-INT-003   | 1   | P1       | Nessun `BaseModel` inline in `main.py`                    | ARCH-5.2-001    |
| 5.2-INT-004   | 1   | P1       | Middleware registrati                                     | ARCH-5.2-009    |
| 5.2-INT-005   | 2   | P0       | Esistenza routers                                         | ARCH-5.2-001    |
| 5.2-INT-006   | 2   | P1       | `APIRouter(prefix=...)` per ogni router                   | ARCH-5.2-001    |
| 5.2-INT-007   | 2   | P0       | `include_router` x6                                       | ARCH-5.2-001    |
| 5.2-INT-008   | 3   | P0       | Esistenza services                                        | ARCH-5.2-001    |
| 5.2-INT-009   | 3   | P1       | Routers importano services                                | ARCH-5.2-001    |
| 5.2-INT-010   | 4   | P0       | Esistenza schemas                                         | ARCH-5.2-001    |
| 5.2-INT-011   | 4   | P1       | Routers importano schemas                                 | ARCH-5.2-001    |
| 5.2-INT-012   | 4   | P1       | Nessun `BaseModel` nei routers                            | ARCH-5.2-001    |
| 5.2-INT-013   | 5   | P0       | `dependencies.py` funzioni presenti                       | ARCH-5.2-005    |
| 5.2-INT-014   | 5   | P1       | Routers importano dependencies                            | ARCH-5.2-005    |
| 5.2-INT-016   | 5   | P1       | Rate limiting smoke                                       | ARCH-5.2-006    |
| 5.2-INT-017   | 6   | P1       | Struttura tests per modulo                                | ARCH-5.2-010    |
| 5.2-INT-018   | 6   | P1       | ≥6 test file routers                                      | ARCH-5.2-003    |
| 5.2-INT-019   | 6   | P0       | Coverage gate ≥85%                                        | ARCH-5.2-003    |
| 5.2-INT-020   | 7   | P1       | Docs: 0 riferimenti monolite                              | ARCH-5.2-007    |
| 5.2-INT-021   | 7   | P1       | Docs: ≥20 riferimenti `routers/`                          | ARCH-5.2-007    |
| 5.2-INT-022   | 7   | P2       | `docs/architecture.md` include `routers/`                 | ARCH-5.2-007    |
| 5.2-INT-023   | 8   | P0       | OpenAPI diff invariato                                    | ARCH-5.2-004    |
| 5.2-INT-024   | 8   | P1       | Parity responses campione                                 | ARCH-5.2-001    |
| 5.2-INT-025   | 8   | P0       | Gate governance OpenAPI (solo descrizioni/tags; policy)   | ARCH-5.2-011    |

### End-to-End Tests (4 total)

| ID            | AC  | Priority | Test Focus                                                | Risk Mitigation |
|---------------|-----|----------|-----------------------------------------------------------|-----------------|
| 5.2-E2E-001   | 8   | P0       | Regression suite backend invariata                        | ARCH-5.2-001    |
| 5.2-E2E-002   | 8   | P0       | Regression suite frontend invariata                       | ARCH-5.2-001    |
| 5.2-E2E-003   | 2   | P2       | Smoke GET /health                                         | -               |
| 5.2-E2E-004   | 5   | P1       | Auth flow smoke (exchange-code → 200)                     | ARCH-5.2-005    |

---

## Risk Coverage Matrix

Mapping test scenarios to identified risks from risk profile:

| Risk ID       | Risk Title                                      | Test Coverage Count | Test IDs                                               |
|---------------|--------------------------------------------------|---------------------|--------------------------------------------------------|
| ARCH-5.2-001  | Endpoint regressions / breaking changes          | 6                   | 5.2-INT-001/002/024, 5.2-E2E-001/002, 5.2-INT-007      |
| ARCH-5.2-004  | OpenAPI schema drift                             | 1                   | 5.2-INT-023                                           |
| ARCH-5.2-003  | Coverage < 85%                                   | 2                   | 5.2-INT-018/019                                       |
| ARCH-5.2-005  | DI/Auth misconfig                                | 6                   | 5.2-INT-013/014, 5.2-UNIT-005/006/007, 5.2-E2E-004    |
| ARCH-5.2-006  | Rate limiting non agganciato ai routers          | 1                   | 5.2-INT-016                                           |
| ARCH-5.2-007  | Documentazione non coerente                      | 3                   | 5.2-INT-020/021/022                                   |
| ARCH-5.2-009  | Performance/observability overhead               | 2                   | 5.2-INT-004, 5.2-UNIT-001                             |
| ARCH-5.2-011  | Governance contratti OpenAPI insufficiente       | 1                   | 5.2-INT-025                                           |

---

## Test Data Requirements

### Contract Parity & OpenAPI
- `schema_pre.json`: snapshot OpenAPI pre-refactor  
- `schema_post.json`: snapshot post-refactor per diff  
- Golden files per responses endpoint core (auth, chat, kb, documents)

### Unit/Integration
- JWT fixture con secret e `leeway` configurati  
- Campioni request/response per routers (auth, chat, kb)  
- Log capture per verifiche JSON logging/middleware

### E2E
- Ambiente staging con FE/BE allineati  
- Credenziali admin/test preconfigurate

---

## Test Environment Requirements

### Unit
- Dependencies: pytest, pytest-mock  
- Isolation: nessuna dipendenza esterna

### Integration
- Environment: Docker (API), Supabase test (o mock), Redis (per RL se necessario)  
- Tools: `poetry run pytest`, `ruff`, `mypy`

### E2E
- Environment: Staging completo (API + Web)  
- Browser: Playwright (Chromium)

---

## Recommended Execution Order

### Phase 1: Structural & Contracts (P0)
```bash
pytest -q tests/ -k "5.2-INT-001 or 5.2-INT-002 or 5.2-INT-019 or 5.2-INT-023"
```

### Phase 2: DI/Auth & Services (P0/P1)
```bash
pytest -q tests/ -k "5.2-UNIT-005 or 5.2-UNIT-006 or 5.2-UNIT-007 or 5.2-INT-013 or 5.2-INT-014"
```

### Phase 3: Routers/Schemas Layout (P1)
```bash
pytest -q tests/ -k "5.2-INT-005 or 5.2-INT-006 or 5.2-INT-010 or 5.2-INT-011 or 5.2-INT-012"
```

### Phase 4: E2E Parity (P0)
```bash
pnpm --filter web test:e2e -- --grep "@P0"
```

### Phase 5: Documentation Consistency (P1/P2)
```bash
pytest -q tests/ -k "5.2-INT-020 or 5.2-INT-021 or 5.2-INT-022"
```

**Total Execution Time (target):** ~12–15 minutes (senza nightly full run)

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 31
  by_level:
    unit: 8
    integration: 19
    e2e: 4
  by_priority:
    p0: 11
    p1: 14
    p2: 6
  coverage_gaps: []
```

---

## Trace References

- Story: `docs/stories/5.2-fastapi-modularization-architecture-refactoring.md`  
- Risk Profile: `docs/qa/assessments/5.2-fastapi-modularization-architecture-refactoring-risk-20251008.md`

---

## Quality Checklist Verification

- [x] Ogni AC coperto da almeno 3 scenari complessivi  
- [x] P0 coprono regressioni/contract parity e coverage gate  
- [x] Mappatura rischi principale completata  
- [x] Struttura test allineata a `tests/{routers,services}`  
- [x] E2E invariance inclusa

---

**End of Test Design Document**


