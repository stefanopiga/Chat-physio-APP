# Risk Profile: Story 4.2.4 – Persistenza Feedback Database

Date: 2025-10-30
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 16
- Critical Risks: 2
- High Risks: 6
- Medium Risks: 6
- Low Risks: 2
- Risk Score: 38/100

Questa story sposta la persistenza dei feedback da memoria volatile a database (Supabase/Postgres). I rischi principali riguardano sicurezza (RLS/permessi), integrità dati (upsert/unique), performance (latency p95 < 100ms) e regressioni sugli analytics che finora leggevano dallo store in‑memory. Le mitigazioni sono chiare e attuabili prima del deploy.

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: RLS errata consente lettura dati sensibili

Score: 9 (Critical)
Probability: High – Config RLS complessa; rischio errore policy “SELECT”
Impact: High – Esposizione dei feedback (potenzialmente con user_id/ip) a utenti non admin
Mitigation:
- Abilitare RLS e applicare policy “SELECT solo admin” secondo spec
- Test di sicurezza con JWT non admin e verifiche 403/empty set
- Aggiungere test di integrazione che provano SELECT con ruoli diversi
Testing Focus: Test di accesso con token anonimo/student → nessun dato; admin → full access

### 2. DATA-001: Perdita/duplicazione dati per UPSERT mal configurato

Score: 9 (Critical)
Probability: Medium/High – Uso UNIQUE(session_id,message_id) nuovo
Impact: High – Duplicati o perse sovrascritture rompono analytics e storico
Mitigation:
- Verificare vincolo UNIQUE e on_conflict="session_id,message_id"
- Test di integrazione con doppio POST stesso message_id → singolo record
- Migrazione con indice unico creato prima del deploy codice
Testing Focus: Test upsert, race sotto concorrenza (100 richieste)

## Risk Distribution

### By Category

- Security: 4 (1 critical, 2 high, 1 medium)
- Performance: 4 (0 critical, 2 high, 2 medium)
- Data: 4 (1 critical, 1 high, 2 medium)
- Business: 2 (0 critical, 1 high, 1 low)
- Operational: 2 (0 critical, 0 high, 2 medium)
- Technical: 0 critical, 0 high, 1 medium, 1 low

### By Component

- Backend (FastAPI): 6
- Database (Supabase/Postgres): 7
- Analytics layer: 2
- Infrastructure/Deploy: 1

## Detailed Risk Register

| ID       | Category   | Title                                                    | Prob | Impact | Score | Priority |
|----------|------------|----------------------------------------------------------|------|--------|-------|----------|
| SEC-001  | security   | RLS errata consente lettura a non‑admin                  | 3    | 3      | 9     | Critical |
| DATA-001 | data       | UPSERT/UNIQUE mal configurato → duplicati/perdite        | 3    | 3      | 9     | Critical |
| PERF-001 | performance| Latenza p95 > 100ms su POST feedback                     | 2    | 3      | 6     | High     |
| SEC-002  | security   | SQL/Query injection tramite campo comment                | 2    | 3      | 6     | High     |
| DATA-002 | data       | Mismatch campo tempo (created_at vs timestamp)           | 2    | 3      | 6     | High     |
| PERF-002 | performance| Query analytics senza indici adeguati                    | 2    | 3      | 6     | High     |
| BUS-001  | business   | Regressione analytics storici dopo switch a DB           | 2    | 3      | 6     | High     |
| SEC-003  | security   | Esposizione IP/user_id senza mascheramento               | 2    | 2      | 4     | Medium   |
| OPS-001  | operational| Migrazione non applicata in produzione                   | 2    | 2      | 4     | Medium   |
| DATA-003 | data       | Incongruenza tra message_id usato (assistant vs user)    | 2    | 2      | 4     | Medium   |
| TECH-001 | technical  | Race condition in upsert ad alto throughput              | 2    | 2      | 4     | Medium   |
| PERF-003 | performance| Contesa connessioni Supabase in burst                    | 2    | 2      | 4     | Medium   |
| OPS-002  | operational| Logging/monitoring insufficienti su errori DB            | 2    | 2      | 4     | Medium   |
| SEC-004  | security   | Token handling/ruoli in test e staging non allineati     | 1    | 2      | 2     | Low      |
| TECH-002 | technical  | Residui reference a feedback_store (in‑memory)           | 1    | 2      | 2     | Low      |
| BUS-002  | business   | Costi/limiti piani Supabase sotto carico                 | 1    | 2      | 2     | Low      |

### Mitigations and Testing Requirements

- SEC-001 (RLS):
  - Strategy: preventive/detective
  - Actions: Abilita RLS; policy SELECT solo admin; test con token vari; revisione security
  - Testing: Integrazione con token anonimo/student/admin; OWASP ZAP su endpoint analytics
  - Owner: backend
  - Timeline: prima del deploy

- DATA-001 (UPSERT):
  - Strategy: preventive
  - Actions: UNIQUE(session_id,message_id); on_conflict corretto; transazioni idempotenti
  - Testing: Double‑POST, test concorrenza, verifica conteggi aggregati
  - Owner: backend/DBA
  - Timeline: prima del deploy

- PERF-001 (Latency POST):
  - Strategy: preventive
  - Actions: Indici minimi; connessione riusata; evitare round‑trip superflui
  - Testing: Benchmark 100 richieste; p95 < 100ms; profiling

- SEC-002 (Injection via comment):
  - Strategy: preventive
  - Actions: Sanitizzazione lato server; validazione lunghezze; escaping in output
  - Testing: Payload malevoli; fuzzing campi

- DATA-002 (Tempo mismatch):
  - Strategy: preventive/corrective
  - Actions: Usare created_at ovunque; migrare eventuali riferimenti ‘timestamp’
  - Testing: Test analytics su created_at; verifica filtri temporali

- PERF-002 (Indici analytics):
  - Strategy: preventive
  - Actions: Creare idx su created_at DESC, vote, session_id, message_id
  - Testing: EXPLAIN ANALYZE query chiave; guardrail p95

- BUS-001 (Analytics regressione):
  - Strategy: preventive
  - Actions: Test E2E dashboard; comparazione risultati prima/dopo; fixture dati
  - Testing: Suite regression 4.2.2/4.2.3

- SEC-003 (Privacy):
  - Strategy: preventive
  - Actions: Mascheramento IP; user_id opzionale; minimizzazione dati
  - Testing: Verifica payload salvato

- OPS-001 (Migrazione):
  - Strategy: preventive
  - Actions: Pipeline che lancia supabase db push prima del deploy; check schema
  - Testing: Smoke test su env prod‑like

- DATA-003 (ID corretti):
  - Strategy: preventive
  - Actions: Associare sempre feedback all’assistant message ID
  - Testing: Test integrazione su messageId

- TECH-001 (Race upsert):
  - Strategy: preventive
  - Actions: Vincolo UNIQUE + UPSERT atomico; evitare doppie scritture
  - Testing: Test concorrenza 1k feedback concorrenti

- PERF-003 (Conn pool):
  - Strategy: preventive
  - Actions: Pooling/riuso client; retry/backoff controllato
  - Testing: Stress in burst

- OPS-002 (Monitoring):
  - Strategy: detective
  - Actions: Log errori strutturati; alert su tassi errori; dashboard p95
  - Testing: Injection errori controllati

- SEC-004 (Ruoli test/stage):
  - Strategy: preventive
  - Actions: Allineare RBAC tra ambienti
  - Testing: Matrice permessi per env

- TECH-002 (Residui in‑memory):
  - Strategy: corrective
  - Actions: rimuovere import/uso; commento deprecation; grep CI
  - Testing: Ricerca riferimenti e build

- BUS-002 (Costi/limiti):
  - Strategy: monitor
  - Actions: Alert su quote; piano adeguato
  - Testing: Nessuno richiesto per MVP

## Risk-Based Testing Strategy

- Priority 1 (Critical):
  - RLS enforcement; upsert idempotente sotto concorrenza; regressione analytics basata su DB
- Priority 2 (High):
  - Latenza endpoint; indici efficaci; sanitizzazione comment; consistenza created_at
- Priority 3 (Medium/Low):
  - Monitoraggio e logging; residui in‑memory; RBAC ambienti; costi

## Risk Acceptance Criteria

- Must Fix Before Production: tutti i rischi score 9; tutti gli score 6 su SEC/DATA/PERF
- Can Deploy With Mitigation: medium con controlli compensativi e monitoraggio
- Accepted Risks: BUS-002 può essere accettato con monitoraggio quote

## Monitoring Requirements

- Metriche: p95/p99 POST feedback; error rate DB; tempo query analytics
- Sicurezza: alert su SELECT non autorizzati; audit RLS changes
- Business: trend thumbs_up/down giornalieri; volume feedback

## Risk Review Triggers

- Modifiche schema DB o RLS; nuovi filtri analytics; incremento traffico >10x; variazioni RBAC

## Story Hook

Risk profile: docs/qa/assessments/4.2.4-risk-20251030.md

