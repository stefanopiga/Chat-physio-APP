# Test Design – Story 2.8.1: Secret Governance e Resilienza Servizi Esterni

Data: 2025-10-14  
Autore: Quinn (Test Architect & Quality Advisor)

## 1. Test Strategy Overview

- Scenari totali: 14  
- Unit: 4 (29%) – Validazione logica e sanitizzazione  
- Integration: 7 (50%) – Interazioni con servizi esterni, vault e pipeline CI  
- E2E: 3 (21%) – Pipeline orchestrata e raccolta metriche P95  
- Priorità: P0: 6, P1: 6, P2: 2  
- Dipendenze critiche: accesso vault GitHub Actions, ambiente staging con OpenAI/Supabase, scheduling CI/nightly

## 2. Test Scenarios by Acceptance Criteria

### AC1 – Secret Governance Operativa

| ID | Livello | Priorità | Test | Giustificazione |
| --- | --- | --- | --- | --- |
| 2.8.1-UNIT-001 | Unit | P0 | Sanitizzare output scanner (funzioni di redazione log; regex allowlist) | Garantire che gli script non espongano secret prima dell'upload |
| 2.8.1-INT-001 | Integration | P0 | Pipeline CI con step `trufflehog` + `detect-secrets` produce report e fallisce su leak simulato | Verifica  end-to-end dei controlli in pipeline |
| 2.8.1-INT-002 | Integration | P0 | Validare accesso vault con audit trail attivato (API GitHub/Hashicorp) | Assicura che la governance includa audit e permessi |
| 2.8.1-INT-003 | Integration | P1 | Review log pipeline con checklist (artifact retrieval + parsing) | Copre AC1.3; conferma log redatti |
| 2.8.1-E2E-001 | E2E | P1 | CI run completa (branch feature) con generazione `reports/secrets-scan-YYYYMMDD.txt` | Valida orchestrazione complessiva secrets governance |

### AC2 – Resilienza Servizi Esterni

| ID | Livello | Priorità | Test | Giustificazione |
| --- | --- | --- | --- | --- |
| 2.8.1-UNIT-002 | Unit | P1 | Retry/backoff logic – simulazione eccezioni OpenAI/Supabase | Assicura corretta gestione delle eccezioni prima dell’integrazione |
| 2.8.1-INT-004 | Integration | P0 | Pytest: quota OpenAI esaurita → verifica fallback + log warn | Mitiga OPS-301, condizione alto rischio |
| 2.8.1-INT-005 | Integration | P0 | Pytest: downtime Supabase (`--simulate-downtime`) → verifica retry/backoff + escalation | Copre AC2.2 con evidenza |
| 2.8.1-INT-006 | Integration | P1 | Scheduler health check esegue script connectivity e salva log con diff | Convalida AC2.3 |
| 2.8.1-E2E-002 | E2E | P1 | Drill resilienza orchestrato (workflow CI manuale) con raccolta log e tempi recovery | End-to-end su processi operativi |

### AC3 – Metriche P95 Affidabili

| ID | Livello | Priorità | Test | Giustificazione |
| --- | --- | --- | --- | --- |
| 2.8.1-UNIT-003 | Unit | P1 | Validare parser `summarize_p95.py` con dataset noto (≥300 richieste) | Assicura logica di aggregazione corretta |
| 2.8.1-INT-007 | Integration | P0 | Esecuzione `p95_local_test.js` (≥300 request) + summarizer → verifica report | Copre AC3.1, riduce rischio PERF-301 |
| 2.8.1-INT-008 | Integration | P0 | Confronto automatico P95 vs dashboard Supabase (delta ≤10%) | Validazione automatica AC3.2 |
| 2.8.1-E2E-003 | E2E | P0 | Pipeline nightly genera report, screenshot e issue se delta >10% | End-to-end metrica affidabile e governance |

### AC4 – Evidenze e Handoff

| ID | Livello | Priorità | Test | Giustificazione |
| --- | --- | --- | --- | --- |
| 2.8.1-UNIT-004 | Unit | P2 | Validare checklist rotazione chiavi (funzione di verifica RACI) | Riduce rischio OPS-303 |
| 2.8.1-INT-009 | Integration | P1 | Verificare aggiornamento story 2.8 (QA Results) e dashboard monitor via script diff | Garantisce allineamento documentale |

## 3. Risk Coverage Mapping

| Rischio | Scenari correlati |
| --- | --- |
| SEC-301 | 2.8.1-UNIT-001, 2.8.1-INT-001, 2.8.1-INT-002, 2.8.1-INT-003, 2.8.1-E2E-001 |
| OPS-301 | 2.8.1-UNIT-002, 2.8.1-INT-004, 2.8.1-INT-005, 2.8.1-E2E-002 |
| PERF-301 | 2.8.1-UNIT-003, 2.8.1-INT-007, 2.8.1-INT-008, 2.8.1-E2E-003 |
| OPS-302 | 2.8.1-INT-006, 2.8.1-E2E-002 |
| DATA-301 | 2.8.1-UNIT-001, 2.8.1-INT-003 |
| OPS-303 | 2.8.1-UNIT-004, 2.8.1-INT-009 |
| TECH-301 | 2.8.1-UNIT-001..003, 2.8.1-INT-007..008 |

## 4. Recommended Execution Order

1. Unit P0/P1 (2.8.1-UNIT-001, -002, -003) – validano logica critical e sanitizzazione.
2. Integration P0 (2.8.1-INT-001, -002, -004, -005, -007, -008) – difesa principale contro leakage/resilienza/P95.
3. E2E P0 (2.8.1-E2E-003) – verifica orchestrata delle metriche.  
4. Resto Integration/E2E P1 (INT-003, -006, -009; E2E-001, -002).  
5. Unit P2 (2.8.1-UNIT-004) – completamento governance documentale.

## 5. Additional Notes

- Utilizzare fixture/stage per forzare quota esaurita OpenAI e downtime Supabase (ad es. flag env `SIMULATE_SUPABASE_DOWN`).
- Automatizzare confronto P95 vs dashboard con script Python che legge CSV/JSON e produce delta; fallire test se >10%.
- Checklist rotazione chiavi: implementare test unit con dataset YAML simulato per verificare presenza campi owner, frequenza, escalation.
- Documentare in README QA come rigenerare `reports/secrets-scan-YYYYMMDD.txt` e `reports/metrics-p95-YYYYMMDD.md`.

## 6. Gate YAML Block

```yaml
test_design:
  scenarios_total: 14
  by_level:
    unit: 4
    integration: 7
    e2e: 3
  by_priority:
    p0: 6
    p1: 6
    p2: 2
  coverage_gaps: []
```

## 7. Trace Reference

```
Test design matrix: docs/qa/assessments/2.8.1-test-design-20251014.md
P0 tests identified: 6
```
