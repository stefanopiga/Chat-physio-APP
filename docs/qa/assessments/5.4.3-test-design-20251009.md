# Test Design: Story 5.4.3 — API Logic Bugs Resolution

Date: 2025-10-09
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 12
- Unit tests: 4 (33%)
- Integration tests: 6 (50%)
- E2E tests: 2 (17%)
- Priority distribution: P0: 8, P1: 3, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: Refresh Token Error Handling (6 test)

#### Scenarios

| ID              | Level       | Priority | Test                                                         | Justification                          |
| ----------------| ----------- | -------- | ------------------------------------------------------------ | -------------------------------------- |
| 5.4.3-UNIT-001  | Unit        | P0       | Handler: 0 rows → HTTP 401                                   | Pure mapping error → code path guard   |
| 5.4.3-UNIT-002  | Unit        | P0       | Handler: token `is_revoked=True` → HTTP 401                  | Pure branching logic                    |
| 5.4.3-INT-001   | Integration | P0       | POST /auth/refresh-token invalid token → 401                 | Router + DB query path                  |
| 5.4.3-INT-002   | Integration | P0       | POST /auth/refresh-token revoked token → 401                 | Router + DB query path                  |
| 5.4.3-INT-003   | Integration | P0       | POST /auth/refresh-token parent student_token inactive → 401 | Join su `student_tokens.is_active`      |
| 5.4.3-E2E-001   | E2E         | P1       | Client flow: token scaduto → refresh → 401                   | User journey negative path              |

Note dati/varianti:
- Token values: invalid format, unknown, revoked.
- Parent `student_tokens`: `is_active=False`.
- Assert schema body: `{ "detail": <message> }`, nessun 500.

### AC2: Admin Token Creation (2 test)

#### Scenarios

| ID              | Level       | Priority | Test                                                     | Justification                      |
| ----------------| ----------- | -------- | -------------------------------------------------------- | ---------------------------------- |
| 5.4.3-INT-004   | Integration | P0       | POST /admin/student-tokens con admin UUID valido → 201   | Router + fixture DB                |
| 5.4.3-E2E-002   | E2E         | P1       | Journey admin: login (mock) → crea student token → 201   | Percorso critico moderato          |

Note fixture:
- `admin_token_in_db`: crea utente admin UUID valido, cleanup deterministico.

### AC3: Pass Rate Target Achieved (Quality Goal)

#### Scenarios

| ID              | Level       | Priority | Test                                                    | Justification                         |
| ----------------| ----------- | -------- | ------------------------------------------------------- | ------------------------------------- |
| 5.4.3-INT-005   | Integration | P0       | Suite focalizzata: 6 refresh + 2 admin → tutti PASS    | Verifica aggregata obiettivo story    |
| 5.4.3-UNIT-003  | Unit        | P2       | Error formatter: messaggi coerenti tra rami 401         | Coerenza messaggi, costo basso        |
| 5.4.3-UNIT-004  | Unit        | P1       | Mapper DB→DTO per refresh response                      | Stabilità schema                      |
| 5.4.3-INT-006   | Integration | P1       | Contract test: codici HTTP non 500 sui path negativi    | Prevenzione regressioni               |

## Risk Coverage

- Mitigates `SEC-001` (critical): Scenari 5.4.3-UNIT-001/002, 5.4.3-INT-001/002/003, 5.4.3-E2E-001.
- Mitigates `SEC-002` (critical): Scenari 5.4.3-INT-004, 5.4.3-E2E-002.
- Mitigates `TECH-001` (critical): 5.4.3-INT-003, 5.4.3-INT-006.
- Mitigates `BUS-002` (high): 5.4.3-INT-005.

## Recommended Execution Order

1. P0 Unit tests (5.4.3-UNIT-001, 5.4.3-UNIT-002)
2. P0 Integration tests (5.4.3-INT-001/002/003/004/005)
3. P1 E2E tests (5.4.3-E2E-001, 5.4.3-E2E-002)
4. P1 Unit/Integration (5.4.3-UNIT-004, 5.4.3-INT-006)
5. P2 Unit (5.4.3-UNIT-003)

---

## Gate Block

test_design:
  scenarios_total: 12
  by_level:
    unit: 4
    integration: 6
    e2e: 2
  by_priority:
    p0: 8
    p1: 3
    p2: 1
  coverage_gaps: []

---

Test design matrix: qa.qaLocation/assessments/5.4.3-test-design-20251009.md
P0 tests identified: 8
