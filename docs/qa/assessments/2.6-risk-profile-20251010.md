## Profilo Rischi ‚Äî Story 2.6

Fonte: `docs/stories/2.6.rag-system-validation-and-gap-analysis.md`

Data di riferimento:
```5:5:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Last Updated:** 2025-10-10 (Post Story 5.* Refactoring)
```

Stato:
```3:3:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Status:** Ready for Review
```

Versione (ultima voce Change Log):
```899:904:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-10 | 1.1 | Aggiunta sezione **Riferimenti File Configurazione (Templates Non-Sensitive)** con documentazione dettagliata dei 3 file environment: (1) `.env` root (template: `ENV_TEMPLATE.txt`), (2) `apps/api/.env.test.local` (template: `ENV_TEST_TEMPLATE.txt`), (3) `apps/web/.env` (template: `ENV_WEB_TEMPLATE.txt`). Espansione Task 1 con subtask granulari per audit multi-ambiente (extraction variabili, mapping Docker, gap analysis, security audit). Aggiunta tabella variabili critiche con valori template e scope. Note usage per agent AI su safety template files e policy non-visionabilit√† file reali. **Chiarimento shell environment:** Tutti comandi terminal specificati come PowerShell (Windows 10). Note aggiunte in sezioni Tasks e Tools & Commands. Conversione blocchi ```bash ‚Üí ```powershell (Task 13, 14, Docker commands). | AI |
```

### Estratti ‚Äî Gap di produzione
```22:29:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Gap Production Readiness:**
Sistema tecnicamente validato ma richiede audit finale pre-deployment production:
1. Environment configuration completa e sicura (secrets management, .env validation)
2. Infrastructure resilience (Docker health, Celery stability, Redis performance)
3. Database integrity audit (indici pgvector, orphan records, query performance)
4. Performance benchmarks (latency p95, throughput pipeline)
5. Security posture (API authentication, rate limiting production-ready)
```
```40:46:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Gap da Validare (Production):**
- Environment variables production vs development
- Secrets rotation policy
- Database backup strategy
- Monitoring & alerting setup
- Performance under load (10+ concurrent ingestion)
```
```715:721:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Production Readiness Gaps (Questa Storia):**
- ‚è≥ Performance benchmarks production load (10+ concurrent ingestion)
- ‚è≥ Security audit JWT/secrets/CORS
- ‚è≥ Database integrity audit orphan records
- ‚è≥ Infrastructure health matrix production
- ‚è≥ Deployment checklist e rollback plan
```

### Acceptance Criteria (estratti)
```49:58:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
### AC1: Environment Production Audit ‚úÖ MANTENUTO
**Given** sistema con .env development e docker-compose.yml locale
**When** audit environment production viene eseguito
**Then** documento contiene:
- Tutte variabili richieste per production (SUPABASE_*, OPENAI_*, CELERY_*)
- Secrets management strategy (rotazione, vault, encryption at rest)
- Differenze development vs staging vs production
- Missing variables con impact assessment
- Hardcoded values risk report
```
```59:69:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
### AC2: Infrastructure Health Matrix ‚úÖ MANTENUTO
**Given** stack Docker completo (api, celery-worker, redis, supabase)
**When** health check matrix viene eseguita
**Then** report contiene per ogni servizio:
- Container status (Up/Restarting/Exited)
- Network connectivity inter-service (api‚Üíredis, celery‚Üíredis)
- Volume mounts integrity
- Logs health (ultimi 100 righe, error count)
- Resource usage (CPU%, Memory%)
- Restart policy configurato
```
```70:79:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
### AC3: Database Integrity Audit ‚úÖ MANTENUTO
**Given** database Supabase con documenti e chunks indicizzati
**When** integrity audit viene eseguito
**Then** report SQL contiene:
- Orphan documents (status completed senza chunks)
- Orphan chunks (embedding NULL)
- Index pgvector performance (EXPLAIN ANALYZE)
- Foreign key constraint violations
- Table statistics (row counts, index usage)
```
```80:89:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
### AC4: Performance Benchmarks üÜï AGGIUNTO
**Given** pipeline RAG operativa
**When** performance benchmarks vengono eseguiti
**Then** report contiene:
- **Ingestion**: latency per documento (p50, p95, p99) su 10 documenti test
- **Embedding**: latency OpenAI API (p50, p95) su 100 chunks
- **Search**: latency semantic search (p95 <1s) su 30 query
- **Chat**: latency augmented generation (p95 <2s) su 20 query
- **Throughput**: documenti/ora pipeline completa
- Bottleneck identification
```
```91:101:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
### AC5: Security Posture Review üÜï AGGIUNTO
**Given** API esposta con autenticazione JWT
**When** security review viene eseguito
**Then** report contiene:
- JWT secret strength (entropy bits, rotation policy)
- Rate limiting production-ready (config per environment)
- API authentication coverage (endpoint protetti vs pubblici)
- CORS policy production-safe
- Secret exposure risk (git history scan, logs sanitization)
- OpenAI API key scope (project vs user key, spending limits)
```
```102:111:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
### AC6: Deployment Checklist Production üÜï AGGIUNTO
**Given** sistema production-ready
**When** deployment checklist viene completato
**Then** documento contiene:
- Pre-deployment: backup DB, secrets rotation, container build
- Deployment: docker-compose up procedure, health check validation
- Post-deployment: smoke tests, monitoring setup, rollback plan
- Rollback triggers: failed health checks, error rate threshold
- Contact matrix: on-call rotation, escalation paths
```

### Variabili critiche (tabella dal sorgente)
```675:690:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Variabili Critiche per Validation Story 2.6:**

| Variabile | Valore Template | Scopo | File Reference |
|-----------|-----------------|-------|----------------|
| `SUPABASE_URL` | `https://kqjneskjzzlhayrpnfcp.supabase.co` | Endpoint Supabase project | Root + API Test + Web |
| `DATABASE_URL` | `postgresql://postgres.kqjn...@aws-1-eu-central-2.pooler...` | PostgreSQL connection string | Root + API Test |
| `CELERY_ENABLED` | `false` (test) / non-set (prod assume true) | Toggle async task processing | Root + API Test |
| `CELERY_BROKER_URL` | `redis://localhost:6379/0` | Redis broker Celery | Root + API Test |
| `OPENAI_API_KEY` | `<your-openai-api-key>` | GPT API key (used for classification/generation) | Root + API Test |
| `SUPABASE_JWT_SECRET` | `<your-jwt-secret>` (placeholder) | Secret per JWT token validation | Root + API Test |
| `ADMIN_EMAIL` | `stefanopiga1976@gmail.com` | Email admin default | Root + API Test |
| `TESTING` | `true` | Flag environment test | API Test only |
| `RATE_LIMITING_ENABLED` | `false` | Toggle rate limiting (disable test) | API Test only |
```
```691:697:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Usage Notes per Agent AI:**
- Template files sono **safe to read** (contengono solo placeholders e nomi variabili)
- File reali `.env` **NON visionabili** per policy sicurezza
- Per audit environment (Task 1): confrontare variabili richieste nel codice (`os.getenv()`) con template disponibili
- Per troubleshooting: template mostrano valori corretti formato/struttura (URL patterns, connection strings format)
- Per setup nuovi environment: template contengono istruzioni inline (es. "Use TEST database, NOT production")
```

### Riferimenti file configurazione (estratti)
```645:654:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
Il progetto utilizza 3 file `.env` distinti per configurazione multi-ambiente. I file reali contengono secrets e sono gitignored. I template elencati mostrano nomi variabili e valori non-sensitive utili per reference:
...
- **Key variables:** `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_JWT_SECRET`, `DATABASE_URL`, `OPENAI_API_KEY`, `CELERY_ENABLED`, `CELERY_BROKER_URL`, `CELERY_RESULT_BACKEND`, `ADMIN_EMAIL`, `TOKEN_SUPABASE_CHAT_FISIO`
- **Note:** File reale `.env` contiene valori production/development ma non visionabile da agent per policy sicurezza
```

### Contesto numerico e stato test (estratti)
```15:21:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Stato Attuale (Post Story 5.5 - Ottobre 2025):**
- ‚úÖ Architettura refactorizzata modulare (Story 5.2: main.py 2086‚Üí112 righe)
- ‚úÖ Test suite 100% pass rate (Story 5.5: 179/179 test attivi, 0 failed)
- ‚úÖ Pipeline RAG implementata e testata (Story 2.5: Quality Gate PASS 90/100)
- ‚úÖ Coverage 93% su apps/api
- ‚úÖ Known issues risolti (FK constraints, rate limiting, embedding NULL)
```
```112:117:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
### ~~AC7-10: Test Coverage & Pipeline Validation~~ ‚ùå RIMOSSI
**Rationale:** Gi√† validati in Story 5.* (test suite 100%, pipeline Story 2.5).
- Story 5.5: test suite 179/179 PASSED, 0 FAILED
- Story 2.5: pipeline RAG testata, Quality Gate PASS 90/100
- Coverage 93% su apps/api
```
```709:714:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Test Coverage Status (Post Story 5.5):**
- ‚úÖ **Integration tests:** 22 SKIPPED (by design - RL tests, E2E infra)
- ‚úÖ **Test suite:** 179/179 PASSED (100% pass rate attivi)
- ‚úÖ **Coverage:** 93% su apps/api
- ‚úÖ **E2E tests:** Pipeline testata (test_pipeline_e2e.py passano)
```

### Known Issues ‚Äî stato risoluzione
```700:707:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Issues Risolti (Story 5.* - Verificato):**
- ‚úÖ **DATA-001**: Embedding NULL (121 chunks) ‚Üí **RISOLTO** Story 2.5 (retry logic tenacity implementato)
- ‚úÖ **OPS-001**: Celery worker instability ‚Üí **RISOLTO** Story 5.4 (test isolation, rate limiting bypass)
- ‚úÖ **PERF-001**: OpenAI rate limiting ‚Üí **MITIGATO** Story 2.5 (adaptive batching implementato)
- ‚úÖ **TEST-001**: FK constraint violations ‚Üí **RISOLTO** Story 5.4.2 (fixture upsert con user creation)
- ‚úÖ **TEST-002**: Rate limit pollution ‚Üí **RISOLTO** Story 5.4 (bypass test environment)
- ‚úÖ **TEST-003**: Auth override propagation ‚Üí **RISOLTO** Story 5.4.1 (client_admin/client_student fixtures)
```

### Infrastructure & configurazione (estratti)
```515:522:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
- [ ] Analizzare `docker-compose.yml`:
    - Services dependencies verificati: api‚Üíredis, celery-worker‚Üíredis+api, web (independence)
    - Restart policies: verificare se definiti (default: no restart automatico)
    - Health checks: verificare se definiti per api, celery-worker
    - Network: `fisio-rag-net` presente
```
```749:769:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**NOTA IMPORTANTE:** Tutti i comandi terminal in questa storia sono per **PowerShell** (Windows). Sistema operativo target: Windows 10 (win32 10.0.19045). Shell: `C:\Windows\System32\cmd.exe` ma esecuzione comandi via PowerShell.
...
# Redis CLI
docker exec fisio-rag-redis redis-cli
```

### Database & indexing (estratti)
```418:424:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
- [ ] **CRITICO**: Verificare embedding NOT NULL (issue production: 121 chunks con NULL)
- [ ] Se embedding NULL, investigare cause:
    - Celery task fallita senza error logging?
    - SupabaseVectorStore.add_texts() ritorn√≤ IDs ma non salv√≤ embeddings?
    - Transazione database rollback?
- [ ] Verificare indice pgvector: `SELECT indexname FROM pg_indexes WHERE tablename = 'document_chunks';`
```
```399:403:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
vector = embeddings.embed_query(test_chunk)
print(f"Vector dimension: {len(vector)}, First 5 values: {vector[:5]}")
```
```402:402:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
- [ ] Verificare dimensione vettore corretta (1536 per text-embedding-3-small)
```

### Deliverables ed evidenze (estratti)
```851:860:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Report Principali (Aggiornati per Production Readiness):**
1. `docs/reports/rag-production-readiness-summary.md` - Executive summary audit
2. `docs/reports/rag-performance-benchmarks.md` - Latency p95/throughput metrics
3. `docs/reports/rag-security-audit.md` - JWT/secrets/CORS audit findings
4. `docs/reports/rag-infrastructure-health.md` - Docker/Celery/Redis resilience
5. `docs/reports/rag-database-integrity.md` - DB audit (orphan records, indices)
6. `docs/reports/rag-deployment-checklist.md` - Pre/post deployment steps
```
```861:866:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Evidence Artifacts**:
- `temp/logs/` - Docker logs salvati per analisi
- `temp/screenshots/` - UI behavior screenshots
- `temp/queries/` - SQL queries + results
- `temp/payloads/` - API request/response samples
```

### Testing & Load (estratti)
```830:841:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Unit Tests (New)**:
- `tests/test_environment_validation.py`: verifica tutte env vars definite
- `tests/test_docker_health.py`: mock health check responses
- `tests/test_pipeline_logging.py`: verifica logging output structure

**Integration Tests (New)**:
- `tests/integration/test_celery_task_execution.py`: test task enqueue + result fetch
- `tests/integration/test_embedding_real_api.py`: test OpenAI embedding con API reale (skip se key mancante)
- `tests/integration/test_supabase_vector_store.py`: test pgvector insert + search con test DB
```
```847:850:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Load Tests (Future)**:
- Locust o pytest-benchmark per pipeline throughput
- Target: 10 documenti concorrenti senza degradation
```

### Success criteria (estratti)
```885:891:docs/stories/2.6.rag-system-validation-and-gap-analysis.md
**Story considerata completata quando**:
1. Tutti 10 AC verificati (PASS/FAIL documentato)
2. Actionable backlog creato con P0/P1/P2/P3 priorities
3. Root cause identificata per discrepanza documentazione vs realt√†
4. Executive summary presentato e validato da team
5. Team ha roadmap chiara per fix (storie successive)
```

Sezioni non presenti nel sorgente: not available in source.
