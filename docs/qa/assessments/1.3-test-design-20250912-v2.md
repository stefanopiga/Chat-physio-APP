# Test Design: Story 1.3 (v2)

Date: 2025-09-12
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 14
- Unit tests: 3 (21%)
- Integration tests: 8 (57%)
- E2E tests: 3 (21%)
- Priority distribution: P0: 7, P1: 5, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Endpoint admin per generare codici

| ID           | Level       | Priority | Test                                                           | Justification                                  |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ---------------------------------------------- |
| 1.3-UNIT-001 | Unit        | P1       | Valida generazione stringa codice (formato, lunghezza)        | Logica isolabile                               |
| 1.3-INT-001  | Integration | P0       | POST admin/generate crea `AccessCode` con campi previsti       | Interazione API↔DB (PostgREST/BE)              |
| 1.3-INT-002  | Integration | P0       | Endpoint protetto: 401/403 senza token admin                   | Security path                                  |

### AC2: Endpoint pubblico per validare un codice

| ID           | Level       | Priority | Test                                                           | Justification                                  |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ---------------------------------------------- |
| 1.3-UNIT-002 | Unit        | P1       | Validator formato input codice                                 | Logica isolabile                               |
| 1.3-INT-003  | Integration | P0       | Codice attivo/non scaduto → 200                                | Contratto endpoint                             |
| 1.3-INT-004  | Integration | P0       | Codice inesistente/inattivo/scaduto → 4xx                      | Error handling critico                         |

### AC3: Un codice valido restituisce un token temporaneo

| ID           | Level       | Priority | Test                                                           | Justification                                  |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ---------------------------------------------- |
| 1.3-INT-005  | Integration | P0       | Validazione ok → response contiene token, type, expires_in     | Contratto di risposta                          |
| 1.3-INT-006  | Integration | P0       | Decodifica JWT: `iss` e `aud` attesi; `exp` futuro; alg HS256  | Specifiche addendum (JWT)                      |

### AC4: Campo codice in pagina principale

| ID           | Level       | Priority | Test                                                           | Justification                                  |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ---------------------------------------------- |
| 1.3-UNIT-003 | Unit        | P2       | Rendering input e stato controllato                            | Logica UI isolata                              |
| 1.3-E2E-001  | E2E         | P1       | Presenza campo codice nella home                               | Journey base                                   |

### AC5: Redirect alla chat su codice valido

| ID           | Level       | Priority | Test                                                           | Justification                                  |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ---------------------------------------------- |
| 1.3-E2E-002  | E2E         | P0       | Inserimento codice valido → redirect a /chat                   | Percorso utente critico                        |

### AC6–AC7: Validazione client-side e error message

| ID           | Level       | Priority | Test                                                           | Justification                                  |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ---------------------------------------------- |
| 1.3-INT-007  | Integration | P1       | Submit con input vuoto → blocco + messaggio sotto il campo     | Comportamento form + validazione FE            |
| 1.3-E2E-003  | E2E         | P1       | Inserimento non valido → messaggio specifico in UI             | Esperienza utente                              |

### Error Handling (Exchange Code)

| ID           | Level       | Priority | Test                                                           | Justification                                  |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | ---------------------------------------------- |
| 1.3-INT-008  | Integration | P0       | `invalid_request` → 400                                        | Etichette esemplificative in addendum          |
| 1.3-INT-009  | Integration | P0       | `invalid_code` → 401                                           | Etichette esemplificative in addendum          |
| 1.3-INT-010  | Integration | P1       | `expired_code` → 410                                           | Etichette esemplificative in addendum          |
| 1.3-INT-011  | Integration | P1       | `code_already_used` → 409                                      | Etichette esemplificative in addendum          |
| 1.3-INT-012  | Integration | P1       | `rate_limited` → 429                                           | Etichette esemplificative in addendum          |

## Risk Coverage

- P0 estesi a contract/security (JWT claims e error handling principali).
- Dipendenze dalle specifiche addendum per le asserzioni JWT.

## Recommended Execution Order

1. P0 Unit/Integration (1.3-INT-001, 1.3-INT-002, 1.3-INT-003, 1.3-INT-004, 1.3-INT-005, 1.3-INT-006, 1.3-E2E-002)
2. P1 scenari error handling (1.3-INT-010..012), P1 UI (1.3-INT-007, 1.3-E2E-003)
3. P2 rimanenti

## Gate YAML Block

test_design:
  scenarios_total: 14
  by_level:
    unit: 3
    integration: 8
    e2e: 3
  by_priority:
    p0: 7
    p1: 5
    p2: 2
  coverage_gaps: []
