# Risk Profile — Story 2.4.2: Implementazione Gestione Errori Pipeline di Ingestione

## Riepilogo
- **ID**: 2.4.2 (fonte: L6)
- **Tipo**: Technical Debt / Blocker (fonte: L7)
- **Epic**: Epic 2 — Core Knowledge Pipeline (fonte: L8)
- **Priorità**: Critical (P0 - Blocker) (fonte: L9)
- **Complessità**: Low (fonte: L10)
- **Effort stimato**: 2-3 ore implementation + 1 ora testing (fonte: L11, L488)
- **Storie bloccate**: Testing Story 2.4.1, First Real Document Ingestion (fonte: L12)

## Contesto del rischio
- Il flusso corrente di ingestion non gestisce errori OpenAI e Supabase, causando fallimenti silenziosi con HTTP 200 e `"inserted": 0` (fonte: L30–L33, L38–L57).
- L'obiettivo è implementare pattern di gestione errori definiti in `addendum-external-services-error-handling.md` per rilevare e propagare correttamente i fallimenti (fonte: L18–L20, L66–L124).
- Scope limitato a singolo file `indexer.py` con modifiche a `_get_embeddings_model()` e `index_chunks()` (fonte: L193, L451).

## Elenco rischi

### Rischi Tecnici di Implementazione

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-2.4.2-1 | Pattern addendum non copre edge case specifici di LangChain | Bassa | Medio | Addendum basato su ricerca esaustiva documentazione ufficiale OpenAI e LangChain (fonte: L359) |
| R-2.4.2-2 | Import `openai` mancante o versione incompatibile con exception hierarchy | Bassa | Alto | Verificare `pyproject.toml` per dipendenza `openai` via `langchain_openai`; test import in container |
| R-2.4.2-3 | Logger non inizializzato correttamente nel modulo `indexer.py` | Media | Medio | Verificare configurazione logging in `apps/api/api/main.py`; test logging output durante implementazione (fonte: L351) |
| R-2.4.2-4 | Try/except annidati in `index_chunks()` creano flusso complesso | Bassa | Basso | Pattern validato in addendum sezione 3.4; review codice obbligatorio |

### Rischi di Integrazione

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-2.4.2-5 | Exception propagata da `indexer.py` catturata da try/except generale in `main.py` (line 1366) che logga solo messaggio generico | Alta | Alto | **CRITICO**: Verificare che logging dettagliato in `indexer.py` avvenga PRIMA del raise; exception handling in `main.py` deve preservare contesto diagnostico |
| R-2.4.2-6 | LangChain wrapper potrebbe trasformare eccezioni OpenAI in eccezioni generiche | Media | Alto | Test con chiave invalida per verificare tipo eccezione effettiva; se necessario, aggiungere catch per exception wrapper LangChain |
| R-2.4.2-7 | Error response HTTP 500 non include dettagli diagnostici per client | Bassa | Medio | Documentare che dettagli errore sono nei log server-side; client riceve solo status code |

### Rischi di Testing

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-2.4.2-8 | Impossibilità di testare error paths senza invalidare configurazione container reale | Alta | Medio | **ACCETTATO**: Test manuali con backup/ripristino `.env`; nessun test automatizzato per error paths (fonte: L368–L390) |
| R-2.4.2-9 | Container restart richiesto tra test casi, rallentando feedback loop | Media | Basso | Script test automatizzato per backup/modifica/restart/test/ripristino; stimare 5-10 minuti per ciclo completo |
| R-2.4.2-10 | Test Case AC3 (Supabase failure) non eseguibile senza permessi admin Supabase | Alta | Medio | **DIFFERITO**: Test simulato con mock in unit test futuro; validazione produzione tramite monitoring |

### Rischi di Deployment

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-2.4.2-11 | Se `OPENAI_API_KEY` già invalida/mancante in ambiente corrente, fix rivelerà errori immediati al primo sync-job | Media | Alto | **PRE-DEPLOYMENT CHECK OBBLIGATORIO**: Eseguire `docker exec fisio-rag-api env | grep OPENAI_API_KEY` e validare con test call OpenAI prima del merge |
| R-2.4.2-12 | Breaking change comportamento: endpoint passa da HTTP 200 (silent fail) a HTTP 500 (explicit error) | Alta | Medio | **ACCETTATO**: Comportamento corretto per API REST; documentare breaking change in release notes; client deve gestire 5xx |
| R-2.4.2-13 | Logging verboso potrebbe degradare performance in produzione | Bassa | Basso | Logging info/error standard; nessun logging debug o trace in produzione; impact stimato < 1ms per operazione |

### Rischi di Dipendenze

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-2.4.2-14 | Versione `openai` library incompatibile con exception types definiti in addendum | Bassa | Alto | Verificare versione in `pyproject.toml`; addendum basato su `openai >= 1.0.0` (API v2); test import exception classes |
| R-2.4.2-15 | Logging framework non supporta parameter `extra={}` in logger.error() | Bassa | Basso | Pattern standard Python logging; fallback a logging senza extra se non supportato |

### Rischi di Sicurezza

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-2.4.2-16 | Log error potrebbero esporre parti di `OPENAI_API_KEY` nel messaggio errore | Media | Alto | **REVIEW OBBLIGATORIO**: Verificare che messaggi errore OpenAI non includano chiave API completa; se necessario, sanitizzare messaggio prima del log |
| R-2.4.2-17 | Stack trace completi in log potrebbero rivelare dettagli architetturali interni | Bassa | Medio | **ACCETTATO**: Stack trace necessari per debugging; log accessibili solo ad admin; risk accettabile per troubleshooting |

### Rischi di Scope Creep

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-2.4.2-18 | Tentazione di aggiungere retry logic o circuit breaker durante implementazione | Media | Medio | **SCOPE LOCK**: Story limitata a error detection e logging; retry logic differito a story futura (fonte: L332) |
| R-2.4.2-19 | Richieste di estendere error handling ad altri moduli (es. `chunk_router.py`) | Media | Medio | **OUT OF SCOPE**: Focus su `indexer.py` come definito; altri moduli in story separate |

## Verifiche e criteri di accettazione rilevanti

### Criteri di Accettazione
- **AC1**: OpenAI `AuthenticationError` deve causare HTTP 500 con log error diagnostico (fonte: L130–L148).
- **AC2**: OpenAI `APIConnectionError` deve causare HTTP 500 con log error connessione (fonte: L150–L156).
- **AC3**: Supabase insert failure deve causare HTTP 500 con messaggio specifico "Error inserting: No rows added" (fonte: L158–L169).
- **AC4**: Configurazione corretta deve restituire `inserted > 0` con log success (fonte: L171–L185).

### Test Coverage
- **Test Case 1**: API key invalida → HTTP 500 + log `"openai.AuthenticationError"` (fonte: L368–L390).
- **Test Case 2**: Configurazione corretta → HTTP 200 + `inserted: 1` + database verification (fonte: L392–L408).
- **Test Case 3**: Logging completo con struttura diagnostica verificata (fonte: L410–L418).

## Piano di mitigazione sintetico

### Pre-Implementation Checklist
1. **Verifica dipendenza OpenAI** (mitiga R-2.4.2-2, R-2.4.2-14):
   ```bash
   docker exec fisio-rag-api python -c "import openai; print(openai.__version__); print(openai.AuthenticationError)"
   # Expected: version >= 1.0.0, exception class defined
   ```

2. **Verifica configurazione attuale** (mitiga R-2.4.2-11):
   ```bash
   docker exec fisio-rag-api env | grep OPENAI_API_KEY
   # Expected: sk-proj-... (valid format)
   ```

3. **Test call OpenAI baseline** (mitiga R-2.4.2-11):
   ```bash
   docker exec fisio-rag-api python -c "from langchain_openai import OpenAIEmbeddings; e = OpenAIEmbeddings(model='text-embedding-3-small'); print(len(e.embed_query('test')))"
   # Expected: 1536 (embedding dimension)
   ```

### Implementation Phase
1. **Implementare pattern esattamente come definito in addendum** (mitiga R-2.4.2-1, R-2.4.2-4):
   - Sezione 2.3 per `_get_embeddings_model()` (fonte: L206–L244)
   - Sezione 3.4 per `add_texts()` error handling (fonte: L269–L326)

2. **Verificare logging output in real-time durante development** (mitiga R-2.4.2-3, R-2.4.2-5):
   ```bash
   docker logs -f fisio-rag-api
   # Monitorare output durante test calls
   ```

3. **Review security: sanitizzare messaggi errore** (mitiga R-2.4.2-16):
   - Verificare che `str(e)` da OpenAI non includa API key
   - Se presente, implementare sanitization: `error_msg = str(e).replace(os.getenv('OPENAI_API_KEY', '')[:10], '***')`

### Testing Phase
1. **Eseguire test manuali in sequenza** (mitiga R-2.4.2-8, R-2.4.2-9):
   - Test Case 1: API key invalida (fonte: L368–L390)
   - Ripristino configurazione
   - Test Case 2: Configurazione corretta (fonte: L392–L408)
   - Test Case 3: Verifica logging (fonte: L410–L418)

2. **Validare propagazione exception attraverso layer** (mitiga R-2.4.2-5, R-2.4.2-6):
   - Log di `indexer.py` devono apparire PRIMA di log `main.py`
   - HTTP 500 response deve essere generato correttamente
   - Client deve ricevere status code senza dettagli interni

### Post-Implementation
1. **Documentare breaking change** (mitiga R-2.4.2-12):
   - Aggiornare API documentation con nuovi status code 500
   - Changelog: "Error handling migliorato: configurazione invalida ora restituisce HTTP 500"

2. **Monitoring deployment** (mitiga R-2.4.2-11, R-2.4.2-13):
   - Verificare log volume post-deployment
   - Monitorare latency endpoint `/sync-jobs` per performance impact

## Impatti

### Positivi
- Sblocca testing Story 2.4.1 con documento reale (fonte: L22, L345).
- Abilita diagnosticabilità immediata errori configurazione (fonte: L22, L60–L63).
- Riduce drasticamente tempo troubleshooting per fallimenti ingestion.

### Negativi (Accettati)
- Breaking change comportamento endpoint: HTTP 200 → HTTP 500 per errori (R-2.4.2-12).
- Test manuali obbligatori senza automation (R-2.4.2-8, R-2.4.2-10).
- Log più verbosi con potenziale minor esposizione informazioni (R-2.4.2-16, R-2.4.2-17 - mitigato).

## Matrice rischi per priorità

### Alta Priorità (Mitigation Obbligatoria)
- **R-2.4.2-5**: Exception handling layer `main.py` - CRITICO per diagnosticabilità
- **R-2.4.2-11**: Pre-deployment check configurazione - CRITICO per evitare downtime immediato
- **R-2.4.2-2**: Verifica dipendenza `openai` - BLOCKER tecnico

### Media Priorità (Mitigation Raccomandata)
- **R-2.4.2-3**: Configurazione logging
- **R-2.4.2-6**: LangChain exception wrapping
- **R-2.4.2-8**: Test automation impossibile - ACCETTATO
- **R-2.4.2-16**: Security log sanitization - REVIEW OBBLIGATORIO

### Bassa Priorità (Monitoraggio)
- **R-2.4.2-1, R-2.4.2-4, R-2.4.2-13, R-2.4.2-15**: Rischi tecnici minori
- **R-2.4.2-18, R-2.4.2-19**: Scope creep management

## Fonti puntuali
- `docs/stories/2.4.2-error-handling-ingestion-pipeline.md`: L6–L12, L18–L20, L28–L57, L66–L124, L130–L185, L193–L326, L332, L345, L351, L359, L368–L418, L451, L488.
- `docs/architecture/addendum-external-services-error-handling.md`: Sezioni 2.3 (righe 130-201), 3.4 (righe 290-388).
- `apps/api/api/main.py`: Linee 1366 (exception handling generale endpoint).
- `apps/api/api/knowledge_base/indexer.py`: Linee 18-47 (codice sorgente attuale senza error handling).

---

**Analisi eseguita**: 2025-10-06  
**Reviewer**: QA Team  
**Risk Level Complessivo**: **MEDIO-ALTO**  
**Raccomandazione**: Procedere con implementazione dopo esecuzione pre-implementation checklist completa. Rischi critici (R-2.4.2-5, R-2.4.2-11, R-2.4.2-16) richiedono attenzione specifica durante implementation e review.

