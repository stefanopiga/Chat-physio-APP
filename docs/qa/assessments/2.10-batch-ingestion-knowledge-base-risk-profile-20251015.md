# Risk Profile: Story 2.10 — Batch Ingestion Knowledge Base

Date: 2025-10-15
Reviewer: Quinn (Test Architect)

## Executive Summary

- Scope: script batch ingestion verso `POST /api/v1/admin/knowledge-base/sync-jobs` su tutti i file in `conoscenza/fisioterapia/` con rate limit 10/min e backoff.
- Total Risks Identified: 16
- Critical Risks: 3
- High Risks: 5
- Overall Risk Score: 58/100 (High, controllabile con mitigazioni operative e test mirati)

## Critical Risks Requiring Immediate Attention

### 1. OPS-001: Violazione rate limit con 429 persistenti durante batch
**Score: 9 (Critical)**  
**Probability**: High — Ingestion prolungata, rischio di jitter non sufficiente.  
**Impact**: High — Throttling prolungato, tempi ingestione >> ore, potenziali blocchi IP o degradazioni globali.
**Mitigation**:
- Delay base 6–7s + jitter casuale 0.5–1.5s; rispettare sempre `Retry-After` su 429.  
- Exponential backoff con cap (p.es. 6s → 12 → 24 → 48, max 60s).  
- Circuit breaker su burst errori 429 per evitare retry tempestivi.

### 2. SEC-001: Gestione credenziali admin JWT non sicura
**Score: 9 (Critical)**  
**Probability**: Medium — Uso script locale; rischio commit o log accidentali.  
**Impact**: High — Compromissione KB admin → ingestion non autorizzate, data poisoning.
**Mitigation**:
- Caricare JWT da env/secret manager; mai loggare header Authorization.  
- Validare assenza di PII/segreti nei log e nel report.  
- Rotazione chiavi post-run in ambienti condivisi.

### 3. DATA-001: Duplicazione o inconsistenza dati per mancata idempotenza client
**Score: 9 (Critical)**  
**Probability**: Medium — Run interrotte/non deterministiche senza stato robusto.  
**Impact**: High — Duplicati, conteggi chunk inattesi, report inattendibili.
**Mitigation**:
- `--state-file` transazionale (write-then-rename), salvataggi atomici per file.  
- Verifica lato backend già presente su `documents.file_hash`; client deve rispettare resume ed evitare reinvii riusciti.  
- Check post-run per duplicati e outliers.

## Risk Distribution

### By Category
- Operational: 6 rischi (1 critical)
- Security: 3 rischi (1 critical)
- Data: 4 rischi (1 critical)
- Performance: 2 rischi (0 critical)
- Compliance: 1 rischio (0 critical)

### By Component
- Client ingestion script: 10 rischi  
- Backend `/sync-jobs`: 3 rischi  
- Infra/limits (Traefik, SlowAPI, Supabase/OpenAI): 3 rischi

## Detailed Risk Register

| Risk ID   | Category    | Title                                                        | Prob. | Impact | Score | Mitigation Summary |
|-----------|-------------|--------------------------------------------------------------|-------|--------|-------|--------------------|
| OPS-001   | Operational | 429 persistenti per violazione rate limit                    | High  | High   | 9     | Jitter + rispetto `Retry-After` + backoff cap + circuit breaker |
| SEC-001   | Security    | Gestione insicura JWT admin (leak in env/log)               | Medium| High   | 9     | Secret via env, no log header, rotazione chiavi |
| DATA-001  | Data        | Idempotenza client incompleta → duplicati/inconsistenze      | Medium| High   | 9     | State file atomico + resume corretto + verifica duplicati |
| OPS-002   | Operational | Interruzioni run (crash/OS) corrompono `--state-file`        | Medium| Medium | 6     | Scritture atomiche, checkpoint frequenti, backup periodico |
| DATA-002  | Data        | Parsing DOCX fallisce su file corrotti/complessi            | Medium| Medium | 6     | Try/catch per file; fallback txt; skip + log dettagliato |
| PERF-001  | Performance | Saturazione worker/coda durante picchi                       | Medium| Medium | 6     | Throttling client; monitor coda; eventualmente sleep adattivo |
| OPS-003   | Operational | Calibrazione inadeguata `--sleep-seconds`/jitter            | Medium| Medium | 4     | Parametrizzare + default sicuri; config per ambiente |
| SEC-002   | Security    | PII o segreti nei log/report                                 | Low   | High   | 4     | Log JSON senza contenuti sensibili; redazione campi |
| DATA-003  | Data        | Disallineamento chunking → conteggi imprevisti               | Low   | Medium | 3     | Validazioni post-run su `document_chunks` e distribuzioni |
| OPS-004   | Operational | Errori rete/timeout non classificati correttamente           | Medium| Medium | 4     | Retry con backoff solo su classi temporanee; fail-fast su 4xx |
| PERF-002  | Performance | Regressione p95 `/sync-jobs` > 2s durante batch              | Low   | Medium | 3     | Limitare concorrenza (seriale); monitor p95; cache attiva |
| SEC-003   | Security    | Permessi eccessivi su file/paths lato client                 | Low   | Medium | 2     | Principle of least privilege; no path traversal nei metadati |
| OPS-005   | Operational | File system edge cases (encoding, nomi lunghi, permessi)     | Medium| Low    | 2     | Normalizzazione path/encoding; skip controllato |
| DATA-004  | Data        | Mismatch categoria/topic metadati → retrieval impattato      | Low   | Medium | 2     | Validazioni su categoria `fisioterapia` e topic da cartella |
| COMP-001  | Compliance  | Mancata conformità licensing/diritti documenti               | Low   | Medium | 2     | Verifica origine/docs; esclusione contenuti non autorizzati |
| OPS-006   | Operational | Report finale incompleto/inaccurato                          | Medium| Low    | 2     | Conteggi, top-chunks, success/fail chiari; CSV/JSON verificati |

## Risk-Based Testing Strategy

### Priority 1: Critical/High
- Test funzionale rate-limit: simulare 429 con `Retry-After` e verificare backoff/jitter e rispetto cap.  
- Test sicurezza credenziali: esecuzione con logger a livello DEBUG e assert assenza header/PII nei log/report.  
- Test idempotenza: interrompere run a metà, ripartire con `--state-file` e verificare zero reinvii dei già riusciti.

### Priority 2: Medium
- Test parsing DOCX/txt/md (file validi e corrotti).  
- Test resilienza rete: timeout e 5xx con retry fino a `--max-retries`.  
- Test integrazione: verifica `job_id` e inserimenti in `document_chunks` con `--limit` 3.

### Priority 3: Low
- Validazioni post-run: conteggi chunk, `embedding IS NULL = 0`, coerenza metadati categoria/topic.  
- Verifica report: presenza metriche chiave e file top per chunks.

## Risk Acceptance Criteria

### Must Fix Before Full Batch
- OPS-001, SEC-001, DATA-001.  
- Esito positivo dei test Priority 1; alerting attivo su 429/5xx.

### Can Proceed With Monitoring
- Score 6: OPS-002, DATA-002, PERF-001 con logging/metriche e fallback.  
- Score 4: OPS-003, OPS-004 con osservabilità.

### Accepted Risks
- Score ≤3 con monitoraggio e piano rollback (pause/resume batch).

## Monitoring Requirements
- Metriche p95/p99 `/sync-jobs`, tasso 429 e 5xx.  
- Profondità coda worker e tempi end-to-end.  
- Validazioni SQL post-run automatiche nel report.

## Risk Review Triggers
- Cambi su rate limit (Traefik/SlowAPI) o policy API.  
- Modifiche allo schema KB/chunking o parametri embedding.  
- Aumento dimensione dataset o formati nuovi (PDF, immagini OCR).

## Fonti Ufficiali da Consultare (per conferme e limiti)
- Traefik Rate Limiting Middleware: https://doc.traefik.io/traefik/middlewares/http/ratelimit/  
- SlowAPI (Flask limit-style for Starlette/FastAPI): https://slowapi.readthedocs.io/  
- OpenAI API rate limits e best practices: https://platform.openai.com/docs/guides/rate-limits  
- Supabase PostgREST/limits e politiche: https://supabase.com/docs  
- python-docx parsing e limitazioni: https://python-docx.readthedocs.io/  
- FastAPI errore/timeout handling: https://fastapi.tiangolo.com/  
- Exponential backoff guidelines (IETF): https://www.rfc-editor.org/rfc/rfc8989

---

# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 3
    high: 5
    medium: 6
    low: 2
  highest:
    id: OPS-001
    score: 9
    title: '429 persistenti per violazione rate limit'
  recommendations:
    must_fix:
      - 'Jitter + rispetto Retry-After + backoff cap + circuit breaker'
      - 'Gestione sicura JWT admin; no secrets nei log; rotazione chiavi'
      - 'State file atomico; resume; verifica duplicati post-run'
    monitor:
      - 'p95/p99 /sync-jobs; tasso 429/5xx; profondità coda; embedding NULL=0'

Risk profile: qa.qaLocation/assessments/2.10-batch-ingestion-knowledge-base-risk-profile-20251015.md

