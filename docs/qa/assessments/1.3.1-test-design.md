# Test Design — Story 1.3.1: Student Token Management System

## Obiettivi e Scope
- Verificare CRUD admin `student_tokens` con soft delete e cascade revoke (fonte: `docs/stories/1.3.1-student-token-management-system.md` L55–L63).
- Validare estensione `POST /api/v1/auth/exchange-code` al Refresh Token Pattern e cookie `HttpOnly` (fonte: L65–L73, L286–L290).
- Validare `POST /api/v1/auth/refresh-token`: controlli su `refresh_tokens`, generazione nuovo access token, audit `last_used_at` (fonte: L73–L79, L307–L335).
- Confermare schema DB e RLS policy: tabelle `student_tokens`, `refresh_tokens`, indici e RLS admin-only (fonte: L49–L54, L90–L91, L117–L173, L140–L149, L175–L191).

## Tracciabilità Requisiti (AC)
- AC2: `POST /api/v1/admin/student-tokens` crea token con durata 1 anno (fonte: L57–L58).
- AC3: `GET /api/v1/admin/student-tokens` con filtro `is_active` (fonte: L59–L60).
- AC4: `DELETE /api/v1/admin/student-tokens/{id}` → soft delete + revoke refresh (fonte: L61–L62).
- AC5: Estensione `exchange-code` per accettare student token e impostare cookie refresh (fonte: L65–L73, L286–L290).
- AC6: `POST /api/v1/auth/refresh-token` rinnova access token (fonte: L73–L79, L318–L325).
- AC10: RLS policy su `student_tokens` e `refresh_tokens` (fonte: L90–L91, L140–L149, L175–L191).
- AC11: Copertura test backend/integration/E2E per flussi principali (fonte: L92–L97, L972–L1010).
## Ambiente di Test
- Backend: FastAPI apps/api, Supabase (PostgreSQL 18), PyJWT HS256 (fonte: L688–L696, L706–L729).
- Sicurezza cookie: `HttpOnly`, `Secure`, `SameSite=Strict`, `Path=/api/v1/auth/refresh-token` (fonte: L742–L771).
- Variabili: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_JWT_SECRET`, `TEMP_JWT_EXPIRES_MINUTES`, `CLOCK_SKEW_LEEWAY_SECONDS`, rate limits (fonte: L1102–L1139).
- Rate limiting: exchange-code, refresh-token, admin create (fonte: L858–L863, L871–L879).

## Dati di Test
- `admin_jwt_valid`: token admin con `app_metadata.role="admin"` (fonte: L100–L103, L140–L149).
- `student_token_valid`: stringa 32 char generata (fonte: L397–L404, L420–L440).
- `refresh_token_valid`: generato runtime dal sistema (fonte: L405–L413, L517–L527, L559–L633).

## Test Cases — Backend (Unit)
1. `test_generate_student_token_uniqueness()` — 1000 generazioni uniche (fonte: L974–L976).
2. `test_generate_refresh_token_uniqueness()` — 1000 generazioni uniche, length 64 (fonte: L976–L977).
3. `test_create_student_token_request_validation()` — Pydantic min/max length (fonte: L977–L980).
4. `test_is_admin_check()` — `_is_admin()` helper (fonte: L978–L979).

## Test Cases — Backend (Integration CRUD)
5. `test_create_student_token_success()` — POST crea record DB (fonte: L981–L982).
6. `test_create_student_token_unauthorized()` — 401 senza JWT (fonte: L982–L983).
7. `test_create_student_token_forbidden()` — 403 non-admin (fonte: L983–L984).
8. `test_list_student_tokens_filtered()` — filtro is_active (fonte: L984–L985).
9. `test_delete_student_token_soft_delete()` — is_active=false + refresh revocati (fonte: L985–L986).
10. `test_delete_student_token_not_found()` — 404 (fonte: L986–L987).

## Test Cases — Backend (Integration Refresh Pattern)
11. `test_exchange_code_with_student_token()` — 200 + access token 15 min + cookie refresh + DB insert (fonte: L989–L996, L275–L284, L286–L290).
12. `test_exchange_code_with_access_code()` — comportamento invariato (fonte: L993–L996, L291–L299).
13. `test_exchange_code_with_expired_student_token()` — 410 (fonte: L996–L997).
14. `test_exchange_code_with_revoked_student_token()` — 401 (fonte: L997–L998).
15. `test_refresh_token_success()` — nuovo access token + last_used_at (fonte: L998–L1002, L318–L325, L615–L619).
16. `test_refresh_token_missing_cookie()` — 400 (fonte: L1002–L1003, L328–L331).
17. `test_refresh_token_invalid()` — 401 (fonte: L1003–L1004, L576–L582, L328–L331).
18. `test_refresh_token_revoked()` — 401 (fonte: L1004–L1005, L597–L605, L328–L331).
19. `test_refresh_token_expired()` — 410 (fonte: L1005–L1006, L587–L595, L331–L332).
20. `test_refresh_token_after_student_token_revoked()` — 401 dopo revoca (fonte: L1006–L1010, L657–L666).

## Test Cases — Frontend (Unit)
21. `test_student_tokens_form_validation()` — required fields (fonte: L1031–L1034).
22. `test_student_tokens_form_submit()` — mostra token generato (fonte: L1033–L1034).
23. `test_token_copy_to_clipboard()` — copia token (fonte: L1034–L1035).
24. `test_student_tokens_list_render()` — render tabella (fonte: L1035–L1036).
25. `test_student_tokens_revoke_action()` — dialog + DELETE (fonte: L1036–L1037).

## Test Cases — E2E (Playwright)
26. Flow completo admin CRUD e revoca (fonte: L1040–L1077).
27. Accesso non autorizzato/forbidden (fonte: L1079–L1082).
28. Scenari studente: token scaduto in login → errore visualizzato (fonte: L1082–L1083).

## Metriche di Uscita
- Tutti i test backend AC passano (fonte: L972–L1010).
- Tutti i test frontend unit + E2E passano (fonte: L1029–L1077, L1314–L1339).
- Refresh automatico confermato dopo 15+ minuti e revoca immediata riflessa (fonte: L1332–L1339).

## Ambiente e Variabili — Verifica
- JWT: algorithms=["HS256"], require exp/iat, leeway=120 (fonte: L688–L729).
- Cookie attributi: HttpOnly/Secure/SameSite/Path (fonte: L742–L771).
- Rate limits configurati via env (fonte: L871–L879, L1129–L1139).

## Tracciabilità
- Requisiti di test derivati esclusivamente dagli AC e dalla sezione Testing Strategy con riferimenti di riga.
