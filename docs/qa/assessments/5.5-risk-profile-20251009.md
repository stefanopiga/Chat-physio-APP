# QA Risk Profile — Story 5.5: Final Test Suite Cleanup

Status: Draft  
Date: 2025-10-09  
Source: docs/stories/5.5-final-test-suite-cleanup.md

---

## Scope
Valutazione dei rischi per la chiusura definitiva della suite di test (4 failure residui) come descritto nella Story 5.5. Tutte le affermazioni numeriche e temporali derivano unicamente dalla fonte indicata.

---

## Executive Summary
- Target: Pass rate 100% (180/180 test PASSED), Errors 0, Duration <600s, Coverage ≥93% (fonte L426-L436, L836-L870)
- Residui: 4 test failed post-5.4.3 (fonte L43-L50)
- Aree critiche: performance semantic search, endpoint chat mancante, validazione feedback, alias SQL sort (fonte L58-L177, L180-L293, L296-L421)

---

## Risk Register

### R1 — Performance target non realistico a 500ms p95
- Category: Performance/SLA
- Evidence: p95=5716ms su 30 richieste (fonte L185-L192)
- Cause: embedding latency esterna; query pgvector senza indice HNSW; assenza pooling (fonte L194-L226)
- Impact: test non passano; blocco CI/CD; SLA non rispettato (fonte L836-L841, L915-L919)
- Likelihood: Alta
- Severity: Alta
- Mitigation: HNSW index (fonte L635-L646), caching embedding (fonte L654-L676), connection pooling (fonte L678-L700), aggiornare threshold a 1000ms (fonte L702-L718)
- Residual Risk: Medio
- Acceptance Criteria collegati: AC3 p95 ≤ 1000ms (fonte L462-L470)

### R2 — Mancanza endpoint /api/v1/chat
- Category: Functional/Coverage
- Evidence: HTTP 404 POST /api/v1/chat (fonte L301-L321)
- Cause: endpoint non implementato/registrato o path mismatch (fonte L323-L349)
- Impact: test E2E fallisce; blocco pass rate 100% (fonte L836-L841)
- Likelihood: Media
- Severity: Alta
- Mitigation: implementare router chat e registrazione (fonte L362-L414, L809-L818)
- Residual Risk: Basso-Medio
- Acceptance Criteria collegati: AC4 (fonte L472-L480)

### R3 — Schema FeedbackCreate non allineato
- Category: Validation/API Contract
- Evidence: HTTP 422 per `feedback_id` required (fonte L65-L86, L88-L99)
- Cause: `feedback_id` richiesto in request invece che auto-generato (fonte L88-L115)
- Impact: test crea feedback fallisce; blocco copertura funzionale (fonte L117-L122)
- Likelihood: Media
- Severity: Media
- Mitigation: rimuovere `feedback_id` da request; generazione UUID server-side; response completa (fonte L101-L115, L538-L562)
- Residual Risk: Basso
- Acceptance Criteria collegati: AC1 (fonte L444-L451)

### R4 — Alias SQL non qualificato nel sort per dimensione
- Category: Data/Query Correctness
- Evidence: test attende `ORDER BY c.chunk_size`, query usa `ORDER BY chunk_size` (fonte L130-L140)
- Cause: alias non applicato o test eccessivamente rigido (fonte L142-L166, L168-L172)
- Impact: failure test; potenziale ambiguità in future join (fonte L173-L177)
- Likelihood: Media
- Severity: Bassa-Media
- Mitigation: qualificare alias e/o adeguare assertion a verifica risultato (fonte L152-L166, L609-L623)
- Residual Risk: Basso
- Acceptance Criteria collegati: AC2 (fonte L453-L460)

### R5 — Dipendenze infrastrutturali per performance
- Category: Environment/Infra
- Evidence: richiesta Redis opzionale; credenziali embedding pendenti (fonte L906-L914)
- Cause: caching distribuito non disponibile; credenziali embedding non configurate
- Impact: mitigazioni performance parziali; rischio instabilità test
- Likelihood: Media
- Severity: Media
- Mitigation: LRU in-memory (fonte L654-L676); pianificare Redis post-5.5 (fonte L922-L929)
- Residual Risk: Medio-Basso

### R6 — Tempo costruzione indice HNSW
- Category: Migration/Operational
- Evidence: tempo 10-30 min su dataset grandi (fonte L890-L893)
- Cause: build index su `document_chunks`
- Impact: finestra operativa; possibile lock se non CONCURRENTLY (nota in mitigazione)
- Likelihood: Media
- Severity: Media
- Mitigation: uso CONCURRENTLY (fonte L890-L893) e pianificazione finestra
- Residual Risk: Basso-Medio

### R7 — Flakiness regressioni integrazione
- Category: Testing/Stability
- Evidence: richiesta 5 run stabili (fonte L842-L855, L482-L488)
- Cause: dipendenze esterne; variabilità latenza; concorrenza test
- Impact: non determinismo; ritardi merge
- Likelihood: Media
- Severity: Media
- Mitigation: esecuzioni ripetute e verifica varianza 0; pooling; caching (fonte L842-L855, L678-L700, L654-L676)
- Residual Risk: Basso-Medio

---

## Risk Matrix
- High: R1, R2
- Medium: R3, R5, R6, R7
- Low: R4

---

## Controls Mapping → Acceptance Criteria/Plan
- AC1 Feedback: Task 1.2-1.3 (fonte L516-L536, L538-L568)
- AC2 Sort: Task 2.2 / Alternative test update (fonte L580-L607, L609-L629)
- AC3 Performance: Tasks 3.1-3.4 (fonte L633-L724)
- AC4 Chat: Tasks 4.2-4.3 (fonte L737-L818)
- Stability: Phase 5 (fonte L828-L855)

---

## QA Gate Recommendations
- Pass Gate condizionato a: AC1–AC4 satisfied; p95 ≤ 1000ms; 5 run stabili; full suite 180/180 PASSED (fonte L462-L470, L828-L855, L836-L841)
- Bloccare merge se: endpoint chat non registrato; assenza indice HNSW; schema feedback non corretto; p95 > 1000ms

---

## Traceability to Source
- Tutti i riferimenti tra parentesi “fonte Lx-Ly” puntano a `docs/stories/5.5-final-test-suite-cleanup.md` letto integralmente.

---

## Sign-off
- Owner: QA Engineer
- Reviewers: Tech Lead, Backend
- Decision: Pending mitigations completion
