# Test Design: Story 2.6 — RAG System Production Readiness Validation

Date: 2025-10-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 31
- By level: Unit=1, Integration=19, E2E=11
- Priority distribution: P0=15, P1=14, P2=2, P3=0
- Scope derivato da `docs/stories/2.6.rag-system-validation-and-gap-analysis.md` (AC1–AC6)

## Riferimenti vincolanti (fonte)

- AC4 performance: Search p95 < 1s; Chat p95 < 2s (fonte: story AC4 L86–L88)
- Pipeline e componenti: LangChain, Celery, Redis, Docker, Supabase/pgvector, FastAPI (fonte: story L31–L39)

## Test Scenarios by Acceptance Criteria
### AC1: Environment Production Audit

| ID             | Level       | Priority | Test                                                                 | Justification                                   |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------------------------------------------ |
| 2.6-INT-001    | Integration | P0       | Validazione variabili obbligatorie da template vs codice (`os.getenv`) | Copre boundary config-app; rischio sicurezza     |
| 2.6-INT-002    | Integration | P0       | Confronto `.env` root vs `apps/api/.env.test.local`                   | Divergenze ambiente impattano sicurezza/affid.   |
| 2.6-INT-003    | Integration | P1       | Mapping `docker-compose.yml` → services env                           | Corretta propagazione env ai container           |
| 2.6-INT-004    | Integration | P1       | Secrets strength checks (JWT >=32, API key format)                    | Prevenzione esposizione/weak secrets             |
| 2.6-UNIT-001   | Unit        | P2       | Validator schema env (se presente)                                    | Logica pura di validazione                       |

Esecuzione: script `scripts/validation/env_audit.py`; output `docs/reports/rag-environment-audit.md` (fonte story L176–L182; Dev Notes L907–L914).
### AC2: Infrastructure Health Matrix

| ID             | Level       | Priority | Test                                                           | Justification                              |
| -------------- | ----------- | -------- | -------------------------------------------------------------- | ------------------------------------------ |
| 2.6-INT-005    | Integration | P0       | `docker compose ps` stato servizi                              | Health di base per availability             |
| 2.6-INT-006    | Integration | P0       | API `/health` → 200 JSON via Traefik                           | Osservabilità e routing corretto            |
| 2.6-INT-007    | Integration | P0       | Celery worker ready nei log                                    | Asincronia operativa                        |
| 2.6-INT-008    | Integration | P0       | Redis `PING` e KEYS accesso                                    | Broker/kv operativo                         |
| 2.6-INT-009    | Integration | P1       | Network inspect bridge e connectivity api↔redis, worker↔redis  | Interservice networking                     |
| 2.6-INT-010    | Integration | P1       | Volume mounts e persistenza Redis                              | Durabilità dati                             |
| 2.6-INT-011    | Integration | P1       | Restart policy configurata                                     | Resilienza runtime                          |

Esecuzione: `scripts/validation/docker_health_check.py`; report `docs/reports/rag-infrastructure-health.md` (fonte story L60–L69, L183–L193; Dev Notes L911–L914).
### AC3: Database Integrity Audit

| ID             | Level       | Priority | Test                                                       | Justification                                 |
| -------------- | ----------- | -------- | ---------------------------------------------------------- | --------------------------------------------- |
| 2.6-INT-012    | Integration | P0       | Orphan documents (completed senza chunks)                  | Integrità dati                                |
| 2.6-INT-013    | Integration | P0       | Orphan chunks (embedding NULL)                             | Issue storico critico                         |
| 2.6-INT-014    | Integration | P0       | EXPLAIN ANALYZE su indice pgvector                         | Performance query similitudine                |
| 2.6-INT-015    | Integration | P1       | FK violations check                                        | Coerenza referenziale                         |
| 2.6-INT-016    | Integration | P1       | Table statistics (row counts, index usage)                 | Sanity quantitativa                           |

Esecuzione: `scripts/validation/database_integrity_audit.py`; report `docs/reports/rag-database-integrity.md` (fonte story L71–L79, L438–L467).
### AC4: Performance Benchmarks

| ID             | Level       | Priority | Test                                                                    | Justification                                   |
| -------------- | ----------- | -------- | ----------------------------------------------------------------------- | ------------------------------------------------ |
| 2.6-E2E-017    | E2E         | P0       | Ingestion 10 doc: p50/p95/p99, max, throughput                          | Benchmark end-to-end                            |
| 2.6-INT-018    | Integration | P0       | Embedding latency p50/p95 su 100 chunks (OpenAI)                        | Dipendenza esterna critica                      |
| 2.6-E2E-019    | E2E         | P0       | Semantic search latency p95 < 1s su 30 query                            | Requisito story AC4                             |
| 2.6-E2E-020    | E2E         | P0       | Chat latency p95 < 2s su 20 query                                       | Requisito story AC4                             |
| 2.6-INT-021    | Integration | P1       | Bottleneck identification per stage (extraction/class/embedding/index)  | Azioni mirate                                   |
| 2.6-INT-022    | Integration | P1       | Retry handling RateLimitError osservato                                 | Stabilità sotto carico                          |

Evidenze/Report: `docs/reports/rag-performance-benchmarks.md` (fonte story L84–L89; L85–L88).
### AC5: Security Posture Review

| ID             | Level       | Priority | Test                                                     | Justification                        |
| -------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------ |
| 2.6-INT-023    | Integration | P0       | JWT secret entropy e rotazione policy                    | Sicurezza accesso API                |
| 2.6-INT-024    | Integration | P0       | Rate limiting config per environment                     | Hardening prod                       |
| 2.6-INT-025    | Integration | P1       | Endpoint protetti vs pubblici (coverage)                 | Superficie d'attacco                 |
| 2.6-INT-026    | Integration | P1       | CORS policy production-safe                               | Prevenzione cross-origin             |
| 2.6-INT-027    | Integration | P1       | Secret exposure risk (git scan, logs sanitization)       | Data leakage prevention              |
| 2.6-INT-028    | Integration | P1       | OpenAI API key scope/limiti spesa                        | Controllo costi e abuso              |

Report: `docs/reports/rag-security-audit.md` (fonte story L91–L101).
### AC6: Deployment Checklist Production

| ID             | Level       | Priority | Test                                                      | Justification                           |
| -------------- | ----------- | -------- | --------------------------------------------------------- | --------------------------------------- |
| 2.6-E2E-029    | E2E         | P0       | Pre-deployment: backup DB, secrets rotation, image build  | Procedura operativa critica             |
| 2.6-E2E-030    | E2E         | P0       | Deployment: compose up, health check validation           | Verifica messa in produzione            |
| 2.6-E2E-031    | E2E         | P0       | Post-deploy: smoke tests, monitoring, rollback plan       | Stabilità post-release                  |
| 2.6-E2E-032    | E2E         | P1       | Rollback triggers: failed health checks, error rate       | Recovery rapido                         |
| 2.6-E2E-033    | E2E         | P1       | Contact matrix verificata                                 | Operatività incident response           |

Report: `docs/reports/rag-deployment-checklist.md` (fonte story L102–L111).
## Risk Coverage

- Copertura rischi da `docs/qa/assessments/2.6.1-risk-profile.md`:
  - DB-001/002/003/004: Scenari 2.6-INT-012..016, 2.6-E2E-029..031
  - RD-001/002/003: Scenari 2.6-INT-008, 2.6-INT-010, 2.6-INT-011
  - TR-001/002: Scenari 2.6-INT-006, 2.6-INT-009
  - OPS-001/002: Scenari 2.6-INT-011, 2.6-E2E-030

## Recommended Execution Order

1. P0 Integration: AC2 (health), AC3 (DB integrity), AC5 (security)
2. P0 E2E: AC4 (benchmarks), AC6 (deploy)
3. P1 Integration: restanti AC1/AC2/AC5
4. P2/Best effort: unit minime e smoke secondari

## Gate YAML Block (per quality gate)

test_design:
  scenarios_total: 31
  by_level:
    unit: 1
    integration: 19
    e2e: 11
  by_priority:
    p0: 15
    p1: 14
    p2: 2
  coverage_gaps: []

## Trace References

Test design matrix: `docs/qa/assessments/2.6-test-design-20251010.md`
P0 tests identified: 15
