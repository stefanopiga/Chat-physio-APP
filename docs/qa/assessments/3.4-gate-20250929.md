# QA Gate ‚Äî Story 3.4: Source Visualization & Feedback

## Executive Summary
- Decisione: GO
- Motivazione: tutti gli Acceptance Criteria risultano implementati con evidenze a codice e test.

## Verifica Acceptance Criteria

- AC1 ‚Äî Citazioni interattive
```69:79:apps/web/src/components/ChatMessagesList.tsx
<CitationBadge
  id={c.chunk_id}
  excerpt={c.excerpt}
  onClick={() =>
    setOpenCitation(
      openCitation === c.chunk_id ? null : c.chunk_id
    )
  }
/>
```
```11:17:apps/web/src/components/CitationBadge.tsx
<button
  type="button"
  aria-label={`Fonte ${id}`}
  aria-haspopup="dialog"
  title={excerpt || id}
  onClick={onClick}
```

- AC2 ‚Äî Popover con estratto e metadati
```35:49:apps/web/src/components/CitationPopover.tsx
<div
  ref={ref}
  role="tooltip"
  aria-live="polite"
  style={{
    position: "absolute",
    zIndex: 1000,
    background: "#fff",
    border: "1px solid #ccc",
    borderRadius: 6,
    padding: 8,
    boxShadow: "0 2px 8px rgba(0,0,0,0.15)",
    maxWidth: 320,
    pointerEvents: "none",
  }}
>
```
```51:55:apps/web/src/components/CitationPopover.tsx
  <div style={{ fontSize: 12, color: "#666", marginBottom: 4 }}>
    Documento: {documentId || "-"}{" "}
    {typeof position === "number" ? `(pos ${position})` : ""}
  </div>
  <div style={{ fontSize: 13 }}>{excerpt || "(nessun estratto)"}</div>
```

- AC3 ‚Äî Pulsanti di feedback visibili
```96:113:apps/web/src/components/ChatMessagesList.tsx
<FeedbackControls
  disabled={pendingFeedback === m.messageId}
  onUp={() =>
    handleVote(
      localStorage.getItem("chat.sessionId") || "",
      m.messageId!,
      "up"
    )
  }
  onDown={() =>
    handleVote(
      localStorage.getItem("chat.sessionId") || "",
      m.messageId!,
      "down"
    )
  }
/>
```
```11:24:apps/web/src/components/FeedbackControls.tsx
<button
  type="button"
  aria-label="Vota positivo"
  disabled={disabled}
  onClick={onUp}
  style={{
    border: "1px solid #bbb",
    background: "#fff",
    padding: "2px 6px",
    borderRadius: 4,
  }}
>
  üëç
</button>
```

- AC4 ‚Äî Invio feedback `{ sessionId, message_id, vote }`
```28:41:apps/web/src/components/ChatMessagesList.tsx
setPendingFeedback(messageId);
await new Promise((resolve) => setTimeout(resolve, 0));
await apiClient.sendFeedback(sessionId, messageId, vote);
setTimeout(() => setPendingFeedback(null), 200);
```
```85:93:apps/web/src/lib/apiClient.ts
async sendFeedback(
  sessionId: string,
  messageId: string,
  vote: "up" | "down"
) {
  const endpoint = `${API_BASE}/chat/messages/${messageId}/feedback`;
  const payload = { sessionId, vote };
  return this.post<typeof payload, { ok: boolean }>(endpoint, payload);
}
```
```716:726:apps/api/api/main.py
class FeedbackCreateRequest(BaseModel):
    sessionId: str
    vote: Literal["up", "down"]

class FeedbackCreateResponse(BaseModel):
    ok: bool

@app.post("/api/v1/chat/messages/{messageId}/feedback", response_model=FeedbackCreateResponse)
```

- AC5 ‚Äî Persistenza UI del voto selezionato
```25:41:apps/web/src/components/ChatMessagesList.tsx
const [pendingFeedback, setPendingFeedback] = useState<string | null>(null);
setPendingFeedback(messageId);
await new Promise((resolve) => setTimeout(resolve, 0));
await apiClient.sendFeedback(sessionId, messageId, vote);
setTimeout(() => setPendingFeedback(null), 200);
```

## Backend ‚Äî Citazioni arricchite per popover
```569:579:apps/api/api/main.py
class CitationItem(BaseModel):
    chunk_id: str
    document_id: str | None = None
    excerpt: str | None = None
    position: int | None = None

class ChatMessageCreateResponse(BaseModel):
    message_id: str
    answer: str | None = None
    citations: list[CitationItem] | None = None
```
```659:679:apps/api/api/main.py
enriched_citations: list[dict] = []
...
if ch:
    text = (ch.content or "").strip()
    if text:
        excerpt_value = text[:240]
    document_id_value = ch.document_id
enriched_citations.append({
    "chunk_id": cid,
    "document_id": document_id_value,
    "excerpt": excerpt_value,
    "position": None,
})
```
```704:708:apps/api/api/main.py
return ChatMessageCreateResponse(
    message_id=message_id,
    answer=answer_value,
    citations=[CitationItem(**c) for c in enriched_citations],
)
```

## Test E2E ‚Äî Evidenze
```78:85:apps/web/tests/story-3.4.spec.ts
await expect(page.getByRole("button", { name: /Fonte c1/ })).toBeVisible();
await expect(page.getByRole("button", { name: /Fonte c2/ })).toBeVisible();
await page.getByRole("button", { name: /Fonte c1/ }).click();
await expect(page.getByRole("tooltip")).toBeVisible();
await expect(page.getByText(/chunk1 contenuto/i)).toBeVisible();
```
```88:91:apps/web/tests/story-3.4.spec.ts
const up = page.getByRole("button", { name: "Vota positivo" });
await up.click();
await expect(up).toBeDisabled();
```

## Documentazione ‚Äî Stato e compliance
```3:3:docs/stories/3.4.source-visualization-and-feedback.md
**Status:** Implementato
```
```26:30:docs/stories/3.4.source-visualization-and-feedback.md
- Stato: GO ‚Äî prerequisiti backend completati.
- Completati:
  1. Endpoint `POST /api/v1/chat/messages/{messageId}/feedback` (body `{ sessionId, vote }`, risposta `{ ok }`).
  2. Risposta AG arricchita con citazioni per popover (`chunk_id`, `document_id`, `excerpt`, `position`).
```
