# Test Design: Story 2.12

Date: 2025-10-16
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 16
- Unit tests: 6 (38%)
- Integration tests: 7 (44%)
- E2E tests: 3 (18%)
- Priority distribution: P0: 6, P1: 7, P2: 3

## Test Scenarios by Acceptance Criteria

### AC1: Configurazione Centralizzata LLM

| ID            | Level       | Priority | Test                                                     | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------- |
| 2.12-UNIT-001 | unit        | P0       | Validator range temperature (0.0–2.0, None handling)     | Pure validation logic |
| 2.12-UNIT-002 | unit        | P1       | Default values: model=gpt-5-nano; temps (None, 1.0)      | Config defaults correctness |
| 2.12-INT-001  | integration | P0       | Settings DI exposes openai_model and temps via Depends   | DI contract between FastAPI and settings |

### AC2: Refactoring Chat Service

| ID            | Level       | Priority | Test                                                     | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------- |
| 2.12-UNIT-003 | unit        | P1       | _get_llm passes temperature only if not None             | Function branching logic |
| 2.12-INT-002  | integration | P0       | Chat service instantiates ChatOpenAI with settings model | Service-config integration |
| 2.12-INT-003  | integration | P1       | Env override OPENAI_MODEL reflected in chat service      | Env → settings → service path |
| 2.12-E2E-001  | e2e         | P1       | Chat endpoint responds OK using configured model         | Critical user journey |

### AC3: Refactoring Classifier

| ID            | Level       | Priority | Test                                                     | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------- |
| 2.12-UNIT-004 | unit        | P1       | Classifier _get_llm uses settings temperature=1.0        | Function correctness |
| 2.12-INT-004  | integration | P0       | Classifier uses model from settings                      | Service-config integration |
| 2.12-INT-005  | integration | P1       | Override OPENAI_TEMPERATURE_CLASSIFICATION=1.0 honored  | Env override correctness |
| 2.12-E2E-002  | e2e         | P2       | Classification flow works with configured params         | End-to-end sanity |

### AC4: Documentazione e Environment

| ID            | Level       | Priority | Test                                                     | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------- |
| 2.12-UNIT-005 | unit        | P2       | ENV_TEMPLATE contains new vars and comments              | Static content check |
| 2.12-INT-006  | integration | P1       | ENV overrides parsed correctly (whitespace, locale)      | Robust parsing |

### AC5: Testing e Validazione

| ID            | Level       | Priority | Test                                                     | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------- |
| 2.12-INT-007  | integration | P0       | Full app boot with missing/malformed OPENAI_* → safe fail| Prevent runtime breakages |
| 2.12-E2E-003  | e2e         | P1       | Smoke: chat + classifier workflows after refactor        | Regression on critical flows |
| 2.12-UNIT-006 | unit        | P2       | Logging excludes OPENAI_API_KEY                          | Security hygiene |

## Risk Coverage

- Mitigates TECH-001 with P0 integration boot tests and DI contract tests (2.12-INT-002, 2.12-INT-007)
- Mitigates OPS-001 via malformed/missing env tests (2.12-INT-007)
- Mitigates TECH-002 with None/temperature branching and defaults (2.12-UNIT-003, 2.12-UNIT-002)
- Mitigates PERF-001 with E2E smoke enabling later load baselines (2.12-E2E-001/003)
- Mitigates DATA-001 with classification temperature assertions (2.12-UNIT-004, 2.12-INT-005)
- Mitigates SEC-001 through logging hygiene checks (2.12-UNIT-006)

## Recommended Execution Order

1. P0 Unit: 2.12-UNIT-001
2. P0 Integration: 2.12-INT-002, 2.12-INT-007
3. P1 Integration: 2.12-INT-001, 003, 004, 005, 006
4. P1 E2E: 2.12-E2E-001
5. Remaining Unit/E2E P2

## Test Environment & Tooling

- Framework: pytest
- Mocks: monkeypatch for env; FastAPI dependency override for settings
- CI: run unit/integration on each push; E2E nightly or gated branch
- Data: no real OpenAI calls; mock ChatOpenAI init and capture parameters

## Definition of Done (Testing)

- All P0 tests passing in CI
- Gate can move from FAIL to CONCERNS post-mitigation
- Evidence: test logs showing configured model/temps used by services
