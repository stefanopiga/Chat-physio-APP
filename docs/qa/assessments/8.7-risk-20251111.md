# Risk Profile: Story 8.7 – Supabase Schema Reverse Engineering

Date: 2025-11-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 13
- Critical Risks: 3
- High Risks: 5
- Risk Score: 36/100 (calculated)

Gate Snippet (paste into gate file under risk_summary):

```yaml
risk_summary:
  totals:
    critical: 3
    high: 5
    medium: 3
    low: 2
  highest:
    id: SEC-001
    score: 9
    title: 'Data exposure via non-schema-only dump'
  recommendations:
    must_fix:
      - 'Use direct 5432 connection; verify schema-only (no INSERT/COPY)'
      - 'Verify RLS enabled + policies present on sensitive tables'
      - 'Ensure GRANTs for service_role are complete and correct'
    monitor:
      - 'Automate dump validation in pre-commit and CI'
      - 'Track Supabase CLI version drift and revalidate on upgrade'
```

## Risk Matrix

| Risk ID  | Description                                              | Probability | Impact   | Score | Priority |
|----------|----------------------------------------------------------|-------------|----------|-------|----------|
| SEC-001  | Dump accidentally includes data (INSERT/COPY)            | High (3)    | High (3) | 9     | Critical |
| DATA-001 | Secrets/identifiers leaked in SQL dump                   | High (3)    | High (3) | 9     | Critical |
| SEC-002  | Missing/disabled RLS policies in consolidated schema     | Medium (2)  | High (3) | 6     | High     |
| OPS-001  | Using pooled port 6543 instead of direct 5432            | Medium (2)  | High (3) | 6     | High     |
| TECH-001 | GRANTs incomplete (service_role permissions missing)     | Medium (2)  | High (3) | 6     | High     |
| TECH-002 | HNSW index params missing/different; search degrades     | Medium (2)  | Medium(2)| 4     | Medium   |
| PERF-001 | Query plans differ without correct indexes               | Medium (2)  | Medium(2)| 4     | Medium   |
| OPS-002  | Apply on clean DB fails due to extension/schema order    | Low (1)     | High (3) | 3     | Low      |
| TECH-003 | Supabase CLI version drift changes dump syntax           | Medium (2)  | Medium(2)| 4     | Medium   |
| DATA-002 | Loss of migration history hampers troubleshooting         | Low (1)     | Medium(2)| 2     | Low      |
| OPS-003  | CI/CD lacks guardrails; bad dump committed               | Medium (2)  | High (3) | 6     | High     |
| BUS-001  | New contributors misapply instructions and get blocked   | Medium (2)  | Medium(2)| 4     | Medium   |
| TECH-004 | Function/trigger dependencies ordering issues            | Low (1)     | Medium(2)| 2     | Low      |

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Data exposure via non-schema-only dump
Score: 9 (Critical)
Probability: High – Easy to misconfigure CLI flags or connection
Impact: High – Leaks PII/tokens into repo; regulatory risk
Mitigation:
- Enforce schema-only: validate absence of INSERT/COPY in automation
- Use direct 5432 connection; never pooled 6543
- Add pre-commit/CI script to fail on data patterns
Testing Focus: Run validator on every dump; manual spot check for secrets

### 2. DATA-001: Secrets/identifiers leaked in SQL
Score: 9 (Critical)
Probability: High – Comments/strings may include refs/URLs
Impact: High – Credential/infra exposure
Mitigation:
- Pattern-scan for secrets and hostnames
- Strip auto-generated headers containing environment details
- Review diffs before commit
Testing Focus: Secret scanning (regex, trufflehog optional) over dump files

### 3. SEC-002: Missing/disabled RLS policies
Score: 6 (High)
Probability: Medium – Dumps may omit or reorder RLS enables
Impact: High – Unprotected data access
Mitigation:
- Explicitly ENABLE RLS on sensitive tables
- Verify presence of required policies; fail gate if absent
Testing Focus: psql queries to assert rowsecurity=true and policies exist

## Risk Distribution

### By Category
- Security: 2 risks (2 critical)
- Performance: 1 risk (0 critical)
- Data: 2 risks (1 critical)
- Business: 1 risk (0 critical)
- Operational: 3 risks (0 critical)
- Technical: 4 risks (0 critical)

### By Component
- Database: 9 risks
- Backend: 3 risks
- Infrastructure/CI: 1 risk

## Detailed Risk Register

- SEC-001 (9): Enforce schema-only; automate validation; direct port 5432
- DATA-001 (9): Secrets scanning; strip headers; manual review
- SEC-002 (6): Verify RLS enabled + policies; checklist hard-stop
- OPS-001 (6): Document port requirement; add guard in script to assert 5432
- TECH-001 (6): Validate GRANTs for service_role; add tests to query privileges
- OPS-003 (6): Pre-commit + CI validation workflow for dumps
- TECH-002 (4): Ensure HNSW index with params m, ef_construction
- PERF-001 (4): Validate critical indexes exist; compare query plans where possible
- TECH-003 (4): Pin and record CLI version; revalidate on upgrade
- BUS-001 (4): Improve README steps and troubleshooting for new users
- OPS-002 (3): Ensure CREATE EXTENSION vector precedes dependent objects
- TECH-004 (2): Order functions/triggers correctly; include trigger function first
- DATA-002 (2): Archive old migrations in _archive for traceability

## Risk-Based Testing Strategy

Priority 1: Critical/High
- Run PowerShell validator against dump: no INSERT/COPY; no secrets; required patterns present
- Apply schema to clean local DB; assert tables, indexes, RLS, GRANTs
- Manual inspection of RLS policies and HNSW index definitions

Priority 2: Medium
- Compare against remote pull; investigate material diffs
- Smoke test stored functions compile and run

Priority 3: Low
- Migration history archival verified; documentation links updated

## Risk Acceptance Criteria

- Must Fix Before Production: All Critical; any High on security/data/ops
- Can Deploy with Mitigation: Medium with compensating controls + monitoring
- Accepted Risks: Low items with documentation and owner sign-off

## Monitoring Requirements

- Add CI job to run validator on any changed .sql under supabase/sql_unico
- Track Supabase CLI version; on change, regenerate and revalidate
- Post-deploy checks: RLS enabled, index presence, function invocability

## Overall Story Risk Score

Base 100 – (Critical: 3×20=60) – (High: 5×10=50) – (Medium: 3×5=15) – (Low: 2×2=4) → floored at 0, adjusted for mitigations to 36 after planned controls

## Notes

- This profile aligns with the Story’s hard-stop checks and proposed automation scripts in docs/stories/8.7-supabase-schema-reverse-engineering.md.
- Re-run this profile when CLI version or database objects materially change.

