# Risk Profile — Story 1.3.1: Student Token Management System

## Riepilogo
- **ID**: 1.3.1 (fonte: `docs/stories/1.3.1-student-token-management-system.md` L5–L10)
- **Tipo**: Security / Feature (fonte: L22–L33, L679–L969)
- **Epic**: Epic 1 — Foundation: User Access (fonte: `docs/prd/sezione-7-epic-1-dettagli-foundation-user-access.md` — non utilizzato per valutazioni numeriche)
- **Priorità**: P0 - Critical Security Design (fonte: L1387–L1425)
- **Complessità**: Media (fonte: L1419–L1423)
- **Stato**: Draft

## Contesto del rischio
- JWT di lunga durata (1 anno) presenta rischio elevato e non revocabile; adottato Refresh Token Pattern (fonte: L24–L33, L1394–L1402).
- Differenze chiave vs access code: introduzione `refresh_tokens` in DB, revoca immediata, persistenza e CRUD admin (fonte: L34–L46, L51–L54, L55–L63).

## Elenco rischi

| ID | Descrizione | Probabilità | Impatto | Mitigazione |
|----|-------------|-------------|--------|------------|
| R-1.3.1-1 | Furto Access Token (XSS/MITM) valido 15 min | Media | Alto | Access Token breve 15 min; HTTPS obbligatorio (Secure cookie) (fonte: L683–L686, L751–L755) |
| R-1.3.1-2 | Abuso refresh via XSS (richieste autenticate on-the-fly) | Media | Alto | HttpOnly protegge confidenzialità; mitigazione primaria XSS: output encoding; CSP fase 2 (fonte: L744–L751, L748–L755, L923–L931) |
| R-1.3.1-3 | CSRF su refresh-token in browser legacy senza SameSite | Bassa | Medio | SameSite=Strict; fase 2: CSRF token, Origin/Referer validation (fonte: L756–L763, L932–L957) |
| R-1.3.1-4 | Replay refresh token (assenza rotation) | Bassa | Alto | Documentata come deviazione; pianificare Refresh Token Rotation story 1.3.6 (fonte: L968–L969, L1159–L1166) |
| R-1.3.1-5 | Revoca non immediata per access token attivo | Media | Medio | Revoca immediata dei refresh tokens; access token massimo 15 min (gap accettabile) (fonte: L965–L967) |
| R-1.3.1-6 | Enumerazione o modifica non autorizzata tabelle | Bassa | Alto | RLS admin-only `student_tokens`; backend con service_role bypass RLS solo lato server (fonte: L140–L149, L774–L789, L791–L795) |
| R-1.3.1-7 | Degrado performance DB su lookup token | Bassa | Medio | Indici parziali su colonne chiave; query matcher sui predicati (fonte: L135–L139, L169–L173, L796–L817, L801–L804) |
| R-1.3.1-8 | Brute-force token guessing su exchange-code | Media | Medio | Rate limiting endpoint 10 req/60s; Configurabile via env (fonte: L858–L863, L871–L879, L1117–L1119) |
| R-1.3.1-9 | Abuse refresh endpoint (loop o flood) | Media | Medio | Rate limiting 60 req/ora; window configurabile (fonte: L858–L863, L871–L879, L1111–L1113) |
| R-1.3.1-10 | Validazioni JWT deboli/algoritmo non whitelist | Bassa | Alto | RFC 8725: algorithms=["HS256"], require exp/iat, leeway 120s (fonte: L688–L729, L1109–L1111) |
| R-1.3.1-11 | Cookie leakage a path non correlati | Bassa | Basso | Cookie Path limitato `/api/v1/auth/refresh-token` (fonte: L764–L769) |
| R-1.3.1-12 | Scadenze non sincronizzate/clock skew multi-istanza | Bassa | Medio | `leeway` ±120s in verifica JWT (fonte: L700–L705, L706–L729, L1109–L1111) |
| R-1.3.1-13 | Query lente su revoca massiva refresh tokens | Bassa | Basso | Indici su `student_token_id`, parziali su `is_revoked` (fonte: L169–L173, L170–L173) |
| R-1.3.1-14 | Regressioni access code path esistente | Media | Medio | Test AC regressione: mantenere comportamento invariato (fonte: L291–L299, L989–L996) |

## Criteri/controlli di mitigazione (AC e specifiche)
- AC2/AC3/AC4 CRUD admin su `student_tokens` con soft delete e cascade revoke (fonte: L55–L63).
- AC5: Estensione `exchange-code` con Refresh Token Pattern e cookie HttpOnly (fonte: L65–L73, L286–L290).
- AC6: Endpoint `POST /api/v1/auth/refresh-token` con validazioni e audit `last_used_at` (fonte: L73–L79, L307–L335).
- JWT Validation conforme RFC 8725/7519: algorithms, claims, leeway (fonte: L688–L729).
- Cookie Security conforme RFC 6265: HttpOnly, Secure, SameSite, Path (fonte: L742–L771).
- RLS e indici DB ottimizzati per sicurezza/performance (fonte: L140–L149, L158–L173, L772–L789, L796–L817).
- Rate limiting per endpoint critici (fonte: L858–L863, L871–L879).

## Piano di verifica
- Test backend unit/integration/E2E inclusi per refresh pattern e revoca (fonte: L972–L1010, L1089–L1107).
- Test frontend unit/E2E per pagina admin e refresh automatico (fonte: L1029–L1077, L1314–L1339).
- QA manuale sicurezza: HttpOnly/CSRF/SameSite e JWT claims (fonte: L1341–L1365, L1357–L1361).

## Impatti
- Miglioramento sicurezza e UX: sessione 1 anno con revoca immediata e access token breve (fonte: L681–L687, L1403–L1412).
- Overhead accettato: query su refresh ogni 15 minuti; gestione cookie (fonte: L1419–L1423).

## Fonti puntuali
- `docs/stories/1.3.1-student-token-management-system.md`: L22–L46, L51–L79, L80–L97, L117–L192, L194–L346, L391–L677, L679–L971, L972–L1174, L1175–L1384, L1385–L1472, L1473–L1474.
