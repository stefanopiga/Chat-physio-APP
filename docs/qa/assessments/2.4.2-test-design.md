# Test Design — Story 2.4.2: Implementazione Gestione Errori Pipeline di Ingestione

## Obiettivi e Scope
- Verificare l'implementazione dei pattern di gestione errori in `indexer.py` secondo `addendum-external-services-error-handling.md`.
- Validare i criteri di accettazione AC1–AC4 definiti in `docs/stories/2.4.2-error-handling-ingestion-pipeline.md`.
- Confermare l'eliminazione del fallimento silenzioso (HTTP 200 con `"inserted": 0`).

## Tracciabilità Requisiti
- AC1: OpenAI `AuthenticationError` → HTTP 500 + log (fonte: Story L130–L148)
- AC2: OpenAI `APIConnectionError` → HTTP 500 + log (fonte: Story L150–L156)
- AC3: Supabase insert failure → HTTP 500 + log specifico (fonte: Story L158–L169)
- AC4: Success path → `inserted > 0` + log success (fonte: Story L171–L185)

## Ambiente di Test
- Servizi: API container `fisio-rag-api` in esecuzione
- Endpoint: `POST /api/v1/admin/knowledge-base/sync-jobs`
- Autenticazione: token admin valido (`Authorization: Bearer <ADMIN_JWT>`)
- Variabili richieste: `OPENAI_API_KEY`, `SUPABASE_URL`, `SUPABASE_SERVICE_KEY`

## Dati di Test
- `document_text_minimo`: "Anatomia Funzionale della Colonna Cervicale..."
- `metadata_base`: `{ "document_name": "td_242_min.txt" }`

## Precondizioni
1. Logging API attivo con livello >= INFO.
2. `OPENAI_API_KEY` valida disponibile e salvata per ripristino.
3. Accesso ai log del container (`docker logs fisio-rag-api`).
## Casi di Test

### TC1 — OpenAI API key invalida → HTTP 500 + log AuthenticationError
- Preconditions: impostare `OPENAI_API_KEY=sk-invalid-test-key` nel container
- Steps:
  1. `docker-compose restart api`
  2. Eseguire richiesta:
     ```bash
     curl -X POST http://localhost:8000/api/v1/admin/knowledge-base/sync-jobs \
       -H "Authorization: Bearer $ADMIN_JWT" \
       -H "Content-Type: application/json" \
       -d '{"document_text":"Test", "metadata": {"document_name":"td_tc1.txt"}}'
     ```
  3. `docker logs fisio-rag-api | grep AuthenticationError`
- Expected:
  - Status HTTP: 500
  - Log contiene `openai.AuthenticationError`

### TC2 — OpenAI non raggiungibile → HTTP 500 + log APIConnectionError
- Preconditions: simulare disconnessione rete per il container (o hostname OpenAI non risolvibile)
- Steps:
  1. Applicare regola di firewall o disabilitare rete del container
  2. Eseguire la richiesta come in TC1 con `document_name=td_tc2.txt`
  3. Verificare log: `docker logs fisio-rag-api | grep APIConnectionError`
- Expected:
  - Status HTTP: 500
  - Log contiene `openai.APIConnectionError`

### TC3 — Supabase insert failure → HTTP 500 + log specifico
- Preconditions: configurare condizione di fallimento (es. RLS restrittiva su `document_chunks` o tabella schema non allineato)
- Steps:
  1. Eseguire la richiesta come in TC1 con `document_name=td_tc3.txt`
  2. Verificare log: `docker logs fisio-rag-api | grep "Error inserting: No rows added"`
- Expected:
  - Status HTTP: 500
  - Log contiene stringa `Error inserting: No rows added` o messaggio equivalente definito da addendum

### TC4 — Success path → inserted > 0 + log success
- Preconditions: configurazione corretta (`OPENAI_API_KEY` valida, Supabase operativo)
- Steps:
  1. Ripristinare `.env` corretto e `docker-compose restart api`
  2. Eseguire richiesta con `document_text_minimo`, `metadata_base(document_name=td_tc4.txt)`
  3. Verificare response e log
- Expected:
  - Status HTTP: 200
  - Body: `{"inserted": N}`, con `N > 0`
  - Log: contiene `Inseriti N chunks con successo`

### TC5 — No chunks → early return 0
- Preconditions: input vuoto o whitespace-only
- Steps:
  1. Eseguire richiesta con `document_text: "   "`
- Expected:
  - Status HTTP: 400 (validazione endpoint già in `main.py`)

## Metriche di Uscita
- 4/4 casi critici (TC1–TC4) conformi
- Nessun errore silente (assenza di HTTP 200 con `inserted: 0` nei percorsi d’errore)
- Log contengono tipo eccezione e messaggio comprensibile

## Attività Post-Test
- Ripristinare `.env` con chiave OpenAI valida
- Annotare evidenze (response, estratti log) nella sezione QA della PR
- Aggiornare `INVESTIGATION_CHUNKING_ZERO_RESULTS.md` a "RESOLVED"
