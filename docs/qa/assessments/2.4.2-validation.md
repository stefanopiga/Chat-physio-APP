# Validation — Story 2.4.2: Implementazione Gestione Errori Pipeline di Ingestione

## Esito
- **Validazione esito**: READY FOR REVIEW
- **Scope**: Limitato a `apps/api/api/knowledge_base/indexer.py` (fonte: Story L193, L451)
- **Vincoli**: Aderenza stretta a `addendum-external-services-error-handling.md` senza personalizzazioni (fonte: Story L332)

## Allineamento Requisiti ↔️ Fonti
- **Obiettivo**: Eliminare fallimento silenzioso e propagare errori OpenAI/Supabase (fonte: Story L18–L23, L30–L33)
- **Pattern da implementare**: Sezione 2.3 (OpenAI) e 3.4 (Supabase) dell'addendum (fonte: Story L328–L331)
- **File interessato**: `indexer.py` con gestione errori in `_get_embeddings_model()` e `add_texts()` (fonte: Story L206–L244, L269–L326)

## Acceptance Criteria (AC) — Verificabilità
- **AC1**: `OPENAI_API_KEY` invalida → HTTP 500 + log `openai.AuthenticationError` (fonte: Story L130–L148)
- **AC2**: OpenAI non raggiungibile → HTTP 500 + log `openai.APIConnectionError` (fonte: Story L150–L156)
- **AC3**: Supabase insert failure → HTTP 500 + log specifico `"Error inserting: No rows added"` (fonte: Story L158–L169)
- **AC4**: Configurazione corretta → `inserted > 0` + log success (fonte: Story L171–L185)

Tutti gli AC sono misurabili e hanno passi di verifica definiti (fonte: Story L136–L148, L150–L156, L164–L169, L177–L185).

## Coerenza con Addendum
- OpenAI: gestione `AuthenticationError`, `APIConnectionError`, `RateLimitError`, `APIStatusError` con log e re-raise (fonte: Addendum §2.3, righe 130–201; Story L79–L93, L206–L244)
- Supabase: verifica `len(ids) > 0` e gestione messaggio `Error inserting: No rows added` (fonte: Addendum §3.4, righe 290–388; Story L269–L326)

## Rischi e Breakings (dichiarati/accettati)
- **HTTP 500** al posto di 200 su errori esterni (breaking change) — accettato e documentato negli AC (fonte: Story L130–L148, L158–L169)
- **Testing manuale** per error paths — previsto in Test Design (fonte: `docs/qa/assessments/2.4.2-test-design.md`)

## Dipendenze e Precondizioni
- `OPENAI_API_KEY`, `SUPABASE_URL`, `SUPABASE_SERVICE_KEY` presenti in ambiente (fonte: Story L338–L343)
- Logging API attivo ≥ INFO (fonte: Test Design)

## Note per la Review
- Vedi `docs/qa/assessments/2.4.2-coverage-nfr-gaps-20251006.md` per copertura e gaps NFR.
- Vedi `docs/qa/assessments/2.4.2-nfr-assessment.md` e `docs/qa/assessments/2.4.2-trace-20251006.md` per mapping completo AC↔Implementazione↔Evidenze.

## Decisione
- La story è allineata agli standard e pronta per la review formale.
