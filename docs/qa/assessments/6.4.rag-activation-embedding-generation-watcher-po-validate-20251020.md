# PO Story Draft Validation — Story 6.4: RAG Activation — Embedding Generation for Watcher Pipeline

Data: 2025-10-20
Riferimento Story: docs/stories/6.4.rag-activation-embedding-generation-watcher.md
Stato Story: Draft
Priorità: P0 (critico)

## 1) Sintesi Valutazione
- Scopo chiaro: attivare embeddings per sbloccare la chat RAG.
- AC definiti (AC1–AC4) con dettagli tecnici; AC2.5 introduce requisito architetturale critico (advisory locks) per sicurezza concorrenza.
- Dipendenze e contesto solidi (riuso index_chunks, integrazione con watcher post 6.3).
- Stato: Bozza — richiede alcune conferme e piccoli affinamenti prima di marcare "Ready for Dev".

Decisione: CONCERNS (correggere/integrare punti sotto, poi OK)

## 2) Completezza & Chiarezza (Checklist sintetica)
- Obiettivo utente e valore: CHIARO
- Confini/MVP: CHIARI (Opzione A sync, B async opzionale)
- AC SMART (testabili/misurabili): QUASI COMPLETI (vedi note su metriche/costi)
- Rischi evidenziati: SÌ (AC2.5, duplicati, rate limit)
- Dipendenze esplicite: PARZIALI (vedi sezione 3)
- Testabilità: BUONA (verifiche AC3, endpoint AC4)
- Osservabilità: BUONA (endpoint health + log strutturati)
- Stima/effort: INDICATIVO (presente in SCP 6.4 AC2.5), ok per P0

## 3) Dipendenze/Prerequisiti
- Servizi: OpenAI Embeddings, Supabase (Vector Store), Postgres (funzioni advisory locks hashtext).
- Config/Env: chiavi OpenAI/Supabase, connessione DB; feature flag WATCHER_CELERY_INDEXING (default false per MVP).
- Codice riusato: pps/api/api/knowledge_base/indexer.py::index_chunks.
- Runner: watcher (pps/api/scripts/watcher_runner.py) e batch scripts/admin/generate_missing_embeddings.py.

Azioni PO: confermare disponibilità/limiti costi OpenAI per run iniziale (~190 chunk), eventuale finestra oraria.

## 4) Coerenza con Architettura
- Allineato a Pattern 6 (asyncpg + advisory locks). Riferimenti espliciti in AC2.5.
- Correzione AC2.5 elimina incoerenze (row locks vs advisory) — approvata in SCP.

## 5) Qualità degli Acceptance Criteria
- AC1: chiaro, testabile, include log/metriche. OK.
- AC2: chiaro, degradazione controllata con logging. OK.
- AC2.5: dettagliato (lock acquire/try, chiavi stabili via hashtext, test concorrenza). OK.
- AC3: query e oracoli funzionali (chat/search) misurabili. OK.
- AC4: schema di risposta previsto per health — OK; suggerita aggiunta campo openai_calls_total opzionale.

## 6) Rischi & Mitigazioni (PO View)
- Duplicati/Corruzione: mitigato da AC2.5 + idempotenza. Critico ma sotto controllo.
- Costi/Rate limit: mitigazione prevista (batching/backoff). Richiesta visibilità su costo/chunk (non bloccante).
- Regressioni performance watcher: mitigato tenendo indexing fuori transazione; monitorare latenza.

## 7) Gap/Correzioni Richieste
1) Esplicitare limiti operativi per batch iniziale: batch size e QPS target (es. 64/chunk, 2 QPS) — non bloccante.
2) Confermare formato finale endpoint AC4 (campi minimi obbligatori + eventuali opzionali: costo stimato, openai_calls_total) — non bloccante.
3) Notare prerequisito DB: estensioni/permessi necessari per advisory locks (verificare in migrazioni) — bloccante se mancanti.
4) Verificare che index_chunks ritorni conteggio inseriti per logging coerente in watcher/batch — se no, adattare log. 

## 8) Raccomandazioni PO
- Ordine esecuzione: implementare AC2.5 prima, poi AC1 (batch) e AC2 (watcher), infine AC3–AC4.
- Programmare finestra di esecuzione batch iniziale e attivare dashboard minima con copertura embedding.

## 9) Decisione PO (Advisory)
- Gate: CONCERNS
- Condizioni per passaggio a "Ready for Dev":
  - [ ] Verifica prerequisito advisory locks in ambiente (DB/migrazioni/permessi).
  - [ ] Chiarire batch size e QPS di default per AC1 in story (nota operativa).
  - [ ] Confermare/aggiornare risposta AC4 (campi minimi e opzionali, se aggiunti).

## 10) Riferimenti
- docs/stories/6.4.rag-activation-embedding-generation-watcher.md
- docs/stories/SPRINT_CHANGE_PROPOSAL_6.4_AC2.5.md
- docs/architecture/addendum-asyncpg-database-pattern.md
- apps/api/api/knowledge_base/indexer.py
