# Test Design — Story 4.4: Document Chunk Explorer

## Riferimenti
- Fonte primaria: `docs/stories/4.4-document-chunk-explorer.md`

---

## Acceptance Criteria (da fonte)
1. Document List View con colonne richieste — Source: 4.4 L52-L53
2. Chunk Explorer View con navigazione — Source: 4.4 L54-L55
3. Chunk Display con preview, size, metadata, status — Source: 4.4 L56-L62
4. Chunk Expansion (dialog/accordion) — Source: 4.4 L63-L64
5. Filtering: strategy, size range — Source: 4.4 L65-L68
6. Sorting: sequence, size, creation date — Source: 4.4 L69-L73
7. Empty State — Source: 4.4 L74-L75
8. Responsive Design — Source: 4.4 L76-L77
9. Performance: < 500ms a 200 chunk — Source: 4.4 L78-L79
10. Access Control: AdminGuard — Source: 4.4 L80-L81

---

## Gating / Prerequisiti (bloccanti)
- Backend: `asyncpg` installato e configurato — Source: 4.4 L122-L127, L533
- DB: `documents` e `document_chunks` esistono; metadata `chunking_strategy`, `page_number` presenti — Source: 4.4 L637-L639
- Frontend: Shadcn/UI Select installato; Dialog disponibile — Source: 4.4 L529-L531, L662-L663

---

## Obiettivi di Test
- Backend unit tests: 6 test — Source: 4.4 L573-L579
- Frontend unit tests: 8 test — Source: 4.4 L589-L597
- E2E tests: 6 scenari — Source: 4.4 L607-L613
- Coverage backend ≥85% — Source: 4.4 L581
- Coverage frontend ≥90% — Source: 4.4 L599
- E2E duration target < 30s totali — Source: 4.4 L615

---

## Backend Test Design
- Test file: `apps/api/tests/test_document_explorer.py` — Source: 4.4 L571

### API — GET /api/v1/admin/documents (6 test)
1) 200 OK con lista documenti, model conforme — Source: 4.4 L136-L148, L157-L189
2) 403 Forbidden per non-admin — Source: 4.4 L80-L81 (Access Control)
3) Aggregazione `chunk_count` corretta — Source: 4.4 L164-L168, L176-L178
4) Strategia predominante calcolata con MODE() — Source: 4.4 L165, L175
5) Ordine per `created_at DESC` rispettato — Source: 4.4 L179
6) Documenti senza chunk inclusi (LEFT JOIN) — Source: 4.4 L167, L193

### API — GET /api/v1/admin/documents/{id}/chunks (8 test)
1) 200 OK con chunk list e campi: id, content, size, index, strategy, page, status, created_at — Source: 4.4 L274-L283
2) Filter `strategy` applicato — Source: 4.4 L291-L295
3) Filter `min_size` applicato — Source: 4.4 L296-L301
4) Sort per `chunk_index` default — Source: 4.4 L207-L208, L303
5) Sort per `created_at` — Source: 4.4 L207-L208, L303
6) Pagination `limit/offset` — Source: 4.4 L208-L209, L304-L306
7) Total count corretto senza paginazione — Source: 4.4 L310-L313
8) `embedding_status` derivato da `embedding` — Source: 4.4 L281

---

## Frontend Test Design
- Test file: `apps/web/src/pages/__tests__/DocumentsPage.test.tsx` — Source: 4.4 L587

### DocumentsPage (8 test)
1) Rendering tabella con colonne richieste — Source: 4.4 L352-L375
2) Navigazione a chunks page al click — Source: 4.4 L384-L388, L400
3) Empty state quando zero documenti — Source: 4.4 L74-L75
4) Loading skeleton durante fetch — Source: 4.4 L678 (Acceptance: unit tests pass; pattern implicito)
5) Error state con messaggio — Source: 4.4 L674-L676 (fetch + error handling)
6) Badge strategia chunking render corretto — Source: 4.4 L382-L383
7) Sort per colonna tabella (quando implementato) — Source: 4.4 L69-L73
8) Filter dropdown strategy — Source: 4.4 L65-L68

### DocumentChunksPage (8 test)
1) Rendering lista chunk con preview/metadata/status — Source: 4.4 L466-L474, L478-L482
2) Dialog “Mostra contenuto completo” apre contenuto — Source: 4.4 L483-L495
3) Select filtro `strategy` aggiorna lista — Source: 4.4 L431-L443
4) Select `Sort By` aggiorna ordinamento — Source: 4.4 L445-L455
5) Icona/badge embedding_status coerente — Source: 4.4 L472-L474
6) Page number mostrato se presente — Source: 4.4 L469-L471
7) Empty state quando zero chunk — Source: 4.4 L74-L75
8) Responsive layout non degrada (snapshot classes) — Source: 4.4 L423, L458-L461

---

## E2E Test Design — Playwright (6 scenari)
- Test file: `apps/web/tests/story-4.4.spec.ts` — Source: 4.4 L605
1) Admin login → /admin/documents visibile — Source: 4.4 L608-L609
2) Click documento → /chunks render — Source: 4.4 L609-L610
3) Dialog contenuto completo — Source: 4.4 L610-L611
4) Filter per strategy — Source: 4.4 L611-L612
5) Sort per size — Source: 4.4 L612-L613
6) Non-admin redirect — Source: 4.4 L613-L614

---

## Performance & Access Control
- Performance target: lista chunk < 500ms per 200 chunk — Source: 4.4 L78-L79, L695
- Access Control: Admin-only — Source: 4.4 L80-L81
