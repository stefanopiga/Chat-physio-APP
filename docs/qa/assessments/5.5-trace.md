# Trace — Story 5.5: Final Test Suite Cleanup

Stato: COMPLETATA (fonte: docs/stories/5.5-final-test-suite-cleanup.md L3)
ID: 5.5 (fonte: L6)
Tipo: Technical Debt / Bugfix / Testing (fonte: L7)
Epic: Epic 5 — DevOps & Maintainability (fonte: L8)
Priorità: P1 - High (fonte: L9)
Complessità: Medium-High (fonte: L10)
Stima sforzo: 8-12 ore (fonte: L11)

## Obiettivi e Business Value
- Obiettivo: risolvere 4 test failures residui per raggiungere pass rate 100% e CI/CD production-ready (fonte: L19-L23)
- Business Value: completamento test suite, zero failures, performance ottimizzata, endpoint mancanti implementati, conformità API (fonte: L23)

## Stato Iniziale (post 5.4.3)
- Total tests: 204 (fonte: L33)
- Passed: 176 (86.3%) (fonte: L34)
- Failed: 4 (2.0%) (fonte: L35)
- Errors: 0 (0%) (fonte: L36)
- Skipped: 24 (11.8%) (fonte: L37)
- Pass Rate: 86.3% (fonte: L38)
- Target: 100% (fonte: L39)
- Gap: -13.7pp (fonte: L40)
- Failure distribution: dettagli in elenco (fonte: L45-L50)

## Analisi Problemi e Fix Pianificati
1) Feedback Endpoint Validation (fonte: L60-L86, L88-L115, L117-L122)
   - Errore: HTTP 422 per campo `feedback_id` richiesto nel body (fonte: L76-L85)
   - Root cause: `feedback_id` erroneamente required nello schema (fonte: L91-L96)
   - Fix: rimozione `feedback_id` dal request model; mantenere in response; rating bounds (fonte: L101-L115)
   - AC: payload senza `feedback_id`, DB genera UUID, response include `feedback_id`, 201 Created (fonte: L117-L121)

2) Document Chunks Query Sort (fonte: L125-L141, L142-L151, L152-L176)
   - Errore: ORDER BY senza alias tabella (fonte: L136-L140)
   - Root cause: query costruita con `ORDER BY chunk_size DESC` (fonte: L148-L150)
   - Fix: usare alias `c.chunk_size` o adeguare test ad asserire l'ordinamento sui risultati (fonte: L154-L166)
   - AC: alias consistente e verifica sull’ordinamento (fonte: L173-L176)

3) Semantic Search Performance (fonte: L180-L193, L196-L279, L281-L293)
   - Stato: p95 5716ms su 30 richieste, atteso <500ms (fonte: L187-L192)
   - Cause: latenza embedding, query vector non ottimizzata, no pooling (fonte: L196-L226)
   - Fix: caching embedding, indice HNSW, connection pooling (fonte: L228-L279)
   - Target aggiornato realistico: p95 < 1000ms (fonte: L281-L287)
   - AC: p95 ≤ 1000ms, caching, HNSW, pooling (fonte: L288-L293)

4) Chat Endpoint Missing (fonte: L296-L321, L323-L350, L351-L360, L362-L414)
   - Errore: 404 su POST /api/v1/chat (fonte: L309-L320)
   - Root cause: endpoint non implementato o non registrato o path mismatch (fonte: L325-L349)
   - Fix: implementare `api/routers/chat.py` e includere in `main.py` (fonte: L362-L414)
   - AC: 200 OK con risposta RAG (fonte: L416-L421)

## Desired State
- Pass Rate: 100% su 180/180 attivi, Errors 0, API 100% implementati, p95 <1000ms, Coverage ≥93%, Duration <600s, CI/CD green (fonte: L426-L436)

## Esiti Implementazione
- Files modificati: elenco in Implementation Notes (fonte: L995-L1003)
- Files non modificati: elenco out-of-scope (fonte: L1004-L1008)
- Completion Date: 2025-10-09 (fonte: L1011)
- Implementation Time: ~3 ore (fonte: L1012)
- Test Results: 179/204 PASSED (87.7%), 0 FAILED, 22 SKIPPED, Coverage 93% (fonte: L1013)

## Statistiche Finali Post-Implementation
- Total Tests: 201 (fonte: L1021)
- PASSED: 179 (89.1%) (fonte: L1022)
- FAILED: 0 (0%) (fonte: L1023)
- ERRORS: 0 (0%) con nota teardown (fonte: L1024)
- SKIPPED: 22 (10.9%) (fonte: L1025)
- Pass Rate attivi: 100% (179/179) (fonte: L1026)
- Coverage: 93% (fonte: L1027)
- Duration: 454s (fonte: L1028)

## Confronto con 5.4.3
- Before: 176/204 PASSED (86.3%), 4 FAILED, 3 obsoleti (fonte: L1033)
- After: 179/201 PASSED (89.1%), 0 FAILED, 0 obsoleti (fonte: L1034)
- Improvement: +3 passed, -4 failures, -3 obsoleti (fonte: L1035)

## Test Risolti e Skipped
- Failures risolti: feedback, chunks sort, chat endpoint (fonte: L1039-L1042)
- Skipped: 22, con motivazioni e lista file per categorie (fonte: L1043-L1152)

## Tracciabilità Requisiti → Implementazione → Evidenze
- AC1 Feedback Endpoint → schema ed endpoint aggiornati (fonte: L516-L536, L538-L562) → test passed 1/1 (fonte: L564-L568)
- AC2 Document Chunks Sort → query alias e/o assert risultati (fonte: L580-L607, L609-L623) → test passed 1/1 (fonte: L625-L629)
- AC3 Performance p95 ≤1000ms → threshold aggiornato, caching/HNSW/pooling previsti (fonte: L702-L718, L947-L951) → evidenza non disponibile sul p95 attuale
- AC4 Chat Endpoint → implementazione e registrazione (fonte: L737-L818) → test e2e atteso pass, evidenza singolo test indicata (fonte: L820-L824)

## Note di Tracciamento Mancanze Evidenze
- Misure p95 aggiornate dopo modifiche: non disponibile in source (fonte: L951)
- 5 run consecutivi (flakiness=0): non disponibile in source (fonte: L485)
- OpenAPI completezza: non disponibile in source (fonte: L497)
