# Risk Profile — Story 4.2.2: Analytics Dashboard - Metriche Avanzate

Metadata
- Story ID: 4.2.2
- Status at assessment: Approved
- Assessment date: 2025-10-29 (UTC)
- Scope: Advanced analytics metrics, temporal distribution, quality metrics, problematic queries, engagement stats, chunk retrieval, CSV export, time filters, performance/UX constraints, backward compatibility

## Summary
- Overall risk posture: Medium-High
- Highest categories: DATA, SEC, PERF
- Gate guidance: CONCERNS (due to multiple High risks; no Critical if mitigations implemented before release)

## Risk Matrix

| Risk ID  | Description                                                                 | Prob. | Impact | Score | Priority |
|----------|------------------------------------------------------------------------------|-------|--------|-------|----------|
| DATA-001 | CSV export may leak sensitive/PII or reversible identifiers                 | 2     | 3      | 6     | High     |
| SEC-001  | Weak hashing or improper salt handling for session_id/query anonymization   | 2     | 3      | 6     | High     |
| PERF-001 | Aggregations over 30-day window exceed p95 800ms on 5k queries              | 2     | 2      | 4     | Medium   |
| TECH-001 | Temporal bucketing and filters produce inconsistent UTC windows             | 2     | 2      | 4     | Medium   |
| DATA-002 | Chunk metadata exposure (document_id mapping enables deanonymization)       | 2     | 2      | 4     | Medium   |
| SEC-002  | Insufficient authorization on analytics endpoints/export                    | 1     | 3      | 3     | Low      |
| OPS-001  | Missing monitoring for export usage and performance regressions             | 2     | 2      | 4     | Medium   |
| BUS-001  | Metrics misinterpreted due to unclear definitions (e.g., median buckets)    | 2     | 2      | 4     | Medium   |
| TECH-002 | In-memory volatility leads to inconsistent results across refreshes         | 2     | 1      | 2     | Low      |
| DATA-003 | Query text retained in clear when anonymization expected by stakeholders    | 1     | 2      | 2     | Low      |

Legend: Probability 1=Low, 2=Medium, 3=High. Impact 1=Low, 2=Medium, 3=High.

## Detailed Risk Register

### DATA-001 — CSV export may leak sensitive/PII or reversible identifiers (Score 6 High)
- Category: Data
- Description: CSV export includes `query_text` or `query_hash`, `session_id_hashed`. Risk of indirect PII or linkage attacks if salt reused or stored insecurely; potential exfiltration via broad column set or mis-scoped access.
- Affected components: Export service, `Settings.analytics_export_salt`, access control, storage of generated CSV.
- Detection method: Spec review; data modeling and privacy analysis.
- Mitigations:
  - Enforce default anonymization: `Settings.analytics_anonymize_queries=true` in production; export `query_hash` not raw `query_text` unless explicit admin override with audit.
  - Use per-environment, rotated, high-entropy salt; store in secret manager; never commit to VCS.
  - Add allowlist enforcement in code with unit tests verifying exact CSV columns/order.
  - Add role-based authorization (admin-only) and short-lived signed download URLs.
  - Add DLP check to prevent unexpected fields; reject if columns deviate.
- Residual risk: Medium.

### SEC-001 — Weak hashing or improper salt handling (Score 6 High)
- Category: Security
- Description: SHA256+salt is specified; risks include low-entropy salt, shared salt across tenants, logging of unhashed identifiers, or missing HMAC-style construction.
- Affected: Hashing utility, config loader, logging pipeline.
- Mitigations:
  - Enforce minimum salt length (>=32 bytes) and randomness; prefer HMAC-SHA256 with secret key from secret store.
  - Prohibit logging of raw session IDs or unhashed query text when anonymization is enabled.
  - Secrets scanning in CI; rotate on incident.
- Residual risk: Medium.

### PERF-001 — Aggregations exceed p95 800ms on 5k queries (Score 4 Medium)
- Category: Performance
- Description: Temporal distribution and top-chunks require multi-pass aggregations; risk increases with larger datasets.
- Affected: Aggregation functions (`aggregate_temporal_distribution`, `aggregate_quality_metrics`, `aggregate_problematic_queries`, `top_chunks`).
- Mitigations:
  - Pre-aggregate with indexed structures; memoize per `time_filter` for request scope.
  - Cap window to 30 days strictly; return 413/validation error otherwise.
  - Add performance tests with synthetic datasets; optimize hot paths; avoid Python-level per-message loops where vectorization is available.
- Residual risk: Low-Medium.

### TECH-001 — UTC windowing inconsistencies (Score 4 Medium)
- Category: Technical
- Description: Incorrect cutoff calculations or local-time parsing could skew buckets.
- Mitigations:
  - Enforce ISO 8601 UTC parsing; unit tests for boundary hours and daylight transitions.
  - Centralize `_get_time_cutoff(time_filter)` with clear inclusive window semantics; document in API.
- Residual risk: Low.

### DATA-002 — Chunk metadata exposure enables deanonymization (Score 4 Medium)
- Category: Data
- Description: Showing top chunks with `document_id` could allow linking to sensitive content frequency.
- Mitigations:
  - Display only opaque `document_id` without content; restrict to admin role; optionally aggregate at document category level.
  - Add minimum threshold (k-anonymity style) before listing (e.g., do not show items with <3 occurrences).
- Residual risk: Low-Medium.

### SEC-002 — Insufficient authorization on analytics endpoints/export (Score 3 Low)
- Category: Security
- Mitigations: Enforce RBAC checks; add integration tests ensuring non-admins receive 403; ensure CSRF protection for export triggers if applicable.
- Residual risk: Low.

### OPS-001 — Missing monitoring for export usage and performance (Score 4 Medium)
- Category: Operational
- Mitigations: Emit metrics for export requests, size, duration, errors; alert on spikes. Add audit logs with requester identity and parameters.
- Residual risk: Low.

### BUS-001 — Misinterpretation of metrics (Score 4 Medium)
- Category: Business
- Mitigations: Provide precise metric definitions and labels (UTC, 2h slots, medians). Add tooltips and documentation page.
- Residual risk: Low.

### TECH-002 — In-memory volatility (Score 2 Low)
- Category: Technical
- Mitigations: Document constraint; surface banner that long-range filters are limited until persistence story; add cache warming to reduce variability.
- Residual risk: Low.

### DATA-003 — Clear query text retained unexpectedly (Score 2 Low)
- Category: Data
- Mitigations: Default to anonymized export; add explicit toggle UI and server validation; show confirmation when exporting clear text.
- Residual risk: Low.

## Component Risk Summary
- Frontend/UI: Medium (mislabeling, export UX leading to misuse)
- Backend/API: Medium-High (data handling, auth, hashing, performance)
- Data Layer: Medium (chunk/document linkage, aggregation correctness)
- Infrastructure/Secrets: Medium (salt storage, rotation)

## Risk-Based Testing Strategy

Priority 1 — High risks
- Security
  - Verify HMAC-SHA256 hashing with secret from secret manager; unit tests for deterministic outputs given key+input; ensure non-reversible without secret.
  - Authorization tests: non-admin access to analytics and export returns 403; admin success paths audited.
  - Secrets handling: ensure salt/key not logged; config loader rejects weak/empty keys.
- Data privacy
  - Export column allowlist enforced; snapshot tests for column names and order.
  - Anonymization toggle behavior: when `analytics_anonymize_queries=true`, CSV contains `query_hash` and excludes `query_text`.

Priority 2 — Medium risks
- Performance
  - Load tests with 5k, 10k queries; assert p95 < 800ms for week filter; profile hotspots.
- Correctness
  - UTC boundary tests for time filters; bucket assignment tests for 2h slots.
  - Top-chunks: verify minimum threshold suppression and absence of content leakage.

Priority 3 — Low risks
- Operational
  - Observability tests: metrics emitted for export actions; audit log entries contain user id, time, parameters.
- UX
  - Tooltips and empty states for <10 queries; labels reflect UTC.

## Risk Acceptance Criteria
- Must fix before production
  - DATA-001, SEC-001 mitigations implemented and verified.
- Can deploy with mitigation
  - PERF-001, DATA-002, OPS-001 with monitoring and thresholds.
- Accepted risks
  - TECH-002 until persistence story lands; documented to stakeholders.

## Monitoring Requirements
- Security: alerts on unauthorized export attempts, unusually large exports.
- Performance: p95 latency per endpoint by `time_filter`; memory usage during aggregations.
- Data: monitor distribution of export columns; anomaly detection on export volume.
- Business: dashboards for peak hours, engagement KPIs.

## Risk Scoring (Story-Level)
- Critical (9): 0
- High (6): 2 → -20 points
- Medium (4): 5 → -25 points
- Low (2-3): 3 → -6 points
- Base 100 → Overall Story Risk Score: 49 (Medium-High)

## Recommendations
- Testing priority: focus on data privacy and hashing/auth controls first, then performance.
- Development focus: centralize time filtering; implement HMAC-based anonymization; strict export allowlist.
- Deployment: feature-flag CSV export; phased rollout; ensure rollback of analytics changes is safe.
- Monitoring: add export audit dashboard and error budget for analytics endpoints.

---

Review Hook
- Risk profile path: docs/qa/assessments/4.2.2-risk-20251029.md

