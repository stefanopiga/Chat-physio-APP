### Test Design — Story 5.4.2: FK Constraint Violations Resolution

- **ID**: 5.4.2 (fonte: docs/stories/5.4.2-fk-constraint-resolution.md)
- **Tipo**: Technical Debt / Testing / Bugfix (fonte: docs/stories/5.4.2-fk-constraint-resolution.md)
- **Epic**: Epic 5 — DevOps & Maintainability (fonte: docs/stories/5.4.2-fk-constraint-resolution.md)
- **Priorità**: P1 - High (fonte: docs/stories/5.4.2-fk-constraint-resolution.md)
- **Complessità**: High (fonte: docs/stories/5.4.2-fk-constraint-resolution.md)
- **Stato**: DRAFT (2025-10-09) (fonte: docs/stories/5.4.2-fk-constraint-resolution.md)

### Obiettivi di test
- Eliminare tutti gli errori di vincoli FK nei test `auth/student_tokens` (fonte: docs/stories/5.4.2-fk-constraint-resolution.md L31–L41, L52–L63, L128–L138).
- Raggiungere pass rate >90% con Errors: 0 e Failed <10, mantenendo Coverage ≥93% e durata <550s (fonte: L108–L118, L174–L177, L604–L617).
- Garantire coerenza transazionale e isolamento delle fixture con identificatori unici per test (fonte: L120–L125, L149–L156).

### Ambito
- Fix per FK violations durante setup fixture `student_token_in_db` e correlate (`refresh_token_in_db`) (fonte: L64–L85, L88–L102).
- Analisi e correzione race conditions, collisioni ID, scope mismatch e cleanup timing (fonte: L66–L85).
- Validazione sequenziale e in parallelo con pytest-xdist (fonte: L237–L247, L577–L586).

### Fuori scope
- Ottimizzazione performance avanzata, refactoring integrazione obsoleta, migrazione client Supabase→asyncpg come decisione architetturale separata (fonte: L675–L681).

### Baseline e target
- Baseline suite (post 5.4.1): Total 204, PASSED 154 (75.5%), FAILED 12 (5.9%), ERRORS 15 (7.4%), SKIPPED 24 (11.8%), Pass Rate 85.1%, Target >90%, Gap -4.9pp (fonte: L31–L41).
- Target: Pass Rate >90% (180+/204), Errors 0, Failed <10, Coverage ≥93%, Duration <550s (fonte: L110–L118, L171–L176, L604–L617).

### Strategia di esecuzione
- Esecuzione per fasi come da piano implementazione (Phase 1→6) con comandi e validazioni elencate (fonte: L185–L247, L563–L601).
- Verifica transazionale/isolamento fixture con UUID unici, insert verificate, cleanup deterministico (fonte: L252–L335, L337–L386, L389–L443, L488–L507).
- Stress test in parallelo per rilevare/eliminare race conditions (fonte: L577–L586).

### Ambiente e configurazioni
- Suite `apps/api` con `poetry run pytest`; livello log DEBUG per tracing fixture; pytest-xdist per parallel run (fonte: L224–L236, L240–L247, L563–L586).

### Casi di test — Criteri di accettazione

1) AC1 — Zero FK Constraint Violations (fonte: L132–L138)
- GIVEN: test suite completa
- WHEN: esecuzione test `auth` e `student_tokens`
- THEN: nessun `postgrest.exceptions.APIError` per FK; i 15 test in ERROR diventano PASSED o FAILED logici
- Validazione: 
  - `poetry run pytest tests/routers/test_auth.py -vvs --tb=long` (fonte: L224–L229)
  - `poetry run pytest tests/routers/test_student_tokens.py -v` (fonte: L43–L50)

2) AC2 — Fixture Transactional Consistency (fonte: L140–L147)
- GIVEN: fixture `student_token_in_db`
- WHEN: setup eseguito
- THEN: user parent esiste prima di insert token; uso pattern BEGIN/COMMIT o verified insert; rollback su failure
- Validazione:
  - Implementazione UUID unico, insert user verificato e insert token con FK esistente (fonte: L252–L335)
  - Alternativa transazionale con `asyncpg` (fonte: L337–L386)

3) AC3 — Test Isolation Guaranteed (fonte: L149–L156)
- GIVEN: 2 test concorrenti
- WHEN: esecuzione parallela con pytest-xdist
- THEN: unique user_id per test, nessuna collisione, cleanup isolato
- Validazione: `poetry run pytest tests/routers/test_auth.py tests/routers/test_student_tokens.py -n 4 --dist loadfile -vv` (fonte: L240–L247)

4) AC4 — Fixture Cleanup Deterministic (fonte: L158–L165)
- GIVEN: teardown fixture
- WHEN: cleanup
- THEN: DELETE child prima del parent; verifica successo; log warning se cleanup fallisce
- Validazione: logging cleanup step-by-step (fonte: L487–L507)

### Casi di test — Esecuzione mirata
- Trace dei failure rappresentativi: `test_exchange_code_with_student_token`, `test_refresh_token_success` per riproduzione FK (fonte: L88–L103).
- Verifica eliminazione error pattern in setup INSERT (fonte: L104–L105).

### Metriche di uscita
- Pass Rate >90% (180+/204), Errors 0, Failed <10, Coverage ≥93%, Duration <550s (fonte: L110–L118, L604–L617).
- Stabilità: 0 FK errors in 10 run consecutivi; varianza pass rate <2% (fonte: L169–L173).

### Tracciabilità
- Ogni sezione e metrica referenziata direttamente da `docs/stories/5.4.2-fk-constraint-resolution.md` con linee indicate.
