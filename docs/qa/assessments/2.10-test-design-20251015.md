# Test Design: Story 2.10 — Batch Ingestion Knowledge Base

Date: 2025-10-15
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Obiettivo validazione: Ingerire in batch i documenti sotto `conoscenza/fisioterapia/` rispettando rate limit (10/min), garantendo idempotenza client (`--state-file`), assenza di duplicati e qualità operativa (report finale, log strutturati) senza regressioni performance su `/sync-jobs` (P95 < 2s, baseline Story 2.9).
- Totale scenari: 18
- Per livello: Unit 6 (33%), Integration 8 (44%), E2E 4 (22%)
- Priorità: P0: 7, P1: 7, P2: 4

Razionale livelli: la logica di backoff/jitter e resume è verificabile in unit/integration con finti 429/timeout, mentre la correttezza end-to-end richiede pilot controllato e query SQL su Supabase. Nessuna concorrenza: esecuzione seriale per rispettare i limiti.

## Test Scenarios by Acceptance Criteria

### AC1: Script di Ingestione Massiva Creato

| ID               | Level       | Priority | Test                                                                                  | Justification                                  |
| ---------------- | ----------- | -------- | ------------------------------------------------------------------------------------- | ---------------------------------------------- |
| 2.10-UNIT-001    | Unit        | P0       | Parser CLI: `--root-dir/--pattern/--sleep-seconds/--max-retries/--limit/--report/...` | Parametri completi; impedisce run errate        |
| 2.10-UNIT-002    | Unit        | P0       | Rate limit jitter: sleep 6–7s + jitter 0.5–1.5s calcolato correttamente               | Mitiga OPS-001                                 |
| 2.10-UNIT-003    | Unit        | P1       | Backoff expon. con cap: 6→12→24→48 (max 60s)                                          | Evita 429 persistenti                          |
| 2.10-INT-001     | Integration | P0       | 429 con `Retry-After: 10` → attesa ≥10s rispettata prima del retry                    | Conformità server policy                        |
| 2.10-INT-002     | Integration | P1       | Errori rete/timeout → retry fino a `--max-retries`, poi skip con log                   | Resilienza errori temporanei                    |
| 2.10-INT-003     | Integration | P1       | 4xx non retriabili (400/401/403/404) → fail-fast                                      | Correttezza gestione classi errori              |

### AC1 (estrazione testo + payload)

| ID               | Level       | Priority | Test                                                                                  | Justification                                  |
| ---------------- | ----------- | -------- | ------------------------------------------------------------------------------------- | ---------------------------------------------- |
| 2.10-UNIT-004    | Unit        | P1       | Estrazione DOCX: paragraphs concatenati; preserva testo base                          | Compat con `ingest_single_document.py`          |
| 2.10-UNIT-005    | Unit        | P1       | Estrazione TXT/MD: read_text con encoding fallback                                    | Robustezza formati                              |
| 2.10-INT-004     | Integration | P0       | Payload include `document_text`, `document_name`, `source_path`, `category=Fisioterapia`, `topic` da cartella | Retrieval coerente                              |

### AC2: Knowledge Base Completamente Ingerita

| ID               | Level       | Priority | Test                                                                                  | Justification                                  |
| ---------------- | ----------- | -------- | ------------------------------------------------------------------------------------- | ---------------------------------------------- |
| 2.10-E2E-001     | E2E         | P0       | Pilot `--limit 3` su `conoscenza/fisioterapia/lombare/` → HTTP 200, `job_id` presente | Validazione pipeline end-to-end                 |
| 2.10-E2E-002     | E2E         | P1       | SQL: `SELECT COUNT(*) FROM document_chunks;` > 0 (aumenta dopo pilot)                 | Inserimenti effettuati                          |
| 2.10-E2E-003     | E2E         | P0       | SQL: `SELECT COUNT(*) FROM document_chunks WHERE embedding IS NULL;` = 0               | Embedding completati                            |

### AC3: Validazione Funzionale E2E

| ID               | Level       | Priority | Test                                                                                  | Justification                                  |
| ---------------- | ----------- | -------- | ------------------------------------------------------------------------------------- | ---------------------------------------------- |
| 2.10-E2E-004     | E2E         | P1       | Query chat cross-categoria → risposta con citazioni multiple                          | Utilità funzionale della KB                     |

### AC4: Resume & Idempotency Client-side

| ID               | Level       | Priority | Test                                                                                  | Justification                                  |
| ---------------- | ----------- | -------- | ------------------------------------------------------------------------------------- | ---------------------------------------------- |
| 2.10-UNIT-006    | Unit        | P0       | State file: scrittura atomica (temp→rename) e marcatura success/failure               | Prevenzione corruzione dati                     |
| 2.10-INT-005     | Integration | P0       | Interrompi run a metà, riprendi → nessun reinvio di file già riusciti                 | Idempotenza/resume                              |
| 2.10-INT-006     | Integration | P1       | Run ripresa conserva report incrementale coerente                                     | Coerenza output                                 |

### AC5: Osservabilità & Operatività

| ID               | Level       | Priority | Test                                                                                  | Justification                                  |
| ---------------- | ----------- | -------- | ------------------------------------------------------------------------------------- | ---------------------------------------------- |
| 2.10-INT-007     | Integration | P1       | Log per file in JSON con esito, `job_id`, `inserted`, `latency_ms`                    | Tracciabilità                                   |
| 2.10-INT-008     | Integration | P1       | Report `reports/batch_ingestion_report.md` creato con conteggi, top-chunks, CSV/JSON  | Operatività                                     |

### AC6: Compatibilità & Sicurezza

| ID               | Level       | Priority | Test                                                                                  | Justification                                  |
| ---------------- | ----------- | -------- | ------------------------------------------------------------------------------------- | ---------------------------------------------- |
| 2.10-SEC-001     | Integration | P0       | Nessun breaking change su `/sync-jobs` (contratti invariati)                          | Stabilità API                                   |
| 2.10-SEC-002     | Integration | P0       | JWT admin caricato da env; nessun header/secret nei log/report                        | Mitiga SEC-001                                  |
| 2.10-SEC-003     | Integration | P1       | 429/5xx metriche esposte/registrate durante pilot                                     | Monitoraggio rischi operativi                   |

## Risk Coverage

Mappatura principale rischio→scenari (vedi `docs/qa/assessments/2.10-batch-ingestion-knowledge-base-risk-profile-20251015.md`):
- OPS-001 (429 persistenti): 2.10-UNIT-002/003, 2.10-INT-001, 2.10-SEC-003
- SEC-001 (gestione JWT/secret): 2.10-SEC-002
- DATA-001 (idempotenza): 2.10-UNIT-006, 2.10-INT-005/006
- DATA-002 (parsing DOCX): 2.10-UNIT-004/005
- PERF-001 (saturazione worker): 2.10-INT-008 con durata report e monitoraggio coda
- OPS-004 (classificazione errori rete): 2.10-INT-002/003
- DATA-003/004 (conteggi/metadata): 2.10-E2E-002/003, 2.10-INT-004

## Recommended Execution Order
1. P0 Unit: 2.10-UNIT-001/002/006
2. P0 Integration: 2.10-INT-001, 2.10-INT-005, 2.10-SEC-002
3. P0 E2E: 2.10-E2E-001/003
4. P1 Unit/Integration: restanti AC1–AC6
5. P2 rimanenti e verifiche report avanzate

## Gate YAML — test_design

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 6
    integration: 8
    e2e: 4
  by_priority:
    p0: 7
    p1: 7
    p2: 4
  coverage_gaps:
    - "Validazioni SQL automatiche post-run integrate nel report"
    - "Query cross-categoria AC3.1 con citazioni multiple"
```

## Notes for Implementation
- Fornire fixture/mocks per risposte 429 con `Retry-After`, timeout e 5xx.  
- Implementare writer del `--state-file` con file temporanei e rename atomico per evitare corruzioni.  
- Integrare una sezione nel report che esegue automaticamente le 2 query SQL chiave e cattura gli esiti.  
- Redigere i log evitando PII/segreti; testare con logger a livello DEBUG.  
- Per il pilot, limitare a `--limit 3` e monitorare tasso 429, 5xx, P95.

## Story Hook
Test design matrix: docs/qa/assessments/2.10-test-design-20251015.md
P0 tests identified: 7

