# Test Design: Story 8.7 – Supabase Schema Consolidation

Date: 2025-11-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 22
- Unit tests: 6 (27%)
- Integration tests: 11 (50%)
- E2E tests: 5 (23%)
- Priority distribution: P0: 10, P1: 8, P2: 4

## Test Scenarios by Acceptance Criteria

AC Source: Derived from the story’s Hard Stops, Security Checklist, Validation steps, and Output/Verification sections.

### AC1: Dump must be schema-only (no data)

#### Scenarios

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-UNIT-001   | Unit        | P0       | Regex detector flags INSERT/COPY in file           | Pure detection logic |
| 8.7-INT-001    | Integration | P0       | Run validator on generated dump (no INSERT/COPY)   | File-system + tool invocation |
| 8.7-E2E-001    | E2E         | P0       | Full workflow produces clean dump and commit gate  | User-flow critical path |

### AC2: Use direct DB connection (port 5432), not pooled 6543

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-UNIT-002   | Unit        | P0       | Parse provided DB URL and assert :5432             | String/URL validation |
| 8.7-INT-002    | Integration | P0       | Script exits non-zero if port != 5432              | Process behavior |

### AC3: Secrets/identifiers must not be present in dump

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-UNIT-003   | Unit        | P0       | Secret regexes detect potential credentials        | Pattern logic |
| 8.7-INT-003    | Integration | P0       | Validator finds no secrets in a real dump          | On actual file |

### AC4: Required objects present (extensions, tables, indexes, functions, triggers)

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-UNIT-004   | Unit        | P1       | Pattern list covers required CREATE statements     | Logic mapping |
| 8.7-INT-004    | Integration | P1       | Pattern scan finds vector extension in extensions  | File + content check |
| 8.7-INT-005    | Integration | P1       | Required tables detected (documents, chunks, etc.) | File + content check |
| 8.7-INT-006    | Integration | P1       | HNSW index present with m and ef_construction      | File + content check |
| 8.7-INT-007    | Integration | P1       | Functions and triggers present                     | File + content check |

### AC5: RLS enabled with policies for sensitive tables

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-INT-008    | Integration | P0       | After apply: rowsecurity=true on target tables     | DB query validation |
| 8.7-INT-009    | Integration | P0       | Policies exist for sensitive tables                | DB query validation |
| 8.7-E2E-002    | E2E         | P0       | End-to-end: apply + assert RLS and policy presence | Critical security path |

### AC6: GRANTs for service_role complete

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-INT-010    | Integration | P0       | Query pg_catalog to verify privileges              | DB privilege validation |

### AC7: Dump applies on clean local DB without errors

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-E2E-003    | E2E         | P0       | Start local Supabase, psql apply succeeds          | System-level path |
| 8.7-INT-011    | Integration | P1       | After apply: required tables exist                 | DB catalog check |

### AC8: Functions operational (compile and callable)

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-INT-012    | Integration | P1       | Call match_document_chunks with empty DB succeeds  | Runtime function check |

### AC9: HNSW index and parameters present

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-INT-013    | Integration | P1       | Query pg_indexes shows hnsw index with params      | Catalog check |

### AC10: Size threshold reasonable (<100KB)

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-UNIT-005   | Unit        | P2       | File size check utility                            | Simple logic |
| 8.7-INT-014    | Integration | P2       | Validate actual dump under threshold               | File check |

### AC11: CLI version pinned and recorded

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-UNIT-006   | Unit        | P2       | Parse CLI version file and compare                 | Parsing logic |
| 8.7-INT-015    | Integration | P2       | Fail if version < required                         | Process guard |

### AC12: Diff vs remote pull has no material gaps

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-E2E-004    | E2E         | P1       | Generate db pull and compare key objects           | Whole flow comparison |

### AC13: CI/Pre-commit validation blocks bad dumps

| ID             | Level       | Priority | Test                                               | Justification |
| 8.7-INT-016    | Integration | P0       | Pre-commit script fails on seeded bad file         | Hook behavior |
| 8.7-E2E-005    | E2E         | P1       | CI job runs validator and fails on issues          | Pipeline guard |

## Risk Coverage

- Mitigates SEC-001 (data exposure): 8.7-UNIT-001, 8.7-INT-001, 8.7-E2E-001, 8.7-INT-016
- Mitigates DATA-001 (secrets leak): 8.7-UNIT-003, 8.7-INT-003, 8.7-E2E-001
- Mitigates SEC-002 (RLS): 8.7-INT-008, 8.7-INT-009, 8.7-E2E-002
- Mitigates TECH-001 (GRANTs): 8.7-INT-010
- Mitigates OPS-001 (port misuse): 8.7-UNIT-002, 8.7-INT-002
- Mitigates TECH-002/PERF-001 (indexes): 8.7-INT-006, 8.7-INT-013
- Mitigates TECH-003 (CLI drift): 8.7-UNIT-006, 8.7-INT-015
- Mitigates OPS-003 (CI guardrails): 8.7-INT-016, 8.7-E2E-005

## Recommended Execution Order

1. P0 Unit tests: 8.7-UNIT-001, 8.7-UNIT-002, 8.7-UNIT-003
2. P0 Integration tests: 8.7-INT-001, 8.7-INT-002, 8.7-INT-003, 8.7-INT-008, 8.7-INT-009, 8.7-INT-010, 8.7-INT-016
3. P0 E2E tests: 8.7-E2E-001, 8.7-E2E-002, 8.7-E2E-003
4. P1 Integration/E2E: 8.7-INT-004..007, 8.7-INT-011..013, 8.7-E2E-004, 8.7-E2E-005
5. P2 checks: 8.7-UNIT-005, 8.7-INT-014, 8.7-UNIT-006, 8.7-INT-015

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 22
  by_level:
    unit: 6
    integration: 11
    e2e: 5
  by_priority:
    p0: 10
    p1: 8
    p2: 4
  coverage_gaps: []
```

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (shift-left where possible)
- [x] No duplicate coverage across levels
- [x] Priorities align with risk profile
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent

## Notes

- These scenarios align with the story’s validation queries and the validator script proposed under docs/stories/8.7-supabase-schema-reverse-engineering.md.
- Mapping is designed to integrate easily with pre-commit and CI jobs already outlined in the story.

