# PO Validation – Story 2.10: Batch Ingestion Knowledge Base

Data: 2025-10-15  
Validator: Sarah (Product Owner)  
Fonte story: docs/stories/2.10.batch-ingestion-knowledge-base.md  
Stato story: Draft – High Priority

## Executive Summary

La story definisce in modo chiaro l’obiettivo (ingestione massiva dei documenti sotto `conoscenza/fisioterapia/`) con criteri di accettazione misurabili e un set di task ben strutturato (implementazione script, test controllato, ingestione completa, validazioni SQL e E2E). Copre rate limiting, retry/backoff, idempotenza lato client mediante state file e osservabilità tramite logging e report finale. Non emergono blocker critici: esito suggerito GO, con alcune correzioni “Should-Fix” per migliorare chiarezza contrattuale, robustezza operativa e coerenza documentale.

## Template Compliance Issues

- Struttura complessiva conforme (Story, Context, Acceptance Criteria, Tasks/Subtasks, DoD, Risks).  
- Mancano espliciti “Deliverables/Allegati” e “File List” con percorsi definitivi dei report generati (citati in AC ma non riassunti in una sezione dedicata).  
- Alcuni caratteri accentati risultano corrotti nel testo (encoding). Opportuno normalizzare per evitare fraintendimenti.

## Critical Issues (Must Fix – Story Blocked)

Nessun blocker identificato.

## Should-Fix Issues (Quality Improvements)

1. Chiarezza contratti API e payload  
   - In AC/Tasks specificare il payload minimo e i campi opzionali inviati a `POST /api/v1/admin/knowledge-base/sync-jobs` quando si usa `document_text` (già indicato nel Context), includendo un esempio JSON.  
   - Confermare i codici di risposta attesi (200/202, 4xx/5xx) e presenza del `job_id` in caso di successo.

2. Parametri CLI e mapping ad AC  
   - Elencare i parametri con tipo/required/default ed esplicitare il mapping verso gli AC (p.es. `--state-file` → AC4, `--limit` → Fase 2, `--sleep-seconds`/backoff → AC1/AC5).  
   - Aggiungere esempio di invocazione per run di prova (`--limit 3`) e run completo.

3. Preflight env bloccante (AC5.2)  
   - Elencare esplicitamente le variabili verificate (OPENAI_API_KEY, SUPABASE_URL, SUPABASE_SERVICE_KEY, API_BASE_URL) e il comportamento in caso di assenza (exit code ≠ 0 con messaggio chiaro).  
   - Suggerito: stampare un riepilogo mascherato delle variabili caricate.

4. Coerenza report e percorsi  
   - Formalizzare i percorsi di output: `reports/batch_ingestion_report.md` e i file di dettaglio (`reports/batch_ingestion_report.json` e/o `.csv`).  
   - Aggiungere una sezione “Deliverables” con l’elenco file prodotti e link interni.

5. Osservabilità e logging strutturato  
   - Specificare formato log (JSON LTSV-like già citato), campi minimi (file, esito, job_id, inserted, latency_ms, retries, backoff_ms, ts).  
   - Indicare il path di log (stdout + file, es. `reports/logs/ingestion_{YYYYMMDD}.log`).

6. Encoding e caratteri speciali  
   - Correggere i caratteri corrotti nel testo della story (accenti e simboli), per evitare ambiguità nei copy/paste dei requisiti.

## Nice-to-Have Improvements

- Tabella di mapping Task → Acceptance Criteria per verifica veloce.  
- Nota operativa su resume: frequenza di salvataggio stato (per es. ogni N file).  
- Parametro `--concurrency 1` esplicitato (se si decide di mantenere esecuzione seriale) per evitare 429 in scenari futuri.

## Anti-Hallucination Findings

- Endpoint e contesto tecnico sono coerenti con il codice/progetto: esiste la pipeline ingestion e il route `/sync-jobs` lato admin; l’API non legge percorsi host e supporta `document_text` in payload.  
- Rate limiting dichiarato (10/min) in linea con pattern di Traefik/SlowAPI già presenti.  
- Report e validazioni SQL citati sono compatibili con lo schema noto (`document_chunks`).

## Dev Agent Implementation Readiness

- Completezza del contesto: Alta – obiettivo e vincoli operativi chiari.  
- Chiarezza operativa: Alta – AC testabili e tasks granulari; indicazioni su retry/backoff, idempotenza e logging.  
- Gap principali: formalizzazione payload/response API, deliverables/percorsi e normalizzazione encoding.  
- Rischi gestiti: rate limit, file corrotti, chiavi mancanti.

## Re-Validation Update (2025-10-15)

Aggiornamento post-revisione della story:

- Encoding normalizzato: RISOLTO.  
- Tabella parametri CLI con mapping ad AC: AGGIUNTA.  
- Contratto API (payload, header, status codes): FORMALIZZATO.  
- Sezione Deliverables con percorsi espliciti: AGGIUNTA.  
- Preflight environment check blocking e comportamento di errore: ESPPLICITATO.

Residui migliorativi suggeriti:

- Esempio di invocazione CLI end-to-end (dry-run e full-run) con valori placeholder.  
- Nota su masking dei valori sensibili nel log di preflight.

## Final Assessment

- Decisione: GO  
- Implementation Readiness Score: 9.5/10  
- Confidence Level: High – requisiti chiari e testabili, rischi mitigati.

## Action Items

- [ ] Aggiungere esempi di invocazione CLI (dry-run `--limit 3`, full-run) con output atteso sintetico.  
- [ ] Confermare masking dei segreti nel log di preflight (mostrare solo prefix/suffix).
