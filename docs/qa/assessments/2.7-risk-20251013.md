# Risk Profile – Story 2.7: Hardening di Sicurezza e Ottimizzazione Performance del Database Supabase

Data: 2025-10-13 (aggiornamento QA: 2025-10-13 18:00 CET)  
Revisore: Quinn (Test Architect & Quality Advisor)

## Executive Summary

- Totale rischi attivi: 6
- Critici: 0, Alti: 3, Medi: 3, Bassi: 0
- Risk Score complessivo: 55/100 (base 100 − high*10 − medium*5)
- Principali esposizioni: hardening Auth parziale, suite di regressione bloccata, upgrade Postgres ancora da eseguire con piano formale.

### Riepilogo per Gate (incollare come `risk_summary`)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 3
    low: 0
  highest:
    id: SEC-001
    score: 6
    title: "Hardening Auth incompleto espone a credential stuffing"
  recommendations:
    must_fix:
      - "Abilitare leaked password protection o formalizzare mitigazioni equivalenti con monitoraggio"
      - "Ripristinare la suite pytest e pipeline di regressione prima di nuove release"
      - "Programmare finestra di upgrade Postgres con backup/rollback verificati"
    monitor:
      - "Raccogliere metriche p95/p99 post-hardening e osservare idx_scan sull'indice FK"
      - "Allineare la documentazione QA (upgrade plan + evidenze MFA) per evitare drift"
```

## Contesto aggiornato

- Le attività di hardening DB (funzioni `SECURITY DEFINER`, indice FK, RLS con wrapper `SELECT auth.jwt()`) risultano completate e verificate nel report di validazione (`docs/reports/db-hardening-validation.md`).
- L'estensione `vector` è stata spostata nello schema dedicato con piano e validazioni (`docs/reports/db-vector-extension-migration-plan.md`).
- Restano aperti i work item Auth (protezione leaked password, evidenze MFA) e le verifiche di performance/test suite, documentati come pendenti nel report QA.
- Il piano di upgrade Postgres è ancora nello stato “Pianificato” e necessita di finestra e Go/No-Go formale (`docs/reports/postgres-upgrade-plan.md`).

## Risk Matrix

| ID | Categoria | Descrizione | Probabilità | Impatto | Score | Priorità | Stato |
|----|-----------|-------------|-------------|---------|-------|----------|-------|
| SEC-001 | Security | Hardening Auth incompleto (leaked password protection disattiva, MFA limitata) espone a credential stuffing e takeover | Medium (2) | High (3) | 6 | High | Aperto |
| OPS-001 | Operational | Suite pytest/API rotta (`ImportError: access_codes_store`) disattiva la regressione automatica | High (3) | Medium (2) | 6 | High | Aperto |
| OPS-002 | Operational | Upgrade Postgres rimandato lascia scoperte patch di sicurezza e può causare downtime non pianificato | Medium (2) | High (3) | 6 | High | Pianificato |
| PERF-001 | Performance | Mancano misurazioni p95/p99 post-hardening, rischio di degradazioni invisibili nelle query critiche | Medium (2) | Medium (2) | 4 | Medium | In corso |
| DATA-001 | Data | Decisioni su indici “unused” basate su finestre brevi possono portare a drop errati o overhead non monitorato | Medium (2) | Medium (2) | 4 | Medium | In valutazione |
| TECH-001 | Technical | Hardened function e ricerca vettoriale dipendono da script manuali; upgrade futuri rischiano di perdere `SECURITY DEFINER`/`search_path` coerenti | Medium (2) | Medium (2) | 4 | Medium | Aperto |

## Detailed Risk Register

### SEC-001 — Hardening Auth incompleto espone a credential stuffing (Score 6)
- **Evidence:** Il report di validazione segnala che la protezione “Leaked password” è rimasta disabilitata per limiti di piano e che solo TOTP è attivo, con passkeys non disponibili (`docs/reports/db-hardening-validation.md`, sezione “Attività Pendenti (Manuali)”).
- **Probability:** Media — il vettore di attacco è comune e non mitigato da controlli automatici.
- **Impact:** Alta — compromissione account comporta esposizione dei dati medici e pivot verso Supabase.
- **Mitigations:**
  - Valutare upgrade al piano Pro o introdurre mitigazioni equivalenti (rate limiting aggressivo, controllo su credential leak).
  - Applicare enforcement MFA per ruoli privilegiati e documentare le eccezioni con piano di follow-up.
  - Integrare questi controlli nelle checklist di release e nel runbook.
- **Testing Focus:** Verifica dashboard/Auth API, tentativi controllati di reuse password compromesse, check MFA enforcement.
- **Monitoring:** Alert su tentativi di login falliti, export logs Supabase Auth con analisi periodica.

### OPS-001 — Suite pytest/API rotta blocca la regressione (Score 6)
- **Evidence:** L’esecuzione 2025-10-13 della suite backend fallisce in raccolta con `ImportError: cannot import name 'access_codes_store'` (`docs/reports/db-hardening-validation.md`, sezione “Esecuzione 2025-10-13”).
- **Probability:** Alta — failure riproducibile fino a intervento sviluppatori.
- **Impact:** Medio — senza regressione automatica le vulnerabilità reintrodotte passano inosservate.
- **Mitigations:**
  - Riallineare i test al refactoring `api.main` o ripristinare il modulo mancante.
  - Eseguire suite completa + pipeline E2E prima di promuovere in staging/produzione.
  - Rendere blocking il job CI collegato al report di QA.
- **Testing Focus:** `pytest` su container Docker ufficiale e test di integrazione `test_sync_job_integration.py`.
- **Monitoring:** Alert Slack/Email sulle failure di pipeline e report automatico dei test giornalieri.

### OPS-002 — Upgrade Postgres rimandato mantiene superfici di rischio (Score 6)
- **Evidence:** Il piano rimane “Pianificato (in attesa finestra manutenzione)” senza approvazioni finali (`docs/reports/postgres-upgrade-plan.md`).
- **Probability:** Media — patch di sicurezza Supabase/Postgres vengono rilasciate regolarmente, il backlog può crescere.
- **Impact:** Alta — vulnerabilità aperte e upgrade d’emergenza senza preparazione introducono downtime.
- **Mitigations:**
  - Bloccare una finestra (staging → produzione) con checklist completa e Go/No-Go firmato.
  - Rieseguire i prerequisiti (PITR, inventario estensioni) con dati aggiornati post-hardening.
  - Aggiornare il runbook con passi dettagliati di rollback e comunicazione utenti.
- **Testing Focus:** Dry-run in staging con smoke test RAG e verifica funzioni `SECURITY DEFINER`.
- **Monitoring:** Metriche Supabase (p95, errori DB) durante e dopo l’upgrade; alert su failure di backup.

### PERF-001 — Telemetria performance assente dopo il rifacimento (Score 4)
- **Evidence:** Il report QA evidenzia che p95 endpoint non è stato misurato per mancanza di traffico e tooling (`docs/reports/db-hardening-validation.md`, sezione “Piano Test & Performance”).
- **Probability:** Media — senza osservabilità è probabile che regressioni restino non rilevate.
- **Impact:** Medio — degrado di query/ricerche impatta SLA e qualità servizio.
- **Mitigations:**
  - Strumentare l’export di metriche Supabase, raccogliere baseline pre/post.
  - Automatizzare test sintetici (es. script RAG) con raccolta latenza.
  - Allegare le evidenze in `docs/reports/metrics-*` e monitorare trend.
- **Testing Focus:** Workload sintetico su document retrieval/chat con confronto pre/post deploy.
- **Monitoring:** Dashboard condivisa con soglie >1s (search) e >2s (chat), alert se superate.

### DATA-001 — Valutazione indici “unused” rischia decisioni premature (Score 4)
- **Evidence:** La task “Analizzare indici ‘unused’” è aperta e basa la decisione su `pg_stat_user_indexes` senza report consolidato (`docs/stories/2.7.database-hardening-and-performance.md`, sezione “Fase 2 — Fix a Medio Rischio”).
- **Probability:** Media — finestre brevi o carichi anomali possono falsare `idx_scan`.
- **Impact:** Medio — drop errato causa regressioni e costi di rebuild; indici inutili mantengono overhead.
- **Mitigations:**
  - Estendere la raccolta metriche a ≥14 giorni con carichi rappresentativi.
  - Coinvolgere DBA per la decisione finale e documentare esito nel report.
  - Introdurre job automatico che esporta `pg_stat_user_indexes` periodicamente.
- **Testing Focus:** Benchmark comparativo (con/ senza indice) in staging.
- **Monitoring:** Review mensile degli indici a basso utilizzo prima di ogni change major.

### TECH-001 — Manual hardening scripts possono andare in drift (Score 4)
- **Evidence:** Il piano di upgrade contiene esempi dove `prosecdef` risulta `false`, sintomo di baseline non aggiornata al nuovo stato sicuro (`docs/reports/postgres-upgrade-plan.md`, sezione “Validazioni Post-Upgrade (SQL)`); le funzioni richiedono `search_path` che includa `extensions`.
- **Probability:** Media — migrazioni manuali possono essere sovrascritte o dimenticate nei deploy futuri.
- **Impact:** Medio — perdita di `SECURITY DEFINER` o `search_path` corretto reintroduce vulnerabilità o malfunzionamenti vector.
- **Mitigations:**
  - Versionare gli script di hardening in migrazioni idempotenti e includerli nel repository.
  - Aggiornare il piano di upgrade con gli assert corretti e aggiungere check automatici in CI.
  - Pianificare audit periodici `pg_proc`/`pg_extension` post-deploy.
- **Testing Focus:** Query di verifica `pg_proc` + smoke test `match_document_chunks` dopo ogni deploy/upgrade.
- **Monitoring:** Job schedulato che confronta configurazione funzioni con baseline e segnala differenze.

## Risk-Based Testing Strategy

**Priority 1 — High Risks**
- Validare configurazioni Auth (leaked password, MFA enforcement) con test manuali/API e prove di rate limiting.
- Ripristinare ed eseguire la suite pytest completa e la pipeline E2E, rendendo blocking il gate QA.
- Eseguire dry-run dell’upgrade Postgres in staging con checklist completa e smoke test RAG.

**Priority 2 — Medium Risks**
- Raccogliere metriche p95/p99 e `idx_scan` durante carichi rappresentativi, salvando le evidenze.
- Analizzare gli indici “unused” su un periodo esteso e documentare decisioni e rollback plan.
- Automatizzare audit su funzioni hardened e search_path come parte della pipeline di deployment.

**Priority 3 — Continuous Controls**
- Integrare dashboard Supabase Observability e alert su failure Auth/DB.
- Riesaminare i report di hardening nelle riunioni ops, assicurandosi che le attività pendenti avanzino.
- Condividere aggiornamenti QA con il team di sviluppo per mantenere allineati runbook e checklist.

## Monitoring & Telemetry Requirements

- Export programmato (≥1 volta al giorno) di `pg_stat_user_indexes`, `pg_proc` (flag security) e `pg_extension`.
- Dashboard centralizzata con metriche p95/p99, error rate Auth, e success rate delle pipeline di test.
- Alerting su:
  - Tentativi di login falliti > soglia definita;
  - Failure pipeline CI/CD (pytest/import) o runbook upgrade non eseguito entro la finestra;
  - Degradazioni >20% sulla latenza media delle query `match_document_chunks`.

## Residual Risk Score & Gate Recommendation

- **Story Risk Score:** 55/100 (3 High @−10, 3 Medium @−5).  
- **Gate Recommendation:** CONCERNS — chiudere i tre rischi High prima di dichiarare lo story “Ready for Review”.

## Linea di Hook

```
Risk profile: docs/qa/assessments/2.7-risk-20251013.md
```
