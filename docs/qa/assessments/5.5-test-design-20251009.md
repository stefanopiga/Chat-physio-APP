# QA Test Design — Story 5.5: Final Test Suite Cleanup

Status: Draft  
Date: 2025-10-09  
Source: docs/stories/5.5-final-test-suite-cleanup.md

---

## Obiettivi di Test
- Validare la risoluzione dei 4 failure residui e raggiungere pass rate 100% (fonte L43-L50, L836-L841).
- Verificare criteri di accettazione funzionali AC1–AC4 (fonte L440-L480).
- Garantire stabilità non-funzionale: p95 ≤ 1000ms, 5 run stabili, durata <600s, coverage ≥93% (fonte L426-L436, L482-L498, L836-L870).

---

## Ambito
- API Backend: `/api/v1/feedback`, `/api/v1/admin/documents/{id}/chunks`, `/api/v1/chat`, semantic search performance path (fonte L538-L562, L580-L607, L764-L807, L702-L718).

---

## Strategie di Test
- Black-box funzionale per contratti API e sorting.
- Grey-box per query SQL e alias qualificati.
- Performance test sintetico per p95 su 30 richieste (fonte L702-L718).
- Integrazione end-to-end: pipeline indexing → chat (fonte L301-L321, L820-L824).

---

## Casi di Test Dettagliati

### TC-AC1-01 — Feedback: creazione con payload valido
- Fonte: AC1 (fonte L444-L451); Implementazione (fonte L538-L562)
- Precondizioni: DB disponibile
- Input:
  ```json
  {"session_id":"<uuid>","message":"ok","rating":5}
  ```
- Pass Criteria: HTTP 201; body contiene `feedback_id`, `session_id`, `message`, `rating`, `created_at`.
- Negative: rating=0 → HTTP 422.

### TC-AC1-02 — Feedback: omissione feedback_id
- Fonte: Root cause e fix (fonte L88-L115)
- Input: come TC-AC1-01 senza `feedback_id`.
- Pass Criteria: HTTP 201; `feedback_id` auto-generato.

### TC-AC2-01 — Document chunks: sort per size DESC
- Fonte: AC2 (fonte L453-L460); Query alias (fonte L580-L607)
- Precondizioni: documento con ≥3 chunk con size diversa.
- Request: `GET /api/v1/admin/documents/{id}/chunks?sort_by=size`
- Pass Criteria: lista `chunks` ordinata per `chunk_size` DESC; query usa `c.chunk_size` oppure test valida solo l’ordine (fonte L609-L623).

### TC-AC2-02 — Document chunks: default sort per chunk_index
- Fonte: sort map (fonte L595-L603)
- Request: `GET ...?sort_by=chunk_index`
- Pass Criteria: ordinamento per `c.chunk_index ASC`.

### TC-AC3-01 — Performance p95 ≤ 1000ms (30 richieste)
- Fonte: Performance test (fonte L702-L718); mitigazioni (fonte L635-L700, L654-L676)
- Setup: indice HNSW presente; caching attivo; pooling attivo.
- Procedura: inviare 30 POST semantic-search o chiamate chat con query semplice; misurare latenza ms.
- Pass Criteria: p95 < 1000ms.

### TC-AC3-02 — Degrado controllato senza caching
- Fonte: mitigazioni opzionali (fonte L906-L914, L922-L929)
- Setup: disabilitare LRU; mantenere HNSW.
- Pass Criteria: p95 peggiora ma rimane < 1000ms con indice + pooling.

### TC-AC4-01 — Chat dopo indexing: 200 OK
- Fonte: AC4 (fonte L472-L480); endpoint (fonte L764-L807); E2E (fonte L820-L824)
- Precondizioni: documento indicizzato con chunks.
- Input:
  ```json
  {"query":"anatomia spalla","session_id":"<uuid>"}
  ```
- Pass Criteria: HTTP 200; body `answer` non vuoto; `sources` lista con campi `content`, `document_id`, `chunk_id`, `similarity`.

### TC-AC4-02 — Chat: no results
- Fonte: endpoint (fonte L776-L783)
- Input query fuori dominio.
- Pass Criteria: HTTP 404 con `detail="No relevant content found"`.

### TC-STAB-01 — Stabilità suite (5 run)
- Fonte: Stability (fonte L842-L855)
- Procedura: eseguire 5 run completi dei test selezionati AC1–AC4.
- Pass Criteria: varianza 0 nel numero di test passed.

---

## Dati di Test
- UUID validi per `session_id` e `document_id`.
- Documento seed con 3+ chunk di dimensioni diverse per sorting.
- Query testuale breve e ripetibile per performance.

---

## Ambiente e Prerequisiti
- Index HNSW su `document_chunks` (fonte L635-L646).
- Caching embedding LRU attivo (fonte L654-L676).
- Connection pooling asyncpg attivo (fonte L678-L700).

---

## Metriche e Reporting
- KPI: pass/fail per AC1–AC4; p95 ms; durata suite; flakiness (varianza 0); coverage ≥93% (fonte L426-L436, L836-L870).

---

## Tracciabilità → Fonte
- Ogni sezione annotata con riferimenti “fonte Lx-Ly” a `docs/stories/5.5-final-test-suite-cleanup.md`.

---

## Allegati
- Nessuno.
