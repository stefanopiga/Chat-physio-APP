### Test Design — Story 5.4.1: Suite-wide Test Fixes & Pattern Propagation

- **ID**: 5.4.1 (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Tipo**: Technical Debt / Testing / Bugfix (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Epic**: Epic 5 — DevOps & Maintainability (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Priorità**: P1 - High (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Complessità**: High (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- **Stato**: DRAFT (2025-10-09) (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Obiettivi di test
- Raggiungere pass rate >90%, failed <10, errors 0, duration <500s, coverage ≥93% (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Eliminare FK violations su `student_tokens` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Garantire schema API coerente per `/documents/{id}/chunks` e `/knowledge-base/search` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Completare migrazione import path a `api.dependencies` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Allineare test dei servizi per rate limiting e JWT ai pattern definiti (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Validare integrazioni sync job senza 401 (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Ambito
- Categorie failure 1–8 elencate nella sorgente, incluse: FK violations, mismatch schema documenti e knowledge base, import legacy, rate limit service tests, JWT service tests, sync job integration, test chat/performance/pipeline e2e (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Fuori scope
- Ottimizzazione performance `test_performance_semantic_search.py` p95 5253ms; refactoring E2E completo; aumento coverage >93%; suite separata rate limiting (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Baseline e target
- Baseline: 143 PASSED, 33 FAILED, 15 ERRORS, 14 SKIPPED; Pass Rate 73.7%; Duration 471.64s; Coverage 93% (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Target: Pass Rate >90% (180+/194), Failed <10, Errors 0, Coverage ≥93%, Duration <500s (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Strategia di esecuzione
- Esecuzione incrementale per fasi come descritto (Phase 1→7) con validazioni per file/gruppi di test e full suite finale con coverage (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Utilizzo comandi `poetry run pytest` indicati per validazione di ciascuna fase (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Ambiente e configurazioni
- `TESTING=true` e `RATE_LIMITING_ENABLED=false` influenzano i test di rate limit (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Richiesto green build CI/CD (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Casi di test — Selezione e criteri

1) AC1: FK Violations Eliminated (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- GIVEN: suite completa; WHEN: esecuzione test auth e student_tokens; THEN: nessun `postgrest.exceptions.APIError` per FK (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Validazione comando: `poetry run pytest tests/routers/test_auth.py -v` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

2) AC2: API Schema Compliance Suite-wide (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Documents: GIVEN endpoint `/documents/{id}/chunks`; WHEN GET; THEN response include `document_id`, `chunks`, `total_chunks` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Knowledge Base: GIVEN endpoint `/knowledge-base/search`; WHEN POST; THEN ogni result include `similarity_score` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Validazione comando: `poetry run pytest tests/routers/test_documents.py tests/test_document_explorer.py -v` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

3) AC3: Import Path Modernization Complete (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- GIVEN suite completa; WHEN import moduli; THEN nessun AttributeError su import legacy `api.main`; import spostati su `api.dependencies` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Validazione comando: `poetry run pytest tests/test_indexing_admin.py tests/test_indexing_unit.py -v` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

4) AC4: Service Tests Functional (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Rate limit service: con skip condizionale o override, i test verificano `HTTPException` quando RL abilitato (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- JWT service: test su generation/validation con claim `aud` e `timedelta` tipo corretto (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Validazione comando: `poetry run pytest tests/services/ -v` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

5) AC5: Integration Tests Green (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Sync job: GIVEN test_sync_job_integration.py; WHEN eseguiti con admin auth; THEN status code corretti (nessun 401) (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
- Validazione comando: `poetry run pytest tests/test_sync_job_integration.py -v` (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Metriche di uscita
- Pass Rate >90% (180+/194), Failed <10, Errors 0, Coverage ≥93%, Duration <500s (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)

### Tracciabilità
- AC1–AC5 coperti dalle sezioni Casi di test e dalle validazioni comando corrispondenti (fonte: docs/stories/5.4.1-suite-wide-test-fixes.md)
