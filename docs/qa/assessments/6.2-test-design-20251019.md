# Test Design: Story 6.2 — Watcher Configuration Diagnostics & Stabilization

Date: 2025-10-19
Designer: Quinn (Test Architect)
Story: 6.2 — Watcher Configuration Diagnostics & Stabilization
Source: docs/stories/6.2.watcher-configuration-diagnostics-and-stabilization.md

## Test Strategy Overview

- Total test scenarios: 26
- By level: Unit 13 (50%), Integration 9 (35%), E2E 4 (15%)
- By priority: P0: 10, P1: 10, P2: 6, P3: 0
- Focus areas: configuration precedence, LLM binding parameters, timeout validation, Redis graceful behavior, diagnostic tooling outputs, documentation/runbook consistency.

Rationale: Favor unit tests for precedence and validation logic; integration tests for Redis and classifier wiring; minimal but targeted E2E to validate diagnostic runners and end-to-end watcher diag flow.

## Test Scenarios by Acceptance Criteria

### AC1: Docker Logs & Health (ops scripts archive expected signals)

#### Scenarios

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 6.2-UNIT-001   | Unit        | P2       | PowerShell script builds timestamped output path                     | PS logic check |
| 6.2-UNIT-002   | Unit        | P2       | Bash script builds timestamped output path                           | SH logic check |
| 6.2-INT-001    | Integration | P1       | Script collects docker compose ps/logs and archives locally          | Validates external command interactions |
| 6.2-E2E-001    | E2E         | P1       | End-to-end run produces folder and files under ingestion/temp/…      | Critical operator flow |

### AC2: Redis Cache Check (1s timeout, graceful fallback)

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 6.2-UNIT-003   | Unit        | P1       | `redis_check.ping(timeout=1s)` returns True within budget            | Pure logic/timeout param wiring |
| 6.2-UNIT-004   | Unit        | P1       | Disabled flag avoids connection attempts (`CLASSIFICATION_CACHE_ENABLED=false`) | Guard clause correctness |
| 6.2-INT-002    | Integration | P1       | Simulated Redis unreachable → logs warning, watcher continues        | Multi-component behavior |
| 6.2-INT-003    | Integration | P1       | Redis reachable → cache path taken without blocking                  | Happy path integration |

### AC3: Binding LLM to watcher (Settings propagation + event log)

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 6.2-UNIT-005   | Unit        | P0       | `_get_llm()` passes `api_key` from Settings                          | Security-critical param |
| 6.2-UNIT-006   | Unit        | P0       | `_get_llm()` passes optional `base_url` and `project`                | Endpoint correctness |
| 6.2-UNIT-007   | Unit        | P1       | Logs `classifier_llm_initialized` with model/base_url/project/source | Observability requirement |
| 6.2-INT-004    | Integration | P1       | Mock OpenAI client receives expected constructor args                | Cross-module wiring |

### AC4: Precedenza `.env` vs variabili di processo (print_settings + warnings)

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 6.2-UNIT-008   | Unit        | P0       | Process env overrides `.env` for critical keys with warning logged   | Prevent silent misconfig |
| 6.2-UNIT-009   | Unit        | P0       | `print_settings` redacts secrets (api keys, service keys)            | Security |
| 6.2-INT-005    | Integration | P1       | CLI `python -m api.debug.print_settings` emits redacted JSON         | Command-level validation |

### AC5: Ingestion paths from `.env` via Settings → env → defaults

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 6.2-UNIT-010   | Unit        | P1       | `IngestionConfig.from_env()` resolves from Settings when set         | Precedence logic |
| 6.2-UNIT-011   | Unit        | P1       | Falls back to `os.getenv` then defaults with source logging          | Precedence + auditability |
| 6.2-INT-006    | Integration | P1       | Auto `mkdir` for missing paths                                       | Filesystem side-effects |
| 6.2-INT-007    | Integration | P1       | Clear error if directories not writable                              | Robustness |

### AC6: Modalità diagnostica watcher (single-file)

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 6.2-UNIT-012   | Unit        | P2       | Argparse parses `--file` and required flags                          | CLI ergonomics |
| 6.2-INT-008    | Integration | P1       | Executes extract → classify → chunk on sample file; emits metrics    | Pipeline integration |
| 6.2-E2E-002    | E2E         | P1       | Produces JSON report under `ingestion/temp/diag/…`; nonzero exit on blocking error | Operator flow correctness |

### AC7: Documentazione & Runbook

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 6.2-INT-009    | Integration | P2       | Documentation section includes troubleshooting steps and correct commands | Doc validation via content check |
| 6.2-E2E-003    | E2E         | P2       | Follow runbook end-to-end resolves a simulated misconfig             | Realistic operator validation |

### AC8: Test suites (as per story)

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 6.2-UNIT-013   | Unit        | P0       | Timeout validator warns for dev<20s and prod<10s                     | Guardrails on perf risk |
| 6.2-E2E-004    | E2E         | P1       | `tests/test_watcher_diag.py` E2E validates single-file diag happy path | Critical path |

## Risk Coverage

- TECH-001 (Config precedence): 6.2-UNIT-008, 6.2-UNIT-010, 6.2-UNIT-011, 6.2-INT-006, 6.2-INT-007
- TECH-002 (LLM binding params): 6.2-UNIT-005, 6.2-UNIT-006, 6.2-UNIT-007, 6.2-INT-004
- OPS-001 (Diagnostics completeness): 6.2-UNIT-001, 6.2-UNIT-002, 6.2-INT-001, 6.2-E2E-001
- PERF-001 (Timeout too low): 6.2-UNIT-013
- PERF-002 (Timeout too high): 6.2-UNIT-013 (upper-bound validation rules documented)
- DATA-001 (Unwritable paths): 6.2-INT-006, 6.2-INT-007
- SEC-001 (Secrets redaction): 6.2-UNIT-009, 6.2-INT-005
- OPS-002 (Redis graceful): 6.2-UNIT-004, 6.2-INT-002, 6.2-INT-003
- TECH-003 (Cross-environment): 6.2-UNIT-001, 6.2-UNIT-002, 6.2-E2E-001 (Windows/Unix)
- BUS-001 (Docs adoption): 6.2-INT-009, 6.2-E2E-003

## Recommended Execution Order

1. P0 Unit: 6.2-UNIT-005, 6.2-UNIT-006, 6.2-UNIT-008, 6.2-UNIT-009, 6.2-UNIT-013
2. P0 Integration: 6.2-INT-004
3. P1 Integration: 6.2-INT-002, 6.2-INT-003, 6.2-INT-005, 6.2-INT-006, 6.2-INT-007, 6.2-INT-008
4. P1 E2E: 6.2-E2E-001, 6.2-E2E-002, 6.2-E2E-004
5. P2 Unit/Integration/E2E: Remaining scenarios (scripts and docs)

## Gate YAML Block

test_design:
  scenarios_total: 26
  by_level:
    unit: 13
    integration: 9
    e2e: 4
  by_priority:
    p0: 10
    p1: 10
    p2: 6
  coverage_gaps: []

## Trace References

Test design matrix: docs/qa/assessments/6.2-test-design-20251019.md
P0 tests identified: 10

## Notes

- IDs follow {epic}.{story}-{LEVEL}-{SEQ}. Keep sequences stable.
- Prefer mocking external services (OpenAI, Redis) for determinism; reserve live tests for E2E.
- Ensure logs assertions use structured fields as specified in the story.

