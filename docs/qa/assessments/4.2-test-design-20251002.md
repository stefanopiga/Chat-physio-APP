# Test Design — Story 4.2: Analytics Dashboard

**Date**: 2025-10-02  
**Reviewer**: QA Team  
**Story Type**: Feature / Post-MVP Enhancement  
**Epic**: Epic 4 — Post-MVP Enhancements  
**Status**: TEST DESIGN COMPLETE

---

## Riferimenti

**Fonte Primaria**: `docs/stories/4.2.analytics-dashboard.md`

**Documenti Correlati**:
- Risk Profile: `docs/qa/assessments/4.2-risk-20251002.md`
- PRD Epic 4: `docs/prd/sezione-epic-4-dettagli-post-mvp-enhancements.md`
- Architecture Security: `docs/architecture/sezione-10-sicurezza-e-performance.md`
- Testing Strategy: `docs/architecture/sezione-11-strategia-di-testing.md`
- Recharts Implementation Guide: `docs/architecture/addendum-recharts-implementation-4.2.md`
- Story 4.1.5 (Admin Dashboard Hub): `docs/stories/4.1.5-admin-dashboard-hub.md`

---

## Gating / Prerequisiti (Bloccanti)

### Dipendenze Tecniche (Status: DONE ✅)

1. **Story 3.2 — Augmented Generation Endpoint**: 
   - `chat_messages_store` disponibile per aggregazione query
   - Source: `docs/stories/4.2.analytics-dashboard.md` L198

2. **Story 3.4 — Feedback System**: 
   - `feedback_store` disponibile per aggregazione thumbs up/down
   - Source: `docs/stories/4.2.analytics-dashboard.md` L199

3. **Story 4.1.5 — Admin Dashboard Hub**: 
   - `AdminGuard` protection esistente
   - `Card` component Shadcn/UI disponibile
   - Route `/admin/analytics` definita in `App.tsx`
   - Source: `docs/stories/4.2.analytics-dashboard.md` L200, L121

4. **Tech Story — Tailwind + Shadcn/UI**: 
   - UI component library completa
   - Theming light/dark supportato
   - Source: `docs/stories/4.2.analytics-dashboard.md` L203

---

### Prerequisiti Implementativi (Pre-Testing)

**Backend**:
- [ ] Modulo `apps/api/api/analytics/` creato con `analytics.py`
- [ ] Pydantic models definiti: `AnalyticsResponse`, `OverviewStats`, `QueryStat`, `FeedbackSummary`, `PerformanceMetrics`
- [ ] Endpoint `GET /api/v1/admin/analytics` implementato con auth + rate limiting
- [ ] Aggregation logic implementata: query counts, feedback ratio, latency p95/p99
- [ ] Session ID hashing SHA256 implementato (R-4.2-2 mitigation)
- [ ] Rate limiting `30/hour` configurato
- Source: `docs/stories/4.2.analytics-dashboard.md` L324-334, L413-419

**Frontend**:
- [ ] Recharts installato: `pnpm add recharts` in `apps/web/`
- [ ] Componente `AnalyticsPage.tsx` creato in `apps/web/src/pages/`
- [ ] Layout responsive implementato (2 col desktop, 1 col mobile)
- [ ] Chart components: `FeedbackBarChart`, `PerformanceLineChart` (opzionale MVP)
- [ ] Data fetching logic con loading/error states
- [ ] Route `/admin/analytics` abilitata con `AdminGuard`
- Source: `docs/stories/4.2.analytics-dashboard.md` L342-366, L421-436

**Integration**:
- [ ] Card "Analytics Dashboard" abilitata in `DashboardPage.tsx` (rimozione "Coming Soon")
- [ ] Navigation link da dashboard a analytics funzionante
- Source: `docs/stories/4.2.analytics-dashboard.md` L377, L439-440

---

## Obiettivi di Test

### Coverage Targets
- **Backend**: ≥85% coverage su modulo analytics
- **Frontend**: ≥90% coverage su `AnalyticsPage.tsx` e chart components
- **E2E**: 10 scenari completi (navigation, data display, responsive, security)
- Source: `docs/stories/4.2.analytics-dashboard.md` L258, L276, L296

### Risk-Based Testing Priorities
1. **High Priority**: Security (R-4.2-2 session_id hashing), Admin auth, Rate limiting
2. **Medium Priority**: Performance aggregation (R-4.2-3), Responsive layout (R-4.2-5)
3. **Low Priority**: Bundle size monitoring (R-4.2-4)
- Source: `docs/qa/assessments/4.2-risk-20251002.md` L234-256

### Acceptance Criteria Coverage
- **10 Acceptance Criteria** definiti nella story
- Ogni AC mappato a ≥1 test case
- Source: `docs/stories/4.2.analytics-dashboard.md` L25-36

---

## Backend Test Design

### Test File Location
**Path**: `/apps/api/tests/test_analytics.py`  
**Framework**: Pytest + HTTPX AsyncClient  
**Source**: `docs/stories/4.2.analytics-dashboard.md` L248

---

### API Endpoint: GET /api/v1/admin/analytics

**Contract Specification**:
```python
# Request
GET /api/v1/admin/analytics
Headers: Authorization: Bearer {admin_jwt_token}

# Response 200 OK
{
  "overview": {
    "total_queries": int,
    "total_sessions": int,
    "feedback_ratio": float,  # 0.0-1.0
    "avg_latency_ms": int
  },
  "top_queries": [
    {
      "query_text": str,
      "count": int,
      "last_queried_at": str  # ISO datetime
    }
  ],
  "feedback_summary": {
    "thumbs_up": int,
    "thumbs_down": int,
    "ratio": float  # 0.0-1.0
  },
  "performance_metrics": {
    "latency_p95_ms": int,
    "latency_p99_ms": int,
    "sample_count": int
  }
}
```
Source: `docs/stories/4.2.analytics-dashboard.md` L48-76

---

### Unit Tests — Aggregation Logic (6 test cases)

**BT-001: Query Count Aggregation — Case Insensitive**
- **Given**: `chat_messages_store` con messaggi ["Test Query", "test query", "TEST QUERY"]
- **When**: Aggregation eseguita
- **Then**: Conteggio aggregato = 3 per "test query" (normalizzato)
- **Coverage**: Case-insensitive normalization
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L251, L85-91

**BT-002: Top Queries Ordered by Count DESC**
- **Given**: Query counts {"query A": 10, "query B": 5, "query C": 15}
- **When**: `most_common(10)` applicato
- **Then**: Ordine result = ["query C" (15), "query A" (10), "query B" (5)]
- **Coverage**: Sorting logic
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L252, L94-97

**BT-003: Feedback Ratio — Zero Feedback Edge Case**
- **Given**: `feedback_store` vuoto (no thumbs up/down)
- **When**: Feedback ratio calcolato
- **Then**: `ratio = 0.0`, no division by zero error
- **Coverage**: Edge case handling
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L253, L100-103

**BT-004: Feedback Ratio — Mixed Up/Down**
- **Given**: `feedback_store` con 45 thumbs up, 15 thumbs down
- **When**: Feedback ratio calcolato
- **Then**: `ratio = 0.75` (45/60), `thumbs_up=45`, `thumbs_down=15`
- **Coverage**: Correct calculation
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L254, L100-103

**BT-005: Latency Percentiles — p95/p99**
- **Given**: `ag_latency_samples_ms = [100, 200, ..., 1000]` (100 samples)
- **When**: Percentile calculation
- **Then**: `latency_p95_ms ≈ 950`, `latency_p99_ms ≈ 990`
- **Coverage**: Percentile math accuracy
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L106-107

**BT-006: Session ID Anonymization — SHA256 Hashing**
- **Given**: `session_id = "raw_session_abc123"`
- **When**: Analytics response preparata
- **Then**: Response contiene `hashed_session_id = sha256(raw_session_abc123)[:16]`, NO raw session_id presente
- **Coverage**: R-4.2-2 security mitigation
- **Priority**: CRITICAL
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L333, `docs/qa/assessments/4.2-risk-20251002.md` L95-145

---

### Integration Tests — Endpoint Security (3 test cases)

**BT-010: Admin Auth — 403 for Non-Admin User**
- **Given**: JWT token con `role=student`
- **When**: `GET /api/v1/admin/analytics`
- **Then**: Status 403 Forbidden, error message "Admin access required"
- **Coverage**: Admin role check (`_is_admin()`)
- **Priority**: HIGH
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L255, L111

**BT-011: Admin Auth — 401 for Missing JWT**
- **Given**: No Authorization header
- **When**: `GET /api/v1/admin/analytics`
- **Then**: Status 401 Unauthorized
- **Coverage**: JWT verification
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L111

**BT-012: Admin Auth — 200 for Valid Admin JWT**
- **Given**: JWT token con `role=admin`
- **When**: `GET /api/v1/admin/analytics`
- **Then**: Status 200 OK, response completa con tutti campi
- **Coverage**: Happy path admin access
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L111

---

### Performance Tests — Aggregation Timing (2 test cases)

**BT-020: Performance Benchmark — 1000 Messages**
- **Given**: Mock stores con 1000 messaggi, 100 sessioni, 200 feedback, 500 latency samples
- **When**: Aggregation eseguita
- **Then**: Latency aggregation < 500ms (p95)
- **Coverage**: R-4.2-3 performance requirement
- **Measurement**: Use `pytest-benchmark` o `time.perf_counter()`
- **Priority**: MEDIUM
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L256, `docs/qa/assessments/4.2-risk-20251002.md` L147-219

**BT-021: Rate Limiting — 30 Requests/Hour**
- **Given**: 31 richieste analytics consecutive da stesso admin IP
- **When**: 31° richiesta eseguita
- **Then**: Status 429 Too Many Requests
- **Coverage**: Rate limiting enforcement
- **Priority**: HIGH
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L112

---

### Data Integrity Tests (3 test cases)

**BT-030: Last Queried Timestamp Accuracy**
- **Given**: Query "test" eseguita a T1, poi a T2 (T2 > T1)
- **When**: Analytics richiesta
- **Then**: `top_queries[i].last_queried_at` = T2 (timestamp più recente)
- **Coverage**: Timestamp tracking
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L62-65

**BT-031: Total Sessions Count**
- **Given**: `chat_messages_store` con 5 session_id unici
- **When**: Analytics richiesta
- **Then**: `overview.total_sessions = 5`
- **Coverage**: Unique session counting
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L56-60

**BT-032: Average Latency Calculation**
- **Given**: `ag_latency_samples_ms = [100, 200, 300]`
- **When**: Analytics richiesta
- **Then**: `overview.avg_latency_ms = 200` (mean)
- **Coverage**: Average calculation
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L60

---

## Frontend Test Design

### Test File Location
**Path**: `/apps/web/src/pages/__tests__/AnalyticsPage.test.tsx`  
**Framework**: Vitest + React Testing Library  
**Source**: `docs/stories/4.2.analytics-dashboard.md` L264

---

### Unit Tests — AnalyticsPage Component (8 test cases)

**FT-001: Rendering — Page Heading Present**
- **Given**: `AnalyticsPage` renderizzata con mock data
- **When**: Component mounted
- **Then**: Heading "Analytics Dashboard" visibile
- **Coverage**: AC1 - basic rendering
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L267

**FT-002: Loading State — Skeleton Cards Visible**
- **Given**: API fetch in progress (mock pending promise)
- **When**: Component rendering durante fetch
- **Then**: Skeleton UI placeholders visibili, no real data
- **Coverage**: AC10 - loading state
- **Pattern**: Shadcn/UI skeleton pattern
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L268, L191

**FT-003: KPI Cards — 4 Overview Cards Rendered**
- **Given**: Mock analytics data con overview stats
- **When**: Data loaded
- **Then**: 4 Card components visibili con titoli "Domande Totali", "Sessioni Attive", "Feedback Ratio", "Latenza Media"
- **Coverage**: AC2 - Panoramica KPI cards
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L269, L28

**FT-004: Query Table — Top Queries with Sort**
- **Given**: Mock `top_queries = [{query_text: "test", count: 10}, {query_text: "query", count: 5}]`
- **When**: Table rendered
- **Then**: 2 righe presenti, ordinamento count desc (10, poi 5)
- **Coverage**: AC3 - Domande più frequenti
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L270, L29

**FT-005: Feedback Chart — Bar Chart Visible**
- **Given**: Mock `feedback_summary = {thumbs_up: 45, thumbs_down: 12}`
- **When**: Chart section rendered
- **Then**: Recharts `BarChart` component presente, 2 bar visibili (green/red)
- **Coverage**: AC4 - Feedback visualization
- **Testing**: Check SVG element `<svg class="recharts-surface">`
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L271, L30

**FT-006: Performance Metrics — P95/P99 Displayed**
- **Given**: Mock `performance_metrics = {latency_p95_ms: 350, latency_p99_ms: 520}`
- **When**: Performance section rendered
- **Then**: Card P95 mostra "350ms", Card P99 mostra "520ms"
- **Coverage**: AC5 - Performance metrics
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L272, L31

**FT-007: Refresh Button — Click Triggers Re-Fetch**
- **Given**: `AnalyticsPage` già caricata con dati iniziali
- **When**: Click su button "Aggiorna Dati"
- **Then**: `fetchAnalytics()` chiamata nuovamente, loading state attivato
- **Coverage**: AC9 - Refresh manuale
- **Mocking**: `vi.spyOn(api, 'fetchAnalytics')`
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L273, L35

**FT-008: Error State — Error Message Displayed**
- **Given**: API fetch fallisce con 500 error
- **When**: Component handling error
- **Then**: Messaggio errore "Impossibile caricare analytics" visibile
- **Coverage**: Error handling
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L274

---

### Unit Tests — Chart Components (4 test cases)

**FT-010: FeedbackBarChart — Recharts Props Correct**
- **Given**: `FeedbackBarChart` con data `[{name: 'Thumbs Up', count: 45}, {name: 'Thumbs Down', count: 12}]`
- **When**: Component rendered
- **Then**: 
  - `BarChart` component presente
  - `Bar` component con `fill="#22c55e"` per up, `fill="#ef4444"` per down
  - `ResponsiveContainer` wrapper presente
- **Coverage**: Recharts integration, color semantics
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L350-353, `docs/architecture/addendum-recharts-implementation-4.2.md` L39-86

**FT-011: FeedbackBarChart — ResponsiveContainer Width 100%**
- **Given**: `FeedbackBarChart` rendered
- **When**: Container inspected
- **Then**: `ResponsiveContainer` prop `width="100%"`, `height={300}`
- **Coverage**: Responsive design
- **Source**: `docs/architecture/addendum-recharts-implementation-4.2.md` L67-68

**FT-012: PerformanceLineChart — Dual Lines P95/P99**
- **Given**: `PerformanceLineChart` con data `[{timestamp: '10:00', p95: 320, p99: 450}]`
- **When**: Component rendered
- **Then**: 
  - 2 `Line` components presenti
  - Line p95 stroke `#3b82f6` (blue)
  - Line p99 stroke `#ef4444` (red)
- **Coverage**: Line chart dual series
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L354-357, `docs/architecture/addendum-recharts-implementation-4.2.md` L100-160

**FT-013: PerformanceLineChart — Threshold Highlighting**
- **Given**: `latency_p95_ms = 2100` (> 2000ms threshold)
- **When**: Performance section rendered
- **Then**: Badge "⚠ High" visibile accanto a P95 card
- **Coverage**: Threshold warning logic
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L357

---

### Integration Tests — Data Fetching (3 test cases)

**FT-020: Data Fetch — API Call with Admin JWT**
- **Given**: Admin logged in con session token
- **When**: `AnalyticsPage` mounts, `useEffect` triggers `fetchAnalytics()`
- **Then**: 
  - API call a `/api/v1/admin/analytics` con header `Authorization: Bearer {token}`
  - Mock response 200 OK parsed correctly
- **Coverage**: API integration, auth headers
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L176-186

**FT-021: Data Fetch — 403 Error Handling**
- **Given**: API returns 403 Forbidden (non-admin user)
- **When**: `fetchAnalytics()` executed
- **Then**: Error state attivato, error message "Accesso negato"
- **Coverage**: Error handling 403
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L274

**FT-022: Data Transformation — API Response to Chart Data**
- **Given**: API response `feedback_summary = {thumbs_up: 45, thumbs_down: 12, ratio: 0.789}`
- **When**: Data transformed per chart
- **Then**: Chart data = `[{name: 'Thumbs Up', count: 45}, {name: 'Thumbs Down', count: 12}]`
- **Coverage**: Data transformation logic
- **Source**: `docs/architecture/addendum-recharts-implementation-4.2.md` L29-37

---

## E2E Test Design

### Test File Location
**Path**: `/apps/web/tests/story-4.2.spec.ts`  
**Framework**: Playwright  
**Source**: `docs/stories/4.2.analytics-dashboard.md` L282

---

### E2E Test Scenarios (10 test cases)

**E2E-001: Admin Navigation — Dashboard → Analytics**
- **Given**: Admin autenticato, su `/admin/dashboard`
- **When**: Click su card "Analytics Dashboard"
- **Then**: 
  - Redirect a `/admin/analytics`
  - Page heading "Analytics Dashboard" visibile
- **Duration Target**: < 5s
- **Coverage**: AC1 - Dashboard navigation
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L285

**E2E-002: Dashboard Load — 4 KPI Cards Visible**
- **Given**: Admin su `/admin/analytics`, analytics data disponibile
- **When**: Page fully loaded
- **Then**: 4 Card components con KPI visibili (total queries, sessions, feedback ratio, avg latency)
- **Duration Target**: < 3s
- **Coverage**: AC2 - Panoramica section
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L286

**E2E-003: Top Queries Table — At Least 1 Row**
- **Given**: Analytics data con almeno 1 query registrata
- **When**: Dashboard loaded
- **Then**: Table "Domande Più Frequenti" contiene ≥1 riga con query text, count, timestamp
- **Coverage**: AC3 - Query table
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L287

**E2E-004: Feedback Chart — Bar Chart Visible**
- **Given**: Analytics data con feedback disponibile
- **When**: Dashboard loaded
- **Then**: 
  - Bar chart visibile in sezione "Feedback Aggregato"
  - SVG element `<svg class="recharts-surface">` presente
  - Ratio percentage text visibile (es. "78.9%")
- **Coverage**: AC4 - Feedback visualization
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L288

**E2E-005: Performance Metrics — P95/P99 Cards Visible**
- **Given**: Analytics data con latency samples
- **When**: Dashboard loaded
- **Then**: 
  - Card "P95 Latency" visibile con valore ms
  - Card "P99 Latency" visibile con valore ms
- **Coverage**: AC5 - Performance section
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L289

**E2E-006: Refresh Button — Click → Loading → New Data**
- **Given**: Dashboard già caricata con dati iniziali
- **When**: Click su button "Aggiorna Dati"
- **Then**: 
  - Loading indicator (skeleton) appare brevemente
  - Nuovi dati caricati (timestamp aggiornato)
  - Success feedback (opzionale)
- **Duration Target**: < 3s refresh cycle
- **Coverage**: AC9 - Manual refresh
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L290

**E2E-007: Non-Admin User — Redirect to Home**
- **Given**: Student user (non-admin) autenticato
- **When**: Tentativo navigazione diretta a `/admin/analytics`
- **Then**: 
  - `AdminGuard` blocca accesso
  - Redirect a `/` (home page)
  - Heading "Accesso Studente" visibile
- **Duration Target**: < 2s
- **Coverage**: AC6 - Admin-only access
- **Priority**: HIGH (security test)
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L291

**E2E-008: Responsive Mobile — Layout 1 Column (375px)**
- **Given**: Viewport impostato a 375px width (iPhone SE)
- **When**: Dashboard loaded
- **Then**: 
  - KPI cards stack verticalmente (1 colonna)
  - Table ha scroll orizzontale se necessario
  - Chart width adapts a 100% container
- **Coverage**: AC8 - Responsive mobile
- **Priority**: MEDIUM (R-4.2-5)
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L292, `docs/qa/assessments/4.2-risk-20251002.md` L221-275

**E2E-009: Responsive Desktop — Layout 2 Columns (1280px)**
- **Given**: Viewport impostato a 1280px width (desktop standard)
- **When**: Dashboard loaded
- **Then**: 
  - KPI cards in grid 4 colonne
  - Chart sections affiancate dove applicabile
  - No horizontal scroll
- **Coverage**: AC8 - Responsive desktop
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L293

**E2E-010: Navigation — Dashboard → Analytics → Back to Dashboard**
- **Given**: Admin su `/admin/analytics`
- **When**: 
  - Click su navigation link/breadcrumb "Dashboard" (assumendo implementazione)
  - OR browser back button
- **Then**: 
  - Redirect a `/admin/dashboard`
  - Dashboard card grid visibile
- **Duration Target**: < 2s
- **Coverage**: Navigation flow completeness
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L294

---

### E2E Test Setup & Patterns

**Admin Session Setup**:
```typescript
// Setup admin credentials before goto
await page.addInitScript(() => {
  localStorage.setItem('supabase.auth.token', JSON.stringify({
    access_token: 'e2e-admin-token',
    user: { role: 'admin' }
  }));
});
await page.goto('/admin/analytics');
```
Source: `docs/architecture/sezione-11-strategia-di-testing.md` L33-39

**AdminGuard Wait Pattern**:
```typescript
// Attendere sblocco AdminGuard prima di interagire
await expect(page.getByText('Verifica autenticazione...')).not.toBeVisible({ timeout: 10000 });
await expect(page.getByRole('heading', { name: /Analytics Dashboard/i })).toBeVisible();
```
Source: `docs/architecture/sezione-11-strategia-di-testing.md` L41-43

**Selettori Resilienti**:
```typescript
// Preferire selettori semantici
const refreshButton = page.getByRole('button', { name: /Aggiorna Dati/i });
await expect(refreshButton).toBeVisible({ timeout: 5000 });

// Chart detection
const chartSvg = page.locator('svg.recharts-surface');
await expect(chartSvg).toBeVisible({ timeout: 5000 });
```
Source: `docs/architecture/sezione-11-strategia-di-testing.md` L45-48

---

## Accessibility Testing

### Manual Accessibility Tests (3 scenarios)

**A11Y-001: Keyboard Navigation — Tab Order**
- **Given**: Dashboard loaded
- **When**: Utente naviga con `Tab` key
- **Then**: 
  - Focus visibile su ogni elemento interattivo
  - Tab order logico: Header → KPI cards → Table → Charts → Refresh button
  - No focus traps
- **Coverage**: AC (implicit accessibility requirement)
- **Tool**: Manual test + axe-core browser extension
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L313-316

**A11Y-002: Chart ARIA Labels**
- **Given**: Charts rendered
- **When**: Screen reader active
- **Then**: 
  - `BarChart` ha `role="img"` e `aria-label="Bar chart showing feedback distribution"`
  - `LineChart` ha `aria-label="Line chart showing latency trends"`
- **Coverage**: AC (accessibility)
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L314

**A11Y-003: Table Semantics — Header Scope**
- **Given**: Top queries table rendered
- **When**: Inspecting table structure
- **Then**: 
  - `<th>` tags con `scope="col"` per headers
  - Proper `<thead>`, `<tbody>` structure
- **Coverage**: AC (accessibility)
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L315

---

## Performance Testing

### Performance Test Suite (3 scenarios)

**PERF-001: Bundle Size — Recharts Impact**
- **Given**: Build production con Recharts
- **When**: `pnpm build --analyze` eseguito
- **Then**: 
  - Bundle increment < +5KB gzip vs baseline (130.85KB)
  - Analytics route lazy-loaded (separate chunk)
- **Target**: ≤135KB gzip total
- **Coverage**: R-4.2-4 monitoring
- **Tool**: `webpack-bundle-analyzer` o `rollup-plugin-visualizer`
- **Source**: `docs/qa/assessments/4.2-risk-20251002.md` L277-325

**PERF-002: API Response Time — p95 Target**
- **Given**: Backend con 1000 messaggi mock, 100 sessioni
- **When**: 100 richieste consecutive a `/api/v1/admin/analytics`
- **Then**: 
  - p95 latency < 500ms
  - p99 latency < 1000ms
- **Tool**: Apache Bench `ab` o `wrk`
- **Coverage**: AC (implicit performance), R-4.2-3
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L400, `docs/qa/assessments/4.2-risk-20251002.md` L147-219

**PERF-003: First Load Time — Lighthouse Score**
- **Given**: Production build deployed
- **When**: Lighthouse audit eseguito su `/admin/analytics`
- **Then**: 
  - Performance score ≥90
  - FCP < 1.5s
  - TTI < 3.0s
- **Coverage**: Overall performance
- **Tool**: Lighthouse CI
- **Source**: `docs/qa/assessments/4.1.5-nfr-assessment-20251002.md` L71 (pattern reference)

---

## Security Testing

### Security Test Suite (4 scenarios)

**SEC-001: Session ID Hashing — Regex Search**
- **Given**: API response `/api/v1/admin/analytics` captured
- **When**: JSON response parsed
- **Then**: 
  - Regex search for raw `session_id` pattern (UUID-like) = NO MATCH
  - Only hashed values presente (64 char hex string)
- **Priority**: CRITICAL
- **Coverage**: R-4.2-2 privacy leak mitigation
- **Source**: `docs/qa/assessments/4.2-risk-20251002.md` L95-145

**SEC-002: Admin Role Enforcement — Negative Test**
- **Given**: JWT token con `role=student`
- **When**: API call a `/api/v1/admin/analytics`
- **Then**: 
  - Response 403 Forbidden
  - Error message non leak informazioni sensibili
- **Coverage**: AC6 - Admin-only access
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L32

**SEC-003: Rate Limiting — Burst Test**
- **Given**: Admin user con valid JWT
- **When**: 31 richieste consecutive a `/api/v1/admin/analytics` in < 1 minuto
- **Then**: 
  - Prime 30 richieste: 200 OK
  - 31° richiesta: 429 Too Many Requests
  - Header `Retry-After` presente
- **Coverage**: R-4.2-3 partial (abuse prevention)
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L112

**SEC-004: JWT Expiration — Expired Token Handling**
- **Given**: JWT token scaduto (exp claim passato)
- **When**: Tentativo fetch analytics
- **Then**: 
  - Response 401 Unauthorized
  - Frontend handling: redirect a login o refresh token
- **Coverage**: Auth security best practices
- **Source**: `docs/architecture/sezione-10-sicurezza-e-performance.md` L3-13

---

## Regression Testing

### Regression Test Suite (Story 4.1/4.1.5)

**REG-001: Dashboard Hub — Card Grid Still Works**
- **Given**: Implementazione Story 4.2 completata
- **When**: Navigazione a `/admin/dashboard`
- **Then**: 
  - 2 Card presenti (Debug View, Analytics Dashboard)
  - Card Analytics non ha più badge "Coming Soon"
  - Click su card Analytics → redirect a `/admin/analytics`
- **Coverage**: Ensure Story 4.1.5 non rotto da 4.2
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L377, L439

**REG-002: Debug View — Still Accessible**
- **Given**: Admin su dashboard
- **When**: Click su card "Debug View"
- **Then**: 
  - Redirect a `/admin/debug`
  - Debug view funzionante
- **Coverage**: Ensure Story 4.1 non rotto
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L446

**REG-003: Previous E2E Suites — Re-Run**
- **Given**: Test suite Story 4.1 (18 tests), Story 4.1.5 (18 tests)
- **When**: Re-run dopo implementazione 4.2
- **Then**: 
  - 100% pass rate maintained
  - No new failures
- **Duration Target**: < 2 min total
- **Coverage**: Full regression coverage
- **Source**: `docs/stories/4.2.analytics-dashboard.md` L446

---

## Test Data Requirements

### Mock Data Specifications

**Analytics Mock Data — Happy Path**:
```typescript
const mockAnalyticsData = {
  overview: {
    total_queries: 156,
    total_sessions: 42,
    feedback_ratio: 0.789,
    avg_latency_ms: 342
  },
  top_queries: [
    { query_text: "quali sono i sintomi della tendinite?", count: 15, last_queried_at: "2025-10-02T10:30:00Z" },
    { query_text: "esercizi per la lombalgia", count: 12, last_queried_at: "2025-10-02T09:45:00Z" },
    { query_text: "terapia per il tunnel carpale", count: 10, last_queried_at: "2025-10-02T11:20:00Z" }
  ],
  feedback_summary: {
    thumbs_up: 45,
    thumbs_down: 12,
    ratio: 0.789
  },
  performance_metrics: {
    latency_p95_ms: 450,
    latency_p99_ms: 620,
    sample_count: 156
  }
};
```
Source: `docs/stories/4.2.analytics-dashboard.md` L48-76

**Mock Data — Edge Cases**:
1. **Empty Data**: Zero queries, zero feedback, zero sessions
2. **Single Query**: 1 query, 1 session (min viable data)
3. **Large Dataset**: 10,000 queries, 1000 sessions (performance test)
4. **Unbalanced Feedback**: 100% thumbs up (ratio = 1.0) OR 100% thumbs down (ratio = 0.0)

---

## Test Execution Strategy

### Phase 1: Unit Testing (Backend)
**Duration**: 2-3 hours  
**Order**:
1. Aggregation logic tests (BT-001 to BT-006) — CRITICAL
2. Security tests (BT-010 to BT-012) — HIGH priority
3. Performance tests (BT-020 to BT-021) — MEDIUM priority
4. Data integrity tests (BT-030 to BT-032) — LOW priority

**Exit Criteria**: 
- ≥85% coverage backend analytics module
- All CRITICAL/HIGH tests PASS
- Zero security test failures

---

### Phase 2: Unit Testing (Frontend)
**Duration**: 3-4 hours  
**Order**:
1. Component rendering tests (FT-001 to FT-008)
2. Chart component tests (FT-010 to FT-013)
3. Integration tests (FT-020 to FT-022)

**Exit Criteria**: 
- ≥90% coverage `AnalyticsPage.tsx`
- All chart rendering tests PASS
- Data transformation logic validated

---

### Phase 3: E2E Testing
**Duration**: 2-3 hours  
**Order**:
1. Security test (E2E-007) — CRITICAL first
2. Navigation tests (E2E-001, E2E-010)
3. Data display tests (E2E-002 to E2E-006)
4. Responsive tests (E2E-008, E2E-009)

**Exit Criteria**: 
- 10/10 E2E scenarios PASS
- Duration target < 45s total
- Zero AdminGuard bypass

---

### Phase 4: Specialized Testing
**Duration**: 2-4 hours  
**Components**:
1. Accessibility tests (A11Y-001 to A11Y-003) — Manual + axe-core
2. Performance tests (PERF-001 to PERF-003) — Lighthouse + Benchmark
3. Security tests (SEC-001 to SEC-004) — Manual inspection + automated
4. Regression tests (REG-001 to REG-003) — Automated suite re-run

**Exit Criteria**: 
- Zero critical accessibility violations
- Performance targets met (p95 < 500ms)
- All regression tests PASS

---

## Coverage Metrics & Targets

### Backend Coverage
**Target**: ≥85%  
**Measured Modules**:
- `apps/api/api/analytics/analytics.py`
- Aggregation functions
- Security middleware (admin check, rate limiting)

**Critical Paths** (must be 100% covered):
- Admin role verification
- Session ID hashing
- Rate limiting enforcement

**Source**: `docs/stories/4.2.analytics-dashboard.md` L258

---

### Frontend Coverage
**Target**: ≥90%  
**Measured Components**:
- `apps/web/src/pages/AnalyticsPage.tsx`
- `FeedbackBarChart.tsx` (se component separato)
- `PerformanceLineChart.tsx` (se component separato)

**Critical Paths** (must be 100% covered):
- Data fetching logic
- Error handling
- Loading states

**Source**: `docs/stories/4.2.analytics-dashboard.md` L276

---

### E2E Coverage
**Target**: 10/10 scenarios PASS  
**Duration Target**: < 45 seconds total  
**Critical Scenarios** (zero tolerance for failures):
- E2E-007: AdminGuard security
- E2E-001: Navigation from dashboard
- E2E-002: KPI cards rendering

**Source**: `docs/stories/4.2.analytics-dashboard.md` L296

---

## Risk Coverage Matrix

| Risk ID | Priority | Test Cases Covering | Status |
|---------|----------|---------------------|--------|
| R-4.2-1 | High | N/A (Tech Debt Accepted) | Documented |
| R-4.2-2 | High | BT-006, SEC-001 | CRITICAL |
| R-4.2-3 | Medium | BT-020, PERF-002, SEC-003 | MEDIUM |
| R-4.2-4 | Low | PERF-001 | LOW |
| R-4.2-5 | Medium | E2E-008, E2E-009, A11Y-001 | MEDIUM |

**Source**: `docs/qa/assessments/4.2-risk-20251002.md`

---

## Test Automation CI/CD Integration

### Pre-Merge Checks (GitHub Actions)
```yaml
# .github/workflows/story-4.2-tests.yml
name: Story 4.2 — Analytics Dashboard Tests

on:
  pull_request:
    paths:
      - 'apps/api/api/analytics/**'
      - 'apps/web/src/pages/AnalyticsPage.tsx'

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Run Backend Unit Tests
        run: poetry run pytest apps/api/tests/test_analytics.py --cov --cov-fail-under=85
      
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Run Frontend Unit Tests
        run: pnpm test -- AnalyticsPage.test.tsx --coverage --coverageThreshold=90
      
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Run E2E Tests
        run: pnpm test:e2e -- story-4.2.spec.ts
        
  security-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Session ID Hashing Verification
        run: poetry run pytest apps/api/tests/test_analytics.py::test_analytics_anonymizes_session_id
```

**Gate Criteria**: All jobs must PASS before merge allowed

---

## Known Limitations & Exclusions

### Out of Scope for Testing

1. **Data Persistence**: Dati volatili (R-4.2-1), test persistence differito a Phase 2
2. **Export Functionality**: CSV/PDF export non implementato in MVP
3. **Date Range Filters**: Filtri temporali avanzati non presenti
4. **Real-time Updates**: No WebSocket/SSE, solo refresh manuale
5. **Historical Trends**: No confronto performance storico (single-point data)

**Source**: `docs/stories/4.2.analytics-dashboard.md` L221-228

---

### Test Data Constraints

**Limitation**: Test con dati in-memory volatili significa:
- Mock stores devono essere popolati manualmente per ogni test
- Integration tests non possono verificare persistence cross-restart
- Performance tests limitati a singola sessione aggregation

**Mitigation**: Phase 2 con Supabase persistence abiliterà test più robusti

---

## Post-Implementation Checklist

### Pre-Merge Checklist
- [ ] Backend unit tests: 6/6 PASS, coverage ≥85%
- [ ] Frontend unit tests: 12/12 PASS, coverage ≥90%
- [ ] E2E tests: 10/10 PASS, duration < 45s
- [ ] Security review: Session ID hashing verified
- [ ] Performance benchmark: Aggregation < 500ms with 1000 messages
- [ ] Bundle size analysis: Recharts impact < +5KB gzip
- [ ] Accessibility audit: Zero critical violations (axe-core)
- [ ] Regression tests: Story 4.1 + 4.1.5 suites PASS

**Source**: `docs/qa/assessments/4.2-risk-20251002.md` L423-440

---

### Pre-Production Checklist
- [ ] APM monitoring configured (aggregation latency, API calls)
- [ ] Sentry error tracking active per `AnalyticsPage.tsx`
- [ ] Rate limiting verified in production environment
- [ ] Admin training: Limitazione dati volatili comunicata
- [ ] Phase 2 backlog ticket created: Supabase persistence
- [ ] Lighthouse score: Performance ≥90

**Source**: `docs/qa/assessments/4.2-risk-20251002.md` L447-455

---

## Test Metrics Summary

### Test Case Count
| Category | Count |
|----------|-------|
| Backend Unit Tests | 14 |
| Frontend Unit Tests | 11 |
| E2E Tests | 10 |
| Accessibility Tests | 3 |
| Performance Tests | 3 |
| Security Tests | 4 |
| Regression Tests | 3 |
| **TOTAL** | **48** |

---

### Estimated Test Duration
| Phase | Duration | Automation |
|-------|----------|------------|
| Backend Unit | 2-3 hours | Automated |
| Frontend Unit | 3-4 hours | Automated |
| E2E Tests | 2-3 hours | Automated |
| Specialized Tests | 2-4 hours | Mixed (manual + automated) |
| **TOTAL** | **9-14 hours** | ~80% automated |

---

### Coverage Goals
| Component | Target | Actual | Status |
|-----------|--------|--------|--------|
| Backend Analytics | ≥85% | TBD | ⏳ Pending |
| Frontend AnalyticsPage | ≥90% | TBD | ⏳ Pending |
| E2E Scenarios | 10/10 PASS | TBD | ⏳ Pending |

---

## Change Log

| Date | Author | Change Description |
|------|--------|-------------------|
| 2025-10-02 | QA Team | Initial test design — 48 test cases, 10 E2E scenarios |
| 2025-10-02 | QA Team | Security test SEC-001 elevated to CRITICAL priority (R-4.2-2) |
| 2025-10-02 | QA Team | Performance benchmark BT-020 scoped to 1000 messages (R-4.2-3) |

---

## Approval & Sign-Off

**QA Lead**: ⏳ Pending Review  
**Tech Lead**: ⏳ Pending Review  
**Product Owner**: ⏳ Pending Approval

**Ready for Implementation**: ✅ YES (conditional on prerequisiti completati)

---

## Appendix: Testing Tools & Setup

### Backend Testing Stack
- **Framework**: Pytest 7.x
- **HTTP Client**: HTTPX AsyncClient
- **Mocking**: `pytest-mock`, `monkeypatch`
- **Coverage**: `pytest-cov`
- **Benchmark**: `pytest-benchmark`

### Frontend Testing Stack
- **Framework**: Vitest
- **React Testing**: React Testing Library
- **Mocking**: `vi.mock()`, `vi.spyOn()`
- **Coverage**: Vitest coverage (Istanbul/c8)

### E2E Testing Stack
- **Framework**: Playwright
- **Browsers**: Chromium, Firefox, WebKit
- **Viewports**: 375px (mobile), 768px (tablet), 1280px (desktop)

### Accessibility Testing Tools
- **Automated**: axe-core, Playwright accessibility assertions
- **Manual**: NVDA/JAWS screen readers, keyboard-only navigation

### Performance Testing Tools
- **Bundle Analysis**: `webpack-bundle-analyzer`, `rollup-plugin-visualizer`
- **API Load Testing**: Apache Bench (`ab`), `wrk`
- **Lighthouse**: Lighthouse CI for Lighthouse scores

---

**Test Design Status**: ✅ COMPLETE  
**Total Test Cases**: 48  
**Estimated Test Effort**: 9-14 hours  
**Automation Rate**: ~80%  
**Next Step**: Implementation → Execution → Results Report

---

## References

### Primary Sources
- Story Document: `docs/stories/4.2.analytics-dashboard.md`
- Risk Profile: `docs/qa/assessments/4.2-risk-20251002.md`
- Recharts Guide: `docs/architecture/addendum-recharts-implementation-4.2.md`

### Related Test Designs
- Story 4.1 Test Design: `docs/qa/assessments/4.1-test-design-20251001.md`
- Story 3.4 Test Design: `docs/qa/assessments/3.4-test-design-20250929.md`

### Architecture & Standards
- Testing Strategy: `docs/architecture/sezione-11-strategia-di-testing.md`
- Security Guidelines: `docs/architecture/sezione-10-sicurezza-e-performance.md`

