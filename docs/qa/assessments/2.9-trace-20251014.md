# Requirements Traceability Matrix: Story 2.9 — Classification Performance Optimization

**Date:** 2025-10-14  
**Reviewer:** Quinn (Test Architect & Quality Advisor)  
**Story:** 2.9 — Classification Performance Optimization  
**Type:** Requirements Traceability Analysis

---

## Executive Summary

### Coverage Summary

- Total Acceptance Criteria: 6  
- Fully Covered: 2  
- Partially Covered: 4  
- Not Covered: 0  
- Total Referenced Tests: 10 (unit + integration)  
- External Validation: 1 perf report (cache cold → not meeting P95 target)

### Coverage Status by AC

| AC | Requirement | Coverage | Test Level | Status |
|----|-------------|----------|------------|--------|
| AC1 | Redis cache implementation (key/hash/TTL/metrics) | FULL | Unit + Integration | ✅ PASSED |
| AC2 | Performance improvement (P95 < 2s with cache hit) | PARTIAL | Perf (k6) | ⚠️ Cold cache; warmup missing |
| AC3 | Configurability & operatività (env flags, invalidation) | PARTIAL | Unit | ⚠️ Feature flag tested; invalidation endpoint untested |
| AC4 | Monitoring & observability (events + stats endpoint) | PARTIAL | Unit | ⚠️ Metrics collected; endpoint coverage missing |
| AC5 | Testing & validation (unit/integration/perf) | PARTIAL | Unit + Integration + Perf | ⚠️ Perf needs warmup; full regression pending |
| AC6 | Backwards compatibility (flag off, no break) | FULL | Integration | ✅ PASSED |

Overall: Coverage is sufficient for functionality; performance target awaits process change (warmup) and endpoint coverage additions.

---

## Detailed Requirement Mappings

### AC1: Redis Cache Implementation

Definition: Implement cache layer with TTL, deterministic key (SHA-256 on text+metadata), metrics hit/miss, graceful degradation.

Implementation Trace:
- apps/api/api/knowledge_base/classification_cache.py:1
- apps/api/api/knowledge_base/classifier.py: classification lookup/store integration
- apps/api/api/config.py: settings `classification_cache_*`

Tests:
- apps/api/tests/test_classification_cache.py:1
  - test_cache_store_and_retrieve_hit_rate
  - test_cache_ttl_expiration
  - test_cache_hash_determinism
  - test_cache_clear_flushes_all_entries
  - test_cache_gracefully_handles_redis_errors
  - test_metadata_variation_changes_digest
- apps/api/tests/test_classification_cache_pipeline.py:1
  - test_classification_pipeline_caches_result

Given-When-Then Examples:
- Given text+metadata identical, When classify invoked twice, Then second call hits cache and chain invokes once (apps/api/tests/test_classification_cache_pipeline.py:1).
- Given TTL=1s, When time advances by 5s, Then cached entry expires and get() returns None (apps/api/tests/test_classification_cache.py:1).

Coverage: FULL ✅

---

### AC2: Performance Improvement

Definition: Cache-hit latency <100ms; sync-jobs P95 <2s with 300 requests; miss unchanged.

Evidence:
- Unit metrics collection present via `record_latency` and `get_stats()` (classification_cache.py:1).
- Perf report: reports/metrics-p95-20251014-post-cache.md:1 → P95 59.98s due to cold cache (all misses).

Given-When-Then Example:
- Given warm cache for repeated documents, When load test runs with same batch, Then hit-rate >90% and overall P95 <2s. (Pending execution; needs warmup step.)

Coverage: PARTIAL ⚠️ (mechanism ready, perf scenario missing warmup)

---

### AC3: Configurabilità & Operatività

Definition: Env vars `CLASSIFICATION_CACHE_ENABLED` (default true), `CLASSIFICATION_CACHE_TTL_SECONDS` (default 604800); manual invalidation endpoints.

Implementation Trace:
- apps/api/api/config.py:1 (settings)
- apps/api/api/routers/admin.py: cache invalidate/flush/stats endpoints

Tests:
- apps/api/tests/test_classification_cache.py:1 → test_get_classification_cache_respects_env

Coverage Notes:
- Feature flag behaviour covered at integration level: apps/api/tests/test_classification_pipeline_respects_feature_flag (apps/api/tests/test_classification_cache_pipeline.py:1)
- Invalidation endpoints are implemented but not covered by tests.

Coverage: PARTIAL ⚠️ (add endpoint tests)

---

### AC4: Monitoring & Observability

Definition: Structured logging events (`classification_cache_hit|miss|error`) and metrics endpoint (p50/p95 hit/miss, hit rate, cache size, redis availability).

Implementation Trace:
- apps/api/api/knowledge_base/classification_cache.py:1 (events + metrics aggregation)
- apps/api/api/routers/admin.py: stats endpoint

Tests:
- apps/api/tests/test_classification_cache.py:1 → test_latency_stats_collection

Coverage: PARTIAL ⚠️ (endpoint JSON contract not asserted in tests)

---

### AC5: Testing & Validation

Definition: Unit tests for mechanics, integration for pipeline, perf test rerun with P95 target, documentation of results.

Evidence:
- Unit: apps/api/tests/test_classification_cache.py: all core behaviours
- Integration: apps/api/tests/test_classification_cache_pipeline.py: cache usage in classify_content_enhanced
- Perf: reports/metrics-p95-20251014-post-cache.md: run executed, warmup missing

Coverage: PARTIAL ⚠️ (perf rerun after warmup pending; full suite regression pending per story)

---

### AC6: Backwards Compatibility

Definition: No external API breaking changes; rollback via `CLASSIFICATION_CACHE_ENABLED=false` with no side effects; tests pass.

Tests:
- apps/api/tests/test_classification_cache_pipeline.py:1 → test_classification_pipeline_respects_feature_flag (no caching when disabled)

Coverage: FULL ✅ (API unchanged; feature flag verified)

---

## Trace Matrix (Summary)

- Requirements → Implementation → Tests → Evidence/Status consistently mapped per AC. Gaps are limited to endpoint coverage (AC3/AC4) and perf scenario warmup (AC2/AC5).

---

## Gaps & Recommendations

1) Add integration tests for admin cache endpoints (DELETE by digest, DELETE flush, GET stats) asserting authz and JSON schema.  
2) Update `scripts/perf/run_p95.ps1` to include warmup stage, verify hit-rate >90% via stats endpoint before load.  
3) Optional: add healthcheck for Redis DB1 and failure injection tests to assert graceful degradation logs.

---

## Gate YAML (copy/paste)

```yaml
trace:
  totals:
    requirements: 6
    full: 2
    partial: 4
    none: 0
  planning_ref: 'docs/qa/assessments/2.9-test-design-20251014.md'
  uncovered: []
  notes: 'See docs/qa/assessments/2.9-trace-20251014.md for mappings and gaps.'
```

---

## Update 2025-10-14 (dettagliato)

- Ricalcolata copertura: 2 FULL (AC1, AC6), 4 PARTIAL (AC2–AC5) coerente con evidenze attuali.  
- Aggiunto Gate YAML per import rapido nel file gate della story.  
- Confermate azioni: warmup nel perf runner, test integrazione endpoints admin, verifica schema JSON stats.
