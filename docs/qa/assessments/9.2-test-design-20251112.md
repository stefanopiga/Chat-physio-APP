# Test Design: Story 9.2

Date: 2025-11-12
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 22
- Unit tests: 8 (36%)
- Integration tests: 8 (36%)
- E2E tests: 6 (27%)
- Priority distribution: P0: 6, P1: 10, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Backend endpoint implements GET /history/full with params, schema, JWT, rate limit, pagination

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-UNIT-001  | Unit        | P0       | Validate request/response Pydantic models serialize ok   | Pure schema validation                 |
| 9.2-INT-001   | Integration | P0       | Endpoint 200 returns messages,total_count,has_more       | Service+DB interaction                 |
| 9.2-INT-002   | Integration | P1       | Enforce defaults: limit=100, offset=0                    | Param parsing + defaulting             |
| 9.2-INT-003   | Integration | P0       | 401 without/invalid JWT                                  | Auth dependency                         |
| 9.2-INT-004   | Integration | P1       | Rate limit 60 req/min per session (returns 429)          | Middleware behavior                     |

### AC2: Endpoint uses ConversationPersistenceService.load_session_history()

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-UNIT-002  | Unit        | P1       | Service called with correct args (sessionId,limit,offset)| Unit mock verify invocation             |
| 9.2-INT-005   | Integration | P1       | Filters archived messages per metadata                   | DB query correctness                    |
| 9.2-INT-006   | Integration | P1       | Ordered by created_at ASC                                | Ordering guarantees                     |

### AC3: Frontend apiClient.getSessionHistory() with typing and error handling

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-UNIT-003  | Unit        | P1       | Returns typed response on 200                            | Pure function behavior (mock fetch)     |
| 9.2-UNIT-004  | Unit        | P1       | Handles 404 by returning empty result                    | Error handling path                     |
| 9.2-UNIT-005  | Unit        | P1       | On 401 triggers redirect and throws                      | Security flow                           |
| 9.2-UNIT-006  | Unit        | P2       | Retry with backoff on network error (max 3)              | Algorithmic backoff                     |
| 9.2-UNIT-007  | Unit        | P2       | Honors Retry-After header on 429                         | Policy compliance                       |

### AC4: ChatPage loads history on init with graceful degradation and loading indicator

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-INT-007   | Integration | P1       | useEffect loads on mount; messages set; spinner toggles  | Component+service interaction           |
| 9.2-E2E-001   | E2E         | P1       | App reopen renders prior history                         | Critical user journey                   |

### AC5: Historical messages render identically with citations preserved

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-INT-008   | Integration | P1       | MessageBubble renders stored messages                    | UI+data integration                     |
| 9.2-E2E-002   | E2E         | P1       | Citations popover opens and links source chunks          | UX critical                             |

### AC6: Feature flag ENABLE_PERSISTENT_MEMORY controls behavior

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-UNIT-008  | Unit        | P1       | Flag false: skip history load without error              | Simple conditional logic                |
| 9.2-E2E-003   | E2E         | P2       | Flag toggle reflects in app behavior                     | End-to-end environment behavior         |

### AC7: Robust error handling (network, 401, 404, 500)

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-INT-009   | Integration | P1       | Network error triggers retry/backoff path                | Behavior across layers                  |
| 9.2-E2E-004   | E2E         | P1       | 500 shows toast, app remains usable                      | User-visible resilience                 |
| 9.2-E2E-005   | E2E         | P2       | 404 new session yields empty state without error         | UX correctness                          |

### AC8: Performance optimized with pagination and virtual scrolling

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-INT-010   | Integration | P1       | loadMoreHistory appends without duplicates               | Stateful merge                          |
| 9.2-INT-011   | Integration | P1       | has_more toggles correctly based on count/offset         | Pagination control                      |
| 9.2-E2E-006   | E2E         | P2       | Virtual list performs with >50 messages                  | UX performance                          |

### AC9: Testing coverage minimums

| ID            | Level       | Priority | Test                                                     | Justification                         |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------------- |
| 9.2-INT-012   | Integration | P1       | Backend unit+int tests exist for endpoint                 | Coverage enforcement                    |
| 9.2-UNIT-009  | Unit        | P1       | Vitest for hook covers success/empty/error               | FE coverage                             |

## Risk Coverage

- TECH-001 covered by 9.2-INT-010, 9.2-INT-011
- DATA-001 covered by 9.2-INT-010 (dedupe), 9.2-INT-011 (stable paging)
- PERF-001 covered by 9.2-E2E-006; measure render FPS
- SEC-001 covered by 9.2-INT-003 (401), FE redirect checks
- OPS-001 covered by 9.2-INT-004 (rate limiting)

## Recommended Execution Order

1. P0 Unit tests (models, auth)
2. P0 Integration tests (endpoint happy path, JWT, rate limit)
3. P0 E2E (reopen app history)
4. P1 tests (broader scenarios)
5. P2 tests (performance, toggles)
