# Risk Profile: Story 6.1

Date: 2025-10-17
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 16
- Critical Risks: 2
- High Risks: 6
- Risk Score: 58/100

## Critical Risks Requiring Immediate Attention

### 1. TECH-001: Divergenza comportamentale Watcher con feature flag disattivo

Score: 9 (Critical)
Probability: High — rischio elevato di regression se il percorso legacy non resta identico alla 5.x
Impact: High — ingest errata o duplicata, incoerenza chunking in produzione
Mitigation:
- Test di compatibilità legacy (AC5) con snapshot/output parity pre-6.1
- Golden dataset e confronto byte-for-byte sugli output dei chunk e metadati
- Canary in staging con confronto metrica di fallback e distribuzione strategie
Testing Focus: test comparativi OFF-flag vs versione precedente; integrazione end-to-end watcher

### 2. PERF-001: Latenza e saturazione dovute alla classificazione LLM

Score: 9 (Critical)
Probability: High — classificazione on-by-default e cache non ancora warm
Impact: High — rallentamenti ingest, backlog coda watcher, possibili timeout
Mitigation:
- Cache Redis abilitata e monitorata (hit-rate ≥40%)
- Timeout rigoroso (10s) con fallback e log; batch size e backoff
- Rollout graduale e flag per disabilitazione rapida
Testing Focus: test di timeout e carico con documenti eterogenei; misurazione p50/p95/p99; hit-rate cache

## Risk Matrix

| Risk ID   | Description                                                       | Probability | Impact | Score | Priority |
|-----------|-------------------------------------------------------------------|-------------|--------|-------|----------|
| TECH-001  | Legacy parity con flag OFF può rompere comportamenti esistenti    | High (3)    | High (3) | 9   | Critical |
| PERF-001  | Latenza/saturazione dovute a LLM classification                   | High (3)    | High (3) | 9   | Critical |
| OPS-001   | Governance classificazione solo su file nuovi/modificati          | High (3)    | Medium (2) | 6 | High     |
| DATA-001  | Metadata incompleti/errati propagati dal DocumentExtractor        | Medium (2)  | High (3) | 6   | High     |
| TECH-002  | Integrazione DocumentExtractor nel watcher (eccezioni, formati)   | Medium (2)  | High (3) | 6   | High     |
| OPS-002   | Osservabilità incompleta su metriche obbligatorie (AC7)           | Medium (2)  | High (3) | 6   | High     |
| SEC-001   | Esposizione dati sensibili nei log strutturati                    | Medium (2)  | Medium (2) | 4 | Medium   |
| PERF-002  | Cache Redis non disponibile o con bassa hit-rate                  | Medium (2)  | Medium (2) | 4 | Medium   |
| TECH-003  | Routing errato per soglia confidenza e mapping strategie          | Medium (2)  | Medium (2) | 4 | Medium   |
| BUS-001   | Documentazione non allineata crea false aspettative               | Medium (2)  | Medium (2) | 4 | Medium   |
| OPS-003   | Alert mancanti o soglie improprie (false positive/negative)       | Medium (2)  | Medium (2) | 4 | Medium   |
| DATA-002  | Duplicazione chunk/ingestion se watcher rielabora invariati       | Low (1)     | High (3) | 3  | Low      |
| SEC-002   | Uso API LLM con contenuti confidenziali senza policy/PII scrub    | Low (1)     | High (3) | 3  | Low      |
| TECH-004  | Dipendenze di terze parti (PyMuPDF, python-docx) instabilità      | Low (1)     | Medium (2) | 2 | Low      |
| OPS-004   | Rollback non testato per flag/variabili env                       | Low (1)     | Medium (2) | 2 | Low      |
| PERF-003  | Strategy distribution sbilanciata → eccesso fallback              | Low (1)     | Medium (2) | 2 | Low      |

## Risk Distribution

- Security: 2 (0 critical)
- Performance: 3 (1 critical)
- Data: 2 (0 critical)
- Business: 1 (0 critical)
- Operational: 4 (0 critical)
- Technical: 4 (1 critical)

## Detailed Risk Register

TECH-001 — Legacy parity OFF-flag
- Description: il percorso con `WATCHER_ENABLE_CLASSIFICATION=false` deve replicare fedelmente la 5.x
- Components: watcher.py, chunk_router.py
- Detection: differenze su output parity e log
- Mitigation: test comparativi, golden dataset, canary, rollback

PERF-001 — LLM latency/saturation
- Description: tempi di classificazione e timeout con cold cache
- Components: classifier.py, Redis, watcher
- Mitigation: cache efficace, timeout, backoff, rollout graduale

OPS-001 — Governance “solo nuovi/modificati”
- Description: rischio di riclassificare tutto ad ogni scan
- Components: file inventory/hash, watcher scheduling
- Mitigation: hashing/inventory affidabili, skip invariati, audit log

DATA-001 — Metadata incompleti/errati
- Description: conteggio immagini/tabelle inconsistenti
- Components: DocumentExtractor, propagazione metadata
- Mitigation: test su PDF/DOCX/TXT, validazioni, fallback

TECH-002 — Integrazione estrazione
- Description: eccezioni formati/driver; gestione errori
- Components: DocumentExtractor
- Mitigation: try/except, tipi supportati, fallback, logging

OPS-002 — Osservabilità incompleta
- Description: metriche AC7 non tutte emesse o aggregazioni errate
- Components: watcher_metrics.py, logging
- Mitigation: contract di metriche, test di log/metrics, dashboard

SEC-001 — Logging di dati sensibili
- Description: path/nome file sensibili o contenuti nei log
- Components: logger, payload redaction
- Mitigation: redazione e masking, policy logging, revisione

PERF-002 — Cache inefficace/indisponibile
- Description: bassa hit-rate o Redis down
- Components: Redis, classification_cache
- Mitigation: graceful degradation, circuit breaker, alert su hit-rate

TECH-003 — Mapping strategie/threshold
- Description: confidenza <0.7 e mapping errati a strategy_name
- Components: chunk_router, watcher
- Mitigation: test parametrici, logging strategy distribution, assert

BUS-001 — Documentazione non allineata
- Description: confusione tra pipeline A/B
- Components: architecture docs
- Mitigation: confronto, tabella features, diagrammi, link incrociati

OPS-003 — Alert soglie improprie
- Description: alert rumorosi o mancati incidenti
- Components: alerting config
- Mitigation: tuning soglie, runbook, SLO validation script

DATA-002 — Duplicazione ingest
- Description: re-scan di invariati genera duplicati
- Components: hashing/index
- Mitigation: dedup, idempotenza salvataggio, inventory coerente

SEC-002 — Policy LLM/PII
- Description: invio contenuti confidenziali al modello
- Components: classifier integration
- Mitigation: policy, filtri PII, dataset esclusi, provider conf.

TECH-004 — Dipendenze estrazione
- Description: aggiornamenti PyMuPDF/python-docx rompono parsing
- Components: dependencies
- Mitigation: version pinning, smoke test, lockfile

OPS-004 — Rollback/flag
- Description: variabili env non propagate o rollback non testato
- Components: config.py, .env, deploy
- Mitigation: checklist rollout/rollback, test in staging

PERF-003 — Fallback ratio alto
- Description: classificazione porta spesso a fallback
- Components: classifier/router
- Mitigation: tuning prompt/modello, osservazione distribuzioni

## Risk-Based Testing Strategy

Priority 1 (Critical)
- Legacy parity OFF-flag: test comparativi E2E con golden dataset
- LLM latency: test di carico e timeout; misurazione p50/p95/p99; resilienza cache

Priority 2 (High)
- Governance nuovi/modificati: test su inventory/hash e skip invariati
- Metadata estrazione: PDF/DOCX/TXT con fixture; assert counts
- Osservabilità: assert su log/metriche richieste da AC7

Priority 3 (Medium/Low)
- Security logging: test redaction
- Cache failure: test degradazione senza Redis
- Mapping strategie: test parametrici su structure_type/confidence

## Risk Acceptance Criteria

- Must Fix: tutti i Critical (score 9) prima del deploy
- Deploy con Mitigazione: High con controlli e monitoraggio attivi
- Accepted: Medium/Low documentati nel gate con owner e follow-up

## Monitoring Requirements

- Performance: latenza classificazione (p50/p95/p99), throughput watcher
- Security: audit logging senza dati sensibili
- Ops: fallback ratio, failure rate classificazione, cache hit-rate
- Business: trend distribuzione strategie vs qualità retrieval

## Risk Review Triggers

- Cambi significativi a DocumentExtractor/classifier/router
- Cambi a soglia confidenza o mapping strategie
- Nuove integrazioni, variazioni di carico, incidenti performance

---

# risk_summary (paste into gate file)
risk_summary:
  totals:
    critical: 2
    high: 6
    medium: 6
    low: 2
  highest:
    id: TECH-001
    score: 9
    title: "Legacy parity OFF-flag può rompersi"
  recommendations:
    must_fix:
      - "Test comparativi legacy OFF-flag + golden dataset"
      - "Mitigazioni performance/timeout per classificazione"
    monitor:
      - "Hit-rate cache ≥40% e fallback ratio <15%"
      - "Alert p95 >5s e failure rate classificazione >10%"

```
Risk profile: qa.qaLocation/assessments/6.1-risk-profile-20251017.md
```

