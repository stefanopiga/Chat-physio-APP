# Risk Profile — Story 5.2: FastAPI Modularization & Architecture Refactoring

Date: 2025-10-08
Reviewer: Quinn (Test Architect)

## Metadata
- **ID**: 5.2  
- **Tipo**: Technical Debt / Architecture  
- **Epic**: Epic 5 — DevOps & Maintainability  
- **Priorità**: P1 - High  
- **Complessità**: High  
- **Stima sforzo**: 16–24 ore  
- **Stato**: Draft

Fonti: `docs/stories/5.2-fastapi-modularization-architecture-refactoring.md`.

---

## Executive Summary

- **Totale rischi identificati**: 11  
- **Critical**: 1  
- **High**: 4  
- **Medium**: 5  
- **Low**: 1  
- **Overall Risk Score**: 41/100 (Medium) — refactoring esteso con potenziale regressione; mitigabile con test di parità, CI rigorosa e gate documentali.

**Raccomandazione**: Conditional PASS — procedere solo con: (1) parità API verificata (AC8), (2) test coverage ≥85%, (3) documentazione aggiornata e coerente, (4) finestra di merge freeze coordinata.

---

## Estratti con riferimenti al sorgente

### Risks dichiarati nella storia (linee 1298–1325)
```1298:1325:docs/stories/5.2-fastapi-modularization-architecture-refactoring.md
## Risks

| ID | Description | Probability | Impact | Mitigation |
|----|-------------|-------------|--------|------------|
| R-5.2-1 | Breaking changes accidentali durante refactoring | Media | Alto | Test suite completa + E2E regression tests pre-merge |
| R-5.2-2 | Import circolari tra routers/services | Bassa | Medio | Dependency injection pattern + review struttura import |
| R-5.2-3 | Performance degradation da layer aggiuntivi | Bassa | Basso | Profiling pre/post refactoring + monitoring deployment |
| R-5.2-4 | Inconsistenza documentazione architettura | Media | Medio | Checklist aggiornamento docs obbligatorio + review |
| R-5.2-5 | Merge conflicts con feature branches attive | Alta | Medio | Comunicazione team + merge freeze durante refactoring |
| R-5.2-6 | OpenAPI schema drift e assenza di governance contratti | Media | Alto | Gate su diff OpenAPI (solo descrizioni/tags consentite), policy versioning e deprecation secondo addendum Enterprise Standards |
```

### Acceptance su compatibilità retrocompatibile (linee 368–391)
```368:391:docs/stories/5.2-fastapi-modularization-architecture-refactoring.md
### AC8: Backward Compatibility Mantenuta
**Given** il refactoring modifica struttura interna  
**When** il refactoring viene completato  
**Then** TUTTI gli endpoint esistenti rispondono con stesso comportamento  
**And** contratti API (request/response) non sono modificati  
**And** test E2E esistenti passano senza modifiche  
**And** nessuna breaking change per frontend o client API

**Verifica**:
```bash
# 1. Test suite esistenti passano
cd apps/api && poetry run pytest tests/ -v

# 2. Test E2E frontend passano
cd apps/web && pnpm test:e2e

# 3. OpenAPI schema compatibile
# (Comparare schema pre/post refactoring)
curl http://localhost/docs/openapi.json > schema_post.json
diff schema_pre.json schema_post.json
```
```

---

## Risk Distribution

### By Category
- Security: Low  
- Performance: Low  
- Data/Contracts: High  
- Business/Operational: Medium  
- Architectural/Code Quality: High

### By Component
- Backend: High (routers/services/schemas modularization)  
- Frontend: Medium (dipende da OpenAPI parity)  
- Database: Low (nessun cambiamento previsto)  
- Infrastructure: Low (no infra changes diretti)

---

## Detailed Risk Register

Legenda: Probability/Impact → Bassa/Media/Alta. Score: 2=Low, 4=Medium, 6=High, 9=Critical.

| Risk ID | Title | Probability | Impact | Score | Priority | Mitigation | Validation Hooks | Sources |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| ARCH-5.2-001 | Endpoint regressions / breaking changes post-modularizzazione | Media | Alto | 9 | Critical | Baseline snapshot + parity tests; E2E invariance; schema diff | Baseline capture → parity diff; E2E suite green; OpenAPI diff 0 | AC8; Risks R-5.2-1 |
| ARCH-5.2-002 | Import circolari tra `routers/`, `services/`, `schemas/` | Bassa | Medio | 4 | Medium | Dependency boundaries; `TYPE_CHECKING`; avoid cross-layer imports | Static check with `mypy`; runtime import smoke | Risks R-5.2-2 |
| ARCH-5.2-003 | Copertura test < 85% → regressioni non rilevate | Media | Alto | 6 | High | Ricollocare/espandere test per modulo; coverage gate in CI | `pytest --cov` ≥85%; CI fail sotto soglia | DoD Testing; Phase 6 |
| ARCH-5.2-004 | Schema OpenAPI drift → rottura FE/SDK | Media | Alto | 6 | High | Snapshot pre/post; contract tests; approval gate su diff | `diff schema_pre.json schema_post.json` ammesso solo in descrizioni/tags | AC8 |
| ARCH-5.2-005 | Misconfig DI (`get_settings`, `verify_jwt_token`) → auth failure | Media | Alto | 6 | High | Centralizzare `dependencies.py`; test DI override; secrets via env | Unit su dependencies; e2e auth flows | AC5; Phase 1.3 |
| ARCH-5.2-006 | Rate limiting non agganciato ai routers → 429 erratici o no-RL | Bassa | Medio | 4 | Medium | Singola istanza `limiter` in `app.state`; decorators corretti | Smoke su endpoints RL; log di SlowAPI | Phase 5.2 (main), Notes SlowAPI |
| ARCH-5.2-007 | Inconsistenza documentazione architettura | Media | Medio | 4 | Medium | Checklist docs; grep refs vecchia struttura; PR review docs | Grep `routers/` refs ≥ target; 0 ricorrenze monolite | AC7; Risks R-5.2-4 |
| ARCH-5.2-008 | Merge conflicts con branch attivi | Alta | Medio | 6 | High | Merge freeze + comunicazione; branch per refactor; rebase frequente | No conflicts al merge; changelog aggiornato | Risks R-5.2-5; Pre-Implementation |
| ARCH-5.2-009 | Degradazione performance per middleware/layer extra | Bassa | Basso | 2 | Low | Profiling pre/post; monitoraggio 48h; rollback plan | Latency p95 no-regress; CPU/mem stabili | Risks R-5.2-3; Phase 8.3 |
| ARCH-5.2-010 | Fixtures/test runner fragili dopo ristrutturazione cartelle | Bassa | Medio | 4 | Medium | `apps/api/tests/{routers,services}`; `conftest.py` consolidato | Suite verde locale + CI | AC6; Phase 6 |
| ARCH-5.2-011 | Governance contratti OpenAPI insufficiente (versioning/deprecation) | Media | Alto | 6 | High | Gate su diff OpenAPI (solo descrizioni/tags); policy di versioning e deprecation conformi a addendum Enterprise Standards | Gate contratti in CI; review su change-log dello schema; referenza addendum enterprise | Risks R-5.2-6 |

---

## Risk-Based Testing Strategy

1) Contract Parity & Backward Compatibility  
- Cattura baseline pre-refactor: responses e OpenAPI (`schema_pre.json`).  
- Post-refactor: parity runner su tutti gli endpoint; diff OpenAPI ammesso solo in descrizioni/tags.  
- Gate: FAIL se qualsiasi differenza strutturale (path, method, status, fields) — copre ARCH-5.2-001, ARCH-5.2-004.

2) Test Suite Organization & Coverage  
- Spostare test in `tests/routers/` e `tests/services/`; aggiungere casi mancanti.  
- Gate: coverage ≥85% (target 90%+) — copre ARCH-5.2-003, ARCH-5.2-010.

3) Dependency Injection & Security  
- Unit su `dependencies.py`: `verify_jwt_token`, `_is_admin`, `get_settings`.  
- Test override dependencies in integrazione. — copre ARCH-5.2-005.

4) Rate Limiting  
- Smoke su endpoints rate-limited; verifica handler eccezioni `RateLimitExceeded`. — copre ARCH-5.2-006.

5) Performance/Observability  
- Misurare latency p50/p95 pre/post (10 minuti di carico leggero).  
- Verificare logging JSON coerente; overhead accettabile. — copre ARCH-5.2-009.

6) Documentation Consistency  
- Grep documentazione: rimuovere riferimenti a monolite; aggiungere percorsi `routers/`, `services/`, `schemas/`. — copre ARCH-5.2-007.

---

## Monitoring Requirements (Post-Deployment 48h)

- Error rate API < 1%  
- Latency p95 non regressa (> +10% rispetto baseline)  
- Memoria container stabile (no spike persistenti)  
- Log `app_started` con elenco routers presenti  
- All E2E front-end tests green in pipeline notturna

---

## Gate YAML Block

```yaml
risk_summary:
  totals:
    critical: 1
    high: 4
    medium: 5
    low: 1
  recommendations:
    must_fix:
      - ARCH-5.2-001  # Endpoint regressions / breaking changes
      - ARCH-5.2-003  # Coverage gate ≥85%
      - ARCH-5.2-004  # OpenAPI schema parity
      - ARCH-5.2-005  # DI/Auth configuration stability
      - ARCH-5.2-011  # OpenAPI governance (versioning/deprecation policy)
    monitor:
      - ARCH-5.2-006
      - ARCH-5.2-007
      - ARCH-5.2-008
      - ARCH-5.2-009
      - ARCH-5.2-010
  decision: CONCERNS
  rationale: "Large-scale refactor with medium systemic risk; proceed with parity and coverage gates."
```

---

## Review Hook

```
Risk profile: docs/qa/assessments/5.2-fastapi-modularization-architecture-refactoring-risk-20251008.md
```

---

## Sources

- `docs/stories/5.2-fastapi-modularization-architecture-refactoring.md` (contenuti citati)  
- `docs/architecture/addendum-fastapi-best-practices.md` (pattern routers/services/schemas)  
- `docs/qa/assessments/5.1-risk-profile.md` (stile e citazioni)  

---

## Change Log

| Date | Author | Change Description |
|------|--------|-------------------|
| 2025-10-08 | QA Team | Initial risk profile — Story 5.2 |
| 2025-10-08 | QA Team | Aggiornato con R-5.2-6 (OpenAPI governance) e conteggi rivisti |


