# Story Draft Validation: 8.7 – Supabase Schema Reverse Engineering

Date: 2025-11-11
Validator: Sarah (Product Owner)
Story: docs/stories/8.7-supabase-schema-reverse-engineering.md

## Template Compliance Issues

- Template alignment: Story is a process/operational story; it does not follow a strict user-story template. However, it contains clear sections (Context/Problem, Solution, Steps, Validation, Outputs, Gate Criteria, Notes) sufficient for implementation.
- Missing sections vs typical story template: No explicit “Acceptance Criteria” section; ACs are derivable from Hard Stops, Validation, and Gate Criteria.
- Placeholders: None found. Dates, environment notes, and paths are concrete.

## Critical Issues (Must Fix - Story Blocked)

- None blocking. The story is implementable as written. ACs should be made explicit for clarity (see Should-Fix).

## Should-Fix Issues (Important Quality Improvements)

- Acceptance Criteria explicitness: Promote “Hard Stop Conditions”, “Security Checklist”, “Validation” bullets into an explicit “Acceptance Criteria” section to aid traceability and gating.
- Output artifact naming: Standardize final filename consistently as `supabase/sql_unico/00_consolidated_schema_v2_VERIFIED.sql` (story mentions both _GENERATED and _VERIFIED in places; ensure final converge and rename step is explicit).
- Traceability: Include a brief “Why now/Dependencies” note referencing any upstream docs or epic to improve context linkage.

## Nice-to-Have Improvements (Optional Enhancements)

- Add a short rollback note for replacing an incorrect dump (restore previous v1_BACKUP.sql) to streamline recovery.
- Include a minimal sample query list to validate key objects (one-liners for indexes, policies), to speed up manual validation.

## Anti-Hallucination Findings

- Claims are grounded in concrete Supabase CLI operations and standard Postgres concepts (extensions, RLS, HNSW index). No invented libraries.
- File paths and tools used (PowerShell, Git hooks, GitHub Actions) match repo structure and prior stories.
- External references provided (Supabase CLI docs, PostgreSQL docs) align with described steps.

## File Structure and Source Tree Validation

- Paths used exist or are conventional within this repo: `supabase/sql_unico/`, `scripts/`, `.github/workflows/`.
- Script locations are consistent with `scripts/` usage in repo. No conflicting directory guidance detected.
- No new directories required beyond `supabase/sql_unico/` (already implied); confirm folder exists or is created when running steps.

## Acceptance Criteria Satisfaction Assessment

Derived ACs from story content (to be optionally promoted into an AC section):

1) Dump is schema-only: no INSERT/COPY statements; file size reasonable (<100KB) – Hard Stop.
2) Direct DB connection on port 5432 is used; not pooled 6543 – Hard Stop.
3) No secrets/identifiers leak in dump; secret scan clean – Hard Stop.
4) Required objects present: vector extension, required tables, HNSW index with parameters, functions, triggers.
5) RLS enabled on sensitive tables; policies present and appropriate – Hard Stop if missing.
6) GRANTs for `service_role` complete across schema/tables/sequences/functions.
7) Dump applies on a clean local DB without errors; tables appear as expected.
8) Key functions compile and callable (e.g., match_document_chunks).
9) HNSW index visible with expected parameters via pg_indexes.
10) CLI version pinned and recorded in metadata file.
11) Diff vs db pull shows no material gaps (format/order differences acceptable).
12) Pre-commit and CI validations block bad dumps.

Assessment: The story’s steps and validation instructions, plus the proposed scripts, are sufficient to satisfy these ACs. Mapping to tests is available in docs/qa/assessments/8.7-test-design-20251111.md.

## Validation and Testing Instructions Review

- Clear validator script is provided with concrete checks and failure behavior.
- Manual validation checklists are thorough (extensions, tables, indexes, RLS, GRANTs, functions, triggers).
- Tools are specified (Supabase CLI, PowerShell, psql, Git hooks, GitHub Actions).
- Test data requirements: none (schema-only). Local Supabase stack used for application tests.

## Security Considerations Assessment

- Strong security posture: direct connection requirement, schema-only constraint, secret scanning, RLS enablement/policies as hard stops, GRANT validation.
- No handling of live credentials in repo; guidance emphasizes scanning and removal.

## Tasks/Subtasks Sequence Validation

- Logical flow: prerequisites → dump → validate → clean → apply locally → validate vs prod → package final file → automation hooks.
- Dependencies clear: CLI installed and logged in; direct DB URL; local Supabase for application tests.
- Granularity: actionable steps with commands and validation points.

## Dev Agent Implementation Readiness

- Instructions are unambiguous and self-contained for a development agent.
- All required technical details (commands, paths, checks) are present.
- Minimal additional context needed beyond ensuring environment variables and CLI availability.

## Final Assessment

- GO
- Implementation Readiness Score: 8/10
- Confidence Level: High

## Gate Block (optional paste)

Suggested ACs to add under an explicit Acceptance Criteria section and tie to Gate Criteria:

- AC1: Schema-only dump (no INSERT/COPY), secrets-free, <100KB
- AC2: Direct connection (5432) used for dump
- AC3: Required objects present (extensions/tables/indexes/functions/triggers)
- AC4: RLS enabled + policies present on sensitive tables
- AC5: GRANTs for service_role complete
- AC6: Clean apply on local DB; post-apply validations pass
- AC7: CLI version pinned and recorded; diff vs db pull has no material gaps
- AC8: Pre-commit and CI validations block non-compliant dumps

