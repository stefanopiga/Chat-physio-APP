# Risk Profile – Story 2.8.1: Secret Governance e Resilienza Servizi Esterni

Data: 2025-10-14 (QA update: 2025-10-14 11:15 CET)  
Revisore: Quinn (Test Architect & Quality Advisor)

## Executive Summary

- Rischi attivi totali: 7  
- Critici: 0, Alti: 3, Medi: 4, Bassi: 0  
- Risk Score complessivo: 65/100 (High×10 + Medium×5)  
- Principali esposizioni: governare i secrets senza audit consolidato, resilienza reale verso downtime/rate limit OpenAI/Supabase, affidabilità delle metriche P95 e automazione health check.

### Riepilogo per Gate (`risk_summary`)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 4
    low: 0
  highest:
    id: SEC-301
    score: 6
    title: "Secret governance incompleta: vault e pipeline scanner non convalidati"
  recommendations:
    must_fix:
      - "Completare configurazione vault/secrets manager con audit trail e report scanner archiviato prima di riaprire il gate."
      - "Eseguire drill di resilienza per quota OpenAI e downtime Supabase con log evidenziando retry/backoff e recovery time."
      - "Ottenere campione P95 ≥300 richieste e confronto ≤10% con dashboard Supabase, allegando evidenze e issue in caso di delta."
    monitor:
      - "Automatizzare scheduler health check e verificare che le differenze tra run vengano analizzate (diff dei log)."
      - "Allineare dashboard monitor con alert su quota/429/5xx e ownership responsabile della sorveglianza."
```

## Contesto Aggiornato

- La Story 2.8 resta in stato CONCERNS; questa storia mira a produrre le evidenze operative mancanti prima di passare al dev principale.
- Documenti chiave: `docs/stories/2.8.1.secrets-resilience-and-p95-foundation.md`, `docs/architecture/addendum-external-services-error-handling.md`, `docs/architecture/sezione-11-strategia-di-testing.md`, `docs/architecture/sezione-14-monitoraggio-e-osservabilit.md`.
- L’assenza attuale di evidenze significa che i rischi derivano da attività ancora teoriche (vault, scanner, fallback, raccolta P95).

## Risk Matrix

| ID      | Categoria | Descrizione | Probabilità | Impatto | Score | Priorità | Stato |
| ------- | --------- | ----------- | ----------- | ------- | ----- | -------- | ----- |
| SEC-301 | Security  | Secret governance incompleta: vault non configurato, scanner pipeline non attivi/topologia audit non definita | Medium (2) | High (3) | 6 | High | Aperto |
| OPS-301 | Operational | Drills di resilienza OpenAI/Supabase non eseguiti: downtime o quota possono bloccare E2E | Medium (2) | High (3) | 6 | High | Aperto |
| PERF-301| Performance | Metriche P95 non validate con campione adeguato e confronto dashboard | Medium (2) | High (3) | 6 | High | Aperto |
| OPS-302 | Operational | Scheduler health check non attivato o senza retention log → regressioni non rilevate | Medium (2) | Medium (2) | 4 | Medium | Aperto |
| DATA-301| Data       | Log e report (scanner, health, P95) possono contenere secrets/PII se non sanitizzati | Medium (2) | Medium (2) | 4 | Medium | Aperto |
| OPS-303 | Operational | Matrice responsabilità/owner rotazione chiavi non formalizzata → rischio single point of failure | Medium (2) | Medium (2) | 4 | Medium | Aperto |
| TECH-301| Technical  | Affidarsi a script/manualità senza automazione robusta (CLI scanner, script P95) può produrre falsi negativi | Medium (2) | Medium (2) | 4 | Medium | Aperto |

## Detailed Risk Register

### SEC-301 – Secret governance incompleta
- **Evidence:** Story AC1.* richiede vault + scanner; nessuna evidenza attuale. Alte probabilità di leakage se i job CI stampano segreti (`docs/stories/2.8.1…`, AC1.1-1.3).
- **Mitigations:** configurare vault con audit trail, integrare scanner (trufflehog/detect-secrets) nel CI, archiviare report firmato (`reports/secrets-scan-YYYYMMDD.txt`).
- **Testing Focus:** esecuzione scanner automatica + review log; usare `detect-secrets audit` per validare falsi positivi.
- **Monitoring:** audit periodico accessi vault; alert su modifiche secrets.

### OPS-301 – Resilienza servizi esterni non provata
- **Evidence:** AC2.* richiede drill per quota/downtime, ma non sono pianificati; addendum error handling prescrive retry/backoff (`docs/architecture/addendum-external-services-error-handling.md#3-pattern-operativi`).
- **Mitigations:** eseguire test negativi (quota esaurita, Supabase offline), documentare tempi di recovery, aggiornare runbook con escalation.
- **Testing Focus:** pytest mirati (`test_openai_resilience.py`) e script `--simulate-downtime`; verifica che i log contengano retry/backoff.
- **Monitoring:** alert su 429/5xx, timing dei job; definire SLO per pipeline E2E.

### PERF-301 – Affidabilità P95
- **Evidence:** AC3.* richiede >=300 richieste e delta ≤10%; storicamente P95 non attendibili (`docs/qa/gates/2.8...`).
- **Mitigations:** definire script P95 con param `--requests`, salvare report + screenshot, aprire issue se delta >10%.
- **Testing Focus:** run k6/script su staging, analizzare varianza, includere scenario frenato (servizi lenti).
- **Monitoring:** dashboard P95 con comparazione automatica; alert su delta >10%.

### OPS-302 – Scheduler health check assente
- **Evidence:** AC2.3 indica scheduling ma non c’è implementazione; fallback dipende da log manuali (`docs/stories/2.8.1…`, Fase 2).
- **Mitigations:** predisporre GitHub Actions nightly o cron job; salvare log con naming strutturato e diff automatico.
- **Testing Focus:** esecuzione consecutiva e verifica diff log; fail se cambiano permessi/schema.
- **Monitoring:** alert se job non produce output o fallisce.

### DATA-301 – Sanitizzazione log/report
- **Evidence:** Story prevede archiviazione multipla (reports/*.log, JSON scanner); rischio di contenere secrets o PII se non filtrati.
- **Mitigations:** pipeline di redazione (regex/allowlist), check manuale e script per mascherare; definire retention policy.
- **Testing Focus:** eseguire scanner su log generati per verificare che siano puliti; QA review manuale.
- **Monitoring:** processi di cleanup e alert su repository/log non redatti.

### OPS-303 – Ownership rotazione chiavi non formalizzata
- **Evidence:** AC4.2 richiede completare checklist rotazione; se non completata, rischio di secrets non ruotati o mancanza di owner.
- **Mitigations:** aggiornare `docs/operations/secrets-rotation.md` con RACI e cadenzario; approvazione PO/Platform.
- **Testing Focus:** simulare procedura di rotazione e verificare che non interrompa pipeline.
- **Monitoring:** reminder calendar; audit semestrale.

### TECH-301 – Affidabilità automatismi script
- **Evidence:** Reliance su script CLI (scanner, P95) senza pipeline dedicata; rischi di falsi positivi/negativi se parametri errati.
- **Mitigations:** pipeline CI dedicata con parametri fissi, validazione output (es. parsing JSON), fallback manuale se script fallisce.
- **Testing Focus:** testare script con dataset noto per garantire output coerenti; assert su formati file.
- **Monitoring:** job CI con badge stato; alert su difformità output.

## Prioritized Recommendations

**Priorità 1 – Must fix (High risks)**
- Completare secret governance: vault + scanner CI + report controllato.
- Eseguire e documentare drill resilienza (OpenAI quota, Supabase downtime) con runbook aggiornato.
- Validare metriche P95 e allineare dashboard/issue per delta >10%.

**Priorità 2 – Mitigazioni da monitorare**
- Automatizzare health check Supabase con scheduling e diff log.
- Applicare sanitizzazione log/report e verifiche periodiche.
- Formalizzare ownership rotazione chiavi con RACI.
- Stabilizzare pipeline automatica per script CLI (scanner, P95).

**Priorità 3 – Controlli continui**
- Audit trimestrale accessi vault e rotazione chiavi.
- Monitorare trending P95 e errori 429/5xx via dashboard.
- Conservare check-list di review log post-pipeline.

## Risk-Based Testing Strategy

### Priorità 1 – Test critici
- **Security:** Eseguire `trufflehog` e `detect-secrets` su repo e artefatti; testare che i log pipeline siano privi di secrets (SEC-301).
- **Resilienza:** Pytest per quota OpenAI e downtime Supabase; validare retry/backoff (OPS-301).
- **Performance:** k6/P95 run con ≥300 richieste; analisi delta vs dashboard (PERF-301).

### Priorità 2 – Test High
- **Operational:** Testare scheduler health check (esecuzioni consecutive, diff log) (OPS-302).
- **Data:** Scanner su log/report archiviati; test checklist sanificazione (DATA-301).

### Priorità 3 – Test Medium
- **Operational:** Verificare RACI rotazione chiavi eseguendo dry-run; assicurarsi che pipeline non fallisca (OPS-303).
- **Technical:** Pipeline automatica script (unit test/mocks per configurazioni errate) (TECH-301).

## Monitoring & Telemetry Requirements

- Dashboard `docs/monitoring/external-services-dashboard.md` da aggiornare con:
  - Consumo quota OpenAI vs soglia (alert su 80%).
  - Errori 429/5xx per OpenAI/Supabase.
  - Trend P95 con highlight delta >10%.
- Alert su fallimento jobs nightly (health check, scanner).
- Audit log vault con review mensile.
- Ticket automatico se report P95 non generato entro finestra prevista.

## Residual Risk Score & Gate Recommendation

- **Story Risk Score:** 65/100 (tre rischi High non mitigati + quattro Medium).
- **Gate Recommendation:** CONCERNS – completare mitigazioni must-fix prima di considerare la storia pronta per implementazione o di rimuovere blocker sulla 2.8.

## Hook Reference

```
Risk profile: docs/qa/assessments/2.8.1-risk-20251014.md
```
