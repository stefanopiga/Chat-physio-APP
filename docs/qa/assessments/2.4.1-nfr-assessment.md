# NFR Assessment — Story 2.4.1: Document Persistence Integrity Fix

## Scope
- **Story**: 2.4.1 — Document Persistence Integrity Fix (rif. L5-L12:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **Epic**: Epic 2 — Core Knowledge Pipeline (rif. L8:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **Priority**: Critical (P0 - Blocker) (rif. L9:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **Effort Estimate**: 4-6 ore (rif. L11:docs/stories/2.4.1-document-persistence-integrity-fix.md)

## Integrità Dati
- **Vincolo FK document_id**: rispetto del vincolo tra `document_chunks.document_id` e `documents.id` come obiettivo esplicito (rif. L88-L98:docs/stories/2.4.1-document-persistence-integrity-fix.md).
```73:99:docs/stories/2.4.1-document-persistence-integrity-fix.md
### AC2: Foreign Key Constraint Respect
... 
SELECT COUNT(*) FROM document_chunks dc
WHERE NOT EXISTS (SELECT 1 FROM documents d WHERE d.id = dc.document_id);
-- Expected: 0 (nessun orfano)
```
- **Idempotenza inserimento documenti**: `ON CONFLICT (file_hash)` mantiene lo stesso `document_id` e aggiorna solo `updated_at` (rif. L100-L116, L182-L194:docs/stories/2.4.1-document-persistence-integrity-fix.md).
```182:194:docs/stories/2.4.1-document-persistence-integrity-fix.md
INSERT INTO documents (...)
ON CONFLICT (file_hash) DO UPDATE SET ...
RETURNING id
```

## Affidabilità e Coerenza
- **Flusso corretto**: creazione/aggiornamento documento padre, propagazione `document_id`, indexing con FK valida (rif. L58-L69:docs/stories/2.4.1-document-persistence-integrity-fix.md).
- **Aggiornamento stato documento**: `update_document_status` aggiorna `status` e inserisce eventuale `error` in `metadata` (rif. L212-L224:docs/stories/2.4.1-document-persistence-integrity-fix.md).
```219:224:docs/stories/2.4.1-document-persistence-integrity-fix.md
UPDATE documents 
SET status = $1, metadata = jsonb_set(metadata, '{error}', $2::jsonb), updated_at = NOW()
WHERE id = $3
```

## Prestazioni
- **Overhead previsto**: asyncpg call con latency +5-10ms (Basso impatto) (rif. R-2.4.1-4, L390-L391:docs/stories/2.4.1-document-persistence-integrity-fix.md).

## Scalabilità e Throughput
- **Rate limiting endpoint**: `@limiter.limit("10/minute")` su `POST /api/v1/admin/knowledge-base/sync-jobs` (rif. L244-L246:docs/stories/2.4.1-document-persistence-integrity-fix.md).
```244:246:docs/stories/2.4.1-document-persistence-integrity-fix.md
@app.post("/api/v1/admin/knowledge-base/sync-jobs", ...)
@limiter.limit("10/minute")
```

## Sicurezza
- **Access control**: richiede admin; risposte `403 Forbidden` in caso di utente non autorizzato (rif. L252-L254:docs/stories/2.4.1-document-persistence-integrity-fix.md).
- **Validazione input**: `document_text` obbligatorio, errore `400` se mancante/vuoto (rif. L255-L257:docs/stories/2.4.1-document-persistence-integrity-fix.md).

## Osservabilità
- **Tracciamento esiti**: aggiornamento `status` documento a `completed` o `error` durante indexing; persistenza messaggio errore in `metadata.error` (rif. L287-L293, L219-L224:docs/stories/2.4.1-document-persistence-integrity-fix.md).

## Testabilità e Qualità
- **Unit test**: 8/8 PASSED con 100% coverage su `db_storage.py` (rif. L401-L409, L509:docs/stories/2.4.1-document-persistence-integrity-fix.md). Target coverage ≥90% ✅ superato.
- **Integration test**: 4/4 implementati con dependency overrides pattern; pending DB test environment (non bloccante) (rif. L451-L466:docs/stories/2.4.1-document-persistence-integrity-fix.md).
- **E2E (Story 4.4)**: attesi 6/6 PASS in staging environment (rif. L141-L145, L511:docs/stories/2.4.1-document-persistence-integrity-fix.md).

## Migrazioni e Retrocompatibilità
- **Script retroattivo per chunk orfani**: creazione documenti placeholder e fix referenziale (rif. L618-L656:docs/stories/2.4.1-document-persistence-integrity-fix.md).
```618:656:docs/stories/2.4.1-document-persistence-integrity-fix.md
-- Script data migration per chunk orfani ...
ON CONFLICT (file_hash) DO NOTHING;
... RAISE NOTICE 'Fixed orphan chunks: %', fixed_count;
```

## Dipendenze Tecniche
- **asyncpg**: >= 0.30.0 (rif. L377:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **PostgreSQL**: 14+ con pgvector (rif. L379:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **FastAPI DI/Pool**: configurati (rif. L378-L380:docs/stories/2.4.1-document-persistence-integrity-fix.md)

## Vincoli / Issue Notevoli
- **Integration tests richiedono DB test environment**: risolto con pattern alternativo; NFR coverage garantita da unit tests (100% coverage) (rif. L768-L777:docs/stories/2.4.1-document-persistence-integrity-fix.md).
```768:777:docs/stories/2.4.1-document-persistence-integrity-fix.md
Status: ✅ Risolto con pattern alternativo
Issue: Integration tests richiedono database PostgreSQL reale
Soluzione: Test unitari garantiscono 100% coverage su logica persistence
Impatto: Non bloccante - conformità NFR garantita da test unitari
```
- **Watcher**: fuori scope, non bloccante per MVP/Story 4.4 (rif. L308-L358:docs/stories/2.4.1-document-persistence-integrity-fix.md).

## Conformità ai Criteri di Accettazione
- **AC1**: Creazione record in `documents` con `document_id` UUID (rif. L75-L85:docs/stories/2.4.1-document-persistence-integrity-fix.md).
- **AC2**: Nessun chunk orfano; FK rispettata (rif. L87-L98:docs/stories/2.4.1-document-persistence-integrity-fix.md).
- **AC3**: Idempotenza via `ON CONFLICT` con `document_id` invariato (rif. L100-L116:docs/stories/2.4.1-document-persistence-integrity-fix.md).
- **AC4**: Endpoint crea `documents` prima dell'indexing; response include `document_id` (rif. L118-L131:docs/stories/2.4.1-document-persistence-integrity-fix.md).
- **AC5**: Document Explorer ritorna documenti con `chunk_count > 0`; E2E 6/6 attesi (rif. L133-L145:docs/stories/2.4.1-document-persistence-integrity-fix.md).

## Rischi Residui
- **R-2.4.1-1**: chunk esistenti senza FK valida — Mitigazione: pre-migration + script fix (rif. L387:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **R-2.4.1-2**: race condition su `ON CONFLICT` — Probabilità bassa; `file_hash` UNIQUE (rif. L388:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **R-2.4.1-3**: breaking change per test — Aggiornare fixture (rif. L389:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **R-2.4.1-4**: overhead asyncpg +5-10ms — Accettabile (rif. L390-L391:docs/stories/2.4.1-document-persistence-integrity-fix.md)
- **R-2.4.1-5**: scope creep watcher — Fuori scope (rif. L391-L392:docs/stories/2.4.1-document-persistence-integrity-fix.md)

## Decisioni
- **Decisione di rilascio**: ✅ APPROVED per review - NFR coverage garantita da unit tests (100%), integration tests implementati (pending DB setup non bloccante)
