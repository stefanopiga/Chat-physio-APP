# Requirements Traceability Matrix

## Story: 2.3 - Polymorphic Chunking Router

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 4 (80%)
- Partially Covered: 1 (20%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Almeno due strategie di chunking implementate.

**Coverage: FULL**

- Unit Test: `apps/api/tests/test_chunk_strategies.py::test_recursive_strategy_basic`
  - Given: Testo lungo 120 caratteri
  - When: Viene applicato `RecursiveCharacterStrategy`
  - Then: Vengono prodotti ≥ 2 chunk; `strategy_name` con prefisso `recursive_character_`

- Unit Test: `apps/api/tests/test_chunk_strategies.py::test_tabular_strategy_sections_and_fallback`
  - Given: Testo con 3 sezioni separate da doppie newline
  - When: Viene applicato `TabularStructuralStrategy`
  - Then: Vengono prodotti ≥ 2 chunk; `strategy_name` con prefisso `tabular_structural_`

#### AC2: Definita una strategia di fallback.

**Coverage: FULL**

- Unit Test: `apps/api/tests/test_chunking_router.py::test_router_fallback_without_classification`
  - Given: Classificazione assente `None`
  - When: Router `route` è invocato
  - Then: `strategy_name` con prefisso `fallback::`

- Unit Test: `apps/api/tests/test_chunking_router.py::test_router_confidence_fallback`
  - Given: Classificazione con `confidenza = 0.5`
  - When: Router `route` è invocato
  - Then: `strategy_name` con prefisso `fallback::`

#### AC3: Il sistema applica la strategia corretta o il fallback.

**Coverage: FULL**

- Unit Test: `apps/api/tests/test_chunking_router.py::test_router_by_category_recursive`
  - Given: Categoria `TESTO_ACCADEMICO_DENSO` con `confidenza = 0.9`
  - When: Router `route` è invocato
  - Then: `strategy_name` con prefisso `recursive_character_`

- Unit Test: `apps/api/tests/test_chunking_router.py::test_router_by_category_tabular`
  - Given: Categoria `DOCUMENTO_TABELLARE` con `confidenza = 0.9`
  - When: Router `route` è invocato
  - Then: `strategy_name` con prefisso `tabular_structural_`

#### AC4: Il testo viene suddiviso in chunk con riferimento alla sorgente.

**Coverage: FULL (Integration)**

- Integration Test: `apps/api/tests/test_ingestion.py::test_scan_crea_output_temporanei`
  - Given: File sorgente `a.txt` in directory di watch
  - When: Viene eseguito `scan_once`
  - Then: Esistono file `file_hash.txt`, `file_hash.json` e directory dei chunk `file_hash/`

- Integration Test: `apps/api/tests/test_ingestion.py::test_ingestion_metadata_chunking`
  - Given: File sorgente con contenuto sufficiente a generare chunk
  - When: Viene eseguito `scan_once`
  - Then: `doc.chunking_strategy` valorizzato; `metadata["chunks_count"]` coerente con numero file nella dir `file_hash/`

#### AC5: Design modulare.

**Coverage: PARTIAL**

- Unit Tests: `apps/api/tests/test_chunk_strategies.py` e `apps/api/tests/test_chunking_router.py`
  - Given: Strategie e router separati in moduli distinti
  - When: Vengono testate le singole strategie e il router
  - Then: La separazione consente test unitari per ciascun componente; non esiste un test che convalidi esplicitamente il requisito architetturale

### Critical Gaps

1. AC5
   - Gap: Nessun test che convalidi esplicitamente il requisito di design modulare
   - Risk: Basso

### Risk Assessment

- High Risk: Nessuno
- Medium Risk: Nessuno
- Low Risk: AC5

### Trace Matrix Hook

Trace matrix: docs/qa/assessments/2.3-trace-20250921.md
