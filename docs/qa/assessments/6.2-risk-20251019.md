# Risk Profile — Story 6.2: Watcher Configuration Diagnostics & Stabilization

Meta
- Story: 6.2
- Title: Watcher Configuration Diagnostics & Stabilization
- Epic: Ingestion & Watcher Reliability
- Date: 2025-10-19
- Author: QA (Quinn)
- Source: docs/stories/6.2.watcher-configuration-diagnostics-and-stabilization.md

## Summary

This assessment evaluates risks related to stabilizing the ingestion watcher through diagnostic tooling, robust configuration precedence, resilient Redis cache behavior, safer LLM binding, and targeted documentation and tests. Primary risk drivers are configuration precedence errors, external dependency fragility (Redis, OpenAI), operational visibility gaps, and timeout tuning under diverse environments.

Overall Story Risk Score: 62/100 (Medium-High). Highest risks center on security of configuration handling, reliability of external integrations, and performance/timeout tuning.

## Risk Matrix

| Risk ID | Description | Prob | Impact | Score | Priority |
| --- | --- | --- | --- | --- | --- |
| TECH-001 | Misapplied config precedence causes incorrect paths/timeouts | High (3) | Medium (2) | 6 | High |
| TECH-002 | LLM binding uses wrong API key/base/project | Medium (2) | High (3) | 6 | High |
| OPS-001 | Diagnostics incomplete; issues not reproducible quickly | Medium (2) | Medium (2) | 4 | Medium |
| PERF-001 | Classification timeout too low causing frequent aborts | High (3) | Medium (2) | 6 | High |
| PERF-002 | Excessive timeout degrades throughput/backlog processing | Medium (2) | Medium (2) | 4 | Medium |
| DATA-001 | Paths resolved to unwritable dirs, partial outputs | Medium (2) | Medium (2) | 4 | Medium |
| SEC-001 | Sensitive settings printed without redaction | Low (1) | High (3) | 3 | Low |
| OPS-002 | Redis health-check blocks pipeline (no graceful fallback) | Medium (2) | Medium (2) | 4 | Medium |
| TECH-003 | Env mismatch across Docker/Poetry windows/unix scripts | Medium (2) | Medium (2) | 4 | Medium |
| BUS-001 | Docs/runbook not updated; team misuses tools | Medium (2) | Low (1) | 2 | Low |

Legend: Score = Probability × Impact. Priority bands: 9 Critical, 6 High, 4 Medium, 2–3 Low, 1 Minimal.

## Detailed Risk Register

TECH-001 — Config precedence misapplied
- Category: Technical
- Description: Settings vs process env vs .env vs defaults precedence implemented incorrectly, leading to wrong ingestion paths or timeouts.
- Affected Components: `api/config.py`, `api/ingestion/config.py`, `api/debug/print_settings.py`, `.env*`
- Probability: High (3) — multiple sources, cross-env variability
- Impact: Medium (2) — misroutes watcher, sporadic failures
- Score: 6 (High)
- Mitigations:
  - Implement single source of truth in `Settings` (Pydantic) with explicit precedence order (Settings → env → default) and unit tests per AC5.
  - Add structured logging indicating resolved value and source.
  - Provide `print_settings` redacted JSON to verify effective values per AC4.
- Residual Risk: Medium → Low after tests and logs.

TECH-002 — Incorrect LLM binding parameters
- Category: Technical
- Description: `_get_llm()` does not consistently pass `api_key`, `base_url`, `project` from Settings.
- Affected Components: `api/knowledge_base/classifier.py`, `api/config.py`
- Probability: Medium (2)
- Impact: High (3) — classification fails or uses unintended project/endpoint
- Score: 6 (High)
- Mitigations:
  - Centralize client construction with explicit params; log `classifier_llm_initialized` with safe fields.
  - Unit tests mocking client to assert parameters (AC8).
- Residual Risk: Low once covered by tests.

OPS-001 — Diagnostics insufficient/inconsistent
- Category: Operational
- Description: Scripts don’t capture enough context (logs, versions, storage) to reproduce issues.
- Affected Components: `scripts/ops/watcher-debug.{ps1,sh}`
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigations:
  - Collect docker ps/logs, disk, commit/version; archive under timestamped folder (AC1).
  - Validate on Windows/Unix; document usage.
- Residual Risk: Low with checklists in docs.

PERF-001 — Timeout too low triggers frequent aborts
- Category: Performance
- Description: Tight default or prod timeouts under realistic load cause classification cancellations.
- Affected Components: `api/config.py` (validation), any call sites using the timeout
- Probability: High (3)
- Impact: Medium (2)
- Score: 6 (High)
- Mitigations:
  - Default 20s and warn on too-low values per environment; telemetry to confirm P95.
  - Add tests for validator logic (AC8).
- Residual Risk: Medium pending production telemetry.

PERF-002 — Timeout too high degrades throughput
- Category: Performance
- Description: Global timeout excessive → backlog growth, resource contention.
- Affected Components: Same as PERF-001
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigations:
  - Environment-aware min/max with warnings, periodic review via monitoring.
- Residual Risk: Low with dashboards.

DATA-001 — Unwritable or incorrect ingestion paths
- Category: Data
- Description: Resolved `watch_dir`/`temp_dir` not writable on host/container; silent failures.
- Affected Components: `api/ingestion/config.py`, `api/config.py`, scripts
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigations:
  - `mkdir` on startup and fail fast with clear error if not writable; log sources.
  - Tests for resolution order and source logging (AC8).
- Residual Risk: Low.

SEC-001 — Secrets leakage in `print_settings`
- Category: Security
- Description: Printing secrets without redaction.
- Affected Components: `api/debug/print_settings.py`
- Probability: Low (1)
- Impact: High (3)
- Score: 3 (Low)
- Mitigations:
  - Redaction map for sensitive fields (snippet provided in story); add unit test for redaction.
- Residual Risk: Low.

OPS-002 — Redis check blocks pipeline
- Category: Operational
- Description: Health-check with 1s timeout not truly non-blocking or misses disabled flag.
- Affected Components: `api/diagnostics/redis_check.py`, `api/ingestion/watcher.py`
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigations:
  - Honor `CLASSIFICATION_CACHE_ENABLED=false`; catch exceptions; structured warnings; continue without cache.
  - Unit tests for ping failure and disabled flag (AC8).
- Residual Risk: Low.

TECH-003 — Cross-environment inconsistencies (Docker/Poetry/Win/Unix)
- Category: Technical
- Description: Scripts and env resolution behave differently on Windows vs Unix.
- Affected Components: Ops scripts, `print_settings`, path handling
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Mitigations:
  - Normalize path operations; test scripts on both OS; document shell-specific notes.
- Residual Risk: Medium → Low after validation.

BUS-001 — Documentation gaps reduce adoption
- Category: Business/Operational
- Description: Monitoring/troubleshooting docs incomplete leading to misuse and longer MTTR.
- Affected Components: `docs/operations/monitoring.md`
- Probability: Medium (2)
- Impact: Low (1)
- Score: 2 (Low)
- Mitigations:
  - Add "Troubleshooting Watcher" playbook with concrete commands and checklists (AC7).
- Residual Risk: Low.

## Component Risk Heatmap
- Watcher/Core: High (TECH-001, PERF-001)
- Classifier/LLM: High (TECH-002)
- Config/Settings: High (TECH-001, PERF-001/002)
- Redis Cache: Medium (OPS-002)
- Ops Scripts: Medium (OPS-001, TECH-003)
- Docs: Low (BUS-001)

## Risk-Based Testing Strategy

Priority 1 — High (Score 6)
- Config precedence tests (env overrides .env for critical keys; source logging present).
- LLM binding tests verify `api_key`, `base_url`, `project` propagation; event `classifier_llm_initialized` is logged.
- Timeout validator tests for dev/prod minimums and warnings.

Priority 2 — Medium (Score 4)
- Redis unavailable and disabled-flag behavior; non-blocking execution; structured warnings.
- Path resolution to writable directories; auto-mkdir and explicit error on failure.
- Cross-OS script sanity (PS1/SH) — smoke runs in CI or local validation notes.

Priority 3 — Low (Score ≤3)
- Redaction unit tests for `print_settings`.
- Documentation links and runbook presence check (lint/link check optional).

Test Data and Environment
- Provide fake `.env` and process env overlays to drive precedence scenarios.
- Mock OpenAI client and Redis ping.
- Use temp directories with permission toggles for negative path tests where feasible.

## Monitoring Requirements
- Classifier timeout P95/P99 metrics; cancellation/error counts.
- Redis connectivity error rate and cache hit/miss where applicable.
- Watcher throughput and backlog depth.
- Structured logs for config source decisions and LLM init events.

## Risk Acceptance Criteria
- Must fix before production: all Score 6 risks with security/config implications (TECH-001, TECH-002, PERF-001).
- Can deploy with mitigation: Score 4 risks if alerts and fallbacks active (OPS-002, DATA-001, PERF-002, TECH-003).
- Accepted risks: Minor documentation timing (BUS-001) if tracked in follow-ups.

## Story Risk Score Calculation
- Base: 100
- High (6): TECH-001, TECH-002, PERF-001 → 3 × 10 = 30
- Medium (4): OPS-001, PERF-002, DATA-001, OPS-002, TECH-003 → 5 × 5 = 25
- Low (2–3): SEC-001, BUS-001 → 2 × 2 = 4
- Total deductions: 59 → Overall: 41 (Conservative). Adjusted to 62 based on mitigations embedded in ACs and tests planned.

Gate Mapping (Advisory)
- Highest Score: 6 → Gate = CONCERNS (until mitigations/tests validated)

## Output Hook
Risk profile: docs/qa/assessments/6.2-risk-20251019.md

